[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [sdaftuar](https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1547892773), [ajtowns](https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1552435967) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-05-11T13:53:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544032117",
      "id" : 1544032117,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cCA91",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544032117/reactions"
      },
      "updated_at" : "2023-05-18T05:39:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544032117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think the removed-for-block case is the main one we care about -- in a situation where a peer has requested a transaction where we have received a block containing the transaction in the time between announcement and relay, it seems likely that the peer is about to receive the block as well, and with the compact block protocol we may be helping our peer quite a bit (potentially saving a round trip) if we deliver the transaction before the cmpctblock arrives to them.",
      "created_at" : "2023-05-11T14:04:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544047433",
      "id" : 1544047433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cCEtJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544047433/reactions"
      },
      "updated_at" : "2023-05-11T14:04:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544047433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-11T14:40:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544111666",
      "id" : 1544111666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cCUYy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544111666/reactions"
      },
      "updated_at" : "2023-05-11T14:40:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544111666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ok, good point. I was about to suggest that in that case it seems sufficient to only put `BLOCK` (maybe also `CONFLICTED`/`REORG`) transactions into `mapRelay` (keeping their mempool timestamp, to avoid adding ones that are older than 15 minutes). However, I think your point also applies to `REPLACED` transactions, because we'd still want to relay them, so that they are rejected by the peer and end up in their `AddToCompactExtraTransactions`? I wonder if it makes sense to drop a line or two of documentation here. (Edit: Or maybe even a test, if we want to get extra fancy)",
      "created_at" : "2023-05-11T15:10:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544171255",
      "id" : 1544171255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cCi73",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544171255/reactions"
      },
      "updated_at" : "2023-05-11T18:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544171255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, I've thought about moving `mapRelay` into txmempool so that its size can be counted as part of the 300MB (or whatever), and, if it grows too large, that we could trim `mapRelay` before their scheduled expiry time has actually been reached. Then you could have a multi_index amongst `txid`, `wtxid`, `expiry` to an `CTransactionRef`, along with a counter of how many entries in `mapRelay` aren't also in the mempool for handling memory usage?",
      "created_at" : "2023-05-11T16:08:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544274997",
      "id" : 1544274997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cC8Q1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544274997/reactions"
      },
      "updated_at" : "2023-05-11T16:08:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544274997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> we could trim mapRelay before their scheduled expiry time has actually been reached.\r\n\r\nSounds like this would either degrade compact block relay when the mempool is full due to trimming `mapRelay`, or turn one DoS (OOM) into another DoS (lost fee income) due to trimming valid mempool txs? And if you use separate and dedicated size limits for `mapRelay` and the mempool, it might be easier to keep them separate data structures? ",
      "created_at" : "2023-05-11T19:15:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544546730",
      "id" : 1544546730,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cD-mq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544546730/reactions"
      },
      "updated_at" : "2023-05-11T19:15:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544546730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "What is the benefit of `mapRelay` overlapping with mempool? If we moved it into txmempool, could we just add things to `mapRelay` from `mapTx` whenever evicting something for a block-related reason + whose timestamp is recent? If the main reason is transactions that could be in blocks, it seems reasonable to cap it at just a few thousand entries?",
      "created_at" : "2023-05-11T19:45:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544581150",
      "id" : 1544581150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cEHAe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544581150/reactions"
      },
      "updated_at" : "2023-05-11T19:46:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544581150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > we could trim mapRelay before their scheduled expiry time has actually been reached.\r\n> \r\n> Sounds like this would either degrade compact block relay when the mempool is full due to trimming `mapRelay`, or turn one DoS (OOM) into another DoS (lost fee income) due to trimming valid mempool txs? And if you use separate and dedicated size limits for `mapRelay` and the mempool, it might be easier to keep them separate data structures?\r\n\r\nThe memory usage of `mapRelay` depends on whether the transactions in it have been removed from the mempool -- if you've got 15k txs in `mapRelay` but all of them are in the mempool, then that's likely using up ~1MB; but if 50% of them were removed from the mempool and each `CTransactionRef` is using up 1kB, then that's more an extra ~15MB. You maybe get the latter scenario if you're relaying a lot of RBF txs. So I don't think you can sensibly put a figure on how much memory `mapRelay` is using if you don't track the relationship.\r\n\r\nBeyond that, the advantage of linking the two together for limits is that if you start trimming the mempool because `mapRelay` is too large, then you're increasing the mempool minfee, which reduces the RBF headroom -- instead of being able to RBF 50 times from 10 sat/vb up to 60 sat/vb, you might only see and relay 40 RBFs, from 20 sat/vb up to 60 sat/vb, which then reduces pressure on `mapRelay`.\r\n\r\n> What is the benefit of `mapRelay` overlapping with mempool?\r\n\r\n(a) We want things to expire from `mapRelay` based on when we first announced them, not when we first received them or when we evicted them, so that's extra data to store.\r\n\r\n(b) The number of txs we announce in 15 minutes is (currently) relatively tightly constrained (35tx every 2s for outbounds over 15min is ~16k; chance of >20k in 15min is about 1-in-5M).\r\n\r\n> If the main reason is transactions that could be in blocks, it seems reasonable to cap it at just a few thousand entries?\r\n\r\nWith RBF, you could have many different variants of a single tx, each relatively likely to make it into a block depending on when the miner picked the block template, so I think the time-based cap makes sense.\r\n\r\nThat said, I don't think there's a strong reason for the expiry duration to be 15 minutes rather than something shorter -- that was just left unchanged in #16851 when `mapRelay` went from being the only way to find a tx to just being the way to get at txs that are new to the mempool.",
      "created_at" : "2023-05-12T00:53:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544947585",
      "id" : 1544947585,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cFgeB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544947585/reactions"
      },
      "updated_at" : "2023-05-12T00:53:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544947585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm a concept ACK on getting rid of mapRelay.  It's been a while since I thought about this and I haven't fully dug through the code again to refresh my memory, but my recollection is that one of the main reasons we had to keep mapRelay in the past was that historically, our software wouldn't deal with NOTFOUND responses to a getdata very well, and so if we announced a transaction and then dropped it (for whatever reason) we would be mildly DoS'ing our peers (I think we used to wait 2 minutes before trying the next peer who had announced it to us).\r\n\r\nNow that we handle NOTFOUND's better, I think the last reason to hang on to mapRelay is the reason I gave above -- if the transaction was just removed in a block, we should provide it.  However, we can do that by just looking at the last block we received, which I believe we store in memory for fast compact block replies (`m_most_recent_block`).  So if we just built an index into that last block, then I think we would be clear to drop mapRelay altogether.",
      "created_at" : "2023-05-15T13:48:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1547892773",
      "id" : 1547892773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cQvgl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1547892773/reactions"
      },
      "updated_at" : "2023-05-15T13:48:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1547892773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think the last reason to hang on to mapRelay is the reason I gave above\r\n\r\nMy understanding is that `REPLACED` would also need to be provided to peers: https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544171255. Otherwise there may be another round trip if the miner mines a previous version of a recently replaced transaction, which is in `mapRelay` and  `vExtraTxnForCompact`, but not the mempool (and not yet in a block, because it may be in-flight)?\r\n\r\nHowever, that may be solved, but just replacing the `mapRelay` lookup by a `vExtraTxnForCompact` lookup?",
      "created_at" : "2023-05-15T14:53:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1548022004",
      "id" : 1548022004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cRPD0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1548022004/reactions"
      },
      "updated_at" : "2023-05-15T15:00:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1548022004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> My understanding is that `REPLACED` would also need to be provided to peers: [#27625 (comment)](https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544171255). Otherwise there may be another round trip if the miner mines a previous version of a recently replaced transaction, which is in `mapRelay` and `vExtraTxnForCompact`, but not the mempool (and not yet in a block, because it may be in-flight)?\r\n\r\nI think it's better that we not relay transactions that are `REPLACED` -- note that we already won't send a given peer the INV for a replaced transaction if the replacement occurs prior to the original INV going out (because we filter out transactions that are dropped from the mempool when we INV).\r\n\r\nMoreover I think it's better if, when we are aware of conflicting transactions, that we only relay the version that we think ought to confirm.  At the margin, it makes it more likely that the version we think is better gets mined, and from the perspective of a single node, we're presumably picking the one that we think is best to keep in our own mempools, so I don't think we should be spending system resources (and those of our peer) relaying the wrong version.",
      "created_at" : "2023-05-15T20:09:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1548505174",
      "id" : 1548505174,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cTFBW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1548505174/reactions"
      },
      "updated_at" : "2023-05-15T20:09:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1548505174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nThe original use of `mapRelay` was that if a tx wasn't in `mapRelay` it wouldn't be relayed at all. That resulted in problems with child transactions -- if we relay a recent child to a peer that doesn't have the parent, the parent may have expired from `mapRelay` and thus the peer wouldn't be able to accept the child at all.\r\n\r\nWe fixed that with #16851 so that we'd relay txs from the mempool if they'd been in the mempool long enough to expire from `mapRelay` (ie, 15 minutes). That got further tweaked in #18861 so that we'd skip txs that were in the to-be-announced queue, and then got tweaked further in #19109 so that the mempool would be used unconditionally for txs that had been announced recently, or that were older than 2 minutes, and `mapRelay` would only be used for txs that had left the mempool, had been announced recently (with the last 3500-5250 txs), and had entered the mempool within the last 15 minutes.\r\n\r\nThis resurrects #17303, and it's probably worth reviewing the comments there; most of the issues they raise have already been addressed, I think.\r\n\r\nI think I agree with [Suhas's comment](https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544047433) that we should ensure we serve any txs in the most recent block before dropping `mapRelay` though, so only a concept ack here. Here's a test commit that adds that functionality https://github.com/bitcoin/bitcoin/pull/27675/commits/f26a85059fb4eaf29f9c1652b2b5e14060d79a36 I'm now running that with logging for both relayed-from-most-recent-block and relayed-from-mapRelay-only to see how relevant those cases are in practice.\r\n\r\nI think it would also be good to continue serving txs from `vExtraTxnForCompact` (and to use them for resolving orphans?) to help address the [privacy issue for rbf relay](https://github.com/bitcoin/bitcoin/pull/17303#issuecomment-550460346), but I don't think that needs to be a prerequisite for dropping `mapRelay`.",
      "created_at" : "2023-05-18T05:39:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1552435967",
      "id" : 1552435967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585ciEr_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552435967/reactions"
      },
      "updated_at" : "2023-05-18T05:39:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552435967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think it would also be good to continue serving txs from `vExtraTxnForCompact`\r\n\r\nI wasn't sure how to do this, given the planned removal of `m_recently_announced_invs`  in https://github.com/bitcoin/bitcoin/pull/27675 . Otherwise we may relay invalid/non-standard transactions that were injected into us by a spy node.\r\n\r\nMaybe a flag on each transaction in `vExtraTxnForCompact` could be set to indicate if it ever was in the mempool. Though that would still leave the fingerprint vector if the spy node sent tx and its replacement immediately after (before we'd announce the original tx on any link).\r\n\r\n> address the https://github.com/bitcoin/bitcoin/pull/17303#issuecomment-550460346, but I don't think that needs to be a prerequisite for dropping mapRelay\r\n\r\nI agree. One could argue that the issue has little to do with mapRelay, because mapRelay only delays the attack by 15 minutes. Instead of 30 seconds, a spy node could wait 15 minutes + 30 seconds to clear mapRelay for its spy purposes and then proceed. See also https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191600264\r\n\r\nSo if there is a fix for this it can (and probably should) be suggested and discussed independent of this pull.\r\n\r\n> Here's a test commit that adds that functionality https://github.com/bitcoin/bitcoin/commit/f26a85059fb4eaf29f9c1652b2b5e14060d79a36 I'm now running that with logging for both relayed-from-most-recent-block and relayed-from-mapRelay-only to see how relevant those cases are in practice.\r\n\r\nHow would you judge \"relevant\"? I presume you are looking for rbf'd transactions that were requested from mapRelay and ended up in a block, but the block was not yet available to you when the tx was requested?\r\n\r\n> This resurrects https://github.com/bitcoin/bitcoin/pull/17303, and it's probably worth reviewing the comments there;\r\n\r\nI don't think the discussion contains anything relevant anymore, since the tx relay logic has been completely reworked in the meantime. (As summarized by you). And the only relevant stuff (that mapRelay is needed for compact block relay) wasn't even mentioned in that thread.",
      "created_at" : "2023-05-18T07:43:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1552665725",
      "id" : 1552665725,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585ci8x9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552665725/reactions"
      },
      "updated_at" : "2023-05-18T07:59:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552665725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> How would you judge \"relevant\"? I presume you are looking for rbf'd transactions that were requested from mapRelay and ended up in a block, but the block was not yet available to you?\r\n\r\nI'm still tweaking the logging, but so far what I'm seeing seems like roughly:\r\n\r\n * 95% relay from the mempool\r\n * of the 5% that don't:\r\n   * 87% are recent txs included in the most recent block (so would also be available via mapRelay)\r\n   * 12% are recent txs not in the most recent block, so only via mapRelay (combination of rbf'ed txs and things from the 2nd most recent block by the looks; EDIT: also things that were at the bottom of the mempool as minfee gets raised)\r\n   * 1% txs in the most recent block but not in mapRelay\r\n\r\nWhen things gets broadcast and then quickly rbf'ed, our behaviour looks a little weird, eg:\r\n\r\n```\r\n2023-05-18T07:32:49Z [net] got inv: wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7  new peer=40\r\n2023-05-18T07:32:51Z [net] Requesting wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7 peer=40\r\n2023-05-18T07:33:13Z [mempool] replacing tx 8d291ba6d69303d2aec6147df7768726a44108bbbdfc4064dfdbbb2f7ce9f280 with {06a3c28af14f9ad196f4aa209bc32fe4c79c79c8e176dc63428d7db96418cb17} for 0.00003867 additional fees, 0 delta bytes\r\n2023-05-18T07:33:13Z [mempool] AcceptToMemoryPool: peer=40: accepted {06a3c28af14f9ad196f4aa209bc32fe4c79c79c8e176dc63428d7db96418cb17} (poolsz 19793 txn, 100120 kB) feerate=158.23\r\n2023-05-18T07:33:54Z [net] got inv: wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7  have peer=30\r\n2023-05-18T07:33:56Z [net] got inv: wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7  have peer=48\r\n2023-05-18T07:34:01Z [mempool] replacing tx {06a3c28af14f9ad196f4aa209bc32fe4c79c79c8e176dc63428d7db96418cb17} with ab6b9c2863bfbf2fd013f76ae010d52c378df7785a16dcb15d73077ab2406139 for 0.00010398 additional fees, 0 delta bytes\r\n2023-05-18T07:34:04Z [net] got inv: wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7  new peer=46\r\n2023-05-18T07:34:04Z [net] Requesting wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7 peer=46\r\n2023-05-18T07:34:05Z [mempoolrej] {06a3c28af14f9ad196f4aa209bc32fe4c79c79c8e176dc63428d7db96418cb17} from peer=46 was not accepted: insufficient fee, rejecting replacement {06a3c28af14f9ad196f4aa209bc32fe4c79c79c8e176dc63428d7db96418cb17}; new feerate 0.00158227 BTC/kvB <= old feerate 0.00287881 BTC/kvB\r\n2023-05-18T07:34:05Z [net]  XXX - +mr hey, relaying something from mapRelay {06a3c28af14f9ad196f4aa209bc32fe4c79c79c8e176dc63428d7db96418cb17} 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7\r\n2023-05-18T07:34:06Z [net] got inv: wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7  have peer=8\r\n2023-05-18T07:34:09Z [net] got inv: wtx 57232af955cc9a788118508f50bc4f4bd8f41769c9ffbc218c6fe964c431e6c7  have peer=43\r\n```\r\n\r\n(ie, tx B arrives and replaces tx A; then we replace it with tx C; then B is announced by someone else so we request it again and run it through ATMP then we reject it; then someone else requests it and we relay it from mapRelay)",
      "created_at" : "2023-05-18T08:27:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1552718608",
      "id" : 1552718608,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cjJsQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552718608/reactions"
      },
      "updated_at" : "2023-05-18T10:21:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552718608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think I agree with https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1544047433 that we should ensure we serve any txs in the most recent block\r\n\r\nAdded a test for this in https://github.com/bitcoin/bitcoin/pull/27695, which should fail on this pull as is. I think the test only checks for `sendcmpct 0` (low bandwidth) behavior. And only for the case where the `tx`-`getdata` was already sent on the wire, because otherwise Bitcoin Core on current `master` would queue it behind the `cmpctblock`-`getdata`, which would also delay the reply so much that it will be useless. For `sendcmpct 1` (high bandwidth) the `cmpctblock` is sent directly to the peer without consideration of any outstanding `getdata`.\r\n\r\nMaybe transactions that are in the block, and recent, and presumed to be not know by the peer can be pushed on the send buffer before the compact block message, even absent a corresponding `inv` or `getdata` for those transactions?",
      "created_at" : "2023-05-18T10:07:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1552831521",
      "id" : 1552831521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cjlQh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552831521/reactions"
      },
      "updated_at" : "2023-05-18T10:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552831521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > I think it would also be good to continue serving txs from `vExtraTxnForCompact`\r\n> \r\n> I wasn't sure how to do this, given the planned removal of `m_recently_announced_invs` in #27675 . Otherwise we may relay invalid/non-standard transactions that were injected into us by a spy node.\r\n\r\nI guess a straightforward approach would be to have the mempool separately keep track of the last ~700 txs removed, as well as their entry time and removal time. Then they could be relayed to a node (under #27675's proposed logic) provided `entry <= last_inv < removal`. At 14tx/s, 700 txs is 50s, and the liklihood of not sending an inv to inbounds in that time seems like it's around once every 12 days (lowering to 40s would already reduce it to once a day).",
      "created_at" : "2023-05-18T11:31:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1552923162",
      "id" : 1552923162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cj7oa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552923162/reactions"
      },
      "updated_at" : "2023-05-18T11:31:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552923162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">I guess a straightforward approach would be to have the mempool separately keep track of the last ~700 txs removed, as well as their entry time and removal time. Then they could be relayed to a node (under https://github.com/bitcoin/bitcoin/pull/27675's proposed logic)\r\n\r\nThat would still leave the fingerprint vector if the spy node sent a transaction and its replacement immediately after. That is, before we'd have a chance to announce or send the original to anyone. Leaving us with a unique fingerprint that can be used to find out if we are reachable on two networks.",
      "created_at" : "2023-05-18T11:42:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1552934253",
      "id" : 1552934253,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cj-Vt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552934253/reactions"
      },
      "updated_at" : "2023-05-18T11:42:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1552934253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think it would also be good to continue serving txs from vExtraTxnForCompact (and to use them for resolving orphans?) to help address the https://github.com/bitcoin/bitcoin/pull/17303#issuecomment-550460346, but I don't think that needs to be a prerequisite for dropping mapRelay.\r\n\r\nI don't think the privacy issues raised by not relaying replaced transactions are significant at all.  There are many ways to use transaction relay behavior to infer the network topology, and I think there are downsides (perhaps mild) to both a node and the network if we do relay such transactions.  It seems like we all agree that this shouldn't be a requirement to dropping `mapRelay` but I just want to be clear that I think there is no benefit to doing so either.\r\n\r\n> When things gets broadcast and then quickly rbf'ed, our behaviour looks a little weird, eg:\r\n\r\nOne idea may be to add replaced transactions to a reject filter.\r\n\r\n> Maybe transactions that are in the block, and recent, and presumed to be not know by the peer can be pushed on the send buffer before the compact block message, even absent a corresponding inv or getdata for those transactions?\r\n\r\nNote that compact blocks can be sent with prefilled transactions for precisely this use case.  Some research should be done to come up with heuristics for determining when to include prefilled transactions (as there is a bandwidth, and therefore latency cost to including transactions that are unnecessary).  Anyway, I think that is work for another PR.\r\n\r\nMy suggestion would be to move forward with a PR that uses the `m_recently_announced_invs` filter for now to determine when to relay from the mempool, or the most recent block, which I think is a very straightforward code change.  The PR that seeks to remove the recently announced filter should be easy to update to support what we're doing here.\r\n\r\n\r\n",
      "created_at" : "2023-05-18T15:22:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1553225738",
      "id" : 1553225738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585clFgK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553225738/reactions"
      },
      "updated_at" : "2023-05-18T15:22:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553225738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Here's a test commit that adds that functionality https://github.com/bitcoin/bitcoin/commit/f26a85059fb4eaf29f9c1652b2b5e14060d79a36\r\n\r\nThanks. Did you want me to push it here (removing the logging), or did you want to open a fresh pull yourself?\r\n\r\nAlso, I think we dropped support for non-witness compact block relay, so I guess you can drop `txid` from your map and only use `wtxid`?",
      "created_at" : "2023-05-19T10:19:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1554355740",
      "id" : 1554355740,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cpZYc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554355740/reactions"
      },
      "updated_at" : "2023-05-19T10:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554355740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Also, I think we dropped support for non-witness compact block relay, so I guess you can drop `txid` from your map and only use `wtxid`?\r\n\r\nI believe that there should be some older versions of our software that support witness-compact-block-relay but don't support wtxidrelay, so I think @ajtowns patch is correct to index on both.\r\n",
      "created_at" : "2023-05-19T12:36:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27625#issuecomment-1554510214",
      "id" : 1554510214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27625",
      "node_id" : "IC_kwDOABII585cp_GG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554510214/reactions"
      },
      "updated_at" : "2023-05-19T12:36:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554510214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
