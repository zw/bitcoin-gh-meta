[
   {
      "body" : "Is this a regression? LevelDB has always done compaction at startup, AFAIU.\n\nOn February 3, 2017 8:23:00 PM EST, Chris Moore <notifications@github.com> wrote:\n>I'm running the current master branch version (1c2edd9f) and find that\n>most times when I start bitcoind it spends about 10 minutes thrashing\n>my hard drive doing a 'compaction' of the chainstate database.\n>\n>The relevant stack trace:\n>\n>#9  0x000055555596ce1f in leveldb::DBImpl::DoCompactionWork\n>(this=0x7fffd8619e90, compact=0x7fffa8015860) at\n>leveldb/db/db_impl.cc:1006\n>#10 0x000055555596d69f in leveldb::DBImpl::BackgroundCompaction\n>(this=0x7fffd8619e90) at leveldb/db/db_impl.cc:736\n>#11 0x000055555596e192 in leveldb::DBImpl::BackgroundCall\n>(this=0x7fffd8619e90) at leveldb/db/db_impl.cc:674\n>#12 0x00005555559951a3 in BGThread (this=0x7fffd847c490) at\n>leveldb/util/env_posix.cc:582\n>#13 leveldb::(anonymous namespace)::PosixEnv::BGThreadWrapper\n>(arg=0x7fffd847c490) at leveldb/util/env_posix.cc:521\n>#14 0x00007ffff4cc30a4 in start_thread (arg=0x7fffb73bc700) at\n>pthread_create.c:309\n>\n>I tried restarting bitcoind 10 times and kept a copy of the LOG file\n>each time. Here are the file sizes:\n>\n>    -rw------- 1 chris chris 184366 Feb  3 11:19 LOG.00\n>    -rw------- 1 chris chris 182024 Feb  3 11:30 LOG.01\n>    -rw------- 1 chris chris    344 Feb  3 12:11 LOG.02\n>    -rw------- 1 chris chris 194758 Feb  3 12:27 LOG.03\n>    -rw------- 1 chris chris    344 Feb  3 12:27 LOG.04\n>    -rw------- 1 chris chris 187248 Feb  3 12:36 LOG.05\n>    -rw------- 1 chris chris    571 Feb  3 15:28 LOG.06\n>    -rw------- 1 chris chris 189728 Feb  3 15:45 LOG.07\n>    -rw------- 1 chris chris 194434 Feb  3 16:00 LOG.08\n>    -rw------- 1 chris chris 188599 Feb  3 16:16 LOG.09\n>\n>7 out of 10 times it did a full recompact, causing the computer to\n>almost come to a standstill while it kept the harddrive busy. One of\n>the 10 times bitcoind crashed hard almost immediately, but I'm sure\n>that's a separate issue (#9683).\n>\n>Here's the\n>[LOG](https://github.com/bitcoin/bitcoin/files/751895/LOG.txt) file\n>from the ~/.bitcoin/chainstate/ folder.\n>\n>-- \n>You are receiving this because you are subscribed to this thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/issues/9684\n",
      "created_at" : "2017-02-04T02:02:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9684#issuecomment-277409750",
      "id" : 277409750,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9684",
      "updated_at" : "2017-02-04T02:02:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/277409750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I used to be able to start bitcoind without it thrashing my hard drive for 10 minutes. And sometimes I still can (3 out of 10 times in my recent tests). Did it always read and rewrite most of the chainstate db on startup?",
      "created_at" : "2017-02-04T02:15:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9684#issuecomment-277410835",
      "id" : 277410835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9684",
      "updated_at" : "2017-02-04T02:15:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/277410835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "I think it's related to how much has been written to the database before shutdown, and how long that was. With larger dbcache values in recent versions (in 0.14/master it can be up to 600M by default, if the mempool is empty), there may be a large dump to disk of dirty entries at shutdown, which need compaction at startup.",
      "created_at" : "2017-02-04T02:23:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9684#issuecomment-277411447",
      "id" : 277411447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9684",
      "updated_at" : "2017-02-04T02:23:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/277411447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@dooglus What version/options were you using last where you did not notice this behaviour?",
      "created_at" : "2017-02-04T02:24:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9684#issuecomment-277411479",
      "id" : 277411479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9684",
      "updated_at" : "2017-02-04T02:24:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/277411479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "> I think it's related to how much has been written to the database before shutdown, and how long that was. \r\n\r\nI was seeing a full recompact even when I had a fully synced blockchain and restarted shortly after starting up. ie. I'd start bitcoind, wait 10 minutes for the recompact to finish, then stop and restart it, and I'd see another full recompact immediately.\r\n\r\n> What version/options were you using last where you did not notice this behaviour?\r\n\r\nI don't know. I didn't know this was a behavior that could happen until I first noticed it happening. These are the settings I use now, when it does happen:\r\n\r\n    keypool=10\r\n    logips=1\r\n    minrelaytxfee=0.0001\r\n    paytxfee=0.0001\r\n    upnp=0\r\n    spendzeroconfchange=0\r\n    logips=1\r\n    bind=127.0.0.1\r\n    maxconnections=32\r\n    testnet=0\r\n    txindex=1\r\n    checkblocks=1\r\n    listen=0\r\n    server=1\r\n    daemon=1\r\n\r\nI changed to `daemon=0` when testing with bitcoind instead of bitcoin-cli, but it didn't seem to change the  behavior.\r\n\r\nWhen I first noticed the behavior I was running from commit 453bda63. In the past I have run `bitcored` from bitpay, which comes with its own bitcoind executable, `Bitcoin version v0.11.2.0-bc99ef3 (2016-04-08 10:42:17 -0400)`. I suppose that could be statically linked with a different leveldb version, and may be contributing to the behavior I'm seeing, since I run it on the same ~/.bitcoin/ directory.\r\n\r\nI'll can rebuilding from older commits and see if I can determine which commit introduced the behavior if that would be helpful.",
      "created_at" : "2017-02-04T08:02:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9684#issuecomment-277427399",
      "id" : 277427399,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9684",
      "updated_at" : "2017-02-04T08:02:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/277427399",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "Well the compaction will always run at startup, I believe, and always has. The question is whether it takes a long time.\n\nv0.11.2 had a much smaller dbcache, and did much more frequent writes to disk. Also, txindex may affect performance (though that's in the block index db, not the chainstate).",
      "created_at" : "2017-02-04T08:21:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9684#issuecomment-277428237",
      "id" : 277428237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9684",
      "updated_at" : "2017-02-04T08:21:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/277428237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "There are some things we can do to improve this but they all require modifying our in-tree copy of the LevelDB source code. That's something I'd like to do anyway, but I'm not sure everyone else is convinced that's a good idea.\r\n\r\n@dooglus In the meantime you can use `ionice` to deprioritize the compaction thread. On Linux you can set this to a specific thread id. Usually the LevelDB compaction thread is the highest numbered thread id in the output of `ps -eL`. (Renaming that thread is another thing I'd like to change in the LevelDB source code).",
      "created_at" : "2018-03-10T07:20:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9684#issuecomment-372009547",
      "id" : 372009547,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9684",
      "updated_at" : "2018-03-10T07:20:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/372009547",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   }
]
