[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187776664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187776664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, put `{` here.",
      "commit_id" : "cdd084ded2d4a1bf33459d17e243a30cca02c1c2",
      "created_at" : "2018-05-12T16:16:01Z",
      "diff_hunk" : "@@ -1163,6 +1163,18 @@ void CConnman::ThreadSocketHandler()\n         //\n         {\n             LOCK(cs_vNodes);\n+\n+            if (!fNetworkActive)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187776664",
      "id" : 187776664,
      "original_commit_id" : "8e2e21bf054a30525adc7b3a9d5b3ac4a34137be",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 119630291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212",
      "updated_at" : "2018-05-13T12:03:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187776664",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187776675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187776675"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, space after `if`.",
      "commit_id" : "cdd084ded2d4a1bf33459d17e243a30cca02c1c2",
      "created_at" : "2018-05-12T16:16:32Z",
      "diff_hunk" : "@@ -1163,6 +1163,18 @@ void CConnman::ThreadSocketHandler()\n         //\n         {\n             LOCK(cs_vNodes);\n+\n+            if (!fNetworkActive)\n+            {\n+                // Disconnect any connected nodes\n+                for (CNode* pnode : vNodes) {\n+                    if(!pnode->fDisconnect) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187776675",
      "id" : 187776675,
      "original_commit_id" : "8e2e21bf054a30525adc7b3a9d5b3ac4a34137be",
      "original_position" : 9,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 119630291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212",
      "updated_at" : "2018-05-13T12:03:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187776675",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187776992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187776992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can  install `clang-format` and run the https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy script to preempt whitespace nitpicking.",
      "commit_id" : "cdd084ded2d4a1bf33459d17e243a30cca02c1c2",
      "created_at" : "2018-05-12T16:29:20Z",
      "diff_hunk" : "@@ -1163,6 +1163,18 @@ void CConnman::ThreadSocketHandler()\n         //\n         {\n             LOCK(cs_vNodes);\n+\n+            if (!fNetworkActive)\n+            {\n+                // Disconnect any connected nodes\n+                for (CNode* pnode : vNodes) {\n+                    if(!pnode->fDisconnect) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187776992",
      "id" : 187776992,
      "in_reply_to_id" : 187776675,
      "original_commit_id" : "8e2e21bf054a30525adc7b3a9d5b3ac4a34137be",
      "original_position" : 9,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 119630612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212",
      "updated_at" : "2018-05-13T12:03:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187776992",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187798531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187798531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed the formatting using clang-format-diff.py. Thanks!",
      "commit_id" : "cdd084ded2d4a1bf33459d17e243a30cca02c1c2",
      "created_at" : "2018-05-13T12:08:46Z",
      "diff_hunk" : "@@ -1163,6 +1163,18 @@ void CConnman::ThreadSocketHandler()\n         //\n         {\n             LOCK(cs_vNodes);\n+\n+            if (!fNetworkActive)\n+            {\n+                // Disconnect any connected nodes\n+                for (CNode* pnode : vNodes) {\n+                    if(!pnode->fDisconnect) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13212#discussion_r187798531",
      "id" : 187798531,
      "in_reply_to_id" : 187776675,
      "original_commit_id" : "8e2e21bf054a30525adc7b3a9d5b3ac4a34137be",
      "original_position" : 9,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 119652299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13212",
      "updated_at" : "2018-05-13T12:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187798531",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/834253?v=4",
         "events_url" : "https://api.github.com/users/lmanners/events{/privacy}",
         "followers_url" : "https://api.github.com/users/lmanners/followers",
         "following_url" : "https://api.github.com/users/lmanners/following{/other_user}",
         "gists_url" : "https://api.github.com/users/lmanners/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/lmanners",
         "id" : 834253,
         "login" : "lmanners",
         "organizations_url" : "https://api.github.com/users/lmanners/orgs",
         "received_events_url" : "https://api.github.com/users/lmanners/received_events",
         "repos_url" : "https://api.github.com/users/lmanners/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/lmanners/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/lmanners/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/lmanners"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@lmanners Thanks, this appears to fix the #13038 bug that I reported. Tested ACK\r\n\r\n- I verified that the bug is still easily reproducible with current master branch commit 6738813bcbb730b5a19e67482b6612d568c22699.\r\n- I applied this patch.\r\n- I verified that I was not able to reproduce the bug with multiple attempts.\r\n\r\nTested with:\r\n\r\n`/bitcoin/src/qt/bitcoin-qt -datadir=/data/bitcoin-unpruned-txindex -txindex -disablewallet -persistmempool=0 -printtoconsole -debug=net`\r\n\r\nI believe this is an example of the race that I was able to capture and see being handled cleanly by this patch:\r\n\r\n```\r\n2018-05-21T12:20:30Z SetNetworkActive: false\r\n2018-05-21T12:20:31Z Added connection peer=13\r\n2018-05-21T12:20:31Z sending version (103 bytes) peer=13\r\n2018-05-21T12:20:31Z send version message: version 70015, blocks=523490, us=[::]:0, peer=13\r\n2018-05-21T12:20:31Z Network not active, dropping peer=13\r\n2018-05-21T12:20:31Z disconnecting peer=13\r\n2018-05-21T12:20:31Z Cleared nodestate for peer=13\r\n\r\n2018-05-21T12:21:32Z SetNetworkActive: true\r\n2018-05-21T12:21:33Z trying connection 180.107.22.115:8333 lastseen=36.9hrs\r\n2018-05-21T12:21:33Z Added connection peer=14\r\n2018-05-21T12:21:33Z sending version (103 bytes) peer=14\r\n2018-05-21T12:21:33Z send version message: version 70015, blocks=523490, us=[::]:0, peer=14\r\n2018-05-21T12:21:34Z trying connection 176.223.201.198:8333 lastseen=0.2hrs\r\n\r\n2018-05-21T12:21:34Z SetNetworkActive: false\r\n2018-05-21T12:21:34Z Network not active, dropping peer=14\r\n2018-05-21T12:21:34Z disconnecting peer=14\r\n2018-05-21T12:21:34Z Cleared nodestate for peer=14\r\n2018-05-21T12:21:34Z Added connection peer=15\r\n2018-05-21T12:21:34Z sending version (103 bytes) peer=15\r\n2018-05-21T12:21:34Z send version message: version 70015, blocks=523490, us=[::]:0, peer=15\r\n2018-05-21T12:21:34Z Network not active, dropping peer=15\r\n2018-05-21T12:21:34Z disconnecting peer=15\r\n2018-05-21T12:21:34Z Cleared nodestate for peer=15\r\n```",
      "created_at" : "2018-05-21T12:31:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13212#issuecomment-390640506",
      "id" : 390640506,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13212",
      "updated_at" : "2018-05-21T12:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/390640506",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for testing this @mruddy!\r\n\r\nNote: when I did my own testing, I added a sleep statement in CConnman::OpenNetworkConnection just after fNetworkActive is checked, to make the race condition reproduce consistently.",
      "created_at" : "2018-05-21T16:55:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13212#issuecomment-390714873",
      "id" : 390714873,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13212",
      "updated_at" : "2018-05-21T16:55:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/390714873",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/834253?v=4",
         "events_url" : "https://api.github.com/users/lmanners/events{/privacy}",
         "followers_url" : "https://api.github.com/users/lmanners/followers",
         "following_url" : "https://api.github.com/users/lmanners/following{/other_user}",
         "gists_url" : "https://api.github.com/users/lmanners/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/lmanners",
         "id" : 834253,
         "login" : "lmanners",
         "organizations_url" : "https://api.github.com/users/lmanners/orgs",
         "received_events_url" : "https://api.github.com/users/lmanners/received_events",
         "repos_url" : "https://api.github.com/users/lmanners/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/lmanners/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/lmanners/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/lmanners"
      }
   }
]
