{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "### Can you reliably reproduce the issue?\r\n\r\nYes\r\n\r\n#### If so, please list the steps to reproduce below:\r\n\r\n> % bitcoin-cli listtransactions '*' 2\r\n> error: couldn't parse reply from server\r\n\r\n### Expected behaviour\r\n\r\nJSON being printed on console\r\n\r\n### Actual behaviour\r\n\r\nJSON-PARSER in `bitcoin-cli` complains about invalid JSON received from `bitcoind`\r\n\r\n### What version of bitcoin-core are you using?\r\n\r\n> % bitcoin-cli --version\r\n> Bitcoin Core RPC client version v0.13.1.0-g03422e5`\r\n\r\n### What is the last known version where listtransactions was working\r\n\r\nThe problem was discovered after upgrading nodes from 0.11.2 to 0.13.1\r\n\r\n### Why does this happen?\r\n\r\nThe `wallet.dat` was used since the 0.3.XX days of Bitcoin Core and upgraded over time. Some old TXs in that `wallet.dat` contain comments with non-ASCII chars encoded as **latin1**.\r\n\r\nIn this case it's the German Umlaut **ÃÂ¼** encoded as `0xFC` (latin1) instead of `0xC3BC` (UTF8).\r\n\r\n`bitcoind` passes the comment in it's JSON response to `bitcoin-cli` without transformation, so the parser in `bitcoin-cli` complains about the latin1 representation of that character.\r\n\r\nJSON must to be used with UTF8 encoding.\r\n\r\ntcpdump confirms that the problem only occurs with TXs with non-utf8 special chars in their comments.\r\n\r\nSkipping the TXs with the problematic comments works fine:\r\n\r\n> % bitcoin-cli listtransactions '*' 1 2\r\n> (...)\r\n\r\n### Does dumping wallet.dat with `db_dump`, modifying the dump file and `db_load` work as a workaround?\r\n\r\nYes.\r\n\r\nStop `bitcoind`, make a **backup** of your `wallet.dat` file.\r\n\r\n```\r\ndb_dump -p -f dump.txt wallet.dat\r\ngrep -F comment dump.txt | perl -p -e 's#^.*comment(.*?)\\\\0b.*$#$1#'\r\n# this will output all your TX comments to inspect visually before modifying\r\nvim dump.txt\r\ndb_load -f dump.txt new.dat\r\nmv wallet.dat wallet.dat.orig\r\nmv new.dat wallet.dat\r\n```\r\n\r\nProblem: `grep` from above doesn't find all your comments. So there might still be comments left with latin1-encoded chars.\r\n\r\nMake 100% sure to replace the special chars only in your comments. Do not use search/replace! Replace each 1 byte char with exactly 1 byte ASCI char.\r\n\r\nIn my case I replaced `\\fc` with `u` (German `ÃÂ¼` --> `u`)\r\n\r\nIf you change the length of the string by replacing one special char with more than 1 char, you will get errors like the following on next start of `bitcoind`:\r\n\r\n> 2016-11-15 17:29:55 init message: Loading wallet...\r\n> Warning: Error reading wallet.dat! All keys read correctly,\r\n> but transaction data or address book entries might be missing or incorrect.\r\n\r\nWhat's the best way to handle this?",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 9,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9166/comments",
   "created_at" : "2016-11-15T18:11:22Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9166/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/9166",
   "id" : 189465671,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9166/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 9166,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "listtransactions returns invalid JSON when comment contain non-UTF8 special chars",
   "updated_at" : "2016-11-21T08:11:40Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9166",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/20477825?v=4",
      "events_url" : "https://api.github.com/users/c0deright/events{/privacy}",
      "followers_url" : "https://api.github.com/users/c0deright/followers",
      "following_url" : "https://api.github.com/users/c0deright/following{/other_user}",
      "gists_url" : "https://api.github.com/users/c0deright/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/c0deright",
      "id" : 20477825,
      "login" : "c0deright",
      "organizations_url" : "https://api.github.com/users/c0deright/orgs",
      "received_events_url" : "https://api.github.com/users/c0deright/received_events",
      "repos_url" : "https://api.github.com/users/c0deright/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/c0deright/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/c0deright/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/c0deright"
   }
}
