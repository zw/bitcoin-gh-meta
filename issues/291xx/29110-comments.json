[
   {
      "author_association" : "MEMBER",
      "body" : "It looks like the `SQLiteBatch` being used to write data to disk is being destroyed unexpectedly, which causes subsequent writes using the same object(??) to have the wrong db transaction state that triggers this error.\r\n\r\nEdit: I'm thinking that this might actually be due to a race condition? If there were two `SQLiteBatch` objects with one beginning a transaction, when the other executes its actions, and then destructs, it would detect that a transaction is in progress that it hadn't started, and thus do `ROLLBACK` which would result in the first batch object expecting a transaction when the other had aborted it.\r\n\r\nLooking at this further, I think the `ChainStateFlushed` that happens after we see `BEGIN TRANSACTION` is the culprit. The wallet makes a new batch for flushing the chainstate, and when this is destroyed, it also aborts the other batch's transaction.",
      "created_at" : "2023-12-18T20:05:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29110#issuecomment-1861506107",
      "id" : 1861506107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29110",
      "node_id" : "IC_kwDOABII585u9FQ7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1861506107/reactions"
      },
      "updated_at" : "2023-12-18T20:13:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1861506107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yeah. The description is accurate achow. I had something for this in the past for #25297. We currently support a single db connection at time; when multiple `WalletBatch` are created on different threads, the first one destructed has priority over the others.\r\n\r\nIIRC, I had a database manager class providing db references, mapping the thread id to the db ref. So different threads can wait until other processes finish dumping data, acting accordantly, before making use of the db.\r\nI think I never pushed it because I wanted to go further (and also because #25297 didn't get much attention); wanted to make the db manager class provide db txns at the software level (not db engine level), enabling real parallelism and also letting us batch writes even across data from different processes.",
      "created_at" : "2023-12-18T21:44:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29110#issuecomment-1861732127",
      "id" : 1861732127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29110",
      "node_id" : "IC_kwDOABII585u98cf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1861732127/reactions"
      },
      "updated_at" : "2023-12-18T21:46:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1861732127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> https://cirrus-ci.com/task/5898005006516224?logs=ci#L2515 :\r\n> \r\n> ```shell\r\n> _20231218_134952/wallet_basic_259/node0/regtest/wallets/default_wallet/wallet.dat] SQLite Statement: ROLLBACK TRANSACTION \r\n>  node0 2023-12-18T13:53:29.193915Z [scheduler] [wallet/sqlite.cpp:400] [Close] SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted \r\n>  node0 2023-12-18T13:53:29.194038Z [scheduler] [wallet/sqlite.cpp:53] [TraceSqlCallback] [/ci_container_base/ci/scratch/test_runner/test_runner_â¿_ð_20231218_134952/wallet_basic_259/node0/regtest/wallets/zeroconf/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?) \r\n>  node0 2023-12-18T13:53:29.194122Z [scheduler] [wallet/sqlite.cpp:53] [TraceSqlCallback] [/ci_container_base/ci/scratch/test_runner/test_runner_â¿_ð_20231218_134952/wallet_basic_259/node0/regtest/wallets/zeroconf/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?) \r\n>  test  2023-12-18T13:53:29.196000Z TestFramework (ERROR): JSONRPC error \r\n>                                    Traceback (most recent call last):\r\n>                                      File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 131, in main\r\n>                                        self.run_test()\r\n>                                      File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/wallet_basic.py\", line 786, in run_test\r\n>                                        self.test_chain_listunspent()\r\n>                                      File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/wallet_basic.py\", line 792, in test_chain_listunspent\r\n>                                        self.nodes[0].get_wallet_rpc(self.default_wallet_name).sendtoaddress(self.wallet.get_address(), \"5\")\r\n>                                      File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/coverage.py\", line 50, in __call__\r\n>                                        return_val = self.auth_service_proxy_instance.__call__(*args, **kwargs)\r\n>                                      File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/authproxy.py\", line 129, in __call__\r\n>                                        raise JSONRPCException(response['error'], status)\r\n>                                    test_framework.authproxy.JSONRPCException: Error during descriptors keypool top up. Cannot commit changes for wallet [default_wallet] (-1)\r\n>  node0 2023-12-18T13:53:29.196028Z [httpworker.2] [wallet/sqlite.cpp:53] [TraceSqlCallback] [/ci_container_base/ci/scratch/test_runner/test_runner_â¿_ð_20231218_134952/wallet_basic_259/node0/regtest/wallets/default_wallet/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?) \r\n>  test  2023-12-18T13:53:29.198000Z TestFramework (DEBUG): Closing down network thread \r\n>  test  2023-12-18T13:53:29.248000Z TestFramework (INFO): Stopping nodes \r\n>  test  2023-12-18T13:53:29.248000Z TestFramework.node0 (DEBUG): Stopping node \r\n> ```\r\n\r\n",
      "created_at" : "2023-12-25T16:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29110#issuecomment-1869042800",
      "id" : 1869042800,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29110",
      "node_id" : "IC_kwDOABII585vZ1Rw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1869042800/reactions"
      },
      "updated_at" : "2023-12-25T16:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1869042800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/93977584?v=4",
         "events_url" : "https://api.github.com/users/Lajandra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Lajandra/followers",
         "following_url" : "https://api.github.com/users/Lajandra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Lajandra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Lajandra",
         "id" : 93977584,
         "login" : "Lajandra",
         "node_id" : "U_kgDOBZn78A",
         "organizations_url" : "https://api.github.com/users/Lajandra/orgs",
         "received_events_url" : "https://api.github.com/users/Lajandra/received_events",
         "repos_url" : "https://api.github.com/users/Lajandra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Lajandra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Lajandra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Lajandra"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added milestone, because this seems like a blocker?",
      "created_at" : "2024-01-11T15:29:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29110#issuecomment-1887419702",
      "id" : 1887419702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29110",
      "node_id" : "IC_kwDOABII585wf702",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 3,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1887419702/reactions"
      },
      "updated_at" : "2024-01-11T15:29:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1887419702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "https://cirrus-ci.com/task/6509037848625152?logs=ci#L2502",
      "created_at" : "2024-01-17T11:02:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29110#issuecomment-1895578477",
      "id" : 1895578477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29110",
      "node_id" : "IC_kwDOABII585w_Dtt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1895578477/reactions"
      },
      "updated_at" : "2024-01-17T11:02:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1895578477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
