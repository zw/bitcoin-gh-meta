{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Current behaviour\r\n\r\nbitcoind hangs \r\n\r\n### Expected behaviour\r\n\r\nbitcoind shouldn't hang\r\n\r\nI was able to dump the running threads and it was stuck waiting for `g_requests` to be empty. The issue seems to be that this callback may not actually be called in case of error: https://github.com/bitcoin/bitcoin/blob/22139f6e83a2bedd2dad9f280567d2c76c54252f/src/httpserver.cpp#L222-L227\r\n\r\nSee this issue https://github.com/libevent/libevent/issues/589 for more details. I think what happens is that interrupting `bitcoin-cli` before it has received the reply calls the error callback and then the success callback is never called.\r\n\r\nI think this is also a memory leak since `g_requests` won't get cleaned up. Whether it's severe or not probably depends on the caller and what type of requests they are making. This new code was introduced here https://github.com/bitcoin/bitcoin/pull/26742\r\n\r\n### Steps to reproduce\r\n\r\nI was running a simple shell script in 4 terminal windows for fun:\r\n\r\n```\r\n#!/bin/bash\r\n\r\nfor i in {1..50000}\r\ndo\r\n\t./src/bitcoin-cli -rpcuser=admin -rpcpassword=pass getrawtransaction 217819875434324c412d5e938f7f3c1670fb60814974cf7958f1fac90ee5afb7\r\ndone\r\n```\r\n\r\nI was messing around with this script and randomly Ctrl-C'd each terminal window in rapid succession and then when I waited up to a minute and Ctrl-C'd bitcoind, it didn't shutdown. I can reproduce it pretty reliably as well.\r\n\r\nCompilation commands:\r\n```\r\n./autogen.sh; ./configure --without-wallet --with-gui=no --disable-zmq; make -j4\r\n```\r\n\r\nRun-time options (note that I was able to reproduce this with the default number of rpcthreads as well):\r\n```\r\n./src/bitcoind -txindex -rpcthreads=1 -debug\r\n```\r\n\r\nOutput of `gcc --version`:\r\n```\r\nConfigured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1\r\nApple clang version 11.0.3 (clang-1103.0.32.62)\r\nTarget: x86_64-apple-darwin21.6.0\r\nThread model: posix\r\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\r\n```\r\n\r\nOutput of `g++ --version`:\r\n```\r\nConfigured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1\r\nApple clang version 11.0.3 (clang-1103.0.32.62)\r\nTarget: x86_64-apple-darwin21.6.0\r\nThread model: posix\r\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\r\n```\r\n\r\nMy libevent version is somewhere between 0x02010600 and 0x02020001 -- I can get that if it matters\r\n\r\n### Relevant log output\r\n\r\n```\r\n^C2023-05-22T20:56:10Z [http] Interrupting HTTP server\r\n2023-05-22T20:56:10Z [rpc] Interrupting HTTP RPC server\r\n2023-05-22T20:56:10Z [rpc] Interrupting RPC\r\n2023-05-22T20:56:10Z tor: Thread interrupt\r\n2023-05-22T20:56:10Z Shutdown: In progress...\r\n2023-05-22T20:56:10Z [rpc] Stopping HTTP RPC server\r\n2023-05-22T20:56:10Z torcontrol thread exit\r\n2023-05-22T20:56:10Z [http] Unregistering HTTP handler for / (exactmatch 1)\r\n2023-05-22T20:56:10Z addcon thread exit\r\n2023-05-22T20:56:10Z [http] Unregistering HTTP handler for /wallet/ (exactmatch 0)\r\n2023-05-22T20:56:10Z [rpc] Stopping RPC\r\n2023-05-22T20:56:10Z net thread exit\r\n2023-05-22T20:56:10Z [rpc] RPC stopped.\r\n2023-05-22T20:56:10Z [http] Stopping HTTP server\r\n2023-05-22T20:56:10Z [http] Waiting for HTTP worker threads to exit\r\n2023-05-22T20:56:10Z [http] Exited http event loop\r\n2023-05-22T20:56:10Z [http] Waiting for 1 requests to stop HTTP server\r\n```\r\n\r\nThe important bit is the very last log line. bitcoind was still alive and periodically printed log lines about feeding dynamic environment data into the RNG.\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nCompiled from source\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\n17acb2782a66f033238340e4fb81009e7f79e97a\r\n\r\n### Operating system and version\r\n\r\nmacOS intel\r\n\r\n### Machine specifications\r\n\r\n_No response_",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722/comments",
   "created_at" : "2023-05-22T23:05:42Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722",
   "id" : 1720770400,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "description" : null,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII585mkN9g",
   "number" : 27722,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722/timeline",
   "title" : "bitcoind hangs waiting for `g_requests.empty()`",
   "updated_at" : "2023-05-23T16:00:49Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
      "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
      "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
      "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
      "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/Crypt-iQ",
      "id" : 15145615,
      "login" : "Crypt-iQ",
      "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
      "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
      "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
      "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/Crypt-iQ"
   }
}
