[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/27792).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [1440000bytes](https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1776361008) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n* [#27286](https://github.com/bitcoin/bitcoin/pull/27286) (wallet: Keep track of the wallet's own transaction outputs in memory by achow101)\n* [#25907](https://github.com/bitcoin/bitcoin/pull/25907) (wallet: rpc to add automatically generated descriptors by achow101)\n* [#25273](https://github.com/bitcoin/bitcoin/pull/25273) (wallet: Pass through transaction locktime and preset input sequences and scripts to CreateTransaction by achow101)\n* [#21283](https://github.com/bitcoin/bitcoin/pull/21283) (Implement BIP 370 PSBTv2 by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-31T07:50:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1569673880",
      "id" : 1569673880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585dj1KY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569673880/reactions"
      },
      "updated_at" : "2023-10-25T21:35:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569673880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@achow101 - per our discussion, I've created a PR with the core \"deniability\" functionality in the main repo here. The GUI portion is rebased over this branch and is in the GUI repo. I've updated the PRs' descriptions to point to each other.\r\nPlease let me know what you think. Thanks!",
      "created_at" : "2023-05-31T08:00:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1569687477",
      "id" : 1569687477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585dj4e1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569687477/reactions"
      },
      "updated_at" : "2023-05-31T08:00:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569687477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not sure how much this achieves. Bitcoin Core's wallet has a \"unique\" fingerprint on transactions that is shared by way less than 50% of transactions in the network, so creating additional transactions where it is likely (latest when the outputs are spent) that it was a self-transfer seems only to be bloating the utxo set and chain space? I haven't thought about this, but it would be good to have a more in-depth analysis of this, considering using a different \"fingerprint vector\".",
      "created_at" : "2023-05-31T08:09:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1569702764",
      "id" : 1569702764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585dj8Ns",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569702764/reactions"
      },
      "updated_at" : "2023-05-31T08:09:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569702764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Bitcoin Core's wallet has a \"unique\" fingerprint on transactions that is shared by way less than 50% of transactions in the network ...\r\n\r\nBy fingerprint, do you mean Bitcoin Core's transactions can be identified on the block chain? If that's the case that's unfortunate for sure. What's the nature of the difference? Is it on purpose and if not, would it be possible to fix?",
      "created_at" : "2023-05-31T17:17:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1570613994",
      "id" : 1570613994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585dnarq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570613994/reactions"
      },
      "updated_at" : "2023-05-31T17:17:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570613994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "See for example https://github.com/achow101/wallet-fingerprinting/blob/main/fingerprints.md",
      "created_at" : "2023-06-01T06:49:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1571457996",
      "id" : 1571457996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585dqovM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1571457996/reactions"
      },
      "updated_at" : "2023-06-01T06:49:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1571457996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> See for example https://github.com/achow101/wallet-fingerprinting/blob/main/fingerprints.md\r\n\r\nThanks! \r\nAt a quick glance, it looks like Core's transactions are somewhat close to Electrum's. \r\nI'm not familiar with some of the items, but assuming it's possible, I can look into injecting some variety in the \"deniabilized\" transactions to make them resemble a variety of wallets (eg Electrum as a start). \r\nIs there prior work in this by any chance? That would help me for sure.\r\nAlso, should I pursue it for this PR, or would a follow up PR be acceptable as well?",
      "created_at" : "2023-06-01T22:22:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1572869964",
      "id" : 1572869964,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585dwBdM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572869964/reactions"
      },
      "updated_at" : "2023-06-01T22:58:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572869964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> It doesn't improve privacy. \r\n\r\nCan you please elaborate why you think so?\r\nPaul's blog post had some pretty compelling arguments why this scheme should work and I think it has a lot of merit.\r\n\r\n> False sense of privacy implemented in this pull request only helps miners with fees.\r\n\r\nIt's important to point out that this PR doesn't add functionality that couldn't be achieved manually before.\r\nIf a user wanted to split a coin and send it to themselves, they could do it with the existing Bitcoin Core (either via RPC/Console or the GUI). It's just cumbersome and error prone.\r\n\r\nThe API we're adding in this PR makes this a simple and robust single operation (C++ API call or RPC call).\r\nIt's entirely opt-in and the user can decide to use it or not, up to their own judgement on how effective it is in improving their privacy. I would assume anyone using the C++/RPC interface understands the implications and can be trusted to know what they are doing.\r\n\r\nThe GUI PR (https://github.com/bitcoin-core/gui/pull/733) implements automation on top of this API, which is also entirely opt-in. We provide an explanation of how it works, so the user could make an educated decision on whether to use it or not. \r\nA lot of new Bitcoin users (myself including), weren't aware early on that it's important to use new addresses when receiving BTC. Many exchanges also don't make it easy either (eg by requiring time-locked whitelisting etc).\r\nAs a result I suspect many users may wish to improve their privacy by \"deniabilizing\" their UTXOs after the fact.\r\nThis has been my main motivation to pursue creating this tool. I personally wanted to use it and I suspected others may appreciate it too. ",
      "created_at" : "2023-06-01T22:56:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1572892485",
      "id" : 1572892485,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585dwG9F",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572892485/reactions"
      },
      "updated_at" : "2023-06-01T23:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572892485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> It's important to point out that this PR doesn't add functionality that couldn't be achieved manually before.\r\nIf a user wanted to split a coin and send it to themselves, they could do it with the existing Bitcoin Core (either via RPC/Console or the GUI). It's just cumbersome and error prone.\r\n\r\nGood point and most of the people who tried this with coins involved in any incident regret doing it. Privacy in bitcoin is not as simple as doing some transactions with your own addresses automatically. There are lot of things you need to take care of. One mistake and your privacy is breached, publicly available for the whole world.\r\n\r\nPayjoin will improve privacy without wasting fees on these automated transactions by hiding the amounts involved in transaction. Presently, payjoin is less used because of the need for a server but this can be improved.",
      "created_at" : "2023-06-02T16:46:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1574030615",
      "id" : 1574030615,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585d0c0X",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1574030615/reactions"
      },
      "updated_at" : "2023-06-02T16:46:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1574030615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/134363042?v=4",
         "events_url" : "https://api.github.com/users/zkfrio/events{/privacy}",
         "followers_url" : "https://api.github.com/users/zkfrio/followers",
         "following_url" : "https://api.github.com/users/zkfrio/following{/other_user}",
         "gists_url" : "https://api.github.com/users/zkfrio/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/zkfrio",
         "id" : 134363042,
         "login" : "zkfrio",
         "node_id" : "U_kgDOCAI3og",
         "organizations_url" : "https://api.github.com/users/zkfrio/orgs",
         "received_events_url" : "https://api.github.com/users/zkfrio/received_events",
         "repos_url" : "https://api.github.com/users/zkfrio/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/zkfrio/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/zkfrio/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/zkfrio"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Good point and most of the people who tried this with coins involved in any incident regret doing it. Privacy in bitcoin is not as simple as doing some transactions with your own addresses automatically. There are lot of things you need to take care of. One mistake and your privacy is breached, publicly available for the whole world.\r\n\r\nWhat kind of incidents do you mean? Do you have some concrete examples?\r\nI don't see how one's privacy would be any worse after sending transactions to oneself. \r\nEach transaction moves further away from a potentially known UTXO, to new UTXOs that only the user's wallet knows are theirs. To a blockchain analysis that would look like a \"spend\" and they'll have to guess which one is potentially a different user and which one is a change address. With each split, the guesses become less and less accurate, thus leading to increased privacy, no?\r\nIf you see a flaw in this argument, please share you explanation, because I'm not seeing an issue.",
      "created_at" : "2023-06-03T16:07:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1575041987",
      "id" : 1575041987,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585d4TvD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575041987/reactions"
      },
      "updated_at" : "2023-06-03T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575041987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> > Good point and most of the people who tried this with coins involved in any incident regret doing it. Privacy in bitcoin is not as simple as doing some transactions with your own addresses automatically. There are lot of things you need to take care of. One mistake and your privacy is breached, publicly available for the whole world.\r\n> \r\n> What kind of incidents do you mean? Do you have some concrete examples? I don't see how one's privacy would be any worse after sending transactions to oneself. \r\n\r\nSorry. I cannot share exact incidents that involve \"crime\" on GitHub. However, you can look at this explanation from bitcoin privacy wiki to understand basics:\r\n\r\n_\"In a peeling chain, a single address begins with a relatively large amount of bitcoins. A smaller amount is then peeled off this larger amount, creating a transaction in which a small amount is transferred to one address, and the remainder is transferred to a one-time change address. This process is repeated - potentially for hundreds or thousands of hops - until the larger amount is pared down, at which point (in one usage) the amount remaining in the address might be aggregated with other such addresses to again yield a large amount in a single address, and the peeling process begins again[5].\"_\r\n\r\nhttps://en.bitcoin.it/wiki/Privacy",
      "created_at" : "2023-07-07T22:47:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1626337924",
      "id" : 1626337924,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585g7_KE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1626337924/reactions"
      },
      "updated_at" : "2023-07-07T22:47:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1626337924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/134363042?v=4",
         "events_url" : "https://api.github.com/users/zkfrio/events{/privacy}",
         "followers_url" : "https://api.github.com/users/zkfrio/followers",
         "following_url" : "https://api.github.com/users/zkfrio/following{/other_user}",
         "gists_url" : "https://api.github.com/users/zkfrio/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/zkfrio",
         "id" : 134363042,
         "login" : "zkfrio",
         "node_id" : "U_kgDOCAI3og",
         "organizations_url" : "https://api.github.com/users/zkfrio/orgs",
         "received_events_url" : "https://api.github.com/users/zkfrio/received_events",
         "repos_url" : "https://api.github.com/users/zkfrio/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/zkfrio/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/zkfrio/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/zkfrio"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Hi @ishaanam  and thank you for looking at my PR.\r\nI do agree the implementation can be improved and your feedback helps me greatly.\r\n\r\nHere are my thoughts regarding your concerns:\r\n1) I thought about this problem too and indeed spending deniabilized outputs is somewhat challenging. \r\nObviously, if the user just HODLs, or spends less than a deniabilized UTXO, then all is good. \r\nHowever if they spend larger amounts, more than one UTXOs would get picked up and that would reveal that they belong to the same user. \r\nI don't think this destroys the entire privacy gained from deniabilization, since in a regular \"spend\" transaction with no-reuse tag, would look similar to deniabilized transaction, and blockchain analysis would've probably assigned some probability that some UTXOs are change, and our spending would confirm those ... But yes, the larger the spend the more would be revealed, so it's not ideal. \r\nPerhaps we could augment the UTXO selection algorithm to be deniabilization-aware, and perhaps there's ways to pick UTXO that minimize the damage? I'm not sure what heuristic we should use for that, so I'm open to suggestions.\r\nAnother option would be to provide a user parameter for \"likely spendable size\", which we use in the chunking decision and make strictly bigger chunks if possible. There's already logic that avoids \"dust\" chunks so it won't be difficult to extend in that direction.\r\n\r\n2) Yes, the fingerprint concern is valid and unfortunate (and sadly I wasn't aware of it when I started this work). However it's also a pre-existing problem and while I do agree we should fix it, I'm hoping we could do this in a separate PR. Also I'm not yet knowledgable enough to tackle it, so if you guys want me to pursue a solution I could use some help.\r\n\r\n3) The reason for grouping UTXOs that share the same address is that (and correct me if I'm wrong) if we can spend one UTXO from a given address, then we have ownership of all UTXOs that share that address. In other words, we don't lose any privacy by deniabilizing the whole group. \r\nIn my limited experience, large amount of shared-address UTXOs tends to happen when transferring from an exchange (eg periodic buys) - often people don't update their withdrawal address, and many exchanges make it difficult to update (eg by requiring whitelisting and so on).\r\nThis grouping allows the deniabilization process to actually reduce the UTXO count if used for just few cycles.\r\nAt any rate, it would be trivial do disable the grouping if there's a flaw in this reasoning, or otherwise have it on a user toggle or some such.\r\n\r\n> Given this, Iâm unsure whether it would make sense for an implementation of something like this to be built directly into \r\nBitcoin Core\r\n\r\nI thought about if this could be implemented in some kind of a plugin, but as far as I know, there's no support for plugins yet?\r\nOriginally my PR was entirely in the GUI, since I wanted to avoid API changes, but @achow101 correctly pointed out it would be safer and easier to test the main functions as part of the wallet API, so that's why I split the PR into a core and GUI parts.\r\nIf there's a path to implement this in a more \"plugin\" way, I'd be interested to hear of course.\r\n\r\nThank you for your feedback. I greatly appreciate it.",
      "created_at" : "2023-07-10T03:53:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1628080840",
      "id" : 1628080840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585hCorI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1628080840/reactions"
      },
      "updated_at" : "2023-07-10T03:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1628080840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> 1. But yes, the larger the spend the more would be revealed, so it's not ideal.\r\n\r\nNot only that, but if you spend a UTXO thatâs the change from the previous transaction with the output of the next, thatâs one thing. But if you spend an output with the change from fifteen transactions prior, you may heavily imply that all payments in between were also self-sends.\r\n\r\n> * Another option would be to provide a user parameter for \"likely spendable size\", which we use in the chunking decision and make strictly bigger chunks if possible. There's already logic that avoids \"dust\" chunks so it won't be difficult to extend in that direction.\r\n\r\nYeah, that sounds like a reasonable direction of development. It would e.g. be possible to pick from two otherwise similar inputs sets the one that creates a change output whose value is most different from other UTXOs already in the wallet. Otherwise, it is a bit difficult to predict what a âlikely spendable sizeâ is, since it depends on many different factors such as future exchange rate, and unknown future motivations for the user to create transactions. I would surmise that past transactions would only have a limited utility in predicting future spending sizes. In fact in my master-thesis, I explored a similar idea by attempting to always create change of a similar amount as the recipient output. Unfortunately, the resulting UTXO pool performed subpar.",
      "created_at" : "2023-07-11T18:07:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1631267324",
      "id" : 1631267324,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585hOyn8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1631267324/reactions"
      },
      "updated_at" : "2023-07-11T18:07:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1631267324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-19T09:36:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1641757611",
      "id" : 1641757611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585h2zur",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1641757611/reactions"
      },
      "updated_at" : "2023-07-19T09:36:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1641757611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "In a tx graph ( tree really ) with large and randomized fan out, eventual merging of some terminal UTXOs does not necessarily indicate that the later clustered entity is the same entity that was KYCâed on an exchange prior to the deniabilization fan out. Some probability maybe assigned to both entities being the same but thereâs also a combinatorial explosion of other possible clusterings in between.",
      "created_at" : "2023-08-08T06:31:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1668987567",
      "id" : 1668987567,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585jerqv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668987567/reactions"
      },
      "updated_at" : "2023-08-08T06:37:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668987567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/74521?v=4",
         "events_url" : "https://api.github.com/users/kravets/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kravets/followers",
         "following_url" : "https://api.github.com/users/kravets/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kravets/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kravets",
         "id" : 74521,
         "login" : "kravets",
         "node_id" : "MDQ6VXNlcjc0NTIx",
         "organizations_url" : "https://api.github.com/users/kravets/orgs",
         "received_events_url" : "https://api.github.com/users/kravets/received_events",
         "repos_url" : "https://api.github.com/users/kravets/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kravets/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kravets/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kravets"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Would it not be better to postpone removing the Core tx fingerprints  to Deniabilization 1.1 or 2.0 version and get this safe, isolated UI centric feature merged in sooner rather than later ?",
      "created_at" : "2023-08-08T06:39:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1668995563",
      "id" : 1668995563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585jetnr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668995563/reactions"
      },
      "updated_at" : "2023-08-08T06:39:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668995563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/74521?v=4",
         "events_url" : "https://api.github.com/users/kravets/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kravets/followers",
         "following_url" : "https://api.github.com/users/kravets/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kravets/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kravets",
         "id" : 74521,
         "login" : "kravets",
         "node_id" : "MDQ6VXNlcjc0NTIx",
         "organizations_url" : "https://api.github.com/users/kravets/orgs",
         "received_events_url" : "https://api.github.com/users/kravets/received_events",
         "repos_url" : "https://api.github.com/users/kravets/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kravets/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kravets/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kravets"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase if still relevant",
      "created_at" : "2023-10-04T15:41:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1747163307",
      "id" : 1747163307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585oI5ir",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1747163307/reactions"
      },
      "updated_at" : "2023-10-04T15:41:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1747163307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Needs rebase if still relevant\r\n\r\nAh, I didn't notice, sorry. I'll rebase it now.",
      "created_at" : "2023-10-06T16:35:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1751075877",
      "id" : 1751075877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585oX0wl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751075877/reactions"
      },
      "updated_at" : "2023-10-06T16:35:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751075877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I hit an issue in my wallet tests after rebasing. Looks like a bug was introduced in ExtractDestination. I left a comment in https://github.com/bitcoin/bitcoin/pull/28246\r\n",
      "created_at" : "2023-10-06T17:05:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1751118802",
      "id" : 1751118802,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585oX_PS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751118802/reactions"
      },
      "updated_at" : "2023-10-06T17:05:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751118802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maybe mark as draft while CI is red?",
      "created_at" : "2023-10-07T09:41:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1751666369",
      "id" : 1751666369,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585oaE7B",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751666369/reactions"
      },
      "updated_at" : "2023-10-07T09:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751666369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349552527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349552527"
         }
      },
      "author_association" : "NONE",
      "body" : "@achow101 - continuing our PubKeyDestination discussion here.\r\nIn the highlighted code I was trying to determine if all inputs share the same address or not. \r\nThis seemed to work in all my tests, for real wallets and for unit test wallets (eg from coinbase keys), however with the introduction of the PubKeyDestination address, this now breaks for coinbase keys. In particular the call to OutputTypeFromDestination further down in this function, now returns nullopt.\r\nI suspect my understanding of scripts and addresses is flawed. I assumed scripts is just the general encoding of addresses on the block chain, while addresses (CTxDestination) are specialized classes of address types that Bitcoin Core understands, and I assumed CNoDestination is just addresses we don't understand and can't use for transactions. I'm guessing there's more to it?\r\nHow should I modify my code to correctly handle the new PubKeyDestination, which seems to be how coinbase key wallet scripts get classified now?\r\nI added a quick hack to pass the CI below, but it sounds like this is probably not correct behavior (to treat PubKeyDestination as OutputType::Legacy).\r\nThank you in advance!",
      "commit_id" : "4c731398d3b62b68581f65dd2a9e4246eae017c3",
      "created_at" : "2023-10-07T17:56:11Z",
      "diff_hunk" : "@@ -1392,4 +1392,302 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     return true;\n }\n+\n+constexpr int NUM_DENIABILIZATION_OUTPUTS = 2;\n+\n+static unsigned int CalculateDeniabilizationTxSize(const CTxDestination& address, CAmount value, unsigned int numTxIn)\n+{\n+    // Calculation based on the comments and code in GetDustThreshold and CreateTransactionInternal\n+    CScript script = GetScriptForDestination(address);\n+    unsigned int txOutSize = (unsigned int)GetSerializeSize(CTxOut(value, script), PROTOCOL_VERSION);\n+\n+    const size_t txOutCount = NUM_DENIABILIZATION_OUTPUTS;\n+    unsigned int txSize = 10 + GetSizeOfCompactSize(txOutCount); // bytes for output count\n+    txSize += txOutSize * txOutCount;\n+\n+    int witnessversion = 0;\n+    std::vector<unsigned char> witnessprogram;\n+    if (script.IsWitnessProgram(witnessversion, witnessprogram)) {\n+        txSize += (unsigned int)(numTxIn * 67.75f + 0.5f);\n+    } else {\n+        txSize += numTxIn * 148;\n+    }\n+    return txSize;\n+}\n+\n+float CalculateDeniabilizationProbability(unsigned int deniabilization_cycles)\n+{\n+    // 100%, 50%, 25%, 13%, 6%, 3%, 2%, 1%\n+    return powf(0.5f, deniabilization_cycles);\n+}\n+\n+bool IsDeniabilizationWorthwhile(CAmount total_value, CAmount fee_estimate)\n+{\n+    constexpr CAmount value_to_fee_ratio = 10;\n+    return total_value > fee_estimate * value_to_fee_ratio;\n+}\n+\n+CCoinControl SetupDeniabilizationCoinControl(unsigned int confirm_target)\n+{\n+    CCoinControl coin_control;\n+    coin_control.m_avoid_address_reuse = true;\n+    coin_control.m_avoid_partial_spends = true;\n+    coin_control.m_allow_other_inputs = false;\n+    coin_control.m_signal_bip125_rbf = true;\n+    coin_control.m_confirm_target = confirm_target;\n+    // we'll automatically bump the fee if economical ends up not confirming by the next deniabilization cycle\n+    coin_control.m_fee_mode = FeeEstimateMode::ECONOMICAL;\n+    return coin_control;\n+}\n+\n+CFeeRate CalculateDeniabilizationFeeRate(const CWallet& wallet, unsigned int confirm_target)\n+{\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+\n+    CFeeRate requiredFeeRate = GetRequiredFeeRate(wallet);\n+    FeeCalculation fee_calc;\n+    CFeeRate minFeeRate = GetMinimumFeeRate(wallet, coin_control, &fee_calc);\n+    if (fee_calc.reason == FeeReason::FALLBACK || requiredFeeRate > minFeeRate)\n+        return requiredFeeRate;\n+    return minFeeRate;\n+}\n+\n+static CAmount CalculateDeniabilizationTxFee(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, const CFeeRate& fee_rate)\n+{\n+    Assert(num_utxos > 0);\n+    unsigned int deniabilization_tx_size = CalculateDeniabilizationTxSize(shared_destination, total_value, num_utxos);\n+    return fee_rate.GetFee(deniabilization_tx_size);\n+}\n+\n+CAmount CalculateDeniabilizationFeeEstimate(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, unsigned int deniabilization_cycles, const CFeeRate& fee_rate)\n+{\n+    float deniabilizationProbability = CalculateDeniabilizationProbability(deniabilization_cycles);\n+    // convert to integer percent to truncate and check for zero probability\n+    unsigned int deniabilizationProbabilityPercent = deniabilizationProbability * 100;\n+    if (deniabilizationProbabilityPercent == 0) {\n+        return 0;\n+    }\n+\n+    // this cycle will use all the UTXOs, while following cycles will have just one UTXO\n+    CAmount deniabilizationFee = CalculateDeniabilizationTxFee(shared_destination, total_value, num_utxos, fee_rate);\n+\n+    // calculate the fees from future deniabilization cycles\n+    CAmount futureDeniabilizationFee = CalculateDeniabilizationFeeEstimate(shared_destination, total_value / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, fee_rate) * 2;\n+\n+    // if it's worthwhile to do future deniabilizations then add them to this cycle estimate\n+    if (IsDeniabilizationWorthwhile(total_value, deniabilizationFee + futureDeniabilizationFee)) {\n+        deniabilizationFee += futureDeniabilizationFee;\n+    }\n+    return deniabilizationFee;\n+}\n+\n+std::pair<unsigned int, bool> CalculateDeniabilizationCycles(CWallet& wallet, const COutPoint& outpoint)\n+{\n+    LOCK(wallet.cs_wallet);\n+    auto walletTx = wallet.GetWalletTx(outpoint.hash);\n+    if (!walletTx) {\n+        return std::make_pair(0, false);\n+    }\n+    auto tx = walletTx->tx;\n+\n+    if (tx->IsCoinBase()) {\n+        // this is a block reward tx, so we tag it as such\n+        return std::make_pair(0, true);\n+    }\n+\n+    // an deniabilized coin is one we sent to ourselves\n+    // all txIn should belong to our wallet\n+    if (tx->vin.empty()) {\n+        return std::make_pair(0, false);\n+    }\n+    for (const auto& txIn : tx->vin) {\n+        if (InputIsMine(wallet, txIn) == ISMINE_NO) {\n+            return std::make_pair(0, false);\n+        }\n+    }\n+\n+    // all txOut should belong to our wallet\n+    Assert(outpoint.n < tx->vout.size());\n+    unsigned int n = 0;\n+    for (const auto& txOut : tx->vout) {\n+        if (wallet.IsMine(txOut) == ISMINE_NO) {\n+            Assert(n != outpoint.n);\n+            return std::make_pair(0, false);\n+        }\n+        n++;\n+    }\n+\n+    unsigned int uniqueTxOutCount = 0;\n+    for (const auto& txOut : tx->vout) {\n+        // check if it's a valid destination\n+        CTxDestination txOutDestination;\n+        ExtractDestination(txOut.scriptPubKey, txOutDestination);\n+        if (std::get_if<CNoDestination>(&txOutDestination)) {\n+            continue;\n+        }\n+\n+        // don't count outputs that match any input addresses (eg it's change output)\n+        bool matchesInput = false;\n+        for (const auto& txIn : tx->vin) {\n+            auto prevWalletTx = wallet.GetWalletTx(txIn.prevout.hash);\n+            if (prevWalletTx && prevWalletTx->tx->vout[txIn.prevout.n].scriptPubKey == txOut.scriptPubKey) {\n+                matchesInput = true;\n+                break;\n+            }\n+        }\n+        if (matchesInput) {\n+            continue;\n+        }\n+\n+        uniqueTxOutCount++;\n+    }\n+\n+    // we consider two or more unique outputs an \"deniabilization\" of the coin\n+    unsigned int deniabilizationCycles = uniqueTxOutCount >= 2 ? 1 : 0;\n+\n+    // all txIn and txOut are from our wallet\n+    // however if we have multiple txIn this was either an initial deniabilization of multiple UTXOs or the user manually merged deniabilized UTXOs\n+    // in either case we don't need to recurse into parent transactions and we can return the calculated cycles\n+    if (tx->vin.size() > 1) {\n+        return std::make_pair(deniabilizationCycles, false);\n+    }\n+\n+    const auto& txIn = tx->vin[0];\n+    // now recursively calculate the deniabilization cycles of the input\n+    auto inputStats = CalculateDeniabilizationCycles(wallet, txIn.prevout);\n+    return std::make_pair(inputStats.first + deniabilizationCycles, inputStats.second);\n+};\n+\n+util::Result<CreatedTransactionResult> CreateDeniabilizationTransaction(CWallet& wallet, const std::set<COutPoint>& inputs, unsigned int confirm_target, unsigned int deniabilization_cycles, bool sign, bool& insufficient_amount)\n+{\n+    if (inputs.empty()) {\n+        return util::Error{_(\"Inputs must not be empty\")};\n+    }\n+\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+    for (const auto& input : inputs) {\n+        coin_control.Select(input);\n+    }\n+    Assert(coin_control.HasSelected());\n+    CFeeRate deniabilization_fee_rate = CalculateDeniabilizationFeeRate(wallet, confirm_target);\n+    coin_control.m_feerate = deniabilization_fee_rate;\n+\n+    LOCK(wallet.cs_wallet);\n+\n+    FastRandomContext rng_fast;\n+    CoinSelectionParams coin_selection_params{rng_fast};\n+    auto res_fetch_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+    if (!res_fetch_inputs) {\n+        return util::Error{util::ErrorString(res_fetch_inputs)};\n+    }\n+    PreSelectedInputs preset_inputs = *res_fetch_inputs;\n+    CAmount total_amount = preset_inputs.total_amount;\n+\n+    // validate that all UTXOs share the same address\n+    std::optional<CTxDestination> op_shared_destination;\n+    for (const auto& coin : preset_inputs.coins) {\n+        CTxDestination destination = CNoDestination();\n+        ExtractDestination(coin->txout.scriptPubKey, destination);\n+        if (!std::get_if<CNoDestination>(&destination) && !op_shared_destination) {\n+            op_shared_destination = destination;\n+        }\n+        if (!op_shared_destination || !(*op_shared_destination == destination)) {\n+            return util::Error{_(\"Input addresses must all match.\")};\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349552527",
      "id" : 1349552527,
      "line" : 1597,
      "node_id" : "PRRC_kwDOABII585QcImP",
      "original_commit_id" : "4c731398d3b62b68581f65dd2a9e4246eae017c3",
      "original_line" : 1597,
      "original_position" : 206,
      "original_start_line" : 1586,
      "path" : "src/wallet/spend.cpp",
      "position" : 206,
      "pull_request_review_id" : 1663087526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349552527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1586,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-07T17:56:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349552527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349555508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349555508"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest that you operate entirely on `CScript`s rather than `CTxDestination`s. Under the previous semantics, P2PK and P2PKH scripts would be bundled together which I don't think is actually the behavior that you want. It would be better to use `CScript` and the `Solver` to get precise script types, and avoid using `CTxDestination` and `OutputType`. The latter two are more for user input and display rather than providing precise distinction between scripts. Scripts are always precise and accurate as they are what appear in transactions. We sometimes abstract away things about addresses and address types to the user to make things easier to understand and so meaning can be lost.",
      "commit_id" : "937e17a94a70b707170467b74cea1696d6286030",
      "created_at" : "2023-10-07T18:02:53Z",
      "diff_hunk" : "@@ -1392,4 +1392,302 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     return true;\n }\n+\n+constexpr int NUM_DENIABILIZATION_OUTPUTS = 2;\n+\n+static unsigned int CalculateDeniabilizationTxSize(const CTxDestination& address, CAmount value, unsigned int numTxIn)\n+{\n+    // Calculation based on the comments and code in GetDustThreshold and CreateTransactionInternal\n+    CScript script = GetScriptForDestination(address);\n+    unsigned int txOutSize = (unsigned int)GetSerializeSize(CTxOut(value, script), PROTOCOL_VERSION);\n+\n+    const size_t txOutCount = NUM_DENIABILIZATION_OUTPUTS;\n+    unsigned int txSize = 10 + GetSizeOfCompactSize(txOutCount); // bytes for output count\n+    txSize += txOutSize * txOutCount;\n+\n+    int witnessversion = 0;\n+    std::vector<unsigned char> witnessprogram;\n+    if (script.IsWitnessProgram(witnessversion, witnessprogram)) {\n+        txSize += (unsigned int)(numTxIn * 67.75f + 0.5f);\n+    } else {\n+        txSize += numTxIn * 148;\n+    }\n+    return txSize;\n+}\n+\n+float CalculateDeniabilizationProbability(unsigned int deniabilization_cycles)\n+{\n+    // 100%, 50%, 25%, 13%, 6%, 3%, 2%, 1%\n+    return powf(0.5f, deniabilization_cycles);\n+}\n+\n+bool IsDeniabilizationWorthwhile(CAmount total_value, CAmount fee_estimate)\n+{\n+    constexpr CAmount value_to_fee_ratio = 10;\n+    return total_value > fee_estimate * value_to_fee_ratio;\n+}\n+\n+CCoinControl SetupDeniabilizationCoinControl(unsigned int confirm_target)\n+{\n+    CCoinControl coin_control;\n+    coin_control.m_avoid_address_reuse = true;\n+    coin_control.m_avoid_partial_spends = true;\n+    coin_control.m_allow_other_inputs = false;\n+    coin_control.m_signal_bip125_rbf = true;\n+    coin_control.m_confirm_target = confirm_target;\n+    // we'll automatically bump the fee if economical ends up not confirming by the next deniabilization cycle\n+    coin_control.m_fee_mode = FeeEstimateMode::ECONOMICAL;\n+    return coin_control;\n+}\n+\n+CFeeRate CalculateDeniabilizationFeeRate(const CWallet& wallet, unsigned int confirm_target)\n+{\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+\n+    CFeeRate requiredFeeRate = GetRequiredFeeRate(wallet);\n+    FeeCalculation fee_calc;\n+    CFeeRate minFeeRate = GetMinimumFeeRate(wallet, coin_control, &fee_calc);\n+    if (fee_calc.reason == FeeReason::FALLBACK || requiredFeeRate > minFeeRate)\n+        return requiredFeeRate;\n+    return minFeeRate;\n+}\n+\n+static CAmount CalculateDeniabilizationTxFee(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, const CFeeRate& fee_rate)\n+{\n+    Assert(num_utxos > 0);\n+    unsigned int deniabilization_tx_size = CalculateDeniabilizationTxSize(shared_destination, total_value, num_utxos);\n+    return fee_rate.GetFee(deniabilization_tx_size);\n+}\n+\n+CAmount CalculateDeniabilizationFeeEstimate(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, unsigned int deniabilization_cycles, const CFeeRate& fee_rate)\n+{\n+    float deniabilizationProbability = CalculateDeniabilizationProbability(deniabilization_cycles);\n+    // convert to integer percent to truncate and check for zero probability\n+    unsigned int deniabilizationProbabilityPercent = deniabilizationProbability * 100;\n+    if (deniabilizationProbabilityPercent == 0) {\n+        return 0;\n+    }\n+\n+    // this cycle will use all the UTXOs, while following cycles will have just one UTXO\n+    CAmount deniabilizationFee = CalculateDeniabilizationTxFee(shared_destination, total_value, num_utxos, fee_rate);\n+\n+    // calculate the fees from future deniabilization cycles\n+    CAmount futureDeniabilizationFee = CalculateDeniabilizationFeeEstimate(shared_destination, total_value / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, fee_rate) * 2;\n+\n+    // if it's worthwhile to do future deniabilizations then add them to this cycle estimate\n+    if (IsDeniabilizationWorthwhile(total_value, deniabilizationFee + futureDeniabilizationFee)) {\n+        deniabilizationFee += futureDeniabilizationFee;\n+    }\n+    return deniabilizationFee;\n+}\n+\n+std::pair<unsigned int, bool> CalculateDeniabilizationCycles(CWallet& wallet, const COutPoint& outpoint)\n+{\n+    LOCK(wallet.cs_wallet);\n+    auto walletTx = wallet.GetWalletTx(outpoint.hash);\n+    if (!walletTx) {\n+        return std::make_pair(0, false);\n+    }\n+    auto tx = walletTx->tx;\n+\n+    if (tx->IsCoinBase()) {\n+        // this is a block reward tx, so we tag it as such\n+        return std::make_pair(0, true);\n+    }\n+\n+    // an deniabilized coin is one we sent to ourselves\n+    // all txIn should belong to our wallet\n+    if (tx->vin.empty()) {\n+        return std::make_pair(0, false);\n+    }\n+    for (const auto& txIn : tx->vin) {\n+        if (InputIsMine(wallet, txIn) == ISMINE_NO) {\n+            return std::make_pair(0, false);\n+        }\n+    }\n+\n+    // all txOut should belong to our wallet\n+    Assert(outpoint.n < tx->vout.size());\n+    unsigned int n = 0;\n+    for (const auto& txOut : tx->vout) {\n+        if (wallet.IsMine(txOut) == ISMINE_NO) {\n+            Assert(n != outpoint.n);\n+            return std::make_pair(0, false);\n+        }\n+        n++;\n+    }\n+\n+    unsigned int uniqueTxOutCount = 0;\n+    for (const auto& txOut : tx->vout) {\n+        // check if it's a valid destination\n+        CTxDestination txOutDestination;\n+        ExtractDestination(txOut.scriptPubKey, txOutDestination);\n+        if (std::get_if<CNoDestination>(&txOutDestination)) {\n+            continue;\n+        }\n+\n+        // don't count outputs that match any input addresses (eg it's change output)\n+        bool matchesInput = false;\n+        for (const auto& txIn : tx->vin) {\n+            auto prevWalletTx = wallet.GetWalletTx(txIn.prevout.hash);\n+            if (prevWalletTx && prevWalletTx->tx->vout[txIn.prevout.n].scriptPubKey == txOut.scriptPubKey) {\n+                matchesInput = true;\n+                break;\n+            }\n+        }\n+        if (matchesInput) {\n+            continue;\n+        }\n+\n+        uniqueTxOutCount++;\n+    }\n+\n+    // we consider two or more unique outputs an \"deniabilization\" of the coin\n+    unsigned int deniabilizationCycles = uniqueTxOutCount >= 2 ? 1 : 0;\n+\n+    // all txIn and txOut are from our wallet\n+    // however if we have multiple txIn this was either an initial deniabilization of multiple UTXOs or the user manually merged deniabilized UTXOs\n+    // in either case we don't need to recurse into parent transactions and we can return the calculated cycles\n+    if (tx->vin.size() > 1) {\n+        return std::make_pair(deniabilizationCycles, false);\n+    }\n+\n+    const auto& txIn = tx->vin[0];\n+    // now recursively calculate the deniabilization cycles of the input\n+    auto inputStats = CalculateDeniabilizationCycles(wallet, txIn.prevout);\n+    return std::make_pair(inputStats.first + deniabilizationCycles, inputStats.second);\n+};\n+\n+util::Result<CreatedTransactionResult> CreateDeniabilizationTransaction(CWallet& wallet, const std::set<COutPoint>& inputs, unsigned int confirm_target, unsigned int deniabilization_cycles, bool sign, bool& insufficient_amount)\n+{\n+    if (inputs.empty()) {\n+        return util::Error{_(\"Inputs must not be empty\")};\n+    }\n+\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+    for (const auto& input : inputs) {\n+        coin_control.Select(input);\n+    }\n+    Assert(coin_control.HasSelected());\n+    CFeeRate deniabilization_fee_rate = CalculateDeniabilizationFeeRate(wallet, confirm_target);\n+    coin_control.m_feerate = deniabilization_fee_rate;\n+\n+    LOCK(wallet.cs_wallet);\n+\n+    FastRandomContext rng_fast;\n+    CoinSelectionParams coin_selection_params{rng_fast};\n+    auto res_fetch_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+    if (!res_fetch_inputs) {\n+        return util::Error{util::ErrorString(res_fetch_inputs)};\n+    }\n+    PreSelectedInputs preset_inputs = *res_fetch_inputs;\n+    CAmount total_amount = preset_inputs.total_amount;\n+\n+    // validate that all UTXOs share the same address\n+    std::optional<CTxDestination> op_shared_destination;\n+    for (const auto& coin : preset_inputs.coins) {\n+        CTxDestination destination = CNoDestination();\n+        ExtractDestination(coin->txout.scriptPubKey, destination);\n+        if (!std::get_if<CNoDestination>(&destination) && !op_shared_destination) {\n+            op_shared_destination = destination;\n+        }\n+        if (!op_shared_destination || !(*op_shared_destination == destination)) {\n+            return util::Error{_(\"Input addresses must all match.\")};\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349555508",
      "id" : 1349555508,
      "in_reply_to_id" : 1349552527,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QcJU0",
      "original_commit_id" : "4c731398d3b62b68581f65dd2a9e4246eae017c3",
      "original_line" : 1597,
      "original_position" : 206,
      "original_start_line" : 1586,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1663091519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349555508/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-07T18:03:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349555508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349558005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349558005"
         }
      },
      "author_association" : "NONE",
      "body" : "How do I compare one CScript with another (in particular one txout.scriptPubKey with another). \r\nThe idea being that I want to issue a transaction where the inputs are strictly inputs that share the same \"address\" (address in layman terms - the address that people copy/paste to receive BTC).",
      "commit_id" : "937e17a94a70b707170467b74cea1696d6286030",
      "created_at" : "2023-10-07T18:19:25Z",
      "diff_hunk" : "@@ -1392,4 +1392,302 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     return true;\n }\n+\n+constexpr int NUM_DENIABILIZATION_OUTPUTS = 2;\n+\n+static unsigned int CalculateDeniabilizationTxSize(const CTxDestination& address, CAmount value, unsigned int numTxIn)\n+{\n+    // Calculation based on the comments and code in GetDustThreshold and CreateTransactionInternal\n+    CScript script = GetScriptForDestination(address);\n+    unsigned int txOutSize = (unsigned int)GetSerializeSize(CTxOut(value, script), PROTOCOL_VERSION);\n+\n+    const size_t txOutCount = NUM_DENIABILIZATION_OUTPUTS;\n+    unsigned int txSize = 10 + GetSizeOfCompactSize(txOutCount); // bytes for output count\n+    txSize += txOutSize * txOutCount;\n+\n+    int witnessversion = 0;\n+    std::vector<unsigned char> witnessprogram;\n+    if (script.IsWitnessProgram(witnessversion, witnessprogram)) {\n+        txSize += (unsigned int)(numTxIn * 67.75f + 0.5f);\n+    } else {\n+        txSize += numTxIn * 148;\n+    }\n+    return txSize;\n+}\n+\n+float CalculateDeniabilizationProbability(unsigned int deniabilization_cycles)\n+{\n+    // 100%, 50%, 25%, 13%, 6%, 3%, 2%, 1%\n+    return powf(0.5f, deniabilization_cycles);\n+}\n+\n+bool IsDeniabilizationWorthwhile(CAmount total_value, CAmount fee_estimate)\n+{\n+    constexpr CAmount value_to_fee_ratio = 10;\n+    return total_value > fee_estimate * value_to_fee_ratio;\n+}\n+\n+CCoinControl SetupDeniabilizationCoinControl(unsigned int confirm_target)\n+{\n+    CCoinControl coin_control;\n+    coin_control.m_avoid_address_reuse = true;\n+    coin_control.m_avoid_partial_spends = true;\n+    coin_control.m_allow_other_inputs = false;\n+    coin_control.m_signal_bip125_rbf = true;\n+    coin_control.m_confirm_target = confirm_target;\n+    // we'll automatically bump the fee if economical ends up not confirming by the next deniabilization cycle\n+    coin_control.m_fee_mode = FeeEstimateMode::ECONOMICAL;\n+    return coin_control;\n+}\n+\n+CFeeRate CalculateDeniabilizationFeeRate(const CWallet& wallet, unsigned int confirm_target)\n+{\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+\n+    CFeeRate requiredFeeRate = GetRequiredFeeRate(wallet);\n+    FeeCalculation fee_calc;\n+    CFeeRate minFeeRate = GetMinimumFeeRate(wallet, coin_control, &fee_calc);\n+    if (fee_calc.reason == FeeReason::FALLBACK || requiredFeeRate > minFeeRate)\n+        return requiredFeeRate;\n+    return minFeeRate;\n+}\n+\n+static CAmount CalculateDeniabilizationTxFee(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, const CFeeRate& fee_rate)\n+{\n+    Assert(num_utxos > 0);\n+    unsigned int deniabilization_tx_size = CalculateDeniabilizationTxSize(shared_destination, total_value, num_utxos);\n+    return fee_rate.GetFee(deniabilization_tx_size);\n+}\n+\n+CAmount CalculateDeniabilizationFeeEstimate(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, unsigned int deniabilization_cycles, const CFeeRate& fee_rate)\n+{\n+    float deniabilizationProbability = CalculateDeniabilizationProbability(deniabilization_cycles);\n+    // convert to integer percent to truncate and check for zero probability\n+    unsigned int deniabilizationProbabilityPercent = deniabilizationProbability * 100;\n+    if (deniabilizationProbabilityPercent == 0) {\n+        return 0;\n+    }\n+\n+    // this cycle will use all the UTXOs, while following cycles will have just one UTXO\n+    CAmount deniabilizationFee = CalculateDeniabilizationTxFee(shared_destination, total_value, num_utxos, fee_rate);\n+\n+    // calculate the fees from future deniabilization cycles\n+    CAmount futureDeniabilizationFee = CalculateDeniabilizationFeeEstimate(shared_destination, total_value / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, fee_rate) * 2;\n+\n+    // if it's worthwhile to do future deniabilizations then add them to this cycle estimate\n+    if (IsDeniabilizationWorthwhile(total_value, deniabilizationFee + futureDeniabilizationFee)) {\n+        deniabilizationFee += futureDeniabilizationFee;\n+    }\n+    return deniabilizationFee;\n+}\n+\n+std::pair<unsigned int, bool> CalculateDeniabilizationCycles(CWallet& wallet, const COutPoint& outpoint)\n+{\n+    LOCK(wallet.cs_wallet);\n+    auto walletTx = wallet.GetWalletTx(outpoint.hash);\n+    if (!walletTx) {\n+        return std::make_pair(0, false);\n+    }\n+    auto tx = walletTx->tx;\n+\n+    if (tx->IsCoinBase()) {\n+        // this is a block reward tx, so we tag it as such\n+        return std::make_pair(0, true);\n+    }\n+\n+    // an deniabilized coin is one we sent to ourselves\n+    // all txIn should belong to our wallet\n+    if (tx->vin.empty()) {\n+        return std::make_pair(0, false);\n+    }\n+    for (const auto& txIn : tx->vin) {\n+        if (InputIsMine(wallet, txIn) == ISMINE_NO) {\n+            return std::make_pair(0, false);\n+        }\n+    }\n+\n+    // all txOut should belong to our wallet\n+    Assert(outpoint.n < tx->vout.size());\n+    unsigned int n = 0;\n+    for (const auto& txOut : tx->vout) {\n+        if (wallet.IsMine(txOut) == ISMINE_NO) {\n+            Assert(n != outpoint.n);\n+            return std::make_pair(0, false);\n+        }\n+        n++;\n+    }\n+\n+    unsigned int uniqueTxOutCount = 0;\n+    for (const auto& txOut : tx->vout) {\n+        // check if it's a valid destination\n+        CTxDestination txOutDestination;\n+        ExtractDestination(txOut.scriptPubKey, txOutDestination);\n+        if (std::get_if<CNoDestination>(&txOutDestination)) {\n+            continue;\n+        }\n+\n+        // don't count outputs that match any input addresses (eg it's change output)\n+        bool matchesInput = false;\n+        for (const auto& txIn : tx->vin) {\n+            auto prevWalletTx = wallet.GetWalletTx(txIn.prevout.hash);\n+            if (prevWalletTx && prevWalletTx->tx->vout[txIn.prevout.n].scriptPubKey == txOut.scriptPubKey) {\n+                matchesInput = true;\n+                break;\n+            }\n+        }\n+        if (matchesInput) {\n+            continue;\n+        }\n+\n+        uniqueTxOutCount++;\n+    }\n+\n+    // we consider two or more unique outputs an \"deniabilization\" of the coin\n+    unsigned int deniabilizationCycles = uniqueTxOutCount >= 2 ? 1 : 0;\n+\n+    // all txIn and txOut are from our wallet\n+    // however if we have multiple txIn this was either an initial deniabilization of multiple UTXOs or the user manually merged deniabilized UTXOs\n+    // in either case we don't need to recurse into parent transactions and we can return the calculated cycles\n+    if (tx->vin.size() > 1) {\n+        return std::make_pair(deniabilizationCycles, false);\n+    }\n+\n+    const auto& txIn = tx->vin[0];\n+    // now recursively calculate the deniabilization cycles of the input\n+    auto inputStats = CalculateDeniabilizationCycles(wallet, txIn.prevout);\n+    return std::make_pair(inputStats.first + deniabilizationCycles, inputStats.second);\n+};\n+\n+util::Result<CreatedTransactionResult> CreateDeniabilizationTransaction(CWallet& wallet, const std::set<COutPoint>& inputs, unsigned int confirm_target, unsigned int deniabilization_cycles, bool sign, bool& insufficient_amount)\n+{\n+    if (inputs.empty()) {\n+        return util::Error{_(\"Inputs must not be empty\")};\n+    }\n+\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+    for (const auto& input : inputs) {\n+        coin_control.Select(input);\n+    }\n+    Assert(coin_control.HasSelected());\n+    CFeeRate deniabilization_fee_rate = CalculateDeniabilizationFeeRate(wallet, confirm_target);\n+    coin_control.m_feerate = deniabilization_fee_rate;\n+\n+    LOCK(wallet.cs_wallet);\n+\n+    FastRandomContext rng_fast;\n+    CoinSelectionParams coin_selection_params{rng_fast};\n+    auto res_fetch_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+    if (!res_fetch_inputs) {\n+        return util::Error{util::ErrorString(res_fetch_inputs)};\n+    }\n+    PreSelectedInputs preset_inputs = *res_fetch_inputs;\n+    CAmount total_amount = preset_inputs.total_amount;\n+\n+    // validate that all UTXOs share the same address\n+    std::optional<CTxDestination> op_shared_destination;\n+    for (const auto& coin : preset_inputs.coins) {\n+        CTxDestination destination = CNoDestination();\n+        ExtractDestination(coin->txout.scriptPubKey, destination);\n+        if (!std::get_if<CNoDestination>(&destination) && !op_shared_destination) {\n+            op_shared_destination = destination;\n+        }\n+        if (!op_shared_destination || !(*op_shared_destination == destination)) {\n+            return util::Error{_(\"Input addresses must all match.\")};\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349558005",
      "id" : 1349558005,
      "in_reply_to_id" : 1349552527,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QcJ71",
      "original_commit_id" : "4c731398d3b62b68581f65dd2a9e4246eae017c3",
      "original_line" : 1597,
      "original_position" : 206,
      "original_start_line" : 1586,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1663094812,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349558005/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-07T18:46:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349558005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349564359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349564359"
         }
      },
      "author_association" : "NONE",
      "body" : "I think I figured it out. CScript appears to have an operator== so I switched to using that. I'm hoping this works in the way I wanted to compare equality of laymen \"addresses\".\r\n \r\nI pushed an update to the PR. Please let me know if this makes sense.",
      "commit_id" : "937e17a94a70b707170467b74cea1696d6286030",
      "created_at" : "2023-10-07T19:20:48Z",
      "diff_hunk" : "@@ -1392,4 +1392,302 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     return true;\n }\n+\n+constexpr int NUM_DENIABILIZATION_OUTPUTS = 2;\n+\n+static unsigned int CalculateDeniabilizationTxSize(const CTxDestination& address, CAmount value, unsigned int numTxIn)\n+{\n+    // Calculation based on the comments and code in GetDustThreshold and CreateTransactionInternal\n+    CScript script = GetScriptForDestination(address);\n+    unsigned int txOutSize = (unsigned int)GetSerializeSize(CTxOut(value, script), PROTOCOL_VERSION);\n+\n+    const size_t txOutCount = NUM_DENIABILIZATION_OUTPUTS;\n+    unsigned int txSize = 10 + GetSizeOfCompactSize(txOutCount); // bytes for output count\n+    txSize += txOutSize * txOutCount;\n+\n+    int witnessversion = 0;\n+    std::vector<unsigned char> witnessprogram;\n+    if (script.IsWitnessProgram(witnessversion, witnessprogram)) {\n+        txSize += (unsigned int)(numTxIn * 67.75f + 0.5f);\n+    } else {\n+        txSize += numTxIn * 148;\n+    }\n+    return txSize;\n+}\n+\n+float CalculateDeniabilizationProbability(unsigned int deniabilization_cycles)\n+{\n+    // 100%, 50%, 25%, 13%, 6%, 3%, 2%, 1%\n+    return powf(0.5f, deniabilization_cycles);\n+}\n+\n+bool IsDeniabilizationWorthwhile(CAmount total_value, CAmount fee_estimate)\n+{\n+    constexpr CAmount value_to_fee_ratio = 10;\n+    return total_value > fee_estimate * value_to_fee_ratio;\n+}\n+\n+CCoinControl SetupDeniabilizationCoinControl(unsigned int confirm_target)\n+{\n+    CCoinControl coin_control;\n+    coin_control.m_avoid_address_reuse = true;\n+    coin_control.m_avoid_partial_spends = true;\n+    coin_control.m_allow_other_inputs = false;\n+    coin_control.m_signal_bip125_rbf = true;\n+    coin_control.m_confirm_target = confirm_target;\n+    // we'll automatically bump the fee if economical ends up not confirming by the next deniabilization cycle\n+    coin_control.m_fee_mode = FeeEstimateMode::ECONOMICAL;\n+    return coin_control;\n+}\n+\n+CFeeRate CalculateDeniabilizationFeeRate(const CWallet& wallet, unsigned int confirm_target)\n+{\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+\n+    CFeeRate requiredFeeRate = GetRequiredFeeRate(wallet);\n+    FeeCalculation fee_calc;\n+    CFeeRate minFeeRate = GetMinimumFeeRate(wallet, coin_control, &fee_calc);\n+    if (fee_calc.reason == FeeReason::FALLBACK || requiredFeeRate > minFeeRate)\n+        return requiredFeeRate;\n+    return minFeeRate;\n+}\n+\n+static CAmount CalculateDeniabilizationTxFee(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, const CFeeRate& fee_rate)\n+{\n+    Assert(num_utxos > 0);\n+    unsigned int deniabilization_tx_size = CalculateDeniabilizationTxSize(shared_destination, total_value, num_utxos);\n+    return fee_rate.GetFee(deniabilization_tx_size);\n+}\n+\n+CAmount CalculateDeniabilizationFeeEstimate(const CTxDestination& shared_destination, CAmount total_value, unsigned int num_utxos, unsigned int deniabilization_cycles, const CFeeRate& fee_rate)\n+{\n+    float deniabilizationProbability = CalculateDeniabilizationProbability(deniabilization_cycles);\n+    // convert to integer percent to truncate and check for zero probability\n+    unsigned int deniabilizationProbabilityPercent = deniabilizationProbability * 100;\n+    if (deniabilizationProbabilityPercent == 0) {\n+        return 0;\n+    }\n+\n+    // this cycle will use all the UTXOs, while following cycles will have just one UTXO\n+    CAmount deniabilizationFee = CalculateDeniabilizationTxFee(shared_destination, total_value, num_utxos, fee_rate);\n+\n+    // calculate the fees from future deniabilization cycles\n+    CAmount futureDeniabilizationFee = CalculateDeniabilizationFeeEstimate(shared_destination, total_value / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, fee_rate) * 2;\n+\n+    // if it's worthwhile to do future deniabilizations then add them to this cycle estimate\n+    if (IsDeniabilizationWorthwhile(total_value, deniabilizationFee + futureDeniabilizationFee)) {\n+        deniabilizationFee += futureDeniabilizationFee;\n+    }\n+    return deniabilizationFee;\n+}\n+\n+std::pair<unsigned int, bool> CalculateDeniabilizationCycles(CWallet& wallet, const COutPoint& outpoint)\n+{\n+    LOCK(wallet.cs_wallet);\n+    auto walletTx = wallet.GetWalletTx(outpoint.hash);\n+    if (!walletTx) {\n+        return std::make_pair(0, false);\n+    }\n+    auto tx = walletTx->tx;\n+\n+    if (tx->IsCoinBase()) {\n+        // this is a block reward tx, so we tag it as such\n+        return std::make_pair(0, true);\n+    }\n+\n+    // an deniabilized coin is one we sent to ourselves\n+    // all txIn should belong to our wallet\n+    if (tx->vin.empty()) {\n+        return std::make_pair(0, false);\n+    }\n+    for (const auto& txIn : tx->vin) {\n+        if (InputIsMine(wallet, txIn) == ISMINE_NO) {\n+            return std::make_pair(0, false);\n+        }\n+    }\n+\n+    // all txOut should belong to our wallet\n+    Assert(outpoint.n < tx->vout.size());\n+    unsigned int n = 0;\n+    for (const auto& txOut : tx->vout) {\n+        if (wallet.IsMine(txOut) == ISMINE_NO) {\n+            Assert(n != outpoint.n);\n+            return std::make_pair(0, false);\n+        }\n+        n++;\n+    }\n+\n+    unsigned int uniqueTxOutCount = 0;\n+    for (const auto& txOut : tx->vout) {\n+        // check if it's a valid destination\n+        CTxDestination txOutDestination;\n+        ExtractDestination(txOut.scriptPubKey, txOutDestination);\n+        if (std::get_if<CNoDestination>(&txOutDestination)) {\n+            continue;\n+        }\n+\n+        // don't count outputs that match any input addresses (eg it's change output)\n+        bool matchesInput = false;\n+        for (const auto& txIn : tx->vin) {\n+            auto prevWalletTx = wallet.GetWalletTx(txIn.prevout.hash);\n+            if (prevWalletTx && prevWalletTx->tx->vout[txIn.prevout.n].scriptPubKey == txOut.scriptPubKey) {\n+                matchesInput = true;\n+                break;\n+            }\n+        }\n+        if (matchesInput) {\n+            continue;\n+        }\n+\n+        uniqueTxOutCount++;\n+    }\n+\n+    // we consider two or more unique outputs an \"deniabilization\" of the coin\n+    unsigned int deniabilizationCycles = uniqueTxOutCount >= 2 ? 1 : 0;\n+\n+    // all txIn and txOut are from our wallet\n+    // however if we have multiple txIn this was either an initial deniabilization of multiple UTXOs or the user manually merged deniabilized UTXOs\n+    // in either case we don't need to recurse into parent transactions and we can return the calculated cycles\n+    if (tx->vin.size() > 1) {\n+        return std::make_pair(deniabilizationCycles, false);\n+    }\n+\n+    const auto& txIn = tx->vin[0];\n+    // now recursively calculate the deniabilization cycles of the input\n+    auto inputStats = CalculateDeniabilizationCycles(wallet, txIn.prevout);\n+    return std::make_pair(inputStats.first + deniabilizationCycles, inputStats.second);\n+};\n+\n+util::Result<CreatedTransactionResult> CreateDeniabilizationTransaction(CWallet& wallet, const std::set<COutPoint>& inputs, unsigned int confirm_target, unsigned int deniabilization_cycles, bool sign, bool& insufficient_amount)\n+{\n+    if (inputs.empty()) {\n+        return util::Error{_(\"Inputs must not be empty\")};\n+    }\n+\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+    for (const auto& input : inputs) {\n+        coin_control.Select(input);\n+    }\n+    Assert(coin_control.HasSelected());\n+    CFeeRate deniabilization_fee_rate = CalculateDeniabilizationFeeRate(wallet, confirm_target);\n+    coin_control.m_feerate = deniabilization_fee_rate;\n+\n+    LOCK(wallet.cs_wallet);\n+\n+    FastRandomContext rng_fast;\n+    CoinSelectionParams coin_selection_params{rng_fast};\n+    auto res_fetch_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+    if (!res_fetch_inputs) {\n+        return util::Error{util::ErrorString(res_fetch_inputs)};\n+    }\n+    PreSelectedInputs preset_inputs = *res_fetch_inputs;\n+    CAmount total_amount = preset_inputs.total_amount;\n+\n+    // validate that all UTXOs share the same address\n+    std::optional<CTxDestination> op_shared_destination;\n+    for (const auto& coin : preset_inputs.coins) {\n+        CTxDestination destination = CNoDestination();\n+        ExtractDestination(coin->txout.scriptPubKey, destination);\n+        if (!std::get_if<CNoDestination>(&destination) && !op_shared_destination) {\n+            op_shared_destination = destination;\n+        }\n+        if (!op_shared_destination || !(*op_shared_destination == destination)) {\n+            return util::Error{_(\"Input addresses must all match.\")};\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349564359",
      "id" : 1349564359,
      "in_reply_to_id" : 1349552527,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QcLfH",
      "original_commit_id" : "4c731398d3b62b68581f65dd2a9e4246eae017c3",
      "original_line" : 1597,
      "original_position" : 206,
      "original_start_line" : 1586,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1663101013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349564359/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-07T19:20:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349564359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349564944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349564944"
         }
      },
      "author_association" : "NONE",
      "body" : "@achow101 m\r\nIs this a correct way to get an OutputType from a CScript? I need the OutputType for the ReserveDestination constructor.\r\nFor coinbase key wallet scripts, the destination gets classified as PubKeyDestination, thus OutputTypeFromDestination will return nullopt, so we'll end up using the wallet.m_default_address_type.\r\nThis appears to work, but I'm not sure if it's kosher ...",
      "commit_id" : "937e17a94a70b707170467b74cea1696d6286030",
      "created_at" : "2023-10-07T19:26:52Z",
      "diff_hunk" : "@@ -1392,4 +1392,293 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     return true;\n }\n+\n+constexpr int NUM_DENIABILIZATION_OUTPUTS = 2;\n+\n+static unsigned int CalculateDeniabilizationTxSize(const CScript& script, CAmount value, unsigned int numTxIn)\n+{\n+    // Calculation based on the comments and code in GetDustThreshold and CreateTransactionInternal\n+    unsigned int txOutSize = (unsigned int)GetSerializeSize(CTxOut(value, script), PROTOCOL_VERSION);\n+\n+    const size_t txOutCount = NUM_DENIABILIZATION_OUTPUTS;\n+    unsigned int txSize = 10 + GetSizeOfCompactSize(txOutCount); // bytes for output count\n+    txSize += txOutSize * txOutCount;\n+\n+    int witnessversion = 0;\n+    std::vector<unsigned char> witnessprogram;\n+    if (script.IsWitnessProgram(witnessversion, witnessprogram)) {\n+        txSize += (unsigned int)(numTxIn * 67.75f + 0.5f);\n+    } else {\n+        txSize += numTxIn * 148;\n+    }\n+    return txSize;\n+}\n+\n+float CalculateDeniabilizationProbability(unsigned int deniabilization_cycles)\n+{\n+    // 100%, 50%, 25%, 13%, 6%, 3%, 2%, 1%\n+    return powf(0.5f, deniabilization_cycles);\n+}\n+\n+bool IsDeniabilizationWorthwhile(CAmount total_value, CAmount fee_estimate)\n+{\n+    constexpr CAmount value_to_fee_ratio = 10;\n+    return total_value > fee_estimate * value_to_fee_ratio;\n+}\n+\n+CCoinControl SetupDeniabilizationCoinControl(unsigned int confirm_target)\n+{\n+    CCoinControl coin_control;\n+    coin_control.m_avoid_address_reuse = true;\n+    coin_control.m_avoid_partial_spends = true;\n+    coin_control.m_allow_other_inputs = false;\n+    coin_control.m_signal_bip125_rbf = true;\n+    coin_control.m_confirm_target = confirm_target;\n+    // we'll automatically bump the fee if economical ends up not confirming by the next deniabilization cycle\n+    coin_control.m_fee_mode = FeeEstimateMode::ECONOMICAL;\n+    return coin_control;\n+}\n+\n+CFeeRate CalculateDeniabilizationFeeRate(const CWallet& wallet, unsigned int confirm_target)\n+{\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+\n+    CFeeRate requiredFeeRate = GetRequiredFeeRate(wallet);\n+    FeeCalculation fee_calc;\n+    CFeeRate minFeeRate = GetMinimumFeeRate(wallet, coin_control, &fee_calc);\n+    if (fee_calc.reason == FeeReason::FALLBACK || requiredFeeRate > minFeeRate)\n+        return requiredFeeRate;\n+    return minFeeRate;\n+}\n+\n+static CAmount CalculateDeniabilizationTxFee(const CScript& shared_script, CAmount total_value, unsigned int num_utxos, const CFeeRate& fee_rate)\n+{\n+    Assert(num_utxos > 0);\n+    unsigned int deniabilization_tx_size = CalculateDeniabilizationTxSize(shared_script, total_value, num_utxos);\n+    return fee_rate.GetFee(deniabilization_tx_size);\n+}\n+\n+CAmount CalculateDeniabilizationFeeEstimate(const CScript& shared_script, CAmount total_value, unsigned int num_utxos, unsigned int deniabilization_cycles, const CFeeRate& fee_rate)\n+{\n+    float deniabilizationProbability = CalculateDeniabilizationProbability(deniabilization_cycles);\n+    // convert to integer percent to truncate and check for zero probability\n+    unsigned int deniabilizationProbabilityPercent = deniabilizationProbability * 100;\n+    if (deniabilizationProbabilityPercent == 0) {\n+        return 0;\n+    }\n+\n+    // this cycle will use all the UTXOs, while following cycles will have just one UTXO\n+    CAmount deniabilizationFee = CalculateDeniabilizationTxFee(shared_script, total_value, num_utxos, fee_rate);\n+\n+    // calculate the fees from future deniabilization cycles\n+    CAmount futureDeniabilizationFee = CalculateDeniabilizationFeeEstimate(shared_script, total_value / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, fee_rate) * 2;\n+\n+    // if it's worthwhile to do future deniabilizations then add them to this cycle estimate\n+    if (IsDeniabilizationWorthwhile(total_value, deniabilizationFee + futureDeniabilizationFee)) {\n+        deniabilizationFee += futureDeniabilizationFee;\n+    }\n+    return deniabilizationFee;\n+}\n+\n+std::pair<unsigned int, bool> CalculateDeniabilizationCycles(CWallet& wallet, const COutPoint& outpoint)\n+{\n+    LOCK(wallet.cs_wallet);\n+    auto walletTx = wallet.GetWalletTx(outpoint.hash);\n+    if (!walletTx) {\n+        return std::make_pair(0, false);\n+    }\n+    auto tx = walletTx->tx;\n+\n+    if (tx->IsCoinBase()) {\n+        // this is a block reward tx, so we tag it as such\n+        return std::make_pair(0, true);\n+    }\n+\n+    // an deniabilized coin is one we sent to ourselves\n+    // all txIn should belong to our wallet\n+    if (tx->vin.empty()) {\n+        return std::make_pair(0, false);\n+    }\n+    for (const auto& txIn : tx->vin) {\n+        if (InputIsMine(wallet, txIn) == ISMINE_NO) {\n+            return std::make_pair(0, false);\n+        }\n+    }\n+\n+    // all txOut should belong to our wallet\n+    Assert(outpoint.n < tx->vout.size());\n+    unsigned int n = 0;\n+    for (const auto& txOut : tx->vout) {\n+        if (wallet.IsMine(txOut) == ISMINE_NO) {\n+            Assert(n != outpoint.n);\n+            return std::make_pair(0, false);\n+        }\n+        n++;\n+    }\n+\n+    unsigned int uniqueTxOutCount = 0;\n+    for (const auto& txOut : tx->vout) {\n+        // check if it's a valid destination\n+        CTxDestination txOutDestination;\n+        ExtractDestination(txOut.scriptPubKey, txOutDestination);\n+        if (std::get_if<CNoDestination>(&txOutDestination)) {\n+            continue;\n+        }\n+\n+        // don't count outputs that match any input addresses (eg it's change output)\n+        bool matchesInput = false;\n+        for (const auto& txIn : tx->vin) {\n+            auto prevWalletTx = wallet.GetWalletTx(txIn.prevout.hash);\n+            if (prevWalletTx && prevWalletTx->tx->vout[txIn.prevout.n].scriptPubKey == txOut.scriptPubKey) {\n+                matchesInput = true;\n+                break;\n+            }\n+        }\n+        if (matchesInput) {\n+            continue;\n+        }\n+\n+        uniqueTxOutCount++;\n+    }\n+\n+    // we consider two or more unique outputs an \"deniabilization\" of the coin\n+    unsigned int deniabilizationCycles = uniqueTxOutCount >= 2 ? 1 : 0;\n+\n+    // all txIn and txOut are from our wallet\n+    // however if we have multiple txIn this was either an initial deniabilization of multiple UTXOs or the user manually merged deniabilized UTXOs\n+    // in either case we don't need to recurse into parent transactions and we can return the calculated cycles\n+    if (tx->vin.size() > 1) {\n+        return std::make_pair(deniabilizationCycles, false);\n+    }\n+\n+    const auto& txIn = tx->vin[0];\n+    // now recursively calculate the deniabilization cycles of the input\n+    auto inputStats = CalculateDeniabilizationCycles(wallet, txIn.prevout);\n+    return std::make_pair(inputStats.first + deniabilizationCycles, inputStats.second);\n+};\n+\n+util::Result<CreatedTransactionResult> CreateDeniabilizationTransaction(CWallet& wallet, const std::set<COutPoint>& inputs, unsigned int confirm_target, unsigned int deniabilization_cycles, bool sign, bool& insufficient_amount)\n+{\n+    if (inputs.empty()) {\n+        return util::Error{_(\"Inputs must not be empty\")};\n+    }\n+\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+    for (const auto& input : inputs) {\n+        coin_control.Select(input);\n+    }\n+    Assert(coin_control.HasSelected());\n+    CFeeRate deniabilization_fee_rate = CalculateDeniabilizationFeeRate(wallet, confirm_target);\n+    coin_control.m_feerate = deniabilization_fee_rate;\n+\n+    LOCK(wallet.cs_wallet);\n+\n+    FastRandomContext rng_fast;\n+    CoinSelectionParams coin_selection_params{rng_fast};\n+    auto res_fetch_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+    if (!res_fetch_inputs) {\n+        return util::Error{util::ErrorString(res_fetch_inputs)};\n+    }\n+    PreSelectedInputs preset_inputs = *res_fetch_inputs;\n+    CAmount total_amount = preset_inputs.total_amount;\n+\n+    // validate that all UTXOs share the same address\n+    std::optional<CScript> op_shared_script;\n+    for (const auto& coin : preset_inputs.coins) {\n+        if (!op_shared_script) {\n+            op_shared_script = coin->txout.scriptPubKey;\n+        }\n+        if (!op_shared_script || !(*op_shared_script == coin->txout.scriptPubKey)) {\n+            return util::Error{_(\"Input addresses must all match.\")};\n+        }\n+    }\n+    Assert(op_shared_script);\n+    CScript shared_script = *op_shared_script;\n+\n+    CFeeRate discard_feerate = GetDiscardRate(wallet);\n+    CAmount dust_threshold = GetDustThreshold(CTxOut(total_amount, shared_script), discard_feerate);\n+\n+    // deniabilize the UTXOs by splitting the value randomly\n+    // find a split that leaves enough amount post split to finish the deniabilization process in each new UTXO\n+    CAmount min_post_split_amount = CalculateDeniabilizationFeeEstimate(shared_script, total_amount / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, deniabilization_fee_rate) + dust_threshold;\n+    CAmount estimated_tx_fee = CalculateDeniabilizationTxFee(shared_script, total_amount, preset_inputs.coins.size(), deniabilization_fee_rate);\n+\n+    CAmount total_random_range = total_amount - min_post_split_amount * NUM_DENIABILIZATION_OUTPUTS - estimated_tx_fee;\n+    if (total_random_range < 0) {\n+        insufficient_amount = true;\n+        return util::Error{strprintf(_(\"Insufficient amount (%d) for a deniabilization transaction, min amount (%d), tx fee (%d).\"), total_amount, min_post_split_amount, estimated_tx_fee)};\n+    }\n+\n+    CTxDestination shared_destination = CNoDestination();\n+    ExtractDestination(shared_script, shared_destination);\n+    std::optional<OutputType> op_output_type = OutputTypeFromDestination(shared_destination);\n+    if (!op_output_type) {\n+        op_output_type = wallet.m_default_change_type;\n+    }\n+    OutputType output_type = op_output_type ? *op_output_type : wallet.m_default_address_type;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349564944",
      "id" : 1349564944,
      "line" : 1618,
      "node_id" : "PRRC_kwDOABII585QcLoQ",
      "original_commit_id" : "937e17a94a70b707170467b74cea1696d6286030",
      "original_line" : 1618,
      "original_position" : 227,
      "original_start_line" : 1612,
      "path" : "src/wallet/spend.cpp",
      "position" : 227,
      "pull_request_review_id" : 1663101478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349564944/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1612,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-07T19:26:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349564944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349567860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349567860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That looks fine.",
      "commit_id" : "937e17a94a70b707170467b74cea1696d6286030",
      "created_at" : "2023-10-07T19:57:14Z",
      "diff_hunk" : "@@ -1392,4 +1392,293 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     return true;\n }\n+\n+constexpr int NUM_DENIABILIZATION_OUTPUTS = 2;\n+\n+static unsigned int CalculateDeniabilizationTxSize(const CScript& script, CAmount value, unsigned int numTxIn)\n+{\n+    // Calculation based on the comments and code in GetDustThreshold and CreateTransactionInternal\n+    unsigned int txOutSize = (unsigned int)GetSerializeSize(CTxOut(value, script), PROTOCOL_VERSION);\n+\n+    const size_t txOutCount = NUM_DENIABILIZATION_OUTPUTS;\n+    unsigned int txSize = 10 + GetSizeOfCompactSize(txOutCount); // bytes for output count\n+    txSize += txOutSize * txOutCount;\n+\n+    int witnessversion = 0;\n+    std::vector<unsigned char> witnessprogram;\n+    if (script.IsWitnessProgram(witnessversion, witnessprogram)) {\n+        txSize += (unsigned int)(numTxIn * 67.75f + 0.5f);\n+    } else {\n+        txSize += numTxIn * 148;\n+    }\n+    return txSize;\n+}\n+\n+float CalculateDeniabilizationProbability(unsigned int deniabilization_cycles)\n+{\n+    // 100%, 50%, 25%, 13%, 6%, 3%, 2%, 1%\n+    return powf(0.5f, deniabilization_cycles);\n+}\n+\n+bool IsDeniabilizationWorthwhile(CAmount total_value, CAmount fee_estimate)\n+{\n+    constexpr CAmount value_to_fee_ratio = 10;\n+    return total_value > fee_estimate * value_to_fee_ratio;\n+}\n+\n+CCoinControl SetupDeniabilizationCoinControl(unsigned int confirm_target)\n+{\n+    CCoinControl coin_control;\n+    coin_control.m_avoid_address_reuse = true;\n+    coin_control.m_avoid_partial_spends = true;\n+    coin_control.m_allow_other_inputs = false;\n+    coin_control.m_signal_bip125_rbf = true;\n+    coin_control.m_confirm_target = confirm_target;\n+    // we'll automatically bump the fee if economical ends up not confirming by the next deniabilization cycle\n+    coin_control.m_fee_mode = FeeEstimateMode::ECONOMICAL;\n+    return coin_control;\n+}\n+\n+CFeeRate CalculateDeniabilizationFeeRate(const CWallet& wallet, unsigned int confirm_target)\n+{\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+\n+    CFeeRate requiredFeeRate = GetRequiredFeeRate(wallet);\n+    FeeCalculation fee_calc;\n+    CFeeRate minFeeRate = GetMinimumFeeRate(wallet, coin_control, &fee_calc);\n+    if (fee_calc.reason == FeeReason::FALLBACK || requiredFeeRate > minFeeRate)\n+        return requiredFeeRate;\n+    return minFeeRate;\n+}\n+\n+static CAmount CalculateDeniabilizationTxFee(const CScript& shared_script, CAmount total_value, unsigned int num_utxos, const CFeeRate& fee_rate)\n+{\n+    Assert(num_utxos > 0);\n+    unsigned int deniabilization_tx_size = CalculateDeniabilizationTxSize(shared_script, total_value, num_utxos);\n+    return fee_rate.GetFee(deniabilization_tx_size);\n+}\n+\n+CAmount CalculateDeniabilizationFeeEstimate(const CScript& shared_script, CAmount total_value, unsigned int num_utxos, unsigned int deniabilization_cycles, const CFeeRate& fee_rate)\n+{\n+    float deniabilizationProbability = CalculateDeniabilizationProbability(deniabilization_cycles);\n+    // convert to integer percent to truncate and check for zero probability\n+    unsigned int deniabilizationProbabilityPercent = deniabilizationProbability * 100;\n+    if (deniabilizationProbabilityPercent == 0) {\n+        return 0;\n+    }\n+\n+    // this cycle will use all the UTXOs, while following cycles will have just one UTXO\n+    CAmount deniabilizationFee = CalculateDeniabilizationTxFee(shared_script, total_value, num_utxos, fee_rate);\n+\n+    // calculate the fees from future deniabilization cycles\n+    CAmount futureDeniabilizationFee = CalculateDeniabilizationFeeEstimate(shared_script, total_value / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, fee_rate) * 2;\n+\n+    // if it's worthwhile to do future deniabilizations then add them to this cycle estimate\n+    if (IsDeniabilizationWorthwhile(total_value, deniabilizationFee + futureDeniabilizationFee)) {\n+        deniabilizationFee += futureDeniabilizationFee;\n+    }\n+    return deniabilizationFee;\n+}\n+\n+std::pair<unsigned int, bool> CalculateDeniabilizationCycles(CWallet& wallet, const COutPoint& outpoint)\n+{\n+    LOCK(wallet.cs_wallet);\n+    auto walletTx = wallet.GetWalletTx(outpoint.hash);\n+    if (!walletTx) {\n+        return std::make_pair(0, false);\n+    }\n+    auto tx = walletTx->tx;\n+\n+    if (tx->IsCoinBase()) {\n+        // this is a block reward tx, so we tag it as such\n+        return std::make_pair(0, true);\n+    }\n+\n+    // an deniabilized coin is one we sent to ourselves\n+    // all txIn should belong to our wallet\n+    if (tx->vin.empty()) {\n+        return std::make_pair(0, false);\n+    }\n+    for (const auto& txIn : tx->vin) {\n+        if (InputIsMine(wallet, txIn) == ISMINE_NO) {\n+            return std::make_pair(0, false);\n+        }\n+    }\n+\n+    // all txOut should belong to our wallet\n+    Assert(outpoint.n < tx->vout.size());\n+    unsigned int n = 0;\n+    for (const auto& txOut : tx->vout) {\n+        if (wallet.IsMine(txOut) == ISMINE_NO) {\n+            Assert(n != outpoint.n);\n+            return std::make_pair(0, false);\n+        }\n+        n++;\n+    }\n+\n+    unsigned int uniqueTxOutCount = 0;\n+    for (const auto& txOut : tx->vout) {\n+        // check if it's a valid destination\n+        CTxDestination txOutDestination;\n+        ExtractDestination(txOut.scriptPubKey, txOutDestination);\n+        if (std::get_if<CNoDestination>(&txOutDestination)) {\n+            continue;\n+        }\n+\n+        // don't count outputs that match any input addresses (eg it's change output)\n+        bool matchesInput = false;\n+        for (const auto& txIn : tx->vin) {\n+            auto prevWalletTx = wallet.GetWalletTx(txIn.prevout.hash);\n+            if (prevWalletTx && prevWalletTx->tx->vout[txIn.prevout.n].scriptPubKey == txOut.scriptPubKey) {\n+                matchesInput = true;\n+                break;\n+            }\n+        }\n+        if (matchesInput) {\n+            continue;\n+        }\n+\n+        uniqueTxOutCount++;\n+    }\n+\n+    // we consider two or more unique outputs an \"deniabilization\" of the coin\n+    unsigned int deniabilizationCycles = uniqueTxOutCount >= 2 ? 1 : 0;\n+\n+    // all txIn and txOut are from our wallet\n+    // however if we have multiple txIn this was either an initial deniabilization of multiple UTXOs or the user manually merged deniabilized UTXOs\n+    // in either case we don't need to recurse into parent transactions and we can return the calculated cycles\n+    if (tx->vin.size() > 1) {\n+        return std::make_pair(deniabilizationCycles, false);\n+    }\n+\n+    const auto& txIn = tx->vin[0];\n+    // now recursively calculate the deniabilization cycles of the input\n+    auto inputStats = CalculateDeniabilizationCycles(wallet, txIn.prevout);\n+    return std::make_pair(inputStats.first + deniabilizationCycles, inputStats.second);\n+};\n+\n+util::Result<CreatedTransactionResult> CreateDeniabilizationTransaction(CWallet& wallet, const std::set<COutPoint>& inputs, unsigned int confirm_target, unsigned int deniabilization_cycles, bool sign, bool& insufficient_amount)\n+{\n+    if (inputs.empty()) {\n+        return util::Error{_(\"Inputs must not be empty\")};\n+    }\n+\n+    CCoinControl coin_control = SetupDeniabilizationCoinControl(confirm_target);\n+    for (const auto& input : inputs) {\n+        coin_control.Select(input);\n+    }\n+    Assert(coin_control.HasSelected());\n+    CFeeRate deniabilization_fee_rate = CalculateDeniabilizationFeeRate(wallet, confirm_target);\n+    coin_control.m_feerate = deniabilization_fee_rate;\n+\n+    LOCK(wallet.cs_wallet);\n+\n+    FastRandomContext rng_fast;\n+    CoinSelectionParams coin_selection_params{rng_fast};\n+    auto res_fetch_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+    if (!res_fetch_inputs) {\n+        return util::Error{util::ErrorString(res_fetch_inputs)};\n+    }\n+    PreSelectedInputs preset_inputs = *res_fetch_inputs;\n+    CAmount total_amount = preset_inputs.total_amount;\n+\n+    // validate that all UTXOs share the same address\n+    std::optional<CScript> op_shared_script;\n+    for (const auto& coin : preset_inputs.coins) {\n+        if (!op_shared_script) {\n+            op_shared_script = coin->txout.scriptPubKey;\n+        }\n+        if (!op_shared_script || !(*op_shared_script == coin->txout.scriptPubKey)) {\n+            return util::Error{_(\"Input addresses must all match.\")};\n+        }\n+    }\n+    Assert(op_shared_script);\n+    CScript shared_script = *op_shared_script;\n+\n+    CFeeRate discard_feerate = GetDiscardRate(wallet);\n+    CAmount dust_threshold = GetDustThreshold(CTxOut(total_amount, shared_script), discard_feerate);\n+\n+    // deniabilize the UTXOs by splitting the value randomly\n+    // find a split that leaves enough amount post split to finish the deniabilization process in each new UTXO\n+    CAmount min_post_split_amount = CalculateDeniabilizationFeeEstimate(shared_script, total_amount / NUM_DENIABILIZATION_OUTPUTS, 1, deniabilization_cycles + 1, deniabilization_fee_rate) + dust_threshold;\n+    CAmount estimated_tx_fee = CalculateDeniabilizationTxFee(shared_script, total_amount, preset_inputs.coins.size(), deniabilization_fee_rate);\n+\n+    CAmount total_random_range = total_amount - min_post_split_amount * NUM_DENIABILIZATION_OUTPUTS - estimated_tx_fee;\n+    if (total_random_range < 0) {\n+        insufficient_amount = true;\n+        return util::Error{strprintf(_(\"Insufficient amount (%d) for a deniabilization transaction, min amount (%d), tx fee (%d).\"), total_amount, min_post_split_amount, estimated_tx_fee)};\n+    }\n+\n+    CTxDestination shared_destination = CNoDestination();\n+    ExtractDestination(shared_script, shared_destination);\n+    std::optional<OutputType> op_output_type = OutputTypeFromDestination(shared_destination);\n+    if (!op_output_type) {\n+        op_output_type = wallet.m_default_change_type;\n+    }\n+    OutputType output_type = op_output_type ? *op_output_type : wallet.m_default_address_type;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#discussion_r1349567860",
      "id" : 1349567860,
      "in_reply_to_id" : 1349564944,
      "line" : 1618,
      "node_id" : "PRRC_kwDOABII585QcMV0",
      "original_commit_id" : "937e17a94a70b707170467b74cea1696d6286030",
      "original_line" : 1618,
      "original_position" : 227,
      "original_start_line" : 1612,
      "path" : "src/wallet/spend.cpp",
      "position" : 227,
      "pull_request_review_id" : 1663103891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27792",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349567860/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1612,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-07T19:57:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1349567860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@maflcko - The CI has been failing on the \"fuzzer\" test with a \"time out\", and I re-tried it few times, but to no avail. I'm not sure if this is a global CI issue, or if it is indeed something wrong with my code. Is there a chat/forum I can inquire about CI issues?",
      "created_at" : "2023-10-21T20:59:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1773920006",
      "id" : 1773920006,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585pu98G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1773920006/reactions"
      },
      "updated_at" : "2023-10-21T20:59:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1773920006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The fuzz timeout can be ignored for now. It will be fixed next week.",
      "created_at" : "2023-10-22T12:56:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1774088450",
      "id" : 1774088450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585pvnEC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1774088450/reactions"
      },
      "updated_at" : "2023-10-22T12:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1774088450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK\r\n\r\nI cant comment on the approach before testing and going through everything. I had tried to implement similar feature in electrum: https://github.com/spesmilo/electrum/pull/8159\r\n\r\nFingerprinting issue could be resolved by using random fingerprints for transactions in this feature or add spoofing feature in core: https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2023-October/021998.html\r\n\r\nBTCPay Server also randomizes wallet fingerprint for transactions: https://github.com/btcpayserver/btcpayserver/blob/a921504bcf619c5e845813b8f994b39147694a97/Changelog.md?plain=1#L2079",
      "created_at" : "2023-10-24T01:54:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1776361008",
      "id" : 1776361008,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585p4R4w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776361008/reactions"
      },
      "updated_at" : "2023-10-24T01:54:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776361008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/147166694?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 147166694,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOCMWV5g",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@1440000bytes , @maflcko, @achow101  \r\nIn commit [c6e1d30 ](https://github.com/bitcoin/bitcoin/commit/c6e1d30fee58f716f1cb7d6c31fc1a54c1cc4d89) I implemented a first pass \"fingerprint spoofing\" for deniabilization transactions, based on the pointers you guys gave me. Please let me know what you think. \r\nThanks!",
      "created_at" : "2023-10-26T02:28:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1780317939",
      "id" : 1780317939,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585qHX7z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1780317939/reactions"
      },
      "updated_at" : "2023-10-26T02:28:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1780317939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/123340139?v=4",
         "events_url" : "https://api.github.com/users/denavila/events{/privacy}",
         "followers_url" : "https://api.github.com/users/denavila/followers",
         "following_url" : "https://api.github.com/users/denavila/following{/other_user}",
         "gists_url" : "https://api.github.com/users/denavila/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/denavila",
         "id" : 123340139,
         "login" : "denavila",
         "node_id" : "U_kgDOB1oFaw",
         "organizations_url" : "https://api.github.com/users/denavila/orgs",
         "received_events_url" : "https://api.github.com/users/denavila/received_events",
         "repos_url" : "https://api.github.com/users/denavila/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/denavila/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/denavila/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/denavila"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@denavila \r\n> If there's a path to implement this in a more \"plugin\" way, I'd be interested to hear of course.\r\n\r\nTechnically this could be written as a python script that uses Bitcoin Core RPCs to create and sign transactions, but does the deniabilization steps and anti-fingerprinting measures in python. \r\n\r\nThat being said, I also have a few reservations about the fingerprint imitation implemented here:\r\n- It seems like it introduces a big maintenance burden because whenever another wallet changes the fingerprints they exhibit, this will need to updated correspondingly.\r\n- Additionally, I'm not sure how much this actually fixes. Because this does not eliminate all of Bitcoin Core's fingerprints (which would be quite a challenge), combining another wallet's fingerprints with Bitcoin Core's could just produce a more obvious fingerprint which will make it obvious that a given transaction is a deniability transaction. \r\n- Lastly, some of the fingerprints that are removed when certain wallets are imitated (like `standardVersion` and `antiFeeSniping`) are actually useful. `antiFeeSniping` is something that we want to be doing because it prevents fee-sniping. In fact, we should be encouraging other wallets to do this instead of removing it from our own transactions. Additionally, the `nVersion` of a transaction may need to have a certain value depending on which time locks are being used (this is not implemented yet, but now that Bitcoin Core has miniscript, they likely will be soon).",
      "created_at" : "2023-10-26T22:03:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27792#issuecomment-1781953589",
      "id" : 1781953589,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27792",
      "node_id" : "IC_kwDOABII585qNnQ1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1781953589/reactions"
      },
      "updated_at" : "2023-10-26T22:03:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1781953589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   }
]
