[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/27742).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28107](https://github.com/bitcoin/bitcoin/pull/28107) (rfc: Type-safe transaction identifiers by dergoegge)\n* [#28066](https://github.com/bitcoin/bitcoin/pull/28066) (fuzz: Generate process_message targets individually by MarcoFalke)\n* [#28043](https://github.com/bitcoin/bitcoin/pull/28043) (fuzz: Test headers pre-sync through p2p interface by dergoegge)\n* [#28031](https://github.com/bitcoin/bitcoin/pull/28031) (Package Relay 1/3: Introduce TxPackageTracker as Orphan Resolution Module by glozow)\n* [#27837](https://github.com/bitcoin/bitcoin/pull/27837) (net: introduce block tracker to retry to download blocks after failure by furszy)\n* [#27675](https://github.com/bitcoin/bitcoin/pull/27675) (p2p: Drop m_recently_announced_invs bloom filter by ajtowns)\n* [#27509](https://github.com/bitcoin/bitcoin/pull/27509) (Relay own transactions only via short-lived Tor or I2P connections by vasild)\n* [#27499](https://github.com/bitcoin/bitcoin/pull/27499) (net processing, refactor: Decouple PeerManager from gArgs by dergoegge)\n* [#27452](https://github.com/bitcoin/bitcoin/pull/27452) (test: cover addrv2 anchors by adding TorV3 to CAddress in messages.py by pinheadmz)\n* [#27385](https://github.com/bitcoin/bitcoin/pull/27385) (net, refactor: extract Network and BIP155Network logic to node/network by jonatack)\n* [#26711](https://github.com/bitcoin/bitcoin/pull/26711) (validate package transactions with their in-package ancestor sets by glozow)\n* [#26697](https://github.com/bitcoin/bitcoin/pull/26697) (logging: use bitset for categories by LarryRuane)\n* [#26621](https://github.com/bitcoin/bitcoin/pull/26621) (refactor: Continue moving application data from CNode to Peer by dergoegge)\n* [#26451](https://github.com/bitcoin/bitcoin/pull/26451) (Enforce incentive compatibility for all RBF replacements by sdaftuar)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n* [#25268](https://github.com/bitcoin/bitcoin/pull/25268) (refactor: Introduce EvictionManager by dergoegge)\n* [#20892](https://github.com/bitcoin/bitcoin/pull/20892) (tests: Run both descriptor and legacy tests within a single test invocation by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-24T15:38:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1561395468",
      "id" : 1561395468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dEQEM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561395468/reactions"
      },
      "updated_at" : "2023-12-18T09:45:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561395468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210641158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210641158"
         }
      },
      "author_association" : "MEMBER",
      "body" : "or what?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T18:06:43Z",
      "diff_hunk" : "@@ -24,6 +24,44 @@ class TxPackageTracker::Impl {\n     TxOrphanage m_orphanage;\n \n     mutable Mutex m_mutex;\n+    struct RegistrationState {\n+        // All of the following bools will need to be true",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210641158",
      "id" : 1210641158,
      "line" : 40,
      "node_id" : "PRRC_kwDOABII585IKOsG",
      "original_commit_id" : "692e4baa4bc5d1198672b083f0de214575306477",
      "original_line" : 40,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 40,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210641158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210641158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210682865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210682865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[[txorphange] use wtxid instead of txid, handle nullptr](https://github.com/bitcoin/bitcoin/pull/27742/commits/22e93f08a50a206b54717b07682e73a751cc6755)\r\n\r\nmaybe change commit message to be clearer we're erasing by wtxid, as the primary change?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T18:41:30Z",
      "diff_hunk" : "@@ -2932,7 +2932,7 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n             LogPrint(BCLog::MEMPOOL, \"   accepted orphan tx %s\\n\", orphanHash.ToString());\n             RelayTransaction(orphanHash, porphanTx->GetWitnessHash());\n             m_txpackagetracker->AddChildrenToWorkSet(*porphanTx);\n-            m_txpackagetracker->EraseOrphanTx(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210682865",
      "id" : 1210682865,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IKY3x",
      "original_commit_id" : "22e93f08a50a206b54717b07682e73a751cc6755",
      "original_line" : 2935,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210682865/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210682865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210707099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210707099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "wouldn't reference it in case it drifts? If it's exactly the same and always should be, just use this constant value?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:04:20Z",
      "diff_hunk" : "@@ -4,12 +4,33 @@\n \n #include <node/txpackagetracker.h>\n \n+#include <common/bloom.h>\n+#include <logging.h>\n #include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n \n namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210707099",
      "id" : 1210707099,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585IKeyb",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 16,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 16,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210707099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210707099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210708748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210708748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> is_wtxid\r\n\r\nwhere is this defined?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:06:19Z",
      "diff_hunk" : "@@ -4,12 +4,33 @@\n \n #include <node/txpackagetracker.h>\n \n+#include <common/bloom.h>\n+#include <logging.h>\n #include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n \n namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */\n+    static constexpr auto ORPHAN_ANCESTOR_GETDATA_INTERVAL{60s};\n+\n+    /** Delay to add if an orphan resolution candidate is already using a lot of memory in the\n+     * orphanage. */\n+    static constexpr auto ORPHANAGE_OVERLOAD_DELAY{2s};\n+\n class TxPackageTracker::Impl {\n     /** Manages unvalidated tx data (orphan transactions for which we are downloading ancestors). */\n     TxOrphanage m_orphanage;\n+\n+    mutable Mutex m_mutex;\n+\n+    /** Tracks orphans for which we need to request ancestor information. All hashes stored are\n+     * wtxids, i.e., the wtxid of the orphan. However, the is_wtxid field is used to indicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210708748",
      "id" : 1210708748,
      "line" : 163,
      "node_id" : "PRRC_kwDOABII585IKfMM",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 163,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 163,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210708748/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210708748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210724340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210724340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "really close to `OrphanageAddTx` even though the comments are clear of its purpose here. Maybe `AddKnownOrphanTx` or `AddAlreadyKnownOrphanTx`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:21:23Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210724340",
      "id" : 1210724340,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585IKi_0",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 78,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 78,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210724340/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210724340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210729694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210729694"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`is_wtxid=false`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:26:05Z",
      "diff_hunk" : "@@ -18,14 +39,119 @@ class TxPackageTracker::Impl {\n     bool OrphanageHaveTx(const GenTxid& gtxid) { return m_orphanage.HaveTx(gtxid); }\n     CTransactionRef GetTxToReconsider(NodeId peer) { return m_orphanage.GetTxToReconsider(peer); }\n     int EraseOrphanTx(const uint256& txid) { return m_orphanage.EraseTx(txid); }\n-    void DisconnectedPeer(NodeId peer) {\n-        m_orphanage.EraseForPeer(peer);\n+    void DisconnectedPeer(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        orphan_request_tracker.DisconnectedPeer(nodeid);\n+        m_orphanage.EraseForPeer(nodeid);\n+    }\n+    void BlockConnected(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        const auto wtxids_erased{m_orphanage.EraseForBlock(block)};\n+        std::set<uint256> block_wtxids;\n+        std::set<uint256> conflicted_wtxids;\n+        for (const CTransactionRef& ptx : block.vtx) {\n+            block_wtxids.insert(ptx->GetWitnessHash());\n+        }\n+        for (const auto& wtxid : wtxids_erased) {\n+            if (block_wtxids.count(wtxid) == 0) {\n+                conflicted_wtxids.insert(wtxid);\n+            }\n+        }\n+        FinalizeTransactions(block_wtxids, conflicted_wtxids);\n     }\n-    void BlockConnected(const CBlock& block) { m_orphanage.EraseForBlock(block); }\n     void LimitOrphans(unsigned int max_orphans) { m_orphanage.LimitOrphans(max_orphans); }\n     void AddChildrenToWorkSet(const CTransaction& tx) { m_orphanage.AddChildrenToWorkSet(tx); }\n     bool HaveTxToReconsider(NodeId peer) { return m_orphanage.HaveTxToReconsider(peer); }\n     size_t OrphanageSize() { return m_orphanage.Size(); }\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n+        if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+\n+        // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210729694",
      "id" : 1210729694,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IKkTe",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 77,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : null,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210729694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210729694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210734976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210734976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "When should `tx` be `NULL`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:30:31Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210734976",
      "id" : 1210734976,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585IKlmA",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 78,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 78,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210734976/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210734976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210736698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210736698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What does this last sentence mean?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:32:29Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210736698",
      "id" : 1210736698,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585IKmA6",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 88,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 88,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210736698/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210736698",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210769183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210769183"
         }
      },
      "author_association" : "MEMBER",
      "body" : "where did this behavior live prior, where this isn't a behavior change?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T20:04:00Z",
      "diff_hunk" : "@@ -5860,6 +5859,18 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             }\n         }\n \n+        auto requestable_orphans = m_txpackagetracker->GetOrphanRequests(pto->GetId(), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210769183",
      "id" : 1210769183,
      "line" : 6259,
      "node_id" : "PRRC_kwDOABII585IKt8f",
      "original_commit_id" : "bb5e0b21520e6deebcfe9576ae17f4db15c31421",
      "original_line" : 6259,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 862,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210769183/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210769183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211763570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "since we're touching this, would you mind annotating the bool as `/* best */` to make it clearer what this is doing? New to tx tracking; would be helpful",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T13:56:26Z",
      "diff_hunk" : "@@ -667,6 +678,21 @@ class TxRequestTracker::Impl {\n         });\n     }\n \n+    void ResetRequestTimeout(NodeId peer, const uint256& txhash, std::chrono::microseconds new_expiry)\n+    {\n+        auto it = m_index.get<ByPeer>().find(ByPeerView{peer, false, txhash});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211763570",
      "id" : 1211763570,
      "line" : 683,
      "node_id" : "PRRC_kwDOABII585IOgty",
      "original_commit_id" : "212a7010257b43eff9fa017bcf625acfc84f650f",
      "original_line" : 683,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 24,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763570/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211861912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211861912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason for the first?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T14:59:41Z",
      "diff_hunk" : "@@ -176,9 +207,13 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx)\n         const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n         if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n             for (const auto& elem : it_by_prev->second) {\n+                Assume(elem->second.announcers.size() >= 1);\n+                if (elem->second.announcers.empty()) break;\n+                // Pick the first peer from announcers set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211861912",
      "id" : 1211861912,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585IO4uY",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 212,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 210,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211861912/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211861912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211869199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211869199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should note that it only returns true if new",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T15:04:44Z",
      "diff_hunk" : "@@ -24,7 +24,7 @@ static constexpr size_t MAX_ORPHAN_TOTAL_SIZE{100 * MAX_STANDARD_TX_WEIGHT};\n  */\n class TxOrphanage {\n public:\n-    /** Add a new orphan transaction */\n+    /** Add a new orphan transaction. If the tx already exists, add this peer to its list of announcers. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211869199",
      "id" : 1211869199,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII585IO6gP",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 27,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 23,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211869199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211869199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211872666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211872666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can we `Assume` that there's already an entry in the announcer list?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T15:07:26Z",
      "diff_hunk" : "@@ -21,8 +21,14 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n     if (tx == nullptr) return false;\n \n     const uint256& hash = tx->GetHash();\n-    if (m_orphans.count(hash))\n+    if (m_orphans.count(hash)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211872666",
      "id" : 1211872666,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585IO7Wa",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 24,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 16,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211872666/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211872666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212076537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212076537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How is this preferred precisely?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T17:41:23Z",
      "diff_hunk" : "@@ -1418,16 +1423,47 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n     }\n }\n \n-void PeerManagerImpl::AddOrphanResolutionCandidate(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& orphan, std::chrono::microseconds current_time)\n+void PeerManagerImpl::AddOrphanAnnouncer(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& tx, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main);\n+    AssertLockHeld(::cs_main); // For m_txrequest\n+    const bool connected = m_connman.ForNode(nodeid, [](CNode* node) { return node->fSuccessfullyConnected && !node->fDisconnect; });\n+    if (!connected) return;\n+    if (m_txpackagetracker->Count(nodeid) + m_txrequest.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) {\n+        // Too many queued announcements. Request from a different peer.\n+        // TODO: Allow peers with Relay permissions to bypass this restriction.\n+        return;\n+    }\n     const CNodeState* state = State(nodeid);\n-    // Decide the TxRequestTracker parameters for this orphan resolution:\n+    // Decide the TxRequestTracker parameters for this orphan resolution.\n+    // TxPackageTracker may also increase the delay.\n     // - \"preferred\": if fPreferredDownload is set (= outbound, or NetPermissionFlags::NoBan permission)\n-    // - \"reqtime\": current time\n+    // - \"reqtime\": current time plus delays for:\n+    //   - NONPREF_PEER_TX_DELAY for announcements from non-preferred connections\n+    //   - OVERLOADED_PEER_TX_DELAY for announcements from peers which have at least\n+    //     MAX_PEER_TX_REQUEST_IN_FLIGHT requests in flight\n+    //     TODO: allow peers with Relay permissions to bypass this restiction\n     auto delay{0us};\n     const bool preferred = state->fPreferredDownload;\n-    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, orphan, preferred, current_time + delay);\n+    if (!preferred) delay += NONPREF_PEER_TX_DELAY;\n+    const bool overloaded = m_txrequest.CountInFlight(nodeid) >= MAX_PEER_TX_REQUEST_IN_FLIGHT;\n+    if (overloaded) delay += OVERLOADED_PEER_TX_DELAY;\n+    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, tx, preferred, current_time + delay);\n+}\n+void PeerManagerImpl::AddOrphanResolutionCandidates(const CTransactionRef& orphan, NodeId originator)\n+{\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // The originator will not show up in GetCandidatePeers() since we already requested from them.\n+    AddOrphanAnnouncer(originator, orphan->GetWitnessHash(), orphan, current_time);\n+    // We prefer to request the orphan's ancestors via package relay rather than txids",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212076537",
      "id" : 1212076537,
      "line" : 1514,
      "node_id" : "PRRC_kwDOABII585IPtH5",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 1458,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 211,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212076537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212076537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212089989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212089989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this seems mutually exclusive with the above conditional since it implies `!fAlreadyHave`, make an `else if` to make it clearer?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T17:53:26Z",
      "diff_hunk" : "@@ -3748,6 +3784,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 if (!fAlreadyHave && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n                     AddTxAnnouncement(pfrom, gtxid, current_time);\n                 }\n+                if (inv.IsMsgWtx() && m_txpackagetracker->OrphanageHaveTx(gtxid) && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212089989",
      "id" : 1212089989,
      "line" : 3996,
      "node_id" : "PRRC_kwDOABII585IPwaF",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 3787,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 582,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212089989/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212089989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212101478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212101478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Double checking that this is a no-op if the peer is already one the list of announcers? These seem to be called quite a bit as you get new announcements.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T18:02:00Z",
      "diff_hunk" : "@@ -1418,16 +1423,47 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n     }\n }\n \n-void PeerManagerImpl::AddOrphanResolutionCandidate(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& orphan, std::chrono::microseconds current_time)\n+void PeerManagerImpl::AddOrphanAnnouncer(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& tx, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main);\n+    AssertLockHeld(::cs_main); // For m_txrequest\n+    const bool connected = m_connman.ForNode(nodeid, [](CNode* node) { return node->fSuccessfullyConnected && !node->fDisconnect; });\n+    if (!connected) return;\n+    if (m_txpackagetracker->Count(nodeid) + m_txrequest.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) {\n+        // Too many queued announcements. Request from a different peer.\n+        // TODO: Allow peers with Relay permissions to bypass this restriction.\n+        return;\n+    }\n     const CNodeState* state = State(nodeid);\n-    // Decide the TxRequestTracker parameters for this orphan resolution:\n+    // Decide the TxRequestTracker parameters for this orphan resolution.\n+    // TxPackageTracker may also increase the delay.\n     // - \"preferred\": if fPreferredDownload is set (= outbound, or NetPermissionFlags::NoBan permission)\n-    // - \"reqtime\": current time\n+    // - \"reqtime\": current time plus delays for:\n+    //   - NONPREF_PEER_TX_DELAY for announcements from non-preferred connections\n+    //   - OVERLOADED_PEER_TX_DELAY for announcements from peers which have at least\n+    //     MAX_PEER_TX_REQUEST_IN_FLIGHT requests in flight\n+    //     TODO: allow peers with Relay permissions to bypass this restiction\n     auto delay{0us};\n     const bool preferred = state->fPreferredDownload;\n-    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, orphan, preferred, current_time + delay);\n+    if (!preferred) delay += NONPREF_PEER_TX_DELAY;\n+    const bool overloaded = m_txrequest.CountInFlight(nodeid) >= MAX_PEER_TX_REQUEST_IN_FLIGHT;\n+    if (overloaded) delay += OVERLOADED_PEER_TX_DELAY;\n+    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, tx, preferred, current_time + delay);\n+}\n+void PeerManagerImpl::AddOrphanResolutionCandidates(const CTransactionRef& orphan, NodeId originator)\n+{\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // The originator will not show up in GetCandidatePeers() since we already requested from them.\n+    AddOrphanAnnouncer(originator, orphan->GetWitnessHash(), orphan, current_time);\n+    // We prefer to request the orphan's ancestors via package relay rather than txids\n+    // of missing inputs. Also, if the first request fails, we should try again.\n+    // Get all peers that announced this transaction and prioritize accordingly...\n+    for (const auto nodeid : m_txrequest.GetCandidatePeers(orphan->GetWitnessHash())) {\n+        AddOrphanAnnouncer(nodeid, orphan->GetWitnessHash(), orphan, current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212101478",
      "id" : 1212101478,
      "line" : 1518,
      "node_id" : "PRRC_kwDOABII585IPzNm",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 1462,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 215,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212101478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212101478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212157327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212157327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "end of*",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T18:46:14Z",
      "diff_hunk" : "@@ -294,3 +297,57 @@ std::vector<uint256> TxOrphanage::EraseForBlock(const CBlock& block)\n     }\n     return vOrphanErase;\n }\n+\n+void TxOrphanage::ProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already protected, increase its protection\n+    if (it->second->second.list_pos < 0) {\n+        it->second->second.list_pos -= 1;\n+        return;\n+    }\n+\n+    auto old_pos = it->second->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it->second);\n+    if (old_pos + 1 != static_cast<int32_t>(m_orphan_list.size())) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    // Set list_pos to -1 to indicate this orphan is protected.\n+    it->second->second.list_pos = -1;\n+}\n+\n+void TxOrphanage::UndoProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already not protected, nothing to do\n+    if (it->second->second.list_pos >= 0) {\n+        Assume(false);\n+        return;\n+    }\n+    // Protected by more than one peer. Remove one of the protections.\n+    if (it->second->second.list_pos < -1) {\n+        it->second->second.list_pos += 1;\n+        return;\n+    }\n+    // Add to the end or m_orphan_list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212157327",
      "id" : 1212157327,
      "line" : 343,
      "node_id" : "PRRC_kwDOABII585IQA2P",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 343,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 289,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212157327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212157327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212166925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212166925"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Say in comment the obvious \"protected by a single peer\" or add an `Assume` to that effect. Took me too long to figure this out even though it's obvious now.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T18:51:18Z",
      "diff_hunk" : "@@ -294,3 +297,57 @@ std::vector<uint256> TxOrphanage::EraseForBlock(const CBlock& block)\n     }\n     return vOrphanErase;\n }\n+\n+void TxOrphanage::ProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already protected, increase its protection\n+    if (it->second->second.list_pos < 0) {\n+        it->second->second.list_pos -= 1;\n+        return;\n+    }\n+\n+    auto old_pos = it->second->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it->second);\n+    if (old_pos + 1 != static_cast<int32_t>(m_orphan_list.size())) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    // Set list_pos to -1 to indicate this orphan is protected.\n+    it->second->second.list_pos = -1;\n+}\n+\n+void TxOrphanage::UndoProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already not protected, nothing to do\n+    if (it->second->second.list_pos >= 0) {\n+        Assume(false);\n+        return;\n+    }\n+    // Protected by more than one peer. Remove one of the protections.\n+    if (it->second->second.list_pos < -1) {\n+        it->second->second.list_pos += 1;\n+        return;\n+    }\n+    // Add to the end or m_orphan_list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212166925",
      "id" : 1212166925,
      "in_reply_to_id" : 1212157327,
      "line" : 343,
      "node_id" : "PRRC_kwDOABII585IQDMN",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 343,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 289,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212166925/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212166925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Approach review is very welcome on this PR\r\n\r\ndidn't real whole OP until now. In my not expert opinion, the orphan handling seems reasonable, and I think it makes to open it ASAP to take it out of draft",
      "created_at" : "2023-06-01T14:12:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1572135299",
      "id" : 1572135299,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dtOGD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572135299/reactions"
      },
      "updated_at" : "2023-06-01T14:12:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572135299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Offline feedback suggested I clarify what I mean by \"approach feedback welcome\" before \"I open separate PRs.\"\r\n\r\nThis is a large project, and the first few p2p commits essentially define the interface. I'd like to get rough consensus on approach before we start looking at code details and merging PRs, because I believe it will help us \"get useful stuff in\" faster and avoid premature optimizations.\r\n\r\nHere are some approach questions I think we should answer before diving in:\r\n1. Does the proposed protocol look sound?\r\n2. Are these 3 milestones appropriate?\r\n3. Is there important functionality that is in the \"todo improvements\" section but should be included in one of the 3 milestones? Alternatively, is there not-that-important stuff in the milestones that we should defer until later?\r\n4. Does it make sense to have this `PeerManager` <-> `TxPackageTracker` <-> `TxOrphanage` relationship?",
      "created_at" : "2023-06-01T14:51:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1572205313",
      "id" : 1572205313,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dtfMB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572205313/reactions"
      },
      "updated_at" : "2023-06-01T14:51:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572205313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> redownloading orphans if we cannot afford to protect them\r\n\r\nIs the idea here that protection is a bandiwdth optimization to avoid fetching an orphan twice in a row in the presence of malicious peers or random churn? Reasonable if so, just want this to be explicitly stated if so.",
      "created_at" : "2023-06-01T17:50:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1572526838",
      "id" : 1572526838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dutr2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572526838/reactions"
      },
      "updated_at" : "2023-06-01T17:51:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572526838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213499613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213499613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note: if child is evicted, will we attempt to process the rest of the package? will likely fail due to fee reasons, maybe this is just bandwidth loss?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T17:59:10Z",
      "diff_hunk" : "@@ -256,12 +292,49 @@ class TxPackageTracker::Impl {\n             orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n         }\n \n-        if (tx != nullptr) {\n-            m_orphanage.AddTx(tx, nodeid);\n-        } else {\n-            m_orphanage.AddTx(m_orphanage.GetTx(wtxid), nodeid);\n-        }\n-\n+        m_orphanage.AddTx(ptx, nodeid);\n+        // Protection may or may not be possible. If the orphan is unprotected, it's possible it\n+        // will be evicted by the time we try to download ancestors. If we cannot protect now but",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213499613",
      "id" : 1213499613,
      "line" : 297,
      "node_id" : "PRRC_kwDOABII585IVIjd",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 297,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 297,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213499613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213499613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213504016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213504016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "re-use `orphan_size`",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:03:51Z",
      "diff_hunk" : "@@ -256,12 +292,49 @@ class TxPackageTracker::Impl {\n             orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n         }\n \n-        if (tx != nullptr) {\n-            m_orphanage.AddTx(tx, nodeid);\n-        } else {\n-            m_orphanage.AddTx(m_orphanage.GetTx(wtxid), nodeid);\n-        }\n-\n+        m_orphanage.AddTx(ptx, nodeid);\n+        // Protection may or may not be possible. If the orphan is unprotected, it's possible it\n+        // will be evicted by the time we try to download ancestors. If we cannot protect now but\n+        // still have it later, we will attempt to protect it again.\n+        MaybeProtectOrphan(nodeid, wtxid);\n+    }\n+    void MaybeProtectOrphan(NodeId nodeid, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex)\n+    {\n+        AssertLockHeld(m_mutex);\n+        auto peer_info_it = info_per_peer.find(nodeid);\n+        // Skip if this isn't a package relay peer.\n+        if (peer_info_it == info_per_peer.end()) return;\n+        const auto orphan_tx = m_orphanage.GetTx(wtxid);\n+        // Skip if the orphanage doesn't have this transaction.\n+        if (!orphan_tx) return;\n+        const auto orphan_size{orphan_tx->GetTotalSize()};\n+        // Skip if this peer is already protecting this orphan.\n+        if (peer_info_it->second.m_protected_orphan_map.count(wtxid) > 0) return;\n+        // Skip if this peer is already protecting too many orphans.\n+        if (peer_info_it->second.AvailableProtectionTokens() < orphan_size) return;\n+\n+        // Protect this orphan.\n+        LogPrint(BCLog::TXPACKAGES, \"\\nProtecting orphan %s for peer=%d\\n\", wtxid.ToString(), nodeid);\n+        m_orphanage.ProtectOrphan(wtxid);\n+        peer_info_it->second.m_protected_orphans_size += orphan_tx->GetTotalSize();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213504016",
      "id" : 1213504016,
      "line" : 319,
      "node_id" : "PRRC_kwDOABII585IVJoQ",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 319,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 319,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213504016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213504016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213509093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213509093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "make it clear that all these units are in serialized transaction bytes, not WU or vsize.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:09:19Z",
      "diff_hunk" : "@@ -16,10 +16,21 @@ namespace node {\n      * Same as GETDATA_TX_INTERVAL. */\n     static constexpr auto ORPHAN_ANCESTOR_GETDATA_INTERVAL{60s};\n \n-    /** Delay to add if an orphan resolution candidate is already using a lot of memory in the\n+    /** Delay to add if an orphan resolution candidate is protecting a lot of memory in the\n      * orphanage. */\n     static constexpr auto ORPHANAGE_OVERLOAD_DELAY{1s};\n \n+    /** Maximum amount of orphans we may protect for an inbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. */\n+    static constexpr size_t MAX_ORPHANAGE_PROTECTION_INBOUND{50000};\n+    /** Maximum amount of orphans we may protect for an outbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. Equal to one maximum-size orphan. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213509093",
      "id" : 1213509093,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII585IVK3l",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 27,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 27,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213509093/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213509093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213527350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213527350"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`BytesFromPeer` counts all announced orphans, even if duplicates, correct?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:26:51Z",
      "diff_hunk" : "@@ -241,12 +267,22 @@ class TxPackageTracker::Impl {\n         LOCK(m_mutex);\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+        CTransactionRef ptx = tx ? tx : m_orphanage.GetTx(wtxid);\n \n         // Skip if already requested in the (recent-ish) past.\n         if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n \n+        // Skip if this peer is already using a lot of space in the orphanage.\n+        if (m_orphanage.BytesFromPeer(nodeid) > MAX_ORPHANAGE_USAGE) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213527350",
      "id" : 1213527350,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585IVPU2",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 276,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 276,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213527350/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213527350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213537090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213537090"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what is the conditional guarding against?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:37:53Z",
      "diff_hunk" : "@@ -303,6 +376,9 @@ class TxPackageTracker::Impl {\n             auto pending_iter = pending_package_info.find(packageid);\n             Assume(pending_iter != pending_package_info.end());\n             if (pending_iter != pending_package_info.end()) {\n+                for (const auto& [wtxid, missing] : pending_iter->second.m_txdata_status) {\n+                    if (!missing) MaybeUnprotectOrphan(nodeid, wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213537090",
      "id" : 1213537090,
      "line" : 380,
      "node_id" : "PRRC_kwDOABII585IVRtC",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 380,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 380,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213537090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213537090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213551414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213551414"
         }
      },
      "author_association" : "MEMBER",
      "body" : "also, think we should use the new orphan tx size as well here to avoid going past MAX_ORPHANAGE_USAGE?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:53:28Z",
      "diff_hunk" : "@@ -241,12 +267,22 @@ class TxPackageTracker::Impl {\n         LOCK(m_mutex);\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+        CTransactionRef ptx = tx ? tx : m_orphanage.GetTx(wtxid);\n \n         // Skip if already requested in the (recent-ish) past.\n         if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n \n+        // Skip if this peer is already using a lot of space in the orphanage.\n+        if (m_orphanage.BytesFromPeer(nodeid) > MAX_ORPHANAGE_USAGE) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213551414",
      "id" : 1213551414,
      "in_reply_to_id" : 1213527350,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585IVVM2",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 276,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 276,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213551414/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213551414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213639103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213639103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_orphan_list` seems more aptly named `m_unprotected_orphan_list` after this",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T20:19:34Z",
      "diff_hunk" : "@@ -188,7 +191,7 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n         if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n     }\n     FastRandomContext rng;\n-    while (m_orphans.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)\n+    while (m_orphan_list.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213639103",
      "id" : 1213639103,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII585IVqm_",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 194,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 191,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213639103/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213639103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213640730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213640730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we connect to enough peers and protect transactions beyond `MAX_ORPHAN_TOTAL_SIZE`, this will result in an assert with randrange arg of 0 once m_orphan_list is empty? Should either check m_orphan_list is non-empty, or only count non-protected bytes with `m_total_unprotected_orphan_bytes`?\r\n\r\n",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T20:21:34Z",
      "diff_hunk" : "@@ -188,7 +191,7 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n         if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n     }\n     FastRandomContext rng;\n-    while (m_orphans.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)\n+    while (m_orphan_list.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213640730",
      "id" : 1213640730,
      "in_reply_to_id" : 1213639103,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII585IVrAa",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 194,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 191,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213640730/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213640730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213651441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213651441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "rename arg `max_unprotected_orphans`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T20:33:43Z",
      "diff_hunk" : "@@ -50,7 +50,12 @@ class TxOrphanage {\n     /** Erase all orphans included in or invalidated by a new block. Returns wtxids of erased txns. */\n     std::vector<uint256> EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Limit the orphanage to the given maximum */\n+    /** Limit the orphanage to the given maximum. Delete orphans whose expiry has been reached.\n+     * The maximum does not apply to protected transactions, i.e., LimitOrphans(100) ensures\n+     * that the number of non-protected orphan entries does not exceed 100. Afterward, Size() may\n+     * return a number greater than 100.  It is the caller's responsibility to ensure that not too\n+     * many orphans are protected.\n+     */\n     void LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213651441",
      "id" : 1213651441,
      "line" : 59,
      "node_id" : "PRRC_kwDOABII585IVtnx",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 59,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 58,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213651441/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213651441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > redownloading orphans if we cannot afford to protect them\r\n> \r\n> Is the idea here that protection is a bandiwdth optimization to avoid fetching an orphan twice in a row in the presence of malicious peers or random churn? Reasonable if so, just want this to be explicitly stated if so.\r\n\r\nYes exactly. Worse is we want to avoid a situation where we requested the rest of the package while the orphan was in our orphanage, but then it fell out while we were waiting for the rest of the transactions. Then, we should re-download the orphan, but what do we do with the rest of them? We basically have to redownload the whole thing again, otherwise we might end up in an endless cycle of redownloading if we put them into an orphanage but don't necessarily protect them from eviction.\r\n\r\nHere is a more detailed doc for the orphanage protection and \"token bucket\" scheme: https://gist.github.com/glozow/7c0ff639f996e660146314edffa6f06c.",
      "created_at" : "2023-06-02T10:38:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1573521731",
      "id" : 1573521731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dyglD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573521731/reactions"
      },
      "updated_at" : "2023-06-02T10:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573521731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214465487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214465487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should this function ever be called with a protected orphan? Tests don't cover these lines for protected peers(added an assert, never hit), and seems suspect that it would delete things below this block if it's protected.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:38:20Z",
      "diff_hunk" : "@@ -74,21 +99,43 @@ int TxOrphanage::_EraseTx(const uint256& txid)\n             m_outpoint_to_orphan_it.erase(itPrev);\n     }\n \n-    size_t old_pos = it->second.list_pos;\n-    assert(m_orphan_list[old_pos] == it);\n-    if (old_pos + 1 != m_orphan_list.size()) {\n-        // Unless we're deleting the last entry in m_orphan_list, move the last\n-        // entry to the position we're deleting.\n-        auto it_last = m_orphan_list.back();\n-        m_orphan_list[old_pos] = it_last;\n-        it_last->second.list_pos = old_pos;\n+    if (it->second.list_pos >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214465487",
      "id" : 1214465487,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IY0XP",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 102,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 103,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214465487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214465487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214484568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214484568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Should this function ever be called with a protected orphan?\r\n\r\nYes. It's called when orphans expire as well.\r\n\r\n> Tests don't cover these lines for protected peers\r\n\r\nSounds like I neglected to write a test for this. Expiry is pretty long, but theoretically we can hit this if we have multiple peers stalling us on the resolution of this orphan. We might happen to be trying package relay with one of the peers when the expiration is reached.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:55:32Z",
      "diff_hunk" : "@@ -74,21 +99,43 @@ int TxOrphanage::_EraseTx(const uint256& txid)\n             m_outpoint_to_orphan_it.erase(itPrev);\n     }\n \n-    size_t old_pos = it->second.list_pos;\n-    assert(m_orphan_list[old_pos] == it);\n-    if (old_pos + 1 != m_orphan_list.size()) {\n-        // Unless we're deleting the last entry in m_orphan_list, move the last\n-        // entry to the position we're deleting.\n-        auto it_last = m_orphan_list.back();\n-        m_orphan_list[old_pos] = it_last;\n-        it_last->second.list_pos = old_pos;\n+    if (it->second.list_pos >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214484568",
      "id" : 1214484568,
      "in_reply_to_id" : 1214465487,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IY5BY",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 102,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 103,
      "pull_request_review_id" : 1457714296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214484568/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:55:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214484568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214486019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214486019"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah! Didn't put 2 and 2 together. Comment-worthy",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:56:53Z",
      "diff_hunk" : "@@ -74,21 +99,43 @@ int TxOrphanage::_EraseTx(const uint256& txid)\n             m_outpoint_to_orphan_it.erase(itPrev);\n     }\n \n-    size_t old_pos = it->second.list_pos;\n-    assert(m_orphan_list[old_pos] == it);\n-    if (old_pos + 1 != m_orphan_list.size()) {\n-        // Unless we're deleting the last entry in m_orphan_list, move the last\n-        // entry to the position we're deleting.\n-        auto it_last = m_orphan_list.back();\n-        m_orphan_list[old_pos] = it_last;\n-        it_last->second.list_pos = old_pos;\n+    if (it->second.list_pos >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214486019",
      "id" : 1214486019,
      "in_reply_to_id" : 1214465487,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IY5YD",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 102,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 103,
      "pull_request_review_id" : 1457717975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214486019/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:56:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214486019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214489207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214489207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah yes, that's a bug! This `while` condition is very strange since one part applies to the unprotected orphanage and the other applies to the total orphanage. I think we should change the second condition to be on `m_total_unprotected_orphan_bytes`, yes.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:59:44Z",
      "diff_hunk" : "@@ -188,7 +191,7 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n         if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n     }\n     FastRandomContext rng;\n-    while (m_orphans.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)\n+    while (m_orphan_list.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214489207",
      "id" : 1214489207,
      "in_reply_to_id" : 1213639103,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII585IY6J3",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 194,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 191,
      "pull_request_review_id" : 1457726341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214489207/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214489207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214497418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214497418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Basically arbitrary. The relevance is basically which peer's message processing is blocked to process this, and would get a misbehaving score if the tx is invalid. Anyone who announced it is equally deserving of this burden imo. I suppose a more fair way to pick is uniformly randomly.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T15:07:28Z",
      "diff_hunk" : "@@ -176,9 +207,13 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx)\n         const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n         if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n             for (const auto& elem : it_by_prev->second) {\n+                Assume(elem->second.announcers.size() >= 1);\n+                if (elem->second.announcers.empty()) break;\n+                // Pick the first peer from announcers set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214497418",
      "id" : 1214497418,
      "in_reply_to_id" : 1211861912,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585IY8KK",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 212,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 210,
      "pull_request_review_id" : 1457748132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214497418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T15:07:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214497418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214696267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214696267"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this introduces an interdependency between the number of outgoing transaction bytes we can receive from a peer and the maximum flow of LN commitment transaction+CPFP in weight a direct transaction-relay peer can announce to us and therefore we can validate. An `option_anchors_zero_fee_htlc_tx` LN commitment transaction weight is 900 WU with no pending HTLCs. As the orphan memory usage is implemented, its unclear if there is any processing guarantees for a peer announcing transaction to us, such processing guarantees are hard to enforce as we would be dependent on the full-node host performance.\r\n\r\nNote current `MAX_ORPHANAGE_USAGE` is defined as `MAX_ORPHANAGE_USAGE{10*MAX_ORPHANAGE_PROTECTION_OUTBOUND}` though it sounds applied on processing inbound announcement (L276 in `src/node/txpackagetracker.cpp`).",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T18:42:45Z",
      "diff_hunk" : "@@ -72,6 +72,13 @@ class TxOrphanage {\n         LOCK(m_mutex);\n         return m_total_orphan_bytes;\n     }\n+    size_t BytesFromPeer(NodeId peer) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214696267",
      "id" : 1214696267,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585IZstL",
      "original_commit_id" : "986f7622dabd422d6dc21bfc3319a0d04d4c4ecc",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 83,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214696267/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214696267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214712117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214712117"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There is a argument that can be made if memory and throughputs limits (e.g `MAX_PEER_ANNOUNCEMENTS`) are applied in function of the type of transactions received (e.g v3 transactions) and that can be used to nudge multi-party and contracting protocols transactions broadcasters to use fee-bumping efficient mechanism such as one CPFP covering multiple parents due to the package limits. This would be a discount incentive by analogy with SegWit spending discounted by consensus validation rules.\r\n\r\nOn the other hand, such incentive might have bad incentives as such package topology might be unsafe (i.e if all the parents confirmation are time-sensitive) and this can become a further complication of our transaction-relay stack.\r\n\r\nThere is still a last open question if such lack of dissociation between type of traffic (e.g packages from simple transactions) could be abused when package validation is deployed, and CPU performance processing asymmetries (i.e `AcceptSingleTransaction` vs `AcceptMultipleTransactions` vs `AcceptPackageWrappingSingle` vs `AcceptAncestorPackage`) between our code paths could be exploited by a transaction-relay jamming adversary.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T18:57:00Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214712117",
      "id" : 1214712117,
      "line" : 74,
      "node_id" : "PRRC_kwDOABII585IZwk1",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 63,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 74,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214712117/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214712117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214720397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214720397"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If I understand correctly the rate-limiting accounting introduced here, whatever the number of orphan parent missing, there will be an in-flight orphan parent requests issued (i.e if were missing 10 parents, were going to issue 10 in-flight orphan parent requests).\r\n\r\nI think this should be documented as multi-party applications and contracting protocols transactions issuers might have to assemble their packages in function.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:03:32Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214720397",
      "id" : 1214720397,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585IZymN",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 70,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 81,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214720397/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214720397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214728153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214728153"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is unclear what level of enforcement is granted to a final decision, if the transactions are added to any transaction-relay download filters such as `m_recent_rejects` or `m_recently_announced_invs`. Otherwise, in case of blocks re-orgs dropping out the first package component and a second package component still stuck in filters, this can be source of package propagation failure.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:10:09Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */\n+    size_t CountInFlight(NodeId nodeid) const;\n+\n+    /** Get list of requests that should be sent to resolve orphans. These may be wtxids to send\n+     * getdata(ANCPKGINFO) or txids corresponding to parents. Automatically marks the orphans as\n+     * having outgoing requests. */\n+    std::vector<GenTxid> GetOrphanRequests(NodeId nodeid, std::chrono::microseconds current_time);\n+\n+    /** Update transactions for which we have made \"final\" decisions: transactions that have\n+     * confirmed in a block, conflicted due to a block, or added to the mempool already.\n+     * Should be called on new block: valid=block transactions, invalid=conflicts.\n+     * Should be called when tx is added to mempool.\n+     * Should not be called when a tx fails validation.\n+     * */\n+    void FinalizeTransactions(const std::set<uint256>& valid, const std::set<uint256>& invalid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214728153",
      "id" : 1214728153,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IZ0fZ",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 91,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 102,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214728153/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214728153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214732393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214732393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think there can be a source of concerns if all the announced orphans are second components from a single common parent. All our peers would announce those second-stage components, only one of them will succeed in the mempool validation and other will be refused as conflicts, I think.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:14:42Z",
      "diff_hunk" : "@@ -43,7 +43,8 @@ class TxOrphanage {\n     /** Erase an orphan by wtxid */\n     int EraseTx(const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    /** Maybe erase all orphans announced by a peer (eg, after that peer disconnects). If an orphan",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214732393",
      "id" : 1214732393,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585IZ1hp",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 46,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 42,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214732393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214732393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214751567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214751567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Orphan usage would effect the CPFP transactions, IIUC, not the commitment transactions. The CPFP is deemed high enough, sent to the peer, the peer holds the child tx in orphan set and requests the full package, which isn't size-bound(beyond current mempool limits).",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:34:01Z",
      "diff_hunk" : "@@ -72,6 +72,13 @@ class TxOrphanage {\n         LOCK(m_mutex);\n         return m_total_orphan_bytes;\n     }\n+    size_t BytesFromPeer(NodeId peer) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214751567",
      "id" : 1214751567,
      "in_reply_to_id" : 1214696267,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585IZ6NP",
      "original_commit_id" : "986f7622dabd422d6dc21bfc3319a0d04d4c4ecc",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 83,
      "pull_request_review_id" : 1458376374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214751567/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214751567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1218144248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218144248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC\r\n\r\ntotal number of inflights doesn't appear to be changed here, it's still `MAX_PEER_TX_ANNOUNCEMENTS`\r\n\r\nIf the protected buckets are taken by attackers, an honest party can still insert an orphan into the unprotected bucket(under the MAX_PEER_TX_ANNOUNCEMENTS limit), and the whole package including the child should get fetched after a short delay.\r\n\r\nSo from a time-sensitive contract perspective, things should be strictly better than today?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-05T14:19:36Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1218144248",
      "id" : 1218144248,
      "in_reply_to_id" : 1214720397,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585Im2f4",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 70,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 81,
      "pull_request_review_id" : 1462664683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218144248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-05T14:19:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218144248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223106639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223106639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you elaborate on this concern? The orphan that isn't received yet may still be in orphanage, and will be connected to its parents normally?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T14:14:55Z",
      "diff_hunk" : "@@ -43,7 +43,8 @@ class TxOrphanage {\n     /** Erase an orphan by wtxid */\n     int EraseTx(const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    /** Maybe erase all orphans announced by a peer (eg, after that peer disconnects). If an orphan",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223106639",
      "id" : 1223106639,
      "in_reply_to_id" : 1214732393,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585I5yBP",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 46,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 42,
      "pull_request_review_id" : 1470017044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223106639/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-08T14:14:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223106639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223432211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223432211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note that it returns true if peer can relay some type of package that we accept",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T18:54:40Z",
      "diff_hunk" : "@@ -56,6 +61,14 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    PackageRelayVersions GetSupportedVersions() const;\n+\n+    // We expect this to be called only once\n+    void ReceivedVersion(NodeId nodeid);\n+    void ReceivedSendpackages(NodeId nodeid, PackageRelayVersions versions);\n+    // Finalize the registration state.\n+    bool ReceivedVerack(NodeId nodeid, bool inbound, bool txrelay, bool wtxidrelay);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223432211",
      "id" : 1223432211,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII585I7BgT",
      "original_commit_id" : "26e11e877e2848f99591894d6d46b7bf69756e60",
      "original_line" : 70,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 71,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223432211/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223432211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223435262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223435262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should also test `PKG_RELAY_NONE`",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T18:58:19Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+// Copyright (c) 2021-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txpackagetracker.h>\n+#include <txorphanage.h>\n+\n+#include <test/util/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(txpackagetracker_tests, BasicTestingSetup)\n+BOOST_AUTO_TEST_CASE(pkginfo)\n+{\n+    TxOrphanage orphanage;\n+    node::TxPackageTracker tracker;\n+\n+    // Peer 0: successful handshake\n+    NodeId peer = 0;\n+    tracker.ReceivedVersion(peer);\n+    tracker.ReceivedSendpackages(peer, node::PKG_RELAY_ANCPKG);\n+    BOOST_CHECK(tracker.ReceivedVerack(peer, /*inbound`*/ true, /*txrelay=*/true, /*wtxidrelay=*/true));\n+\n+    // Peer 1: unsupported version(s)\n+    const node::PackageRelayVersions unsupported_package_type{1 << 29};\n+    peer = 1;\n+    tracker.ReceivedVersion(peer);\n+    tracker.ReceivedSendpackages(peer, unsupported_package_type);\n+    BOOST_CHECK(!tracker.ReceivedVerack(peer, /*inbound`*/ true, /*txrelay=*/true, /*wtxidrelay=*/true));\n+\n+    // Peer 2: no wtxidrelay\n+    peer = 2;\n+    tracker.ReceivedVersion(peer);\n+    tracker.ReceivedSendpackages(peer, node::PKG_RELAY_ANCPKG);\n+    BOOST_CHECK(!tracker.ReceivedVerack(peer, /*inbound`*/ true, /*txrelay=*/true, /*wtxidrelay=*/false));\n+\n+    // Peer 3: fRelay=false",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223435262",
      "id" : 1223435262,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII585I7CP-",
      "original_commit_id" : "5e5afc5590171157a983a123a5b8150f9edbe582",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/test/txpackagetracker_tests.cpp",
      "position" : 57,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223435262/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223435262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223451646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223451646"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in what situation would we support ancestor packages but also be running blocksonly?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T19:15:13Z",
      "diff_hunk" : "@@ -3319,6 +3336,16 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (greatest_common_version >= WTXID_RELAY_VERSION) {\n             m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::WTXIDRELAY));\n+            if (m_enable_package_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223451646",
      "id" : 1223451646,
      "line" : 3500,
      "node_id" : "PRRC_kwDOABII585I7GP-",
      "original_commit_id" : "daa3802272fe4bb59eaba19b02ca2bb0288f8526",
      "original_line" : 3339,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 530,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223451646/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223451646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223459823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223459823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "log seems cut off?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T19:25:59Z",
      "diff_hunk" : "@@ -0,0 +1,105 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test package relay messages\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_sendpackages,\n+    msg_verack,\n+    msg_wtxidrelay,\n+    PKG_RELAY_ANCPKG,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PTxInvStore,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+)\n+\n+def cleanup(func):\n+    def wrapper(self):\n+        assert len(self.nodes[0].getpeerinfo()) == 0\n+        assert len(self.nodes[0].getrawmempool()) == 0\n+        try:\n+            func(self)\n+        finally:\n+            # Clear mempool\n+            self.generate(self.nodes[0], 1)\n+            self.nodes[0].disconnect_p2ps()\n+    return wrapper\n+\n+class PackageRelayer(P2PTxInvStore):\n+    def __init__(self, send_sendpackages=True, send_wtxidrelay=True):\n+        super().__init__()\n+        # List versions of each sendpackages received\n+        self._sendpackages_received = []\n+        self._send_sendpackages = send_sendpackages\n+        self._send_wtxidrelay = send_wtxidrelay\n+\n+    @property\n+    def sendpackages_received(self):\n+        with p2p_lock:\n+            return self._sendpackages_received\n+\n+    def on_version(self, message):\n+        if self._send_wtxidrelay:\n+            self.send_message(msg_wtxidrelay())\n+        if self._send_sendpackages:\n+            sendpackages_message = msg_sendpackages()\n+            sendpackages_message.versions = PKG_RELAY_ANCPKG\n+            self.send_message(sendpackages_message)\n+        self.send_message(msg_verack())\n+        self.nServices = message.nServices\n+\n+    def on_sendpackages(self, message):\n+        self._sendpackages_received.append(message.versions)\n+\n+class PackageRelayTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[\"-packagerelay=1\"]]\n+\n+    @cleanup\n+    def test_sendpackages(self):\n+        self.log.info(\"Test sendpackages during version handshake\")\n+        node = self.nodes[0]\n+        peer_normal = node.add_p2p_connection(PackageRelayer())\n+        assert_equal(node.getpeerinfo()[0][\"bytesrecv_per_msg\"][\"sendpackages\"], 28)\n+        assert_equal(node.getpeerinfo()[0][\"bytessent_per_msg\"][\"sendpackages\"], 28)\n+        assert_equal(peer_normal.sendpackages_received, [PKG_RELAY_ANCPKG])\n+        node.disconnect_p2ps()\n+\n+        self.log.info(\"Test sendpackages without wtxid relay\")\n+        node = self.nodes[0]\n+        peer_no_wtxidrelay = node.add_p2p_connection(PackageRelayer(send_wtxidrelay=False))\n+        assert_equal(node.getpeerinfo()[0][\"bytesrecv_per_msg\"][\"sendpackages\"], 28)\n+        assert_equal(node.getpeerinfo()[0][\"bytessent_per_msg\"][\"sendpackages\"], 28)\n+        assert_equal(peer_no_wtxidrelay.sendpackages_received, [PKG_RELAY_ANCPKG])\n+        node.disconnect_p2ps()\n+\n+        self.log.info(\"Test sendpackages is sent even so\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223459823",
      "id" : 1223459823,
      "line" : 244,
      "node_id" : "PRRC_kwDOABII585I7IPv",
      "original_commit_id" : "daa3802272fe4bb59eaba19b02ca2bb0288f8526",
      "original_line" : 85,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "test/functional/p2p_package_relay.py",
      "position" : 244,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223459823/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223459823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223461978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223461978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "add a test where it's *not* sent if peer's protocol version doesn't support `WTXID_RELAY_VERSION`",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T19:28:41Z",
      "diff_hunk" : "@@ -0,0 +1,105 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test package relay messages\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_sendpackages,\n+    msg_verack,\n+    msg_wtxidrelay,\n+    PKG_RELAY_ANCPKG,\n+)\n+from test_framework.p2p import (\n+    p2p_lock,\n+    P2PTxInvStore,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+)\n+\n+def cleanup(func):\n+    def wrapper(self):\n+        assert len(self.nodes[0].getpeerinfo()) == 0\n+        assert len(self.nodes[0].getrawmempool()) == 0\n+        try:\n+            func(self)\n+        finally:\n+            # Clear mempool\n+            self.generate(self.nodes[0], 1)\n+            self.nodes[0].disconnect_p2ps()\n+    return wrapper\n+\n+class PackageRelayer(P2PTxInvStore):\n+    def __init__(self, send_sendpackages=True, send_wtxidrelay=True):\n+        super().__init__()\n+        # List versions of each sendpackages received\n+        self._sendpackages_received = []\n+        self._send_sendpackages = send_sendpackages\n+        self._send_wtxidrelay = send_wtxidrelay\n+\n+    @property\n+    def sendpackages_received(self):\n+        with p2p_lock:\n+            return self._sendpackages_received\n+\n+    def on_version(self, message):\n+        if self._send_wtxidrelay:\n+            self.send_message(msg_wtxidrelay())\n+        if self._send_sendpackages:\n+            sendpackages_message = msg_sendpackages()\n+            sendpackages_message.versions = PKG_RELAY_ANCPKG\n+            self.send_message(sendpackages_message)\n+        self.send_message(msg_verack())\n+        self.nServices = message.nServices\n+\n+    def on_sendpackages(self, message):\n+        self._sendpackages_received.append(message.versions)\n+\n+class PackageRelayTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[\"-packagerelay=1\"]]\n+\n+    @cleanup\n+    def test_sendpackages(self):\n+        self.log.info(\"Test sendpackages during version handshake\")\n+        node = self.nodes[0]\n+        peer_normal = node.add_p2p_connection(PackageRelayer())\n+        assert_equal(node.getpeerinfo()[0][\"bytesrecv_per_msg\"][\"sendpackages\"], 28)\n+        assert_equal(node.getpeerinfo()[0][\"bytessent_per_msg\"][\"sendpackages\"], 28)\n+        assert_equal(peer_normal.sendpackages_received, [PKG_RELAY_ANCPKG])\n+        node.disconnect_p2ps()\n+\n+        self.log.info(\"Test sendpackages without wtxid relay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223461978",
      "id" : 1223461978,
      "line" : 235,
      "node_id" : "PRRC_kwDOABII585I7Ixa",
      "original_commit_id" : "daa3802272fe4bb59eaba19b02ca2bb0288f8526",
      "original_line" : 77,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "test/functional/p2p_package_relay.py",
      "position" : 235,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223461978/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223461978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223467513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223467513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "would be nice to expose when `m_enable_package_relay` is true somewhere",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T19:35:13Z",
      "diff_hunk" : "@@ -244,6 +245,7 @@ static RPCHelpMan getpeerinfo()\n             heights.push_back(height);\n         }\n         obj.pushKV(\"inflight\", heights);\n+        obj.pushKV(\"relaytxpackages\", statestats.m_package_relay);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223467513",
      "id" : 1223467513,
      "line" : 248,
      "node_id" : "PRRC_kwDOABII585I7KH5",
      "original_commit_id" : "d60b80edf0f347cb1f0d91ede77fcc3a85beadd0",
      "original_line" : 248,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 12,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223467513/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223467513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223472785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223472785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a regression test with two elements checking it's actually sorted lexigraphically would be good since this is a p2p message. I added a `std::reverse` to `GetCombinedHash` and passed tests.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T19:41:55Z",
      "diff_hunk" : "@@ -293,16 +293,27 @@ BOOST_FIXTURE_TEST_CASE(noncontextual_package_tests, TestChain100Setup)\n         BOOST_CHECK_EQUAL(state.GetResult(), PackageValidationResult::PCKG_POLICY);\n         BOOST_CHECK_EQUAL(state.GetRejectReason(), \"package-not-sorted\");\n         BOOST_CHECK(IsChildWithParents({tx_parent, tx_child}));\n+        BOOST_CHECK_EQUAL(GetPackageHash({tx_child}), GetCombinedHash({tx_child->GetWitnessHash()}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223472785",
      "id" : 1223472785,
      "line" : 296,
      "node_id" : "PRRC_kwDOABII585I7LaR",
      "original_commit_id" : "f1ec862c3f899b4a51145b4090cdf613bb19c84e",
      "original_line" : 296,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/txpackage_tests.cpp",
      "position" : 180,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223472785/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223472785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223524179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223524179"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe update comment above for this. Would the case be maybe fee situation has changed and we'd reconsider? ",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-08T20:37:25Z",
      "diff_hunk" : "@@ -2084,6 +2117,7 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_orphanage\n         // txs a second chance.\n         hashRecentRejectsChainTip = m_chainman.ActiveChain().Tip()->GetBlockHash();\n         m_recent_rejects.reset();\n+        m_recent_rejects_reconsiderable.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1223524179",
      "id" : 1223524179,
      "line" : 2133,
      "node_id" : "PRRC_kwDOABII585I7X9T",
      "original_commit_id" : "985b36ab71bffa4a53ac6edd000fa8380fa78ef7",
      "original_line" : 2120,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 331,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223524179/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223524179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224415809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224415809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this feels unrelated? \r\n\r\n`parent_txid` in loop below should be renamed accordingly",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T14:53:09Z",
      "diff_hunk" : "@@ -2436,6 +2480,7 @@ void PeerManagerImpl::ProcessGetData(CNode& pfrom, Peer& peer, const std::atomic\n                     for (const CTxMemPoolEntry& parent : parents) {\n                         if (parent.GetTime() > now - UNCONDITIONAL_RELAY_DELAY) {\n                             parent_ids_to_add.push_back(parent.GetTx().GetHash());\n+                            parent_ids_to_add.push_back(parent.GetTx().GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224415809",
      "id" : 1224415809,
      "line" : 2492,
      "node_id" : "PRRC_kwDOABII585I-xpB",
      "original_commit_id" : "a988ba3fddfea58908b3dc7d68a70811022ff97f",
      "original_line" : 2483,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 414,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224415809/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224415809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224428421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224428421"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems like this is wrong? for an inv of type `MSG_ANCPKGINFO`, we'll be looking up the transaction as though it's a txid, not wtxid. Perhaps this isn't causing issues since `m_recently_announced_invs` contains both hashes even if m_mempool.info() would miss it?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T15:03:05Z",
      "diff_hunk" : "@@ -223,6 +226,6 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n GenTxid ToGenTxid(const CInv& inv)\n {\n-    assert(inv.IsGenTxMsg());\n+    assert(inv.IsGenTxMsg() || inv.IsMsgAncPkgInfo());\n     return inv.IsMsgWtx() ? GenTxid::Wtxid(inv.hash) : GenTxid::Txid(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224428421",
      "id" : 1224428421,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585I-0uF",
      "original_commit_id" : "a988ba3fddfea58908b3dc7d68a70811022ff97f",
      "original_line" : 230,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/protocol.cpp",
      "position" : 36,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224428421/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224428421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224447994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224447994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC this is the first INV you can't actually send anyone (yet). Might be nice to catch that and print a sensible error message instead of \"Unknown inv type\": https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp#L3765\r\n\r\nWould help future readers too, I think.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T15:21:48Z",
      "diff_hunk" : "@@ -498,6 +501,7 @@ class CInv\n     bool IsMsgFilteredBlk() const { return type == MSG_FILTERED_BLOCK; }\n     bool IsMsgCmpctBlk() const { return type == MSG_CMPCT_BLOCK; }\n     bool IsMsgWitnessBlk() const { return type == MSG_WITNESS_BLOCK; }\n+    bool IsMsgAncPkgInfo() const { return type == MSG_ANCPKGINFO; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224447994",
      "id" : 1224447994,
      "line" : 513,
      "node_id" : "PRRC_kwDOABII585I-5f6",
      "original_commit_id" : "a988ba3fddfea58908b3dc7d68a70811022ff97f",
      "original_line" : 504,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 34,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224447994/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224447994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224493542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224493542"
         }
      },
      "author_association" : "MEMBER",
      "body" : "from this specific peer",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T16:03:56Z",
      "diff_hunk" : "@@ -159,14 +165,26 @@ class TxPackageTracker::Impl {\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n \n-        // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n-        orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n+        // Skip if already requested in the (recent-ish) past.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224493542",
      "id" : 1224493542,
      "line" : 272,
      "node_id" : "PRRC_kwDOABII585I_Enm",
      "original_commit_id" : "f5f4b6cd0bd8d545cf3cc16820b111aa43e25ee5",
      "original_line" : 168,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 272,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224493542/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224493542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224506179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224506179"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These two functions are defined but not used in this commit. Could we put these changes in a commit that includes this functionality/tests?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T16:18:59Z",
      "diff_hunk" : "@@ -99,6 +99,16 @@ class TxPackageTracker {\n      * Should not be called when a tx fails validation.\n      * */\n     void FinalizeTransactions(const std::set<uint256>& valid, const std::set<uint256>& invalid);\n+\n+    /** Whether a package info message is allowed (version-agnostic):\n+     * - We agreed to relay packages of this version with this peer.\n+     * - We solicited this package info somewhat recently.\n+     * Returns false if the message is not allowed and the peer should be disconnected. */\n+    bool PkgInfoAllowed(NodeId nodeid, const uint256& wtxid, PackageRelayVersions version);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224506179",
      "id" : 1224506179,
      "line" : 108,
      "node_id" : "PRRC_kwDOABII585I_HtD",
      "original_commit_id" : "f5f4b6cd0bd8d545cf3cc16820b111aa43e25ee5",
      "original_line" : 107,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 108,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224506179/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224506179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224519916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224519916"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't know where this 4th peer came from? I suppose in the context of the test it would result in a peer we would fetch via legacy orphan handling.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T16:34:10Z",
      "diff_hunk" : "@@ -44,6 +64,58 @@ BOOST_AUTO_TEST_CASE(pkginfo)\n         BOOST_CHECK_EQUAL(tracker.Count(i), 0);\n         BOOST_CHECK_EQUAL(tracker.CountInFlight(i), 0);\n     }\n+\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+    const auto orphan0 = make_tx({COutPoint{det_rand.rand256(), 0}}, 1);\n+    const auto wtxid_parent1 = det_rand.rand256();\n+    const auto orphan1 = make_tx({COutPoint{wtxid_parent1, 0}, COutPoint{wtxid_parent1, 1}}, 1);\n+    const auto orphan2 = make_tx({COutPoint{det_rand.rand256(), 0}, COutPoint{det_rand.rand256(), 0}}, 1);\n+    tracker.AddOrphanTx(/*nodeid=*/0, orphan0->GetWitnessHash(), orphan0, /*is_preferred=*/false, current_time);\n+    tracker.AddOrphanTx(/*nodeid=*/1, orphan1->GetWitnessHash(), orphan1, /*is_preferred=*/false, current_time);\n+    tracker.AddOrphanTx(/*nodeid=*/1, orphan0->GetWitnessHash(), orphan0, /*is_preferred=*/false, current_time + 10s);\n+    tracker.AddOrphanTx(/*nodeid=*/2, orphan1->GetWitnessHash(), orphan1, /*is_preferred=*/false, current_time + 5s);\n+    tracker.AddOrphanTx(/*nodeid=*/3, orphan2->GetWitnessHash(), orphan2, /*is_preferred=*/true, current_time + 5s);\n+    tracker.AddOrphanTx(/*nodeid=*/4, orphan2->GetWitnessHash(), orphan2, /*is_preferred=*/false, current_time + 9s);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224519916",
      "id" : 1224519916,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585I_LDs",
      "original_commit_id" : "cd5520ccfa84f0a8d8792db3e867e4109ec8fcbe",
      "original_line" : 78,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/txpackagetracker_tests.cpp",
      "position" : 78,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224519916/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224519916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224522961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224522961"
         }
      },
      "author_association" : "MEMBER",
      "body" : "for the two _later checks, would be nice to see `GetOrphanRequests` returns empty if reqtime wasn't reached yet, even if they're otherwise the best peer for it post-disconnect",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T16:38:12Z",
      "diff_hunk" : "@@ -44,6 +64,58 @@ BOOST_AUTO_TEST_CASE(pkginfo)\n         BOOST_CHECK_EQUAL(tracker.Count(i), 0);\n         BOOST_CHECK_EQUAL(tracker.CountInFlight(i), 0);\n     }\n+\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+    const auto orphan0 = make_tx({COutPoint{det_rand.rand256(), 0}}, 1);\n+    const auto wtxid_parent1 = det_rand.rand256();\n+    const auto orphan1 = make_tx({COutPoint{wtxid_parent1, 0}, COutPoint{wtxid_parent1, 1}}, 1);\n+    const auto orphan2 = make_tx({COutPoint{det_rand.rand256(), 0}, COutPoint{det_rand.rand256(), 0}}, 1);\n+    tracker.AddOrphanTx(/*nodeid=*/0, orphan0->GetWitnessHash(), orphan0, /*is_preferred=*/false, current_time);\n+    tracker.AddOrphanTx(/*nodeid=*/1, orphan1->GetWitnessHash(), orphan1, /*is_preferred=*/false, current_time);\n+    tracker.AddOrphanTx(/*nodeid=*/1, orphan0->GetWitnessHash(), orphan0, /*is_preferred=*/false, current_time + 10s);\n+    tracker.AddOrphanTx(/*nodeid=*/2, orphan1->GetWitnessHash(), orphan1, /*is_preferred=*/false, current_time + 5s);\n+    tracker.AddOrphanTx(/*nodeid=*/3, orphan2->GetWitnessHash(), orphan2, /*is_preferred=*/true, current_time + 5s);\n+    tracker.AddOrphanTx(/*nodeid=*/4, orphan2->GetWitnessHash(), orphan2, /*is_preferred=*/false, current_time + 9s);\n+    BOOST_CHECK_EQUAL(tracker.Count(0), 1);\n+    BOOST_CHECK_EQUAL(tracker.Count(1), 2);\n+    BOOST_CHECK_EQUAL(tracker.Count(2), 1);\n+    BOOST_CHECK_EQUAL(tracker.Count(3), 1);\n+    BOOST_CHECK_EQUAL(tracker.Count(4), 1);\n+    const auto peer0_requests = tracker.GetOrphanRequests(/*nodeid=*/0, current_time + 1s);\n+    const auto peer1_requests = tracker.GetOrphanRequests(/*nodeid=*/1, current_time + 1s);\n+    const auto peer2_requests = tracker.GetOrphanRequests(/*nodeid=*/2, current_time + 1s);\n+    const auto peer3_requests = tracker.GetOrphanRequests(/*nodeid=*/3, current_time);\n+    const auto peer4_requests = tracker.GetOrphanRequests(/*nodeid=*/4, current_time);\n+    BOOST_CHECK_EQUAL(peer0_requests.size(), 1);\n+    BOOST_CHECK(peer0_requests.front().IsWtxid());\n+    BOOST_CHECK_EQUAL(peer0_requests.front().GetHash(), orphan0->GetWitnessHash());\n+    BOOST_CHECK_EQUAL(peer1_requests.size(), 1);\n+    BOOST_CHECK_EQUAL(peer1_requests.front().GetHash(), wtxid_parent1);\n+    BOOST_CHECK(!peer1_requests.front().IsWtxid());\n+    BOOST_CHECK(peer2_requests.empty());\n+    BOOST_CHECK(peer3_requests.empty());\n+    BOOST_CHECK(peer4_requests.empty());\n+    BOOST_CHECK_EQUAL(tracker.CountInFlight(0), 1);\n+    BOOST_CHECK_EQUAL(tracker.CountInFlight(1), 1);\n+    BOOST_CHECK_EQUAL(tracker.Count(1), 2);\n+    BOOST_CHECK_EQUAL(tracker.CountInFlight(2), 0);\n+    BOOST_CHECK_EQUAL(tracker.CountInFlight(3), 0);\n+    BOOST_CHECK_EQUAL(tracker.CountInFlight(4), 0);\n+    // After peer1 disconnects, request from peer2\n+    tracker.DisconnectedPeer(1);\n+    // After peer3 disconnects, request from peer4\n+    tracker.DisconnectedPeer(3);\n+    BOOST_CHECK_EQUAL(tracker.Count(3), 0);\n+    BOOST_CHECK_EQUAL(tracker.CountInFlight(3), 0);\n+    const auto peer2_requests_later = tracker.GetOrphanRequests(/*nodeid=*/2, current_time + 5s);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224522961",
      "id" : 1224522961,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII585I_LzR",
      "original_commit_id" : "cd5520ccfa84f0a8d8792db3e867e4109ec8fcbe",
      "original_line" : 110,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/test/txpackagetracker_tests.cpp",
      "position" : 110,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224522961/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224522961",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224542605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224542605"
         }
      },
      "author_association" : "MEMBER",
      "body" : "won't disconnect peer if `!m_enable_package_relay` but will if it's on?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T16:52:26Z",
      "diff_hunk" : "@@ -4992,6 +5046,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     // If we receive a NOTFOUND message for a tx we requested, mark the announcement for it as\n                     // completed in TxRequestTracker.\n                     m_txrequest.ReceivedResponse(pfrom.GetId(), inv.hash);\n+                } else if (inv.IsMsgAncPkgInfo() && m_enable_package_relay) {\n+                    if (!m_txpackagetracker->PkgInfoAllowed(pfrom.GetId(), inv.hash, node::PKG_RELAY_ANCPKG)) {\n+                        LogPrint(BCLog::NET, \"\\nUnsolicited ancpkginfo sent, disconnecting peer=%d\\n\", pfrom.GetId());\n+                        // Unsolicited ancpkginfo or peer is not registered for package relay.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224542605",
      "id" : 1224542605,
      "line" : 5210,
      "node_id" : "PRRC_kwDOABII585I_QmN",
      "original_commit_id" : "39476ab805a950c184f2dcdea43b655aac17cbca",
      "original_line" : 5052,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 817,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224542605/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224542605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224550602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224550602"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Empty ancpkginfo seems invalid, peer should have sent a `notfound`?\r\n\r\n\"The wtxid of the requested transaction must be the last item in the list\"",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T17:02:11Z",
      "diff_hunk" : "@@ -4174,6 +4178,56 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    if (msg_type == NetMsgType::ANCPKGINFO) {\n+        std::vector<uint256> package_wtxids;\n+        vRecv >> package_wtxids;\n+        if (package_wtxids.empty()) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224550602",
      "id" : 1224550602,
      "line" : 4261,
      "node_id" : "PRRC_kwDOABII585I_SjK",
      "original_commit_id" : "39476ab805a950c184f2dcdea43b655aac17cbca",
      "original_line" : 4184,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 595,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224550602/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224550602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224557823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224557823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "*recently*",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-09T17:11:37Z",
      "diff_hunk" : "@@ -4174,6 +4178,56 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    if (msg_type == NetMsgType::ANCPKGINFO) {\n+        std::vector<uint256> package_wtxids;\n+        vRecv >> package_wtxids;\n+        if (package_wtxids.empty()) return;\n+        if (!peer->m_package_relay) {\n+            LogPrint(BCLog::NET, \"ancpkginfo sent in violation of protocol, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+        if (!m_txpackagetracker->PkgInfoAllowed(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG)) {\n+            LogPrint(BCLog::NET, \"unsolicited ancpkginfo sent, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+\n+        const auto& rep_wtxid{package_wtxids.back()};\n+        if (package_wtxids.size() > MAX_PACKAGE_COUNT) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, too many transactions\\n\", rep_wtxid.ToString());\n+            m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+            return;\n+        }\n+        LOCK(::cs_main);\n+        if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+        // We have already validated this exact set of transactions recently, so don't do it again.\n+        if (m_recent_rejects_reconsiderable.contains(GetCombinedHash(package_wtxids))) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, this package has already been rejected\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224557823",
      "id" : 1224557823,
      "line" : 4286,
      "node_id" : "PRRC_kwDOABII585I_UT_",
      "original_commit_id" : "39476ab805a950c184f2dcdea43b655aac17cbca",
      "original_line" : 4206,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 620,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224557823/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224557823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229828735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229828735"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            // If a transaction is in m_recent_rejects and package not m_recent_rejects_reconsiderable, that\r\n```",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-14T15:40:10Z",
      "diff_hunk" : "@@ -3992,6 +4255,78 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    if (msg_type == NetMsgType::ANCPKGINFO) {\n+        std::vector<uint256> package_wtxids;\n+        vRecv >> package_wtxids;\n+        if (package_wtxids.empty()) return;\n+        if (!peer->m_package_relay) {\n+            LogPrint(BCLog::NET, \"ancpkginfo sent in violation of protocol, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+        if (!m_txpackagetracker->PkgInfoAllowed(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG)) {\n+            LogPrint(BCLog::NET, \"unsolicited ancpkginfo sent, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+\n+        // Note: Multiple ancestor packages can have the same representative (different ancestors for\n+        // honest or malicious reasons). But since we're only using this to resolve orphans, we\n+        // should never be in a situation where we have multiple ancpkginfos out for the same wtxid\n+        const auto& rep_wtxid{package_wtxids.back()};\n+        if (package_wtxids.size() > MAX_PACKAGE_COUNT) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, too many transactions\\n\", rep_wtxid.ToString());\n+            m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+            return;\n+        }\n+        LOCK(::cs_main);\n+        if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+        // We have already validated this exact set of transactions recently, so don't do it again.\n+        if (m_recent_rejects_reconsiderable.contains(GetCombinedHash(package_wtxids))) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, this package has already been rejected\\n\",\n+                     rep_wtxid.ToString());\n+            m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+            return;\n+        }\n+        for (const auto& wtxid : package_wtxids) {\n+            // If a transaction is in m_recent_rejects and not m_recent_rejects_reconsiderable, that",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229828735",
      "id" : 1229828735,
      "line" : 4292,
      "node_id" : "PRRC_kwDOABII585JTbJ_",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 4292,
      "original_position" : 626,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 626,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229828735/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229828735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229835172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229835172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this filter has individual wtxids entered into it, but never actually checked for. All `contains` call sites I see are checking for package hashes only.\r\n\r\nIn other words, I think we'll re-fetch in those transactions individually when advertised erroneously.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-14T15:44:56Z",
      "diff_hunk" : "@@ -817,6 +847,33 @@ class PeerManagerImpl final : public PeerManager\n      * Memory used: 1.3 MB\n      */\n     CRollingBloomFilter m_recent_rejects GUARDED_BY(::cs_main){120'000, 0.000'001};\n+    /**\n+     * Filter for transactions or packages of transactions that were recently rejected by\n+     * the mempool but are eligible for reconsideration if submitted with other transactions.\n+     * This filter only contains wtxids of individual transactions and combined hashes of packages\n+     * (see GetCombinedHash and GetPackageHash).\n+     *\n+     * When a transaction's error is TX_LOW_FEE (in a package or by itself), add its wtxid to this\n+     * filter. If it was in a package, also add the combined hash of the transactions in its\n+     * subpackage to this filter. When a package fails for any reason, add the combined hash of all\n+     * transactions in the package info to this filter.\n+     *\n+     * Upon receiving an announcement for a transaction, if it exists in this filter, do not\n+     * download the txdata. Upon receiving a package info, if the combined hash of its transactions\n+     * are in this filter, do not download the txdata.\n+     *\n+     * Reset this filter when the chain tip changes.\n+     *\n+     * We will only add wtxids to this filter. Groups of multiple transactions are represented by\n+     * the hash of their wtxids, concatenated together in lexicographical order.\n+     *\n+     * Parameters are picked to be identical to that of m_recent_rejects, with the same rationale.\n+     * Memory used: 1.3 MB\n+     * FIXME: this filter can probably be smaller, but how much smaller?\n+     */\n+    CRollingBloomFilter m_recent_rejects_reconsiderable GUARDED_BY(::cs_main){120'000, 0.000'001};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229835172",
      "id" : 1229835172,
      "line" : 874,
      "node_id" : "PRRC_kwDOABII585JTcuk",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 874,
      "original_position" : 143,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 143,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229835172/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229835172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229847693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229847693"
         }
      },
      "author_association" : "MEMBER",
      "body" : "make all fields `m_`-compliant?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-14T15:54:51Z",
      "diff_hunk" : "@@ -0,0 +1,673 @@\n+// Copyright (c) 2022\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txpackagetracker.h>\n+\n+#include <common/bloom.h>\n+#include <logging.h>\n+#include <policy/policy.h>\n+#include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n+\n+namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */\n+    static constexpr auto ORPHAN_ANCESTOR_GETDATA_INTERVAL{60s};\n+\n+    /** Delay to add if an orphan resolution candidate is protecting a lot of memory in the\n+     * orphanage. */\n+    static constexpr auto ORPHANAGE_OVERLOAD_DELAY{1s};\n+\n+    /** Maximum amount of orphans we may protect for an inbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. */\n+    static constexpr size_t MAX_ORPHANAGE_PROTECTION_INBOUND{50000};\n+    /** Maximum amount of orphans we may protect for an outbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. Equal to one maximum-size orphan. */\n+    static constexpr size_t MAX_ORPHANAGE_PROTECTION_OUTBOUND{400000};\n+\n+    /** Number of orphanage bytes a peer may use before we start dropping their requests. */\n+    static constexpr size_t MAX_ORPHANAGE_USAGE{10*MAX_ORPHANAGE_PROTECTION_OUTBOUND};\n+\n+\n+class TxPackageTracker::Impl {\n+    /** Manages unvalidated tx data (orphan transactions for which we are downloading ancestors). */\n+    TxOrphanage m_orphanage;\n+\n+    mutable Mutex m_mutex;\n+    struct RegistrationState {\n+        // All of the following bools will need to be true\n+        /** Whether this peer allows transaction relay from us. */\n+        bool m_txrelay{true};\n+        // Whether this peer sent a BIP339 wtxidrelay message.\n+        bool m_wtxid_relay{false};\n+        /** Whether this peer says they can do package relay. */\n+        bool m_sendpackages_received{false};\n+        /** Versions of package relay supported by this node.\n+         * This is a subset of PACKAGE_RELAY_SUPPORTED_VERSIONS. */\n+        PackageRelayVersions m_versions_in_common;\n+        bool CanRelayPackages() {\n+            return m_txrelay && m_wtxid_relay && m_sendpackages_received && m_versions_in_common != PKG_RELAY_NONE;\n+        }\n+    };\n+    /** Represents AncPkgInfo for which we are missing transaction data. */\n+    struct PackageToDownload {\n+        /** Who provided the ancpkginfo - this is the peer whose work queue to add this package when\n+         * all tx data is received. We expect to receive tx data from this peer. */\n+        const NodeId m_pkginfo_provider;\n+\n+        /** When to stop trying to download this package if we haven't received tx data yet. */\n+        std::chrono::microseconds m_expiry;\n+\n+        /** Representative wtxid, i.e. the orphan in an ancestor package. */\n+        const uint256 m_rep_wtxid;\n+\n+        /** Map from wtxid to status (true indicates it is missing). This can be expanded to further\n+         * states such as \"already in mempool/confirmed\" in the future. */\n+        std::vector<std::pair<uint256, bool>> m_txdata_status;\n+\n+        // Package info without wtxids doesn't make sense.\n+        PackageToDownload() = delete;\n+        // Constructor if you already know size.\n+        PackageToDownload(NodeId nodeid,\n+                          std::chrono::microseconds expiry,\n+                          const uint256& rep_wtxid,\n+                          const std::vector<std::pair<uint256, bool>>& txdata_status) :\n+            m_pkginfo_provider{nodeid},\n+            m_expiry{expiry},\n+            m_rep_wtxid{rep_wtxid},\n+            m_txdata_status{txdata_status}\n+        {}\n+        bool HasTransactionIn(const std::set<uint256>& wtxidset) const {\n+            for (const auto& keyval : m_txdata_status) {\n+                if (wtxidset.count(keyval.first) > 0) return true;\n+            }\n+            return false;\n+        }\n+        /** Returns wtxid of representative transaction (i.e. the orphan in an ancestor package). */\n+        uint256 RepresentativeWtxid() const { return m_rep_wtxid; }\n+        /** Combined hash of all wtxids in package. */\n+        uint256 GetPackageHash() const {\n+            std::vector<uint256> all_wtxids;\n+            std::transform(m_txdata_status.cbegin(), m_txdata_status.cend(), std::back_inserter(all_wtxids),\n+                [](const auto& mappair) { return mappair.first; });\n+            return GetCombinedHash(all_wtxids);\n+        }\n+    };\n+\n+    using PackageInfoRequestId = uint256;\n+    PackageInfoRequestId GetPackageInfoRequestId(NodeId nodeid, const uint256& wtxid, uint32_t version) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << wtxid << version).GetHash();\n+    }\n+    using PackageTxnsRequestId = uint256;\n+    PackageTxnsRequestId GetPackageTxnsRequestId(NodeId nodeid, const std::vector<uint256>& wtxids) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << GetCombinedHash(wtxids)).GetHash();\n+    }\n+    PackageTxnsRequestId GetPackageTxnsRequestId(NodeId nodeid, const std::vector<CTransactionRef>& pkgtxns) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << GetPackageHash(pkgtxns)).GetHash();\n+    }\n+    PackageTxnsRequestId GetPackageTxnsRequestId(NodeId nodeid, const uint256& combinedhash) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << combinedhash).GetHash();\n+    }\n+    /** List of all ancestor package info we're currently requesting txdata for, indexed by the\n+     * nodeid and getpkgtxns request we would have sent them. */\n+    std::map<PackageTxnsRequestId, PackageToDownload> pending_package_info GUARDED_BY(m_mutex);\n+\n+    using PendingMap = decltype(pending_package_info);\n+    struct IteratorComparator {\n+        template<typename I>\n+        bool operator()(const I& a, const I& b) const { return &(*a) < &(*b); }\n+    };\n+\n+    struct PeerInfo {\n+        /** Whether this is an inbound peer. Affects how much of the orphanage we may protect for\n+         * this peer. */\n+        bool m_is_inbound;\n+        // What package versions we agreed to relay.\n+        PackageRelayVersions m_versions_supported;\n+        /** Amount of orphans protected for this peer, in bytes. */\n+        size_t m_protected_orphans_size{0};\n+        /** Maximum amount of orphans that can be protected for this peer, in bytes. */\n+        size_t m_max_orphans_to_protect{0};\n+        /** Wtxids and sizes of the orphans in the orphanage who are protected for this peer. */\n+        std::map<uint256, size_t> m_protected_orphan_map;\n+\n+        /** Iterators to items in pending_package_info originating from this peer. */\n+        std::set<PendingMap::iterator, IteratorComparator> m_package_info_provided;\n+\n+        PeerInfo(bool is_inbound, PackageRelayVersions versions) :\n+            m_is_inbound{is_inbound},\n+            m_versions_supported{versions},\n+            m_max_orphans_to_protect{is_inbound ? MAX_ORPHANAGE_PROTECTION_INBOUND : MAX_ORPHANAGE_PROTECTION_OUTBOUND}\n+        {}\n+        bool SupportsVersion(PackageRelayVersions version) { return m_versions_supported & version; }\n+        size_t AvailableProtectionTokens() {\n+            if (m_max_orphans_to_protect < m_protected_orphans_size) {\n+                Assume(false);\n+                return 0;\n+            }\n+            return m_max_orphans_to_protect - m_protected_orphans_size;\n+        }\n+    };\n+\n+    /** Stores relevant information about the peer prior to verack. Upon completion of version\n+     * handshake, we use this information to decide whether we relay packages with this peer. */\n+    std::map<NodeId, RegistrationState> registration_states GUARDED_BY(m_mutex);\n+\n+    /** Information for each peer we relay packages with. Membership in this map is equivalent to\n+     * whether or not we relay packages with a peer. */\n+    std::map<NodeId, PeerInfo> info_per_peer GUARDED_BY(m_mutex);\n+\n+    /** Tracks orphans for which we need to request ancestor information. All hashes stored are\n+     * wtxids, i.e., the wtxid of the orphan. However, the is_wtxid field is used to indicate\n+     * whether we would request the ancestor information by wtxid (via package relay) or by txid\n+     * (via prevouts of the missing inputs). */\n+    TxRequestTracker orphan_request_tracker GUARDED_BY(m_mutex);\n+\n+    /** Cache of package info requests sent. Used to identify unsolicited package info messages. */\n+    CRollingBloomFilter packageinfo_requested GUARDED_BY(m_mutex){50000, 0.000001};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229847693",
      "id" : 1229847693,
      "line" : 169,
      "node_id" : "PRRC_kwDOABII585JTfyN",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 169,
      "original_position" : 169,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 169,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229847693/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229847693",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229850076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850076"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe too obvious to note, but bloom filters never have false-negatives, which means this wouldn't cause additional disconnects if someone was flooding this shared resource. I had it backwards and thought it would allow a peer to influence who you disconnect from, vs tricking you into thinking you asked for the package info",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-14T15:56:38Z",
      "diff_hunk" : "@@ -0,0 +1,673 @@\n+// Copyright (c) 2022\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/txpackagetracker.h>\n+\n+#include <common/bloom.h>\n+#include <logging.h>\n+#include <policy/policy.h>\n+#include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n+\n+namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */\n+    static constexpr auto ORPHAN_ANCESTOR_GETDATA_INTERVAL{60s};\n+\n+    /** Delay to add if an orphan resolution candidate is protecting a lot of memory in the\n+     * orphanage. */\n+    static constexpr auto ORPHANAGE_OVERLOAD_DELAY{1s};\n+\n+    /** Maximum amount of orphans we may protect for an inbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. */\n+    static constexpr size_t MAX_ORPHANAGE_PROTECTION_INBOUND{50000};\n+    /** Maximum amount of orphans we may protect for an outbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. Equal to one maximum-size orphan. */\n+    static constexpr size_t MAX_ORPHANAGE_PROTECTION_OUTBOUND{400000};\n+\n+    /** Number of orphanage bytes a peer may use before we start dropping their requests. */\n+    static constexpr size_t MAX_ORPHANAGE_USAGE{10*MAX_ORPHANAGE_PROTECTION_OUTBOUND};\n+\n+\n+class TxPackageTracker::Impl {\n+    /** Manages unvalidated tx data (orphan transactions for which we are downloading ancestors). */\n+    TxOrphanage m_orphanage;\n+\n+    mutable Mutex m_mutex;\n+    struct RegistrationState {\n+        // All of the following bools will need to be true\n+        /** Whether this peer allows transaction relay from us. */\n+        bool m_txrelay{true};\n+        // Whether this peer sent a BIP339 wtxidrelay message.\n+        bool m_wtxid_relay{false};\n+        /** Whether this peer says they can do package relay. */\n+        bool m_sendpackages_received{false};\n+        /** Versions of package relay supported by this node.\n+         * This is a subset of PACKAGE_RELAY_SUPPORTED_VERSIONS. */\n+        PackageRelayVersions m_versions_in_common;\n+        bool CanRelayPackages() {\n+            return m_txrelay && m_wtxid_relay && m_sendpackages_received && m_versions_in_common != PKG_RELAY_NONE;\n+        }\n+    };\n+    /** Represents AncPkgInfo for which we are missing transaction data. */\n+    struct PackageToDownload {\n+        /** Who provided the ancpkginfo - this is the peer whose work queue to add this package when\n+         * all tx data is received. We expect to receive tx data from this peer. */\n+        const NodeId m_pkginfo_provider;\n+\n+        /** When to stop trying to download this package if we haven't received tx data yet. */\n+        std::chrono::microseconds m_expiry;\n+\n+        /** Representative wtxid, i.e. the orphan in an ancestor package. */\n+        const uint256 m_rep_wtxid;\n+\n+        /** Map from wtxid to status (true indicates it is missing). This can be expanded to further\n+         * states such as \"already in mempool/confirmed\" in the future. */\n+        std::vector<std::pair<uint256, bool>> m_txdata_status;\n+\n+        // Package info without wtxids doesn't make sense.\n+        PackageToDownload() = delete;\n+        // Constructor if you already know size.\n+        PackageToDownload(NodeId nodeid,\n+                          std::chrono::microseconds expiry,\n+                          const uint256& rep_wtxid,\n+                          const std::vector<std::pair<uint256, bool>>& txdata_status) :\n+            m_pkginfo_provider{nodeid},\n+            m_expiry{expiry},\n+            m_rep_wtxid{rep_wtxid},\n+            m_txdata_status{txdata_status}\n+        {}\n+        bool HasTransactionIn(const std::set<uint256>& wtxidset) const {\n+            for (const auto& keyval : m_txdata_status) {\n+                if (wtxidset.count(keyval.first) > 0) return true;\n+            }\n+            return false;\n+        }\n+        /** Returns wtxid of representative transaction (i.e. the orphan in an ancestor package). */\n+        uint256 RepresentativeWtxid() const { return m_rep_wtxid; }\n+        /** Combined hash of all wtxids in package. */\n+        uint256 GetPackageHash() const {\n+            std::vector<uint256> all_wtxids;\n+            std::transform(m_txdata_status.cbegin(), m_txdata_status.cend(), std::back_inserter(all_wtxids),\n+                [](const auto& mappair) { return mappair.first; });\n+            return GetCombinedHash(all_wtxids);\n+        }\n+    };\n+\n+    using PackageInfoRequestId = uint256;\n+    PackageInfoRequestId GetPackageInfoRequestId(NodeId nodeid, const uint256& wtxid, uint32_t version) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << wtxid << version).GetHash();\n+    }\n+    using PackageTxnsRequestId = uint256;\n+    PackageTxnsRequestId GetPackageTxnsRequestId(NodeId nodeid, const std::vector<uint256>& wtxids) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << GetCombinedHash(wtxids)).GetHash();\n+    }\n+    PackageTxnsRequestId GetPackageTxnsRequestId(NodeId nodeid, const std::vector<CTransactionRef>& pkgtxns) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << GetPackageHash(pkgtxns)).GetHash();\n+    }\n+    PackageTxnsRequestId GetPackageTxnsRequestId(NodeId nodeid, const uint256& combinedhash) {\n+        return (CHashWriter(SER_GETHASH, 0) << nodeid << combinedhash).GetHash();\n+    }\n+    /** List of all ancestor package info we're currently requesting txdata for, indexed by the\n+     * nodeid and getpkgtxns request we would have sent them. */\n+    std::map<PackageTxnsRequestId, PackageToDownload> pending_package_info GUARDED_BY(m_mutex);\n+\n+    using PendingMap = decltype(pending_package_info);\n+    struct IteratorComparator {\n+        template<typename I>\n+        bool operator()(const I& a, const I& b) const { return &(*a) < &(*b); }\n+    };\n+\n+    struct PeerInfo {\n+        /** Whether this is an inbound peer. Affects how much of the orphanage we may protect for\n+         * this peer. */\n+        bool m_is_inbound;\n+        // What package versions we agreed to relay.\n+        PackageRelayVersions m_versions_supported;\n+        /** Amount of orphans protected for this peer, in bytes. */\n+        size_t m_protected_orphans_size{0};\n+        /** Maximum amount of orphans that can be protected for this peer, in bytes. */\n+        size_t m_max_orphans_to_protect{0};\n+        /** Wtxids and sizes of the orphans in the orphanage who are protected for this peer. */\n+        std::map<uint256, size_t> m_protected_orphan_map;\n+\n+        /** Iterators to items in pending_package_info originating from this peer. */\n+        std::set<PendingMap::iterator, IteratorComparator> m_package_info_provided;\n+\n+        PeerInfo(bool is_inbound, PackageRelayVersions versions) :\n+            m_is_inbound{is_inbound},\n+            m_versions_supported{versions},\n+            m_max_orphans_to_protect{is_inbound ? MAX_ORPHANAGE_PROTECTION_INBOUND : MAX_ORPHANAGE_PROTECTION_OUTBOUND}\n+        {}\n+        bool SupportsVersion(PackageRelayVersions version) { return m_versions_supported & version; }\n+        size_t AvailableProtectionTokens() {\n+            if (m_max_orphans_to_protect < m_protected_orphans_size) {\n+                Assume(false);\n+                return 0;\n+            }\n+            return m_max_orphans_to_protect - m_protected_orphans_size;\n+        }\n+    };\n+\n+    /** Stores relevant information about the peer prior to verack. Upon completion of version\n+     * handshake, we use this information to decide whether we relay packages with this peer. */\n+    std::map<NodeId, RegistrationState> registration_states GUARDED_BY(m_mutex);\n+\n+    /** Information for each peer we relay packages with. Membership in this map is equivalent to\n+     * whether or not we relay packages with a peer. */\n+    std::map<NodeId, PeerInfo> info_per_peer GUARDED_BY(m_mutex);\n+\n+    /** Tracks orphans for which we need to request ancestor information. All hashes stored are\n+     * wtxids, i.e., the wtxid of the orphan. However, the is_wtxid field is used to indicate\n+     * whether we would request the ancestor information by wtxid (via package relay) or by txid\n+     * (via prevouts of the missing inputs). */\n+    TxRequestTracker orphan_request_tracker GUARDED_BY(m_mutex);\n+\n+    /** Cache of package info requests sent. Used to identify unsolicited package info messages. */\n+    CRollingBloomFilter packageinfo_requested GUARDED_BY(m_mutex){50000, 0.000001};\n+\n+public:\n+    Impl() = default;\n+\n+    // Orphanage Wrapper Functions\n+    bool OrphanageHaveTx(const GenTxid& gtxid) { return m_orphanage.HaveTx(gtxid); }\n+    CTransactionRef GetTxToReconsider(NodeId peer) { return m_orphanage.GetTxToReconsider(peer); }\n+    int EraseOrphanTx(const uint256& txid) { return m_orphanage.EraseTx(txid); }\n+    void DisconnectedPeer(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        if (auto it{registration_states.find(nodeid)}; it != registration_states.end()) {\n+            registration_states.erase(it);\n+        }\n+        if (auto it{info_per_peer.find(nodeid)}; it != info_per_peer.end()) {\n+            std::set<uint256> pending_to_erase;\n+            for (const auto pkginfo_iter : it->second.m_package_info_provided) {\n+                if (pkginfo_iter != pending_package_info.end()) {\n+                    pending_to_erase.insert(GetPackageInfoRequestId(nodeid, pkginfo_iter->second.RepresentativeWtxid(), PKG_RELAY_ANCPKG));\n+                } else {\n+                    Assume(false);\n+                }\n+            }\n+            it->second.m_package_info_provided.clear();\n+            for (const auto& packageid : pending_to_erase) pending_package_info.erase(packageid);\n+            info_per_peer.erase(it);\n+        }\n+        orphan_request_tracker.DisconnectedPeer(nodeid);\n+        m_orphanage.EraseForPeer(nodeid);\n+    }\n+    void BlockConnected(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        const auto wtxids_erased{m_orphanage.EraseForBlock(block)};\n+        std::set<uint256> block_wtxids;\n+        std::set<uint256> conflicted_wtxids;\n+        for (const CTransactionRef& ptx : block.vtx) {\n+            block_wtxids.insert(ptx->GetWitnessHash());\n+        }\n+        for (const auto& wtxid : wtxids_erased) {\n+            if (block_wtxids.count(wtxid) == 0) {\n+                conflicted_wtxids.insert(wtxid);\n+            }\n+        }\n+        FinalizeTransactions(block_wtxids, conflicted_wtxids);\n+    }\n+    void LimitOrphans(unsigned int max_orphans) { m_orphanage.LimitOrphans(max_orphans); }\n+    void AddChildrenToWorkSet(const CTransaction& tx) { m_orphanage.AddChildrenToWorkSet(tx); }\n+    bool HaveTxToReconsider(NodeId peer) { return m_orphanage.HaveTxToReconsider(peer); }\n+    size_t OrphanageSize() { return m_orphanage.Size(); }\n+    PackageRelayVersions GetSupportedVersions() const\n+    {\n+        return PKG_RELAY_ANCPKG;\n+    }\n+\n+    void ReceivedVersion(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        if (registration_states.find(nodeid) != registration_states.end()) return;\n+        registration_states.insert(std::make_pair(nodeid, RegistrationState{}));\n+    }\n+    void ReceivedSendpackages(NodeId nodeid, PackageRelayVersions version) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        const auto it = registration_states.find(nodeid);\n+        if (it == registration_states.end()) return;\n+        it->second.m_sendpackages_received = true;\n+        // Ignore versions we don't understand. Relay packages of versions that we both suppport.\n+        it->second.m_versions_in_common = PackageRelayVersions(GetSupportedVersions() & version);\n+    }\n+\n+    bool ReceivedVerack(NodeId nodeid, bool inbound, bool txrelay, bool wtxidrelay) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        const auto& it = registration_states.find(nodeid);\n+        if (it == registration_states.end()) return false;\n+        it->second.m_txrelay = txrelay;\n+        it->second.m_wtxid_relay = wtxidrelay;\n+        const bool final_state = it->second.CanRelayPackages();\n+        if (final_state) {\n+            auto [peerinfo_it, success] = info_per_peer.insert(std::make_pair(nodeid, PeerInfo{inbound, it->second.m_versions_in_common}));\n+            Assume(success);\n+            // Should support at least one version of package relay.\n+            Assume(peerinfo_it->second.SupportsVersion(PKG_RELAY_ANCPKG));\n+        }\n+        registration_states.erase(it);\n+        return final_state;\n+    }\n+\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n+        if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+        CTransactionRef ptx = tx ? tx : m_orphanage.GetTx(wtxid);\n+\n+        // Skip if already requested in the (recent-ish) past.\n+        if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n+\n+        // Skip if this peer is already using a lot of space in the orphanage.\n+        if (m_orphanage.BytesFromPeer(nodeid) > MAX_ORPHANAGE_USAGE) return;\n+\n+        auto it_peer_info = info_per_peer.find(nodeid);\n+        if (it_peer_info != info_per_peer.end() && it_peer_info->second.SupportsVersion(PKG_RELAY_ANCPKG)) {\n+            // If we cannot protect this transaction, delay the request to use other peers'\n+            // protection tokens.\n+            Assume(it_peer_info->second.m_protected_orphan_map.count(wtxid) == 0);\n+            if (it_peer_info->second.AvailableProtectionTokens() < ptx->GetTotalSize()) {\n+                reqtime += ORPHANAGE_OVERLOAD_DELAY;\n+            }\n+            // Package relay peer: is_wtxid=true because we will be requesting via ancpkginfo.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from package relay peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Wtxid(wtxid), is_preferred, reqtime);\n+        } else {\n+            // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from legacy peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n+        }\n+\n+        m_orphanage.AddTx(ptx, nodeid);\n+        // Protection may or may not be possible. If the orphan is unprotected, it's possible it\n+        // will be evicted by the time we try to download ancestors. If we cannot protect now but\n+        // still have it later, we will attempt to protect it again.\n+        MaybeProtectOrphan(nodeid, wtxid);\n+    }\n+    void MaybeProtectOrphan(NodeId nodeid, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex)\n+    {\n+        AssertLockHeld(m_mutex);\n+        auto peer_info_it = info_per_peer.find(nodeid);\n+        // Skip if this isn't a package relay peer.\n+        if (peer_info_it == info_per_peer.end()) return;\n+        const auto orphan_tx = m_orphanage.GetTx(wtxid);\n+        // Skip if the orphanage doesn't have this transaction.\n+        if (!orphan_tx) return;\n+        const auto orphan_size{orphan_tx->GetTotalSize()};\n+        // Skip if this peer is already protecting this orphan.\n+        if (peer_info_it->second.m_protected_orphan_map.count(wtxid) > 0) return;\n+        // Skip if this peer is already protecting too many orphans.\n+        if (peer_info_it->second.AvailableProtectionTokens() < orphan_size) return;\n+\n+        // Protect this orphan.\n+        LogPrint(BCLog::TXPACKAGES, \"\\nProtecting orphan %s for peer=%d\\n\", wtxid.ToString(), nodeid);\n+        m_orphanage.ProtectOrphan(wtxid);\n+        peer_info_it->second.m_protected_orphans_size += orphan_tx->GetTotalSize();\n+        peer_info_it->second.m_protected_orphan_map.emplace(wtxid, orphan_size);\n+    }\n+    void MaybeUnprotectOrphan(NodeId nodeid, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex)\n+    {\n+        AssertLockHeld(m_mutex);\n+        auto peer_info_it = info_per_peer.find(nodeid);\n+        if (peer_info_it == info_per_peer.end()) return;\n+        auto orphan_map_it = peer_info_it->second.m_protected_orphan_map.find(wtxid);\n+        // Skip if this peer isn't protecting this orphan.\n+        if (orphan_map_it == peer_info_it->second.m_protected_orphan_map.end()) return;\n+        const auto orphan_size = orphan_map_it->second;\n+\n+        // Unprotect this orphan.\n+        LogPrint(BCLog::TXPACKAGES, \"\\nUndoing protection for orphan %s for peer=%d\\n\", wtxid.ToString(), nodeid);\n+        m_orphanage.UndoProtectOrphan(wtxid);\n+        Assume(peer_info_it->second.m_protected_orphans_size >= orphan_size);\n+        peer_info_it->second.m_protected_orphans_size -= orphan_size;\n+        peer_info_it->second.m_protected_orphan_map.erase(wtxid);\n+    }\n+    size_t CountInFlight(NodeId nodeid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        auto count{orphan_request_tracker.CountInFlight(nodeid)};\n+        if (auto it{info_per_peer.find(nodeid)}; it != info_per_peer.end()) {\n+            count += it->second.m_package_info_provided.size();\n+        }\n+        return count;\n+    }\n+    size_t Count(NodeId nodeid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        auto count{orphan_request_tracker.Count(nodeid)};\n+        if (auto it{info_per_peer.find(nodeid)}; it != info_per_peer.end()) {\n+            count += it->second.m_package_info_provided.size();\n+        }\n+        return count;\n+    }\n+\n+    void ExpirePackageToDownload(NodeId nodeid, std::chrono::microseconds current_time)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mutex)\n+    {\n+        AssertLockHeld(m_mutex);\n+        auto peer_info_it = info_per_peer.find(nodeid);\n+        if (peer_info_it == info_per_peer.end()) return;\n+        std::set<PackageTxnsRequestId> to_expire;\n+        for (const auto& pkginfo_iter : peer_info_it->second.m_package_info_provided) {\n+            const auto& packageinfo = pkginfo_iter->second;\n+            if (packageinfo.m_expiry < current_time) {\n+                LogPrint(BCLog::TXPACKAGES, \"\\nExpiring package info for tx %s from peer=%d\\n\",\n+                         packageinfo.RepresentativeWtxid().ToString(), nodeid);\n+                to_expire.insert(pkginfo_iter->first);\n+            }\n+        }\n+        for (const auto& packageid : to_expire) {\n+            auto pending_iter = pending_package_info.find(packageid);\n+            Assume(pending_iter != pending_package_info.end());\n+            if (pending_iter != pending_package_info.end()) {\n+                for (const auto& [wtxid, missing] : pending_iter->second.m_txdata_status) {\n+                    if (!missing) MaybeUnprotectOrphan(nodeid, wtxid);\n+                }\n+                peer_info_it->second.m_package_info_provided.erase(pending_iter);\n+                pending_package_info.erase(pending_iter);\n+            }\n+        }\n+    }\n+    std::vector<GenTxid> GetOrphanRequests(NodeId nodeid, std::chrono::microseconds current_time)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        // Expire packages we were trying to download tx data for\n+        ExpirePackageToDownload(nodeid, current_time);\n+        std::vector<std::pair<NodeId, GenTxid>> expired;\n+        auto tracker_requestable = orphan_request_tracker.GetRequestable(nodeid, current_time, &expired);\n+        for (const auto& entry : expired) {\n+            LogPrint(BCLog::TXPACKAGES, \"\\nTimeout of inflight %s %s from peer=%d\\n\", entry.second.IsWtxid() ? \"ancpkginfo\" : \"orphan parent\",\n+                entry.second.GetHash().ToString(), entry.first);\n+        }\n+        // Get getdata requests we should send\n+        std::vector<GenTxid> results;\n+        for (const auto& gtxid : tracker_requestable) {\n+            if (gtxid.IsWtxid()) {\n+                Assume(info_per_peer.find(nodeid) != info_per_peer.end());\n+                // Add the orphan's wtxid as-is.\n+                LogPrint(BCLog::TXPACKAGES, \"\\nResolving orphan %s, requesting by ancpkginfo from peer=%d\\n\", gtxid.GetHash().ToString(), nodeid);\n+                results.emplace_back(gtxid);\n+                packageinfo_requested.insert(GetPackageInfoRequestId(nodeid, gtxid.GetHash(), PKG_RELAY_ANCPKG));\n+                orphan_request_tracker.RequestedTx(nodeid, gtxid.GetHash(), current_time + ORPHAN_ANCESTOR_GETDATA_INTERVAL);\n+                MaybeProtectOrphan(nodeid, gtxid.GetHash());\n+            } else {\n+                LogPrint(BCLog::TXPACKAGES, \"\\nResolving orphan %s, requesting by txids of parents from peer=%d\\n\", gtxid.GetHash().ToString(), nodeid);\n+                const auto ptx = m_orphanage.GetTx(gtxid.GetHash());\n+                if (!ptx) {\n+                    // We can't request ancpkginfo and we have no way of knowing what the missing\n+                    // parents are (it could also be that the orphan has already been resolved).\n+                    // Give up.\n+                    orphan_request_tracker.ForgetTxHash(gtxid.GetHash());\n+                    LogPrint(BCLog::TXPACKAGES, \"\\nForgetting orphan %s from peer=%d\\n\", gtxid.GetHash().ToString(), nodeid);\n+                    continue;\n+                }\n+                // Add the orphan's parents. Net processing will filter out what we already have.\n+                // Deduplicate parent txids, so that we don't have to loop over\n+                // the same parent txid more than once down below.\n+                std::vector<uint256> unique_parents;\n+                unique_parents.reserve(ptx->vin.size());\n+                for (const auto& txin : ptx->vin) {\n+                    // We start with all parents, and then remove duplicates below.\n+                    unique_parents.push_back(txin.prevout.hash);\n+                }\n+                std::sort(unique_parents.begin(), unique_parents.end());\n+                unique_parents.erase(std::unique(unique_parents.begin(), unique_parents.end()), unique_parents.end());\n+                for (const auto& txid : unique_parents) {\n+                    results.emplace_back(GenTxid::Txid(txid));\n+                }\n+                // Mark the orphan as requested. Limitation: we aren't tracking these txids in\n+                // relation to the orphan's wtxid anywhere. If we get a NOTFOUND for the parent(s),\n+                // we won't automatically know that it corresponds to this orphan (i.e. won't be\n+                // able to call ReceivedResponse()). We will need to wait until it expires before\n+                // requesting from somebody else.\n+                orphan_request_tracker.RequestedTx(nodeid, gtxid.GetHash(), current_time + ORPHAN_ANCESTOR_GETDATA_INTERVAL);\n+            }\n+        }\n+        if (!results.empty()) LogPrint(BCLog::TXPACKAGES, \"\\nRequesting %u items from peer=%d\\n\", results.size(), nodeid);\n+        return results;\n+    }\n+    void FinalizeTransactions(const std::set<uint256>& valid, const std::set<uint256>& invalid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        // Do a linear search of all packages. This operation should not be expensive as we don't\n+        // expect to be relaying more than 1 package per peer. Nonetheless, process sets together\n+        // to be more efficient.\n+        std::set<PackageTxnsRequestId> to_erase;\n+        for (const auto& [packageid, packageinfo] : pending_package_info) {\n+            const auto& rep_wtxid = packageinfo.RepresentativeWtxid();\n+            if (valid.count(rep_wtxid) > 0 || invalid.count(rep_wtxid) > 0) {\n+                // We have already made a final decision on the transaction of interest.\n+                // There is no need to request more information from other peers.\n+                to_erase.insert(packageid);\n+                orphan_request_tracker.ForgetTxHash(rep_wtxid);\n+                MaybeUnprotectOrphan(packageinfo.m_pkginfo_provider, rep_wtxid);\n+            } else if (packageinfo.HasTransactionIn(invalid)) {\n+                // This package info is known to contain an invalid transaction; don't continue\n+                // trying to download or validate it.\n+                to_erase.insert(packageid);\n+                // However, as it's possible for this information to be incorrect (e.g. a peer\n+                // purposefully trying to get us to reject the orphan by providing package info\n+                // containing an invalid transaction), don't prevent further orphan resolution\n+                // attempts with other peers.\n+            } else {\n+                // FIXME: Some packages may need less txdata now.\n+                // It's fine not to do this *for now* since we always request all missing txdata\n+                // from the same peer.\n+            }\n+        }\n+        for (const auto& packageid : to_erase) {\n+            auto pending_iter = pending_package_info.find(packageid);\n+            Assume(pending_iter != pending_package_info.end());\n+            if (pending_iter != pending_package_info.end()) {\n+                auto peer_info_it = info_per_peer.find(pending_iter->second.m_pkginfo_provider);\n+                Assume(peer_info_it != info_per_peer.end());\n+                if (peer_info_it != info_per_peer.end()) {\n+                    for (const auto& [wtxid, missing] : pending_iter->second.m_txdata_status) {\n+                        if (!missing) MaybeUnprotectOrphan(pending_iter->second.m_pkginfo_provider, wtxid);\n+                    }\n+                    peer_info_it->second.m_package_info_provided.erase(pending_iter);\n+                }\n+                pending_package_info.erase(pending_iter);\n+            }\n+        }\n+    }\n+    bool PkgInfoAllowed(NodeId nodeid, const uint256& wtxid, PackageRelayVersions version) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        auto peerinfo_it = info_per_peer.find(nodeid);\n+        if (peerinfo_it == info_per_peer.end()) {\n+            return false;\n+        } else if (!peerinfo_it->second.SupportsVersion(version)) {\n+            return false;\n+        }\n+        auto peer_info = info_per_peer.find(nodeid)->second;\n+        const auto packageid{GetPackageInfoRequestId(nodeid, wtxid, version)};\n+        if (!packageinfo_requested.contains(packageid)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229850076",
      "id" : 1229850076,
      "line" : 505,
      "node_id" : "PRRC_kwDOABII585JTgXc",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 505,
      "original_position" : 505,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 505,
      "pull_request_review_id" : 1470579458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850076/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235554022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235554022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this is never read from, just written to",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-20T17:00:42Z",
      "diff_hunk" : "@@ -3992,6 +4255,78 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    if (msg_type == NetMsgType::ANCPKGINFO) {\n+        std::vector<uint256> package_wtxids;\n+        vRecv >> package_wtxids;\n+        if (package_wtxids.empty()) return;\n+        if (!peer->m_package_relay) {\n+            LogPrint(BCLog::NET, \"ancpkginfo sent in violation of protocol, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+        if (!m_txpackagetracker->PkgInfoAllowed(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG)) {\n+            LogPrint(BCLog::NET, \"unsolicited ancpkginfo sent, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+\n+        // Note: Multiple ancestor packages can have the same representative (different ancestors for\n+        // honest or malicious reasons). But since we're only using this to resolve orphans, we\n+        // should never be in a situation where we have multiple ancpkginfos out for the same wtxid\n+        const auto& rep_wtxid{package_wtxids.back()};\n+        if (package_wtxids.size() > MAX_PACKAGE_COUNT) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, too many transactions\\n\", rep_wtxid.ToString());\n+            m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+            return;\n+        }\n+        LOCK(::cs_main);\n+        if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+        // We have already validated this exact set of transactions recently, so don't do it again.\n+        if (m_recent_rejects_reconsiderable.contains(GetCombinedHash(package_wtxids))) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, this package has already been rejected\\n\",\n+                     rep_wtxid.ToString());\n+            m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+            return;\n+        }\n+        for (const auto& wtxid : package_wtxids) {\n+            // If a transaction is in m_recent_rejects and not m_recent_rejects_reconsiderable, that\n+            // means it will not become valid by adding another transaction.\n+            if (m_recent_rejects.contains(wtxid)) {\n+                LogPrint(BCLog::NET, \"discarding package for tx %s, tx %s has already been rejected and is not eligible for reconsideration\\n\",\n+                         rep_wtxid.ToString(), wtxid.ToString());\n+                m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+                return;\n+            }\n+        }\n+        std::vector<std::pair<uint256, bool>> txdata_status;\n+        txdata_status.reserve(package_wtxids.size());\n+        std::vector<uint256> pkgtxns_to_request;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235554022",
      "id" : 1235554022,
      "line" : 4303,
      "node_id" : "PRRC_kwDOABII585JpQ7m",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 4303,
      "original_position" : 637,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 637,
      "pull_request_review_id" : 1488606572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235554022/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T17:00:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235554022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235557779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235557779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what's the important of not checking orphanage here, then checking the orphanage inside `ReceivedAncPkgInfo`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-20T17:04:22Z",
      "diff_hunk" : "@@ -3992,6 +4255,78 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    if (msg_type == NetMsgType::ANCPKGINFO) {\n+        std::vector<uint256> package_wtxids;\n+        vRecv >> package_wtxids;\n+        if (package_wtxids.empty()) return;\n+        if (!peer->m_package_relay) {\n+            LogPrint(BCLog::NET, \"ancpkginfo sent in violation of protocol, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+        if (!m_txpackagetracker->PkgInfoAllowed(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG)) {\n+            LogPrint(BCLog::NET, \"unsolicited ancpkginfo sent, disconnecting peer=%d\\n\", pfrom.GetId());\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+\n+        // Note: Multiple ancestor packages can have the same representative (different ancestors for\n+        // honest or malicious reasons). But since we're only using this to resolve orphans, we\n+        // should never be in a situation where we have multiple ancpkginfos out for the same wtxid\n+        const auto& rep_wtxid{package_wtxids.back()};\n+        if (package_wtxids.size() > MAX_PACKAGE_COUNT) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, too many transactions\\n\", rep_wtxid.ToString());\n+            m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+            return;\n+        }\n+        LOCK(::cs_main);\n+        if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+        // We have already validated this exact set of transactions recently, so don't do it again.\n+        if (m_recent_rejects_reconsiderable.contains(GetCombinedHash(package_wtxids))) {\n+            LogPrint(BCLog::NET, \"discarding package info for tx %s, this package has already been rejected\\n\",\n+                     rep_wtxid.ToString());\n+            m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+            return;\n+        }\n+        for (const auto& wtxid : package_wtxids) {\n+            // If a transaction is in m_recent_rejects and not m_recent_rejects_reconsiderable, that\n+            // means it will not become valid by adding another transaction.\n+            if (m_recent_rejects.contains(wtxid)) {\n+                LogPrint(BCLog::NET, \"discarding package for tx %s, tx %s has already been rejected and is not eligible for reconsideration\\n\",\n+                         rep_wtxid.ToString(), wtxid.ToString());\n+                m_txpackagetracker->ForgetPkgInfo(pfrom.GetId(), package_wtxids.back(), node::PKG_RELAY_ANCPKG);\n+                return;\n+            }\n+        }\n+        std::vector<std::pair<uint256, bool>> txdata_status;\n+        txdata_status.reserve(package_wtxids.size());\n+        std::vector<uint256> pkgtxns_to_request;\n+        for (const auto& wtxid : package_wtxids) {\n+            AddKnownTx(*peer, wtxid);\n+            if (AlreadyHaveTx(GenTxid::Wtxid(wtxid), /*include_orphanage=*/false)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235557779",
      "id" : 1235557779,
      "line" : 4306,
      "node_id" : "PRRC_kwDOABII585JpR2T",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 4306,
      "original_position" : 640,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 640,
      "pull_request_review_id" : 1488612374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235557779/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T17:04:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235557779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235698156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235698156"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note that the rejection filters are cleared every time the chain tip changes, so I don't think we can get failures this way",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-20T18:53:11Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */\n+    size_t CountInFlight(NodeId nodeid) const;\n+\n+    /** Get list of requests that should be sent to resolve orphans. These may be wtxids to send\n+     * getdata(ANCPKGINFO) or txids corresponding to parents. Automatically marks the orphans as\n+     * having outgoing requests. */\n+    std::vector<GenTxid> GetOrphanRequests(NodeId nodeid, std::chrono::microseconds current_time);\n+\n+    /** Update transactions for which we have made \"final\" decisions: transactions that have\n+     * confirmed in a block, conflicted due to a block, or added to the mempool already.\n+     * Should be called on new block: valid=block transactions, invalid=conflicts.\n+     * Should be called when tx is added to mempool.\n+     * Should not be called when a tx fails validation.\n+     * */\n+    void FinalizeTransactions(const std::set<uint256>& valid, const std::set<uint256>& invalid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235698156",
      "id" : 1235698156,
      "in_reply_to_id" : 1214728153,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585Jp0Hs",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 91,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 102,
      "pull_request_review_id" : 1488822617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235698156/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T18:53:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235698156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235700988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235700988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's weird to set `-blocksonly=1 -packagerelay=1`, but also not the end of the world. In that case we'd want to not send \"sendpackages.\" Does that answer the question?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-20T18:55:37Z",
      "diff_hunk" : "@@ -3319,6 +3336,16 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (greatest_common_version >= WTXID_RELAY_VERSION) {\n             m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::WTXIDRELAY));\n+            if (m_enable_package_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235700988",
      "id" : 1235700988,
      "in_reply_to_id" : 1223451646,
      "line" : 3500,
      "node_id" : "PRRC_kwDOABII585Jp0z8",
      "original_commit_id" : "daa3802272fe4bb59eaba19b02ca2bb0288f8526",
      "original_line" : 3339,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 530,
      "pull_request_review_id" : 1488828002,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235700988/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T18:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235700988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235703425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235703425"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ooh good catch!",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-20T18:57:28Z",
      "diff_hunk" : "@@ -223,6 +226,6 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n GenTxid ToGenTxid(const CInv& inv)\n {\n-    assert(inv.IsGenTxMsg());\n+    assert(inv.IsGenTxMsg() || inv.IsMsgAncPkgInfo());\n     return inv.IsMsgWtx() ? GenTxid::Wtxid(inv.hash) : GenTxid::Txid(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235703425",
      "id" : 1235703425,
      "in_reply_to_id" : 1224428421,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585Jp1aB",
      "original_commit_id" : "a988ba3fddfea58908b3dc7d68a70811022ff97f",
      "original_line" : 230,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/protocol.cpp",
      "position" : 36,
      "pull_request_review_id" : 1488830711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235703425/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T18:57:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235703425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235706750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235706750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch  ",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-20T19:00:30Z",
      "diff_hunk" : "@@ -817,6 +847,33 @@ class PeerManagerImpl final : public PeerManager\n      * Memory used: 1.3 MB\n      */\n     CRollingBloomFilter m_recent_rejects GUARDED_BY(::cs_main){120'000, 0.000'001};\n+    /**\n+     * Filter for transactions or packages of transactions that were recently rejected by\n+     * the mempool but are eligible for reconsideration if submitted with other transactions.\n+     * This filter only contains wtxids of individual transactions and combined hashes of packages\n+     * (see GetCombinedHash and GetPackageHash).\n+     *\n+     * When a transaction's error is TX_LOW_FEE (in a package or by itself), add its wtxid to this\n+     * filter. If it was in a package, also add the combined hash of the transactions in its\n+     * subpackage to this filter. When a package fails for any reason, add the combined hash of all\n+     * transactions in the package info to this filter.\n+     *\n+     * Upon receiving an announcement for a transaction, if it exists in this filter, do not\n+     * download the txdata. Upon receiving a package info, if the combined hash of its transactions\n+     * are in this filter, do not download the txdata.\n+     *\n+     * Reset this filter when the chain tip changes.\n+     *\n+     * We will only add wtxids to this filter. Groups of multiple transactions are represented by\n+     * the hash of their wtxids, concatenated together in lexicographical order.\n+     *\n+     * Parameters are picked to be identical to that of m_recent_rejects, with the same rationale.\n+     * Memory used: 1.3 MB\n+     * FIXME: this filter can probably be smaller, but how much smaller?\n+     */\n+    CRollingBloomFilter m_recent_rejects_reconsiderable GUARDED_BY(::cs_main){120'000, 0.000'001};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1235706750",
      "id" : 1235706750,
      "in_reply_to_id" : 1229835172,
      "line" : 874,
      "node_id" : "PRRC_kwDOABII585Jp2N-",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 874,
      "original_position" : 143,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 143,
      "pull_request_review_id" : 1488834909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235706750/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T19:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235706750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-06-21T12:37:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1600757891",
      "id" : 1600757891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585faaCD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1600757891/reactions"
      },
      "updated_at" : "2023-06-21T12:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1600757891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1237960671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237960671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the comment can indicate the type of p2p packages (ancestor package relay v1 BIP 331), and indicate this is enabling package relay at the p2p level only to dissociate from mempool-level policy like nVersion=3 (e.g any descendant of a an unconfirmed V3 transaction must also be V3 or any descendant of an unconfirmed V3 transaction must also be V3).\r\n\r\nIn the future, we might release multiple versions of packages *both* at the p2p level and policy rules at the mempool-level (e.g nversion=4 to accomodate the flow of more L2s or annex DoS limits).",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T03:52:52Z",
      "diff_hunk" : "@@ -492,6 +493,7 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-i2psam=<ip:port>\", \"I2P SAM proxy to reach I2P peers and accept I2P connections (default: none)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-i2pacceptincoming\", strprintf(\"Whether to accept inbound I2P connections (default: %i). Ignored if -i2psam is not set. Listening for inbound I2P connections is done through the SAM proxy, not by binding to a local address and port.\", DEFAULT_I2P_ACCEPT_INCOMING), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-onlynet=<net>\", \"Make automatic outbound connections only to network <net> (\" + Join(GetNetworkNames(), \", \") + \"). Inbound and manual connections are not affected by this option. It can be specified multiple times to allow multiple networks.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    argsman.AddArg(\"-packagerelay\", strprintf(\"[EXPERIMENTAL] Support relaying transaction packages (default: %u)\", node::DEFAULT_ENABLE_PACKAGE_RELAY), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1237960671",
      "id" : 1237960671,
      "line" : 496,
      "node_id" : "PRRC_kwDOABII585Jycff",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 496,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1492306150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237960671/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T05:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237960671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1237982821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237982821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the waiting time is dependent on timers (e.g `TXID_RELAY_DELAY` or `NONPREF_PEER_TX_DELAY`) or iterating over the inbound/outbound slots (i.e our `CNode`), I think we should document what is this waiting to be able to estimate if we modify max network throughput. Note there is an opened PR modifying tx relay rate, i.e #27630.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T04:40:06Z",
      "diff_hunk" : "@@ -134,7 +134,11 @@ class TxPackageTracker::Impl {\n             for (const auto& txid : unique_parents) {\n                 results.emplace_back(GenTxid::Txid(txid));\n             }\n-            // Mark the orphan as requested\n+            // Mark the orphan as requested. Limitation: we aren't tracking these txids in\n+            // relation to the orphan's wtxid anywhere. If we get a NOTFOUND for the parent(s),\n+            // we won't automatically know that it corresponds to this orphan (i.e. won't be\n+            // able to call ReceivedResponse()). We will need to wait until it expires before",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1237982821",
      "id" : 1237982821,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Jyh5l",
      "original_commit_id" : "26928b9c76ec65e8f8609dfe07eab4bcb8a455ea",
      "original_line" : 140,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : null,
      "pull_request_review_id" : 1492306150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237982821/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T05:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237982821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238002292"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238002292"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the expiry orphans could be announced at the protocol-level, as part of the package-link, i.e somewhere in `sendpackages` or in `ancpkinfo`. Those limits could be announced from the peers `PeerManagerImpl` with a push-interface (e.g the `ZMQNotificationInterface` ), that way a Lightning node could adapt its package broadcasting strategy accordingly.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T05:15:59Z",
      "diff_hunk" : "@@ -50,7 +50,12 @@ class TxOrphanage {\n     /** Erase all orphans included in or invalidated by a new block. Returns wtxids of erased txns. */\n     std::vector<uint256> EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Limit the orphanage to the given maximum */\n+    /** Limit the orphanage to the given maximum. Delete orphans whose expiry has been reached.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238002292",
      "id" : 1238002292,
      "line" : 53,
      "node_id" : "PRRC_kwDOABII585Jymp0",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 53,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 52,
      "pull_request_review_id" : 1492306150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238002292/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T05:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238002292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238008859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238008859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should we implement blessing of all the orphans of a peer with relay permissions ? I can definitely see Lightning deployment where you have an inner Bitcoin Core node and multiple external ones, where you load-balance your flows to avoid transaction-relay fingerprinting based on obvious patterns like HTLC-preimage linked to off-chain channel XYZ. ",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T05:26:51Z",
      "diff_hunk" : "@@ -65,6 +70,16 @@ class TxOrphanage {\n         LOCK(m_mutex);\n         return m_orphans.size();\n     }\n+    /** Protect an orphan from eviction from the orphanage getting full. The orphan may still be\n+     * removed due to expiry. If the orphan is already protected (by any peer), nothing happens.\n+     */\n+    void ProtectOrphan(const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238008859",
      "id" : 1238008859,
      "line" : 76,
      "node_id" : "PRRC_kwDOABII585JyoQb",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 76,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 68,
      "pull_request_review_id" : 1492306150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238008859/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T05:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238008859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238020235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238020235"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just to be sure were in sync on `BytesFromPeer` and `MAX_ORPHANAGE_USAGE`, its correct this a per-peer limit on the space in vbytes occupied by received orphans ?\r\n\r\nIf yes, I think this still introduce an interdependency between the number of outgoing transactions bytes and the maximum flow of LN commitment transactions and this limit should be documented (a la `doc/policy/`), or even better announced as part of `sendpackages` info.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T05:43:23Z",
      "diff_hunk" : "@@ -72,6 +72,13 @@ class TxOrphanage {\n         LOCK(m_mutex);\n         return m_total_orphan_bytes;\n     }\n+    size_t BytesFromPeer(NodeId peer) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238020235",
      "id" : 1238020235,
      "in_reply_to_id" : 1214696267,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585JyrCL",
      "original_commit_id" : "986f7622dabd422d6dc21bfc3319a0d04d4c4ecc",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 83,
      "pull_request_review_id" : 1492395170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238020235/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T05:43:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238020235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238025437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238025437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> So from a time-sensitive contract perspective, things should be strictly better than today?\r\n\r\nI think this is a different concern Im aiming to underscore. Its not related about buckets-capture by the attackers, rather than if you have a package of {A, B, C, D} with E as a CPFP and we have rate-limiting based on the way the parents are fetched (i.e individiually rather than in batch) the equivalent package of A+E will propagate better.\r\n\r\nSo if you would like A to confirm as soon as you can because its a 0-conf dual-funding, you wanna probably go for A+E. ",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T05:51:42Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238025437",
      "id" : 1238025437,
      "in_reply_to_id" : 1214720397,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585JysTd",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 70,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 81,
      "pull_request_review_id" : 1492402854,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238025437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T05:51:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238025437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238028747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238028747"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Note that the rejection filters are cleared every time the chain tip changes, so I don't think we can get failures this way\r\n\r\nYes, I think we should be careful to clean the whole package state in all filters at every block change to avoid half state interfering. `m_recent_rejects_reconsiderable_were_rejected` say reset this filter when the chain tip changes, of course it includes _backward_ change like re-orgs. ",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T05:56:46Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */\n+    size_t CountInFlight(NodeId nodeid) const;\n+\n+    /** Get list of requests that should be sent to resolve orphans. These may be wtxids to send\n+     * getdata(ANCPKGINFO) or txids corresponding to parents. Automatically marks the orphans as\n+     * having outgoing requests. */\n+    std::vector<GenTxid> GetOrphanRequests(NodeId nodeid, std::chrono::microseconds current_time);\n+\n+    /** Update transactions for which we have made \"final\" decisions: transactions that have\n+     * confirmed in a block, conflicted due to a block, or added to the mempool already.\n+     * Should be called on new block: valid=block transactions, invalid=conflicts.\n+     * Should be called when tx is added to mempool.\n+     * Should not be called when a tx fails validation.\n+     * */\n+    void FinalizeTransactions(const std::set<uint256>& valid, const std::set<uint256>& invalid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238028747",
      "id" : 1238028747,
      "in_reply_to_id" : 1214728153,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585JytHL",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 91,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 102,
      "pull_request_review_id" : 1492407945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238028747/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T05:56:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238028747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238034201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238034201"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Can you elaborate on this concern? The orphan that isn't received yet may still be in orphanage, and will be connected to its parents normally\r\n\r\nSo if you have 3 peers and they announce A, B, C all with different wtxids while theyre spending the same parent txid, do we have a concern of the parent being fetched from multiple peers, or download should be dedup when we receive the `ancpkginfo`s ?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T06:04:46Z",
      "diff_hunk" : "@@ -43,7 +43,8 @@ class TxOrphanage {\n     /** Erase an orphan by wtxid */\n     int EraseTx(const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    /** Maybe erase all orphans announced by a peer (eg, after that peer disconnects). If an orphan",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238034201",
      "id" : 1238034201,
      "in_reply_to_id" : 1214732393,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585JyucZ",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 46,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 42,
      "pull_request_review_id" : 1492416463,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238034201/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T06:04:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238034201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238812791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238812791"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit d178c0fb372fc50857438b1b82d344fed0634a10, [txorphanage] impose a maximum total size of orphans]:\r\n\r\ncould this be `maxorphantx * MAX_STANDARD_TX_WEIGHT`, considering that the maximum number of orphans can be changed by the user? Seems a bit weird to just allow the user to change one of the two.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T17:08:05Z",
      "diff_hunk" : "@@ -6,13 +6,17 @@\n #define BITCOIN_TXORPHANAGE_H\n \n #include <net.h>\n+#include <policy/policy.h>\n #include <primitives/block.h>\n #include <primitives/transaction.h>\n #include <sync.h>\n \n #include <map>\n #include <set>\n \n+/** Maximum total size of orphan transactions stored, in bytes. */\n+static constexpr size_t MAX_ORPHAN_TOTAL_SIZE{100 * MAX_STANDARD_TX_WEIGHT};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238812791",
      "id" : 1238812791,
      "line" : 18,
      "node_id" : "PRRC_kwDOABII585J1sh3",
      "original_commit_id" : "d178c0fb372fc50857438b1b82d344fed0634a10",
      "original_line" : 18,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 13,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238812791/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238812791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238826846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238826846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit d178c0fb372fc50857438b1b82d344fed0634a10, [txorphanage] impose a maximum total size of orphans]:\r\n\r\n`size_t` doesn't really make sense for a byte counter imo (there is no corresponding container like there is for the number of orphans).",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T17:22:22Z",
      "diff_hunk" : "@@ -61,7 +65,16 @@ class TxOrphanage {\n         return m_orphans.size();\n     }\n \n+    /** Return total memory usage of the transactions stored. Does not include overhead of\n+     * m_orphans, m_peer_work_set, etc. */\n+    size_t TotalOrphanBytes() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        LOCK(m_mutex);\n+        return m_total_orphan_bytes;\n+    }\n protected:\n+    size_t m_total_orphan_bytes{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238826846",
      "id" : 1238826846,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585J1v9e",
      "original_commit_id" : "d178c0fb372fc50857438b1b82d344fed0634a10",
      "original_line" : 76,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 95,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238826846/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238826846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238893041"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238893041"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit 986f7622dabd422d6dc21bfc3319a0d04d4c4ecc, [txorphanage] track bytes provided per peer: \r\ncan we do without  this line and without `bytes_counted` and instead `Assume` that `m_peer_bytes_used` has no entry for the peer (because `_EraseTx` should have removed all entries for this peer and then also cleared its entry in `m_peer_bytes_used`).",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T18:29:31Z",
      "diff_hunk" : "@@ -106,16 +114,21 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n+    size_t bytes_counted{m_peer_bytes_used.count(peer) ? m_peer_bytes_used.find(peer)->second : 0};\n     std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n         std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n+            bytes_counted -= maybeErase->second.tx->GetTotalSize();\n             nErased += _EraseTx(maybeErase->second.tx->GetWitnessHash());\n         }\n     }\n     if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+    // Either the peer didn't have any orphans, or the amount erased is equal to what the map was storing.\n+    Assume(bytes_counted == 0);\n+    m_peer_bytes_used.erase(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238893041",
      "id" : 1238893041,
      "line" : 165,
      "node_id" : "PRRC_kwDOABII585J2AHx",
      "original_commit_id" : "986f7622dabd422d6dc21bfc3319a0d04d4c4ecc",
      "original_line" : 131,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 170,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238893041/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238893041",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238913973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238913973"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit 498e343a4d767d5c62976d7f48dbac7b82d86157, [refactor] use txpackagetracker for orphan resolution :\r\n\r\ncalling `AddKnownTx()` now even if `fRejectedParents` is `true` seems like a behavior change.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T18:51:35Z",
      "diff_hunk" : "@@ -4078,38 +4095,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         else if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS)\n         {\n             bool fRejectedParents = false; // It may be the case that the orphans parents have all been rejected\n-\n-            // Deduplicate parent txids, so that we don't have to loop over\n-            // the same parent txid more than once down below.\n-            std::vector<uint256> unique_parents;\n-            unique_parents.reserve(tx.vin.size());\n-            for (const CTxIn& txin : tx.vin) {\n-                // We start with all parents, and then remove duplicates below.\n-                unique_parents.push_back(txin.prevout.hash);\n-            }\n-            std::sort(unique_parents.begin(), unique_parents.end());\n-            unique_parents.erase(std::unique(unique_parents.begin(), unique_parents.end()), unique_parents.end());\n-            for (const uint256& parent_txid : unique_parents) {\n+            for (const auto& input : tx.vin) {\n+                const auto& parent_txid = input.prevout.hash;\n+                AddKnownTx(*peer, parent_txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238913973",
      "id" : 1238913973,
      "line" : 4420,
      "node_id" : "PRRC_kwDOABII585J2FO1",
      "original_commit_id" : "498e343a4d767d5c62976d7f48dbac7b82d86157",
      "original_line" : 4100,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 695,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238913973/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238913973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238924470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238924470"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit 498e343a4d767d5c62976d7f48dbac7b82d86157, [refactor] use txpackagetracker for orphan resolution :\r\n\r\nthis looks unintended, with the definition of `had_before` it's `if (!x && x)`, so never true.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T19:03:39Z",
      "diff_hunk" : "@@ -4078,38 +4095,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         else if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS)\n         {\n             bool fRejectedParents = false; // It may be the case that the orphans parents have all been rejected\n-\n-            // Deduplicate parent txids, so that we don't have to loop over\n-            // the same parent txid more than once down below.\n-            std::vector<uint256> unique_parents;\n-            unique_parents.reserve(tx.vin.size());\n-            for (const CTxIn& txin : tx.vin) {\n-                // We start with all parents, and then remove duplicates below.\n-                unique_parents.push_back(txin.prevout.hash);\n-            }\n-            std::sort(unique_parents.begin(), unique_parents.end());\n-            unique_parents.erase(std::unique(unique_parents.begin(), unique_parents.end()), unique_parents.end());\n-            for (const uint256& parent_txid : unique_parents) {\n+            for (const auto& input : tx.vin) {\n+                const auto& parent_txid = input.prevout.hash;\n+                AddKnownTx(*peer, parent_txid);\n                 if (m_recent_rejects.contains(parent_txid)) {\n                     fRejectedParents = true;\n                     break;\n                 }\n             }\n             if (!fRejectedParents) {\n+                const bool had_before{m_txpackagetracker->OrphanageHaveTx(GenTxid::Wtxid(ptx->GetWitnessHash()))};\n                 const auto current_time{GetTime<std::chrono::microseconds>()};\n+                AddOrphanResolutionCandidate(pfrom.GetId(), ptx->GetWitnessHash(), ptx, current_time);\n \n-                for (const uint256& parent_txid : unique_parents) {\n-                    // Here, we only have the txid (and not wtxid) of the\n-                    // inputs, so we only request in txid mode, even for\n-                    // wtxidrelay peers.\n-                    // Eventually we should replace this with an improved\n-                    // protocol for getting all unconfirmed parents.\n-                    const auto gtxid{GenTxid::Txid(parent_txid)};\n-                    AddKnownTx(*peer, parent_txid);\n-                    if (!AlreadyHaveTx(gtxid)) AddTxAnnouncement(pfrom, gtxid, current_time);\n-                }\n-\n-                if (m_txpackagetracker->OrphanageAddTx(ptx, pfrom.GetId())) {\n+                if (!had_before && m_txpackagetracker->OrphanageHaveTx(GenTxid::Wtxid(ptx->GetWitnessHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238924470",
      "id" : 1238924470,
      "line" : 4429,
      "node_id" : "PRRC_kwDOABII585J2Hy2",
      "original_commit_id" : "498e343a4d767d5c62976d7f48dbac7b82d86157",
      "original_line" : 4111,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 718,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238924470/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238924470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238937107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238937107"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "My understanding is that instead of adding all parents of an orphan to the main txrequest tracker (`AddTxAnnouncement`), we now just add the orphan to the orphanage tracker. We then need to request its parents somewhere to preserve behavior, which is done here.\r\nBut I also found this commit hard to understand, would be good to expand the commit msg.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T19:18:52Z",
      "diff_hunk" : "@@ -5860,6 +5859,18 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             }\n         }\n \n+        auto requestable_orphans = m_txpackagetracker->GetOrphanRequests(pto->GetId(), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1238937107",
      "id" : 1238937107,
      "in_reply_to_id" : 1210769183,
      "line" : 6259,
      "node_id" : "PRRC_kwDOABII585J2K4T",
      "original_commit_id" : "bb5e0b21520e6deebcfe9576ae17f4db15c31421",
      "original_line" : 6259,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 862,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238937107/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238937107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1239016063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239016063"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit 0671e1c178270350aadeba625da8b95d6ef2ff00, [p2p] use all orphan announcers as potential parent sources\r\n\r\nthis line doesn't seem to belong here, ancpkginfo hasn't been introduced yet.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T20:47:19Z",
      "diff_hunk" : "@@ -5834,7 +5871,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         //\n-        // Message: getdata (transactions)\n+        // Message: getdata (transactions and ancpkginfo)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1239016063",
      "id" : 1239016063,
      "line" : 6234,
      "node_id" : "PRRC_kwDOABII585J2eJ_",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 5874,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 854,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239016063/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239016063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1239030012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239030012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit fecb522a3fa83e7b485f5d17f070ed56d47e3d90, [txorphanage] support multiple announcers\r\n\r\n`EraseOrphanOfPeer` is introduced but never used anywhere.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-22T21:04:37Z",
      "diff_hunk" : "@@ -79,6 +80,10 @@ class TxOrphanage {\n         return peer_bytes_it == m_peer_bytes_used.end() ? 0 : peer_bytes_it->second;\n     }\n \n+    /** Remove a peer from an orphan's announcers list, erasing the orphan if this is the only peer\n+     * who announced it. If the orphan doesn't exist or does not list this peer as an announcer, do nothing. */\n+    void EraseOrphanOfPeer(const uint256& wtxid, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1239030012",
      "id" : 1239030012,
      "line" : 100,
      "node_id" : "PRRC_kwDOABII585J2hj8",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 85,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 92,
      "pull_request_review_id" : 1493665162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239030012/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239030012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1243535255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243535255"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think mentioning specific policy here would make things more confusing tbh. I can add a mention to BIP331?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-27T10:45:09Z",
      "diff_hunk" : "@@ -492,6 +493,7 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-i2psam=<ip:port>\", \"I2P SAM proxy to reach I2P peers and accept I2P connections (default: none)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-i2pacceptincoming\", strprintf(\"Whether to accept inbound I2P connections (default: %i). Ignored if -i2psam is not set. Listening for inbound I2P connections is done through the SAM proxy, not by binding to a local address and port.\", DEFAULT_I2P_ACCEPT_INCOMING), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-onlynet=<net>\", \"Make automatic outbound connections only to network <net> (\" + Join(GetNetworkNames(), \", \") + \"). Inbound and manual connections are not affected by this option. It can be specified multiple times to allow multiple networks.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    argsman.AddArg(\"-packagerelay\", strprintf(\"[EXPERIMENTAL] Support relaying transaction packages (default: %u)\", node::DEFAULT_ENABLE_PACKAGE_RELAY), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1243535255",
      "id" : 1243535255,
      "in_reply_to_id" : 1237960671,
      "line" : 496,
      "node_id" : "PRRC_kwDOABII585KHteX",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 496,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1500536836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243535255/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T10:45:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243535255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks everyone for the reviews!\r\nLast push:\r\n- Implemented changes that were discussed on the BIP PR https://github.com/bitcoin/bips/pull/1382\r\n    - Maximum of 100 transactions per `getpkgtxns` request\r\n    - Changed `versions` field in `sendpackages` to be 64b instead of 32b.\r\n    - Added a `PKG_RELAY_PKGTXNS` bit for negotiating `getpkgtxns`/`pkgtxns` support in `sendpackages`.\r\n- Fixed some of the bigger problems I found / pointed out by reviewers, e.g.\r\n    - https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1229835172\r\n    - https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1224428421\r\n    - https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213639103\r\n- Rebased on master for the conflicts\r\n\r\nGiven the positive approach feedback, I'm going to polish up the Milestone 1 branch (incorporating comments from here as well) and open a non-draft PR for it.",
      "created_at" : "2023-07-04T11:03:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1620036644",
      "id" : 1620036644,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585gj8wk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1620036644/reactions"
      },
      "updated_at" : "2023-07-04T11:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1620036644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1252120078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252120078"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> download should be dedup when we receive the ancpkginfos ?\r\n\r\nIf it's in your orphanage it won't be fetched again, and will be marked as protected IIUC. See `ReceivedAncPkgInfo`",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-04T14:42:27Z",
      "diff_hunk" : "@@ -43,7 +43,8 @@ class TxOrphanage {\n     /** Erase an orphan by wtxid */\n     int EraseTx(const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    /** Maybe erase all orphans announced by a peer (eg, after that peer disconnects). If an orphan",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1252120078",
      "id" : 1252120078,
      "in_reply_to_id" : 1214732393,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585KodYO",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 46,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 42,
      "pull_request_review_id" : 1513038782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252120078/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-04T14:42:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252120078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253060069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253060069"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T12:48:51Z",
      "diff_hunk" : "@@ -2932,7 +2932,7 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n             LogPrint(BCLog::MEMPOOL, \"   accepted orphan tx %s\\n\", orphanHash.ToString());\n             RelayTransaction(orphanHash, porphanTx->GetWitnessHash());\n             m_txpackagetracker->AddChildrenToWorkSet(*porphanTx);\n-            m_txpackagetracker->EraseOrphanTx(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253060069",
      "id" : 1253060069,
      "in_reply_to_id" : 1210682865,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KsC3l",
      "original_commit_id" : "22e93f08a50a206b54717b07682e73a751cc6755",
      "original_line" : 2935,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253060069/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253060069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253062718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253062718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's true - what type would you suggest?",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T12:51:12Z",
      "diff_hunk" : "@@ -61,7 +65,16 @@ class TxOrphanage {\n         return m_orphans.size();\n     }\n \n+    /** Return total memory usage of the transactions stored. Does not include overhead of\n+     * m_orphans, m_peer_work_set, etc. */\n+    size_t TotalOrphanBytes() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        LOCK(m_mutex);\n+        return m_total_orphan_bytes;\n+    }\n protected:\n+    size_t m_total_orphan_bytes{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253062718",
      "id" : 1253062718,
      "in_reply_to_id" : 1238826846,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585KsDg-",
      "original_commit_id" : "d178c0fb372fc50857438b1b82d344fed0634a10",
      "original_line" : 103,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 95,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253062718/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253062718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253065030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253065030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T12:53:16Z",
      "diff_hunk" : "@@ -106,16 +114,21 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n+    size_t bytes_counted{m_peer_bytes_used.count(peer) ? m_peer_bytes_used.find(peer)->second : 0};\n     std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n         std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n+            bytes_counted -= maybeErase->second.tx->GetTotalSize();\n             nErased += _EraseTx(maybeErase->second.tx->GetWitnessHash());\n         }\n     }\n     if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+    // Either the peer didn't have any orphans, or the amount erased is equal to what the map was storing.\n+    Assume(bytes_counted == 0);\n+    m_peer_bytes_used.erase(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253065030",
      "id" : 1253065030,
      "in_reply_to_id" : 1238893041,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585KsEFG",
      "original_commit_id" : "986f7622dabd422d6dc21bfc3319a0d04d4c4ecc",
      "original_line" : 168,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 173,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253065030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253065030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253066804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253066804"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah I mean of the `GenTxid`. Clarified comment (in other PR), thanks.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T12:54:52Z",
      "diff_hunk" : "@@ -18,14 +39,119 @@ class TxPackageTracker::Impl {\n     bool OrphanageHaveTx(const GenTxid& gtxid) { return m_orphanage.HaveTx(gtxid); }\n     CTransactionRef GetTxToReconsider(NodeId peer) { return m_orphanage.GetTxToReconsider(peer); }\n     int EraseOrphanTx(const uint256& txid) { return m_orphanage.EraseTx(txid); }\n-    void DisconnectedPeer(NodeId peer) {\n-        m_orphanage.EraseForPeer(peer);\n+    void DisconnectedPeer(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        orphan_request_tracker.DisconnectedPeer(nodeid);\n+        m_orphanage.EraseForPeer(nodeid);\n+    }\n+    void BlockConnected(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        const auto wtxids_erased{m_orphanage.EraseForBlock(block)};\n+        std::set<uint256> block_wtxids;\n+        std::set<uint256> conflicted_wtxids;\n+        for (const CTransactionRef& ptx : block.vtx) {\n+            block_wtxids.insert(ptx->GetWitnessHash());\n+        }\n+        for (const auto& wtxid : wtxids_erased) {\n+            if (block_wtxids.count(wtxid) == 0) {\n+                conflicted_wtxids.insert(wtxid);\n+            }\n+        }\n+        FinalizeTransactions(block_wtxids, conflicted_wtxids);\n     }\n-    void BlockConnected(const CBlock& block) { m_orphanage.EraseForBlock(block); }\n     void LimitOrphans(unsigned int max_orphans) { m_orphanage.LimitOrphans(max_orphans); }\n     void AddChildrenToWorkSet(const CTransaction& tx) { m_orphanage.AddChildrenToWorkSet(tx); }\n     bool HaveTxToReconsider(NodeId peer) { return m_orphanage.HaveTxToReconsider(peer); }\n     size_t OrphanageSize() { return m_orphanage.Size(); }\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n+        if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+\n+        // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253066804",
      "id" : 1253066804,
      "in_reply_to_id" : 1210729694,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KsEg0",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 77,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : null,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253066804/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253066804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253067629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253067629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As in `Announcement::m_is_wtxid`, sorry. Clarified (in other PR).",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T12:55:33Z",
      "diff_hunk" : "@@ -4,12 +4,33 @@\n \n #include <node/txpackagetracker.h>\n \n+#include <common/bloom.h>\n+#include <logging.h>\n #include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n \n namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */\n+    static constexpr auto ORPHAN_ANCESTOR_GETDATA_INTERVAL{60s};\n+\n+    /** Delay to add if an orphan resolution candidate is already using a lot of memory in the\n+     * orphanage. */\n+    static constexpr auto ORPHANAGE_OVERLOAD_DELAY{2s};\n+\n class TxPackageTracker::Impl {\n     /** Manages unvalidated tx data (orphan transactions for which we are downloading ancestors). */\n     TxOrphanage m_orphanage;\n+\n+    mutable Mutex m_mutex;\n+\n+    /** Tracks orphans for which we need to request ancestor information. All hashes stored are\n+     * wtxids, i.e., the wtxid of the orphan. However, the is_wtxid field is used to indicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253067629",
      "id" : 1253067629,
      "in_reply_to_id" : 1210708748,
      "line" : 163,
      "node_id" : "PRRC_kwDOABII585KsEtt",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 163,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 163,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253067629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253067629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253068219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253068219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T12:56:03Z",
      "diff_hunk" : "@@ -4,12 +4,33 @@\n \n #include <node/txpackagetracker.h>\n \n+#include <common/bloom.h>\n+#include <logging.h>\n #include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n \n namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253068219",
      "id" : 1253068219,
      "in_reply_to_id" : 1210707099,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585KsE27",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 16,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 16,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253068219/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253068219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253138929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253138929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed/clarified (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T13:48:45Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253138929",
      "id" : 1253138929,
      "in_reply_to_id" : 1210724340,
      "line" : 83,
      "node_id" : "PRRC_kwDOABII585KsWHx",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 83,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 83,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253138929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253138929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253139157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253139157"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added param comment (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T13:48:54Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253139157",
      "id" : 1253139157,
      "in_reply_to_id" : 1210734976,
      "line" : 83,
      "node_id" : "PRRC_kwDOABII585KsWLV",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 83,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 83,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253139157/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253139157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253146225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253146225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Clarified these comments (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T13:53:57Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253146225",
      "id" : 1253146225,
      "in_reply_to_id" : 1210736698,
      "line" : 93,
      "node_id" : "PRRC_kwDOABII585KsX5x",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 93,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 93,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253146225/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253146225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253148822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253148822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've deleted this function as it seems to be a confusing part of the interface. Replaced with separate functions that do similar things. (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T13:55:48Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */\n+    size_t CountInFlight(NodeId nodeid) const;\n+\n+    /** Get list of requests that should be sent to resolve orphans. These may be wtxids to send\n+     * getdata(ANCPKGINFO) or txids corresponding to parents. Automatically marks the orphans as\n+     * having outgoing requests. */\n+    std::vector<GenTxid> GetOrphanRequests(NodeId nodeid, std::chrono::microseconds current_time);\n+\n+    /** Update transactions for which we have made \"final\" decisions: transactions that have\n+     * confirmed in a block, conflicted due to a block, or added to the mempool already.\n+     * Should be called on new block: valid=block transactions, invalid=conflicts.\n+     * Should be called when tx is added to mempool.\n+     * Should not be called when a tx fails validation.\n+     * */\n+    void FinalizeTransactions(const std::set<uint256>& valid, const std::set<uint256>& invalid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253148822",
      "id" : 1253148822,
      "in_reply_to_id" : 1214728153,
      "line" : 107,
      "node_id" : "PRRC_kwDOABII585KsYiW",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 107,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 107,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253148822/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253148822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253151431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253151431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We are not changing the limits, just accounting for orphan parent requests in the normal rate limits. One can argue there's a new restriction, but I'd just say this is simply more accurate enforcement of existing limits. I wouldn't be worried unless you're currently broadcasting descendants before ancestors on purpose to trigger orphan handling and send an extra transaction a few seconds earlier.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T13:57:39Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253151431",
      "id" : 1253151431,
      "in_reply_to_id" : 1214720397,
      "line" : 86,
      "node_id" : "PRRC_kwDOABII585KsZLH",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 86,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 86,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253151431/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253151431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253163572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253163572"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The condition is supposed to be = orphanage didn't have it before, but does have it now (after we called `AddOrphanResolutionCandidate`). Maybe I'm misunderstanding what you mean, but it looks correct to me?\r\n\r\nI'm trying to catch the case where we add the new orphan to the orphanage, but it reaches capacity and happens to be the one evicted.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T14:06:12Z",
      "diff_hunk" : "@@ -4078,38 +4095,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         else if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS)\n         {\n             bool fRejectedParents = false; // It may be the case that the orphans parents have all been rejected\n-\n-            // Deduplicate parent txids, so that we don't have to loop over\n-            // the same parent txid more than once down below.\n-            std::vector<uint256> unique_parents;\n-            unique_parents.reserve(tx.vin.size());\n-            for (const CTxIn& txin : tx.vin) {\n-                // We start with all parents, and then remove duplicates below.\n-                unique_parents.push_back(txin.prevout.hash);\n-            }\n-            std::sort(unique_parents.begin(), unique_parents.end());\n-            unique_parents.erase(std::unique(unique_parents.begin(), unique_parents.end()), unique_parents.end());\n-            for (const uint256& parent_txid : unique_parents) {\n+            for (const auto& input : tx.vin) {\n+                const auto& parent_txid = input.prevout.hash;\n+                AddKnownTx(*peer, parent_txid);\n                 if (m_recent_rejects.contains(parent_txid)) {\n                     fRejectedParents = true;\n                     break;\n                 }\n             }\n             if (!fRejectedParents) {\n+                const bool had_before{m_txpackagetracker->OrphanageHaveTx(GenTxid::Wtxid(ptx->GetWitnessHash()))};\n                 const auto current_time{GetTime<std::chrono::microseconds>()};\n+                AddOrphanResolutionCandidate(pfrom.GetId(), ptx->GetWitnessHash(), ptx, current_time);\n \n-                for (const uint256& parent_txid : unique_parents) {\n-                    // Here, we only have the txid (and not wtxid) of the\n-                    // inputs, so we only request in txid mode, even for\n-                    // wtxidrelay peers.\n-                    // Eventually we should replace this with an improved\n-                    // protocol for getting all unconfirmed parents.\n-                    const auto gtxid{GenTxid::Txid(parent_txid)};\n-                    AddKnownTx(*peer, parent_txid);\n-                    if (!AlreadyHaveTx(gtxid)) AddTxAnnouncement(pfrom, gtxid, current_time);\n-                }\n-\n-                if (m_txpackagetracker->OrphanageAddTx(ptx, pfrom.GetId())) {\n+                if (!had_before && m_txpackagetracker->OrphanageHaveTx(GenTxid::Wtxid(ptx->GetWitnessHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253163572",
      "id" : 1253163572,
      "in_reply_to_id" : 1238924470,
      "line" : 4560,
      "node_id" : "PRRC_kwDOABII585KscI0",
      "original_commit_id" : "498e343a4d767d5c62976d7f48dbac7b82d86157",
      "original_line" : 4560,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 740,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253163572/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253163572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253222853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253222853"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point! Changed so we mark `AddKnownTx` right before we send a parent tx request (in other PR).",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T14:45:38Z",
      "diff_hunk" : "@@ -4078,38 +4095,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         else if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS)\n         {\n             bool fRejectedParents = false; // It may be the case that the orphans parents have all been rejected\n-\n-            // Deduplicate parent txids, so that we don't have to loop over\n-            // the same parent txid more than once down below.\n-            std::vector<uint256> unique_parents;\n-            unique_parents.reserve(tx.vin.size());\n-            for (const CTxIn& txin : tx.vin) {\n-                // We start with all parents, and then remove duplicates below.\n-                unique_parents.push_back(txin.prevout.hash);\n-            }\n-            std::sort(unique_parents.begin(), unique_parents.end());\n-            unique_parents.erase(std::unique(unique_parents.begin(), unique_parents.end()), unique_parents.end());\n-            for (const uint256& parent_txid : unique_parents) {\n+            for (const auto& input : tx.vin) {\n+                const auto& parent_txid = input.prevout.hash;\n+                AddKnownTx(*peer, parent_txid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253222853",
      "id" : 1253222853,
      "in_reply_to_id" : 1238913973,
      "line" : 4551,
      "node_id" : "PRRC_kwDOABII585KsqnF",
      "original_commit_id" : "498e343a4d767d5c62976d7f48dbac7b82d86157",
      "original_line" : 4551,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 717,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253222853/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253222853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253243468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253243468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've squashed the commits so that it's more clear that this was copied to TxPackageTracker (other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T14:59:16Z",
      "diff_hunk" : "@@ -5860,6 +5859,18 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             }\n         }\n \n+        auto requestable_orphans = m_txpackagetracker->GetOrphanRequests(pto->GetId(), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253243468",
      "id" : 1253243468,
      "in_reply_to_id" : 1210769183,
      "line" : 6347,
      "node_id" : "PRRC_kwDOABII585KsvpM",
      "original_commit_id" : "bb5e0b21520e6deebcfe9576ae17f4db15c31421",
      "original_line" : 6347,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 896,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253243468/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253243468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253252501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253252501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:06:07Z",
      "diff_hunk" : "@@ -667,6 +678,21 @@ class TxRequestTracker::Impl {\n         });\n     }\n \n+    void ResetRequestTimeout(NodeId peer, const uint256& txhash, std::chrono::microseconds new_expiry)\n+    {\n+        auto it = m_index.get<ByPeer>().find(ByPeerView{peer, false, txhash});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253252501",
      "id" : 1253252501,
      "in_reply_to_id" : 1211763570,
      "line" : 687,
      "node_id" : "PRRC_kwDOABII585Ksx2V",
      "original_commit_id" : "212a7010257b43eff9fa017bcf625acfc84f650f",
      "original_line" : 687,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 24,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253252501/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253252501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253253635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253253635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:06:58Z",
      "diff_hunk" : "@@ -21,8 +21,14 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n     if (tx == nullptr) return false;\n \n     const uint256& hash = tx->GetHash();\n-    if (m_orphans.count(hash))\n+    if (m_orphans.count(hash)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253253635",
      "id" : 1253253635,
      "in_reply_to_id" : 1211872666,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585KsyID",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 24,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 16,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253253635/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253253635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253262136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253262136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed, thanks (other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:12:30Z",
      "diff_hunk" : "@@ -79,6 +80,10 @@ class TxOrphanage {\n         return peer_bytes_it == m_peer_bytes_used.end() ? 0 : peer_bytes_it->second;\n     }\n \n+    /** Remove a peer from an orphan's announcers list, erasing the orphan if this is the only peer\n+     * who announced it. If the orphan doesn't exist or does not list this peer as an announcer, do nothing. */\n+    void EraseOrphanOfPeer(const uint256& wtxid, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253262136",
      "id" : 1253262136,
      "in_reply_to_id" : 1239030012,
      "line" : 100,
      "node_id" : "PRRC_kwDOABII585Ks0M4",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 100,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 92,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253262136/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:32:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253262136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253270809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253270809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in other PR",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:18:57Z",
      "diff_hunk" : "@@ -3748,6 +3784,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 if (!fAlreadyHave && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n                     AddTxAnnouncement(pfrom, gtxid, current_time);\n                 }\n+                if (inv.IsMsgWtx() && m_txpackagetracker->OrphanageHaveTx(gtxid) && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253270809",
      "id" : 1253270809,
      "in_reply_to_id" : 1212089989,
      "line" : 4117,
      "node_id" : "PRRC_kwDOABII585Ks2UZ",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 4117,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 594,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253270809/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253270809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253271432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253271432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. This is called in a big batch when we realize a tx is an orphan, and then for each inv of a tx that is present in our orphanage.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:19:29Z",
      "diff_hunk" : "@@ -1418,16 +1423,47 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n     }\n }\n \n-void PeerManagerImpl::AddOrphanResolutionCandidate(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& orphan, std::chrono::microseconds current_time)\n+void PeerManagerImpl::AddOrphanAnnouncer(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& tx, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main);\n+    AssertLockHeld(::cs_main); // For m_txrequest\n+    const bool connected = m_connman.ForNode(nodeid, [](CNode* node) { return node->fSuccessfullyConnected && !node->fDisconnect; });\n+    if (!connected) return;\n+    if (m_txpackagetracker->Count(nodeid) + m_txrequest.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) {\n+        // Too many queued announcements. Request from a different peer.\n+        // TODO: Allow peers with Relay permissions to bypass this restriction.\n+        return;\n+    }\n     const CNodeState* state = State(nodeid);\n-    // Decide the TxRequestTracker parameters for this orphan resolution:\n+    // Decide the TxRequestTracker parameters for this orphan resolution.\n+    // TxPackageTracker may also increase the delay.\n     // - \"preferred\": if fPreferredDownload is set (= outbound, or NetPermissionFlags::NoBan permission)\n-    // - \"reqtime\": current time\n+    // - \"reqtime\": current time plus delays for:\n+    //   - NONPREF_PEER_TX_DELAY for announcements from non-preferred connections\n+    //   - OVERLOADED_PEER_TX_DELAY for announcements from peers which have at least\n+    //     MAX_PEER_TX_REQUEST_IN_FLIGHT requests in flight\n+    //     TODO: allow peers with Relay permissions to bypass this restiction\n     auto delay{0us};\n     const bool preferred = state->fPreferredDownload;\n-    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, orphan, preferred, current_time + delay);\n+    if (!preferred) delay += NONPREF_PEER_TX_DELAY;\n+    const bool overloaded = m_txrequest.CountInFlight(nodeid) >= MAX_PEER_TX_REQUEST_IN_FLIGHT;\n+    if (overloaded) delay += OVERLOADED_PEER_TX_DELAY;\n+    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, tx, preferred, current_time + delay);\n+}\n+void PeerManagerImpl::AddOrphanResolutionCandidates(const CTransactionRef& orphan, NodeId originator)\n+{\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // The originator will not show up in GetCandidatePeers() since we already requested from them.\n+    AddOrphanAnnouncer(originator, orphan->GetWitnessHash(), orphan, current_time);\n+    // We prefer to request the orphan's ancestors via package relay rather than txids\n+    // of missing inputs. Also, if the first request fails, we should try again.\n+    // Get all peers that announced this transaction and prioritize accordingly...\n+    for (const auto nodeid : m_txrequest.GetCandidatePeers(orphan->GetWitnessHash())) {\n+        AddOrphanAnnouncer(nodeid, orphan->GetWitnessHash(), orphan, current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253271432",
      "id" : 1253271432,
      "in_reply_to_id" : 1212101478,
      "line" : 1536,
      "node_id" : "PRRC_kwDOABII585Ks2eI",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 1536,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 215,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253271432/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253271432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253272447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253272447"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Through delays. Clarified now in other PR I think.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:20:12Z",
      "diff_hunk" : "@@ -1418,16 +1423,47 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n     }\n }\n \n-void PeerManagerImpl::AddOrphanResolutionCandidate(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& orphan, std::chrono::microseconds current_time)\n+void PeerManagerImpl::AddOrphanAnnouncer(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& tx, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main);\n+    AssertLockHeld(::cs_main); // For m_txrequest\n+    const bool connected = m_connman.ForNode(nodeid, [](CNode* node) { return node->fSuccessfullyConnected && !node->fDisconnect; });\n+    if (!connected) return;\n+    if (m_txpackagetracker->Count(nodeid) + m_txrequest.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) {\n+        // Too many queued announcements. Request from a different peer.\n+        // TODO: Allow peers with Relay permissions to bypass this restriction.\n+        return;\n+    }\n     const CNodeState* state = State(nodeid);\n-    // Decide the TxRequestTracker parameters for this orphan resolution:\n+    // Decide the TxRequestTracker parameters for this orphan resolution.\n+    // TxPackageTracker may also increase the delay.\n     // - \"preferred\": if fPreferredDownload is set (= outbound, or NetPermissionFlags::NoBan permission)\n-    // - \"reqtime\": current time\n+    // - \"reqtime\": current time plus delays for:\n+    //   - NONPREF_PEER_TX_DELAY for announcements from non-preferred connections\n+    //   - OVERLOADED_PEER_TX_DELAY for announcements from peers which have at least\n+    //     MAX_PEER_TX_REQUEST_IN_FLIGHT requests in flight\n+    //     TODO: allow peers with Relay permissions to bypass this restiction\n     auto delay{0us};\n     const bool preferred = state->fPreferredDownload;\n-    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, orphan, preferred, current_time + delay);\n+    if (!preferred) delay += NONPREF_PEER_TX_DELAY;\n+    const bool overloaded = m_txrequest.CountInFlight(nodeid) >= MAX_PEER_TX_REQUEST_IN_FLIGHT;\n+    if (overloaded) delay += OVERLOADED_PEER_TX_DELAY;\n+    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, tx, preferred, current_time + delay);\n+}\n+void PeerManagerImpl::AddOrphanResolutionCandidates(const CTransactionRef& orphan, NodeId originator)\n+{\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // The originator will not show up in GetCandidatePeers() since we already requested from them.\n+    AddOrphanAnnouncer(originator, orphan->GetWitnessHash(), orphan, current_time);\n+    // We prefer to request the orphan's ancestors via package relay rather than txids",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253272447",
      "id" : 1253272447,
      "in_reply_to_id" : 1212076537,
      "line" : 1532,
      "node_id" : "PRRC_kwDOABII585Ks2t_",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 1532,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 211,
      "pull_request_review_id" : 1514439276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253272447/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253272447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253290488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253290488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed here",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:33:29Z",
      "diff_hunk" : "@@ -188,7 +191,7 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n         if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n     }\n     FastRandomContext rng;\n-    while (m_orphans.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)\n+    while (m_orphan_list.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253290488",
      "id" : 1253290488,
      "in_reply_to_id" : 1213639103,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ks7H4",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 194,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 1514811288,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253290488/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:33:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253290488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253291132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253291132"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (in other PR)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T15:34:00Z",
      "diff_hunk" : "@@ -24,7 +24,7 @@ static constexpr size_t MAX_ORPHAN_TOTAL_SIZE{100 * MAX_STANDARD_TX_WEIGHT};\n  */\n class TxOrphanage {\n public:\n-    /** Add a new orphan transaction */\n+    /** Add a new orphan transaction. If the tx already exists, add this peer to its list of announcers. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253291132",
      "id" : 1253291132,
      "in_reply_to_id" : 1211869199,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII585Ks7R8",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 27,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 23,
      "pull_request_review_id" : 1514812329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253291132/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T15:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253291132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253333443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253333443"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the explanation, makes sense. I got confused there somehow.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T16:06:07Z",
      "diff_hunk" : "@@ -4078,38 +4095,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         else if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS)\n         {\n             bool fRejectedParents = false; // It may be the case that the orphans parents have all been rejected\n-\n-            // Deduplicate parent txids, so that we don't have to loop over\n-            // the same parent txid more than once down below.\n-            std::vector<uint256> unique_parents;\n-            unique_parents.reserve(tx.vin.size());\n-            for (const CTxIn& txin : tx.vin) {\n-                // We start with all parents, and then remove duplicates below.\n-                unique_parents.push_back(txin.prevout.hash);\n-            }\n-            std::sort(unique_parents.begin(), unique_parents.end());\n-            unique_parents.erase(std::unique(unique_parents.begin(), unique_parents.end()), unique_parents.end());\n-            for (const uint256& parent_txid : unique_parents) {\n+            for (const auto& input : tx.vin) {\n+                const auto& parent_txid = input.prevout.hash;\n+                AddKnownTx(*peer, parent_txid);\n                 if (m_recent_rejects.contains(parent_txid)) {\n                     fRejectedParents = true;\n                     break;\n                 }\n             }\n             if (!fRejectedParents) {\n+                const bool had_before{m_txpackagetracker->OrphanageHaveTx(GenTxid::Wtxid(ptx->GetWitnessHash()))};\n                 const auto current_time{GetTime<std::chrono::microseconds>()};\n+                AddOrphanResolutionCandidate(pfrom.GetId(), ptx->GetWitnessHash(), ptx, current_time);\n \n-                for (const uint256& parent_txid : unique_parents) {\n-                    // Here, we only have the txid (and not wtxid) of the\n-                    // inputs, so we only request in txid mode, even for\n-                    // wtxidrelay peers.\n-                    // Eventually we should replace this with an improved\n-                    // protocol for getting all unconfirmed parents.\n-                    const auto gtxid{GenTxid::Txid(parent_txid)};\n-                    AddKnownTx(*peer, parent_txid);\n-                    if (!AlreadyHaveTx(gtxid)) AddTxAnnouncement(pfrom, gtxid, current_time);\n-                }\n-\n-                if (m_txpackagetracker->OrphanageAddTx(ptx, pfrom.GetId())) {\n+                if (!had_before && m_txpackagetracker->OrphanageHaveTx(GenTxid::Wtxid(ptx->GetWitnessHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253333443",
      "id" : 1253333443,
      "in_reply_to_id" : 1238924470,
      "line" : 4560,
      "node_id" : "PRRC_kwDOABII585KtFnD",
      "original_commit_id" : "498e343a4d767d5c62976d7f48dbac7b82d86157",
      "original_line" : 4560,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 740,
      "pull_request_review_id" : 1514879811,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253333443/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T16:06:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253333443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253401345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253401345"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, I think the maximum possible value is currently `101 * MAX_STANDARD_TX_WEIGHT` (after that, `LimitOrphans()` would kick in), so an `unsigned int` should suffice in theory? Maybe use a `uint64_t` if this was to be made configurable by users (see comment above, but not sure if that makes sense).",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-05T17:07:41Z",
      "diff_hunk" : "@@ -61,7 +65,16 @@ class TxOrphanage {\n         return m_orphans.size();\n     }\n \n+    /** Return total memory usage of the transactions stored. Does not include overhead of\n+     * m_orphans, m_peer_work_set, etc. */\n+    size_t TotalOrphanBytes() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        LOCK(m_mutex);\n+        return m_total_orphan_bytes;\n+    }\n protected:\n+    size_t m_total_orphan_bytes{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1253401345",
      "id" : 1253401345,
      "in_reply_to_id" : 1238826846,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585KtWMB",
      "original_commit_id" : "d178c0fb372fc50857438b1b82d344fed0634a10",
      "original_line" : 103,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 95,
      "pull_request_review_id" : 1514983401,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253401345/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T17:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1253401345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1255193877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1255193877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Okay so Ive been looking into the code, and yes to my understanding there is _no_ processing penalty at `GETPKGTXNS` reception in `ProcessMessage` than our child has 1 or N parents, were calling `FindTxForGetdata` to compose the response `PKGTXNS`. This invalidate this specific source of concern.\r\n\r\n> we have rate-limiting based on the way the parents are fetched (i.e individiually rather than in batch) the equivalent package of A+E will propagate better.\r\n\r\nIll maintain there is still an interpedency between package rate-limits and package compositions, though telling what to do a LN node is unclear and can be deferred to ulterior documentation.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-07T03:15:13Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1255193877",
      "id" : 1255193877,
      "in_reply_to_id" : 1214720397,
      "line" : 86,
      "node_id" : "PRRC_kwDOABII585K0L0V",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 86,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 86,
      "pull_request_review_id" : 1517694056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1255193877/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T03:15:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1255193877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1255197289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1255197289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes adding a mention in BIP331 than a p2p packages can support multiple versions of policy regimes e.g nversion=3. \r\n\r\nFor flexibility towards the node operators in their resource management (especially for DoS protection on low-performance hosts), I think we should have a `acceptnversion=3`setting, that way a node operator can opted in package relay though not in the most computationally expensive type of policy regimes. The utility of such setting is theoretical as long as we have one policy regime for p2p packages, like right now.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-07T03:22:56Z",
      "diff_hunk" : "@@ -492,6 +493,7 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-i2psam=<ip:port>\", \"I2P SAM proxy to reach I2P peers and accept I2P connections (default: none)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-i2pacceptincoming\", strprintf(\"Whether to accept inbound I2P connections (default: %i). Ignored if -i2psam is not set. Listening for inbound I2P connections is done through the SAM proxy, not by binding to a local address and port.\", DEFAULT_I2P_ACCEPT_INCOMING), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-onlynet=<net>\", \"Make automatic outbound connections only to network <net> (\" + Join(GetNetworkNames(), \", \") + \"). Inbound and manual connections are not affected by this option. It can be specified multiple times to allow multiple networks.\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    argsman.AddArg(\"-packagerelay\", strprintf(\"[EXPERIMENTAL] Support relaying transaction packages (default: %u)\", node::DEFAULT_ENABLE_PACKAGE_RELAY), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1255197289",
      "id" : 1255197289,
      "in_reply_to_id" : 1237960671,
      "line" : 500,
      "node_id" : "PRRC_kwDOABII585K0Mpp",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 500,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1517697867,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1255197289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T03:22:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1255197289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1259064139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1259064139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So `m_recent_rejects_reconsiderable` logs transaction on its wtxid (which is good to avoid witness inflation changing the result) however isnt that two restrictive if you have PKG1 submitted with A+B, A is too low with B and then you have A+B where A is good enough ? Or is that `TX_LOW_FEE` when the transaction isnt good enough to meet mempool min fee not meet / min relay fee not met ?\r\n\r\nIf its correct, I would still favor to exempt package transaction from min relay fee checks as its some awful interdependency for pre-signed lightning transaction :)",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-11T01:15:06Z",
      "diff_hunk" : "@@ -3012,14 +3170,86 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n                     m_recent_rejects.insert(porphanTx->GetHash());\n                 }\n             }\n-            m_orphanage.EraseTx(orphanHash);\n+            m_txpackagetracker->EraseOrphanTx(porphanTx->GetWitnessHash());\n             return true;\n         }\n     }\n \n     return false;\n }\n \n+void PeerManagerImpl::ProcessPackage(CNode& node, const node::TxPackageTracker::PackageToValidate& package)\n+{\n+    AssertLockHeld(g_msgproc_mutex);\n+    LOCK(cs_main);\n+    // We won't re-validate the exact same transaction or package again.\n+    if (m_recent_rejects_reconsiderable.contains(GetPackageHash(package.m_unvalidated_txns))) {\n+        // Should we do anything else here?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1259064139",
      "id" : 1259064139,
      "line" : 3187,
      "node_id" : "PRRC_kwDOABII585LC8tL",
      "original_commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "original_line" : 3187,
      "original_position" : 469,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 469,
      "pull_request_review_id" : 1523258231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1259064139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T01:15:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1259064139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1259525623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1259525623"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, that's the idea of \"reconsiderable.\" If you get A again with a different package, you reconsider it. If you get A+B again, you don't. In this set of changes, `TX_LOW_FEE` is used to decide to put something in the reconsiderable cache.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-11T10:15:30Z",
      "diff_hunk" : "@@ -3012,14 +3170,86 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n                     m_recent_rejects.insert(porphanTx->GetHash());\n                 }\n             }\n-            m_orphanage.EraseTx(orphanHash);\n+            m_txpackagetracker->EraseOrphanTx(porphanTx->GetWitnessHash());\n             return true;\n         }\n     }\n \n     return false;\n }\n \n+void PeerManagerImpl::ProcessPackage(CNode& node, const node::TxPackageTracker::PackageToValidate& package)\n+{\n+    AssertLockHeld(g_msgproc_mutex);\n+    LOCK(cs_main);\n+    // We won't re-validate the exact same transaction or package again.\n+    if (m_recent_rejects_reconsiderable.contains(GetPackageHash(package.m_unvalidated_txns))) {\n+        // Should we do anything else here?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1259525623",
      "id" : 1259525623,
      "in_reply_to_id" : 1259064139,
      "line" : 3187,
      "node_id" : "PRRC_kwDOABII585LEtX3",
      "original_commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "original_line" : 3187,
      "original_position" : 469,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 469,
      "pull_request_review_id" : 1523934951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1259525623/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T10:15:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1259525623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264308888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264308888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Okay reconsiderable makes sense to me, still have to review its correctly implemented. \r\n\r\n> If its correct, I would still favor to exempt package transaction from min relay fee checks as its some awful interdependency for pre-signed lightning transaction :)\r\n\r\nFor this concern, in fact its already addressed by the latest state of bip 331 code and nversion=3 documentation, confusion is mine, I thought mempool min fee checks on parent was still present from previous package / acceptance relay reviews. ",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-15T03:46:33Z",
      "diff_hunk" : "@@ -3012,14 +3170,86 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n                     m_recent_rejects.insert(porphanTx->GetHash());\n                 }\n             }\n-            m_orphanage.EraseTx(orphanHash);\n+            m_txpackagetracker->EraseOrphanTx(porphanTx->GetWitnessHash());\n             return true;\n         }\n     }\n \n     return false;\n }\n \n+void PeerManagerImpl::ProcessPackage(CNode& node, const node::TxPackageTracker::PackageToValidate& package)\n+{\n+    AssertLockHeld(g_msgproc_mutex);\n+    LOCK(cs_main);\n+    // We won't re-validate the exact same transaction or package again.\n+    if (m_recent_rejects_reconsiderable.contains(GetPackageHash(package.m_unvalidated_txns))) {\n+        // Should we do anything else here?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264308888",
      "id" : 1264308888,
      "in_reply_to_id" : 1259064139,
      "line" : 3187,
      "node_id" : "PRRC_kwDOABII585LW9KY",
      "original_commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "original_line" : 3187,
      "original_position" : 469,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 469,
      "pull_request_review_id" : 1531249782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264308888/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-15T03:46:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264308888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264309536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264309536"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this check is correct in what it aims to achieve, i.e not apply the two mempool min fee checks on ancestor package transaction, if it received as such from `AcceptAncestorPackage` / `ProcessNewPackage`, however this is unclear if this exemption apply for all BIP331 package, indifferently of their transactions versions, or only for nversion=3 ones.\r\n\r\nFor context, see https://github.com/lightningdevkit/rust-lightning/pull/2415#discussion_r1263189013",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-15T03:53:45Z",
      "diff_hunk" : "@@ -1423,39 +1438,74 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n             assert(iter != std::nullopt);\n             // Provide the wtxid of the mempool tx so that the caller can look it up in the mempool.\n             results_final.emplace(wtxid, MempoolAcceptResult::MempoolTxDifferentWitness(iter.value()->GetTx().GetWitnessHash()));\n+            packageified.Exclude(tx);\n         } else {\n             // Transaction does not already exist in the mempool.\n-            // Try submitting the transaction on its own.\n-            const auto single_res = AcceptSingleTransaction(tx, single_args);\n-            if (single_res.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-                // The transaction succeeded on its own and is now in the mempool. Don't include it\n-                // in package validation, because its fees should only be \"used\" once.\n-                assert(m_pool.exists(GenTxid::Wtxid(wtxid)));\n-                results_final.emplace(wtxid, single_res);\n-            } else if (single_res.m_state.GetResult() != TxValidationResult::TX_MEMPOOL_POLICY &&\n-                       single_res.m_state.GetResult() != TxValidationResult::TX_MISSING_INPUTS) {\n-                // Package validation policy only differs from individual policy in its evaluation\n-                // of feerate. For example, if a transaction fails here due to violation of a\n-                // consensus rule, the result will not change when it is submitted as part of a\n-                // package. To minimize the amount of repeated work, unless the transaction fails\n-                // due to feerate or missing inputs (its parent is a previous transaction in the\n-                // package that failed due to feerate), don't run package validation. Note that this\n-                // decision might not make sense if different types of packages are allowed in the\n-                // future.  Continue individually validating the rest of the transactions, because\n-                // some of them may still be valid.\n-                quit_early = true;\n-                package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n-                individual_results_nonfinal.emplace(wtxid, single_res);\n-            } else {\n-                individual_results_nonfinal.emplace(wtxid, single_res);\n-                txns_package_eval.push_back(tx);\n+            const auto subpackage = packageified.GetAncestorSet(tx);\n+            if (!subpackage) {\n+                // This transaction depends on a tx we will definitely not accept (failed for a\n+                // non-policy and non-missing-inputs reason). We already know that this transaction\n+                // will be invalid for at least one reason, i.e. a missing input. To minimize the\n+                // amount of repeated work, don't validate this tx. Just return missing inputs.\n+                TxValidationState tx_state_quit_early;\n+                tx_state_quit_early.Invalid(TxValidationResult::TX_MISSING_INPUTS, \"invalid-tx-dependency\");\n+                results_final.emplace(wtxid, MempoolAcceptResult::Failure(tx_state_quit_early));\n+                // Don't quit too early. Other transactions may not necessarily depend on the same\n+                // parent, and should still be considered.\n+                continue;\n+            }\n+            if (wtxid == child->GetWitnessHash()) {\n+                Assume(tx == package.back());\n+                // Validate the child outside of this loop. We will consolidate results_final,\n+                // individual_results_nonfinal, and the result of validating the last transaction's\n+                // subpackage into a single PackageMempoolAcceptResult.\n+                break;\n+            }\n+            // This transaction does not already exist in the mempool and is not the child.\n+            // Try submitting the transaction with its in-package ancestor set.\n+            const auto subpackage_result = AcceptPackageWrappingSingle(subpackage.value(), args);\n+            // Look for \"final\" answers: once a tx is successfully submitted, we can add its\n+            // MempoolAcceptResult to the results map. Note that it's possible for transactions to\n+            // have been submitted to the mempool even if subpackage_result.m_state.IsInvalid().\n+            for (const auto& subpackage_tx : subpackage.value()) {\n+                const auto subpackage_wtxid{subpackage_tx->GetWitnessHash()};\n+                if (m_pool.exists(GenTxid::Wtxid(subpackage_wtxid))) {\n+                    const auto subpackage_it{subpackage_result.m_tx_results.find(subpackage_wtxid)};\n+                    results_final.emplace(subpackage_wtxid, subpackage_it->second);\n+                    // Erase any previous invalid results for this transaction. For example, this\n+                    // could be a low-feerate tx that has just been bumped.\n+                    individual_results_nonfinal.erase(subpackage_wtxid);\n+                    packageified.Exclude(subpackage_tx);\n+                }\n+            }\n+            // If m_state is valid, we already processed each tx in the loop above.\n+            if (subpackage_result.m_state.IsValid()) continue;\n+\n+            const auto single_res_it = subpackage_result.m_tx_results.find(wtxid);\n+            if (single_res_it != subpackage_result.m_tx_results.end()) {\n+                const auto single_res = single_res_it->second;\n+                if (single_res.m_state.GetResult() != TxValidationResult::TX_MEMPOOL_POLICY &&\n+                    single_res.m_state.GetResult() != TxValidationResult::TX_LOW_FEE &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264309536",
      "id" : 1264309536,
      "line" : 1488,
      "node_id" : "PRRC_kwDOABII585LW9Ug",
      "original_commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "original_line" : 1488,
      "original_position" : 298,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 298,
      "pull_request_review_id" : 1531250506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264309536/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-15T03:53:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264309536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264747557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264747557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `wtxids`, this one is not a copy.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-16T21:05:13Z",
      "diff_hunk" : "@@ -180,3 +180,17 @@ void AncestorPackage::Ban(const CTransactionRef& transaction)\n     if (ancestor_subsets.count(transaction->GetHash()) == 0) return;\n     banned_txns.insert(transaction->GetHash());\n }\n+\n+uint256 GetCombinedHash(const std::vector<uint256>& wtxids)\n+{\n+    std::vector<uint256> wtxids_copy(wtxids.cbegin(), wtxids.cend());\n+    std::sort(wtxids_copy.begin(), wtxids_copy.end());\n+    return (HashWriter() << wtxids_copy).GetHash();\n+}\n+uint256 GetPackageHash(const std::vector<CTransactionRef>& transactions)\n+{\n+    std::vector<uint256> wtxids_copy;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264747557",
      "id" : 1264747557,
      "line" : 192,
      "node_id" : "PRRC_kwDOABII585LYoQl",
      "original_commit_id" : "e7cfd56cdb9078e1fd0701638754c05d9991bac1",
      "original_line" : 192,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/policy/packages.cpp",
      "position" : 197,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264747557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264747557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264748895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264748895"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "3494f96ebacf53cbd5fd09f6421d9dabec87361e:\r\nshould update this line too because fee is no longer included in it",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-16T21:17:46Z",
      "diff_hunk" : "@@ -54,6 +54,7 @@ enum class TxValidationResult {\n     TX_CONFLICT,\n     TX_MEMPOOL_POLICY,        //!< violated mempool's fee/size/descendant/RBF/etc limits",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1264748895",
      "id" : 1264748895,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585LYolf",
      "original_commit_id" : "3494f96ebacf53cbd5fd09f6421d9dabec87361e",
      "original_line" : 55,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "src/consensus/validation.h",
      "position" : 2,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264748895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264748895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265523786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265523786"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "3494f96ebacf53cbd5fd09f6421d9dabec87361e:\r\nDo we need to adjust the logic in `ProcessOrphanTx()` too, by inserting there into `m_recent_rejects_reconsiderable` instead of `m_recent_rejects` if the reason was low-fee? It currently adds the wtxid of a reconsidered orphan to `m_recent_rejects` if it fails for policy/fee-related reasons. But if that resolved orphan is itself one of the parent of another orphan we wouldn't consider that (possibly high-fee) child because a parent was rejected.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T15:15:08Z",
      "diff_hunk" : "@@ -835,6 +840,33 @@ class PeerManagerImpl final : public PeerManager\n      * Memory used: 1.3 MB\n      */\n     CRollingBloomFilter m_recent_rejects GUARDED_BY(::cs_main){120'000, 0.000'001};\n+    /**\n+     * Filter for transactions or packages of transactions that were recently rejected by\n+     * the mempool but are eligible for reconsideration if submitted with other transactions.\n+     * This filter only contains wtxids of individual transactions and combined hashes of packages\n+     * (see GetCombinedHash and GetPackageHash).\n+     *\n+     * When a transaction's error is TX_LOW_FEE (in a package or by itself), add its wtxid to this\n+     * filter. If it was in a package, also add the combined hash of the transactions in its\n+     * subpackage to this filter. When a package fails for any reason, add the combined hash of all\n+     * transactions in the package info to this filter.\n+     *\n+     * Upon receiving an announcement for a transaction, if it exists in this filter, do not\n+     * download the txdata. Upon receiving a package info, if the combined hash of its transactions\n+     * are in this filter, do not download the txdata.\n+     *\n+     * Reset this filter when the chain tip changes.\n+     *\n+     * We will only add wtxids to this filter. Groups of multiple transactions are represented by\n+     * the hash of their wtxids, concatenated together in lexicographical order.\n+     *\n+     * Parameters are picked to be identical to that of m_recent_rejects, with the same rationale.\n+     * Memory used: 1.3 MB\n+     * FIXME: this filter can probably be smaller, but how much smaller?\n+     */\n+    CRollingBloomFilter m_recent_rejects_reconsiderable GUARDED_BY(::cs_main){120'000, 0.000'001};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265523786",
      "id" : 1265523786,
      "line" : 871,
      "node_id" : "PRRC_kwDOABII585LblxK",
      "original_commit_id" : "3494f96ebacf53cbd5fd09f6421d9dabec87361e",
      "original_line" : 867,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 143,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265523786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265523786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265739284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265739284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The approach to add a wtxid disguised as a txid to distinguish between legacy orphan processing and package relay seems a bit like a hack to me. \r\nI'm not strictly against it, but I guess I don't completely understand yet why it's necessary - the information whether a peer supports package relay does not change, so why can't we just always use `GenTxid::Wtxid(wtxid)` and check again in `GetOrphanRequests()` and elsewhere whether we do  package relay with the peer instead of checking whether it's a txid / wtxid?",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T18:15:13Z",
      "diff_hunk" : "@@ -158,14 +164,26 @@ class TxPackageTracker::Impl {\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n \n-        // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n-        orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n+        // Skip if already requested in the (recent-ish) past.\n+        if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n+\n+        auto it_peer_info = info_per_peer.find(nodeid);\n+        if (it_peer_info != info_per_peer.end() && it_peer_info->second.SupportsVersion(PKG_RELAY_ANCPKG)) {\n+            // Package relay peer: is_wtxid=true because we will be requesting via ancpkginfo.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from package relay peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Wtxid(wtxid), is_preferred, reqtime);\n+        } else {\n+            // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from legacy peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265739284",
      "id" : 1265739284,
      "line" : 300,
      "node_id" : "PRRC_kwDOABII585LcaYU",
      "original_commit_id" : "ae2664793b1d0d86bfa32c3e635d83b1ee083e60",
      "original_line" : 178,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 300,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265739284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265739284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265806240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265806240"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's an unsolicited `NOTFOUND` of type `MSG_ANCPKGINFO`, would be good to distinguish between the inv type and the actual `ANCPKGINFO` message.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T19:24:05Z",
      "diff_hunk" : "@@ -5077,6 +5131,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     // If we receive a NOTFOUND message for a tx we requested, mark the announcement for it as\n                     // completed in TxRequestTracker.\n                     m_txrequest.ReceivedResponse(pfrom.GetId(), inv.hash);\n+                } else if (inv.IsMsgAncPkgInfo() && m_enable_package_relay) {\n+                    if (!m_txpackagetracker->PkgInfoAllowed(pfrom.GetId(), inv.hash, node::PKG_RELAY_ANCPKG)) {\n+                        LogPrint(BCLog::NET, \"\\nUnsolicited ancpkginfo sent, disconnecting peer=%d\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265806240",
      "id" : 1265806240,
      "line" : 5316,
      "node_id" : "PRRC_kwDOABII585Lcqug",
      "original_commit_id" : "dd6fb139b8887f3400a65dc0d4c4ee54cf53d0bc",
      "original_line" : 5136,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 850,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265806240/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265806240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265811166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265811166"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : " `PkgInfoAllowed()` calling `ReceivedResponse()` as a side effect is surprising to me. Wouldn't it be better if the caller would also have to explicitly call `ForgetPkgInfo()` if they want to forget about the package? This is also not mentioned in its doc.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T19:30:00Z",
      "diff_hunk" : "@@ -240,6 +267,31 @@ class TxPackageTracker::Impl {\n             orphan_request_tracker.ForgetTxHash(wtxid);\n         }\n     }\n+    bool PkgInfoAllowed(NodeId nodeid, const uint256& wtxid, PackageRelayVersions version) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        auto peerinfo_it = info_per_peer.find(nodeid);\n+        if (peerinfo_it == info_per_peer.end()) {\n+            return false;\n+        } else if (!peerinfo_it->second.SupportsVersion(version)) {\n+            return false;\n+        }\n+        if (!packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, version))) {\n+            return false;\n+        }\n+        orphan_request_tracker.ReceivedResponse(nodeid, wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265811166",
      "id" : 1265811166,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Lcr7e",
      "original_commit_id" : "ae2664793b1d0d86bfa32c3e635d83b1ee083e60",
      "original_line" : 283,
      "original_position" : 149,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : null,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265811166/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265811166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265838609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265838609"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that the splitting into commits is not ideal here: In ae2664793b1d0d86bfa32c3e635d83b1ee083e60, we add logic to return the wtxid, expecting it to be requested by `MSG_ANCPKGINFO`. But the net_processing code to actually do this is only added in dd6fb139b8887f3400a65dc0d4c4ee54cf53d0bc, so that at ae2664793b1d0d86bfa32c3e635d83b1ee083e60, we'd send out a `MSG_TX` getdata, thus re-requesting a TX we already know. These two things should go together into one commit.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T20:00:27Z",
      "diff_hunk" : "@@ -195,36 +213,45 @@ class TxPackageTracker::Impl {\n         }\n         std::vector<GenTxid> results;\n         for (const auto& gtxid : tracker_requestable) {\n-            LogPrint(BCLog::TXPACKAGES, \"\\nResolving orphan %s, requesting by txids of parents from peer=%d\\n\", gtxid.GetHash().ToString(), nodeid);\n-            const auto ptx = m_orphanage.GetTx(gtxid.GetHash());\n-            if (!ptx) {\n-                // We can't request ancpkginfo and we have no way of knowing what the missing\n-                // parents are (it could also be that the orphan has already been resolved).\n-                // Give up.\n-                orphan_request_tracker.ForgetTxHash(gtxid.GetHash());\n-                LogPrint(BCLog::TXPACKAGES, \"\\nForgetting orphan %s from peer=%d\\n\", gtxid.GetHash().ToString(), nodeid);\n-                continue;\n+            if (gtxid.IsWtxid()) {\n+                Assume(info_per_peer.find(nodeid) != info_per_peer.end());\n+                // Add the orphan's wtxid as-is.\n+                LogPrint(BCLog::TXPACKAGES, \"\\nResolving orphan %s, requesting by ancpkginfo from peer=%d\\n\", gtxid.GetHash().ToString(), nodeid);\n+                results.emplace_back(gtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265838609",
      "id" : 1265838609,
      "line" : 415,
      "node_id" : "PRRC_kwDOABII585LcyoR",
      "original_commit_id" : "ae2664793b1d0d86bfa32c3e635d83b1ee083e60",
      "original_line" : 220,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 415,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265838609/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265838609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265856298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265856298"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We should also disable sending \"sendpackages\" for outgoing block-relay-only connections and probably also feelers, would suggest to just use `RejectIncomingTxs()`.\r\nAlso, I think this should be moved up and combined with the `m_enable_package_relay` check two lines above, because I see no reason to call `m_txpackagetracker->ReceivedVersion()` in these scenarios.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T20:18:41Z",
      "diff_hunk" : "@@ -3440,6 +3457,16 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (greatest_common_version >= WTXID_RELAY_VERSION) {\n             m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::WTXIDRELAY));\n+            if (m_enable_package_relay) {\n+                m_txpackagetracker->ReceivedVersion(peer->m_id);\n+                if (!m_ignore_incoming_txs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265856298",
      "id" : 1265856298,
      "line" : 3623,
      "node_id" : "PRRC_kwDOABII585Lc28q",
      "original_commit_id" : "e32dd99e42474ec8b3a996797e1a4f911a8e65a4",
      "original_line" : 3462,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 544,
      "pull_request_review_id" : 1531801228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265856298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265856298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265868269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265868269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It makes it very difficult to read, imo, and lilkely introduces bugs going forward, if not now.\r\n\r\nNote @mzumsande that this logic lives in the orphan relay PR IIRC",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T20:30:46Z",
      "diff_hunk" : "@@ -158,14 +164,26 @@ class TxPackageTracker::Impl {\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n \n-        // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n-        orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n+        // Skip if already requested in the (recent-ish) past.\n+        if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n+\n+        auto it_peer_info = info_per_peer.find(nodeid);\n+        if (it_peer_info != info_per_peer.end() && it_peer_info->second.SupportsVersion(PKG_RELAY_ANCPKG)) {\n+            // Package relay peer: is_wtxid=true because we will be requesting via ancpkginfo.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from package relay peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Wtxid(wtxid), is_preferred, reqtime);\n+        } else {\n+            // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from legacy peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265868269",
      "id" : 1265868269,
      "in_reply_to_id" : 1265739284,
      "line" : 300,
      "node_id" : "PRRC_kwDOABII585Lc53t",
      "original_commit_id" : "ae2664793b1d0d86bfa32c3e635d83b1ee083e60",
      "original_line" : 178,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 300,
      "pull_request_review_id" : 1533637663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265868269/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T20:30:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265868269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265915386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265915386"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "right - I'll copy the comment so that we can discuss there - this one can be resolved.",
      "commit_id" : "98046599812a4aa1e5c43d92969a7cd2a5526b1e",
      "created_at" : "2023-07-17T21:20:13Z",
      "diff_hunk" : "@@ -158,14 +164,26 @@ class TxPackageTracker::Impl {\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n \n-        // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n-        orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n+        // Skip if already requested in the (recent-ish) past.\n+        if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n+\n+        auto it_peer_info = info_per_peer.find(nodeid);\n+        if (it_peer_info != info_per_peer.end() && it_peer_info->second.SupportsVersion(PKG_RELAY_ANCPKG)) {\n+            // Package relay peer: is_wtxid=true because we will be requesting via ancpkginfo.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from package relay peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Wtxid(wtxid), is_preferred, reqtime);\n+        } else {\n+            // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.\n+            LogPrint(BCLog::TXPACKAGES, \"\\nPotential orphan resolution for %s from legacy peer=%d\\n\", wtxid.ToString(), nodeid);\n+            orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1265915386",
      "id" : 1265915386,
      "in_reply_to_id" : 1265739284,
      "line" : 300,
      "node_id" : "PRRC_kwDOABII585LdFX6",
      "original_commit_id" : "ae2664793b1d0d86bfa32c3e635d83b1ee083e60",
      "original_line" : 178,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 300,
      "pull_request_review_id" : 1533717256,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265915386/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T21:20:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265915386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-20T10:52:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1643703266",
      "id" : 1643703266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585h-Ovi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1643703266/reactions"
      },
      "updated_at" : "2023-07-20T10:52:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1643703266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I suspect this implementation, with an absurdly high ancestor chain limit being set, would violate the 100 txn limit for `getpackagetxns`: https://github.com/bitcoin/bips/blob/02ec218c7857ef60914e9a3d383b68caf987f70b/bip-0331.mediawiki#getpkgtxns\r\n\r\n",
      "created_at" : "2023-08-28T18:00:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1696113420",
      "id" : 1696113420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585lGKMM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1696113420/reactions"
      },
      "updated_at" : "2023-08-28T18:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1696113420",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I suspect this implementation, with an absurdly high ancestor chain limit being set, would violate the 100 txn limit for getpackagetxns: https://github.com/bitcoin/bips/blob/02ec218c7857ef60914e9a3d383b68caf987f70b/bip-0331.mediawiki#getpkgtxns\r\n\r\nAre you sure? We still require an `ancpkginfo` to have (non-configurable) `MAX_PACKAGE_COUNT` or fewer transactions, otherwise we exit \"discarding packageinfo, too many transactions\". But I can add a check that the list is <= `MAX_PKGTXNS_COUNT` prior to sending.",
      "created_at" : "2023-08-29T09:37:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1697099748",
      "id" : 1697099748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585lJ6_k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697099748/reactions"
      },
      "updated_at" : "2023-08-29T09:37:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697099748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added check that outbound `getpkgtxns` is <= `MAX_PKGTXNS_COUNT`. Also changed the combined hash from double-sha256 to single-sha256 (which was changed in the BIP recently).",
      "created_at" : "2023-08-29T11:00:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1697224567",
      "id" : 1697224567,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585lKZd3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697224567/reactions"
      },
      "updated_at" : "2023-08-29T11:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697224567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Dropping note from offline discussion: probably worthwhile to just to advise users that setting ancestor count higher than 25 may end in weird behavior with chains longer than what package relay can support. I don't know of anyone who sets this value higher manually for production usage, and the value can be updated later easily as an implementation detail. ",
      "created_at" : "2023-09-05T13:07:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1706588280",
      "id" : 1706588280,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585luHh4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1706588280/reactions"
      },
      "updated_at" : "2023-09-05T13:07:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1706588280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1329033501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329033501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it can say do not download \"the whole package data\", if this is referencing to the check L4415 in `src/net_processing.cpp` as pkg info itself is discarded.",
      "commit_id" : "2614777aa14f232f74cad18af44f7c6509a61528",
      "created_at" : "2023-09-18T16:56:34Z",
      "diff_hunk" : "@@ -776,13 +801,18 @@ class PeerManagerImpl final : public PeerManager\n     /** Stalling timeout for blocks in IBD */\n     std::atomic<std::chrono::seconds> m_block_stalling_timeout{BLOCK_STALLING_TIMEOUT_DEFAULT};\n \n-    bool AlreadyHaveTx(const GenTxid& gtxid)\n+    bool AlreadyHaveTx(const GenTxid& gtxid, bool include_orphanage = true)\n         EXCLUSIVE_LOCKS_REQUIRED(cs_main, !m_recent_confirmed_transactions_mutex);\n \n     /**\n-     * Filter for transactions that were recently rejected by the mempool.\n-     * These are not rerequested until the chain tip changes, at which point\n-     * the entire filter is reset.\n+     * Filter for transactions that were recently rejected by the mempool for reasons other than too\n+     * low fee. This filter only contains wtxids and txids of individual transactions.\n+     *\n+     * Upon receiving an announcement for a transaction, if it exists in this filter, do not\n+     * download the txdata. Upon receiving a package info, if it contains a transaction in this\n+     * filter, do not download the tx data.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1329033501",
      "id" : 1329033501,
      "line" : 813,
      "node_id" : "PRRC_kwDOABII585PN3Ed",
      "original_commit_id" : "2614777aa14f232f74cad18af44f7c6509a61528",
      "original_line" : 813,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 109,
      "pull_request_review_id" : 1631576047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329033501/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-18T16:58:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329033501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--13523179cfe9479db18ec6c5d236f789-->\nThere hasn't been much activity lately and the patch still needs rebase. What is the status here?\n\n* Is it still relevant?  Please solve the conflicts to make it ready for review and to ensure the CI passes.\n* Is it no longer relevant?  Please close.\n* Did the author lose interest or time to work on this?  Please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\n",
      "created_at" : "2023-12-18T00:37:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1859351934",
      "id" : 1859351934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585u03V-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1859351934/reactions"
      },
      "updated_at" : "2023-12-18T00:37:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1859351934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not intended for merge. Not planning on rebasing right now since this should be built on top of cluster mempool and other WIP projects.",
      "created_at" : "2023-12-18T09:45:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1859954716",
      "id" : 1859954716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585u3Kgc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1859954716/reactions"
      },
      "updated_at" : "2023-12-18T09:45:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1859954716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--13523179cfe9479db18ec6c5d236f789-->\n There hasn't been much activity lately and the patch still needs rebase. What is the status here?\n\n* Is it still relevant?  Please solve the conflicts to make it ready for review and to ensure the CI passes.\n* Is it no longer relevant?  Please close.\n* Did the author lose interest or time to work on this?  Please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\n",
      "created_at" : "2024-03-16T00:09:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-2000729346",
      "id" : 2000729346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII5853QLUC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2000729346/reactions"
      },
      "updated_at" : "2024-03-16T00:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2000729346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
