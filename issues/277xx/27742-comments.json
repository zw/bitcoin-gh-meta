[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27675](https://github.com/bitcoin/bitcoin/pull/27675) (net_processing: Drop m_recently_announced_invs bloom filter by ajtowns)\n* [#27596](https://github.com/bitcoin/bitcoin/pull/27596) (assumeutxo (2) by jamesob)\n* [#27509](https://github.com/bitcoin/bitcoin/pull/27509) (Relay own transactions only via short-lived Tor or I2P connections by vasild)\n* [#27499](https://github.com/bitcoin/bitcoin/pull/27499) (net processing, refactor: Decouple PeerManager from gArgs by dergoegge)\n* [#27385](https://github.com/bitcoin/bitcoin/pull/27385) (net, refactor: extract Network and BIP155Network logic to node/network by jonatack)\n* [#26697](https://github.com/bitcoin/bitcoin/pull/26697) (logging: use bitset for categories by LarryRuane)\n* [#26621](https://github.com/bitcoin/bitcoin/pull/26621) (refactor: Continue moving application data from CNode to Peer by dergoegge)\n* [#26451](https://github.com/bitcoin/bitcoin/pull/26451) (Enforce incentive compatibility for all RBF replacements by sdaftuar)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n* [#25268](https://github.com/bitcoin/bitcoin/pull/25268) (refactor: Introduce EvictionManager by dergoegge)\n* [#20892](https://github.com/bitcoin/bitcoin/pull/20892) (tests: Run both descriptor and legacy tests within a single test invocation by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-24T15:38:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1561395468",
      "id" : 1561395468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dEQEM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561395468/reactions"
      },
      "updated_at" : "2023-06-01T14:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561395468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210641158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210641158"
         }
      },
      "author_association" : "MEMBER",
      "body" : "or what?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T18:06:43Z",
      "diff_hunk" : "@@ -24,6 +24,44 @@ class TxPackageTracker::Impl {\n     TxOrphanage m_orphanage;\n \n     mutable Mutex m_mutex;\n+    struct RegistrationState {\n+        // All of the following bools will need to be true",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210641158",
      "id" : 1210641158,
      "line" : 40,
      "node_id" : "PRRC_kwDOABII585IKOsG",
      "original_commit_id" : "692e4baa4bc5d1198672b083f0de214575306477",
      "original_line" : 40,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 40,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210641158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210641158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210682865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210682865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[[txorphange] use wtxid instead of txid, handle nullptr](https://github.com/bitcoin/bitcoin/pull/27742/commits/22e93f08a50a206b54717b07682e73a751cc6755)\r\n\r\nmaybe change commit message to be clearer we're erasing by wtxid, as the primary change?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T18:41:30Z",
      "diff_hunk" : "@@ -2932,7 +2932,7 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n             LogPrint(BCLog::MEMPOOL, \"   accepted orphan tx %s\\n\", orphanHash.ToString());\n             RelayTransaction(orphanHash, porphanTx->GetWitnessHash());\n             m_txpackagetracker->AddChildrenToWorkSet(*porphanTx);\n-            m_txpackagetracker->EraseOrphanTx(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210682865",
      "id" : 1210682865,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IKY3x",
      "original_commit_id" : "22e93f08a50a206b54717b07682e73a751cc6755",
      "original_line" : 2935,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210682865/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210682865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210707099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210707099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "wouldn't reference it in case it drifts? If it's exactly the same and always should be, just use this constant value?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:04:20Z",
      "diff_hunk" : "@@ -4,12 +4,33 @@\n \n #include <node/txpackagetracker.h>\n \n+#include <common/bloom.h>\n+#include <logging.h>\n #include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n \n namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210707099",
      "id" : 1210707099,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585IKeyb",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 16,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 16,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210707099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210707099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210708748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210708748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> is_wtxid\r\n\r\nwhere is this defined?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:06:19Z",
      "diff_hunk" : "@@ -4,12 +4,33 @@\n \n #include <node/txpackagetracker.h>\n \n+#include <common/bloom.h>\n+#include <logging.h>\n #include <txorphanage.h>\n+#include <txrequest.h>\n+#include <util/hasher.h>\n \n namespace node {\n+    /** How long to wait before requesting orphan ancpkginfo/parents from an additional peer.\n+     * Same as GETDATA_TX_INTERVAL. */\n+    static constexpr auto ORPHAN_ANCESTOR_GETDATA_INTERVAL{60s};\n+\n+    /** Delay to add if an orphan resolution candidate is already using a lot of memory in the\n+     * orphanage. */\n+    static constexpr auto ORPHANAGE_OVERLOAD_DELAY{2s};\n+\n class TxPackageTracker::Impl {\n     /** Manages unvalidated tx data (orphan transactions for which we are downloading ancestors). */\n     TxOrphanage m_orphanage;\n+\n+    mutable Mutex m_mutex;\n+\n+    /** Tracks orphans for which we need to request ancestor information. All hashes stored are\n+     * wtxids, i.e., the wtxid of the orphan. However, the is_wtxid field is used to indicate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210708748",
      "id" : 1210708748,
      "line" : 163,
      "node_id" : "PRRC_kwDOABII585IKfMM",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 163,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 163,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210708748/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210708748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210724340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210724340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "really close to `OrphanageAddTx` even though the comments are clear of its purpose here. Maybe `AddKnownOrphanTx` or `AddAlreadyKnownOrphanTx`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:21:23Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210724340",
      "id" : 1210724340,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585IKi_0",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 78,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 78,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210724340/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210724340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210729694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210729694"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`is_wtxid=false`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:26:05Z",
      "diff_hunk" : "@@ -18,14 +39,119 @@ class TxPackageTracker::Impl {\n     bool OrphanageHaveTx(const GenTxid& gtxid) { return m_orphanage.HaveTx(gtxid); }\n     CTransactionRef GetTxToReconsider(NodeId peer) { return m_orphanage.GetTxToReconsider(peer); }\n     int EraseOrphanTx(const uint256& txid) { return m_orphanage.EraseTx(txid); }\n-    void DisconnectedPeer(NodeId peer) {\n-        m_orphanage.EraseForPeer(peer);\n+    void DisconnectedPeer(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        orphan_request_tracker.DisconnectedPeer(nodeid);\n+        m_orphanage.EraseForPeer(nodeid);\n+    }\n+    void BlockConnected(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        const auto wtxids_erased{m_orphanage.EraseForBlock(block)};\n+        std::set<uint256> block_wtxids;\n+        std::set<uint256> conflicted_wtxids;\n+        for (const CTransactionRef& ptx : block.vtx) {\n+            block_wtxids.insert(ptx->GetWitnessHash());\n+        }\n+        for (const auto& wtxid : wtxids_erased) {\n+            if (block_wtxids.count(wtxid) == 0) {\n+                conflicted_wtxids.insert(wtxid);\n+            }\n+        }\n+        FinalizeTransactions(block_wtxids, conflicted_wtxids);\n     }\n-    void BlockConnected(const CBlock& block) { m_orphanage.EraseForBlock(block); }\n     void LimitOrphans(unsigned int max_orphans) { m_orphanage.LimitOrphans(max_orphans); }\n     void AddChildrenToWorkSet(const CTransaction& tx) { m_orphanage.AddChildrenToWorkSet(tx); }\n     bool HaveTxToReconsider(NodeId peer) { return m_orphanage.HaveTxToReconsider(peer); }\n     size_t OrphanageSize() { return m_orphanage.Size(); }\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n+        if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+\n+        // Even though this stores the orphan wtxid, is_wtxid=false because we will be requesting the parents via txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210729694",
      "id" : 1210729694,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IKkTe",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 77,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : null,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210729694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210729694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210734976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210734976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "When should `tx` be `NULL`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:30:31Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210734976",
      "id" : 1210734976,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585IKlmA",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 78,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 78,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210734976/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210734976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210736698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210736698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What does this last sentence mean?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T19:32:29Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210736698",
      "id" : 1210736698,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585IKmA6",
      "original_commit_id" : "4c72113677bea9c722070c73471ca27087985a6b",
      "original_line" : 88,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 88,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210736698/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210736698",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210769183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210769183"
         }
      },
      "author_association" : "MEMBER",
      "body" : "where did this behavior live prior, where this isn't a behavior change?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-30T20:04:00Z",
      "diff_hunk" : "@@ -5860,6 +5859,18 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             }\n         }\n \n+        auto requestable_orphans = m_txpackagetracker->GetOrphanRequests(pto->GetId(), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1210769183",
      "id" : 1210769183,
      "line" : 6259,
      "node_id" : "PRRC_kwDOABII585IKt8f",
      "original_commit_id" : "bb5e0b21520e6deebcfe9576ae17f4db15c31421",
      "original_line" : 6259,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 862,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210769183/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210769183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211763570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "since we're touching this, would you mind annotating the bool as `/* best */` to make it clearer what this is doing? New to tx tracking; would be helpful",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T13:56:26Z",
      "diff_hunk" : "@@ -667,6 +678,21 @@ class TxRequestTracker::Impl {\n         });\n     }\n \n+    void ResetRequestTimeout(NodeId peer, const uint256& txhash, std::chrono::microseconds new_expiry)\n+    {\n+        auto it = m_index.get<ByPeer>().find(ByPeerView{peer, false, txhash});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211763570",
      "id" : 1211763570,
      "line" : 683,
      "node_id" : "PRRC_kwDOABII585IOgty",
      "original_commit_id" : "212a7010257b43eff9fa017bcf625acfc84f650f",
      "original_line" : 683,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 24,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763570/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211861912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211861912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason for the first?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T14:59:41Z",
      "diff_hunk" : "@@ -176,9 +207,13 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx)\n         const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n         if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n             for (const auto& elem : it_by_prev->second) {\n+                Assume(elem->second.announcers.size() >= 1);\n+                if (elem->second.announcers.empty()) break;\n+                // Pick the first peer from announcers set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211861912",
      "id" : 1211861912,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585IO4uY",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 212,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 210,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211861912/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211861912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211869199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211869199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should note that it only returns true if new",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T15:04:44Z",
      "diff_hunk" : "@@ -24,7 +24,7 @@ static constexpr size_t MAX_ORPHAN_TOTAL_SIZE{100 * MAX_STANDARD_TX_WEIGHT};\n  */\n class TxOrphanage {\n public:\n-    /** Add a new orphan transaction */\n+    /** Add a new orphan transaction. If the tx already exists, add this peer to its list of announcers. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211869199",
      "id" : 1211869199,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII585IO6gP",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 27,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 23,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211869199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211869199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211872666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211872666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can we `Assume` that there's already an entry in the announcer list?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T15:07:26Z",
      "diff_hunk" : "@@ -21,8 +21,14 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n     if (tx == nullptr) return false;\n \n     const uint256& hash = tx->GetHash();\n-    if (m_orphans.count(hash))\n+    if (m_orphans.count(hash)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1211872666",
      "id" : 1211872666,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585IO7Wa",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 24,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 16,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211872666/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211872666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212076537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212076537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How is this preferred precisely?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T17:41:23Z",
      "diff_hunk" : "@@ -1418,16 +1423,47 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n     }\n }\n \n-void PeerManagerImpl::AddOrphanResolutionCandidate(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& orphan, std::chrono::microseconds current_time)\n+void PeerManagerImpl::AddOrphanAnnouncer(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& tx, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main);\n+    AssertLockHeld(::cs_main); // For m_txrequest\n+    const bool connected = m_connman.ForNode(nodeid, [](CNode* node) { return node->fSuccessfullyConnected && !node->fDisconnect; });\n+    if (!connected) return;\n+    if (m_txpackagetracker->Count(nodeid) + m_txrequest.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) {\n+        // Too many queued announcements. Request from a different peer.\n+        // TODO: Allow peers with Relay permissions to bypass this restriction.\n+        return;\n+    }\n     const CNodeState* state = State(nodeid);\n-    // Decide the TxRequestTracker parameters for this orphan resolution:\n+    // Decide the TxRequestTracker parameters for this orphan resolution.\n+    // TxPackageTracker may also increase the delay.\n     // - \"preferred\": if fPreferredDownload is set (= outbound, or NetPermissionFlags::NoBan permission)\n-    // - \"reqtime\": current time\n+    // - \"reqtime\": current time plus delays for:\n+    //   - NONPREF_PEER_TX_DELAY for announcements from non-preferred connections\n+    //   - OVERLOADED_PEER_TX_DELAY for announcements from peers which have at least\n+    //     MAX_PEER_TX_REQUEST_IN_FLIGHT requests in flight\n+    //     TODO: allow peers with Relay permissions to bypass this restiction\n     auto delay{0us};\n     const bool preferred = state->fPreferredDownload;\n-    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, orphan, preferred, current_time + delay);\n+    if (!preferred) delay += NONPREF_PEER_TX_DELAY;\n+    const bool overloaded = m_txrequest.CountInFlight(nodeid) >= MAX_PEER_TX_REQUEST_IN_FLIGHT;\n+    if (overloaded) delay += OVERLOADED_PEER_TX_DELAY;\n+    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, tx, preferred, current_time + delay);\n+}\n+void PeerManagerImpl::AddOrphanResolutionCandidates(const CTransactionRef& orphan, NodeId originator)\n+{\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // The originator will not show up in GetCandidatePeers() since we already requested from them.\n+    AddOrphanAnnouncer(originator, orphan->GetWitnessHash(), orphan, current_time);\n+    // We prefer to request the orphan's ancestors via package relay rather than txids",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212076537",
      "id" : 1212076537,
      "line" : 1514,
      "node_id" : "PRRC_kwDOABII585IPtH5",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 1458,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 211,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212076537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212076537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212089989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212089989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this seems mutually exclusive with the above conditional since it implies `!fAlreadyHave`, make an `else if` to make it clearer?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T17:53:26Z",
      "diff_hunk" : "@@ -3748,6 +3784,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 if (!fAlreadyHave && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n                     AddTxAnnouncement(pfrom, gtxid, current_time);\n                 }\n+                if (inv.IsMsgWtx() && m_txpackagetracker->OrphanageHaveTx(gtxid) && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212089989",
      "id" : 1212089989,
      "line" : 3996,
      "node_id" : "PRRC_kwDOABII585IPwaF",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 3787,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 582,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212089989/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212089989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212101478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212101478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Double checking that this is a no-op if the peer is already one the list of announcers? These seem to be called quite a bit as you get new announcements.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T18:02:00Z",
      "diff_hunk" : "@@ -1418,16 +1423,47 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n     }\n }\n \n-void PeerManagerImpl::AddOrphanResolutionCandidate(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& orphan, std::chrono::microseconds current_time)\n+void PeerManagerImpl::AddOrphanAnnouncer(NodeId nodeid, const uint256& orphan_wtxid, const CTransactionRef& tx, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main);\n+    AssertLockHeld(::cs_main); // For m_txrequest\n+    const bool connected = m_connman.ForNode(nodeid, [](CNode* node) { return node->fSuccessfullyConnected && !node->fDisconnect; });\n+    if (!connected) return;\n+    if (m_txpackagetracker->Count(nodeid) + m_txrequest.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) {\n+        // Too many queued announcements. Request from a different peer.\n+        // TODO: Allow peers with Relay permissions to bypass this restriction.\n+        return;\n+    }\n     const CNodeState* state = State(nodeid);\n-    // Decide the TxRequestTracker parameters for this orphan resolution:\n+    // Decide the TxRequestTracker parameters for this orphan resolution.\n+    // TxPackageTracker may also increase the delay.\n     // - \"preferred\": if fPreferredDownload is set (= outbound, or NetPermissionFlags::NoBan permission)\n-    // - \"reqtime\": current time\n+    // - \"reqtime\": current time plus delays for:\n+    //   - NONPREF_PEER_TX_DELAY for announcements from non-preferred connections\n+    //   - OVERLOADED_PEER_TX_DELAY for announcements from peers which have at least\n+    //     MAX_PEER_TX_REQUEST_IN_FLIGHT requests in flight\n+    //     TODO: allow peers with Relay permissions to bypass this restiction\n     auto delay{0us};\n     const bool preferred = state->fPreferredDownload;\n-    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, orphan, preferred, current_time + delay);\n+    if (!preferred) delay += NONPREF_PEER_TX_DELAY;\n+    const bool overloaded = m_txrequest.CountInFlight(nodeid) >= MAX_PEER_TX_REQUEST_IN_FLIGHT;\n+    if (overloaded) delay += OVERLOADED_PEER_TX_DELAY;\n+    m_txpackagetracker->AddOrphanTx(nodeid, orphan_wtxid, tx, preferred, current_time + delay);\n+}\n+void PeerManagerImpl::AddOrphanResolutionCandidates(const CTransactionRef& orphan, NodeId originator)\n+{\n+    const auto current_time{GetTime<std::chrono::microseconds>()};\n+\n+    // The originator will not show up in GetCandidatePeers() since we already requested from them.\n+    AddOrphanAnnouncer(originator, orphan->GetWitnessHash(), orphan, current_time);\n+    // We prefer to request the orphan's ancestors via package relay rather than txids\n+    // of missing inputs. Also, if the first request fails, we should try again.\n+    // Get all peers that announced this transaction and prioritize accordingly...\n+    for (const auto nodeid : m_txrequest.GetCandidatePeers(orphan->GetWitnessHash())) {\n+        AddOrphanAnnouncer(nodeid, orphan->GetWitnessHash(), orphan, current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212101478",
      "id" : 1212101478,
      "line" : 1518,
      "node_id" : "PRRC_kwDOABII585IPzNm",
      "original_commit_id" : "0671e1c178270350aadeba625da8b95d6ef2ff00",
      "original_line" : 1462,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 215,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212101478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212101478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212157327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212157327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "end of*",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T18:46:14Z",
      "diff_hunk" : "@@ -294,3 +297,57 @@ std::vector<uint256> TxOrphanage::EraseForBlock(const CBlock& block)\n     }\n     return vOrphanErase;\n }\n+\n+void TxOrphanage::ProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already protected, increase its protection\n+    if (it->second->second.list_pos < 0) {\n+        it->second->second.list_pos -= 1;\n+        return;\n+    }\n+\n+    auto old_pos = it->second->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it->second);\n+    if (old_pos + 1 != static_cast<int32_t>(m_orphan_list.size())) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    // Set list_pos to -1 to indicate this orphan is protected.\n+    it->second->second.list_pos = -1;\n+}\n+\n+void TxOrphanage::UndoProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already not protected, nothing to do\n+    if (it->second->second.list_pos >= 0) {\n+        Assume(false);\n+        return;\n+    }\n+    // Protected by more than one peer. Remove one of the protections.\n+    if (it->second->second.list_pos < -1) {\n+        it->second->second.list_pos += 1;\n+        return;\n+    }\n+    // Add to the end or m_orphan_list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212157327",
      "id" : 1212157327,
      "line" : 343,
      "node_id" : "PRRC_kwDOABII585IQA2P",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 343,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 289,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212157327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212157327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212166925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212166925"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Say in comment the obvious \"protected by a single peer\" or add an `Assume` to that effect. Took me too long to figure this out even though it's obvious now.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-05-31T18:51:18Z",
      "diff_hunk" : "@@ -294,3 +297,57 @@ std::vector<uint256> TxOrphanage::EraseForBlock(const CBlock& block)\n     }\n     return vOrphanErase;\n }\n+\n+void TxOrphanage::ProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already protected, increase its protection\n+    if (it->second->second.list_pos < 0) {\n+        it->second->second.list_pos -= 1;\n+        return;\n+    }\n+\n+    auto old_pos = it->second->second.list_pos;\n+    assert(m_orphan_list[old_pos] == it->second);\n+    if (old_pos + 1 != static_cast<int32_t>(m_orphan_list.size())) {\n+        // Unless we're deleting the last entry in m_orphan_list, move the last\n+        // entry to the position we're deleting.\n+        auto it_last = m_orphan_list.back();\n+        m_orphan_list[old_pos] = it_last;\n+        it_last->second.list_pos = old_pos;\n+    }\n+    m_orphan_list.pop_back();\n+    // Set list_pos to -1 to indicate this orphan is protected.\n+    it->second->second.list_pos = -1;\n+}\n+\n+void TxOrphanage::UndoProtectOrphan(const uint256& wtxid)\n+{\n+    AssertLockNotHeld(m_mutex);\n+    LOCK(m_mutex);\n+    const auto it = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it == m_wtxid_to_orphan_it.end()) return;\n+    // Already not protected, nothing to do\n+    if (it->second->second.list_pos >= 0) {\n+        Assume(false);\n+        return;\n+    }\n+    // Protected by more than one peer. Remove one of the protections.\n+    if (it->second->second.list_pos < -1) {\n+        it->second->second.list_pos += 1;\n+        return;\n+    }\n+    // Add to the end or m_orphan_list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1212166925",
      "id" : 1212166925,
      "in_reply_to_id" : 1212157327,
      "line" : 343,
      "node_id" : "PRRC_kwDOABII585IQDMN",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 343,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 289,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212166925/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212166925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Approach review is very welcome on this PR\r\n\r\ndidn't real whole OP until now. In my not expert opinion, the orphan handling seems reasonable, and I think it makes to open it ASAP to take it out of draft",
      "created_at" : "2023-06-01T14:12:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1572135299",
      "id" : 1572135299,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dtOGD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572135299/reactions"
      },
      "updated_at" : "2023-06-01T14:12:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572135299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Offline feedback suggested I clarify what I mean by \"approach feedback welcome\" before \"I open separate PRs.\"\r\n\r\nThis is a large project, and the first few p2p commits essentially define the interface. I'd like to get rough consensus on approach before we start looking at code details and merging PRs, because I believe it will help us \"get useful stuff in\" faster and avoid premature optimizations.\r\n\r\nHere are some approach questions I think we should answer before diving in:\r\n1. Does the proposed protocol look sound?\r\n2. Are these 3 milestones appropriate?\r\n3. Is there important functionality that is in the \"todo improvements\" section but should be included in one of the 3 milestones? Alternatively, is there not-that-important stuff in the milestones that we should defer until later?\r\n4. Does it make sense to have this `PeerManager` <-> `TxPackageTracker` <-> `TxOrphanage` relationship?",
      "created_at" : "2023-06-01T14:51:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1572205313",
      "id" : 1572205313,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dtfMB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572205313/reactions"
      },
      "updated_at" : "2023-06-01T14:51:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572205313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> redownloading orphans if we cannot afford to protect them\r\n\r\nIs the idea here that protection is a bandiwdth optimization to avoid fetching an orphan twice in a row in the presence of malicious peers or random churn? Reasonable if so, just want this to be explicitly stated if so.",
      "created_at" : "2023-06-01T17:50:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1572526838",
      "id" : 1572526838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dutr2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572526838/reactions"
      },
      "updated_at" : "2023-06-01T17:51:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1572526838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213499613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213499613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note: if child is evicted, will we attempt to process the rest of the package? will likely fail due to fee reasons, maybe this is just bandwidth loss?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T17:59:10Z",
      "diff_hunk" : "@@ -256,12 +292,49 @@ class TxPackageTracker::Impl {\n             orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n         }\n \n-        if (tx != nullptr) {\n-            m_orphanage.AddTx(tx, nodeid);\n-        } else {\n-            m_orphanage.AddTx(m_orphanage.GetTx(wtxid), nodeid);\n-        }\n-\n+        m_orphanage.AddTx(ptx, nodeid);\n+        // Protection may or may not be possible. If the orphan is unprotected, it's possible it\n+        // will be evicted by the time we try to download ancestors. If we cannot protect now but",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213499613",
      "id" : 1213499613,
      "line" : 297,
      "node_id" : "PRRC_kwDOABII585IVIjd",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 297,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 297,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213499613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213499613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213504016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213504016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "re-use `orphan_size`",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:03:51Z",
      "diff_hunk" : "@@ -256,12 +292,49 @@ class TxPackageTracker::Impl {\n             orphan_request_tracker.ReceivedInv(nodeid, GenTxid::Txid(wtxid), is_preferred, reqtime);\n         }\n \n-        if (tx != nullptr) {\n-            m_orphanage.AddTx(tx, nodeid);\n-        } else {\n-            m_orphanage.AddTx(m_orphanage.GetTx(wtxid), nodeid);\n-        }\n-\n+        m_orphanage.AddTx(ptx, nodeid);\n+        // Protection may or may not be possible. If the orphan is unprotected, it's possible it\n+        // will be evicted by the time we try to download ancestors. If we cannot protect now but\n+        // still have it later, we will attempt to protect it again.\n+        MaybeProtectOrphan(nodeid, wtxid);\n+    }\n+    void MaybeProtectOrphan(NodeId nodeid, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex)\n+    {\n+        AssertLockHeld(m_mutex);\n+        auto peer_info_it = info_per_peer.find(nodeid);\n+        // Skip if this isn't a package relay peer.\n+        if (peer_info_it == info_per_peer.end()) return;\n+        const auto orphan_tx = m_orphanage.GetTx(wtxid);\n+        // Skip if the orphanage doesn't have this transaction.\n+        if (!orphan_tx) return;\n+        const auto orphan_size{orphan_tx->GetTotalSize()};\n+        // Skip if this peer is already protecting this orphan.\n+        if (peer_info_it->second.m_protected_orphan_map.count(wtxid) > 0) return;\n+        // Skip if this peer is already protecting too many orphans.\n+        if (peer_info_it->second.AvailableProtectionTokens() < orphan_size) return;\n+\n+        // Protect this orphan.\n+        LogPrint(BCLog::TXPACKAGES, \"\\nProtecting orphan %s for peer=%d\\n\", wtxid.ToString(), nodeid);\n+        m_orphanage.ProtectOrphan(wtxid);\n+        peer_info_it->second.m_protected_orphans_size += orphan_tx->GetTotalSize();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213504016",
      "id" : 1213504016,
      "line" : 319,
      "node_id" : "PRRC_kwDOABII585IVJoQ",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 319,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 319,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213504016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213504016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213509093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213509093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "make it clear that all these units are in serialized transaction bytes, not WU or vsize.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:09:19Z",
      "diff_hunk" : "@@ -16,10 +16,21 @@ namespace node {\n      * Same as GETDATA_TX_INTERVAL. */\n     static constexpr auto ORPHAN_ANCESTOR_GETDATA_INTERVAL{60s};\n \n-    /** Delay to add if an orphan resolution candidate is already using a lot of memory in the\n+    /** Delay to add if an orphan resolution candidate is protecting a lot of memory in the\n      * orphanage. */\n     static constexpr auto ORPHANAGE_OVERLOAD_DELAY{1s};\n \n+    /** Maximum amount of orphans we may protect for an inbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. */\n+    static constexpr size_t MAX_ORPHANAGE_PROTECTION_INBOUND{50000};\n+    /** Maximum amount of orphans we may protect for an outbound peer when they first connect.\n+     * The number of \"protection tokens\" an inbound peer starts with. Equal to one maximum-size orphan. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213509093",
      "id" : 1213509093,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII585IVK3l",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 27,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 27,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213509093/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213509093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213527350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213527350"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`BytesFromPeer` counts all announced orphans, even if duplicates, correct?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:26:51Z",
      "diff_hunk" : "@@ -241,12 +267,22 @@ class TxPackageTracker::Impl {\n         LOCK(m_mutex);\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+        CTransactionRef ptx = tx ? tx : m_orphanage.GetTx(wtxid);\n \n         // Skip if already requested in the (recent-ish) past.\n         if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n \n+        // Skip if this peer is already using a lot of space in the orphanage.\n+        if (m_orphanage.BytesFromPeer(nodeid) > MAX_ORPHANAGE_USAGE) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213527350",
      "id" : 1213527350,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585IVPU2",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 276,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 276,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213527350/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213527350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213537090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213537090"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what is the conditional guarding against?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:37:53Z",
      "diff_hunk" : "@@ -303,6 +376,9 @@ class TxPackageTracker::Impl {\n             auto pending_iter = pending_package_info.find(packageid);\n             Assume(pending_iter != pending_package_info.end());\n             if (pending_iter != pending_package_info.end()) {\n+                for (const auto& [wtxid, missing] : pending_iter->second.m_txdata_status) {\n+                    if (!missing) MaybeUnprotectOrphan(nodeid, wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213537090",
      "id" : 1213537090,
      "line" : 380,
      "node_id" : "PRRC_kwDOABII585IVRtC",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 380,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 380,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213537090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213537090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213551414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213551414"
         }
      },
      "author_association" : "MEMBER",
      "body" : "also, think we should use the new orphan tx size as well here to avoid going past MAX_ORPHANAGE_USAGE?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T18:53:28Z",
      "diff_hunk" : "@@ -241,12 +267,22 @@ class TxPackageTracker::Impl {\n         LOCK(m_mutex);\n         // Skip if we weren't provided the tx and can't find the wtxid in the orphanage.\n         if (tx == nullptr && !m_orphanage.HaveTx(GenTxid::Wtxid(wtxid))) return;\n+        CTransactionRef ptx = tx ? tx : m_orphanage.GetTx(wtxid);\n \n         // Skip if already requested in the (recent-ish) past.\n         if (packageinfo_requested.contains(GetPackageInfoRequestId(nodeid, wtxid, PKG_RELAY_ANCPKG))) return;\n \n+        // Skip if this peer is already using a lot of space in the orphanage.\n+        if (m_orphanage.BytesFromPeer(nodeid) > MAX_ORPHANAGE_USAGE) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213551414",
      "id" : 1213551414,
      "in_reply_to_id" : 1213527350,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585IVVM2",
      "original_commit_id" : "d76bb9dbb85d840df36f6b73fb84a2e58ada8433",
      "original_line" : 276,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.cpp",
      "position" : 276,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213551414/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213551414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213639103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213639103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_orphan_list` seems more aptly named `m_unprotected_orphan_list` after this",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T20:19:34Z",
      "diff_hunk" : "@@ -188,7 +191,7 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n         if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n     }\n     FastRandomContext rng;\n-    while (m_orphans.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)\n+    while (m_orphan_list.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213639103",
      "id" : 1213639103,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII585IVqm_",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 194,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 191,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213639103/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213639103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213640730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213640730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we connect to enough peers and protect transactions beyond `MAX_ORPHAN_TOTAL_SIZE`, this will result in an assert with randrange arg of 0 once m_orphan_list is empty? Should either check m_orphan_list is non-empty, or only count non-protected bytes with `m_total_unprotected_orphan_bytes`?\r\n\r\n",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T20:21:34Z",
      "diff_hunk" : "@@ -188,7 +191,7 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n         if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n     }\n     FastRandomContext rng;\n-    while (m_orphans.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)\n+    while (m_orphan_list.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213640730",
      "id" : 1213640730,
      "in_reply_to_id" : 1213639103,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII585IVrAa",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 194,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 191,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213640730/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213640730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213651441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213651441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "rename arg `max_unprotected_orphans`?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-01T20:33:43Z",
      "diff_hunk" : "@@ -50,7 +50,12 @@ class TxOrphanage {\n     /** Erase all orphans included in or invalidated by a new block. Returns wtxids of erased txns. */\n     std::vector<uint256> EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Limit the orphanage to the given maximum */\n+    /** Limit the orphanage to the given maximum. Delete orphans whose expiry has been reached.\n+     * The maximum does not apply to protected transactions, i.e., LimitOrphans(100) ensures\n+     * that the number of non-protected orphan entries does not exceed 100. Afterward, Size() may\n+     * return a number greater than 100.  It is the caller's responsibility to ensure that not too\n+     * many orphans are protected.\n+     */\n     void LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1213651441",
      "id" : 1213651441,
      "line" : 59,
      "node_id" : "PRRC_kwDOABII585IVtnx",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 59,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 58,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213651441/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1213651441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > redownloading orphans if we cannot afford to protect them\r\n> \r\n> Is the idea here that protection is a bandiwdth optimization to avoid fetching an orphan twice in a row in the presence of malicious peers or random churn? Reasonable if so, just want this to be explicitly stated if so.\r\n\r\nYes exactly. Worse is we want to avoid a situation where we requested the rest of the package while the orphan was in our orphanage, but then it fell out while we were waiting for the rest of the transactions. Then, we should re-download the orphan, but what do we do with the rest of them? We basically have to redownload the whole thing again, otherwise we might end up in an endless cycle of redownloading if we put them into an orphanage but don't necessarily protect them from eviction.\r\n\r\nHere is a more detailed doc for the orphanage protection and \"token bucket\" scheme: https://gist.github.com/glozow/7c0ff639f996e660146314edffa6f06c.",
      "created_at" : "2023-06-02T10:38:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#issuecomment-1573521731",
      "id" : 1573521731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27742",
      "node_id" : "IC_kwDOABII585dyglD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573521731/reactions"
      },
      "updated_at" : "2023-06-02T10:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573521731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214465487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214465487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should this function ever be called with a protected orphan? Tests don't cover these lines for protected peers(added an assert, never hit), and seems suspect that it would delete things below this block if it's protected.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:38:20Z",
      "diff_hunk" : "@@ -74,21 +99,43 @@ int TxOrphanage::_EraseTx(const uint256& txid)\n             m_outpoint_to_orphan_it.erase(itPrev);\n     }\n \n-    size_t old_pos = it->second.list_pos;\n-    assert(m_orphan_list[old_pos] == it);\n-    if (old_pos + 1 != m_orphan_list.size()) {\n-        // Unless we're deleting the last entry in m_orphan_list, move the last\n-        // entry to the position we're deleting.\n-        auto it_last = m_orphan_list.back();\n-        m_orphan_list[old_pos] = it_last;\n-        it_last->second.list_pos = old_pos;\n+    if (it->second.list_pos >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214465487",
      "id" : 1214465487,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IY0XP",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 102,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 103,
      "pull_request_review_id" : 1451533873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214465487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214465487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214484568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214484568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Should this function ever be called with a protected orphan?\r\n\r\nYes. It's called when orphans expire as well.\r\n\r\n> Tests don't cover these lines for protected peers\r\n\r\nSounds like I neglected to write a test for this. Expiry is pretty long, but theoretically we can hit this if we have multiple peers stalling us on the resolution of this orphan. We might happen to be trying package relay with one of the peers when the expiration is reached.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:55:32Z",
      "diff_hunk" : "@@ -74,21 +99,43 @@ int TxOrphanage::_EraseTx(const uint256& txid)\n             m_outpoint_to_orphan_it.erase(itPrev);\n     }\n \n-    size_t old_pos = it->second.list_pos;\n-    assert(m_orphan_list[old_pos] == it);\n-    if (old_pos + 1 != m_orphan_list.size()) {\n-        // Unless we're deleting the last entry in m_orphan_list, move the last\n-        // entry to the position we're deleting.\n-        auto it_last = m_orphan_list.back();\n-        m_orphan_list[old_pos] = it_last;\n-        it_last->second.list_pos = old_pos;\n+    if (it->second.list_pos >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214484568",
      "id" : 1214484568,
      "in_reply_to_id" : 1214465487,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IY5BY",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 102,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 103,
      "pull_request_review_id" : 1457714296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214484568/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:55:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214484568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214486019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214486019"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah! Didn't put 2 and 2 together. Comment-worthy",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:56:53Z",
      "diff_hunk" : "@@ -74,21 +99,43 @@ int TxOrphanage::_EraseTx(const uint256& txid)\n             m_outpoint_to_orphan_it.erase(itPrev);\n     }\n \n-    size_t old_pos = it->second.list_pos;\n-    assert(m_orphan_list[old_pos] == it);\n-    if (old_pos + 1 != m_orphan_list.size()) {\n-        // Unless we're deleting the last entry in m_orphan_list, move the last\n-        // entry to the position we're deleting.\n-        auto it_last = m_orphan_list.back();\n-        m_orphan_list[old_pos] = it_last;\n-        it_last->second.list_pos = old_pos;\n+    if (it->second.list_pos >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214486019",
      "id" : 1214486019,
      "in_reply_to_id" : 1214465487,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IY5YD",
      "original_commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "original_line" : 102,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 103,
      "pull_request_review_id" : 1457717975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214486019/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:56:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214486019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214489207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214489207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah yes, that's a bug! This `while` condition is very strange since one part applies to the unprotected orphanage and the other applies to the total orphanage. I think we should change the second condition to be on `m_total_unprotected_orphan_bytes`, yes.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T14:59:44Z",
      "diff_hunk" : "@@ -188,7 +191,7 @@ void TxOrphanage::LimitOrphans(unsigned int max_orphans)\n         if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n     }\n     FastRandomContext rng;\n-    while (m_orphans.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)\n+    while (m_orphan_list.size() > max_orphans || m_total_orphan_bytes > MAX_ORPHAN_TOTAL_SIZE)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214489207",
      "id" : 1214489207,
      "in_reply_to_id" : 1213639103,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII585IY6J3",
      "original_commit_id" : "76c564761687eca898060998d60d6084b4ce361d",
      "original_line" : 194,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 191,
      "pull_request_review_id" : 1457726341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214489207/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T14:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214489207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214497418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214497418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Basically arbitrary. The relevance is basically which peer's message processing is blocked to process this, and would get a misbehaving score if the tx is invalid. Anyone who announced it is equally deserving of this burden imo. I suppose a more fair way to pick is uniformly randomly.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T15:07:28Z",
      "diff_hunk" : "@@ -176,9 +207,13 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx)\n         const auto it_by_prev = m_outpoint_to_orphan_it.find(COutPoint(tx.GetHash(), i));\n         if (it_by_prev != m_outpoint_to_orphan_it.end()) {\n             for (const auto& elem : it_by_prev->second) {\n+                Assume(elem->second.announcers.size() >= 1);\n+                if (elem->second.announcers.empty()) break;\n+                // Pick the first peer from announcers set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214497418",
      "id" : 1214497418,
      "in_reply_to_id" : 1211861912,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585IY8KK",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 212,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 210,
      "pull_request_review_id" : 1457748132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214497418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T15:07:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214497418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214696267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214696267"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this introduces an interdependency between the number of outgoing transaction bytes we can receive from a peer and the maximum flow of LN commitment transaction+CPFP in weight a direct transaction-relay peer can announce to us and therefore we can validate. An `option_anchors_zero_fee_htlc_tx` LN commitment transaction weight is 900 WU with no pending HTLCs. As the orphan memory usage is implemented, its unclear if there is any processing guarantees for a peer announcing transaction to us, such processing guarantees are hard to enforce as we would be dependent on the full-node host performance.\r\n\r\nNote current `MAX_ORPHANAGE_USAGE` is defined as `MAX_ORPHANAGE_USAGE{10*MAX_ORPHANAGE_PROTECTION_OUTBOUND}` though it sounds applied on processing inbound announcement (L276 in `src/node/txpackagetracker.cpp`).",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T18:42:45Z",
      "diff_hunk" : "@@ -72,6 +72,13 @@ class TxOrphanage {\n         LOCK(m_mutex);\n         return m_total_orphan_bytes;\n     }\n+    size_t BytesFromPeer(NodeId peer) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214696267",
      "id" : 1214696267,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585IZstL",
      "original_commit_id" : "986f7622dabd422d6dc21bfc3319a0d04d4c4ecc",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 83,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214696267/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214696267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214712117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214712117"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There is a argument that can be made if memory and throughputs limits (e.g `MAX_PEER_ANNOUNCEMENTS`) are applied in function of the type of transactions received (e.g v3 transactions) and that can be used to nudge multi-party and contracting protocols transactions broadcasters to use fee-bumping efficient mechanism such as one CPFP covering multiple parents due to the package limits. This would be a discount incentive by analogy with SegWit spending discounted by consensus validation rules.\r\n\r\nOn the other hand, such incentive might have bad incentives as such package topology might be unsafe (i.e if all the parents confirmation are time-sensitive) and this can become a further complication of our transaction-relay stack.\r\n\r\nThere is still a last open question if such lack of dissociation between type of traffic (e.g packages from simple transactions) could be abused when package validation is deployed, and CPU performance processing asymmetries (i.e `AcceptSingleTransaction` vs `AcceptMultipleTransactions` vs `AcceptPackageWrappingSingle` vs `AcceptAncestorPackage`) between our code paths could be exploited by a transaction-relay jamming adversary.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T18:57:00Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214712117",
      "id" : 1214712117,
      "line" : 74,
      "node_id" : "PRRC_kwDOABII585IZwk1",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 63,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 74,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214712117/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214712117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214720397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214720397"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If I understand correctly the rate-limiting accounting introduced here, whatever the number of orphan parent missing, there will be an in-flight orphan parent requests issued (i.e if were missing 10 parents, were going to issue 10 in-flight orphan parent requests).\r\n\r\nI think this should be documented as multi-party applications and contracting protocols transactions issuers might have to assemble their packages in function.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:03:32Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214720397",
      "id" : 1214720397,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585IZymN",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 70,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 81,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214720397/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214720397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214728153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214728153"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is unclear what level of enforcement is granted to a final decision, if the transactions are added to any transaction-relay download filters such as `m_recent_rejects` or `m_recently_announced_invs`. Otherwise, in case of blocks re-orgs dropping out the first package component and a second package component still stuck in filters, this can be source of package propagation failure.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:10:09Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing\n+     * parents were requested), package info requests, tx data download, and packages in the\n+     * validation queue. */\n+    size_t Count(NodeId nodeid) const;\n+\n+    /** Number of packages we are currently working on with this peer (i.e. reserving memory for\n+     * storing orphan(s)). Includes in-flight package info requests, tx data download, and packages\n+     * in the validation queue. Excludes entries in the orphan tracker that are just candidates. */\n+    size_t CountInFlight(NodeId nodeid) const;\n+\n+    /** Get list of requests that should be sent to resolve orphans. These may be wtxids to send\n+     * getdata(ANCPKGINFO) or txids corresponding to parents. Automatically marks the orphans as\n+     * having outgoing requests. */\n+    std::vector<GenTxid> GetOrphanRequests(NodeId nodeid, std::chrono::microseconds current_time);\n+\n+    /** Update transactions for which we have made \"final\" decisions: transactions that have\n+     * confirmed in a block, conflicted due to a block, or added to the mempool already.\n+     * Should be called on new block: valid=block transactions, invalid=conflicts.\n+     * Should be called when tx is added to mempool.\n+     * Should not be called when a tx fails validation.\n+     * */\n+    void FinalizeTransactions(const std::set<uint256>& valid, const std::set<uint256>& invalid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214728153",
      "id" : 1214728153,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585IZ0fZ",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 91,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 102,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214728153/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214728153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214732393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214732393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think there can be a source of concerns if all the announced orphans are second components from a single common parent. All our peers would announce those second-stage components, only one of them will succeed in the mempool validation and other will be refused as conflicts, I think.",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:14:42Z",
      "diff_hunk" : "@@ -43,7 +43,8 @@ class TxOrphanage {\n     /** Erase an orphan by wtxid */\n     int EraseTx(const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n+    /** Maybe erase all orphans announced by a peer (eg, after that peer disconnects). If an orphan",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214732393",
      "id" : 1214732393,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585IZ1hp",
      "original_commit_id" : "fecb522a3fa83e7b485f5d17f070ed56d47e3d90",
      "original_line" : 46,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 42,
      "pull_request_review_id" : 1458284571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214732393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214732393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214751567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214751567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Orphan usage would effect the CPFP transactions, IIUC, not the commitment transactions. The CPFP is deemed high enough, sent to the peer, the peer holds the child tx in orphan set and requests the full package, which isn't size-bound(beyond current mempool limits).",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-02T19:34:01Z",
      "diff_hunk" : "@@ -72,6 +72,13 @@ class TxOrphanage {\n         LOCK(m_mutex);\n         return m_total_orphan_bytes;\n     }\n+    size_t BytesFromPeer(NodeId peer) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1214751567",
      "id" : 1214751567,
      "in_reply_to_id" : 1214696267,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585IZ6NP",
      "original_commit_id" : "986f7622dabd422d6dc21bfc3319a0d04d4c4ecc",
      "original_line" : 75,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 83,
      "pull_request_review_id" : 1458376374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214751567/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-02T19:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1214751567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1218144248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218144248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC\r\n\r\ntotal number of inflights doesn't appear to be changed here, it's still `MAX_PEER_TX_ANNOUNCEMENTS`\r\n\r\nIf the protected buckets are taken by attackers, an honest party can still insert an orphan into the unprotected bucket(under the MAX_PEER_TX_ANNOUNCEMENTS limit), and the whole package including the child should get fetched after a short delay.\r\n\r\nSo from a time-sensitive contract perspective, things should be strictly better than today?",
      "commit_id" : "cdb5b163d623db802ed7f8a3394b2674362f409b",
      "created_at" : "2023-06-05T14:19:36Z",
      "diff_hunk" : "@@ -58,6 +59,36 @@ class TxPackageTracker {\n     /** Return how many entries exist in the orphange */\n     size_t OrphanageSize();\n \n+    /** Received an announcement from this peer for a tx we already know is an orphan; should be\n+     * called for every peer that announces the tx, even if they are not a package relay peer.\n+     * The orphan request tracker will decide when to request what from which peer - use\n+     * GetOrphanRequests().\n+     */\n+    void AddOrphanTx(NodeId nodeid, const uint256& wtxid, const CTransactionRef& tx, bool is_preferred, std::chrono::microseconds reqtime);\n+\n+    /** Number of packages we are working on with this peer. Includes any entries in the orphan\n+     * tracker, in-flight orphan parent requests (1 per orphan regardless of how many missing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27742#discussion_r1218144248",
      "id" : 1218144248,
      "in_reply_to_id" : 1214720397,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585Im2f4",
      "original_commit_id" : "1c13f6465c170639465990e38a188193c036648c",
      "original_line" : 70,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/txpackagetracker.h",
      "position" : 81,
      "pull_request_review_id" : 1462664683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218144248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-05T14:19:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218144248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
