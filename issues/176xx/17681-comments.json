[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18923 (wallet: Never schedule MaybeCompactWalletDB when -flushwallet is off by MarcoFalke)\n* #18354 (Protect wallet by using shared pointers by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-12-05T22:21:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-562345098",
      "id" : 562345098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MjM0NTA5OA==",
      "updated_at" : "2020-05-20T01:59:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562345098",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111113"
         }
      },
      "author_association" : "NONE",
      "body" : "should `index` and `internal` be made `const` too? ",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-07T09:22:41Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111113",
      "id" : 355111113,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMTExMw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 283,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111113",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111471"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111471"
         }
      },
      "author_association" : "NONE",
      "body" : "Documentation for the function would be nice, whether here or in the header file. What does this function do? What does the return value mean?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-07T09:29:58Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111471",
      "id" : 355111471,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMTQ3MQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 283,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111471",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111542"
         }
      },
      "author_association" : "NONE",
      "body" : "`const`? Seems like this isn't be modified later in the function",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-07T09:31:26Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111542",
      "id" : 355111542,
      "line" : 307,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMTU0Mg==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 307,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 25,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111542",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112025"
         }
      },
      "author_association" : "NONE",
      "body" : "should the type on the left hand side be `int64_t`? It seems `GetArg` returns that type and you're casting `0` to that type too: https://github.com/bitcoin/bitcoin/blob/23cecd6cd56f952c757f469c46d7593c2ffaa419/src/util/system.h#L234",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-07T09:40:37Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112025",
      "id" : 355112025,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMjAyNQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 292,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112025",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112076"
         }
      },
      "author_association" : "NONE",
      "body" : "`(int64_t) 0` is used twice now, should it be made into a constant?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-07T09:42:06Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112076",
      "id" : 355112076,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMjA3Ng==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 317,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112076",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112156"
         }
      },
      "author_association" : "NONE",
      "body" : "is this missing a termination condition?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-07T09:44:10Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i--;)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112156",
      "id" : 355112156,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMjE1Ng==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 303,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112156",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170609"
         }
      },
      "author_association" : "NONE",
      "body" : "sanity check: should this be `hdChain` or `chain`?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T09:03:09Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170609",
      "id" : 355170609,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE3MDYwOQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 796,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170609",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170663"
         }
      },
      "author_association" : "NONE",
      "body" : "should we check if `chain.seed_id` is null here? ",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T09:04:15Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);\n+    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteInactiveHDChain(chain))\n+        throw std::runtime_error(std::string(__func__) + \": writing inactive chain failed\");\n+\n+    m_inactive_hd_chains[chain.seed_id] = chain;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170663",
      "id" : 355170663,
      "line" : 917,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE3MDY2Mw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 917,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 120,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170663",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355171237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355171237"
         }
      },
      "author_association" : "NONE",
      "body" : "I'm new to Bitcoin and I'm still learning the testing standards - should there be a test where this exception is expected to be thrown?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T09:12:33Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355171237",
      "id" : 355171237,
      "line" : 901,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE3MTIzNw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 901,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 103,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355171237",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No. This is only expected to be thrown under corruption and/or hardware failure conditions.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T16:56:33Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199686",
      "id" : 355199686,
      "in_reply_to_id" : 355171237,
      "line" : 901,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE5OTY4Ng==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 901,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 103,
      "pull_request_review_id" : 328620017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199686",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199870"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it really matters. They are not references and are primitives.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T16:59:21Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199870",
      "id" : 355199870,
      "in_reply_to_id" : 355111113,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE5OTg3MA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 283,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328620165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199870",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`GenerateNewKey` modifies it.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T17:04:27Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200192",
      "id" : 355200192,
      "in_reply_to_id" : 355111542,
      "line" : 307,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMDE5Mg==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 307,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 25,
      "pull_request_review_id" : 328620430,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200192",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's worth it.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T17:05:01Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200227",
      "id" : 355200227,
      "in_reply_to_id" : 355112076,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMDIyNw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 317,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328620464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200227",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200722"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is supposed to be `hdChain`.\r\n\r\n`SetHDChain` happens when we change `hdChain`. We want to store what is currently `hdChain` as an inactive seed before we switch it out for the new one. So this is correct, we add it as an inactive chain before it is set to the new `chain`.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T17:12:53Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200722",
      "id" : 355200722,
      "in_reply_to_id" : 355170609,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMDcyMg==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 796,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328620840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200722",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T18:00:50Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203595",
      "id" : 355203595,
      "in_reply_to_id" : 355111471,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzU5NQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 283,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328623013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203595",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T18:00:55Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203600",
      "id" : 355203600,
      "in_reply_to_id" : 355112025,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzYwMA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 292,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328623021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203600",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I copied this out of TopUp and technically this is correct. But it's hard to read and reason about, so I've changed it to the standard way of doing for loops.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T18:01:18Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i--;)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203638",
      "id" : 355203638,
      "in_reply_to_id" : 355112156,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzYzOA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 303,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328623064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203638",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It should never be null. I've added an assert to check that.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-08T18:01:35Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);\n+    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteInactiveHDChain(chain))\n+        throw std::runtime_error(std::string(__func__) + \": writing inactive chain failed\");\n+\n+    m_inactive_hd_chains[chain.seed_id] = chain;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203648",
      "id" : 355203648,
      "in_reply_to_id" : 355170663,
      "line" : 917,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzY0OA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 917,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 120,
      "pull_request_review_id" : 328623077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203648",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Found a few bugs where the wrong CHDChain was being used/updated/written. Should be fixed now.",
      "created_at" : "2019-12-08T18:02:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-562975226",
      "id" : 562975226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2Mjk3NTIyNg==",
      "updated_at" : "2019-12-08T18:02:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562975226",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355716017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355716017"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is needed to take lock again? Can't you `AssertLockHeld` and `EXCLUSIVE_LOCKREQUIRED` instead?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-09T22:17:38Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355716017",
      "id" : 355716017,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTcxNjAxNw==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_line" : 749,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329329202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355716017",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355717884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355717884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pass `memonly`? (even if value is always `false` for now)",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-09T22:22:02Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355717884",
      "id" : 355717884,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTcxNzg4NA==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_line" : 740,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329329202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355717884",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-09T23:17:31Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738392",
      "id" : 355738392,
      "in_reply_to_id" : 355716017,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTczODM5Mg==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_line" : 749,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329432291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738392",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-09T23:17:36Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738422",
      "id" : 355738422,
      "in_reply_to_id" : 355717884,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTczODQyMg==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_line" : 740,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329432447,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738422",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 after thoughts, I was thinking of the case where we have initial keypool=1000, we create a wallet backup B1 at block N, then we exhaust keypool until reaching index 1100, none of the address in the range 0 to 1000 are confirmed on chain, address index 1100 get confirmed at block N+10000. We restore wallet backup B1 and rescan from N until N+10000, wallet is not going to see address index 1100 because we only advance look-ahead key buffer when we detect an address in range 0 to 1000.\r\n\r\nThis scenario is really unlikely but it this current code behavior ? Just to be sure, if yes maybe comment of `CKeyPool` should be updated to avoid people setting to small `-keypool`.",
      "created_at" : "2019-12-10T02:31:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-563613452",
      "id" : 563613452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MzYxMzQ1Mg==",
      "updated_at" : "2019-12-10T02:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/563613452",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, such a scenario is possible and is unavoidable. The only thing that you can do is to have a large enough keypool (or gap limit as other wallets call it) where this is unlikely to happen. This is why the default `-keypool` was raised to 1000 from 100.",
      "created_at" : "2019-12-10T02:49:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-563636980",
      "id" : 563636980,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MzYzNjk4MA==",
      "updated_at" : "2019-12-10T02:49:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/563636980",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay thanks for answer, added a commit on top of your branch (https://github.com/ariard/bitcoin/commit/3c25ab7f36319cbe38d1fb65a321b1234635648e) to clarify the risk of losing funds by lowering the default keypool value. With the default value, this scenario is really unlikely, but we should inform as best user to avoid one of them removing the footgun protection by mistake.\r\n\r\nWe could also go further and return error at wallet init if -keypool < 100.",
      "created_at" : "2019-12-10T23:24:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564305888",
      "id" : 564305888,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDMwNTg4OA==",
      "updated_at" : "2019-12-10T23:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564305888",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think updating the docs about `-keypool` settings is out of scope for this PR.",
      "created_at" : "2019-12-11T01:48:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564340206",
      "id" : 564340206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDM0MDIwNg==",
      "updated_at" : "2019-12-11T01:48:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564340206",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "No worries I'll take it on its own. But on the raw idea, do you think it's pertinent to update the doc to inform user ?",
      "created_at" : "2019-12-11T03:49:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564367899",
      "id" : 564367899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDM2Nzg5OQ==",
      "updated_at" : "2019-12-11T03:49:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564367899",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, we should keep docs up to date with behavior.",
      "created_at" : "2019-12-11T03:54:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564368726",
      "id" : 564368726,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDM2ODcyNg==",
      "updated_at" : "2019-12-11T03:54:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564368726",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r361878437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/361878437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, above.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-29T23:21:00Z",
      "diff_hunk" : "@@ -275,6 +275,49 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r361878437",
      "id" : 361878437,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MTg3ODQzNw==",
      "original_commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "original_line" : 305,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 336980010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/361878437",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r362106027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362106027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2019-12-30T21:57:46Z",
      "diff_hunk" : "@@ -275,6 +275,49 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r362106027",
      "id" : 362106027,
      "in_reply_to_id" : 361878437,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjEwNjAyNw==",
      "original_commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "original_line" : 305,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 337250492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362106027",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-01-03T18:54:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-570663830",
      "id" : 570663830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MDY2MzgzMA==",
      "updated_at" : "2020-01-03T18:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/570663830",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Renamed it.",
      "created_at" : "2020-01-06T17:03:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-571221110",
      "id" : 571221110,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTIyMTExMA==",
      "updated_at" : "2020-01-06T17:03:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571221110",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nice work!\r\nConcept ACK.",
      "created_at" : "2020-01-09T05:26:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-572394058",
      "id" : 572394058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MjM5NDA1OA==",
      "updated_at" : "2020-01-09T05:26:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/572394058",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-01-30T06:07:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-580098250",
      "id" : 580098250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDA5ODI1MA==",
      "updated_at" : "2020-01-30T06:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580098250",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-01-30T15:54:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-580319326",
      "id" : 580319326,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDMxOTMyNg==",
      "updated_at" : "2020-01-30T15:54:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580319326",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Travis is tripping over some lock issue. As is macOS with `--enable-debug`:\r\n```\r\nwallet/walletdb.cpp:399:58: error: calling function 'AddInactiveHDChain' requires holding mutex 'pwallet->GetOrCreateLegacyScriptPubKeyMan().cs_KeyStore' exclusively [-Werror,-Wthread-safety-analysis]\r\n            pwallet->GetOrCreateLegacyScriptPubKeyMan()->AddInactiveHDChain(chain, true);\r\n```",
      "created_at" : "2020-02-19T12:14:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-588194193",
      "id" : 588194193,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4ODE5NDE5Mw==",
      "updated_at" : "2020-02-19T12:15:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/588194193",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392695102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392695102"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: initial",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-15T17:34:20Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392695102",
      "id" : 392695102,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5NTEwMg==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 156,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392695102",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392695347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392695347"
         }
      },
      "author_association" : "MEMBER",
      "body" : "keypool of 3",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-15T17:37:10Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392695347",
      "id" : 392695347,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5NTM0Nw==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 158,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392695347",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392696785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392696785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion\r\n```diff\r\n-        # Empty keypool and get an address that is beyond the initial keypool\r\n+        # Empty the origin keypool and get an address that is beyond the initial keypool of 3\r\n         origin_rpc.getnewaddress()\r\n         origin_rpc.getnewaddress()\r\n-        last_addr = origin_rpc.getnewaddress()\r\n-        addr = origin_rpc.getnewaddress()\r\n+        last_addr = origin_rpc.getnewaddress() # last address of initial keypool\r\n+        addr = origin_rpc.getnewaddress() # address beyond initial keypool of 3\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-15T17:54:53Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392696785",
      "id" : 392696785,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5Njc4NQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 183,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392696785",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392698112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392698112"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggest mentioning in order of checks\r\n```diff\r\n-        # Check that the restored seed does not have addr but does have last_addr\r\n+        # Check that the restored seed has last_addr but does not have addr\r\n         info = restore_rpc.getaddressinfo(last_addr)\r\n         assert_equal(info['ismine'], True)\r\n         info = restore_rpc.getaddressinfo(addr)\r\n         assert_equal(info['ismine'], False)\r\n+        # Check that the origin seed does have addr\r\n         info = origin_rpc.getaddressinfo(addr)\r\n         assert_equal(info['ismine'], True)\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-15T18:10:19Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392698112",
      "id" : 392698112,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5ODExMg==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 192,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392698112",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392698529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392698529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This line seems redundant?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-15T18:15:31Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392698529",
      "id" : 392698529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5ODUyOQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 172,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392698529",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392700316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392700316"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggest mentioning in order of checks\r\n```diff\r\n-        # Check that the restored seed does not have addr but does have last_addr\r\n+        # Check that the restored seed has last_addr but does not have addr\r\n```\r\n",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-15T18:37:10Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        # Check again that 3 keys were derived.\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392700316",
      "id" : 392700316,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwMDMxNg==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 219,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392700316",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392700402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392700402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could you add comments for the 3 sections above? ",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-15T18:38:09Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392700402",
      "id" : 392700402,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwMDQwMg==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 218,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392700402",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392936080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392936080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit suggestion here and line 1014 just above: git grepping indicates these are lowercased elsewhere, except when the message begins with a class name\r\n```diff\r\n- throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\r\n+ throw std::runtime_error(std::string(__func__) + \": writing HD chain model failed\");\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T10:57:00Z",
      "diff_hunk" : "@@ -918,30 +987,35 @@ void LegacyScriptPubKeyMan::DeriveNewChildKey(WalletBatch &batch, CKeyMetadata&\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n         if (internal) {\n-            chainChildKey.Derive(childKey, hdChain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.hdKeypath = \"m/0'/1'/\" + std::to_string(hdChain.nInternalChainCounter) + \"'\";\n+            chainChildKey.Derive(childKey, hd_chain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            metadata.hdKeypath = \"m/0'/1'/\" + std::to_string(hd_chain.nInternalChainCounter) + \"'\";\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n             metadata.key_origin.path.push_back(1 | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.key_origin.path.push_back(hdChain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            hdChain.nInternalChainCounter++;\n+            metadata.key_origin.path.push_back(hd_chain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            hd_chain.nInternalChainCounter++;\n         }\n         else {\n-            chainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+            chainChildKey.Derive(childKey, hd_chain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hd_chain.nExternalChainCounter) + \"'\";\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.key_origin.path.push_back(hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            hdChain.nExternalChainCounter++;\n+            metadata.key_origin.path.push_back(hd_chain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            hd_chain.nExternalChainCounter++;\n         }\n     } while (HaveKey(childKey.key.GetPubKey().GetID()));\n     secret = childKey.key;\n-    metadata.hd_seed_id = hdChain.seed_id;\n+    metadata.hd_seed_id = hd_chain.seed_id;\n     CKeyID master_id = masterKey.key.GetPubKey().GetID();\n     std::copy(master_id.begin(), master_id.begin() + 4, metadata.key_origin.fingerprint);\n     metadata.has_key_origin = true;\n     // update the chain model in the database\n-    if (!batch.WriteHDChain(hdChain))\n-        throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n+    if (hd_chain.seed_id == m_hd_chain.seed_id) {\n+        if (!batch.WriteHDChain(hd_chain))\n+            throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n+    } else {\n+        if (!batch.WriteInactiveHDChain(hd_chain))\n+            throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392936080",
      "id" : 392936080,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzNjA4MA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 1017,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392936080",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392951184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392951184"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should also define `bool operator!=`...?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T11:29:52Z",
      "diff_hunk" : "@@ -110,6 +110,11 @@ class CHDChain\n         nInternalChainCounter = 0;\n         seed_id.SetNull();\n     }\n+\n+    bool operator==(const CHDChain& chain) const\n+    {\n+        return seed_id == chain.seed_id;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392951184",
      "id" : 392951184,
      "line" : 123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MTE4NA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 123,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : 8,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392951184",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392953786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392953786"
         }
      },
      "author_association" : "MEMBER",
      "body" : "-keypool (keypoolsize)",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T11:34:57Z",
      "diff_hunk" : "@@ -306,6 +320,18 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n      */\n     bool ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool, bool fRequestedInternal);\n \n+    /**\n+     * Like TopUp() but adds keys for inactive HD chains.\n+     * Ensures that there are at least -keypoolsize number of keys derived after the given index.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392953786",
      "id" : 392953786,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1Mzc4Ng==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 325,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392953786",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392954955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392954955"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: s/user selected/user-selected/",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T11:37:06Z",
      "diff_hunk" : "@@ -280,6 +280,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392954955",
      "id" : 392954955,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1NDk1NQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 304,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392954955",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392955591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392955591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree with @achow101, see https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#f16-for-in-parameters-pass-cheaply-copied-types-by-value-and-others-by-reference-to-const",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T11:38:23Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392955591",
      "id" : 392955591,
      "in_reply_to_id" : 355111113,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1NTU5MQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_line" : 283,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392955591",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392976340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392976340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "naming/documentation: both here in `FillInactiveChain()` and in `TopUp()`, \"available\" and `missing` seem like opposites",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T12:20:06Z",
      "diff_hunk" : "@@ -280,6 +280,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392976340",
      "id" : 392976340,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk3NjM0MA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 317,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392976340",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392980170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392980170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "musing on naming here: consider naming the function `FillUpInactiveHDChain` or `TopUpInactiveHDChain`:\r\n- to say it's an HD chain (which shows why no need to check `!CanGenerateKeys()` here IIUC)\r\n- naming similar to `AddInactiveHDChain` and `WriteInActiveHDChain`\r\n- best to avoid \"I\" next to \"ll\"\r\n- and if desired, show similarity to `TopUp` as the functions are similar, unless you don't want grepping for TopUp to return both",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T12:25:29Z",
      "diff_hunk" : "@@ -280,6 +280,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r392980170",
      "id" : 392980170,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4MDE3MA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 283,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392980170",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393019229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393019229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "for info I appended these checks after the rescan so that all checks before the rescan are also repeated after it, and all still pass\r\n```diff\r\n         assert_equal(info['ismine'], False)\r\n+        info = origin_rpc.getaddressinfo(addr)\r\n+        assert_equal(info['ismine'], True)\r\n+\r\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\r\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\r\n+        self.nodes[0].generate(1)\r\n+        origin_rpc.gettransaction(txid)\r\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\r\n+        out_of_kp_txid = txid\r\n+\r\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\r\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\r\n+        self.nodes[0].generate(1)\r\n+        origin_rpc.gettransaction(txid)\r\n+        restore_rpc.gettransaction(txid)\r\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\r\n+\r\n+        restore_rpc.rescanblockchain()\r\n+        restore_rpc.gettransaction(out_of_kp_txid)\r\n+        info = restore_rpc.getaddressinfo(addr)\r\n+        assert_equal(info['ismine'], True)\r\n \r\n if __name__ == '__main__':\r\n     WalletHDTest().main ()\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T13:24:30Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        # Check again that 3 keys were derived.\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393019229",
      "id" : 393019229,
      "line" : 268,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAxOTIyOQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 268,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : 99,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393019229",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393029747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393029747"
         }
      },
      "author_association" : "MEMBER",
      "body" : "On current master d402c1e4d, the new test fails here after the rescan with `Invalid or non-wallet transaction id (-5)`, is this where it fails for you, and should it not fail on one of the assertions?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T13:41:15Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393029747",
      "id" : 393029747,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyOTc0Nw==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 216,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 374818515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393029747",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393151113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393151113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, this is the correct place for it to fail. The asserts above should pass because on mater, we still have the keypool of 3 so all the things existing/not existing is the same. The difference is that the `out_of_kp_txid` is not seen by master because it uses a key that is out of the original keypool. Since master does not continue to extend the original keypool, it fails to detect `out_of_kp_txid` so it is supposed to fail here.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T16:27:39Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393151113",
      "id" : 393151113,
      "in_reply_to_id" : 393029747,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1MTExMw==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 216,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375380020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393151113",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393152055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393152055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is not. We are first setting the original seed (we set it to make sure it is shared), then setting a new seed to simulate a seed rotation.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T16:29:06Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393152055",
      "id" : 393152055,
      "in_reply_to_id" : 392698529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1MjA1NQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 172,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375381245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393152055",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393187069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393187069"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, right -- reading the cli help again, both calls are flushing; the first call sets the seed with the passed `seed` value and the second call sets a random seed. Maybe add a comment to explain the intention or simulation.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:17:32Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393187069",
      "id" : 393187069,
      "in_reply_to_id" : 392698529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE4NzA2OQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 172,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375425890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393187069",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393189292"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393189292"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok thanks. Upgraded the Concept ACK to an ACK with non-blocking comments.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:21:22Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393189292",
      "id" : 393189292,
      "in_reply_to_id" : 393029747,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE4OTI5Mg==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 216,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375428818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393189292",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393202958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393202958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:44:20Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393202958",
      "id" : 393202958,
      "in_reply_to_id" : 392695102,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMjk1OA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 156,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375446101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393202958",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393202998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393202998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:44:25Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393202998",
      "id" : 393202998,
      "in_reply_to_id" : 392695347,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMjk5OA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 158,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375446162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393202998",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203066"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:44:30Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203066",
      "id" : 393203066,
      "in_reply_to_id" : 392696785,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzA2Ng==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 183,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375446238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203066",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203131"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:44:37Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203131",
      "id" : 393203131,
      "in_reply_to_id" : 392698112,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzEzMQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 192,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375446331,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203131",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:44:44Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        # Check again that 3 keys were derived.\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203207",
      "id" : 393203207,
      "in_reply_to_id" : 392700316,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzIwNw==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 219,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375446420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203207",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203250"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:44:47Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203250",
      "id" : 393203250,
      "in_reply_to_id" : 392700402,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzI1MA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 218,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375446461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203250",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:44:52Z",
      "diff_hunk" : "@@ -918,30 +987,35 @@ void LegacyScriptPubKeyMan::DeriveNewChildKey(WalletBatch &batch, CKeyMetadata&\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n         if (internal) {\n-            chainChildKey.Derive(childKey, hdChain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.hdKeypath = \"m/0'/1'/\" + std::to_string(hdChain.nInternalChainCounter) + \"'\";\n+            chainChildKey.Derive(childKey, hd_chain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            metadata.hdKeypath = \"m/0'/1'/\" + std::to_string(hd_chain.nInternalChainCounter) + \"'\";\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n             metadata.key_origin.path.push_back(1 | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.key_origin.path.push_back(hdChain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            hdChain.nInternalChainCounter++;\n+            metadata.key_origin.path.push_back(hd_chain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            hd_chain.nInternalChainCounter++;\n         }\n         else {\n-            chainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+            chainChildKey.Derive(childKey, hd_chain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hd_chain.nExternalChainCounter) + \"'\";\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.key_origin.path.push_back(hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            hdChain.nExternalChainCounter++;\n+            metadata.key_origin.path.push_back(hd_chain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            hd_chain.nExternalChainCounter++;\n         }\n     } while (HaveKey(childKey.key.GetPubKey().GetID()));\n     secret = childKey.key;\n-    metadata.hd_seed_id = hdChain.seed_id;\n+    metadata.hd_seed_id = hd_chain.seed_id;\n     CKeyID master_id = masterKey.key.GetPubKey().GetID();\n     std::copy(master_id.begin(), master_id.begin() + 4, metadata.key_origin.fingerprint);\n     metadata.has_key_origin = true;\n     // update the chain model in the database\n-    if (!batch.WriteHDChain(hdChain))\n-        throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n+    if (hd_chain.seed_id == m_hd_chain.seed_id) {\n+        if (!batch.WriteHDChain(hd_chain))\n+            throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n+    } else {\n+        if (!batch.WriteInactiveHDChain(hd_chain))\n+            throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203317",
      "id" : 393203317,
      "in_reply_to_id" : 392936080,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzMxNw==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 1017,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 375446534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203317",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203508"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It should be implicitly defined.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:45:11Z",
      "diff_hunk" : "@@ -110,6 +110,11 @@ class CHDChain\n         nInternalChainCounter = 0;\n         seed_id.SetNull();\n     }\n+\n+    bool operator==(const CHDChain& chain) const\n+    {\n+        return seed_id == chain.seed_id;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203508",
      "id" : 393203508,
      "in_reply_to_id" : 392951184,
      "line" : 123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzUwOA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 123,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : 8,
      "pull_request_review_id" : 375446771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203508",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:45:14Z",
      "diff_hunk" : "@@ -306,6 +320,18 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n      */\n     bool ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool, bool fRequestedInternal);\n \n+    /**\n+     * Like TopUp() but adds keys for inactive HD chains.\n+     * Ensures that there are at least -keypoolsize number of keys derived after the given index.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203548",
      "id" : 393203548,
      "in_reply_to_id" : 392953786,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzU0OA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 325,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 375446818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203548",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:45:19Z",
      "diff_hunk" : "@@ -280,6 +280,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203587",
      "id" : 393203587,
      "in_reply_to_id" : 392954955,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzU4Nw==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 304,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 375446869,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203587",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:45:23Z",
      "diff_hunk" : "@@ -280,6 +280,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203638",
      "id" : 393203638,
      "in_reply_to_id" : 392976340,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzYzOA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 317,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 375446926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203638",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203756"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203756"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Renamed to `TopUpInactiveHDChain`",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:45:35Z",
      "diff_hunk" : "@@ -280,6 +280,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393203756",
      "id" : 393203756,
      "in_reply_to_id" : 392980170,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwMzc1Ng==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 283,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 375447068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393203756",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393204677"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393204677"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T17:47:10Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393204677",
      "id" : 393204677,
      "in_reply_to_id" : 392698529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIwNDY3Nw==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 172,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 375448232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393204677",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393216391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393216391"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Default comparison operators are only being added in C++20. That said, if nothing needs !=, no need to define it.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T18:05:36Z",
      "diff_hunk" : "@@ -110,6 +110,11 @@ class CHDChain\n         nInternalChainCounter = 0;\n         seed_id.SetNull();\n     }\n+\n+    bool operator==(const CHDChain& chain) const\n+    {\n+        return seed_id == chain.seed_id;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393216391",
      "id" : 393216391,
      "in_reply_to_id" : 392951184,
      "line" : 123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIxNjM5MQ==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 123,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : 8,
      "pull_request_review_id" : 375465363,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393216391",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393253681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393253681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0715613\r\n\r\nIf you switch `-keypool` arg after switching seed to a smaller one, you may end up with less look-ahead protection for a seed which may be used for higher amounts or different funds policy. That's already an issue today without seed rotation, but I would be okay to make it a static parameter part of `m_inactive_hd_chains`.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T19:09:35Z",
      "diff_hunk" : "@@ -280,6 +280,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393253681",
      "id" : 393253681,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1MzY4MQ==",
      "original_commit_id" : "0715613ce4b983b775e247f89aa033d2d2b822f5",
      "original_line" : 310,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 375510813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393253681",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393255004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393255004"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0715613\r\n\r\nToo much work for parameterizing `TopUp` with `seed_id` or other reasons?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T19:12:12Z",
      "diff_hunk" : "@@ -280,6 +280,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393255004",
      "id" : 393255004,
      "line" : 296,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1NTAwNA==",
      "original_commit_id" : "0715613ce4b983b775e247f89aa033d2d2b822f5",
      "original_line" : 296,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 14,
      "pull_request_review_id" : 375510813,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393255004",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393260572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393260572"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think that's necessary. Since `sethdseed`'s purpose is seed rotation, it doesn't really make sense that there would be different funds policies.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T19:23:48Z",
      "diff_hunk" : "@@ -280,6 +280,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393260572",
      "id" : 393260572,
      "in_reply_to_id" : 393253681,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2MDU3Mg==",
      "original_commit_id" : "0715613ce4b983b775e247f89aa033d2d2b822f5",
      "original_line" : 310,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 375519633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393260572",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393261919"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393261919"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Needing `index` makes it harder to parameterize.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-03-16T19:26:31Z",
      "diff_hunk" : "@@ -280,6 +280,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393261919",
      "id" : 393261919,
      "in_reply_to_id" : 393255004,
      "line" : 296,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2MTkxOQ==",
      "original_commit_id" : "0715613ce4b983b775e247f89aa033d2d2b822f5",
      "original_line" : 296,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 14,
      "pull_request_review_id" : 375521318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393261919",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Re-ACK 5fafe5e reviewed changes since last review with `git diff d435512..5fafe5e`, rebased on master @ 25424cf57, built/ran tests/bitcoind",
      "created_at" : "2020-03-16T21:20:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-599763723",
      "id" : 599763723,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTc2MzcyMw==",
      "updated_at" : "2020-03-16T21:20:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599763723",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-25T19:47:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-604049003",
      "id" : 604049003,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDA0OTAwMw==",
      "updated_at" : "2020-03-25T19:47:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604049003",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review almost-ACK d27ced4eeaf59d093b4eedeed6c344f3f80082c1\r\n\r\nArrived here while reviewing #17484, and happy to see another really nicely implemented PR!  Clean changes and great code comments and tests. Only thing that I think is a problem (and easily addressed) is decision to read/write/rely on new \"inactivehdchain\" database rows. I guess there are two slightly different decisions I'm concerned about:\r\n\r\n1. Decision to rely on \"inactivehdchain\" rows being written to top up old seeds instead of always topping up old seeds.\r\n2. Decision to write \"inactivehdchain\" rows when sethdseed is called.\r\n\r\nI think (1) isn't good because it results in behavior that could be unnecessarily confusing and seem unreliable to users. Wallet loading code could just populate the `m_inactive_hd_chains` map from existing key origin data during loading, without requiring \"inactivehdchain\" database rows to have been written previously. A problem with requiring the rows to top up is that now instead of having two types of seeds in the wallet: _active_ and _inactive_, there are three kinds: _active_, _inactive and topped up_, _inactive and dormant_ which could be confusing to users who will see different behavior between the different inactive types, and not have control over what type they end up with without switching software versions. So it would be great to see `m_inactive_hd_chains` map and counters just populated automatically with origin data when wallet is loaded.\r\n\r\nDecision (2) to write \"inactivehdchain\" rows may be justified even if the rows aren't required for topping up, because maybe there is some useful metadata or history they provide, but it would be good to figure out if there is actually anything in there worth keeping when a new seed is set. Also, WalletBatch::WriteInactiveHDChain implemented in 40635251387758aac8a578b72e01b265dcc15d77, seems like it only writes a single row to the database with each new inactive chain overwriting the last, so I wonder if that behaves as intended in the current implementation.\r\n\r\nEverything else seems really good aside from this one point. Great to see this PR!",
      "created_at" : "2020-05-01T01:58:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-622211593",
      "id" : 622211593,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjIxMTU5Mw==",
      "updated_at" : "2020-05-01T01:58:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622211593",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've changed this to get rid of the `inactivehdseed` records and just interpret the `keymeta` records during loading.",
      "created_at" : "2020-05-02T02:03:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-622653118",
      "id" : 622653118,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjY1MzExOA==",
      "updated_at" : "2020-05-02T02:03:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622653118",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421528878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421528878"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"fixup! Determine inactive HD seeds from key metadata and track them in LegacyScriptPubKeyMan\" (65dee3410cd9807bb4aa6b6677c2e0832e050ea2)\r\n\r\nShould fix: probably need to drop this performance optimization",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:02:47Z",
      "diff_hunk" : "@@ -83,6 +83,7 @@ def run_test(self):\n         shutil.rmtree(os.path.join(self.nodes[1].datadir, self.chain, \"blocks\"))\n         shutil.rmtree(os.path.join(self.nodes[1].datadir, self.chain, \"chainstate\"))\n         shutil.copyfile(os.path.join(self.nodes[1].datadir, \"hd.bak\"), os.path.join(self.nodes[1].datadir, self.chain, 'wallets', \"wallet.dat\"))\n+        return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421528878",
      "id" : 421528878,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUyODg3OA==",
      "original_commit_id" : "65dee3410cd9807bb4aa6b6677c2e0832e050ea2",
      "original_line" : 86,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421528878",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421530343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421530343"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"fixup! Determine inactive HD seeds from key metadata and track them in LegacyScriptPubKeyMan\" (65dee3410cd9807bb4aa6b6677c2e0832e050ea2)\r\n\r\nNote: looks like unintended comment change here",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:04:47Z",
      "diff_hunk" : "@@ -685,7 +686,7 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n                 if (IsKeyType(strType) || strType == DBKeys::DEFAULTKEY) {\n                     result = DBErrors::CORRUPT;\n                 } else if (strType == DBKeys::FLAGS) {\n-                    // reading the wallet flags can only fail if unknown flags are present\n+                    // reading the wallet flags only fail if unknown flags are present",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421530343",
      "id" : 421530343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzMDM0Mw==",
      "original_commit_id" : "65dee3410cd9807bb4aa6b6677c2e0832e050ea2",
      "original_line" : 689,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421530343",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421539430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421539430"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Determine inactive HD seeds from key metadata and track them in LegacyScriptPubKeyMan\" (22361d241b4d236b2b8f84b59094c296172db0ff)\r\n\r\nNote: I initially questioned this, but it does seems reasonable to treat unexpected paths as errors. Triggering an error instead of ignoring these keys means we may need to be a little more careful about backwards compatibility in the future, and store possible paths with different lengths in a new field, but this seems like a reasonable tradeoff for getting better error checking now",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:16:51Z",
      "diff_hunk" : "@@ -405,6 +407,56 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        if (keyMeta.key_origin.path.size() != 3) {\n+                            strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                            return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421539430",
      "id" : 421539430,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzOTQzMA==",
      "original_commit_id" : "22361d241b4d236b2b8f84b59094c296172db0ff",
      "original_line" : 423,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421539430",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421540545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421540545"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"fixup! Determine inactive HD seeds from key metadata and track them in LegacyScriptPubKeyMan\" (65dee3410cd9807bb4aa6b6677c2e0832e050ea2)\r\n\r\nNote: Could drop the comment about \"s\" here since it's now noted and handled above",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:18:22Z",
      "diff_hunk" : "@@ -418,15 +418,10 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n                     std::vector<uint32_t> path;\n                     if (keyMeta.has_key_origin) {\n                         // We have a key origin, so pull it from it's path vector\n-                        if (keyMeta.key_origin.path.size() != 3) {\n-                            strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n-                            return false;\n-                        }\n                         path = keyMeta.key_origin.path;\n-                    } else if (keyMeta.hdKeypath != \"s\") {\n+                    } else {\n                         // No key origin, have to parse the string\n                         // \"s\" is for a seed, no path info to parse so we skip those",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421540545",
      "id" : 421540545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0MDU0NQ==",
      "original_commit_id" : "65dee3410cd9807bb4aa6b6677c2e0832e050ea2",
      "original_line" : 424,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421540545",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421550317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421550317"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Determine inactive HD seeds from key metadata and track them in LegacyScriptPubKeyMan\" (22361d241b4d236b2b8f84b59094c296172db0ff)\r\n\r\nShould fix: It would probably be good to skip keys or error if path[1] is not `0` or `1` or path[0] is not `0`",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:30:19Z",
      "diff_hunk" : "@@ -405,6 +407,56 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        if (keyMeta.key_origin.path.size() != 3) {\n+                            strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                            return false;\n+                        }\n+                        path = keyMeta.key_origin.path;\n+                    } else if (keyMeta.hdKeypath != \"s\") {\n+                        // No key origin, have to parse the string\n+                        // \"s\" is for a seed, no path info to parse so we skip those\n+                        std::vector<uint32_t> path;\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    internal = path[1] == 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421550317",
      "id" : 421550317,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU1MDMxNw==",
      "original_commit_id" : "22361d241b4d236b2b8f84b59094c296172db0ff",
      "original_line" : 440,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421550317",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421554491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421554491"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Generate new keys for inactive seeds after marking used\" (8b8f982973a83ea77b5159235b282f20bd430677)\r\n\r\nNote: Maybe would be good to include seed id in log message",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:35:14Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+        AddKeypoolPubkeyWithDB(pubkey, internal, batch);\n+    }\n+    if (missing > 0) {\n+        if (internal) {\n+            WalletLogPrintf(\"inactive seed added %d internal keys\\n\", missing);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421554491",
      "id" : 421554491,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU1NDQ5MQ==",
      "original_commit_id" : "8b8f982973a83ea77b5159235b282f20bd430677",
      "original_line" : 324,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421554491",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421567397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421567397"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Test that keys from inactive seeds are generated\" (5932c00fef5054207bd133daa1aea9857d9c3611)\r\n\r\nClever test! Nice way to ensure the inactive pool wasn't topped up while still active",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:51:35Z",
      "diff_hunk" : "@@ -170,5 +170,82 @@ def run_test(self):\n             assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n             assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+            self.log.info('Test sethdseed restoring with keys outside of the initial keypool')\n+            self.nodes[0].generate(10)\n+            # Restart node 1 with keypool of 3 and a different wallet\n+            self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+            self.stop_node(1)\n+            self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+            connect_nodes(self.nodes[0], 1)\n+\n+            # sethdseed restoring and seeing txs to addresses out of the keypool\n+            origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+            seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+            origin_rpc.sethdseed(True, seed)\n+\n+            self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+            restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+            restore_rpc.sethdseed(True, seed) # Set to be the same seed as origin_rpc\n+            restore_rpc.sethdseed(True) # Rotate to a new seed, making original `seed` inactive\n+\n+            # Check persistence of inactive seed\n+            restore_rpc.unloadwallet()\n+            self.nodes[1].loadwallet('restore')\n+            restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+            # Empty origin keypool and get an address that is beyond the initial keypool\n+            origin_rpc.getnewaddress()\n+            origin_rpc.getnewaddress()\n+            last_addr = origin_rpc.getnewaddress() # Last address of initial keypool\n+            addr = origin_rpc.getnewaddress() # First address beyond initial keypool\n+\n+            # Check that the restored seed has last_addr but does not have addr\n+            info = restore_rpc.getaddressinfo(last_addr)\n+            assert_equal(info['ismine'], True)\n+            info = restore_rpc.getaddressinfo(addr)\n+            assert_equal(info['ismine'], False)\n+            # Check that the origin seed has addr\n+            info = origin_rpc.getaddressinfo(addr)\n+            assert_equal(info['ismine'], True)\n+\n+            # Send a transaction to addr, which is out of the initial keypool.\n+            # The wallet that has set a new seed (restore_rpc) should not detect this transaction.\n+            txid = self.nodes[0].sendtoaddress(addr, 1)\n+            origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+            self.nodes[0].generate(1)\n+            origin_rpc.gettransaction(txid)\n+            assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+            out_of_kp_txid = txid\n+\n+            # Send a transaction to last_addr, which is in the initial keypool.\n+            # The wallet that has set a new seed (restore_rpc) should detect this transaction and generate 3 new keys from the initial seed.\n+            # The previous transaction (out_of_kp_txid) should still not be detected as a rescan is required.\n+            txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+            origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+            self.nodes[0].generate(1)\n+            origin_rpc.gettransaction(txid)\n+            restore_rpc.gettransaction(txid)\n+            assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+            # After rescanning, restore_rpc should now see out_of_kp_txid and generate an additional key.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421567397",
      "id" : 421567397,
      "line" : 241,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2NzM5Nw==",
      "original_commit_id" : "5932c00fef5054207bd133daa1aea9857d9c3611",
      "original_line" : 241,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : 72,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421567397",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421571988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421571988"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Test that keys from inactive seeds are generated\" (5932c00fef5054207bd133daa1aea9857d9c3611)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/17681#discussion_r393019229\r\n\r\n> for info I appended these checks after the rescan so that all checks before the rescan are also repeated after it, and all still pass\r\n\r\nNot sure if this review comment was made based on an older version of the test, but while these checks do good as a sanity check for rescan, I think adding them here would muddle the purpose of this test, and wouldn't be great to add here unless preceded by an explanatory comment, or pulled into a function to keep the test readble",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T14:57:41Z",
      "diff_hunk" : "@@ -153,5 +153,74 @@ def run_test(self):\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, new_seed)\n         assert_raises_rpc_error(-5, \"Already have this key\", self.nodes[1].sethdseed, False, self.nodes[1].dumpprivkey(self.nodes[1].getnewaddress()))\n \n+        self.log.info('Test sethdseed restoring with keys outside of the intial keypool')\n+        self.nodes[0].generate(10)\n+        # Restart node 1 with keypool of 5 and a different wallet\n+        self.nodes[1].createwallet(wallet_name='origin', blank=True)\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=['-keypool=3', '-wallet=origin'])\n+        connect_nodes(self.nodes[0], 1)\n+\n+        # sethdseed restoring and seeing txs to addresses out of the keypool\n+        origin_rpc = self.nodes[1].get_wallet_rpc('origin')\n+        seed = self.nodes[0].dumpprivkey(self.nodes[0].getnewaddress())\n+        origin_rpc.sethdseed(True, seed)\n+\n+        self.nodes[1].createwallet(wallet_name='restore', blank=True)\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+        restore_rpc.sethdseed(True, seed)\n+        restore_rpc.sethdseed(True)\n+\n+        # Check persistence of inactive seed\n+        restore_rpc.unloadwallet()\n+        self.nodes[1].loadwallet('restore')\n+        restore_rpc = self.nodes[1].get_wallet_rpc('restore')\n+\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+        info = origin_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, txid)\n+        out_of_kp_txid = txid\n+\n+        txid = self.nodes[0].sendtoaddress(last_addr, 1)\n+        origin_rpc.sendrawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n+        self.nodes[0].generate(1)\n+        origin_rpc.gettransaction(txid)\n+        restore_rpc.gettransaction(txid)\n+        assert_raises_rpc_error(-5, 'Invalid or non-wallet transaction id', restore_rpc.gettransaction, out_of_kp_txid)\n+\n+        restore_rpc.rescanblockchain()\n+        restore_rpc.gettransaction(out_of_kp_txid)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], True)\n+\n+        # Check again that 3 keys were derived.\n+        # Empty keypool and get an address that is beyond the initial keypool\n+        origin_rpc.getnewaddress()\n+        origin_rpc.getnewaddress()\n+        last_addr = origin_rpc.getnewaddress()\n+        addr = origin_rpc.getnewaddress()\n+\n+        # Check that the restored seed does not have addr but does have last_addr\n+        info = restore_rpc.getaddressinfo(last_addr)\n+        assert_equal(info['ismine'], True)\n+        info = restore_rpc.getaddressinfo(addr)\n+        assert_equal(info['ismine'], False)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421571988",
      "id" : 421571988,
      "in_reply_to_id" : 393019229,
      "line" : 268,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3MTk4OA==",
      "original_commit_id" : "d435512094ccd447ce0d582fa0e9ea85c46ebec3",
      "original_line" : 268,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : 99,
      "pull_request_review_id" : 407503207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421571988",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421616902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421616902"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Whoops. Fixed",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T15:59:43Z",
      "diff_hunk" : "@@ -83,6 +83,7 @@ def run_test(self):\n         shutil.rmtree(os.path.join(self.nodes[1].datadir, self.chain, \"blocks\"))\n         shutil.rmtree(os.path.join(self.nodes[1].datadir, self.chain, \"chainstate\"))\n         shutil.copyfile(os.path.join(self.nodes[1].datadir, \"hd.bak\"), os.path.join(self.nodes[1].datadir, self.chain, 'wallets', \"wallet.dat\"))\n+        return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421616902",
      "id" : 421616902,
      "in_reply_to_id" : 421528878,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNjkwMg==",
      "original_commit_id" : "65dee3410cd9807bb4aa6b6677c2e0832e050ea2",
      "original_line" : 86,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/wallet_hd.py",
      "position" : null,
      "pull_request_review_id" : 407615641,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421616902",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421616981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421616981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T15:59:50Z",
      "diff_hunk" : "@@ -685,7 +686,7 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n                 if (IsKeyType(strType) || strType == DBKeys::DEFAULTKEY) {\n                     result = DBErrors::CORRUPT;\n                 } else if (strType == DBKeys::FLAGS) {\n-                    // reading the wallet flags can only fail if unknown flags are present\n+                    // reading the wallet flags only fail if unknown flags are present",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421616981",
      "id" : 421616981,
      "in_reply_to_id" : 421530343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNjk4MQ==",
      "original_commit_id" : "65dee3410cd9807bb4aa6b6677c2e0832e050ea2",
      "original_line" : 689,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407615751,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421616981",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421617076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421617076"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T15:59:58Z",
      "diff_hunk" : "@@ -418,15 +418,10 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n                     std::vector<uint32_t> path;\n                     if (keyMeta.has_key_origin) {\n                         // We have a key origin, so pull it from it's path vector\n-                        if (keyMeta.key_origin.path.size() != 3) {\n-                            strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n-                            return false;\n-                        }\n                         path = keyMeta.key_origin.path;\n-                    } else if (keyMeta.hdKeypath != \"s\") {\n+                    } else {\n                         // No key origin, have to parse the string\n                         // \"s\" is for a seed, no path info to parse so we skip those",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421617076",
      "id" : 421617076,
      "in_reply_to_id" : 421540545,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNzA3Ng==",
      "original_commit_id" : "65dee3410cd9807bb4aa6b6677c2e0832e050ea2",
      "original_line" : 424,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407615877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421617076",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421617266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421617266"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T16:00:16Z",
      "diff_hunk" : "@@ -405,6 +407,56 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        if (keyMeta.key_origin.path.size() != 3) {\n+                            strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                            return false;\n+                        }\n+                        path = keyMeta.key_origin.path;\n+                    } else if (keyMeta.hdKeypath != \"s\") {\n+                        // No key origin, have to parse the string\n+                        // \"s\" is for a seed, no path info to parse so we skip those\n+                        std::vector<uint32_t> path;\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    internal = path[1] == 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421617266",
      "id" : 421617266,
      "in_reply_to_id" : 421550317,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxNzI2Ng==",
      "original_commit_id" : "22361d241b4d236b2b8f84b59094c296172db0ff",
      "original_line" : 440,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407616128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421617266",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421666484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421666484"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Determine inactive HD seeds from key metadata and track them in LegacyScriptPubKeyMan\" (daa9e347deceedb354aa0c73e34e34d50fafb5d5)\r\n\r\nDoesn't & need to be | here (and above) (and below)? I'm actually not sure how the test seems to pass with this",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T17:19:14Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                    }\n+                    if (path[1] != (0 & 0x80000000) && path[1] != (1 & 0x80000000)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421666484",
      "id" : 421666484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2NjQ4NA==",
      "original_commit_id" : "daa9e347deceedb354aa0c73e34e34d50fafb5d5",
      "original_line" : 441,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407678392,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421666484",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421670272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421670272"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I'm actually not sure how the test seems to pass with this\r\n\r\nOh, there actually are \"Unexpected path index\" errors in the wallet_hd.py debug logs. I guess these errors don't prevent the wallet from being loaded like I initially thought https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421539430, or these checks should be returning false",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T17:25:44Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                    }\n+                    if (path[1] != (0 & 0x80000000) && path[1] != (1 & 0x80000000)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421670272",
      "id" : 421670272,
      "in_reply_to_id" : 421666484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3MDI3Mg==",
      "original_commit_id" : "daa9e347deceedb354aa0c73e34e34d50fafb5d5",
      "original_line" : 441,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407683189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421670272",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421671889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421671889"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, you are correct, they should be `|`. The lack of failure is because I forgot to `return false`.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T17:28:21Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                    }\n+                    if (path[1] != (0 & 0x80000000) && path[1] != (1 & 0x80000000)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421671889",
      "id" : 421671889,
      "in_reply_to_id" : 421666484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3MTg4OQ==",
      "original_commit_id" : "daa9e347deceedb354aa0c73e34e34d50fafb5d5",
      "original_line" : 441,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407685291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421671889",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421673924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421673924"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Determine inactive HD seeds from key metadata and track them in LegacyScriptPubKeyMan\" (01c65e3f3119108c904c19c18921efc2d934a3a3)\r\n\r\n& should be | here too",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T17:31:35Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != (0 | 0x80000000) && path[1] != (1 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 & 0x80000000);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421673924",
      "id" : 421673924,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3MzkyNA==",
      "original_commit_id" : "01c65e3f3119108c904c19c18921efc2d934a3a3",
      "original_line" : 446,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407687729,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421673924",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421729110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421729110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-07T19:05:35Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != (0 | 0x80000000) && path[1] != (1 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 & 0x80000000);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r421729110",
      "id" : 421729110,
      "in_reply_to_id" : 421673924,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcyOTExMA==",
      "original_commit_id" : "01c65e3f3119108c904c19c18921efc2d934a3a3",
      "original_line" : 446,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 407756125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421729110",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We're covering this in review club on May 13: https://bitcoincore.reviews/17681.html",
      "created_at" : "2020-05-11T18:44:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-626885075",
      "id" : 626885075,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNjg4NTA3NQ==",
      "updated_at" : "2020-05-11T18:44:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/626885075",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423324234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423324234"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: since you're moving this anyway, the normal convention is to declare constants at the top of the file. Perhaps also add a doxygen comment?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T21:15:23Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+        AddKeypoolPubkeyWithDB(pubkey, internal, batch);\n+    }\n+    if (missing > 0) {\n+        if (internal) {\n+            WalletLogPrintf(\"inactive seed with id %s added %d internal keys\\n\", HexStr(seed_id), missing);\n+        } else {\n+            WalletLogPrintf(\"inactive seed with id %s added %d keys\\n\", HexStr(seed_id), missing);\n+        }\n+    }\n+    return true;\n+}\n+\n+const uint32_t BIP32_HARDENED_KEY_LIMIT = 0x80000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423324234",
      "id" : 423324234,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyNDIzNA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 332,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423324234",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423328009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423328009"
         }
      },
      "author_association" : "MEMBER",
      "body" : "grammar nit: s/it's/its/",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T21:22:55Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423328009",
      "id" : 423328009,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyODAwOQ==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 420,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423328009",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423333801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423333801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Personally, I think this would be clearer as `(path[0] != (0x80000000))` (remove the `0 |`), or even better, define a constant for BIP_32_HARDENED_BIT.\r\n\r\nSame for check below.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T21:35:23Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423333801",
      "id" : 423333801,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzMzgwMQ==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 438,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423333801",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423334301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423334301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "add a check that `path[2] & 0x80000000 == 0x80000000`?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T21:36:31Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != (0 | 0x80000000) && path[1] != (1 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423334301",
      "id" : 423334301,
      "line" : 449,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzNDMwMQ==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 449,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 59,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423334301",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423338993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423338993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Is this `if` statement required? Can't you just set `chain.nVersion` to `CHDChain::VERSION_HD_CHAIN_SPLIT` every time you're in the `internal` branch? If not, the following seems preferable:\r\n\r\n```\r\nchain.nVersion = std::max(chain.nVersion, CHDChain::VERSION_HD_CHAIN_SPLIT);\r\n```\r\n\r\nto match the formatting below.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T21:46:58Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != (0 | 0x80000000) && path[1] != (1 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 | 0x80000000);\n+                    index = path[2] & ~0x80000000;\n+                }\n+\n+                // Insert a new CHDChain, or get the one that already exists\n+                auto ins = wss.m_hd_chains.emplace(keyMeta.hd_seed_id, CHDChain());\n+                CHDChain& chain = ins.first->second;\n+                if (ins.second) {\n+                    // For new chains, we want to default to VERSION_HD_BASE until we see an internal\n+                    chain.nVersion = CHDChain::VERSION_HD_BASE;\n+                    // Set the seed id\n+                    chain.seed_id = keyMeta.hd_seed_id;\n+                }\n+                if (internal) {\n+                    if (chain.nVersion < CHDChain::VERSION_HD_CHAIN_SPLIT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423338993",
      "id" : 423338993,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzODk5Mw==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 460,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423338993",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423345205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423345205"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: it seems slightly inconsistent that we're sometimes using BIP32_HARDENED_KEY_LIMIT as a value for arithmetic operations and sometimes as a bit for bitwise operations. Functionally it's fine, but It seems slightly clearer to me to do:\r\n\r\n```\r\nbool internal = meta.key_origin.path[1] & ~BIP32_HARDENED_KEY_LIMIT != 0;\r\n```\r\n\r\nand the same below for `index`",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T22:01:18Z",
      "diff_hunk" : "@@ -304,6 +345,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);\n+        if (it != mapKeyMetadata.end()){\n+            CKeyMetadata meta = it->second;\n+            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id) {\n+                bool internal = meta.key_origin.path[1] - BIP32_HARDENED_KEY_LIMIT != 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423345205",
      "id" : 423345205,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NTIwNQ==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 353,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423345205",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423350654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423350654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove \"(locked wallet)\". `TopUpInactiveHDChain()` can return false for multiple reasons.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T22:14:37Z",
      "diff_hunk" : "@@ -304,6 +345,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);\n+        if (it != mapKeyMetadata.end()){\n+            CKeyMetadata meta = it->second;\n+            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id) {\n+                bool internal = meta.key_origin.path[1] - BIP32_HARDENED_KEY_LIMIT != 0;\n+                int64_t index = meta.key_origin.path[2] - BIP32_HARDENED_KEY_LIMIT;\n+\n+                if (!TopUpInactiveHDChain(meta.hd_seed_id, index, internal)) {\n+                    WalletLogPrintf(\"%s: Adding inactive seed keys failed (locked wallet)\\n\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423350654",
      "id" : 423350654,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1MDY1NA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 357,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423350654",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423353444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423353444"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You've copied this comment from `TopUp()`, but it doesn't make sense in this context, because you're not topping up both internal and external keypools here.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T22:21:46Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423353444",
      "id" : 423353444,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1MzQ0NA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 313,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423353444",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423355017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423355017"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't seem right. It adds the key to setInternalKeyPool or setExternalKeyPool, but I don't think we want to do that?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-11T22:25:40Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+        AddKeypoolPubkeyWithDB(pubkey, internal, batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423355017",
      "id" : 423355017,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1NTAxNw==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 320,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409536553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423355017",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423393936"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423393936"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:25:47Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+        AddKeypoolPubkeyWithDB(pubkey, internal, batch);\n+    }\n+    if (missing > 0) {\n+        if (internal) {\n+            WalletLogPrintf(\"inactive seed with id %s added %d internal keys\\n\", HexStr(seed_id), missing);\n+        } else {\n+            WalletLogPrintf(\"inactive seed with id %s added %d keys\\n\", HexStr(seed_id), missing);\n+        }\n+    }\n+    return true;\n+}\n+\n+const uint32_t BIP32_HARDENED_KEY_LIMIT = 0x80000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423393936",
      "id" : 423393936,
      "in_reply_to_id" : 423324234,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5MzkzNg==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 332,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409619426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423393936",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423393972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423393972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:25:50Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423393972",
      "id" : 423393972,
      "in_reply_to_id" : 423328009,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5Mzk3Mg==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 420,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 409619451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423393972",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394002"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:25:55Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394002",
      "id" : 423394002,
      "in_reply_to_id" : 423333801,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5NDAwMg==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 438,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 409619473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394002",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:25:59Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != (0 | 0x80000000) && path[1] != (1 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394015",
      "id" : 423394015,
      "in_reply_to_id" : 423334301,
      "line" : 449,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5NDAxNQ==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 449,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 59,
      "pull_request_review_id" : 409619491,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394015",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394070"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suppose the `if` isn't required. Removed it.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:26:11Z",
      "diff_hunk" : "@@ -405,6 +407,64 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from it's path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != (0 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != (0 | 0x80000000) && path[1] != (1 | 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 | 0x80000000);\n+                    index = path[2] & ~0x80000000;\n+                }\n+\n+                // Insert a new CHDChain, or get the one that already exists\n+                auto ins = wss.m_hd_chains.emplace(keyMeta.hd_seed_id, CHDChain());\n+                CHDChain& chain = ins.first->second;\n+                if (ins.second) {\n+                    // For new chains, we want to default to VERSION_HD_BASE until we see an internal\n+                    chain.nVersion = CHDChain::VERSION_HD_BASE;\n+                    // Set the seed id\n+                    chain.seed_id = keyMeta.hd_seed_id;\n+                }\n+                if (internal) {\n+                    if (chain.nVersion < CHDChain::VERSION_HD_CHAIN_SPLIT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394070",
      "id" : 423394070,
      "in_reply_to_id" : 423338993,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5NDA3MA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 460,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 409619565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394070",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:26:15Z",
      "diff_hunk" : "@@ -304,6 +345,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);\n+        if (it != mapKeyMetadata.end()){\n+            CKeyMetadata meta = it->second;\n+            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id) {\n+                bool internal = meta.key_origin.path[1] - BIP32_HARDENED_KEY_LIMIT != 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394088",
      "id" : 423394088,
      "in_reply_to_id" : 423345205,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5NDA4OA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 353,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409619586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394088",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:26:19Z",
      "diff_hunk" : "@@ -304,6 +345,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);\n+        if (it != mapKeyMetadata.end()){\n+            CKeyMetadata meta = it->second;\n+            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id) {\n+                bool internal = meta.key_origin.path[1] - BIP32_HARDENED_KEY_LIMIT != 0;\n+                int64_t index = meta.key_origin.path[2] - BIP32_HARDENED_KEY_LIMIT;\n+\n+                if (!TopUpInactiveHDChain(meta.hd_seed_id, index, internal)) {\n+                    WalletLogPrintf(\"%s: Adding inactive seed keys failed (locked wallet)\\n\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394110",
      "id" : 423394110,
      "in_reply_to_id" : 423350654,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5NDExMA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 357,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409619601,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394110",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394134"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:26:24Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394134",
      "id" : 423394134,
      "in_reply_to_id" : 423353444,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5NDEzNA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 313,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409619631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394134",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T00:26:31Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+        AddKeypoolPubkeyWithDB(pubkey, internal, batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423394171",
      "id" : 423394171,
      "in_reply_to_id" : 423355017,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM5NDE3MQ==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 320,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 409619687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423394171",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423813368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423813368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This line is causing a -Wparentheses build warning `suggest parentheses around comparison in operand of &`",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T15:11:08Z",
      "diff_hunk" : "@@ -304,6 +344,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);\n+        if (it != mapKeyMetadata.end()){\n+            CKeyMetadata meta = it->second;\n+            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id) {\n+                bool internal = meta.key_origin.path[1] & ~BIP32_HARDENED_KEY_LIMIT != 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423813368",
      "id" : 423813368,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxMzM2OA==",
      "original_commit_id" : "2feb5a2d0403edeb680c21e6f19c37c06a59d859",
      "original_line" : 352,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 410144444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423813368",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423814573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423814573"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This line is making `test/lint/lint-logs.sh` unhappy, appeased with:\r\n```diff\r\n-            pwallet->WalletLogPrintf(\"Inactive HD Chains found but no Legacy ScriptPubKeyMan\");\r\n+            pwallet->WalletLogPrintf(\"Inactive HD Chains found but no Legacy ScriptPubKeyMan\\n\");\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T15:12:48Z",
      "diff_hunk" : "@@ -728,6 +786,20 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Set the inactive chain\n+    if (wss.m_hd_chains.size() > 0) {\n+        LegacyScriptPubKeyMan* legacy_spkm = pwallet->GetLegacyScriptPubKeyMan();\n+        if (!legacy_spkm) {\n+            pwallet->WalletLogPrintf(\"Inactive HD Chains found but no Legacy ScriptPubKeyMan\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423814573",
      "id" : 423814573,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxNDU3Mw==",
      "original_commit_id" : "2feb5a2d0403edeb680c21e6f19c37c06a59d859",
      "original_line" : 793,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 410146052,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423814573",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423870476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423870476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T16:28:37Z",
      "diff_hunk" : "@@ -304,6 +344,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);\n+        if (it != mapKeyMetadata.end()){\n+            CKeyMetadata meta = it->second;\n+            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id) {\n+                bool internal = meta.key_origin.path[1] & ~BIP32_HARDENED_KEY_LIMIT != 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423870476",
      "id" : 423870476,
      "in_reply_to_id" : 423813368,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3MDQ3Ng==",
      "original_commit_id" : "2feb5a2d0403edeb680c21e6f19c37c06a59d859",
      "original_line" : 352,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 410216791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423870476",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423870527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423870527"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T16:28:40Z",
      "diff_hunk" : "@@ -728,6 +786,20 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Set the inactive chain\n+    if (wss.m_hd_chains.size() > 0) {\n+        LegacyScriptPubKeyMan* legacy_spkm = pwallet->GetLegacyScriptPubKeyMan();\n+        if (!legacy_spkm) {\n+            pwallet->WalletLogPrintf(\"Inactive HD Chains found but no Legacy ScriptPubKeyMan\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423870527",
      "id" : 423870527,
      "in_reply_to_id" : 423814573,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3MDUyNw==",
      "original_commit_id" : "2feb5a2d0403edeb680c21e6f19c37c06a59d859",
      "original_line" : 793,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 410216854,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423870527",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423901460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423901460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5eaa903 I think we can tuck this object and loop inside the conditional, to skip it if `missing` is zero.\r\n```diff\r\n-    WalletBatch batch(m_storage.GetDatabase());\r\n-    for (int64_t i = missing; i > 0; --i) {\r\n-        GenerateNewKey(batch, chain, internal);\r\n-    }\r\n     if (missing > 0) {\r\n+        WalletBatch batch(m_storage.GetDatabase());\r\n+        for (int64_t i = missing; i > 0; --i) {\r\n+            GenerateNewKey(batch, chain, internal);\r\n+        }\r\n         if (internal) {\r\n             WalletLogPrintf(\"inactive seed with id %s added %d internal keys\\n\", HexStr(seed_id), missing);\r\n         } else {\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T17:16:38Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // make sure the keypool fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+    }\n+    if (missing > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423901460",
      "id" : 423901460,
      "line" : 319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwMTQ2MA==",
      "original_commit_id" : "a5c3f3218be69ef2a7633bd9fa34963602d1c44f",
      "original_line" : 319,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 37,
      "pull_request_review_id" : 410256690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423901460",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423969969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423969969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5eaa903 s/@@return/@return/",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T19:10:11Z",
      "diff_hunk" : "@@ -319,6 +333,18 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n      */\n     bool ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool, bool fRequestedInternal);\n \n+    /**\n+     * Like TopUp() but adds keys for inactive HD chains.\n+     * Ensures that there are at least -keypool number of keys derived after the given index.\n+     *\n+     * @param seed_id the CKeyID for the HD seed.\n+     * @param index the index to start generating keys from\n+     * @param internal whether the internal chain should be used. true for internal chain, false for external chain.\n+     *\n+     * @@return true if seed was found and keys were derived. false if unable to derive seeds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423969969",
      "id" : 423969969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2OTk2OQ==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 344,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 410256690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423969969",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423983309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423983309"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5eaa90 suggestion:\r\n```diff\r\n@@ -307,14 +307,14 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\r\n     CHDChain& chain = it->second;\r\n \r\n     // Top up key pool\r\n-    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\r\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\r\n \r\n     // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\r\n     // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\r\n     int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\r\n \r\n     // make sure the keypool fits the user-selected target (-keypool)\r\n-    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\r\n+    int64_t missing = std::max(target_size - kp_size, (int64_t) 0);\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T19:33:59Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // make sure the keypool fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423983309",
      "id" : 423983309,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MzMwOQ==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 317,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 410256690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423983309",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423986044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423986044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5eaa90 nit line 341 if you feel like touching it up:\r\n```diff\r\n-            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\r\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T19:38:00Z",
      "diff_hunk" : "@@ -304,6 +344,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423986044",
      "id" : 423986044,
      "line" : 347,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NjA0NA==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 347,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 66,
      "pull_request_review_id" : 410256690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423986044",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423988278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423988278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5eaa90 nit: I reckon this new code section could use a comment.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T19:42:05Z",
      "diff_hunk" : "@@ -304,6 +344,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423988278",
      "id" : 423988278,
      "line" : 350,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4ODI3OA==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 350,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 69,
      "pull_request_review_id" : 410256690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423988278",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423990239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423990239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f5eaa90 now that `BIP32_HARDENED_KEY_LIMIT` has been added, perhaps replace the 6 instances of `0x80000000` here with it (can be done as a follow-up, as there may be others in the codebase that can use this constant)",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-12T19:46:02Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != 0x80000000) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != 0x80000000 && path[1] != (1 | 0x80000000) && (path[2] & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 | 0x80000000);\n+                    index = path[2] & ~0x80000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r423990239",
      "id" : 423990239,
      "line" : 451,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5MDIzOQ==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 451,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 61,
      "pull_request_review_id" : 410256690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423990239",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424449934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424449934"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `target_size` can fall back to 1 here so it doesn't have to be done below.\r\n```suggestion\r\n    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-13T13:45:49Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424449934",
      "id" : 424449934,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0OTkzNA==",
      "original_commit_id" : "f5eaa90301a946b889a9708631da2a60cf365cdc",
      "original_line" : 310,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 410939980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424449934",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424450844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424450844"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fallback to 1 can be done where `target_size` is defined initially so it can just be removed in this line.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-13T13:47:00Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // make sure the keypool fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424450844",
      "id" : 424450844,
      "in_reply_to_id" : 423983309,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MDg0NA==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 317,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 410939980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424450844",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424565904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424565904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> This doesn't seem right. It adds the key to setInternalKeyPool or setExternalKeyPool, but I don't think we want to do that?\r\n\r\nTo clarify, this wasn't just wasteful, but also a potentially dangerous bug right? LIke it could have caused new wallet addresses to be generated with the previous hd seed, and possibly stolen funds if money was sent to those addresses and the previous seed was unencrypted or shared with another wallet?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-13T16:19:16Z",
      "diff_hunk" : "@@ -290,6 +290,47 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count number of missing keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+        AddKeypoolPubkeyWithDB(pubkey, internal, batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424565904",
      "id" : 424565904,
      "in_reply_to_id" : 423355017,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2NTkwNA==",
      "original_commit_id" : "769b03a83c2aa2b97f344b58dc689be26c6e08e5",
      "original_line" : 320,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 411090035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424565904",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2020-05-13T16:27:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-628101843",
      "id" : 628101843,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODEwMTg0Mw==",
      "updated_at" : "2020-05-13T16:27:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628101843",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424575480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424575480"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would it be useful to include the unexpected path in `strErr`?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-13T16:33:52Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != 0x80000000) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != 0x80000000 && path[1] != (1 | 0x80000000) && (path[2] & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424575480",
      "id" : 424575480,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU3NTQ4MA==",
      "original_commit_id" : "9e33fa1b9c1a8c3a20973d4e46a2797324013002",
      "original_line" : 449,
      "original_position" : 55,
      "original_start_line" : 424,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 411102192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424575480",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424577883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424577883"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This comment doesn't seem to add any value. Remove?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-13T16:37:27Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != 0x80000000) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != 0x80000000 && path[1] != (1 | 0x80000000) && (path[2] & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 | 0x80000000);\n+                    index = path[2] & ~0x80000000;\n+                }\n+\n+                // Insert a new CHDChain, or get the one that already exists\n+                auto ins = wss.m_hd_chains.emplace(keyMeta.hd_seed_id, CHDChain());\n+                CHDChain& chain = ins.first->second;\n+                if (ins.second) {\n+                    // For new chains, we want to default to VERSION_HD_BASE until we see an internal\n+                    chain.nVersion = CHDChain::VERSION_HD_BASE;\n+                    // Set the seed id",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424577883",
      "id" : 424577883,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU3Nzg4Mw==",
      "original_commit_id" : "9e33fa1b9c1a8c3a20973d4e46a2797324013002",
      "original_line" : 456,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 411102192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424577883",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424586338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424586338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed; updated the suggestion.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-13T16:50:44Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // make sure the keypool fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424586338",
      "id" : 424586338,
      "in_reply_to_id" : 423983309,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NjMzOA==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 317,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 411115819,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424586338",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424639586"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424639586"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Per today's review club session, should `AddInactiveHDChain` be called not only from `LoadWallet` but also from sethdseed (or elsewhere), and tests updated to check for that case.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-13T18:18:44Z",
      "diff_hunk" : "@@ -842,7 +895,14 @@ void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n     if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n         throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n \n-    hdChain = chain;\n+    m_hd_chain = chain;\n+}\n+\n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r424639586",
      "id" : 424639586,
      "line" : 913,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzOTU4Ng==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 913,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 116,
      "pull_request_review_id" : 411183267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424639586",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Code Review ACK. Verified test, verified test failing in master. Overall nice easy to understand PR. Agreed with the motivation. ",
      "created_at" : "2020-05-15T14:56:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-629280702",
      "id" : 629280702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTI4MDcwMg==",
      "updated_at" : "2020-05-15T14:56:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629280702",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r425866177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425866177"
         }
      },
      "author_association" : "NONE",
      "body" : "As per the review club discussion, the intended behavior is only effective when the wallet is reloaded. As `SetHdChain` is writing the chains to the disk, `CWalletScanState` can only observe the presence of the old chains if it reads back from the disk. This means after setting the seed user must reload the wallet to track inactive chains which might not be readily obvious. could `SetHdChain` detect that a previous chain is being replaced and correspondingly call  `AddInactiveHDChain` before writing the new one to the disk? ",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T15:07:49Z",
      "diff_hunk" : "@@ -842,7 +895,14 @@ void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n     if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r425866177",
      "id" : 425866177,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg2NjE3Nw==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 895,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 412732619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425866177",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426050282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426050282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried but ran into far too many linker errors than I cared to try to fix. The logical places to define this constant aren't necessarily included by or linked with the places that actually use it.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T21:14:49Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != 0x80000000) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != 0x80000000 && path[1] != (1 | 0x80000000) && (path[2] & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 | 0x80000000);\n+                    index = path[2] & ~0x80000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426050282",
      "id" : 426050282,
      "in_reply_to_id" : 423990239,
      "line" : 451,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDI4Mg==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 451,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 61,
      "pull_request_review_id" : 412972378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426050282",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:00:24Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // make sure the keypool fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i) {\n+        CPubKey pubkey(GenerateNewKey(batch, chain, internal));\n+    }\n+    if (missing > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065688",
      "id" : 426065688,
      "in_reply_to_id" : 423901460,
      "line" : 319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTY4OA==",
      "original_commit_id" : "a5c3f3218be69ef2a7633bd9fa34963602d1c44f",
      "original_line" : 319,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 37,
      "pull_request_review_id" : 412991594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065688",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065717"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:00:28Z",
      "diff_hunk" : "@@ -319,6 +333,18 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n      */\n     bool ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool, bool fRequestedInternal);\n \n+    /**\n+     * Like TopUp() but adds keys for inactive HD chains.\n+     * Ensures that there are at least -keypool number of keys derived after the given index.\n+     *\n+     * @param seed_id the CKeyID for the HD seed.\n+     * @param index the index to start generating keys from\n+     * @param internal whether the internal chain should be used. true for internal chain, false for external chain.\n+     *\n+     * @@return true if seed was found and keys were derived. false if unable to derive seeds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065717",
      "id" : 426065717,
      "in_reply_to_id" : 423969969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTcxNw==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 344,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 412991631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065717",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065738"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:00:33Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // make sure the keypool fits the user-selected target (-keypool)\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065738",
      "id" : 426065738,
      "in_reply_to_id" : 423983309,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTczOA==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 317,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 412991661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065738",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065764"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065764"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:00:38Z",
      "diff_hunk" : "@@ -304,6 +344,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065764",
      "id" : 426065764,
      "in_reply_to_id" : 423986044,
      "line" : 347,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTc2NA==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 347,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 66,
      "pull_request_review_id" : 412991688,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065764",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065789"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:00:43Z",
      "diff_hunk" : "@@ -304,6 +344,19 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        auto it = mapKeyMetadata.find(keyid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065789",
      "id" : 426065789,
      "in_reply_to_id" : 423988278,
      "line" : 350,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTc4OQ==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 350,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 69,
      "pull_request_review_id" : 412991720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065789",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:00:52Z",
      "diff_hunk" : "@@ -290,6 +293,43 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065841",
      "id" : 426065841,
      "in_reply_to_id" : 424449934,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTg0MQ==",
      "original_commit_id" : "f5eaa90301a946b889a9708631da2a60cf365cdc",
      "original_line" : 310,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 412991773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:00:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065841",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:01:00Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != 0x80000000) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != 0x80000000 && path[1] != (1 | 0x80000000) && (path[2] & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065877",
      "id" : 426065877,
      "in_reply_to_id" : 424575480,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTg3Nw==",
      "original_commit_id" : "9e33fa1b9c1a8c3a20973d4e46a2797324013002",
      "original_line" : 449,
      "original_position" : 55,
      "original_start_line" : 424,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 412991826,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-15T22:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065877",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065902"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:01:06Z",
      "diff_hunk" : "@@ -405,6 +407,62 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index\n+                    if (path.size() != 3) {\n+                        strErr = \"Error reading wallet database: keymeta found with unexpected path\";\n+                        return false;\n+                    }\n+                    if (path[0] != 0x80000000) {\n+                        strErr = \"Unexpected path index for the element at index 0\";\n+                        return false;\n+                    }\n+                    if (path[1] != 0x80000000 && path[1] != (1 | 0x80000000) && (path[2] & 0x80000000)) {\n+                        strErr = \"Unexpected path index for the element at index 1\";\n+                        return false;\n+                    }\n+                    internal = path[1] == (1 | 0x80000000);\n+                    index = path[2] & ~0x80000000;\n+                }\n+\n+                // Insert a new CHDChain, or get the one that already exists\n+                auto ins = wss.m_hd_chains.emplace(keyMeta.hd_seed_id, CHDChain());\n+                CHDChain& chain = ins.first->second;\n+                if (ins.second) {\n+                    // For new chains, we want to default to VERSION_HD_BASE until we see an internal\n+                    chain.nVersion = CHDChain::VERSION_HD_BASE;\n+                    // Set the seed id",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426065902",
      "id" : 426065902,
      "in_reply_to_id" : 424577883,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NTkwMg==",
      "original_commit_id" : "9e33fa1b9c1a8c3a20973d4e46a2797324013002",
      "original_line" : 456,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 412991853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426065902",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426066015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426066015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a call to `AddInactiveHDChain` to `SetHDCHain` which is where chain rotation occurs.\r\n\r\nAlso updated the tests with a third wallet (`restore2`) which is not reloaded. The things that are checked with `restore` are also checked in `restore2`. I've checked that this test fails without the fix.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:01:33Z",
      "diff_hunk" : "@@ -842,7 +895,14 @@ void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n     if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n         throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n \n-    hdChain = chain;\n+    m_hd_chain = chain;\n+}\n+\n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426066015",
      "id" : 426066015,
      "in_reply_to_id" : 424639586,
      "line" : 913,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NjAxNQ==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 913,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 116,
      "pull_request_review_id" : 412992009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:02:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426066015",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426066136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426066136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426066015",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-15T22:01:56Z",
      "diff_hunk" : "@@ -842,7 +895,14 @@ void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n     if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r426066136",
      "id" : 426066136,
      "in_reply_to_id" : 425866177,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2NjEzNg==",
      "original_commit_id" : "218c4f6405df2b389411f8370057319bfdc59f48",
      "original_line" : 895,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 412992159,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-15T22:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426066136",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427600966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427600966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't seem to be used (I can comment it out and the branch still compiles).\r\n\r\nYou're comparing equality of `seed_id`s directly here: https://github.com/bitcoin/bitcoin/pull/17681/files#diff-5462ceb8a760a507152ab8b76bd48774R1084. I suggest you either change that to compare equality of the `CHDChain` objects, or remove this operator overload.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T21:08:31Z",
      "diff_hunk" : "@@ -116,6 +116,11 @@ class CHDChain\n         nInternalChainCounter = 0;\n         seed_id.SetNull();\n     }\n+\n+    bool operator==(const CHDChain& chain) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427600966",
      "id" : 427600966,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYwMDk2Ng==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 120,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : 5,
      "pull_request_review_id" : 414824583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427600966",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427629797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427629797"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this could be updated to say \"If this is the active HDChain, then update the chain model in the database\"",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T22:10:54Z",
      "diff_hunk" : "@@ -989,30 +1059,30 @@ void LegacyScriptPubKeyMan::DeriveNewChildKey(WalletBatch &batch, CKeyMetadata&\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n         if (internal) {\n-            chainChildKey.Derive(childKey, hdChain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.hdKeypath = \"m/0'/1'/\" + ToString(hdChain.nInternalChainCounter) + \"'\";\n+            chainChildKey.Derive(childKey, hd_chain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            metadata.hdKeypath = \"m/0'/1'/\" + ToString(hd_chain.nInternalChainCounter) + \"'\";\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n             metadata.key_origin.path.push_back(1 | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.key_origin.path.push_back(hdChain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            hdChain.nInternalChainCounter++;\n+            metadata.key_origin.path.push_back(hd_chain.nInternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            hd_chain.nInternalChainCounter++;\n         }\n         else {\n-            chainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.hdKeypath = \"m/0'/0'/\" + ToString(hdChain.nExternalChainCounter) + \"'\";\n+            chainChildKey.Derive(childKey, hd_chain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            metadata.hdKeypath = \"m/0'/0'/\" + ToString(hd_chain.nExternalChainCounter) + \"'\";\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n             metadata.key_origin.path.push_back(0 | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.key_origin.path.push_back(hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            hdChain.nExternalChainCounter++;\n+            metadata.key_origin.path.push_back(hd_chain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+            hd_chain.nExternalChainCounter++;\n         }\n     } while (HaveKey(childKey.key.GetPubKey().GetID()));\n     secret = childKey.key;\n-    metadata.hd_seed_id = hdChain.seed_id;\n+    metadata.hd_seed_id = hd_chain.seed_id;\n     CKeyID master_id = masterKey.key.GetPubKey().GetID();\n     std::copy(master_id.begin(), master_id.begin() + 4, metadata.key_origin.fingerprint);\n     metadata.has_key_origin = true;\n     // update the chain model in the database",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427629797",
      "id" : 427629797,
      "line" : 1083,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyOTc5Nw==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 1083,
      "original_position" : 196,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 196,
      "pull_request_review_id" : 414824583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427629797",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427633081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427633081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is really crying out to be cleaned up:\r\n\r\n- there's a bool flag that substantially changes the logic of this function\r\n- the function is called in two places only, once with `true` and once with `false`\r\n- the argument name is confusing enough that it requires an inline comment that explains where the function is being called from.\r\n\r\nIt seems to me that this function should be split into a `WriteHDChain()` and `SetHDChain()` functions.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T22:19:11Z",
      "diff_hunk" : "@@ -839,10 +894,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_KeyStore);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    // memonly == true means we are loading the wallet file",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427633081",
      "id" : 427633081,
      "line" : 897,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzMzA4MQ==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 897,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 99,
      "pull_request_review_id" : 414824583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427633081",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427634413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427634413"
         }
      },
      "author_association" : "MEMBER",
      "body" : "grammar nit: s/it's/its/ :slightly_smiling_face: ",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T22:22:44Z",
      "diff_hunk" : "@@ -290,20 +293,72 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // make sure the keypool fits the user-selected target (-keypool)\n+    int64_t missing = std::max(target_size - kp_size, (int64_t) 0);\n+\n+    if (missing > 0) {\n+        WalletBatch batch(m_storage.GetDatabase());\n+        for (int64_t i = missing; i > 0; --i) {\n+            GenerateNewKey(batch, chain, internal);\n+        }\n+        if (internal) {\n+            WalletLogPrintf(\"inactive seed with id %s added %d internal keys\\n\", HexStr(seed_id), missing);\n+        } else {\n+            WalletLogPrintf(\"inactive seed with id %s added %d keys\\n\", HexStr(seed_id), missing);\n+        }\n+    }\n+    return true;\n+}\n+\n void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n-            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n             MarkReserveKeysAsUsed(mi->second);\n \n             if (!TopUp()) {\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n+\n+        // Find the key's metadata and check if it's seed id (if it has one) is inactive, i.e. it is not the current m_hd_chain seed id.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427634413",
      "id" : 427634413,
      "line" : 348,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzNDQxMw==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 348,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 67,
      "pull_request_review_id" : 414824583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427634413",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427640400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427640400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is only called from within `MarkUnusedAddresses()`, which has already taken this lock. Rather than taking the lock recursively, I think it makes more sense to add an `EXCLUSIVE_LOCKS_REQUIRED` annotation.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T22:39:46Z",
      "diff_hunk" : "@@ -290,20 +293,72 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427640400",
      "id" : 427640400,
      "line" : 298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0MDQwMA==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 298,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 16,
      "pull_request_review_id" : 414824583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427640400",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427646231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427646231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A few suggestions:\r\n\r\n- drop the default constructor. The implicitly-defined default ctor will do exactly the same (ie nothing since this struct has no data members).\r\n- make it a `struct` so you can drop the `public:` access specifier\r\n- put the `operator()` definition on one line:\r\n\r\n```suggestion\r\nstruct KeyIDHasher\r\n{\r\n    size_t operator()(const CKeyID& id) const { return id.GetUint64(0);}\r\n};\r\n```",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T22:56:51Z",
      "diff_hunk" : "@@ -143,6 +145,17 @@ class CKeyPool\n     }\n };\n \n+class KeyIDHasher\n+{\n+public:\n+    KeyIDHasher() {}\n+\n+    size_t operator()(const CKeyID& id) const\n+    {\n+        return id.GetUint64(0);\n+    }\n+};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427646231",
      "id" : 427646231,
      "line" : 158,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NjIzMQ==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 158,
      "original_position" : 23,
      "original_start_line" : 148,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 23,
      "pull_request_review_id" : 414824583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : 148,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-19T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427646231",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427650867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427650867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "45f2f6a\r\n\r\nInstead of commenting parameters inside function it could be on its top comment and name changed to `loading` or `rotating`. IMO function is a bit blurred it sets a chain but also writes it down to DB, and now does also rotation.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T23:10:38Z",
      "diff_hunk" : "@@ -839,12 +839,29 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_KeyStore);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    // memonly == true means we are loading the wallet file\n+    // memonly == false means that the chain is actually being changed",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427650867",
      "id" : 427650867,
      "line" : 898,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1MDg2Nw==",
      "original_commit_id" : "45f2f6a0e8514a0438a87554400bf73cbb90707f",
      "original_line" : 843,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 100,
      "pull_request_review_id" : 414885119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T01:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427650867",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427658889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427658889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427633081\r\n\r\n> This is really crying out to be cleaned up:\r\n\r\nAgree with this, but my immediate reaction here (without looking too deeply) is that the changes suggested here are only tangentially related to this PR and should be made in a separate PR before or after this one. There's already a lot going on here and it seems like you could make similar comments about a lot of the other wallet functions this PR touches.\r\n\r\n> It seems to me that this function should be split into a `WriteHDChain()` and `SetHDChain()` functions.\r\n\r\nAgain didn't look too closely, but a current convention is to have CWallet and KeyMan LoadXXX and AddXXX methods",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-19T23:35:38Z",
      "diff_hunk" : "@@ -839,10 +894,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_KeyStore);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    // memonly == true means we are loading the wallet file",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427658889",
      "id" : 427658889,
      "in_reply_to_id" : 427633081,
      "line" : 897,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1ODg4OQ==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 897,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 99,
      "pull_request_review_id" : 414894667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-19T23:35:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427658889",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427668785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427668785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "45f2f6a\r\n\r\nWhy internal is OR'd with the hardened bit  ? Isn't the hardening implied by `0x80000000` ?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-20T00:06:31Z",
      "diff_hunk" : "@@ -405,6 +407,65 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427668785",
      "id" : 427668785,
      "line" : 433,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2ODc4NQ==",
      "original_commit_id" : "45f2f6a0e8514a0438a87554400bf73cbb90707f",
      "original_line" : 433,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 43,
      "pull_request_review_id" : 414885119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T01:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427668785",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427675389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427675389"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">  the changes suggested here are only tangentially related to this PR\r\n\r\nPrior to this PR, the `memonly` flag only controlled whether the new seed was written to the database. This PR changes things so the majority of the function is in an `if` block that depends on the flag, so I'd argue it's not tangential.\r\n\r\nI think it's fine to do this in a follow-up, but if this PR gets retouched, no problem doing it here either.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-20T00:29:43Z",
      "diff_hunk" : "@@ -839,10 +894,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_KeyStore);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    // memonly == true means we are loading the wallet file",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427675389",
      "id" : 427675389,
      "in_reply_to_id" : 427633081,
      "line" : 897,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NTM4OQ==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 897,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 99,
      "pull_request_review_id" : 414913886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T00:29:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427675389",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427682625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427682625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c93082e\r\n\r\nI think this is right but code could be made more intuitive IMO with better naming.\r\n\r\nAFAICT `target_size` is the size of keypool we want to keep constant. To do so you need to add new keys it after detecting onchain a key to which `index` is passed. We compute the \"detected_diff\" or \"consumed_diff\" based on chain counter tip. And `missing` is a bit deluding, these keys doesn't \"miss\", we just want to achieve constant-size ahead safety buffer.\r\n\r\n```\r\n// We detect that the keypool has been consumed onchain until index. Increase counter by the diff to keep it constant\r\nint64_t keypool_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);\r\nint64_t to_extend = keypool_size + (index + 1) - (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter);\r\n```\r\n\r\nFeel free to ignore, it's really IMO.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-20T00:56:39Z",
      "diff_hunk" : "@@ -290,20 +293,72 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_KeyStore);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427682625",
      "id" : 427682625,
      "line" : 310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MjYyNQ==",
      "original_commit_id" : "c93082ece40b1c72f05b3e2085c022c09eaa4d65",
      "original_line" : 310,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 28,
      "pull_request_review_id" : 414885119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T01:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427682625",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427683281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427683281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c93082e\r\n\r\nI think a better param name for `internal` could be `layout` and comment `which layout chain should be used, either true for internal or false for external\".\r\n\r\nAlso `unable to derive _keys_` or `unable to find HD-chain` ?",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-20T00:59:21Z",
      "diff_hunk" : "@@ -333,6 +333,18 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n      */\n     bool ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool, bool fRequestedInternal);\n \n+    /**\n+     * Like TopUp() but adds keys for inactive HD chains.\n+     * Ensures that there are at least -keypool number of keys derived after the given index.\n+     *\n+     * @param seed_id the CKeyID for the HD seed.\n+     * @param index the index to start generating keys from\n+     * @param internal whether the internal chain should be used. true for internal chain, false for external chain.\n+     *\n+     * @return true if seed was found and keys were derived. false if unable to derive seeds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427683281",
      "id" : 427683281,
      "line" : 344,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MzI4MQ==",
      "original_commit_id" : "c93082ece40b1c72f05b3e2085c022c09eaa4d65",
      "original_line" : 344,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 53,
      "pull_request_review_id" : 414885119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T01:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427683281",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r428219655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428219655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that this should be cleaned up. There are a few other functions that follow this same pattern, so I think it would be better to change them all at the same time in a followup PR.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-20T18:26:54Z",
      "diff_hunk" : "@@ -839,10 +894,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_KeyStore);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    // memonly == true means we are loading the wallet file",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r428219655",
      "id" : 428219655,
      "in_reply_to_id" : 427633081,
      "line" : 897,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxOTY1NQ==",
      "original_commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "original_line" : 897,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 99,
      "pull_request_review_id" : 415603642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T18:26:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428219655",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r428219871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428219871"
         }
      },
      "author_association" : "MEMBER",
      "body" : "see https://github.com/bitcoin/bitcoin/pull/17681#discussion_r427633081",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-20T18:27:19Z",
      "diff_hunk" : "@@ -839,12 +839,29 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_KeyStore);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    // memonly == true means we are loading the wallet file\n+    // memonly == false means that the chain is actually being changed",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r428219871",
      "id" : 428219871,
      "in_reply_to_id" : 427650867,
      "line" : 898,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxOTg3MQ==",
      "original_commit_id" : "45f2f6a0e8514a0438a87554400bf73cbb90707f",
      "original_line" : 843,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 100,
      "pull_request_review_id" : 415604235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T18:27:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428219871",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r428220934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428220934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The meaning is supposed to be that the path vector contains ints that correspond to `0`, `k`, and `i` with those ints being OR'd with the hardened bitmask. I guess it's not very clear and that sentence could probably be dropped.",
      "commit_id" : "1ed52fbb4d81f7b7634fd4fb6d1d00e1478129dc",
      "created_at" : "2020-05-20T18:29:10Z",
      "diff_hunk" : "@@ -405,6 +407,65 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> keyMeta;\n             wss.nKeyMeta++;\n             pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKeyMetadata(vchPubKey.GetID(), keyMeta);\n+\n+            // Extract some CHDChain info from this metadata if it has any\n+            if (keyMeta.nVersion >= CKeyMetadata::VERSION_WITH_HDDATA && !keyMeta.hd_seed_id.IsNull() && keyMeta.hdKeypath.size() > 0) {\n+                // Get the path from the key origin or from the path string\n+                // Not applicable when path is \"s\" as that indicates a seed\n+                bool internal = false;\n+                uint32_t index = 0;\n+                if (keyMeta.hdKeypath != \"s\") {\n+                    std::vector<uint32_t> path;\n+                    if (keyMeta.has_key_origin) {\n+                        // We have a key origin, so pull it from its path vector\n+                        path = keyMeta.key_origin.path;\n+                    } else {\n+                        // No key origin, have to parse the string\n+                        if (!ParseHDKeypath(keyMeta.hdKeypath, path)) {\n+                            strErr = \"Error reading wallet database: keymeta with invalid HD keypath\";\n+                            return false;\n+                        }\n+                    }\n+\n+                    // Extract the index and internal from the path\n+                    // Path string is m/0'/k'/i'\n+                    // Path vector is [0', k', i'] (but as ints OR'd with the hardened bit\n+                    // k == 0 for external, 1 for internal. i is the index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r428220934",
      "id" : 428220934,
      "in_reply_to_id" : 427668785,
      "line" : 433,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyMDkzNA==",
      "original_commit_id" : "45f2f6a0e8514a0438a87554400bf73cbb90707f",
      "original_line" : 433,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 43,
      "pull_request_review_id" : 415606904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428220934",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "With 3 ACKs now, I think the remaining comments can be done in follow up PRs.",
      "created_at" : "2020-05-20T18:42:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-631654435",
      "id" : 631654435,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTY1NDQzNQ==",
      "updated_at" : "2020-05-20T18:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631654435",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
