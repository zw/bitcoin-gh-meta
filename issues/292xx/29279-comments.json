[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29279).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [stratospher](https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1916028804), [epiccurious](https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1937398480) |\n| Concept ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/29279#pullrequestreview-1832560555), [BrandonOdiwuor](https://github.com/bitcoin/bitcoin/pull/29279#pullrequestreview-1833607389) |\n| Stale ACK | [delta1](https://github.com/bitcoin/bitcoin/pull/29279#pullrequestreview-1831909216) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29358](https://github.com/bitcoin/bitcoin/pull/29358) (test: use v2 everywhere for P2PConnection if --v2transport is enabled by mzumsande)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-01-19T02:37:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1899549817",
      "id" : 1899549817,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585xONR5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899549817/reactions"
      },
      "updated_at" : "2024-02-11T02:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899549817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1466564903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466564903"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "358561e: nit: s/0/`NODE_NONE`",
      "commit_id" : "358561e54ef84f64b216ca8a4271ad17d91b1d51",
      "created_at" : "2024-01-25T15:43:48Z",
      "diff_hunk" : "@@ -0,0 +1,46 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check that lacking desired service flags leads to disconnect\")\n+        for i, conn_type in enumerate([\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]):\n+            services = random.choice([0, NODE_NETWORK, NODE_WITNESS])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1466564903",
      "id" : 1466564903,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585XagEn",
      "original_commit_id" : "358561e54ef84f64b216ca8a4271ad17d91b1d51",
      "original_line" : 29,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 29,
      "pull_request_review_id" : 1844051383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466564903/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T15:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466564903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Concept ACK! i think flaky tests are possible because disconnection could happen before [`p2p_conn.wait_for_connect()`](https://github.com/bitcoin/bitcoin/blob/7699a1aab8fa2a7a602391025f3cfcde29ff2613/test/functional/test_framework/test_node.py#L728) in `add_outbound_connection()`?\r\n\r\nTrue, good catch. The flaky case can be reproduced by adding an artificial delay before the `wait_for_connect()` call, e.g.:\r\n```diff\r\ndiff --git a/test/functional/test_framework/test_node.py b/test/functional/test_framework/test_node.py\r\nindex 77f6e69e98..4aa54fa64a 100755\r\n--- a/test/functional/test_framework/test_node.py\r\n+++ b/test/functional/test_framework/test_node.py\r\n@@ -725,6 +725,7 @@ class TestNode():\r\n             p2p_conn.wait_until(lambda: p2p_conn.message_count[\"version\"] == 1, check_connected=False)\r\n             p2p_conn.wait_until(lambda: not p2p_conn.is_connected, check_connected=False)\r\n         else:\r\n+            time.sleep(1)\r\n             p2p_conn.wait_for_connect()\r\n             self.p2ps.append(p2p_conn)\r\n```\r\nI guess one solution could be to add a `send_version` parameter to `add_outbound_p2p_connection` (like `add_p2p_connection` already has) to prevent the immediate sending of the version message. We could set that to `false` in the test and send the version message triggering the disconnect manually. Will set the PR to draft state until I have something working.",
      "created_at" : "2024-01-25T17:52:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1910708559",
      "id" : 1910708559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585x4xlP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910708559/reactions"
      },
      "updated_at" : "2024-01-25T17:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910708559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Solved the [flaky test issue](https://github.com/bitcoin/bitcoin/pull/29279#pullrequestreview-1844051383) by introducing a `wait_for_disconnect` parameter to `add_p2p_outbound_connection`, which hits the same code path as for feeler connections if set (i.e. waiting for immediate disconnect).",
      "created_at" : "2024-01-26T02:53:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1911327678",
      "id" : 1911327678,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585x7Iu-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1911327678/reactions"
      },
      "updated_at" : "2024-01-26T02:53:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1911327678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1469196012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469196012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ff5f994: nit: `NODE_NONE` here too?",
      "commit_id" : "ff5f99400a34b6ad0913068616580ad615fb3158",
      "created_at" : "2024-01-29T07:56:29Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,\n+            connection_type=connection_type, services=services)\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check that lacking desired service flags leads to disconnect\")\n+        for i, conn_type in enumerate([\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]):\n+            services = random.choice([NODE_NONE, NODE_NETWORK, NODE_WITNESS])\n+            assert (services & DESIRABLE_SERVICE_FLAGS) != DESIRABLE_SERVICE_FLAGS\n+            expected_debug_log = f'peer={i} does not offer the expected services ' \\\n+                    f'({services:08x} offered, {DESIRABLE_SERVICE_FLAGS:08x} expected)'\n+            self.log.info(f'    - services 0x{services:08x}, type \"{conn_type}\"')\n+            with node.assert_debug_log([expected_debug_log]):\n+                self.check_outbound_disconnect(node, i, conn_type, services)\n+\n+        self.log.info(\"Check that feeler connections get disconnected immediately\")\n+        with node.assert_debug_log([\"feeler connection completed\"]):\n+            self.check_outbound_disconnect(node, i+1, \"feeler\", 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1469196012",
      "id" : 1469196012,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585Xkibs",
      "original_commit_id" : "ff5f99400a34b6ad0913068616580ad615fb3158",
      "original_line" : 45,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 45,
      "pull_request_review_id" : 1848022516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469196012/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-29T07:57:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469196012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-01-29T18:08:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1915291442",
      "id" : 1915291442,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585yKQcy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1915291442/reactions"
      },
      "updated_at" : "2024-01-29T18:08:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1915291442",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on master (after the merge of #24748 :tada: ), and tackled https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1469196012. Note that I tried enabling v2 transport for this test, but it seems that it is non-trivial and needs some deeper changes in the test framework regarding the order of version messages sent (see slightly related comment https://mirror.b10c.me/bitcoin-bitcoin/24748/#discussion_r1465420112). Will tackle that in a follow-up.",
      "created_at" : "2024-01-29T22:59:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1915723249",
      "id" : 1915723249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585yL53x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1915723249/reactions"
      },
      "updated_at" : "2024-01-29T22:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1915723249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK d82eafb173d6bfa98a59e86a845013cc8528b65d.",
      "created_at" : "2024-01-30T03:56:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1916028804",
      "id" : 1916028804,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585yNEeE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1916028804/reactions"
      },
      "updated_at" : "2024-01-30T03:56:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1916028804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1476384709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1476384709"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ACK d82eafb173d6bfa98a59e86a845013cc8528b65d\r\nnit: Why not enumerate all combinations of services and connection types here?",
      "commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "created_at" : "2024-02-02T17:10:51Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,\n+            connection_type=connection_type, services=services)\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check that lacking desired service flags leads to disconnect\")\n+        for i, conn_type in enumerate([\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]):\n+            services = random.choice([NODE_NONE, NODE_NETWORK, NODE_WITNESS])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1476384709",
      "id" : 1476384709,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585X_9fF",
      "original_commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 35,
      "pull_request_review_id" : 1859818643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1476384709/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-02T17:12:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1476384709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1485426813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1485426813"
         }
      },
      "author_association" : "NONE",
      "body" : "ACK this nit. Any reason to not include all here?",
      "commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "created_at" : "2024-02-11T02:23:27Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,\n+            connection_type=connection_type, services=services)\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check that lacking desired service flags leads to disconnect\")\n+        for i, conn_type in enumerate([\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]):\n+            services = random.choice([NODE_NONE, NODE_NETWORK, NODE_WITNESS])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1485426813",
      "id" : 1485426813,
      "in_reply_to_id" : 1476384709,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585YidB9",
      "original_commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 35,
      "pull_request_review_id" : 1874291570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1485426813/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-11T02:23:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1485426813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/109078515?v=4",
         "events_url" : "https://api.github.com/users/epiccurious/events{/privacy}",
         "followers_url" : "https://api.github.com/users/epiccurious/followers",
         "following_url" : "https://api.github.com/users/epiccurious/following{/other_user}",
         "gists_url" : "https://api.github.com/users/epiccurious/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/epiccurious",
         "id" : 109078515,
         "login" : "epiccurious",
         "node_id" : "U_kgDOBoBn8w",
         "organizations_url" : "https://api.github.com/users/epiccurious/orgs",
         "received_events_url" : "https://api.github.com/users/epiccurious/received_events",
         "repos_url" : "https://api.github.com/users/epiccurious/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/epiccurious/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/epiccurious/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/epiccurious"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> good to include a test case ... only connect to NODE_NETWORK_LIMITED peers when the local chain is within 24h window from the tip\n\nACK",
      "created_at" : "2024-02-11T02:27:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1937398262",
      "id" : 1937398262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585zeln2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1937398262/reactions"
      },
      "updated_at" : "2024-02-11T02:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1937398262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/109078515?v=4",
         "events_url" : "https://api.github.com/users/epiccurious/events{/privacy}",
         "followers_url" : "https://api.github.com/users/epiccurious/followers",
         "following_url" : "https://api.github.com/users/epiccurious/following{/other_user}",
         "gists_url" : "https://api.github.com/users/epiccurious/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/epiccurious",
         "id" : 109078515,
         "login" : "epiccurious",
         "node_id" : "U_kgDOBoBn8w",
         "organizations_url" : "https://api.github.com/users/epiccurious/orgs",
         "received_events_url" : "https://api.github.com/users/epiccurious/received_events",
         "repos_url" : "https://api.github.com/users/epiccurious/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/epiccurious/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/epiccurious/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/epiccurious"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "utACK d82eafb173d6bfa98a59e86a845013cc8528b65d.",
      "created_at" : "2024-02-11T02:28:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#issuecomment-1937398480",
      "id" : 1937398480,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29279",
      "node_id" : "IC_kwDOABII585zelrQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1937398480/reactions"
      },
      "updated_at" : "2024-02-11T02:28:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1937398480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/109078515?v=4",
         "events_url" : "https://api.github.com/users/epiccurious/events{/privacy}",
         "followers_url" : "https://api.github.com/users/epiccurious/followers",
         "following_url" : "https://api.github.com/users/epiccurious/following{/other_user}",
         "gists_url" : "https://api.github.com/users/epiccurious/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/epiccurious",
         "id" : 109078515,
         "login" : "epiccurious",
         "node_id" : "U_kgDOBoBn8w",
         "organizations_url" : "https://api.github.com/users/epiccurious/orgs",
         "received_events_url" : "https://api.github.com/users/epiccurious/received_events",
         "repos_url" : "https://api.github.com/users/epiccurious/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/epiccurious/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/epiccurious/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/epiccurious"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1493880488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493880488"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: since we wait for the disconnect anyway it seems that passing a different `p2p_idx` each time isn't necessary, so the test could be simplified a tiny bit",
      "commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "created_at" : "2024-02-18T23:59:37Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1493880488",
      "id" : 1493880488,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585ZCs6o",
      "original_commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 28,
      "pull_request_review_id" : 1887366958,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493880488/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-19T00:04:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1493880488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1500061904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500061904"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Benefits of enumerating: tests will be comprehensive and ensure that results can be consistently reproduced on every run, instead of being possibly flaky.\nCosts: 9 instead of 3 iterations of this case.\n\nSeems to weigh in favor of iteration - imo our tests should tend towards comprehensive and consistent.",
      "commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "created_at" : "2024-02-22T23:24:59Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,\n+            connection_type=connection_type, services=services)\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check that lacking desired service flags leads to disconnect\")\n+        for i, conn_type in enumerate([\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]):\n+            services = random.choice([NODE_NONE, NODE_NETWORK, NODE_WITNESS])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1500061904",
      "id" : 1500061904,
      "in_reply_to_id" : 1476384709,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585ZaSDQ",
      "original_commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 35,
      "pull_request_review_id" : 1897158239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500061904/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T23:24:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500061904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1500617601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500617601"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry for the extra-late reply! I agree that enumerating through the combinations makes sense. Since there is already a good number of ACKs, I prefer to tackle that in a follow-up, together with other proposed changes / new test coverage ideas (e.g. https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1493880488 and https://github.com/bitcoin/bitcoin/pull/29279#pullrequestreview-1860288188).",
      "commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "created_at" : "2024-02-23T12:51:58Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,\n+            connection_type=connection_type, services=services)\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check that lacking desired service flags leads to disconnect\")\n+        for i, conn_type in enumerate([\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]):\n+            services = random.choice([NODE_NONE, NODE_NETWORK, NODE_WITNESS])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1500617601",
      "id" : 1500617601,
      "in_reply_to_id" : 1476384709,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585ZcZuB",
      "original_commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 35,
      "pull_request_review_id" : 1898038086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500617601/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-23T12:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500617601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1500775238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500775238"
         }
      },
      "author_association" : "NONE",
      "body" : "(ACKing nit).",
      "commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "created_at" : "2024-02-23T14:49:55Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,\n+            connection_type=connection_type, services=services)\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check that lacking desired service flags leads to disconnect\")\n+        for i, conn_type in enumerate([\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]):\n+            services = random.choice([NODE_NONE, NODE_NETWORK, NODE_WITNESS])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1500775238",
      "id" : 1500775238,
      "in_reply_to_id" : 1476384709,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII585ZdANG",
      "original_commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 35,
      "pull_request_review_id" : 1898294548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500775238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-23T14:52:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1500775238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1506397638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506397638"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch, done. The `p2p_idx` is now passed with a fixed value of zero.",
      "commit_id" : "2f5b69eaeb623a7b0306e7f41fd2d28741f131c0",
      "created_at" : "2024-02-28T18:26:30Z",
      "diff_hunk" : "@@ -0,0 +1,49 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2024 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test P2P behaviour during the handshake phase (VERSION, VERACK messages).\n+\"\"\"\n+import random\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    NODE_NETWORK,\n+    NODE_NONE,\n+    NODE_WITNESS,\n+)\n+from test_framework.p2p import P2PInterface\n+\n+\n+DESIRABLE_SERVICE_FLAGS = NODE_NETWORK | NODE_WITNESS\n+\n+\n+class P2PHandshakeTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def check_outbound_disconnect(self, node, p2p_idx, connection_type, services):\n+        node.add_outbound_p2p_connection(\n+            P2PInterface(), p2p_idx=p2p_idx, wait_for_disconnect=True,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1506397638",
      "id" : 1506397638,
      "in_reply_to_id" : 1493880488,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Zyc3G",
      "original_commit_id" : "d82eafb173d6bfa98a59e86a845013cc8528b65d",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : null,
      "pull_request_review_id" : 1906971931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506397638/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-28T18:26:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506397638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1506601610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506601610"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: This is a bit redundant. Either mining the block or changing the mock time alone will make the following test succeed.",
      "commit_id" : "2f5b69eaeb623a7b0306e7f41fd2d28741f131c0",
      "created_at" : "2024-02-28T20:13:45Z",
      "diff_hunk" : "@@ -60,6 +62,13 @@ def run_test(self):\n         self.test_desirable_service_flags(node, [NODE_NONE, NODE_NETWORK, NODE_WITNESS], expect_disconnect=True)\n         self.test_desirable_service_flags(node, [NODE_NETWORK | NODE_WITNESS], expect_disconnect=False)\n \n+        self.log.info(\"Check that limited peers are only desired if the local chain is close to the tip (<24h)\")\n+        node.setmocktime(int(time.time()) + 25 * 3600)  # tip outside the 24h window, should fail\n+        self.test_desirable_service_flags(node, [NODE_NETWORK_LIMITED | NODE_WITNESS], expect_disconnect=True)\n+        self.generate(node, 1)  # catch up by mining a block\n+        node.setmocktime(int(time.time()) + 23 * 3600)  # tip inside the 24h window, should succeed",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29279#discussion_r1506601610",
      "id" : 1506601610,
      "line" : 69,
      "node_id" : "PRRC_kwDOABII585ZzOqK",
      "original_commit_id" : "2f5b69eaeb623a7b0306e7f41fd2d28741f131c0",
      "original_line" : 69,
      "original_position" : 21,
      "original_start_line" : 68,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 21,
      "pull_request_review_id" : 1907319830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29279",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506601610/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 68,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-02-28T20:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1506601610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
