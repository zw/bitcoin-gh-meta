[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29242).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [murchandamus](https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1924448996) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29306](https://github.com/bitcoin/bitcoin/pull/29306) (policy: enable sibling eviction for v3 transactions by glozow)\n* [#29256](https://github.com/bitcoin/bitcoin/pull/29256) (Improve new LogDebug/Trace/Info/Warning/Error Macros by ryanofsky)\n* [#29015](https://github.com/bitcoin/bitcoin/pull/29015) (kernel: Streamline util library by ryanofsky)\n* [#28984](https://github.com/bitcoin/bitcoin/pull/28984) (Cluster size 2 package rbf by instagibbs)\n* [#28960](https://github.com/bitcoin/bitcoin/pull/28960) (kernel: Remove dependency on CScheduler by TheCharlatan)\n* [#28948](https://github.com/bitcoin/bitcoin/pull/28948) (v3 transaction policy for anti-pinning by glozow)\n* [#28886](https://github.com/bitcoin/bitcoin/pull/28886) (refactor: Replace sets of txiter with CTxMemPoolEntryRefs by TheCharlatan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-01-12T18:07:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1889741023",
      "id" : 1889741023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585woyjf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1889741023/reactions"
      },
      "updated_at" : "2024-02-02T18:23:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1889741023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/20435922692</sub>",
      "created_at" : "2024-01-12T18:29:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1889768276",
      "id" : 1889768276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585wo5NU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1889768276/reactions"
      },
      "updated_at" : "2024-01-12T18:29:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1889768276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ready for review\r\n\r\ncc @glozow @ismaelsadeeq @achow101 ",
      "created_at" : "2024-01-12T21:38:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1889982713",
      "id" : 1889982713,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585wptj5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1889982713/reactions"
      },
      "updated_at" : "2024-01-12T21:38:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1889982713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453480372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453480372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    /** Add fee and size of another FeeFrac to this one. */\r\n    void inline operator+=(const FeeFrac& other) noexcept\r\n    {\r\n        fee += other.fee;\r\n        size += other.size;\r\n    }\r\n\r\n    /** Subtrack fee and size of another FeeFrac from this one. */\r\n```",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T14:09:34Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <assert.h>\n+#include <stdint.h>\n+#include <algorithm>\n+#include <compare>\n+#include <vector>\n+\n+namespace {\n+\n+inline std::pair<int64_t, uint64_t> Mul128(int64_t a, int64_t b)\n+{\n+#ifdef __SIZEOF_INT128__\n+    __int128 ret = (__int128)a * b;\n+    return {ret >> 64, ret};\n+#else\n+    uint64_t ll = (uint64_t)(uint32_t)a * (uint32_t)b;\n+    int64_t lh = (uint32_t)a * (b >> 32);\n+    int64_t hl = (a >> 32) * (uint32_t)b;\n+    int64_t hh = (a >> 32) * (b >> 32);\n+    uint64_t mid34 = (ll >> 32) + (uint32_t)lh + (uint32_t)hl;\n+    int64_t hi = hh + (lh >> 32) + (hl >> 32) + (mid34 >> 32);\n+    uint64_t lo = (mid34 << 32) + (uint32_t)ll;\n+    return {hi, lo};\n+#endif\n+}\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (==, !=, >, <, >=, <=, <=>) respect this ordering.\n+ *\n+ * The >> and << operators only compare feerate and treat equal feerate but different size as\n+ * equivalent. The empty FeeFrac is neither lower or higher in feerate than any other.\n+ * The FeeRateCompare function returns the three-way comparison for this order.\n+ */\n+struct FeeFrac\n+{\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t s, int32_t b) noexcept : fee{s}, size{b}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        assert(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add size and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+    }\n+\n+    /** Subtrack size and size of another FeeFrac from this one. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453480372",
      "id" : 1453480372,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585Wolm0",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 91,
      "original_position" : 91,
      "original_start_line" : 84,
      "path" : "src/util/feefrac.h",
      "position" : 91,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453480372/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 84,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453480372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453480679"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453480679"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reserve here?\r\n```suggestion\r\n    diagram.clear();\r\n    diagram.reserve(chunks.size() + 1);\r\n```",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T14:09:41Z",
      "diff_hunk" : "@@ -0,0 +1,21 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+\n+void BuildDiagramFromUnsortedChunks(std::vector<FeeFrac>& chunks, std::vector<FeeFrac>& diagram)\n+{\n+    diagram.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453480679",
      "id" : 1453480679,
      "line" : 9,
      "node_id" : "PRRC_kwDOABII585Wolrn",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/util/feefrac.cpp",
      "position" : 9,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453480679/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453480679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453482107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453482107"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for this return here\r\n```suggestion\r\n}\r\n```",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T14:10:20Z",
      "diff_hunk" : "@@ -0,0 +1,21 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+\n+void BuildDiagramFromUnsortedChunks(std::vector<FeeFrac>& chunks, std::vector<FeeFrac>& diagram)\n+{\n+    diagram.clear();\n+    // Finish by sorting the chunks we calculated, and then accumulating them.\n+    std::sort(chunks.begin(), chunks.end(), [](const FeeFrac& a, const FeeFrac& b) { return a > b; });\n+\n+    // And now build the diagram for these chunks.\n+    diagram.emplace_back(0, 0);\n+    for (auto& chunk : chunks) {\n+        FeeFrac& last = diagram.back();\n+        diagram.emplace_back(last.fee+chunk.fee, last.size+chunk.size);\n+    }\n+    return;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453482107",
      "id" : 1453482107,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585WomB7",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : 19,
      "path" : "src/util/feefrac.cpp",
      "position" : 20,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453482107/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 19,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453482107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453487633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453487633"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe add a docstring on what `BuildDiagramFromUnsortedChunks` does in and out params description that are doxygen compatible?",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T14:14:22Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <assert.h>\n+#include <stdint.h>\n+#include <algorithm>\n+#include <compare>\n+#include <vector>\n+\n+namespace {\n+\n+inline std::pair<int64_t, uint64_t> Mul128(int64_t a, int64_t b)\n+{\n+#ifdef __SIZEOF_INT128__\n+    __int128 ret = (__int128)a * b;\n+    return {ret >> 64, ret};\n+#else\n+    uint64_t ll = (uint64_t)(uint32_t)a * (uint32_t)b;\n+    int64_t lh = (uint32_t)a * (b >> 32);\n+    int64_t hl = (a >> 32) * (uint32_t)b;\n+    int64_t hh = (a >> 32) * (b >> 32);\n+    uint64_t mid34 = (ll >> 32) + (uint32_t)lh + (uint32_t)hl;\n+    int64_t hi = hh + (lh >> 32) + (hl >> 32) + (mid34 >> 32);\n+    uint64_t lo = (mid34 << 32) + (uint32_t)ll;\n+    return {hi, lo};\n+#endif\n+}\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (==, !=, >, <, >=, <=, <=>) respect this ordering.\n+ *\n+ * The >> and << operators only compare feerate and treat equal feerate but different size as\n+ * equivalent. The empty FeeFrac is neither lower or higher in feerate than any other.\n+ * The FeeRateCompare function returns the three-way comparison for this order.\n+ */\n+struct FeeFrac\n+{\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t s, int32_t b) noexcept : fee{s}, size{b}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        assert(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add size and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+    }\n+\n+    /** Subtrack size and size of another FeeFrac from this one. */\n+    void inline operator-=(const FeeFrac& other) noexcept\n+    {\n+        fee -= other.fee;\n+        size -= other.size;\n+        assert(size != 0 || fee == 0);\n+    }\n+\n+    /** Sum fee and size. */\n+    friend inline FeeFrac operator+(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee + b.fee, a.size + b.size};\n+    }\n+\n+    /** Subtract both fee and size. */\n+    friend inline FeeFrac operator-(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee - b.fee, a.size - b.size};\n+    }\n+\n+    /** Check if two FeeFrac objects are equal (both same fee and same size). */\n+    friend inline bool operator==(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee == b.fee && a.size == b.size;\n+    }\n+\n+    friend inline std::strong_ordering FeeRateCompare(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        if (a.fee > INT32_MAX || a.fee < INT32_MIN || b.fee > INT32_MAX || b.fee < INT32_MIN) {\n+            auto a_cross = Mul128(a.fee, b.size);\n+            auto b_cross = Mul128(b.fee, a.size);\n+            return a_cross <=> b_cross;\n+        } else {\n+            auto a_cross = a.fee * b.size;\n+            auto b_cross = b.fee * a.size;\n+            return a_cross <=> b_cross;\n+        }\n+    }\n+\n+    friend inline std::strong_ordering operator<=>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto feerate_cmp = FeeRateCompare(a, b);\n+        if (feerate_cmp != 0) return feerate_cmp; // NOLINT(modernize-use-nullptr)\n+        return b.size <=> a.size;\n+    }\n+\n+    /** Check if a FeeFrac object has strictly lower feerate than another. */\n+    friend inline bool operator<<(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return FeeRateCompare(a, b) < 0; // NOLINT(modernize-use-nullptr)\n+    }\n+\n+    /** Check if a FeeFrac object has strictly higher feerate than another. */\n+    friend inline bool operator>>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return FeeRateCompare(a, b) > 0; // NOLINT(modernize-use-nullptr)\n+    }\n+\n+    friend inline void swap(FeeFrac& a, FeeFrac& b) noexcept\n+    {\n+        std::swap(a.fee, b.fee);\n+        std::swap(a.size, b.size);\n+    }\n+};\n+\n+void BuildDiagramFromUnsortedChunks(std::vector<FeeFrac>& chunks, std::vector<FeeFrac>& diagram);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453487633",
      "id" : 1453487633,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII585WonYR",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 156,
      "original_position" : 156,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : 156,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453487633/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453487633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453501485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453501485"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: we can just use the empty constructor\r\n```suggestion\r\n    FeeFrac empty{};\r\n```",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T14:24:35Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};\n+    FeeFrac empty{0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453501485",
      "id" : 1453501485,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII585Woqwt",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 17,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453501485/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453501485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453502118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453502118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why can we have negative size ?",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T14:25:01Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453502118",
      "id" : 1453502118,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585Woq6m",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 16,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453502118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453502118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453604924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453604924"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you mean `all_conflicts` here\r\n```suggestion\r\n    // old diagram will consist of each element of all_conflicts either at\r\n```",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T15:36:53Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453604924",
      "id" : 1453604924,
      "line" : 1305,
      "node_id" : "PRRC_kwDOABII585WpEA8",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1305,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 65,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453604924/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453604924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453612523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453612523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "use static cast?\r\n```suggestion\r\n            FeeFrac package{txiter->GetModFeesWithAncestors(), static_cast<int32_t>(txiter->GetSizeWithAncestors())};\r\n```",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T15:42:19Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // Compute OLD chunks for all clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), int32_t(txiter->GetSizeWithAncestors())};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453612523",
      "id" : 1453612523,
      "line" : 1327,
      "node_id" : "PRRC_kwDOABII585WpF3r",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1327,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 87,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453612523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453612523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453626393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453626393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I understand what happens here but its a bit confusing to me the short forms `CON`, `CNK` `DIAGRAM`\r\nWill prefer something like the compute in computing the `OLD` chunk\r\n\r\n```suggestion\r\n    // Step 2: build the new diagram\r\n\r\n    // Add any parents of direct conflicts that are not conflicted themselves into the NEW chunk\r\n    for (auto direct_conflict : direct_conflicts) {\r\n        // If a direct conflict has an ancestor that is not in all_conflicts,\r\n        // it can be affected by the replacement of the child.\r\n        if (direct_conflict->GetMemPoolParentsConst().size() > 0) {\r\n            // Grab the parent.\r\n            const CTxMemPoolEntry& parent = direct_conflict->GetMemPoolParentsConst().begin()->get();\r\n            if (!all_conflicts.count(mapTx.iterator_to(parent))) {\r\n                // This transaction would be left over, so add to the NEW\r\n                // chunk.\r\n                new_chunks.emplace_back(parent.GetModifiedFee(), parent.GetTxSize());\r\n            }\r\n        }\r\n    }\r\n    // Add the replacement package to NEW\r\n    new_chunks.emplace_back(replacement_fees, int32_t(replacement_vsize));\r\n```",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T15:52:23Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // Compute OLD chunks for all clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), int32_t(txiter->GetSizeWithAncestors())};\n+            if (individual > package) {\n+                // The individual feerate is higher than the package, and\n+                // therefore higher than the parent's fee. Chunk these\n+                // together.\n+                old_chunks.emplace_back(package);\n+            } else {\n+                // Add two points, one for the parent and one for this child.\n+                old_chunks.emplace_back(package-individual);\n+                old_chunks.emplace_back(individual);\n+            }\n+        } else {\n+            old_chunks.emplace_back(individual);\n+        }\n+    }\n+\n+    // No topology restrictions post-chunking; sort\n+    BuildDiagramFromUnsortedChunks(old_chunks, old_diagram);\n+\n+    std::vector<FeeFrac> new_chunks;\n+\n+    // Step 2: build the NEW = OLD - CON + CNK diagram\n+\n+    // OLD - CON: Any parents of direct conflicts that are not conflicted themselves\n+    for (auto direct_conflict : direct_conflicts) {\n+        // If a direct conflict has an ancestor that is not in all_conflicts,\n+        // it can be affected by the replacement of the child.\n+        if (direct_conflict->GetMemPoolParentsConst().size() > 0) {\n+            // Grab the parent.\n+            const CTxMemPoolEntry& parent = direct_conflict->GetMemPoolParentsConst().begin()->get();\n+            if (!all_conflicts.count(mapTx.iterator_to(parent))) {\n+                // This transaction would be left over, so add to the new\n+                // diagram.\n+                new_chunks.emplace_back(parent.GetModifiedFee(), parent.GetTxSize());\n+            }\n+        }\n+    }\n+    // + CNK\n+    new_chunks.emplace_back(replacement_fees, int32_t(replacement_vsize));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453626393",
      "id" : 1453626393,
      "line" : 1365,
      "node_id" : "PRRC_kwDOABII585WpJQZ",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1365,
      "original_position" : 125,
      "original_start_line" : 1348,
      "path" : "src/txmempool.cpp",
      "position" : 125,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453626393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1348,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453626393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453667765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453667765"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should forward the detailed error message also?",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-16T16:23:36Z",
      "diff_hunk" : "@@ -181,3 +201,108 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n     }\n     return std::nullopt;\n }\n+\n+// Compare two feerate points, where one of the points is interpolated from\n+// existing points in a feerate diagram.\n+// Return 1 if the interpolated point is greater than fee_compare; 0 if they\n+// are equal; -1 otherwise.\n+int InterpolateValueAndCompare(int64_t eval_size, const FeeFrac& p1, const FeeFrac& p2, CAmount fee_compare)\n+{\n+    // Interpolate between two points using the formula:\n+    // y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)\n+    // i.e.\n+    // y = p1.fee + (eval_size - p1.size) * (p2.fee - p1.fee) / (p2.size - p2.size)\n+    // fee_compare = fee value we want to compare against the interpolated y\n+    //\n+    // Then evaluating y > fee_compare is equivalent to checking if y*(x2-x1) > fee_compare*(x2-x1),\n+    // or y1*(x2-x1) + (x - x1) * (y2 - y1) > fee_compare*(x2-x1).\n+    const auto fee_compare_scaled = Mul128(fee_compare, p2.size - p1.size);\n+    const auto y_scaled = Add128(Mul128(p1.fee, p2.size - p1.size), Mul128(eval_size - p1.size , p2.fee - p1.fee));\n+\n+    if (y_scaled > fee_compare_scaled) {\n+        return 1;\n+    } else if (y_scaled == fee_compare_scaled) {\n+        return 0;\n+    } else {\n+        return -1;\n+    }\n+}\n+\n+// returns true if the new_diagram is strictly better than the old one; false\n+// otherwise.\n+bool CompareFeerateDiagram(std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    size_t old_index=0;\n+    size_t new_index=0;\n+\n+    // whether the new diagram has at least one point better than old_diagram\n+    bool new_better = false;\n+\n+    // whether the old diagram has at least one point better than new_diagram\n+    bool old_better = false;\n+\n+    // Diagrams should be non-empty, and first elements zero in size and fee\n+    Assert(!old_diagram.empty() && !new_diagram.empty());\n+    Assert(old_diagram[0].fee == 0 && old_diagram[0].size == 0);\n+    Assert(new_diagram[0].fee == 0 && new_diagram[0].size == 0);\n+\n+    // Start by padding the smaller diagram with a transaction that pays the\n+    // tail feerate up to the size of the larger diagram.\n+    // For now, use an implicit tail feerate of 0, but we can change this if\n+    // there's an argument to be made that the true tail feerate is higher.\n+    // Also, if we end up needing to transform the feerates (eg to avoid\n+    // negative numbers or overflow in the calculations?), then the tail\n+    // feerate would need to be transformed as well.\n+    if (old_diagram.back().size < new_diagram.back().size) {\n+        old_diagram.emplace_back(old_diagram.back().fee, new_diagram.back().size);\n+    } else if (old_diagram.back().size > new_diagram.back().size) {\n+        new_diagram.emplace_back(new_diagram.back().fee, old_diagram.back().size);\n+    }\n+\n+    while (old_index < old_diagram.size() && new_index < new_diagram.size()) {\n+        int cmp = 0;\n+        if (old_diagram[old_index].size < new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(old_diagram[old_index].size, new_diagram[new_index-1], new_diagram[new_index], old_diagram[old_index].fee);\n+            old_better |= (cmp == -1);\n+            new_better |= (cmp == 1);\n+            old_index++;\n+        } else if (old_diagram[old_index].size > new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(new_diagram[new_index].size, old_diagram[old_index-1], old_diagram[old_index], new_diagram[new_index].fee);\n+            old_better |= (cmp == 1);\n+            new_better |= (cmp == -1);\n+            new_index++;\n+        } else {\n+            if (old_diagram[old_index].fee > new_diagram[new_index].fee) {\n+                old_better = true;\n+            } else if (old_diagram[old_index].fee < new_diagram[new_index].fee) {\n+                new_better = true;\n+            }\n+            old_index++;\n+            new_index++;\n+        }\n+    }\n+\n+    // New is better at least one point, and at least as good on all points; we'll take it\n+    return new_better && !old_better;\n+}\n+\n+std::optional<std::string> ImprovesFeerateDiagram(CTxMemPool& pool,\n+                                                const CTxMemPool::setEntries& direct_conflicts,\n+                                                const CTxMemPool::setEntries& all_conflicts,\n+                                                int64_t replacement_vsize,\n+                                                CAmount replacement_fees)\n+{\n+    // Require that the replacement strictly improve the mempool's fee vs. size diagram.\n+    std::vector<FeeFrac> old_diagram, new_diagram;\n+\n+    const auto err_string{pool.CalculateFeerateDiagramsForRBF(replacement_fees, replacement_vsize, direct_conflicts, all_conflicts, old_diagram, new_diagram)};\n+\n+    if (err_string.has_value()) {\n+        return strprintf(\"unable to compute mining score\");\n+    }\n+\n+    if (!CompareFeerateDiagram(old_diagram, new_diagram)) {\n+        return strprintf(\"insufficient feerate\");\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1453667765",
      "id" : 1453667765,
      "line" : 306,
      "node_id" : "PRRC_kwDOABII585WpTW1",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 306,
      "original_position" : 133,
      "original_start_line" : 300,
      "path" : "src/policy/rbf.cpp",
      "position" : 133,
      "pull_request_review_id" : 1823506588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453667765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 300,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453667765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455418545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455418545"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Even better, I'll add a test that they're the same",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T12:19:19Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};\n+    FeeFrac empty{0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455418545",
      "id" : 1455418545,
      "in_reply_to_id" : 1453501485,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII585Wv-yx",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 17,
      "pull_request_review_id" : 1827173808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455418545/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-17T12:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455418545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455423851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455423851"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These are shorthand labels from https://delvingbitcoin.org/t/post-clustermempool-package-rbf-per-chunk-processing/190 which helped me think through preciesely how it maps onto the concepts laid out.\r\n\r\nI'd like to keep track of these ideas somehow, maybe by defining the labels?",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T12:21:54Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // Compute OLD chunks for all clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), int32_t(txiter->GetSizeWithAncestors())};\n+            if (individual > package) {\n+                // The individual feerate is higher than the package, and\n+                // therefore higher than the parent's fee. Chunk these\n+                // together.\n+                old_chunks.emplace_back(package);\n+            } else {\n+                // Add two points, one for the parent and one for this child.\n+                old_chunks.emplace_back(package-individual);\n+                old_chunks.emplace_back(individual);\n+            }\n+        } else {\n+            old_chunks.emplace_back(individual);\n+        }\n+    }\n+\n+    // No topology restrictions post-chunking; sort\n+    BuildDiagramFromUnsortedChunks(old_chunks, old_diagram);\n+\n+    std::vector<FeeFrac> new_chunks;\n+\n+    // Step 2: build the NEW = OLD - CON + CNK diagram\n+\n+    // OLD - CON: Any parents of direct conflicts that are not conflicted themselves\n+    for (auto direct_conflict : direct_conflicts) {\n+        // If a direct conflict has an ancestor that is not in all_conflicts,\n+        // it can be affected by the replacement of the child.\n+        if (direct_conflict->GetMemPoolParentsConst().size() > 0) {\n+            // Grab the parent.\n+            const CTxMemPoolEntry& parent = direct_conflict->GetMemPoolParentsConst().begin()->get();\n+            if (!all_conflicts.count(mapTx.iterator_to(parent))) {\n+                // This transaction would be left over, so add to the new\n+                // diagram.\n+                new_chunks.emplace_back(parent.GetModifiedFee(), parent.GetTxSize());\n+            }\n+        }\n+    }\n+    // + CNK\n+    new_chunks.emplace_back(replacement_fees, int32_t(replacement_vsize));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455423851",
      "id" : 1455423851,
      "in_reply_to_id" : 1453626393,
      "line" : 1365,
      "node_id" : "PRRC_kwDOABII585WwAFr",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1365,
      "original_position" : 125,
      "original_start_line" : 1348,
      "path" : "src/txmempool.cpp",
      "position" : 125,
      "pull_request_review_id" : 1827178150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455423851/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1348,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-17T12:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455423851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455426826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455426826"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can you be more explicit in suggestion? The errors are being returned?",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T12:23:21Z",
      "diff_hunk" : "@@ -181,3 +201,108 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n     }\n     return std::nullopt;\n }\n+\n+// Compare two feerate points, where one of the points is interpolated from\n+// existing points in a feerate diagram.\n+// Return 1 if the interpolated point is greater than fee_compare; 0 if they\n+// are equal; -1 otherwise.\n+int InterpolateValueAndCompare(int64_t eval_size, const FeeFrac& p1, const FeeFrac& p2, CAmount fee_compare)\n+{\n+    // Interpolate between two points using the formula:\n+    // y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)\n+    // i.e.\n+    // y = p1.fee + (eval_size - p1.size) * (p2.fee - p1.fee) / (p2.size - p2.size)\n+    // fee_compare = fee value we want to compare against the interpolated y\n+    //\n+    // Then evaluating y > fee_compare is equivalent to checking if y*(x2-x1) > fee_compare*(x2-x1),\n+    // or y1*(x2-x1) + (x - x1) * (y2 - y1) > fee_compare*(x2-x1).\n+    const auto fee_compare_scaled = Mul128(fee_compare, p2.size - p1.size);\n+    const auto y_scaled = Add128(Mul128(p1.fee, p2.size - p1.size), Mul128(eval_size - p1.size , p2.fee - p1.fee));\n+\n+    if (y_scaled > fee_compare_scaled) {\n+        return 1;\n+    } else if (y_scaled == fee_compare_scaled) {\n+        return 0;\n+    } else {\n+        return -1;\n+    }\n+}\n+\n+// returns true if the new_diagram is strictly better than the old one; false\n+// otherwise.\n+bool CompareFeerateDiagram(std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    size_t old_index=0;\n+    size_t new_index=0;\n+\n+    // whether the new diagram has at least one point better than old_diagram\n+    bool new_better = false;\n+\n+    // whether the old diagram has at least one point better than new_diagram\n+    bool old_better = false;\n+\n+    // Diagrams should be non-empty, and first elements zero in size and fee\n+    Assert(!old_diagram.empty() && !new_diagram.empty());\n+    Assert(old_diagram[0].fee == 0 && old_diagram[0].size == 0);\n+    Assert(new_diagram[0].fee == 0 && new_diagram[0].size == 0);\n+\n+    // Start by padding the smaller diagram with a transaction that pays the\n+    // tail feerate up to the size of the larger diagram.\n+    // For now, use an implicit tail feerate of 0, but we can change this if\n+    // there's an argument to be made that the true tail feerate is higher.\n+    // Also, if we end up needing to transform the feerates (eg to avoid\n+    // negative numbers or overflow in the calculations?), then the tail\n+    // feerate would need to be transformed as well.\n+    if (old_diagram.back().size < new_diagram.back().size) {\n+        old_diagram.emplace_back(old_diagram.back().fee, new_diagram.back().size);\n+    } else if (old_diagram.back().size > new_diagram.back().size) {\n+        new_diagram.emplace_back(new_diagram.back().fee, old_diagram.back().size);\n+    }\n+\n+    while (old_index < old_diagram.size() && new_index < new_diagram.size()) {\n+        int cmp = 0;\n+        if (old_diagram[old_index].size < new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(old_diagram[old_index].size, new_diagram[new_index-1], new_diagram[new_index], old_diagram[old_index].fee);\n+            old_better |= (cmp == -1);\n+            new_better |= (cmp == 1);\n+            old_index++;\n+        } else if (old_diagram[old_index].size > new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(new_diagram[new_index].size, old_diagram[old_index-1], old_diagram[old_index], new_diagram[new_index].fee);\n+            old_better |= (cmp == 1);\n+            new_better |= (cmp == -1);\n+            new_index++;\n+        } else {\n+            if (old_diagram[old_index].fee > new_diagram[new_index].fee) {\n+                old_better = true;\n+            } else if (old_diagram[old_index].fee < new_diagram[new_index].fee) {\n+                new_better = true;\n+            }\n+            old_index++;\n+            new_index++;\n+        }\n+    }\n+\n+    // New is better at least one point, and at least as good on all points; we'll take it\n+    return new_better && !old_better;\n+}\n+\n+std::optional<std::string> ImprovesFeerateDiagram(CTxMemPool& pool,\n+                                                const CTxMemPool::setEntries& direct_conflicts,\n+                                                const CTxMemPool::setEntries& all_conflicts,\n+                                                int64_t replacement_vsize,\n+                                                CAmount replacement_fees)\n+{\n+    // Require that the replacement strictly improve the mempool's fee vs. size diagram.\n+    std::vector<FeeFrac> old_diagram, new_diagram;\n+\n+    const auto err_string{pool.CalculateFeerateDiagramsForRBF(replacement_fees, replacement_vsize, direct_conflicts, all_conflicts, old_diagram, new_diagram)};\n+\n+    if (err_string.has_value()) {\n+        return strprintf(\"unable to compute mining score\");\n+    }\n+\n+    if (!CompareFeerateDiagram(old_diagram, new_diagram)) {\n+        return strprintf(\"insufficient feerate\");\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455426826",
      "id" : 1455426826,
      "in_reply_to_id" : 1453667765,
      "line" : 306,
      "node_id" : "PRRC_kwDOABII585WwA0K",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 306,
      "original_position" : 133,
      "original_start_line" : 300,
      "path" : "src/policy/rbf.cpp",
      "position" : 133,
      "pull_request_review_id" : 1827180557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455426826/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 300,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-17T12:23:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455426826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455433932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455433932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this is testing that subtraction works correctly, not that an individual chunk can have negative size",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T12:26:54Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455433932",
      "id" : 1455433932,
      "in_reply_to_id" : 1453502118,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585WwCjM",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 16,
      "pull_request_review_id" : 1827186462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455433932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-17T12:26:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455433932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455527026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455527026"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I meant what is being returned by `err_string` and `CompareFeerateDiagram` was not used. why were you unable to compute mining score, same for `CompareFeerateDiagram` why is the fee rate insufficient.",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T13:11:40Z",
      "diff_hunk" : "@@ -181,3 +201,108 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n     }\n     return std::nullopt;\n }\n+\n+// Compare two feerate points, where one of the points is interpolated from\n+// existing points in a feerate diagram.\n+// Return 1 if the interpolated point is greater than fee_compare; 0 if they\n+// are equal; -1 otherwise.\n+int InterpolateValueAndCompare(int64_t eval_size, const FeeFrac& p1, const FeeFrac& p2, CAmount fee_compare)\n+{\n+    // Interpolate between two points using the formula:\n+    // y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)\n+    // i.e.\n+    // y = p1.fee + (eval_size - p1.size) * (p2.fee - p1.fee) / (p2.size - p2.size)\n+    // fee_compare = fee value we want to compare against the interpolated y\n+    //\n+    // Then evaluating y > fee_compare is equivalent to checking if y*(x2-x1) > fee_compare*(x2-x1),\n+    // or y1*(x2-x1) + (x - x1) * (y2 - y1) > fee_compare*(x2-x1).\n+    const auto fee_compare_scaled = Mul128(fee_compare, p2.size - p1.size);\n+    const auto y_scaled = Add128(Mul128(p1.fee, p2.size - p1.size), Mul128(eval_size - p1.size , p2.fee - p1.fee));\n+\n+    if (y_scaled > fee_compare_scaled) {\n+        return 1;\n+    } else if (y_scaled == fee_compare_scaled) {\n+        return 0;\n+    } else {\n+        return -1;\n+    }\n+}\n+\n+// returns true if the new_diagram is strictly better than the old one; false\n+// otherwise.\n+bool CompareFeerateDiagram(std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    size_t old_index=0;\n+    size_t new_index=0;\n+\n+    // whether the new diagram has at least one point better than old_diagram\n+    bool new_better = false;\n+\n+    // whether the old diagram has at least one point better than new_diagram\n+    bool old_better = false;\n+\n+    // Diagrams should be non-empty, and first elements zero in size and fee\n+    Assert(!old_diagram.empty() && !new_diagram.empty());\n+    Assert(old_diagram[0].fee == 0 && old_diagram[0].size == 0);\n+    Assert(new_diagram[0].fee == 0 && new_diagram[0].size == 0);\n+\n+    // Start by padding the smaller diagram with a transaction that pays the\n+    // tail feerate up to the size of the larger diagram.\n+    // For now, use an implicit tail feerate of 0, but we can change this if\n+    // there's an argument to be made that the true tail feerate is higher.\n+    // Also, if we end up needing to transform the feerates (eg to avoid\n+    // negative numbers or overflow in the calculations?), then the tail\n+    // feerate would need to be transformed as well.\n+    if (old_diagram.back().size < new_diagram.back().size) {\n+        old_diagram.emplace_back(old_diagram.back().fee, new_diagram.back().size);\n+    } else if (old_diagram.back().size > new_diagram.back().size) {\n+        new_diagram.emplace_back(new_diagram.back().fee, old_diagram.back().size);\n+    }\n+\n+    while (old_index < old_diagram.size() && new_index < new_diagram.size()) {\n+        int cmp = 0;\n+        if (old_diagram[old_index].size < new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(old_diagram[old_index].size, new_diagram[new_index-1], new_diagram[new_index], old_diagram[old_index].fee);\n+            old_better |= (cmp == -1);\n+            new_better |= (cmp == 1);\n+            old_index++;\n+        } else if (old_diagram[old_index].size > new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(new_diagram[new_index].size, old_diagram[old_index-1], old_diagram[old_index], new_diagram[new_index].fee);\n+            old_better |= (cmp == 1);\n+            new_better |= (cmp == -1);\n+            new_index++;\n+        } else {\n+            if (old_diagram[old_index].fee > new_diagram[new_index].fee) {\n+                old_better = true;\n+            } else if (old_diagram[old_index].fee < new_diagram[new_index].fee) {\n+                new_better = true;\n+            }\n+            old_index++;\n+            new_index++;\n+        }\n+    }\n+\n+    // New is better at least one point, and at least as good on all points; we'll take it\n+    return new_better && !old_better;\n+}\n+\n+std::optional<std::string> ImprovesFeerateDiagram(CTxMemPool& pool,\n+                                                const CTxMemPool::setEntries& direct_conflicts,\n+                                                const CTxMemPool::setEntries& all_conflicts,\n+                                                int64_t replacement_vsize,\n+                                                CAmount replacement_fees)\n+{\n+    // Require that the replacement strictly improve the mempool's fee vs. size diagram.\n+    std::vector<FeeFrac> old_diagram, new_diagram;\n+\n+    const auto err_string{pool.CalculateFeerateDiagramsForRBF(replacement_fees, replacement_vsize, direct_conflicts, all_conflicts, old_diagram, new_diagram)};\n+\n+    if (err_string.has_value()) {\n+        return strprintf(\"unable to compute mining score\");\n+    }\n+\n+    if (!CompareFeerateDiagram(old_diagram, new_diagram)) {\n+        return strprintf(\"insufficient feerate\");\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455527026",
      "id" : 1455527026,
      "in_reply_to_id" : 1453667765,
      "line" : 306,
      "node_id" : "PRRC_kwDOABII585WwZRy",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 306,
      "original_position" : 133,
      "original_start_line" : 300,
      "path" : "src/policy/rbf.cpp",
      "position" : 133,
      "pull_request_review_id" : 1827266447,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455527026/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 300,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-17T13:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455527026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455534078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455534078"
         }
      },
      "author_association" : "MEMBER",
      "body" : "also, `Subtrack` isn't a word...",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T13:14:53Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <assert.h>\n+#include <stdint.h>\n+#include <algorithm>\n+#include <compare>\n+#include <vector>\n+\n+namespace {\n+\n+inline std::pair<int64_t, uint64_t> Mul128(int64_t a, int64_t b)\n+{\n+#ifdef __SIZEOF_INT128__\n+    __int128 ret = (__int128)a * b;\n+    return {ret >> 64, ret};\n+#else\n+    uint64_t ll = (uint64_t)(uint32_t)a * (uint32_t)b;\n+    int64_t lh = (uint32_t)a * (b >> 32);\n+    int64_t hl = (a >> 32) * (uint32_t)b;\n+    int64_t hh = (a >> 32) * (b >> 32);\n+    uint64_t mid34 = (ll >> 32) + (uint32_t)lh + (uint32_t)hl;\n+    int64_t hi = hh + (lh >> 32) + (hl >> 32) + (mid34 >> 32);\n+    uint64_t lo = (mid34 << 32) + (uint32_t)ll;\n+    return {hi, lo};\n+#endif\n+}\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (==, !=, >, <, >=, <=, <=>) respect this ordering.\n+ *\n+ * The >> and << operators only compare feerate and treat equal feerate but different size as\n+ * equivalent. The empty FeeFrac is neither lower or higher in feerate than any other.\n+ * The FeeRateCompare function returns the three-way comparison for this order.\n+ */\n+struct FeeFrac\n+{\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t s, int32_t b) noexcept : fee{s}, size{b}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        assert(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add size and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+    }\n+\n+    /** Subtrack size and size of another FeeFrac from this one. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455534078",
      "id" : 1455534078,
      "in_reply_to_id" : 1453480372,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585Wwa_-",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 91,
      "original_position" : 91,
      "original_start_line" : 84,
      "path" : "src/util/feefrac.h",
      "position" : 91,
      "pull_request_review_id" : 1827272350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455534078/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 84,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-17T13:14:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455534078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455539143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455539143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\nYeah, maybe to be consistent define the labels and do the same in the  `OLD` `chunk` computation loop above.\r\nThough  the explicit comments in the `OLD`  `chunk` computation loop is more easier to parse for me :).",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T13:17:06Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // Compute OLD chunks for all clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), int32_t(txiter->GetSizeWithAncestors())};\n+            if (individual > package) {\n+                // The individual feerate is higher than the package, and\n+                // therefore higher than the parent's fee. Chunk these\n+                // together.\n+                old_chunks.emplace_back(package);\n+            } else {\n+                // Add two points, one for the parent and one for this child.\n+                old_chunks.emplace_back(package-individual);\n+                old_chunks.emplace_back(individual);\n+            }\n+        } else {\n+            old_chunks.emplace_back(individual);\n+        }\n+    }\n+\n+    // No topology restrictions post-chunking; sort\n+    BuildDiagramFromUnsortedChunks(old_chunks, old_diagram);\n+\n+    std::vector<FeeFrac> new_chunks;\n+\n+    // Step 2: build the NEW = OLD - CON + CNK diagram\n+\n+    // OLD - CON: Any parents of direct conflicts that are not conflicted themselves\n+    for (auto direct_conflict : direct_conflicts) {\n+        // If a direct conflict has an ancestor that is not in all_conflicts,\n+        // it can be affected by the replacement of the child.\n+        if (direct_conflict->GetMemPoolParentsConst().size() > 0) {\n+            // Grab the parent.\n+            const CTxMemPoolEntry& parent = direct_conflict->GetMemPoolParentsConst().begin()->get();\n+            if (!all_conflicts.count(mapTx.iterator_to(parent))) {\n+                // This transaction would be left over, so add to the new\n+                // diagram.\n+                new_chunks.emplace_back(parent.GetModifiedFee(), parent.GetTxSize());\n+            }\n+        }\n+    }\n+    // + CNK\n+    new_chunks.emplace_back(replacement_fees, int32_t(replacement_vsize));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455539143",
      "id" : 1455539143,
      "in_reply_to_id" : 1453626393,
      "line" : 1365,
      "node_id" : "PRRC_kwDOABII585WwcPH",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1365,
      "original_position" : 125,
      "original_start_line" : 1348,
      "path" : "src/txmempool.cpp",
      "position" : 125,
      "pull_request_review_id" : 1827276759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455539143/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1348,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-17T13:17:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455539143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455544265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455544265"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, My question was... whats the rationale for `FeeFrac` to generally have negative size ?",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T13:19:22Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455544265",
      "id" : 1455544265,
      "in_reply_to_id" : 1453502118,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585WwdfJ",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 16,
      "pull_request_review_id" : 1827280890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455544265/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-17T13:19:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455544265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455658183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455658183"
         }
      },
      "author_association" : "MEMBER",
      "body" : "CompareFeerateDiagram won't return much very interesting, but you're right for the `err_string`, will return it",
      "commit_id" : "5da41e6f851b53d5639dc12aa3d6c308a8a8b403",
      "created_at" : "2024-01-17T14:08:17Z",
      "diff_hunk" : "@@ -181,3 +201,108 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n     }\n     return std::nullopt;\n }\n+\n+// Compare two feerate points, where one of the points is interpolated from\n+// existing points in a feerate diagram.\n+// Return 1 if the interpolated point is greater than fee_compare; 0 if they\n+// are equal; -1 otherwise.\n+int InterpolateValueAndCompare(int64_t eval_size, const FeeFrac& p1, const FeeFrac& p2, CAmount fee_compare)\n+{\n+    // Interpolate between two points using the formula:\n+    // y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)\n+    // i.e.\n+    // y = p1.fee + (eval_size - p1.size) * (p2.fee - p1.fee) / (p2.size - p2.size)\n+    // fee_compare = fee value we want to compare against the interpolated y\n+    //\n+    // Then evaluating y > fee_compare is equivalent to checking if y*(x2-x1) > fee_compare*(x2-x1),\n+    // or y1*(x2-x1) + (x - x1) * (y2 - y1) > fee_compare*(x2-x1).\n+    const auto fee_compare_scaled = Mul128(fee_compare, p2.size - p1.size);\n+    const auto y_scaled = Add128(Mul128(p1.fee, p2.size - p1.size), Mul128(eval_size - p1.size , p2.fee - p1.fee));\n+\n+    if (y_scaled > fee_compare_scaled) {\n+        return 1;\n+    } else if (y_scaled == fee_compare_scaled) {\n+        return 0;\n+    } else {\n+        return -1;\n+    }\n+}\n+\n+// returns true if the new_diagram is strictly better than the old one; false\n+// otherwise.\n+bool CompareFeerateDiagram(std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    size_t old_index=0;\n+    size_t new_index=0;\n+\n+    // whether the new diagram has at least one point better than old_diagram\n+    bool new_better = false;\n+\n+    // whether the old diagram has at least one point better than new_diagram\n+    bool old_better = false;\n+\n+    // Diagrams should be non-empty, and first elements zero in size and fee\n+    Assert(!old_diagram.empty() && !new_diagram.empty());\n+    Assert(old_diagram[0].fee == 0 && old_diagram[0].size == 0);\n+    Assert(new_diagram[0].fee == 0 && new_diagram[0].size == 0);\n+\n+    // Start by padding the smaller diagram with a transaction that pays the\n+    // tail feerate up to the size of the larger diagram.\n+    // For now, use an implicit tail feerate of 0, but we can change this if\n+    // there's an argument to be made that the true tail feerate is higher.\n+    // Also, if we end up needing to transform the feerates (eg to avoid\n+    // negative numbers or overflow in the calculations?), then the tail\n+    // feerate would need to be transformed as well.\n+    if (old_diagram.back().size < new_diagram.back().size) {\n+        old_diagram.emplace_back(old_diagram.back().fee, new_diagram.back().size);\n+    } else if (old_diagram.back().size > new_diagram.back().size) {\n+        new_diagram.emplace_back(new_diagram.back().fee, old_diagram.back().size);\n+    }\n+\n+    while (old_index < old_diagram.size() && new_index < new_diagram.size()) {\n+        int cmp = 0;\n+        if (old_diagram[old_index].size < new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(old_diagram[old_index].size, new_diagram[new_index-1], new_diagram[new_index], old_diagram[old_index].fee);\n+            old_better |= (cmp == -1);\n+            new_better |= (cmp == 1);\n+            old_index++;\n+        } else if (old_diagram[old_index].size > new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(new_diagram[new_index].size, old_diagram[old_index-1], old_diagram[old_index], new_diagram[new_index].fee);\n+            old_better |= (cmp == 1);\n+            new_better |= (cmp == -1);\n+            new_index++;\n+        } else {\n+            if (old_diagram[old_index].fee > new_diagram[new_index].fee) {\n+                old_better = true;\n+            } else if (old_diagram[old_index].fee < new_diagram[new_index].fee) {\n+                new_better = true;\n+            }\n+            old_index++;\n+            new_index++;\n+        }\n+    }\n+\n+    // New is better at least one point, and at least as good on all points; we'll take it\n+    return new_better && !old_better;\n+}\n+\n+std::optional<std::string> ImprovesFeerateDiagram(CTxMemPool& pool,\n+                                                const CTxMemPool::setEntries& direct_conflicts,\n+                                                const CTxMemPool::setEntries& all_conflicts,\n+                                                int64_t replacement_vsize,\n+                                                CAmount replacement_fees)\n+{\n+    // Require that the replacement strictly improve the mempool's fee vs. size diagram.\n+    std::vector<FeeFrac> old_diagram, new_diagram;\n+\n+    const auto err_string{pool.CalculateFeerateDiagramsForRBF(replacement_fees, replacement_vsize, direct_conflicts, all_conflicts, old_diagram, new_diagram)};\n+\n+    if (err_string.has_value()) {\n+        return strprintf(\"unable to compute mining score\");\n+    }\n+\n+    if (!CompareFeerateDiagram(old_diagram, new_diagram)) {\n+        return strprintf(\"insufficient feerate\");\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1455658183",
      "id" : 1455658183,
      "in_reply_to_id" : 1453667765,
      "line" : 306,
      "node_id" : "PRRC_kwDOABII585Ww5TH",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 306,
      "original_position" : 133,
      "original_start_line" : 300,
      "path" : "src/policy/rbf.cpp",
      "position" : 133,
      "pull_request_review_id" : 1827381635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455658183/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 300,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-17T14:08:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1455658183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/20632055548</sub>",
      "created_at" : "2024-01-18T20:29:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1899159499",
      "id" : 1899159499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xMt_L",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899159499/reactions"
      },
      "updated_at" : "2024-01-18T20:29:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899159499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459252934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459252934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:18Z",
      "diff_hunk" : "@@ -181,3 +201,108 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n     }\n     return std::nullopt;\n }\n+\n+// Compare two feerate points, where one of the points is interpolated from\n+// existing points in a feerate diagram.\n+// Return 1 if the interpolated point is greater than fee_compare; 0 if they\n+// are equal; -1 otherwise.\n+int InterpolateValueAndCompare(int64_t eval_size, const FeeFrac& p1, const FeeFrac& p2, CAmount fee_compare)\n+{\n+    // Interpolate between two points using the formula:\n+    // y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)\n+    // i.e.\n+    // y = p1.fee + (eval_size - p1.size) * (p2.fee - p1.fee) / (p2.size - p2.size)\n+    // fee_compare = fee value we want to compare against the interpolated y\n+    //\n+    // Then evaluating y > fee_compare is equivalent to checking if y*(x2-x1) > fee_compare*(x2-x1),\n+    // or y1*(x2-x1) + (x - x1) * (y2 - y1) > fee_compare*(x2-x1).\n+    const auto fee_compare_scaled = Mul128(fee_compare, p2.size - p1.size);\n+    const auto y_scaled = Add128(Mul128(p1.fee, p2.size - p1.size), Mul128(eval_size - p1.size , p2.fee - p1.fee));\n+\n+    if (y_scaled > fee_compare_scaled) {\n+        return 1;\n+    } else if (y_scaled == fee_compare_scaled) {\n+        return 0;\n+    } else {\n+        return -1;\n+    }\n+}\n+\n+// returns true if the new_diagram is strictly better than the old one; false\n+// otherwise.\n+bool CompareFeerateDiagram(std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    size_t old_index=0;\n+    size_t new_index=0;\n+\n+    // whether the new diagram has at least one point better than old_diagram\n+    bool new_better = false;\n+\n+    // whether the old diagram has at least one point better than new_diagram\n+    bool old_better = false;\n+\n+    // Diagrams should be non-empty, and first elements zero in size and fee\n+    Assert(!old_diagram.empty() && !new_diagram.empty());\n+    Assert(old_diagram[0].fee == 0 && old_diagram[0].size == 0);\n+    Assert(new_diagram[0].fee == 0 && new_diagram[0].size == 0);\n+\n+    // Start by padding the smaller diagram with a transaction that pays the\n+    // tail feerate up to the size of the larger diagram.\n+    // For now, use an implicit tail feerate of 0, but we can change this if\n+    // there's an argument to be made that the true tail feerate is higher.\n+    // Also, if we end up needing to transform the feerates (eg to avoid\n+    // negative numbers or overflow in the calculations?), then the tail\n+    // feerate would need to be transformed as well.\n+    if (old_diagram.back().size < new_diagram.back().size) {\n+        old_diagram.emplace_back(old_diagram.back().fee, new_diagram.back().size);\n+    } else if (old_diagram.back().size > new_diagram.back().size) {\n+        new_diagram.emplace_back(new_diagram.back().fee, old_diagram.back().size);\n+    }\n+\n+    while (old_index < old_diagram.size() && new_index < new_diagram.size()) {\n+        int cmp = 0;\n+        if (old_diagram[old_index].size < new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(old_diagram[old_index].size, new_diagram[new_index-1], new_diagram[new_index], old_diagram[old_index].fee);\n+            old_better |= (cmp == -1);\n+            new_better |= (cmp == 1);\n+            old_index++;\n+        } else if (old_diagram[old_index].size > new_diagram[new_index].size) {\n+            cmp = InterpolateValueAndCompare(new_diagram[new_index].size, old_diagram[old_index-1], old_diagram[old_index], new_diagram[new_index].fee);\n+            old_better |= (cmp == 1);\n+            new_better |= (cmp == -1);\n+            new_index++;\n+        } else {\n+            if (old_diagram[old_index].fee > new_diagram[new_index].fee) {\n+                old_better = true;\n+            } else if (old_diagram[old_index].fee < new_diagram[new_index].fee) {\n+                new_better = true;\n+            }\n+            old_index++;\n+            new_index++;\n+        }\n+    }\n+\n+    // New is better at least one point, and at least as good on all points; we'll take it\n+    return new_better && !old_better;\n+}\n+\n+std::optional<std::string> ImprovesFeerateDiagram(CTxMemPool& pool,\n+                                                const CTxMemPool::setEntries& direct_conflicts,\n+                                                const CTxMemPool::setEntries& all_conflicts,\n+                                                int64_t replacement_vsize,\n+                                                CAmount replacement_fees)\n+{\n+    // Require that the replacement strictly improve the mempool's fee vs. size diagram.\n+    std::vector<FeeFrac> old_diagram, new_diagram;\n+\n+    const auto err_string{pool.CalculateFeerateDiagramsForRBF(replacement_fees, replacement_vsize, direct_conflicts, all_conflicts, old_diagram, new_diagram)};\n+\n+    if (err_string.has_value()) {\n+        return strprintf(\"unable to compute mining score\");\n+    }\n+\n+    if (!CompareFeerateDiagram(old_diagram, new_diagram)) {\n+        return strprintf(\"insufficient feerate\");\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459252934",
      "id" : 1459252934,
      "in_reply_to_id" : 1453667765,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585W-m7G",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 269,
      "original_position" : 133,
      "original_start_line" : 300,
      "path" : "src/policy/rbf.cpp",
      "position" : null,
      "pull_request_review_id" : 1833137718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459252934/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459252934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253057"
         }
      },
      "author_association" : "MEMBER",
      "body" : "took some of hte language, and explicitly defined each term",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:24Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // Compute OLD chunks for all clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), int32_t(txiter->GetSizeWithAncestors())};\n+            if (individual > package) {\n+                // The individual feerate is higher than the package, and\n+                // therefore higher than the parent's fee. Chunk these\n+                // together.\n+                old_chunks.emplace_back(package);\n+            } else {\n+                // Add two points, one for the parent and one for this child.\n+                old_chunks.emplace_back(package-individual);\n+                old_chunks.emplace_back(individual);\n+            }\n+        } else {\n+            old_chunks.emplace_back(individual);\n+        }\n+    }\n+\n+    // No topology restrictions post-chunking; sort\n+    BuildDiagramFromUnsortedChunks(old_chunks, old_diagram);\n+\n+    std::vector<FeeFrac> new_chunks;\n+\n+    // Step 2: build the NEW = OLD - CON + CNK diagram\n+\n+    // OLD - CON: Any parents of direct conflicts that are not conflicted themselves\n+    for (auto direct_conflict : direct_conflicts) {\n+        // If a direct conflict has an ancestor that is not in all_conflicts,\n+        // it can be affected by the replacement of the child.\n+        if (direct_conflict->GetMemPoolParentsConst().size() > 0) {\n+            // Grab the parent.\n+            const CTxMemPoolEntry& parent = direct_conflict->GetMemPoolParentsConst().begin()->get();\n+            if (!all_conflicts.count(mapTx.iterator_to(parent))) {\n+                // This transaction would be left over, so add to the new\n+                // diagram.\n+                new_chunks.emplace_back(parent.GetModifiedFee(), parent.GetTxSize());\n+            }\n+        }\n+    }\n+    // + CNK\n+    new_chunks.emplace_back(replacement_fees, int32_t(replacement_vsize));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253057",
      "id" : 1459253057,
      "in_reply_to_id" : 1453626393,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585W-m9B",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1370,
      "original_position" : 125,
      "original_start_line" : 1348,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1833138006,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253057/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253223"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:31Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // Compute OLD chunks for all clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), int32_t(txiter->GetSizeWithAncestors())};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253223",
      "id" : 1459253223,
      "in_reply_to_id" : 1453612523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585W-m_n",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1327,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1833138370,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253223/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253328"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:35Z",
      "diff_hunk" : "@@ -1248,3 +1249,121 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", ancestor_count, txid_string);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of direct_conflicts either at",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253328",
      "id" : 1459253328,
      "in_reply_to_id" : 1453604924,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585W-nBQ",
      "original_commit_id" : "ab9a952bdd1406a4fc9fa71c63e6fbecb78d0a4b",
      "original_line" : 1305,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1833138587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253328/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We use subtraction, and should try to handle that?",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:37Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253396",
      "id" : 1459253396,
      "in_reply_to_id" : 1453502118,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585W-nCU",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 16,
      "pull_request_review_id" : 1833138722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253396/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:40Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};\n+    FeeFrac empty{0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253460",
      "id" : 1459253460,
      "in_reply_to_id" : 1453501485,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII585W-nDU",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 17,
      "pull_request_review_id" : 1833138857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253460/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253539"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added comment",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:43Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <assert.h>\n+#include <stdint.h>\n+#include <algorithm>\n+#include <compare>\n+#include <vector>\n+\n+namespace {\n+\n+inline std::pair<int64_t, uint64_t> Mul128(int64_t a, int64_t b)\n+{\n+#ifdef __SIZEOF_INT128__\n+    __int128 ret = (__int128)a * b;\n+    return {ret >> 64, ret};\n+#else\n+    uint64_t ll = (uint64_t)(uint32_t)a * (uint32_t)b;\n+    int64_t lh = (uint32_t)a * (b >> 32);\n+    int64_t hl = (a >> 32) * (uint32_t)b;\n+    int64_t hh = (a >> 32) * (b >> 32);\n+    uint64_t mid34 = (ll >> 32) + (uint32_t)lh + (uint32_t)hl;\n+    int64_t hi = hh + (lh >> 32) + (hl >> 32) + (mid34 >> 32);\n+    uint64_t lo = (mid34 << 32) + (uint32_t)ll;\n+    return {hi, lo};\n+#endif\n+}\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (==, !=, >, <, >=, <=, <=>) respect this ordering.\n+ *\n+ * The >> and << operators only compare feerate and treat equal feerate but different size as\n+ * equivalent. The empty FeeFrac is neither lower or higher in feerate than any other.\n+ * The FeeRateCompare function returns the three-way comparison for this order.\n+ */\n+struct FeeFrac\n+{\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t s, int32_t b) noexcept : fee{s}, size{b}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        assert(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add size and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+    }\n+\n+    /** Subtrack size and size of another FeeFrac from this one. */\n+    void inline operator-=(const FeeFrac& other) noexcept\n+    {\n+        fee -= other.fee;\n+        size -= other.size;\n+        assert(size != 0 || fee == 0);\n+    }\n+\n+    /** Sum fee and size. */\n+    friend inline FeeFrac operator+(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee + b.fee, a.size + b.size};\n+    }\n+\n+    /** Subtract both fee and size. */\n+    friend inline FeeFrac operator-(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee - b.fee, a.size - b.size};\n+    }\n+\n+    /** Check if two FeeFrac objects are equal (both same fee and same size). */\n+    friend inline bool operator==(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee == b.fee && a.size == b.size;\n+    }\n+\n+    friend inline std::strong_ordering FeeRateCompare(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        if (a.fee > INT32_MAX || a.fee < INT32_MIN || b.fee > INT32_MAX || b.fee < INT32_MIN) {\n+            auto a_cross = Mul128(a.fee, b.size);\n+            auto b_cross = Mul128(b.fee, a.size);\n+            return a_cross <=> b_cross;\n+        } else {\n+            auto a_cross = a.fee * b.size;\n+            auto b_cross = b.fee * a.size;\n+            return a_cross <=> b_cross;\n+        }\n+    }\n+\n+    friend inline std::strong_ordering operator<=>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto feerate_cmp = FeeRateCompare(a, b);\n+        if (feerate_cmp != 0) return feerate_cmp; // NOLINT(modernize-use-nullptr)\n+        return b.size <=> a.size;\n+    }\n+\n+    /** Check if a FeeFrac object has strictly lower feerate than another. */\n+    friend inline bool operator<<(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return FeeRateCompare(a, b) < 0; // NOLINT(modernize-use-nullptr)\n+    }\n+\n+    /** Check if a FeeFrac object has strictly higher feerate than another. */\n+    friend inline bool operator>>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return FeeRateCompare(a, b) > 0; // NOLINT(modernize-use-nullptr)\n+    }\n+\n+    friend inline void swap(FeeFrac& a, FeeFrac& b) noexcept\n+    {\n+        std::swap(a.fee, b.fee);\n+        std::swap(a.size, b.size);\n+    }\n+};\n+\n+void BuildDiagramFromUnsortedChunks(std::vector<FeeFrac>& chunks, std::vector<FeeFrac>& diagram);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253539",
      "id" : 1459253539,
      "in_reply_to_id" : 1453487633,
      "line" : 200,
      "node_id" : "PRRC_kwDOABII585W-nEj",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 200,
      "original_position" : 156,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : 200,
      "pull_request_review_id" : 1833139037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253539/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253631"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:46Z",
      "diff_hunk" : "@@ -0,0 +1,21 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+\n+void BuildDiagramFromUnsortedChunks(std::vector<FeeFrac>& chunks, std::vector<FeeFrac>& diagram)\n+{\n+    diagram.clear();\n+    // Finish by sorting the chunks we calculated, and then accumulating them.\n+    std::sort(chunks.begin(), chunks.end(), [](const FeeFrac& a, const FeeFrac& b) { return a > b; });\n+\n+    // And now build the diagram for these chunks.\n+    diagram.emplace_back(0, 0);\n+    for (auto& chunk : chunks) {\n+        FeeFrac& last = diagram.back();\n+        diagram.emplace_back(last.fee+chunk.fee, last.size+chunk.size);\n+    }\n+    return;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253631",
      "id" : 1459253631,
      "in_reply_to_id" : 1453482107,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585W-nF_",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 21,
      "original_position" : 20,
      "original_start_line" : 19,
      "path" : "src/util/feefrac.cpp",
      "position" : null,
      "pull_request_review_id" : 1833139134,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:48Z",
      "diff_hunk" : "@@ -0,0 +1,21 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+\n+void BuildDiagramFromUnsortedChunks(std::vector<FeeFrac>& chunks, std::vector<FeeFrac>& diagram)\n+{\n+    diagram.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253686",
      "id" : 1459253686,
      "in_reply_to_id" : 1453480679,
      "line" : 10,
      "node_id" : "PRRC_kwDOABII585W-nG2",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 10,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/util/feefrac.cpp",
      "position" : 10,
      "pull_request_review_id" : 1833139262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253686/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:01:50Z",
      "diff_hunk" : "@@ -0,0 +1,158 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <assert.h>\n+#include <stdint.h>\n+#include <algorithm>\n+#include <compare>\n+#include <vector>\n+\n+namespace {\n+\n+inline std::pair<int64_t, uint64_t> Mul128(int64_t a, int64_t b)\n+{\n+#ifdef __SIZEOF_INT128__\n+    __int128 ret = (__int128)a * b;\n+    return {ret >> 64, ret};\n+#else\n+    uint64_t ll = (uint64_t)(uint32_t)a * (uint32_t)b;\n+    int64_t lh = (uint32_t)a * (b >> 32);\n+    int64_t hl = (a >> 32) * (uint32_t)b;\n+    int64_t hh = (a >> 32) * (b >> 32);\n+    uint64_t mid34 = (ll >> 32) + (uint32_t)lh + (uint32_t)hl;\n+    int64_t hi = hh + (lh >> 32) + (hl >> 32) + (mid34 >> 32);\n+    uint64_t lo = (mid34 << 32) + (uint32_t)ll;\n+    return {hi, lo};\n+#endif\n+}\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (==, !=, >, <, >=, <=, <=>) respect this ordering.\n+ *\n+ * The >> and << operators only compare feerate and treat equal feerate but different size as\n+ * equivalent. The empty FeeFrac is neither lower or higher in feerate than any other.\n+ * The FeeRateCompare function returns the three-way comparison for this order.\n+ */\n+struct FeeFrac\n+{\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t s, int32_t b) noexcept : fee{s}, size{b}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        assert(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add size and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+    }\n+\n+    /** Subtrack size and size of another FeeFrac from this one. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459253728",
      "id" : 1459253728,
      "in_reply_to_id" : 1453480372,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585W-nHg",
      "original_commit_id" : "ec3cf62361912a85ccd8d93abc3606df695c69ef",
      "original_line" : 91,
      "original_position" : 91,
      "original_start_line" : 84,
      "path" : "src/util/feefrac.h",
      "position" : null,
      "pull_request_review_id" : 1833139379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253728/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:01:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459253728",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459264030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459264030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: perhaps this function belongs more in util/feefrac (as the building of the diagram also lives there)",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:09:00Z",
      "diff_hunk" : "@@ -106,4 +108,23 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n                                       CFeeRate relay_fee,\n                                       const uint256& txid);\n \n+/**\n+ * The replacement transaction must improve the feerate diagram of the mempool.\n+ * @param[in]   pool                The mempool.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the direct conflicts\n+ * @param[in]   all_conflicts       Set of mempool entries corresponding to all conflicts\n+ * @param[in]   replacement_fees    Fees of replacement package\n+ * @param[in]   replacement_vsize   Size of replacement package\n+ * @returns error string if mempool diagram doesn't improve, otherwise std::nullopt.\n+ */\n+std::optional<std::string> ImprovesFeerateDiagram(CTxMemPool& pool,\n+                                                const CTxMemPool::setEntries& direct_conflicts,\n+                                                const CTxMemPool::setEntries& all_conflicts,\n+                                                CAmount replacement_fees,\n+                                                int64_t replacement_vsize)\n+                                                EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Compares two feerate diagrams. The shorter one is padded with a horizonal line. */\n+std::partial_ordering CompareFeerateDiagram(std::vector<FeeFrac>& dia0, std::vector<FeeFrac>& dia1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459264030",
      "id" : 1459264030,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585W-poe",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 128,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : 31,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459264030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459264030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459279118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459279118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I can think of one use case where negative sizes are actually useful, though it's pretty far fetched.\r\n\r\nCurrently the code hardcodes a \"tail feerate\" (the feerate of which we assume there is an infinite supply) of 0 sat/vB for mempool improvement checks, but in theory this can be configurable. In that case, in addition to the diagram check between old and new package, we want the property that `fee_new >= fee_old + (size_new - size_old) * feerate_tail`. If `old`, `new`, and `tail` are CFeeFrac objects, this condition is exactly `!((new - old) << tail)`. If new is smaller than old, the `new - old` object has negative size.\r\n\r\nA more pragmatic answer is that there is no real reason to restrict it to just positive sizes, and not enforcing it is simpler.",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:18:54Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2016-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <random.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(feefrac_tests)\n+\n+BOOST_AUTO_TEST_CASE(feefrac_operators)\n+{\n+    FeeFrac p1{1000, 100}, p2{500, 300};\n+    FeeFrac sum{1500, 400};\n+    FeeFrac diff{500, -200};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459279118",
      "id" : 1459279118,
      "in_reply_to_id" : 1453502118,
      "line" : 16,
      "node_id" : "PRRC_kwDOABII585W-tUO",
      "original_commit_id" : "8d74a28a62083bbbee1fd6a2dee56994f293a61a",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/feefrac_tests.cpp",
      "position" : 16,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459279118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459279118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459281387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459281387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: std::array.",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:20:13Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).\n+    add_fn((a & 0xffffffff) * (b & 0xffffffff), 0);\n+    add_fn((a >> 32) * (b & 0xffffffff), 1);\n+    add_fn((a & 0xffffffff) * (b >> 32), 1);\n+    add_fn((a >> 32) * (b >> 32), 2);\n+    return ret;\n+}\n+\n+/* comparison helper for std::vector */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459281387",
      "id" : 1459281387,
      "line" : 47,
      "node_id" : "PRRC_kwDOABII585W-t3r",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 47,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : 47,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459281387/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459281387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459282903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459282903"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: EMBRACE THE SPACESHIP\r\n\r\n```c++\r\nif (a[i] != b[i]) return a[i] <=> b[i];\r\n```",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:21:09Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).\n+    add_fn((a & 0xffffffff) * (b & 0xffffffff), 0);\n+    add_fn((a >> 32) * (b & 0xffffffff), 1);\n+    add_fn((a & 0xffffffff) * (b >> 32), 1);\n+    add_fn((a >> 32) * (b >> 32), 2);\n+    return ret;\n+}\n+\n+/* comparison helper for std::vector */\n+std::strong_ordering compare_arrays(const std::array<uint32_t, 4>& a, const std::array<uint32_t, 4>& b) {\n+    for (size_t i = 0; i < a.size(); ++i) {\n+        if (a[i] < b[i]) return std::strong_ordering::less;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459282903",
      "id" : 1459282903,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585W-uPX",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 50,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : 50,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459282903/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459282903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459283849"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459283849"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Self-nit: `2^64` -> `2^32`",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:21:44Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459283849",
      "id" : 1459283849,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585W-ueJ",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : 39,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459283849/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459283849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459309396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459309396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Suggested change that (I believe) avoids the need for suppressions (and may be more readable?):\r\n\r\n```c++\r\n    auto add_fn = [&](uint64_t v, int pos) {\r\n        uint64_t accum{0};\r\n        for (int i = 0; i + pos < 4; ++i) {\r\n            // Add current value at limb pos in ret.\r\n            accum += ret[3 - pos - i];\r\n            // Add low or high half of v.\r\n            if (i == 0) accum += v & 0xffffffff;\r\n            if (i == 1) accum += v >> 32;\r\n            // Store lower half of result in limb pos in ret.\r\n            ret[3 - pos - i] = accum & 0xffffffff;\r\n            // Leave carry in accum.\r\n            accum >>= 32;\r\n        }\r\n        // Make sure no overflow.\r\n        assert(accum == 0);\r\n    };\r\n```",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:36:25Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459309396",
      "id" : 1459309396,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII585W-0tU",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 22,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : 22,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459309396/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459309396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459312210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459312210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Avoid the need for a suppression:\r\n\r\n```c++\r\n// Compute absolute values.\r\nuint64_t abs_a1 = static_cast<uint64_t>(a1), abs_a2 = static_cast<uint64_t>(a2);\r\nuint64_t abs_b1 = static_cast<uint64_t>(b1), abs_b2 = static_cast<uint64_t>(b2);\r\n// Use (~x + 1) instead of the equivalent (-x) to silence the linter; mod 2^64 behavior is\r\n// intentional here.\r\nif (a1 < 0) abs_a1 = ~abs_a1 + 1;\r\nif (a2 < 0) abs_a2 = ~abs_a2 + 1;\r\nif (b1 < 0) abs_b1 = ~abs_b1 + 1;\r\nif (b2 < 0) abs_b2 = ~abs_b2 + 1;\r\n```\r\n\r\n(The same trick is used in `CScriptNum::serialize`, it could be abstracted out)",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T16:38:05Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).\n+    add_fn((a & 0xffffffff) * (b & 0xffffffff), 0);\n+    add_fn((a >> 32) * (b & 0xffffffff), 1);\n+    add_fn((a & 0xffffffff) * (b >> 32), 1);\n+    add_fn((a >> 32) * (b >> 32), 2);\n+    return ret;\n+}\n+\n+/* comparison helper for std::vector */\n+std::strong_ordering compare_arrays(const std::array<uint32_t, 4>& a, const std::array<uint32_t, 4>& b) {\n+    for (size_t i = 0; i < a.size(); ++i) {\n+        if (a[i] < b[i]) return std::strong_ordering::less;\n+        if (a[i] > b[i]) return std::strong_ordering::greater;\n+    }\n+    return std::strong_ordering::equal;\n+}\n+\n+std::strong_ordering MulCompare(int64_t a1, int64_t a2, int64_t b1, int64_t b2)\n+{\n+    // Compute and compare signs.\n+    int sign_a = (a1 == 0 ? 0 : a1 < 0 ? -1 : 1) * (a2 == 0 ? 0 : a2 < 0 ? -1 : 1);\n+    int sign_b = (b1 == 0 ? 0 : b1 < 0 ? -1 : 1) * (b2 == 0 ? 0 : b2 < 0 ? -1 : 1);\n+    if (sign_a != sign_b) return sign_a <=> sign_b;\n+\n+    // Compute absolute values.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459312210",
      "id" : 1459312210,
      "line" : 62,
      "node_id" : "PRRC_kwDOABII585W-1ZS",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 62,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : 62,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459312210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T17:31:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459312210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459315118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459315118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Self-nit: no need for this `namespace` anymore.",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:39:47Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <stdint.h>\n+#include <compare>\n+#include <vector>\n+#include <util/check.h>\n+\n+namespace {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459315118",
      "id" : 1459315118,
      "line" : 13,
      "node_id" : "PRRC_kwDOABII585W-2Gu",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 13,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : 13,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459315118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459315118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459316281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459316281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Self-nit: this operator can be dropped (C++20 will automatically generate it as negation of `operator==`).",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:40:32Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <stdint.h>\n+#include <compare>\n+#include <vector>\n+#include <util/check.h>\n+\n+namespace {\n+\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (<=>, ==, !=, >, <, >=, <=) respect this ordering.\n+ *\n+ * The CompareFeeFrac, and >> and << operators only compare feerate and treat equal feerate but\n+ * different size as equivalent. The empty FeeFrac is neither lower or higher in feerate than any\n+ * other.\n+ */\n+struct FeeFrac\n+{\n+    /** Fallback version for Mul (see below).\n+     *\n+     * Separate to permit testing on platforms where it isn't actually needed.\n+     */\n+    static inline std::pair<int64_t, uint32_t> MulFallback(int64_t a, int32_t b) noexcept\n+    {\n+        // Otherwise, emulate 96-bit multiplication using two 64-bit multiplies.\n+        int64_t low = int64_t{static_cast<uint32_t>(a)} * b;\n+        int64_t high = (a >> 32) * b;\n+        return {high + (low >> 32), static_cast<uint32_t>(low)};\n+    }\n+\n+    // Compute a * b, returning an unspecified but totally ordered type.\n+#ifdef __SIZEOF_INT128__\n+    static inline __int128 Mul(int64_t a, int32_t b) noexcept\n+    {\n+        // If __int128 is available, use 128-bit wide multiply.\n+        return __int128{a} * b;\n+    }\n+#else\n+    static constexpr auto Mul = MulFallback;\n+#endif\n+\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t f, int32_t s) noexcept : fee{f}, size{s}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add fee and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Subtract fee and size of another FeeFrac from this one. */\n+    void inline operator-=(const FeeFrac& other) noexcept\n+    {\n+        fee -= other.fee;\n+        size -= other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Sum fee and size. */\n+    friend inline FeeFrac operator+(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee + b.fee, a.size + b.size};\n+    }\n+\n+    /** Subtract both fee and size. */\n+    friend inline FeeFrac operator-(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee - b.fee, a.size - b.size};\n+    }\n+\n+    /** Check if two FeeFrac objects are equal (both same fee and same size). */\n+    friend inline bool operator==(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee == b.fee && a.size == b.size;\n+    }\n+\n+    /** Check if two FeeFrac objects are different (either fee or size differs). */\n+    friend inline bool operator!=(const FeeFrac& a, const FeeFrac& b) noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459316281",
      "id" : 1459316281,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII585W-2Y5",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 125,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : 125,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459316281/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459316281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459317381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459317381"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Self-nit: `operator<`, `operator>`, `operator<=` and `operator>=` can be dropped (C++20 will autogenerate them using `operator<=>` (inspecting the compiled code, it's marginally less efficient, but all the actually performance-critical uses use `operator<<`, `operator>>`, or `FeeRateCompare` anyway).",
      "commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "created_at" : "2024-01-19T16:41:05Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <stdint.h>\n+#include <compare>\n+#include <vector>\n+#include <util/check.h>\n+\n+namespace {\n+\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (<=>, ==, !=, >, <, >=, <=) respect this ordering.\n+ *\n+ * The CompareFeeFrac, and >> and << operators only compare feerate and treat equal feerate but\n+ * different size as equivalent. The empty FeeFrac is neither lower or higher in feerate than any\n+ * other.\n+ */\n+struct FeeFrac\n+{\n+    /** Fallback version for Mul (see below).\n+     *\n+     * Separate to permit testing on platforms where it isn't actually needed.\n+     */\n+    static inline std::pair<int64_t, uint32_t> MulFallback(int64_t a, int32_t b) noexcept\n+    {\n+        // Otherwise, emulate 96-bit multiplication using two 64-bit multiplies.\n+        int64_t low = int64_t{static_cast<uint32_t>(a)} * b;\n+        int64_t high = (a >> 32) * b;\n+        return {high + (low >> 32), static_cast<uint32_t>(low)};\n+    }\n+\n+    // Compute a * b, returning an unspecified but totally ordered type.\n+#ifdef __SIZEOF_INT128__\n+    static inline __int128 Mul(int64_t a, int32_t b) noexcept\n+    {\n+        // If __int128 is available, use 128-bit wide multiply.\n+        return __int128{a} * b;\n+    }\n+#else\n+    static constexpr auto Mul = MulFallback;\n+#endif\n+\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t f, int32_t s) noexcept : fee{f}, size{s}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add fee and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Subtract fee and size of another FeeFrac from this one. */\n+    void inline operator-=(const FeeFrac& other) noexcept\n+    {\n+        fee -= other.fee;\n+        size -= other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Sum fee and size. */\n+    friend inline FeeFrac operator+(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee + b.fee, a.size + b.size};\n+    }\n+\n+    /** Subtract both fee and size. */\n+    friend inline FeeFrac operator-(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee - b.fee, a.size - b.size};\n+    }\n+\n+    /** Check if two FeeFrac objects are equal (both same fee and same size). */\n+    friend inline bool operator==(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee == b.fee && a.size == b.size;\n+    }\n+\n+    /** Check if two FeeFrac objects are different (either fee or size differs). */\n+    friend inline bool operator!=(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee != b.fee || a.size != b.size;\n+    }\n+\n+    /** Compare two FeeFracs just by feerate. */\n+    friend inline std::weak_ordering FeeRateCompare(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        return cross_a <=> cross_b;\n+    }\n+\n+    /** Check if a FeeFrac object has strictly lower feerate than another. */\n+    friend inline bool operator<<(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        return cross_a < cross_b;\n+    }\n+\n+    /** Check if a FeeFrac object has strictly higher feerate than another. */\n+    friend inline bool operator>>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        return cross_a > cross_b;\n+    }\n+\n+    /** Compare two FeeFracs. */\n+    friend inline std::strong_ordering operator<=>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        if (cross_a == cross_b) return b.size <=> a.size;\n+        return cross_a <=> cross_b;\n+    }\n+\n+    /** Check if a FeeFrac object is worse than another. */\n+    friend inline bool operator<(const FeeFrac& a, const FeeFrac& b) noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459317381",
      "id" : 1459317381,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585W-2qF",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 160,
      "original_position" : 160,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : 160,
      "pull_request_review_id" : 1833161137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459317381/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459317381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:20Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <stdint.h>\n+#include <compare>\n+#include <vector>\n+#include <util/check.h>\n+\n+namespace {\n+\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (<=>, ==, !=, >, <, >=, <=) respect this ordering.\n+ *\n+ * The CompareFeeFrac, and >> and << operators only compare feerate and treat equal feerate but\n+ * different size as equivalent. The empty FeeFrac is neither lower or higher in feerate than any\n+ * other.\n+ */\n+struct FeeFrac\n+{\n+    /** Fallback version for Mul (see below).\n+     *\n+     * Separate to permit testing on platforms where it isn't actually needed.\n+     */\n+    static inline std::pair<int64_t, uint32_t> MulFallback(int64_t a, int32_t b) noexcept\n+    {\n+        // Otherwise, emulate 96-bit multiplication using two 64-bit multiplies.\n+        int64_t low = int64_t{static_cast<uint32_t>(a)} * b;\n+        int64_t high = (a >> 32) * b;\n+        return {high + (low >> 32), static_cast<uint32_t>(low)};\n+    }\n+\n+    // Compute a * b, returning an unspecified but totally ordered type.\n+#ifdef __SIZEOF_INT128__\n+    static inline __int128 Mul(int64_t a, int32_t b) noexcept\n+    {\n+        // If __int128 is available, use 128-bit wide multiply.\n+        return __int128{a} * b;\n+    }\n+#else\n+    static constexpr auto Mul = MulFallback;\n+#endif\n+\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t f, int32_t s) noexcept : fee{f}, size{s}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add fee and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Subtract fee and size of another FeeFrac from this one. */\n+    void inline operator-=(const FeeFrac& other) noexcept\n+    {\n+        fee -= other.fee;\n+        size -= other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Sum fee and size. */\n+    friend inline FeeFrac operator+(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee + b.fee, a.size + b.size};\n+    }\n+\n+    /** Subtract both fee and size. */\n+    friend inline FeeFrac operator-(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee - b.fee, a.size - b.size};\n+    }\n+\n+    /** Check if two FeeFrac objects are equal (both same fee and same size). */\n+    friend inline bool operator==(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee == b.fee && a.size == b.size;\n+    }\n+\n+    /** Check if two FeeFrac objects are different (either fee or size differs). */\n+    friend inline bool operator!=(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee != b.fee || a.size != b.size;\n+    }\n+\n+    /** Compare two FeeFracs just by feerate. */\n+    friend inline std::weak_ordering FeeRateCompare(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        return cross_a <=> cross_b;\n+    }\n+\n+    /** Check if a FeeFrac object has strictly lower feerate than another. */\n+    friend inline bool operator<<(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        return cross_a < cross_b;\n+    }\n+\n+    /** Check if a FeeFrac object has strictly higher feerate than another. */\n+    friend inline bool operator>>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        return cross_a > cross_b;\n+    }\n+\n+    /** Compare two FeeFracs. */\n+    friend inline std::strong_ordering operator<=>(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        auto cross_a = Mul(a.fee, b.size), cross_b = Mul(b.fee, a.size);\n+        if (cross_a == cross_b) return b.size <=> a.size;\n+        return cross_a <=> cross_b;\n+    }\n+\n+    /** Check if a FeeFrac object is worse than another. */\n+    friend inline bool operator<(const FeeFrac& a, const FeeFrac& b) noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709324",
      "id" : 1459709324,
      "in_reply_to_id" : 1459317381,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XAWWM",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 160,
      "original_position" : 160,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : null,
      "pull_request_review_id" : 1833628032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709324/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709417"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:25Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <stdint.h>\n+#include <compare>\n+#include <vector>\n+#include <util/check.h>\n+\n+namespace {\n+\n+\n+} // namespace\n+\n+/** Data structure storing a fee and size, ordered by increasing fee/size.\n+ *\n+ * The size of a FeeFrac cannot be zero unless the fee is also zero.\n+ *\n+ * FeeFracs have a total ordering, first by increasing feerate (ratio of fee over size), and then\n+ * by decreasing size. The empty FeeFrac (fee and size both 0) sorts last. So for example, the\n+ * following FeeFracs are in sorted order:\n+ *\n+ * - fee=0 size=1 (feerate 0)\n+ * - fee=1 size=2 (feerate 0.5)\n+ * - fee=2 size=3 (feerate 0.667...)\n+ * - fee=2 size=2 (feerate 1)\n+ * - fee=1 size=1 (feerate 1)\n+ * - fee=3 size=2 (feerate 1.5)\n+ * - fee=2 size=1 (feerate 2)\n+ * - fee=0 size=0 (undefined feerate)\n+ *\n+ * A FeeFrac is considered \"better\" if it sorts after another, by this ordering. All standard\n+ * comparison operators (<=>, ==, !=, >, <, >=, <=) respect this ordering.\n+ *\n+ * The CompareFeeFrac, and >> and << operators only compare feerate and treat equal feerate but\n+ * different size as equivalent. The empty FeeFrac is neither lower or higher in feerate than any\n+ * other.\n+ */\n+struct FeeFrac\n+{\n+    /** Fallback version for Mul (see below).\n+     *\n+     * Separate to permit testing on platforms where it isn't actually needed.\n+     */\n+    static inline std::pair<int64_t, uint32_t> MulFallback(int64_t a, int32_t b) noexcept\n+    {\n+        // Otherwise, emulate 96-bit multiplication using two 64-bit multiplies.\n+        int64_t low = int64_t{static_cast<uint32_t>(a)} * b;\n+        int64_t high = (a >> 32) * b;\n+        return {high + (low >> 32), static_cast<uint32_t>(low)};\n+    }\n+\n+    // Compute a * b, returning an unspecified but totally ordered type.\n+#ifdef __SIZEOF_INT128__\n+    static inline __int128 Mul(int64_t a, int32_t b) noexcept\n+    {\n+        // If __int128 is available, use 128-bit wide multiply.\n+        return __int128{a} * b;\n+    }\n+#else\n+    static constexpr auto Mul = MulFallback;\n+#endif\n+\n+    /** Fee. */\n+    int64_t fee;\n+    /** Size. */\n+    int32_t size;\n+\n+    /** Construct an IsEmpty() FeeFrac. */\n+    inline FeeFrac() noexcept : fee{0}, size{0} {}\n+\n+    /** Construct a FeeFrac with specified fee and size. */\n+    inline FeeFrac(int64_t f, int32_t s) noexcept : fee{f}, size{s}\n+    {\n+        // If size==0, fee must be 0 as well.\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    inline FeeFrac(const FeeFrac&) noexcept = default;\n+    inline FeeFrac& operator=(const FeeFrac&) noexcept = default;\n+\n+    /** Check if this is empty (size and fee are 0). */\n+    bool inline IsEmpty() const noexcept {\n+        return size == 0;\n+    }\n+\n+    /** Add fee and size of another FeeFrac to this one. */\n+    void inline operator+=(const FeeFrac& other) noexcept\n+    {\n+        fee += other.fee;\n+        size += other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Subtract fee and size of another FeeFrac from this one. */\n+    void inline operator-=(const FeeFrac& other) noexcept\n+    {\n+        fee -= other.fee;\n+        size -= other.size;\n+        Assume(size != 0 || fee == 0);\n+    }\n+\n+    /** Sum fee and size. */\n+    friend inline FeeFrac operator+(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee + b.fee, a.size + b.size};\n+    }\n+\n+    /** Subtract both fee and size. */\n+    friend inline FeeFrac operator-(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return {a.fee - b.fee, a.size - b.size};\n+    }\n+\n+    /** Check if two FeeFrac objects are equal (both same fee and same size). */\n+    friend inline bool operator==(const FeeFrac& a, const FeeFrac& b) noexcept\n+    {\n+        return a.fee == b.fee && a.size == b.size;\n+    }\n+\n+    /** Check if two FeeFrac objects are different (either fee or size differs). */\n+    friend inline bool operator!=(const FeeFrac& a, const FeeFrac& b) noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709417",
      "id" : 1459709417,
      "in_reply_to_id" : 1459316281,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XAWXp",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 125,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : null,
      "pull_request_review_id" : 1833628227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709496"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:28Z",
      "diff_hunk" : "@@ -0,0 +1,202 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_FEEFRAC_H\n+#define BITCOIN_UTIL_FEEFRAC_H\n+\n+#include <stdint.h>\n+#include <compare>\n+#include <vector>\n+#include <util/check.h>\n+\n+namespace {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709496",
      "id" : 1459709496,
      "in_reply_to_id" : 1459315118,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XAWY4",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 13,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/util/feefrac.h",
      "position" : null,
      "pull_request_review_id" : 1833628323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709496/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:34Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).\n+    add_fn((a & 0xffffffff) * (b & 0xffffffff), 0);\n+    add_fn((a >> 32) * (b & 0xffffffff), 1);\n+    add_fn((a & 0xffffffff) * (b >> 32), 1);\n+    add_fn((a >> 32) * (b >> 32), 2);\n+    return ret;\n+}\n+\n+/* comparison helper for std::vector */\n+std::strong_ordering compare_arrays(const std::array<uint32_t, 4>& a, const std::array<uint32_t, 4>& b) {\n+    for (size_t i = 0; i < a.size(); ++i) {\n+        if (a[i] < b[i]) return std::strong_ordering::less;\n+        if (a[i] > b[i]) return std::strong_ordering::greater;\n+    }\n+    return std::strong_ordering::equal;\n+}\n+\n+std::strong_ordering MulCompare(int64_t a1, int64_t a2, int64_t b1, int64_t b2)\n+{\n+    // Compute and compare signs.\n+    int sign_a = (a1 == 0 ? 0 : a1 < 0 ? -1 : 1) * (a2 == 0 ? 0 : a2 < 0 ? -1 : 1);\n+    int sign_b = (b1 == 0 ? 0 : b1 < 0 ? -1 : 1) * (b2 == 0 ? 0 : b2 < 0 ? -1 : 1);\n+    if (sign_a != sign_b) return sign_a <=> sign_b;\n+\n+    // Compute absolute values.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709630",
      "id" : 1459709630,
      "in_reply_to_id" : 1459312210,
      "line" : 62,
      "node_id" : "PRRC_kwDOABII585XAWa-",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 62,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : 62,
      "pull_request_review_id" : 1833628458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709630/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "looks good, done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:36Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709663",
      "id" : 1459709663,
      "in_reply_to_id" : 1459309396,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII585XAWbf",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 22,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : 22,
      "pull_request_review_id" : 1833628511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709766"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:40Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709766",
      "id" : 1459709766,
      "in_reply_to_id" : 1459283849,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XAWdG",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : null,
      "pull_request_review_id" : 1833628606,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:44Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).\n+    add_fn((a & 0xffffffff) * (b & 0xffffffff), 0);\n+    add_fn((a >> 32) * (b & 0xffffffff), 1);\n+    add_fn((a & 0xffffffff) * (b >> 32), 1);\n+    add_fn((a >> 32) * (b >> 32), 2);\n+    return ret;\n+}\n+\n+/* comparison helper for std::vector */\n+std::strong_ordering compare_arrays(const std::array<uint32_t, 4>& a, const std::array<uint32_t, 4>& b) {\n+    for (size_t i = 0; i < a.size(); ++i) {\n+        if (a[i] < b[i]) return std::strong_ordering::less;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709852",
      "id" : 1459709852,
      "in_reply_to_id" : 1459282903,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XAWec",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 50,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : null,
      "pull_request_review_id" : 1833628685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:48Z",
      "diff_hunk" : "@@ -0,0 +1,126 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <util/feefrac.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+\n+#include <compare>\n+#include <cstdint>\n+#include <iostream>\n+\n+namespace {\n+\n+/** Compute a * b, represented in 4x32 bits, highest limb first. */\n+std::array<uint32_t, 4> Mul128(uint64_t a, uint64_t b)\n+{\n+    std::array<uint32_t, 4> ret{0, 0, 0, 0};\n+\n+    /** Perform ret += v << (32 * pos), at 128-bit precision. */\n+    auto add_fn = [&](uint64_t v, int pos) {\n+        uint32_t carry = 0;\n+        for (int i = 0; i + pos < 4; ++i) {\n+            uint32_t& limb = ret[3 - pos - i];\n+            uint32_t old = limb;\n+            // Add low or high half of v.\n+            if (i == 0) limb += v;\n+            if (i == 1) limb += v >> 32;\n+            // Add carry from previous position.\n+            limb += carry;\n+            // Compute carry for next position.\n+            carry = (limb < old) || ((limb == old) && carry);\n+        }\n+        // Make sure no overflow.\n+        assert(carry == 0);\n+    };\n+\n+    // Multiply the 4 individual limbs (schoolbook multiply, with base 2^64).\n+    add_fn((a & 0xffffffff) * (b & 0xffffffff), 0);\n+    add_fn((a >> 32) * (b & 0xffffffff), 1);\n+    add_fn((a & 0xffffffff) * (b >> 32), 1);\n+    add_fn((a >> 32) * (b >> 32), 2);\n+    return ret;\n+}\n+\n+/* comparison helper for std::vector */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459709932",
      "id" : 1459709932,
      "in_reply_to_id" : 1459281387,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XAWfs",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 47,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/test/fuzz/feefrac.cpp",
      "position" : null,
      "pull_request_review_id" : 1833628778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459709932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459710174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459710174"
         }
      },
      "author_association" : "MEMBER",
      "body" : "makes sense, moved",
      "commit_id" : "c914968b552c2a3d53079d47bc25a2e719cebe37",
      "created_at" : "2024-01-19T20:25:58Z",
      "diff_hunk" : "@@ -106,4 +108,23 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n                                       CFeeRate relay_fee,\n                                       const uint256& txid);\n \n+/**\n+ * The replacement transaction must improve the feerate diagram of the mempool.\n+ * @param[in]   pool                The mempool.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the direct conflicts\n+ * @param[in]   all_conflicts       Set of mempool entries corresponding to all conflicts\n+ * @param[in]   replacement_fees    Fees of replacement package\n+ * @param[in]   replacement_vsize   Size of replacement package\n+ * @returns error string if mempool diagram doesn't improve, otherwise std::nullopt.\n+ */\n+std::optional<std::string> ImprovesFeerateDiagram(CTxMemPool& pool,\n+                                                const CTxMemPool::setEntries& direct_conflicts,\n+                                                const CTxMemPool::setEntries& all_conflicts,\n+                                                CAmount replacement_fees,\n+                                                int64_t replacement_vsize)\n+                                                EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+\n+/** Compares two feerate diagrams. The shorter one is padded with a horizonal line. */\n+std::partial_ordering CompareFeerateDiagram(std::vector<FeeFrac>& dia0, std::vector<FeeFrac>& dia1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1459710174",
      "id" : 1459710174,
      "in_reply_to_id" : 1459264030,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XAWje",
      "original_commit_id" : "a4b92cfd641d65224528395f1f9b98406822f333",
      "original_line" : 128,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 1833628978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459710174/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-19T20:25:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1459710174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/20672153966</sub>",
      "created_at" : "2024-01-19T20:32:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1901072804",
      "id" : 1901072804,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xUBGk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1901072804/reactions"
      },
      "updated_at" : "2024-01-19T20:32:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1901072804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "test failure appears to be spurious wallet failure, ready for review",
      "created_at" : "2024-01-19T21:42:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1901152779",
      "id" : 1901152779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xUUoL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1901152779/reactions"
      },
      "updated_at" : "2024-01-19T21:42:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1901152779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In https://github.com/sipa/bitcoin/commits/pr29242 I pushed another commit which makes `CompareFeerateDiagram` not modify the diagrams in-place.",
      "created_at" : "2024-01-21T14:00:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1902638542",
      "id" : 1902638542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xZ_XO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1902638542/reactions"
      },
      "updated_at" : "2024-01-21T14:00:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1902638542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In https://github.com/sipa/bitcoin/commits/pr29242 I pushed another commit which makes CompareFeerateDiagram not modify the diagrams in-place.\r\n\r\nTaken only with minor comment changes, and added another test case or two to cover the iterative nature of the check",
      "created_at" : "2024-01-22T17:30:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1904479665",
      "id" : 1904479665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xhA2x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1904479665/reactions"
      },
      "updated_at" : "2024-01-22T17:30:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1904479665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462332681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462332681"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In the commit message of \"Implement ImprovesFeerateDiagram\" (9257f33d259bf68f1df1cc41b7b3caaea341782f):\r\n\r\n> This new function takes the populated sets of\r\n> direct and all conflicts computed in the current\r\n> mempool, assuming the replacements are a single\r\n> chunk, and computes a diagram check.\r\n\r\nThe first sentence is confusing to me. Could you perhaps clarify \"the populated sets of direct and all conflicts\" and split the sentence up?",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T19:42:17Z",
      "diff_hunk" : "@@ -19,6 +19,8 @@\n #include <limits>\n #include <vector>\n \n+#include <compare>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462332681",
      "id" : 1462332681,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII585XKW0J",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 22,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 4,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462332681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462332681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462348934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462348934"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"Implement ImprovesFeerateDiagram\" (9257f33d259bf68f1df1cc41b7b3caaea341782f):\r\nNit: The documentation is in opposite order as the checks. Perhaps switch these two lines.",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T19:55:55Z",
      "diff_hunk" : "@@ -1248,3 +1249,126 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", txid_string, ancestor_count - 1);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", txid_string, descendant_count - 1);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462348934",
      "id" : 1462348934,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XKayG",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 1274,
      "original_position" : 35,
      "original_start_line" : 1274,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462348934/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462348934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462350586"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462350586"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"Implement ImprovesFeerateDiagram\" (9257f33d259bf68f1df1cc41b7b3caaea341782f):\r\n\r\n```suggestion\r\n            return strprintf(\"%s has both ancestor and descendant, exceeding cluster limit of 2\", txid_string);\r\n```",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T19:57:44Z",
      "diff_hunk" : "@@ -1248,3 +1249,126 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", txid_string, ancestor_count - 1);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", txid_string, descendant_count - 1);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462350586",
      "id" : 1462350586,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XKbL6",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 1271,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462350586/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462350586",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462365378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462365378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"Implement ImprovesFeerateDiagram\" (9257f33d259bf68f1df1cc41b7b3caaea341782f):\r\nMaybe thatâs my unfamiliarity with the mempool code, but it is not obvious to me what \"direct_conflicts\" and \"all_conflicts\" are, and the description here is self-referential. Do these transactions belong to original, replacement, or both, etc.?",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T20:12:42Z",
      "diff_hunk" : "@@ -106,4 +115,20 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n                                       CFeeRate relay_fee,\n                                       const uint256& txid);\n \n+/**\n+ * The replacement transaction must improve the feerate diagram of the mempool.\n+ * @param[in]   pool                The mempool.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the direct conflicts\n+ * @param[in]   all_conflicts       Set of mempool entries corresponding to all conflicts",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462365378",
      "id" : 1462365378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XKezC",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 122,
      "original_position" : 32,
      "original_start_line" : 121,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462365378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462365378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462385881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462385881"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"Implement ImprovesFeerateDiagram\" (9257f33d259bf68f1df1cc41b7b3caaea341782f):\r\nNit: Spaces around that minus? It took me a moment to realize that dashes arenât a thing in variables. ",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T20:34:34Z",
      "diff_hunk" : "@@ -1248,3 +1249,126 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", txid_string, ancestor_count - 1);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", txid_string, descendant_count - 1);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of all_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // OLD: Compute existing chunks from all affected clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), static_cast<int32_t>(txiter->GetSizeWithAncestors())};\n+            if (individual > package) {\n+                // The individual feerate is higher than the package, and\n+                // therefore higher than the parent's fee. Chunk these\n+                // together.\n+                old_chunks.emplace_back(package);\n+            } else {\n+                // Add two points, one for the parent and one for this child.\n+                old_chunks.emplace_back(package-individual);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462385881",
      "id" : 1462385881,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XKjzZ",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 1335,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462385881/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462385881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462412782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462412782"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"Implement ImprovesFeerateDiagram\" (9257f33d259bf68f1df1cc41b7b3caaea341782f):\r\n\r\n```suggestion\r\n     * @param[in] direct_conflicts    All transactions that would be removed directly (not by being descendants of conflicting transactions)\r\n```",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T20:55:51Z",
      "diff_hunk" : "@@ -734,6 +735,23 @@ class CTxMemPool\n         return m_sequence_number;\n     }\n \n+    /**\n+     * Calculate the old and new mempool feerate diagrams relating to the\n+     * clusters that would be affected by a potential replacement transaction.\n+     *\n+     * @param[in] replacement_fees    Package fees\n+     * @param[in] replacement_vsize   Package size\n+     * @param[in] direct_conflicts    All transactions that would be removed directly (not via descendants)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462412782",
      "id" : 1462412782,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XKqXu",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 744,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462412782/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462412782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462453899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462453899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"test: Add tests for CompareFeerateDiagram and CheckConflictTopology\" (b3d415fe84be7edfbed567a79a25d406b438622b):\r\nNit: I found the comment here confusing. How about: \"`new_diagram` is strictly better due to the first chunk, while the second chunk is worse.\"",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T21:40:35Z",
      "diff_hunk" : "@@ -217,15 +232,113 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // Strictly better but smaller size.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 300}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is sufficiently better, but second chunk is worse.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462453899",
      "id" : 1462453899,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XK0aL",
      "original_commit_id" : "b3d415fe84be7edfbed567a79a25d406b438622b",
      "original_line" : 296,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/test/rbf_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462453899/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462453899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462457196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462457196"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"test: Add tests for CompareFeerateDiagram and CheckConflictTopology\" (b3d415fe84be7edfbed567a79a25d406b438622b):\r\n\r\nNit: in the new diagram, the last two chunks should be one chunk because the last chunk is better (151 sats, 150 vB) than the prior (249 sats, 250 vB).",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T21:44:38Z",
      "diff_hunk" : "@@ -217,15 +232,113 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // Strictly better but smaller size.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 300}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is sufficiently better, but second chunk is worse.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 100}, FeeFrac{1100, 200}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is better, but second chunk is worse\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{750, 100}, FeeFrac{999, 350}, FeeFrac{1150, 500}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462457196",
      "id" : 1462457196,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XK1Ns",
      "original_commit_id" : "b3d415fe84be7edfbed567a79a25d406b438622b",
      "original_line" : 304,
      "original_position" : 214,
      "original_start_line" : 303,
      "path" : "src/test/rbf_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462457196/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462457196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462462868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462462868"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"test: Add tests for CompareFeerateDiagram and CheckConflictTopology\" (b3d415fe84be7edfbed567a79a25d406b438622b):\r\n\r\nThis is the same old_diagram. Did you mean to repeat the same transactions,\r\n```suggestion\r\n\r\n    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 399}};\r\n    new_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\r\n```\r\nor just test in both directions?\r\n```suggestion\r\n```",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-22T21:51:02Z",
      "diff_hunk" : "@@ -217,15 +232,113 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // Strictly better but smaller size.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 300}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is sufficiently better, but second chunk is worse.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 100}, FeeFrac{1100, 200}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is better, but second chunk is worse\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{750, 100}, FeeFrac{999, 350}, FeeFrac{1150, 500}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // If we make the second chunk slightly better, the new diagram now wins.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{750, 100}, FeeFrac{1000, 350}, FeeFrac{1150, 500}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Identical diagrams, cannot be strictly better\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+\n+    BOOST_CHECK(std::is_eq(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Same aggregate fee, but different total size (trigger single tail fee check step)\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 399}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+\n+    // No change in evaluation when tail check needed.\n+    BOOST_CHECK(std::is_gt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 399}};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1462462868",
      "id" : 1462462868,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XK2mU",
      "original_commit_id" : "b3d415fe84be7edfbed567a79a25d406b438622b",
      "original_line" : 328,
      "original_position" : 238,
      "original_start_line" : 326,
      "path" : "src/test/rbf_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1837231759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462462868/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-22T21:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1462462868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463281056"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463281056"
         }
      },
      "author_association" : "MEMBER",
      "body" : "direct_conflicts and all_conflicts. Does that help?",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:26:49Z",
      "diff_hunk" : "@@ -19,6 +19,8 @@\n #include <limits>\n #include <vector>\n \n+#include <compare>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463281056",
      "id" : 1463281056,
      "in_reply_to_id" : 1462332681,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII585XN-Wg",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 22,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 4,
      "pull_request_review_id" : 1838789825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463281056/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:26:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463281056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463285858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463285858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "direct_conflicts -> the set of transactions that have at least one input conflicting with a proposed transaction.\r\nall_conflicts -> Everything that would be evicted by the proposed transaction\r\n\r\nI'll touch this up a bit but this is the nomenclature elsewhere",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:30:37Z",
      "diff_hunk" : "@@ -106,4 +115,20 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n                                       CFeeRate relay_fee,\n                                       const uint256& txid);\n \n+/**\n+ * The replacement transaction must improve the feerate diagram of the mempool.\n+ * @param[in]   pool                The mempool.\n+ * @param[in]   direct_conflicts    Set of txids corresponding to the direct conflicts\n+ * @param[in]   all_conflicts       Set of mempool entries corresponding to all conflicts",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463285858",
      "id" : 1463285858,
      "in_reply_to_id" : 1462365378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XN_hi",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 122,
      "original_position" : 32,
      "original_start_line" : 121,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 1838797602,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463285858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:30:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463285858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314427"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I can't recall honestly, removed that line",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:51:39Z",
      "diff_hunk" : "@@ -217,15 +232,113 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // Strictly better but smaller size.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 300}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is sufficiently better, but second chunk is worse.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 100}, FeeFrac{1100, 200}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is better, but second chunk is worse\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{750, 100}, FeeFrac{999, 350}, FeeFrac{1150, 500}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // If we make the second chunk slightly better, the new diagram now wins.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{750, 100}, FeeFrac{1000, 350}, FeeFrac{1150, 500}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Identical diagrams, cannot be strictly better\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+\n+    BOOST_CHECK(std::is_eq(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Same aggregate fee, but different total size (trigger single tail fee check step)\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 399}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+\n+    // No change in evaluation when tail check needed.\n+    BOOST_CHECK(std::is_gt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 399}};\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314427",
      "id" : 1463314427,
      "in_reply_to_id" : 1462462868,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XOGf7",
      "original_commit_id" : "b3d415fe84be7edfbed567a79a25d406b438622b",
      "original_line" : 328,
      "original_position" : 238,
      "original_start_line" : 326,
      "path" : "src/test/rbf_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1838845793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314427/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:51:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah hmm, I'm not sure that matters for correctness of test, but jacked up the last chunk's size just to make it clearer what we're testing",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:51:42Z",
      "diff_hunk" : "@@ -217,15 +232,113 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // Strictly better but smaller size.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 300}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is sufficiently better, but second chunk is worse.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 100}, FeeFrac{1100, 200}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is better, but second chunk is worse\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{750, 100}, FeeFrac{999, 350}, FeeFrac{1150, 500}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314511",
      "id" : 1463314511,
      "in_reply_to_id" : 1462457196,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XOGhP",
      "original_commit_id" : "b3d415fe84be7edfbed567a79a25d406b438622b",
      "original_line" : 304,
      "original_position" : 214,
      "original_start_line" : 303,
      "path" : "src/test/rbf_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1838845897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314511/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "tried my own re-explanation. I agree as-is is confusing",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:51:45Z",
      "diff_hunk" : "@@ -217,15 +232,113 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};\n+\n+    BOOST_CHECK(CompareFeerateDiagram(old_diagram, new_diagram) == std::partial_ordering::unordered);\n+\n+    // Strictly better but smaller size.\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1100, 300}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Feerate of first chunk is sufficiently better, but second chunk is worse.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314570",
      "id" : 1463314570,
      "in_reply_to_id" : 1462453899,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XOGiK",
      "original_commit_id" : "b3d415fe84be7edfbed567a79a25d406b438622b",
      "original_line" : 296,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/test/rbf_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1838845988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314570/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:51:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "tried my own explanation",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:51:47Z",
      "diff_hunk" : "@@ -734,6 +735,23 @@ class CTxMemPool\n         return m_sequence_number;\n     }\n \n+    /**\n+     * Calculate the old and new mempool feerate diagrams relating to the\n+     * clusters that would be affected by a potential replacement transaction.\n+     *\n+     * @param[in] replacement_fees    Package fees\n+     * @param[in] replacement_vsize   Package size\n+     * @param[in] direct_conflicts    All transactions that would be removed directly (not via descendants)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314620",
      "id" : 1463314620,
      "in_reply_to_id" : 1462412782,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XOGi8",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 744,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 1838846083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314778"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:51:54Z",
      "diff_hunk" : "@@ -1248,3 +1249,126 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", txid_string, ancestor_count - 1);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", txid_string, descendant_count - 1);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.\n+        if (has_descendant) {\n+            const auto& our_child = direct_conflict->GetMemPoolChildrenConst().begin();\n+            if (our_child->get().GetCountWithAncestors() > 2) {\n+                return strprintf(\"%s is not the only parent of child %s\",\n+                                 txid_string, our_child->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        } else if (has_ancestor) {\n+            const auto& our_parent = direct_conflict->GetMemPoolParentsConst().begin();\n+            if (our_parent->get().GetCountWithDescendants() > 2) {\n+                return strprintf(\"%s is not the only child of parent %s\",\n+                                 txid_string, our_parent->get().GetSharedTx()->GetHash().ToString());\n+            }\n+        }\n+    }\n+    return std::nullopt;\n+}\n+\n+std::optional<std::string> CTxMemPool::CalculateFeerateDiagramsForRBF(CAmount replacement_fees, int64_t replacement_vsize, const setEntries& direct_conflicts, const setEntries& all_conflicts, std::vector<FeeFrac>& old_diagram, std::vector<FeeFrac>& new_diagram)\n+{\n+    auto err_string{CheckConflictTopology(direct_conflicts)};\n+    if (err_string.has_value()) {\n+        // Unsupported topology for calculating a feerate diagram\n+        return err_string;\n+    }\n+\n+    // new_diagram will have chunks that consist of each ancestor of\n+    // direct_conflicts that is at its own fee/size, along with the replacement\n+    // tx/package at its own fee/size\n+\n+    // old diagram will consist of each element of all_conflicts either at\n+    // its own feerate (followed by any descendant at its own feerate) or as a\n+    // single chunk at its descendant's ancestor feerate.\n+\n+    std::vector<FeeFrac> old_chunks;\n+    // Step 1: build the old diagram.\n+\n+    // The above clusters are all trivially linearized;\n+    // they have a strict topology of 1 or two connected transactions.\n+\n+    // OLD: Compute existing chunks from all affected clusters\n+    for (auto txiter : all_conflicts) {\n+        // Does this transaction have descendants?\n+        if (txiter->GetCountWithDescendants() > 1) {\n+            // Consider this tx when we consider the descendant.\n+            continue;\n+        }\n+        // Does this transaction have ancestors?\n+        FeeFrac individual{txiter->GetModifiedFee(), txiter->GetTxSize()};\n+        if (txiter->GetCountWithAncestors() > 1) {\n+            // We'll add chunks for either the ancestor by itself and this tx\n+            // by itself, or for a combined package.\n+            FeeFrac package{txiter->GetModFeesWithAncestors(), static_cast<int32_t>(txiter->GetSizeWithAncestors())};\n+            if (individual > package) {\n+                // The individual feerate is higher than the package, and\n+                // therefore higher than the parent's fee. Chunk these\n+                // together.\n+                old_chunks.emplace_back(package);\n+            } else {\n+                // Add two points, one for the parent and one for this child.\n+                old_chunks.emplace_back(package-individual);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463314778",
      "id" : 1463314778,
      "in_reply_to_id" : 1462385881,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XOGla",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 1335,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1838846344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314778/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463314778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463315597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463315597"
         }
      },
      "author_association" : "MEMBER",
      "body" : "taken",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:52:33Z",
      "diff_hunk" : "@@ -1248,3 +1249,126 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", txid_string, ancestor_count - 1);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", txid_string, descendant_count - 1);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463315597",
      "id" : 1463315597,
      "in_reply_to_id" : 1462350586,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XOGyN",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 1271,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1838847715,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463315597/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463315597",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463315777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463315777"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T13:52:40Z",
      "diff_hunk" : "@@ -1248,3 +1249,126 @@ std::vector<CTxMemPool::txiter> CTxMemPool::GatherClusters(const std::vector<uin\n     }\n     return clustered_txs;\n }\n+\n+std::optional<std::string> CTxMemPool::CheckConflictTopology(const setEntries& direct_conflicts)\n+{\n+    for (const auto& direct_conflict : direct_conflicts) {\n+        // Ancestor and descendant counts are inclusive of the tx itself.\n+        const auto ancestor_count{direct_conflict->GetCountWithAncestors()};\n+        const auto descendant_count{direct_conflict->GetCountWithDescendants()};\n+        const bool has_ancestor{ancestor_count > 1};\n+        const bool has_descendant{descendant_count > 1};\n+        const auto& txid_string{direct_conflict->GetSharedTx()->GetHash().ToString()};\n+        // The only allowed configurations are:\n+        // 1 ancestor and 0 descendant\n+        // 0 ancestor and 1 descendant\n+        // 0 ancestor and 0 descendant\n+        if (ancestor_count > 2) {\n+            return strprintf(\"%s has %u ancestors, max 1 allowed\", txid_string, ancestor_count - 1);\n+        } else if (descendant_count > 2) {\n+            return strprintf(\"%s has %u descendants, max 1 allowed\", txid_string, descendant_count - 1);\n+        } else if (has_ancestor && has_descendant) {\n+            return strprintf(\"%s has both ancestor and descendant\", txid_string);\n+        }\n+        // Additionally enforce that:\n+        // If we have a parent, we are its only child.\n+        // If we have a child,  we are its only parent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463315777",
      "id" : 1463315777,
      "in_reply_to_id" : 1462348934,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XOG1B",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 1274,
      "original_position" : 35,
      "original_start_line" : 1274,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1838847976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463315777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-23T13:52:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463315777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@murchandamus comments should be addressed or taken",
      "created_at" : "2024-01-23T13:56:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1906111930",
      "id" : 1906111930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xnPW6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906111930/reactions"
      },
      "updated_at" : "2024-01-23T13:56:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906111930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463859645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463859645"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, that would improve it",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T19:05:54Z",
      "diff_hunk" : "@@ -19,6 +19,8 @@\n #include <limits>\n #include <vector>\n \n+#include <compare>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463859645",
      "id" : 1463859645,
      "in_reply_to_id" : 1462332681,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII585XQLm9",
      "original_commit_id" : "9257f33d259bf68f1df1cc41b7b3caaea341782f",
      "original_line" : 22,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 4,
      "pull_request_review_id" : 1839710319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463859645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-23T19:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463859645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463863198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463863198"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n     *                                having a conflicting input with a proposed transaction\r\n```",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T19:09:34Z",
      "diff_hunk" : "@@ -734,6 +735,24 @@ class CTxMemPool\n         return m_sequence_number;\n     }\n \n+    /**\n+     * Calculate the old and new mempool feerate diagrams relating to the\n+     * clusters that would be affected by a potential replacement transaction.\n+     *\n+     * @param[in] replacement_fees    Package fees\n+     * @param[in] replacement_vsize   Package size\n+     * @param[in] direct_conflicts    All transactions that would be removed directly by\n+     *                                having a conflicting input wih a proposed transaction",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463863198",
      "id" : 1463863198,
      "line" : 745,
      "node_id" : "PRRC_kwDOABII585XQMee",
      "original_commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "original_line" : 745,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 19,
      "pull_request_review_id" : 1839716607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463863198/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-23T19:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463863198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463866212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463866212"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If all diagrams always start with `FeeFrac{0, 0}`, why do we need to mention that as a first element?",
      "commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "created_at" : "2024-01-23T19:12:38Z",
      "diff_hunk" : "@@ -217,15 +232,154 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(improves_feerate, TestChain100Setup)\n+{\n+    CTxMemPool& pool = *Assert(m_node.mempool);\n+    LOCK2(::cs_main, pool.cs);\n+    TestMemPoolEntryHelper entry;\n+\n+    const CAmount low_fee{CENT/100};\n+    const CAmount normal_fee{CENT/10};\n+\n+    // One low feerate txn followed be normal feerate\n+    const auto tx1 = make_tx(/*inputs=*/ {m_coinbase_txns[0]}, /*output_values=*/ {10 * COIN});\n+    pool.addUnchecked(entry.Fee(low_fee).FromTx(tx1));\n+    const auto tx2 = make_tx(/*inputs=*/ {tx1}, /*output_values=*/ {995 * CENT});\n+    pool.addUnchecked(entry.Fee(normal_fee).FromTx(tx2));\n+\n+    const auto entry1 = pool.GetIter(tx1->GetHash()).value();\n+    const auto tx1_fee = entry1->GetModifiedFee();\n+    const auto tx1_size = entry1->GetTxSize();\n+    const auto entry2 = pool.GetIter(tx2->GetHash()).value();\n+    const auto tx2_fee = entry2->GetModifiedFee();\n+    const auto tx2_size = entry2->GetTxSize();\n+\n+    // Now test ImprovesFeerateDiagram with various levels of \"package rbf\" feerates\n+\n+    // It doesn't improve itself\n+    const auto res1 = ImprovesFeerateDiagram(pool, {entry1}, {entry1, entry2}, tx1_fee + tx2_fee, tx1_size + tx2_size);\n+    BOOST_CHECK(res1.has_value());\n+    BOOST_CHECK(res1.value().first == DiagramCheckError::FAILURE);\n+    BOOST_CHECK(res1.value().second == \"insufficient feerate: does not improve feerate diagram\");\n+\n+    // With one more satoshi it does\n+    BOOST_CHECK(ImprovesFeerateDiagram(pool, {entry1}, {entry1, entry2}, tx1_fee + tx2_fee + 1, tx1_size + tx2_size) == std::nullopt);\n+\n+    // Make conflict un-calculable(for now)\n+    const auto tx3 = make_tx(/*inputs=*/ {tx2}, /*output_values=*/ {995 * CENT});\n+    pool.addUnchecked(entry.Fee(normal_fee).FromTx(tx3));\n+    const auto res3 = ImprovesFeerateDiagram(pool, {entry1}, {entry1, entry2}, tx1_fee + tx2_fee + 1, tx1_size + tx2_size);\n+    BOOST_CHECK(res3.has_value());\n+    BOOST_CHECK(res3.value().first == DiagramCheckError::UNCALCULABLE);\n+    BOOST_CHECK(res3.value().second == strprintf(\"%s has 2 descendants, max 1 allowed\", tx1->GetHash().GetHex()));\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1463866212",
      "id" : 1463866212,
      "line" : 328,
      "node_id" : "PRRC_kwDOABII585XQNNk",
      "original_commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "original_line" : 328,
      "original_position" : 238,
      "original_start_line" : 327,
      "path" : "src/test/rbf_tests.cpp",
      "position" : 238,
      "pull_request_review_id" : 1839716607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463866212/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 327,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-23T19:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463866212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\n$ echo \"BAIBAgICAgIABfcN/f11BwAAAPsAAAICAgICAgICAi0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwb3J0AgL+//////8hAQICAooBATIBAR4AAgICAgICAgICAgICAgICAgICAgICAgIC/v///////wECAgKKAQEyAQEeAgIiAgICAgICHgACAgIDAgICAgICAiICAgICAExLQAICAgICAgICAv//////////////////////////////////////////////////////AQEBAQEByQEBAQEBAQEB/P8AAC8AGvsAXAEAAgLcAgICAgICAlSbtqZ56uTNNhvmIHMu83ifTNtXiVGR9z3J4We8dnhZegAAAAAAAAD/AAAAAAAHAAAAAAAAXP96AAAAAgICAgAF9w39/QAAAAEAAAABAgICAgICAgICLZCPcnQCAgIC3AICAgICAgJUm7ameerkzRvmIHMu83ifTNtXiVGR9z3J4We8dnhZegAAAAAAAAAAAAAAAAcABgEAAAAAAAAAAAAAAPsCIlwBAAAHAAAAAQAAAAmLXAEVAAAAAAAAAAAAAAAAAAAAXP+B/////////wAAAAAABwAAAAAAAAAAAAAABwAALAACAgIATEtAAgICAgICAgIC//////////////////////////////////////////////////////8BAQEBAQHJAQEBAQEBAQH8/wAALwAa+wBcAQACAtwCAgICAgICVJu2pnnq5M02G+Ygcy7zeJ9M21eJUZH3PcnhZ7x2eFl6AAAAAAAAAP8AAAAAAAcAAAAAAABc/3oAAAACAgICAAX3Df39AAAAAQAAAAECAgICAgICAgItkI9ydAICAgLcAgICAgICAlSbtqZ56uTNG+Ygcy7zeJ9M21eJUZH3PcnhZ7x2eFl6AAAAAAAAAAAAAAAABwAGAQAAAAAAAAAAAAAA+wIiXAEAAAcAAAABAAAACYtcARUAAAAAAAAAAAAAAAAAAABc/4H/////////AAAAAAAHAAAAAAAAAAAAAAAHAAAsAAAAAPsCAlwBAAAHAAAAAQAAAAmLXAEDAwMDAwMD/729vb29vb29vb29vb29vb29vb29vb29vT+9/wUtYmluvb29vb29vb29vb29vb29vb29vb29/wUtYmluZC0U/////wAAAAAAAAAAHAAAAAAAAP///////////////////////4pVyFwAAAD7AgJcAQAABwAAAAEAAAAJi1wBAwMDAwMDA/+9vb29vb29vb29vb29vb29vb29vb29vb0/vf8FLWJpbr29vb29vb29vb29vb29vb29vb29vf8FLWJpbmQtFP////8AAAAAAAAAABwAAAAAAAD///////////////////////+KVchcToownpjPpiYHL06aRtJ04wyb/sdpyYUpxMKugP////////////////////////9t////AQAAAEZFRUVFRUVFRUVFRUVFRUVFRUVFRUVF/////////////////////3r//////////wMDAwP//////w==\" | base64 --decode > package_rbf-7d643e62d75f4ac67d3bdeaf9f5fbfd67675806a.crash\r\n$ FUZZ=package_rbf ./src/test/fuzz/fuzz package_rbf-7d643e62d75f4ac67d3bdeaf9f5fbfd67675806a.crash\r\nfuzz_libfuzzer: test/fuzz/rbf.cpp:147: void package_rbf_fuzz_target(FuzzBufferType): Assertion `old_diagram.back().fee - replaced_fee + replacement_fees == new_diagram.back().fee' failed.\r\n```",
      "created_at" : "2024-01-23T21:07:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1906919216",
      "id" : 1906919216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xqUcw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906919216/reactions"
      },
      "updated_at" : "2024-01-23T21:07:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906919216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dergoegge fuzzer created a circular reference which caused incongruities between descendant counts and actually walking the descendants in mempool. Please run again?",
      "created_at" : "2024-01-24T15:07:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1908321622",
      "id" : 1908321622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xvq1W",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1908321622/reactions"
      },
      "updated_at" : "2024-01-24T15:07:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1908321622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Please run again?\r\n\r\nRunning now.\r\n\r\nSome coverage reports from the previous runs (one per harness): http://bitcoind-fuzz.dergoegge.de/instagibbs/bitcoin/2024-01-diagram-checks/coverage/",
      "created_at" : "2024-01-24T16:03:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1908435057",
      "id" : 1908435057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585xwGhx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 1,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1908435057/reactions"
      },
      "updated_at" : "2024-01-24T16:03:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1908435057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1466391538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466391538"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "a1414b3388a870aeb463e9cc293d47cbd86e7f0e",
      "created_at" : "2024-01-25T13:37:24Z",
      "diff_hunk" : "@@ -734,6 +735,24 @@ class CTxMemPool\n         return m_sequence_number;\n     }\n \n+    /**\n+     * Calculate the old and new mempool feerate diagrams relating to the\n+     * clusters that would be affected by a potential replacement transaction.\n+     *\n+     * @param[in] replacement_fees    Package fees\n+     * @param[in] replacement_vsize   Package size\n+     * @param[in] direct_conflicts    All transactions that would be removed directly by\n+     *                                having a conflicting input wih a proposed transaction",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1466391538",
      "id" : 1466391538,
      "in_reply_to_id" : 1463863198,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XZ1vy",
      "original_commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "original_line" : 745,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 1843766331,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466391538/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T13:37:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466391538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1466392222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466392222"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll leave this as an ergonomics issue for later debate",
      "commit_id" : "a1414b3388a870aeb463e9cc293d47cbd86e7f0e",
      "created_at" : "2024-01-25T13:37:59Z",
      "diff_hunk" : "@@ -217,15 +232,154 @@ BOOST_FIXTURE_TEST_CASE(rbf_helper_functions, TestChain100Setup)\n     BOOST_CHECK(HasNoNewUnconfirmed(/*tx=*/ *spends_unconfirmed.get(),\n                                     /*pool=*/ pool,\n                                     /*iters_conflicting=*/ all_entries) == std::nullopt);\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, {entry2_normal}) == std::nullopt);\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_unconfirmed.get(), pool, empty_set).has_value());\n \n     const auto spends_new_unconfirmed = make_tx({tx1, tx8}, {36 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2}).has_value());\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, {entry2_normal}).has_value());\n     BOOST_CHECK(HasNoNewUnconfirmed(*spends_new_unconfirmed.get(), pool, all_entries).has_value());\n \n     const auto spends_conflicting_confirmed = make_tx({m_coinbase_txns[0], m_coinbase_txns[1]}, {45 * CENT});\n-    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1, entry3}) == std::nullopt);\n+    BOOST_CHECK(HasNoNewUnconfirmed(*spends_conflicting_confirmed.get(), pool, {entry1_normal, entry3_low}) == std::nullopt);\n+\n+    // Tests for CheckConflictTopology\n+\n+    // Tx4 has 23 descendants\n+    BOOST_CHECK(pool.CheckConflictTopology(set_34_cpfp).has_value());\n+\n+    // No descendants yet\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok\n+    add_descendants(tx9, 1, pool);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained}) == std::nullopt);\n+\n+    // N direct conflicts; ok\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+\n+    // Add 1 descendant, still ok, even if it's considered a direct conflict as well\n+    const auto child_tx = add_descendants(tx10, 1, pool);\n+    const auto entry10_child = pool.GetIter(child_tx->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}) == std::nullopt);\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained, entry10_child}) == std::nullopt);\n+\n+    // One more, size 3 cluster too much\n+    const auto child_tx2 = add_descendants(tx10, 1, pool);\n+    const auto entry10_child2 = pool.GetIter(child_tx2->GetHash()).value();\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_unchained, entry11_unchained}).has_value());\n+    // even if direct conflict is descendent itself\n+    BOOST_CHECK(pool.CheckConflictTopology({entry9_unchained, entry10_child2, entry11_unchained}).has_value());\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(improves_feerate, TestChain100Setup)\n+{\n+    CTxMemPool& pool = *Assert(m_node.mempool);\n+    LOCK2(::cs_main, pool.cs);\n+    TestMemPoolEntryHelper entry;\n+\n+    const CAmount low_fee{CENT/100};\n+    const CAmount normal_fee{CENT/10};\n+\n+    // One low feerate txn followed be normal feerate\n+    const auto tx1 = make_tx(/*inputs=*/ {m_coinbase_txns[0]}, /*output_values=*/ {10 * COIN});\n+    pool.addUnchecked(entry.Fee(low_fee).FromTx(tx1));\n+    const auto tx2 = make_tx(/*inputs=*/ {tx1}, /*output_values=*/ {995 * CENT});\n+    pool.addUnchecked(entry.Fee(normal_fee).FromTx(tx2));\n+\n+    const auto entry1 = pool.GetIter(tx1->GetHash()).value();\n+    const auto tx1_fee = entry1->GetModifiedFee();\n+    const auto tx1_size = entry1->GetTxSize();\n+    const auto entry2 = pool.GetIter(tx2->GetHash()).value();\n+    const auto tx2_fee = entry2->GetModifiedFee();\n+    const auto tx2_size = entry2->GetTxSize();\n+\n+    // Now test ImprovesFeerateDiagram with various levels of \"package rbf\" feerates\n+\n+    // It doesn't improve itself\n+    const auto res1 = ImprovesFeerateDiagram(pool, {entry1}, {entry1, entry2}, tx1_fee + tx2_fee, tx1_size + tx2_size);\n+    BOOST_CHECK(res1.has_value());\n+    BOOST_CHECK(res1.value().first == DiagramCheckError::FAILURE);\n+    BOOST_CHECK(res1.value().second == \"insufficient feerate: does not improve feerate diagram\");\n+\n+    // With one more satoshi it does\n+    BOOST_CHECK(ImprovesFeerateDiagram(pool, {entry1}, {entry1, entry2}, tx1_fee + tx2_fee + 1, tx1_size + tx2_size) == std::nullopt);\n+\n+    // Make conflict un-calculable(for now)\n+    const auto tx3 = make_tx(/*inputs=*/ {tx2}, /*output_values=*/ {995 * CENT});\n+    pool.addUnchecked(entry.Fee(normal_fee).FromTx(tx3));\n+    const auto res3 = ImprovesFeerateDiagram(pool, {entry1}, {entry1, entry2}, tx1_fee + tx2_fee + 1, tx1_size + tx2_size);\n+    BOOST_CHECK(res3.has_value());\n+    BOOST_CHECK(res3.value().first == DiagramCheckError::UNCALCULABLE);\n+    BOOST_CHECK(res3.value().second == strprintf(\"%s has 2 descendants, max 1 allowed\", tx1->GetHash().GetHex()));\n+}\n+\n+BOOST_AUTO_TEST_CASE(feerate_diagram_utilities)\n+{\n+    // Sanity check the correctness of the feerate diagram comparison.\n+\n+    // A strictly better case.\n+    std::vector<FeeFrac> old_diagram{{FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}}};\n+    std::vector<FeeFrac> new_diagram{{FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1050, 400}}};\n+\n+    BOOST_CHECK(std::is_lt(CompareFeerateDiagram(old_diagram, new_diagram)));\n+\n+    // Incomparable diagrams\n+    old_diagram = {FeeFrac{0, 0}, FeeFrac{950, 300}, FeeFrac{1050, 400}};\n+    new_diagram = {FeeFrac{0, 0}, FeeFrac{1000, 300}, FeeFrac{1000, 400}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#discussion_r1466392222",
      "id" : 1466392222,
      "in_reply_to_id" : 1463866212,
      "line" : 328,
      "node_id" : "PRRC_kwDOABII585XZ16e",
      "original_commit_id" : "a14b95129d3a2894b7a41ce919a426bb60f62e35",
      "original_line" : 328,
      "original_position" : 238,
      "original_start_line" : 327,
      "path" : "src/test/rbf_tests.cpp",
      "position" : 238,
      "pull_request_review_id" : 1843767479,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29242",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466392222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 327,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-25T13:38:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466392222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "didn't see any fuzzer crashes locally, all comments addressed",
      "created_at" : "2024-01-25T13:38:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1910238997",
      "id" : 1910238997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585x2-8V",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910238997/reactions"
      },
      "updated_at" : "2024-01-25T13:38:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910238997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK a1414b3388a870aeb463e9cc293d47cbd86e7f0e \r\n\r\nvia rangediff a14b95129d3a2894b7a41ce919a426bb60f62e35..a1414b3388a870aeb463e9cc293d47cbd86e7f0e\r\n\r\nThe changes since my prior ACK appear to only pertain to improvements in the fuzz test to avoid circular packages and a typo fix on a comment in the code.",
      "created_at" : "2024-02-02T18:22:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29242#issuecomment-1924448996",
      "id" : 1924448996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29242",
      "node_id" : "IC_kwDOABII585ytMLk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924448996/reactions"
      },
      "updated_at" : "2024-02-02T18:22:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1924448996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   }
]
