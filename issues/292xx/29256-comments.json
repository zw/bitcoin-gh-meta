[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29256).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept NACK | [ajtowns](https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1894630511) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29432](https://github.com/bitcoin/bitcoin/pull/29432) (Stratum v2 Template Provider (take 3) by Sjors)\n* [#29418](https://github.com/bitcoin/bitcoin/pull/29418) (rpc: provide per message stats for global traffic via new RPC 'getnetmsgstats' by vasild)\n* [#29402](https://github.com/bitcoin/bitcoin/pull/29402) (mempool: Log added for dumping mempool transactions to disk by kevkevinpal)\n* [#29242](https://github.com/bitcoin/bitcoin/pull/29242) (Mempool util: Add RBF diagram checks for single chunks against clusters of size 2 by instagibbs)\n* [#29231](https://github.com/bitcoin/bitcoin/pull/29231) (logging: Update to new logging API by ajtowns)\n* [#29136](https://github.com/bitcoin/bitcoin/pull/29136) (wallet: `addhdkey` RPC to add just keys to wallets via new `void(KEY)` descriptor by achow101)\n* [#28984](https://github.com/bitcoin/bitcoin/pull/28984) (Cluster size 2 package rbf by instagibbs)\n* [#28834](https://github.com/bitcoin/bitcoin/pull/28834) (net: attempts to connect to all resolved addresses when connecting to a node by sr-gi)\n* [#28830](https://github.com/bitcoin/bitcoin/pull/28830) ([refactor] Check CTxMemPool options in ctor by TheCharlatan)\n* [#28765](https://github.com/bitcoin/bitcoin/pull/28765) (p2p: Fill reconciliation sets (Erlay) by naumenkogs)\n* [#28608](https://github.com/bitcoin/bitcoin/pull/28608) (assumeutxo state and locking cleanup by ryanofsky)\n* [#28574](https://github.com/bitcoin/bitcoin/pull/28574) (wallet: optimize migration process, batch db transactions by furszy)\n* [#28333](https://github.com/bitcoin/bitcoin/pull/28333) (wallet: Construct ScriptPubKeyMans with all data rather than loaded progressively by achow101)\n* [#27826](https://github.com/bitcoin/bitcoin/pull/27826) (validation: log which peer sent us a header by Sjors)\n* [#27277](https://github.com/bitcoin/bitcoin/pull/27277) (Move log messages: tx enqueue to mempool, allocation to blockstorage by Sjors)\n* [#27039](https://github.com/bitcoin/bitcoin/pull/27039) (blockstorage: do not flush block to disk if it is already there by pinheadmz)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-01-16T22:09:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1894600378",
      "id" : 1894600378,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585w7U66",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894600378/reactions"
      },
      "updated_at" : "2024-02-27T17:10:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894600378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept NACK from me, this seems much uglier and trickier to work with. I've already written [in depth](https://github.com/bitcoin/bitcoin/pull/28318#issuecomment-1702318968) about why the current approach makes sense, so I'll be brief here.\r\n\r\n> Make them always accept log categories to make it possible to only log messages from a particular component.\r\n\r\nBeing able to avoid logging critical messages is adding a bug, not a feature.\r\n\r\n> Make them less verbose by not requiring BCLog category constants to be specified in individual log prints\r\n\r\n\"+841 -626\" and adding a dummy parameter to most calls does not make things less verbose, and it's also much harder to search for net related logging when the individual log statements just say `m_log` rather than `BCLog::NET`.\r\n\r\n> Make them compatible with wallet logging, which includes the wallet name in log messages\r\n\r\nThe only thing needed here is renaming from `Printf` to `Info`...",
      "created_at" : "2024-01-16T22:34:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1894630511",
      "id" : 1894630511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585w7cRv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894630511/reactions"
      },
      "updated_at" : "2024-01-16T22:34:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894630511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-01-16T23:59:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1894708150",
      "id" : 1894708150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585w7vO2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894708150/reactions"
      },
      "updated_at" : "2024-01-16T23:59:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894708150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hi AJ, this is a draft, and there will be some more changes which may address your concerns.\r\n\r\n> > Make them always accept log categories to make it possible to only log messages from a particular component.\r\n>\r\n> Being able to avoid logging critical messages is adding a bug, not a feature.\r\n\r\nAgree, but the idea here is not to discard log messages, the idea just is to attach meaningful metadata to log messages so they can be filtered by component.\r\n\r\n> > Make them less verbose by not requiring BCLog category constants to be specified in individual log prints\r\n>\r\n> \"+841 -626\" and adding a dummy parameter to most calls does not make things less verbose, and it's also much harder to search for net related logging when the individual log statements just say `m_log` rather than `BCLog::NET`.\r\n\r\nI can probably make the description clearer, but the idea here is that this will make the code less noisy:\r\n\r\n```diff\r\n-LogPrintLevel(BCLog::NET, BCLog::Level::Warning, \"getsockname failed\\n\");\r\n+LogWarning(log, \"getsockname failed\\n\");\r\n```\r\n\r\nIt is true this sacrifices ability to grep by category constants in the source code, and maybe in your judgement that is an unacceptable cost? But in my opinion, if we ever using same category constants in disparate parts of source code, or different category constants in the same part of the source code, it means source code is badly organized and we should fix that instead of resorting to a coping mechanism of searching for constants instead of searching by source path. In my experience, I've haven't used logging frameworks that have encouraged category constants to be scattered and mixed like this, and I don't think it is a good idea.\r\n\r\nThe \"+841 -626\" refactoring is definitely :hankey:-y and I plan to drop it from this PR. The change to the log macros is meant to facilitate that refactoring, not the other way around. I do think we should stop relying on the global logging instance for libbitcoinkernel code, but probably can keep using it elsewhere.\r\n\r\n> > Make them compatible with wallet logging, which includes the wallet name in log messages\r\n>\r\n> The only thing needed here is renaming from `Printf` to `Info`...\r\n\r\nProbably something is lost in communication here, but the idea is to let wallet code use same LogDebug(), LogTrace(), LogInfo(), LogWarning(), LogError() macros other code uses. It just adds a little formatting hook so the wallet name is automatically included when the log source is the wallet. This way full functionality of #29256 is available to the wallet and we can drop WalletLogPrintf and not have dedicated wallet logging functions.\r\n\r\n",
      "created_at" : "2024-01-17T04:41:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1894928988",
      "id" : 1894928988,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585w8lJc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894928988/reactions"
      },
      "updated_at" : "2024-01-17T04:42:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1894928988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/20586125687</sub>",
      "created_at" : "2024-01-17T19:15:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1896474430",
      "id" : 1896474430,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585xCec-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1896474430/reactions"
      },
      "updated_at" : "2024-01-17T19:15:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1896474430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Agree, but the idea here is not to discard log messages, the idea just is to attach meaningful metadata to log messages so they can be filtered by component.\r\n\r\nFiltering is discarding.\r\n\r\nIf you just want to *find* log messages, that what's grep is for, and if you want to make it more fine-grained than \"hey this is an important log message/warning/error\", that's what `-logsourcelocations` is for.\r\n\r\nIf it's any help, I think it's better to think of the sections as not related to which section of the code they appear in so much (again, that's what `-logsourcelocations` is for), but as a subset of the \"debug\" part, in that they let you filter/discard various parts of the full debug log that you would get with `-debug=1`.\r\n \r\n> ```diff\r\n> -LogPrintLevel(BCLog::NET, BCLog::Level::Warning, \"getsockname failed\\n\");\r\n> +LogWarning(log, \"getsockname failed\\n\");\r\n> ```\r\n\r\nThe current code there is noisy because it uses `LogPrintLevel`. The change you're actually making is:\r\n\r\n```diff\r\n-LogWarning(\"getsockname failed\\n\");\r\n+LogWarning(log, \"getsockname failed\\n\");\r\n```\r\n\r\nwhich is adding characters, without adding any information to the reader.\r\n \r\n> It is true this sacrifices ability to grep by category constants in the source code, and maybe in your judgement that is an unacceptable cost?\r\n\r\nI think `LogDebug(BCLog::NET, \"oh no, it all went wrong\\n\")` is better than `LogDebug(m_log, \"oh no, it all went wrong)`. All the characters in the former are doing something useful; `m_log` in the latter isn't (if it weren't for macro magic, we'd write `m_log.Debug(\"...\")` instead, which would be okay at least). I don't think moving the category away from the line of code it's affecting is very useful; and if you want to group all the logs from an individual file together (the way putting `m_log{BCLog::NET}` at the top of the file/class does), then, again, that's what logsourcelocations is for...\r\n\r\n> But in my opinion, if we ever using same category constants in disparate parts of source code, or different category constants in the same part of the source code, it means source code is badly organized and we should fix that instead of resorting to a coping mechanism of searching for constants instead of searching by source path.\r\n\r\nThat's something that already happens: `BCLog::NET` is in timedata and headersync and banman and net and net_processing; `BCLog::VALIDATION` is in validation and validationinterface and flatfile (thought there was a pr to fix that one) and signet; `BCLog::MEMPOOL` is in txmempool, validation and net_processing. It doesn't mean the source code is badly organised, it means different parts of the source are generating related log messages.\r\n\r\n> In my experience, I've haven't used logging frameworks that have encouraged category constants to be scattered and mixed like this, and I don't think it is a good idea.\r\n\r\nI don't think there is anything here \"encouraging\" these categories to be scattered or mixed; most of them are specific to a small set of related files: TOR:torcontrol, HTTP:httpserver, ZMQ:zmq/*, WALLETDB:wallet/*, ESTIMATEFEE:policy/fees.cpp, SELECTCOINS:wallet/coinselection, REINDEX:validation, CMPCTBLOCK:blockencodings, RAND:random.cpp, etc.\r\n\r\nAnd you obviously have worked with code designed this way: that's how `LogPrint` has worked in this codebase since it was implemented in #3009.\r\n\r\n> Probably something is lost in communication here, but the idea is to let wallet code use same LogDebug(), LogTrace(), LogInfo(), LogWarning(), LogError() macros other code uses.\r\n\r\nUpdating `TraceSqlCallback` to call `LogTrace` rather than `LogPrintf` would be an improvement as those messages would get categorised properly; but otherwise this seems like massive overkill just to avoid writing `\"[%s] ...\", walletname, ...`.\r\n\r\n> It just adds a little formatting hook so the wallet name is automatically included when the log source is the wallet. This way full functionality of #29256 is available to the wallet and we can drop WalletLogPrintf and not have dedicated wallet logging functions.\r\n\r\nA +190 -109 diff because you don't like a one-line wrapper function seems crazy to me.\r\n\r\nDo you have some reason to think there's large amounts of additional wallet debug logs that would be introduced if it didn't involve writing `[%s], walletname` or are there a bunch of the current unconditional `WalletLogPrintf` calls that should be silenced and only available when debugging is enabled?",
      "created_at" : "2024-01-19T06:12:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1899825975",
      "id" : 1899825975,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585xPQs3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899825975/reactions"
      },
      "updated_at" : "2024-01-19T06:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899825975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ajtowns, to try to steer this discussion in a more constructive direction, would it be possible for you to make a list of the biggest harms you believe this PR would cause if it were merged? And if you have ideas on how the harms you see could be avoided, while the problems I am trying to solve (see \"Problems this PR attempts to solve\" in the PR description) could be addressed, it would be really helpful to know about. Maybe the harms you see this PR causing and the problems this PR is trying to solve are in direct contradiction, but it's not obvious to me that this is the case, so maybe there is a way out of our disagreement here. In the meantime, I responded to your last message below.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1899825975\r\n\r\n> Filtering is discarding.\r\n\r\nIt's really not. You can view logs into a text editor or log viewer and highlight categories of messages you are interested in while not discarding other messages.\r\n\r\nI am just trying to add some basic flexibility here. If you don't want to attach categories to log messages, you don't have to, you can write `LogWarning({}, \"uncategorizable warning\")`. The PR just makes the log macros consistently accept a source parameter, so code has flexibility to set a category, set a log destination, add metadata to log messages, control log formatting, do a combination of these things, or do none of these things.\r\n\r\n> ```diff\r\n> -LogWarning(\"getsockname failed\\n\");\r\n> +LogWarning(log, \"getsockname failed\\n\");\r\n> ```\r\n> which is adding characters, without adding any information to the reader.\r\n\r\nThis adds 5 characters, but also adds category information that was previously absent to the output. You can find examples of where the API changes in this PR increase verbosity, and examples where they decrease it, and I think there should be less verbosity on net. I also think some of this discussion around verbosity misses the bigger picture, and is a distraction from the actual goal of the PR, which is to add context to log messages, and give code that needs it control over logging behavior. But if making the log parameter optional is a requirement for you, it should be possible to implement that here and never increase verbosity in any case.\r\n\r\n> All the characters in the former are doing something useful; `m_log` in the latter isn't (if it weren't for macro magic, we'd write `m_log.Debug(\"...\")` instead, which would be okay at least).\r\n\r\nI agree `m_log.Debug(\"...\")` would be better than `LogDebug(m_log, \"...\")` but I don't understand why the former would be ok, but the latter is unacceptable. You definitely have much stronger opinions about verbosity than me, so maybe we can try to engage more constructively on this. I think on net, this PR should reduce verbosity, but maybe more improvements are possible that could alleviate your concerns.\r\n\r\n> I don't think moving the category away from the line of code it's affecting is very useful\r\n\r\nThat's ok, since allowing this was a side effect, not a major goal of this PR. But `LogDebug(m_log, \"debug message\")` can be easier to write and read than `LogDebug(BCLog::TXRECONCILIATION, \"debug message\")`, especially if the code has a lot of log prints and the category is repeated a lot. In any case, you aren't forced to choose one approach or the other. The PR allows both.\r\n\r\n> It doesn't mean the source code is badly organised, it means different parts of the source are generating related log messages.\r\n\r\nOk, we definitely disagree on how well the code is organized. IMO, `validation.cpp` doing `BCLog::MEMPOOL` prints is messed up. But this is a tangent. I think log sources should encourage better organization, but this PR does not force anything or break anything that works now.\r\n\r\n> I don't think there is anything here \"encouraging\" these categories to be scattered or mixed\r\n\r\nI don't want to make a big deal out of this, but just to clarify, I think the status quo where trace and debug macros require `BCLog::LogFlags` arguments and can't take source arguments makes it easier to mix up categories, intentionally and unintentionally. The alternative where source objects can be used for error/warning/info prints, not just debug/trace prints, and can tag everything with the same category should make it easier to be consistent if you want to be consistent (and not get in the way if you don't want to).\r\n\r\n> Updating `TraceSqlCallback` to call `LogTrace` rather than `LogPrintf` would be an improvement as those messages would get categorised properly; but otherwise this seems like massive overkill just to avoid writing `\"[%s] ...\", walletname, ...`.\r\n\r\nI don't see the massive overkill. This is a reasonable PR that adds documentation, tests, and doesn't change very much code. We don't want to require every individual wallet log print to include `\"[%s] ...\", walletname, ...` boilerplate for obvious reasons, I think. The problems with the `WalletLogPrintf` function are:\r\n\r\n1. It is only capable of logging at info level, does not provide a way to log at higher or lower levels.\r\n2. It evaluates its arguments unconditionally, so if it were extended to log at lower levels, it would either be inefficient or need to duplicate preprocessor code from logging.h to be as efficient.\r\n3. It is inconsistent with the rest of the codebase. It is nice if the same logging macros can be used everywhere, and the same features can be used everywhere. It also ensures logging is consistent within the wallet and only one logging API is used there.",
      "created_at" : "2024-01-25T20:03:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1910905907",
      "id" : 1910905907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585x5hwz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910905907/reactions"
      },
      "updated_at" : "2024-01-25T20:04:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910905907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1910905907\r\n\r\n> But if making the log parameter optional is a requirement for you, it should be possible to implement that here and never increase verbosity in any case.\r\n\r\nIt turns out making the category argument completely optional is not too hard to implement: 69e69b2a82c95f8040be093a29e5f84c37641f3a. So you could write:\r\n\r\n ```c++\r\nLogWarning(\"uncategorizable warning\")\r\n```\r\n\r\ninstead of\r\n\r\n ```\r\nLogWarning({}, \"uncategorizable warning\")\r\n```\r\n\r\nif that is the blocker here.",
      "created_at" : "2024-01-29T03:45:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1913911460",
      "id" : 1913911460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585yE_ik",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1913911460/reactions"
      },
      "updated_at" : "2024-01-29T03:45:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1913911460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> And if you have ideas on how the harms you see could be avoided, while the problems I am trying to solve (see \"Problems this PR attempts to solve\" in the PR description) could be addressed, \r\n\r\nI think the problem you are actually attempting to solve is [\"I, ryanofsky, find this weird and I don't like it\"](https://github.com/bitcoin/bitcoin/pull/28318#discussion_r1450411706), and I don't think code changes are the way of solving that, any more than code changes are the right way to solve the problem \"Bitcoin is weird and I don't like it\". I think you're wrong, but you seem unwilling to consider changing your opinion, so I'm pretty doubtful this is going to be productive. However, in case I'm wrong:\r\n\r\n> These macros cannot be used directly in wallet code because wallet log prints are supposed to automatically attach wallet names to log messages.\r\n\r\nThe only cases where wallet names are automatically attached to log messages are in info level calls, which can be trivially dealt with by changing the existing wrapper to call `LogInfo`, and with an optional scripted diff renaming the wrapper as well.\r\n\r\n> These macros cannot be used at all in libbitcoinkernel code because they do not allow specifying a logger instance. \r\n\r\nThis, also, is not true: the assumption of these macros is that there is a global `BCLog::Logger` instance, which is already provided by `LogInstance()`. If we want to allow apps to configure libbitcoinkernel's logging in future, we could allow them to setup that global instance, or provide their own callbacks for it to use, in much the same way libevent allows you to setup callbacks. That's not something that needs changing.\r\n\r\n> > Filtering is discarding.\r\n> \r\n> It's really not. You can view logs into a text editor or log viewer and highlight categories of messages you are interested in while not discarding other messages.\r\n\r\nThat's not filtering, that's 'grepping'. If you don't want to filter, but just want to highlight, then, as I've said repeatedly, logsourcelocations is what you want; the only benefit categories have compared to that is that categories can be (and by default are) filtered/discarded. logsourcelocations gives you much more exact information, is precisely separated by source file as you want, works with every level of log message, and requires no code changes or ongoing development effort to support.\r\n\r\n> I am just trying to add some basic flexibility here. If you don't want to attach categories to log messages, you don't have to, you can write `LogWarning({}, \"uncategorizable warning\")`.\r\n\r\nIn that case you will not be able to use your log viewer to highlight that message when you're looking for it, which defeats your claimed goal. (Except, of course, you can select it for highlight, by looking for `[warning]` markers)\r\n\r\n> The PR just makes the log macros consistently accept a source parameter,\r\n\r\nCan you please try using the logsourcelocations option before replying again? I really don't see how it doesn't already do everything you want, but you've ignored it every time I've mentioned it.\r\n\r\n> > ```diff\r\n> > -LogWarning(\"getsockname failed\\n\");\r\n> > +LogWarning(log, \"getsockname failed\\n\");\r\n> > ```\r\n> > which is adding characters, without adding any information to the reader.\r\n\r\nThe reader of the source code, is who I'm referring to here.\r\n \r\n> > All the characters in the former are doing something useful; `m_log` in the latter isn't (if it weren't for macro magic, we'd write `m_log.Debug(\"...\")` instead, which would be okay at least).\r\n> \r\n> I agree `m_log.Debug(\"...\")` would be better than `LogDebug(m_log, \"...\")`\r\n\r\nI don't think `m_log.Debug()` would be better than `LogDebug` -- in my opinion having a global log instance is the right thing here, and both having multiple references to a global log instance or having multiple log instances that all then coordinate writing to a single log would be worse.\r\n\r\nAs I've already said, I think `m_log.SetCategory(NET); m_log.Debug(\"connected to foo\")` is much worse than `LogDebug(NET, \"connected to foo\")`. Having to keep more context/state in your head when you're looking at code makes things harder, and it tends to make tool use go from \"usually works\" to \"never works\" (eg, `grep -RIl 'Log.*NET'`).\r\n \r\n> > It doesn't mean the source code is badly organised, it means different parts of the source are generating related log messages.\r\n> \r\n> Ok, we definitely disagree on how well the code is organized. IMO, `validation.cpp` doing `BCLog::MEMPOOL` prints is messed up. But this is a tangent. I think log sources should encourage better organization, but this PR does not force anything or break anything that works now.\r\n\r\nvalidation.cpp is where we have the code for \"is this valid for the mempool\", because we thought the word \"valid\" was more important than the word \"mempool\" in that sentence. `BCLog::VALIDATION` on the other hand is limited to blocks and headers, allowing it to be much less noisy than anything that triggers for every transaction, like `BCLog::MEMPOOL`. None of that is any indication of whether the code is well or badly organised.\r\n\r\n> > I don't think there is anything here \"encouraging\" these categories to be scattered or mixed\r\n> \r\n> I don't want to make a big deal out of this, but just to clarify, I think the status quo where trace and debug macros require `BCLog::LogFlags` arguments and can't take source arguments makes it easier to mix up categories, intentionally and unintentionally.\r\n\r\nI think by \"source arguments\" you mean \"a context argument\", and there's no reason they couldn't -- you can write `LogDebug(m_log_category, \"stuff\");` right now just as easily as you could `LogDebug(m_log, \"stuff\");` after this PR. That would still be a bad idea, though, as having the name of the log category obvious in the code is helpful.\r\n \r\n> > Updating `TraceSqlCallback` to call `LogTrace` rather than `LogPrintf` would be an improvement as those messages would get categorised properly; but otherwise this seems like massive overkill just to avoid writing `\"[%s] ...\", walletname, ...`.\r\n> \r\n> I don't see the massive overkill.\r\n\r\nIf there's a way of getting 99% of the benefits with a +1-1 change, then a +300-200 change is overkill in general.\r\n\r\n> This is a reasonable PR that adds documentation, tests, and doesn't change very much code. We don't want to require every individual wallet log print to include `\"[%s] ...\", walletname, ...` boilerplate for obvious reasons, I think. The problems with the `WalletLogPrintf` function are:\r\n> \r\n>     1. It is only capable of logging at info level, does not provide a way to log at higher or lower levels.\r\n\r\nWhy do you think that is a problem? None of the other existing cases need to add walletname boilerplate. What wallet-specific event (if it's not wallet specific, it doesn't need to be tagged with a wallet name) shouldn't be unconditionally logged (if an event is affecting the thing that holds all your funds, isn't that one of the most important things to log)?\r\n\r\n>     2. It evaluates its arguments unconditionally, so if it were extended to log at lower levels, it would either be inefficient or need to duplicate preprocessor code from logging.h to be as efficient.\r\n\r\nThat it only logs at info level means it is unconditionally logged, so all the arguments are naturally unconditionally evaluated.\r\n\r\n>     3. It is inconsistent with the rest of the codebase.\r\n\r\nIt's inconsistent with your idea of how the codebase should be, but it's completely consistent with how the codebase actually is. Which is fine: changing the codebase to match better ideas is how you improve it. But things aren't going to improve if we can't recognise how things actually are in the first place.",
      "created_at" : "2024-01-29T05:32:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1913991867",
      "id" : 1913991867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585yFTK7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1913991867/reactions"
      },
      "updated_at" : "2024-01-29T05:32:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1913991867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/20597453668</sub>",
      "created_at" : "2024-02-10T12:18:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1936993273",
      "id" : 1936993273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII585zdCv5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936993273/reactions"
      },
      "updated_at" : "2024-02-10T12:18:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1936993273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 99feed7350b5fc3ae3157dd395ae6260c5bfc092 -> 0cd1616d47e61e125eb3e573573c0c56fba6b775 ([`pr/bclog.12`](https://github.com/ryanofsky/bitcoin/commits/pr/bclog.12) -> [`pr/bclog.13`](https://github.com/ryanofsky/bitcoin/commits/pr/bclog.13), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/bclog.12..pr/bclog.13)) making the log macros backwards compatible to avoid any controversial changes.\r\nRebased 0cd1616d47e61e125eb3e573573c0c56fba6b775 -> 93d37f7d655409e6830475a10f4c9f16e35c76cd ([`pr/bclog.13`](https://github.com/ryanofsky/bitcoin/commits/pr/bclog.13) -> [`pr/bclog.14`](https://github.com/ryanofsky/bitcoin/commits/pr/bclog.14), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/bclog.13-rebase..pr/bclog.14)) due to silent conflicts with #26836.\r\n\r\n> If some parts of this PR cause controversy, could it be reduced to the non-controversial things?\r\n\r\nI made a try at this in the latest push. I think most of the criticism of this PR from AJ is saying that the changes here are unnecessary, not really that they are harmful, so I made the logging macros completely backwards compatible using the approach I mentioned https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1913911460, and only kept the changes I think are essential. I think this should help.",
      "created_at" : "2024-02-27T23:05:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-1967871169",
      "id" : 1967871169,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29256",
      "node_id" : "IC_kwDOABII5851S1TB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967871169/reactions"
      },
      "updated_at" : "2024-02-27T23:46:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967871169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
