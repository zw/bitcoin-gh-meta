[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29253).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1854204356), [achow101](https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919841411) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29112](https://github.com/bitcoin/bitcoin/pull/29112) (sqlite: Disallow writing from multiple `SQLiteBatch`s by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-01-16T00:41:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1892913940",
      "id" : 1892913940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585w05MU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1892913940/reactions"
      },
      "updated_at" : "2024-01-31T20:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1892913940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453968110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 83c807a380b41787214806c6440236ea1a9dabd7 \"sqlite: introduce HasActiveTxn method\"\r\n\r\n`HasActiveTxn()` checks for `m_db` already, so no need to do check that here too.\r\n\r\nSame for `TxnCommit()` and `TxnAbort()`.",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-16T20:10:05Z",
      "diff_hunk" : "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453968110",
      "id" : 1453968110,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Wqcru",
      "original_commit_id" : "83c807a380b41787214806c6440236ea1a9dabd7",
      "original_line" : 620,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1824875743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:11:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453982729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "upps done",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-16T20:22:19Z",
      "diff_hunk" : "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453982729",
      "id" : 1453982729,
      "in_reply_to_id" : 1453968110,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585WqgQJ",
      "original_commit_id" : "83c807a380b41787214806c6440236ea1a9dabd7",
      "original_line" : 620,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1824891279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:22:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1461745349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1461745349"
         }
      },
      "author_association" : "NONE",
      "body" : "src/wallet/sqlite.h\r\n",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-22T11:46:31Z",
      "diff_hunk" : "@@ -57,10 +66,15 @@ class SQLiteBatch : public DatabaseBatch\n     bool HasKey(DataStream&& key) override;\n     bool ErasePrefix(Span<const std::byte> prefix) override;\n \n+    // Execute statement\n+    int Exec(const std::string& statement);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1461745349",
      "id" : 1461745349,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII585XIHbF",
      "original_commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "original_line" : 71,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : 27,
      "pull_request_review_id" : 1836280625,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1461745349/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-22T11:46:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1461745349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/156127317?v=4",
         "events_url" : "https://api.github.com/users/moemat12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/moemat12/followers",
         "following_url" : "https://api.github.com/users/moemat12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/moemat12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/moemat12",
         "id" : 156127317,
         "login" : "moemat12",
         "node_id" : "U_kgDOCU5QVQ",
         "organizations_url" : "https://api.github.com/users/moemat12/orgs",
         "received_events_url" : "https://api.github.com/users/moemat12/received_events",
         "repos_url" : "https://api.github.com/users/moemat12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/moemat12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/moemat12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/moemat12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1463377113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463377113"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: add ability to interrupt statements\" (ca39d812e4766575e25721296fa2d43dfe7eba7e)\r\n\r\nIt would be good to define -999 as a constant so callers could check for this error. Or if there probably won't be a need for callers to do that, it would be clearer to return SQLITE_ERROR.",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-23T14:36:43Z",
      "diff_hunk" : "@@ -493,6 +493,12 @@ bool SQLiteBatch::ExecStatement(sqlite3_stmt* stmt, Span<const std::byte> blob)\n     return res == SQLITE_DONE;\n }\n \n+int SQLiteBatch::Exec(const std::string& statement)\n+{\n+    if (m_exec_handler && !m_exec_handler->CanExecute(statement)) return -999;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1463377113",
      "id" : 1463377113,
      "line" : 519,
      "node_id" : "PRRC_kwDOABII585XOVzZ",
      "original_commit_id" : "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "original_line" : 498,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 55,
      "pull_request_review_id" : 1838949232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463377113/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T21:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463377113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm trying to understand this, but confused about why executing \"ROLLBACK TRANSACTION\" would be expected to fail in sqlite. It seems like the fix in e5217fea1516120643f4a7a55a474648e21e2269 is handling failure to roll back by trying to close and reopen the database. But I don't understand why rolling back a transaction would fail to begin with, unless there was some serious error like disk corruption. Probably to make the this fix clearer and safer it would be good to check the specific error code from the failed rollback instead of just checking res == SQLITE_OK. But I'm generally just confused.\r\n",
      "created_at" : "2024-01-23T15:09:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1906252904",
      "id" : 1906252904,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585xnxxo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906252904/reactions"
      },
      "updated_at" : "2024-01-23T15:09:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906252904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">  if there is a failure during the WalletBatch destruction (independently on if it is due to a fatal or transient and recoverable error, like a busy db or a loss of the db connection)\r\n\r\nYes I've started reviewing both PR's and the code changes seem reasonable, I just don't understand what motivated this PR, because \"failure during the WalletBatch destruction\" seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs? Or did you just notice that the error handling in the destructor wasn't very good, and decide to fix it? Or can failures to roll back actually happen in more cases than it seems, and this is a bug that could happen during normal operation without data corruption?",
      "created_at" : "2024-01-25T16:09:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910522489",
      "id" : 1910522489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585x4EJ5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910522489/reactions"
      },
      "updated_at" : "2024-01-25T16:09:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910522489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs?\r\n\r\nIt shouldn't ever happen.\r\n\r\nIn general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?",
      "created_at" : "2024-01-25T16:33:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910567093",
      "id" : 1910567093,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585x4PC1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910567093/reactions"
      },
      "updated_at" : "2024-01-25T16:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910567093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466931843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466931843"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: add ability to interrupt statements\" (ca39d812e4766575e25721296fa2d43dfe7eba7e)\r\n\r\nWould suggest calling this `SQliteExecBlocker`, or maybe `SQliteExecHook` or `SQliteTestHook` if you anticipate it being used more broadly for other things in the future. \"ExecHandler\" seems like the wrong name because the class itself isn't executing anything and doesn't call sqlite3_exec.\r\n\r\nWould also suggest adding a comment saying this is used for testing, because otherwise it's not clear why `CanExecute` would ever return false.\r\n\r\nAlso, in case you _don't_ anticipate the class being extended used for other things in the future, you could replace it with a std::function, since it does only have one virtual method.",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-25T20:34:21Z",
      "diff_hunk" : "@@ -36,11 +36,20 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class SQliteExecHandler",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466931843",
      "id" : 1466931843,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585Xb5qD",
      "original_commit_id" : "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "original_line" : 39,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : 4,
      "pull_request_review_id" : 1838949232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466931843/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T21:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466931843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466947379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466947379"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nIt would be nice to have a comment explaining the use of sqlite3_get_autocommit, since the name doesn't really explain what it is doing. Maybe \"// sqlite3_get_autocommit returns true by default, and false if a transaction has begun and not been committed or rolled back.\"\r\n\r\nAlso, I noticed https://www.sqlite.org/c3ref/get_autocommit.html says \"If another thread changes the autocommit status of the database connection while this routine is running, then the return value is undefined\" so it seems like we probably need to be using a mutex for this. (That would be a pre-existing issue not related to this PR.)",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-25T20:50:38Z",
      "diff_hunk" : "@@ -377,6 +377,11 @@ void SQLiteDatabase::Close()\n     m_db = nullptr;\n }\n \n+bool SQLiteDatabase::HasActiveTxn()\n+{\n+    return m_db && sqlite3_get_autocommit(m_db) == 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466947379",
      "id" : 1466947379,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII585Xb9cz",
      "original_commit_id" : "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "original_line" : 382,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 6,
      "pull_request_review_id" : 1838949232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466947379/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T21:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466947379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466953925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466953925"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nThere appears to be a bug here. Previously it would return false if `m_db` is null. Now it will try to execute begin transaction. I think you need to keep the `!m_database.m_db` condition",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-25T20:58:31Z",
      "diff_hunk" : "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (m_database.HasActiveTxn()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466953925",
      "id" : 1466953925,
      "line" : 636,
      "node_id" : "PRRC_kwDOABII585Xb_DF",
      "original_commit_id" : "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "original_line" : 620,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 68,
      "pull_request_review_id" : 1838949232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466953925/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T21:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466953925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466956009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466956009"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nWould be good to drop the parenthetical about autocommit mode here, since that's now an implementation detail of HasActiveTxn()",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-25T21:00:59Z",
      "diff_hunk" : "@@ -395,7 +400,7 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466956009",
      "id" : 1466956009,
      "line" : 402,
      "node_id" : "PRRC_kwDOABII585Xb_jp",
      "original_commit_id" : "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "original_line" : 402,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 15,
      "pull_request_review_id" : 1838949232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466956009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T21:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466956009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466966956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466966956"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: guard against dangling to-be-reverted db transactions\" (508fda2fddfef0cefedde9777c914aec72adf7fb)\r\n\r\nI found this comment confusing because I couldn't figure out when failing to abort a transaction would ever be expected to happen, and what the error handling strategy was supposed to be when it did happen. Would maybe suggest: \"// If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back.\"\r\n\r\n\r\n\r\n",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-25T21:14:14Z",
      "diff_hunk" : "@@ -400,11 +400,16 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress\n+    bool force_conn_refresh = false;\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // In case we cannot abort the transaction, prevent other handler/s from dumping the ongoing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466966956",
      "id" : 1466966956,
      "line" : 408,
      "node_id" : "PRRC_kwDOABII585XcCOs",
      "original_commit_id" : "508fda2fddfef0cefedde9777c914aec72adf7fb",
      "original_line" : 408,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 23,
      "pull_request_review_id" : 1838949232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466966956/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T21:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466966956",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466968974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466968974"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: sqlite, add coverage for dangling to-be-reverted db txns\" (d4ebac8381801d024b69d5f1f5a13246c61edbe4)\r\n\r\nI think it would be a little more consistent with other code to call this variable \"batch\" instead of \"handler.\" Also calling it handler gets a little confusing when code below sets a handler on the handler.",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-25T21:16:43Z",
      "diff_hunk" : "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466968974",
      "id" : 1466968974,
      "line" : 254,
      "node_id" : "PRRC_kwDOABII585XcCuO",
      "original_commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "original_line" : 254,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/test/db_tests.cpp",
      "position" : 27,
      "pull_request_review_id" : 1838949232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466968974/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-25T21:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466968974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I just don't understand what motivated this PR, because \"failure during the WalletBatch destruction\" seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs? Or did you just notice that the error handling in the destructor wasn't very good, and decide to fix it? Or can failures to roll back actually happen in more cases than it seems, and this is a bug that could happen during normal operation without data corruption?\r\n\r\nYeah, I just noted that the error handling in the destructor isn't optimal. That if this ever occurs in #29112, the introduced database mutex would lock indefinitely.\r\nThen, I considered the same event in current master: which could lead to the writing of a dangling transaction to disk, which would corrupt the wallet and leave it at a non-recoverable point. Which is quite bad. And that motivated me to split the PR and force the txn rollback within the WalletBatch context as a last resource safety measure.\r\n\r\n> In general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?\r\n\r\nIt wouldn't be ideal if the error is still recoverable (e.g. [SQLITE_BUSY](https://sqlite.org/rescode.html#busy) if we ever introduce concurrent txns).\r\nAt least in this scenario, where we are destroying the object that created the transaction, I believe triggering the database connection reset is acceptable as a first measure. If it fails, then yeah, I agree that unloading the wallet instead of exiting the node would be desirable.",
      "created_at" : "2024-01-25T22:47:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1911119751",
      "id" : 1911119751,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585x6V-H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1911119751/reactions"
      },
      "updated_at" : "2024-01-26T14:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1911119751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, done. Comment added.",
      "commit_id" : "493cfc728aa7835527b1eab179b8cb36edd60946",
      "created_at" : "2024-01-26T13:05:00Z",
      "diff_hunk" : "@@ -377,6 +377,11 @@ void SQLiteDatabase::Close()\n     m_db = nullptr;\n }\n \n+bool SQLiteDatabase::HasActiveTxn()\n+{\n+    return m_db && sqlite3_get_autocommit(m_db) == 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629193",
      "id" : 1467629193,
      "in_reply_to_id" : 1466947379,
      "line" : 383,
      "node_id" : "PRRC_kwDOABII585Xej6J",
      "original_commit_id" : "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "original_line" : 383,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 7,
      "pull_request_review_id" : 1845717595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629193/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T13:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629362"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "493cfc728aa7835527b1eab179b8cb36edd60946",
      "created_at" : "2024-01-26T13:05:10Z",
      "diff_hunk" : "@@ -395,7 +400,7 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629362",
      "id" : 1467629362,
      "in_reply_to_id" : 1466956009,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Xej8y",
      "original_commit_id" : "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "original_line" : 402,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1845717595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629362/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T13:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467631981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467631981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, done. Have slightly rephrased the suggestion. Thanks",
      "commit_id" : "493cfc728aa7835527b1eab179b8cb36edd60946",
      "created_at" : "2024-01-26T13:08:19Z",
      "diff_hunk" : "@@ -400,11 +400,16 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress\n+    bool force_conn_refresh = false;\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // In case we cannot abort the transaction, prevent other handler/s from dumping the ongoing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467631981",
      "id" : 1467631981,
      "in_reply_to_id" : 1466966956,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Xeklt",
      "original_commit_id" : "508fda2fddfef0cefedde9777c914aec72adf7fb",
      "original_line" : 408,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1845717595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467631981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T13:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467631981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634309"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure. Created a constant for the -999 error in the new approach.",
      "commit_id" : "493cfc728aa7835527b1eab179b8cb36edd60946",
      "created_at" : "2024-01-26T13:10:36Z",
      "diff_hunk" : "@@ -493,6 +493,12 @@ bool SQLiteBatch::ExecStatement(sqlite3_stmt* stmt, Span<const std::byte> blob)\n     return res == SQLITE_DONE;\n }\n \n+int SQLiteBatch::Exec(const std::string& statement)\n+{\n+    if (m_exec_handler && !m_exec_handler->CanExecute(statement)) return -999;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634309",
      "id" : 1467634309,
      "in_reply_to_id" : 1463377113,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XelKF",
      "original_commit_id" : "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "original_line" : 498,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1845717595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634309/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T13:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "upps thanks. Fixed.",
      "commit_id" : "493cfc728aa7835527b1eab179b8cb36edd60946",
      "created_at" : "2024-01-26T13:10:51Z",
      "diff_hunk" : "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (m_database.HasActiveTxn()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634537",
      "id" : 1467634537,
      "in_reply_to_id" : 1466953925,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XelNp",
      "original_commit_id" : "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "original_line" : 620,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1845717595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T13:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467640407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467640407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, this was meant to be a class encapsulating all sqlite functions so that we can trigger different errors and improve and test our error-handling code. I'm not sure why I implemented `CanExecute` instead of decoupling the `Exec()`, but well.. I just changed the implementation to follow the initial idea. Thanks for pointing this out.",
      "commit_id" : "493cfc728aa7835527b1eab179b8cb36edd60946",
      "created_at" : "2024-01-26T13:17:28Z",
      "diff_hunk" : "@@ -36,11 +36,20 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class SQliteExecHandler",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467640407",
      "id" : 1467640407,
      "in_reply_to_id" : 1466931843,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XempX",
      "original_commit_id" : "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "original_line" : 39,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : null,
      "pull_request_review_id" : 1845717595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467640407/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T13:33:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467640407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467644011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467644011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So true that it hurts.\r\nI tend to call the `WalletBatch` handler because 'batch' refers to a class that groups operations and dumps the result all at once atomically at the end of the process. This is something that the `WalletBatch` class doesn't do unless we explicitly begin and finish the transaction.",
      "commit_id" : "493cfc728aa7835527b1eab179b8cb36edd60946",
      "created_at" : "2024-01-26T13:21:14Z",
      "diff_hunk" : "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467644011",
      "id" : 1467644011,
      "in_reply_to_id" : 1466968974,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Xenhr",
      "original_commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "original_line" : 254,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/test/db_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1845717595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467644011/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-26T13:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467644011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1469966356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469966356"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: add ability to interrupt statements\" (53c4f1334ee300e2228974b4abca51c38087c51c)\r\n\r\nWould suggest a rename and comment.\r\n\r\nThis class is SQLite specific, but unlike other other classes in this file it does not have SQLite in the name. Would suggest calling it `SQliteExecInterface` since it is an abstract class with all virtual methods.\r\n\r\nAlso, it's not initially clear why this class and the class below exist. Would suggest adding a doxygen comment like //* Abstract class responsible for executing SQL statements in SQLite databases. It is abstract so it can be overridden by unit tests testing unusual database conditions. */\r\n\r\n---\r\n\r\nEDIT: Alternately you could combine ExecHandler and SQliteExecHandler into a single class. This would also simplify the unit test because it could just inherit from SQliteExecHandler instead of inheriting from ExecHandler and containing SQliteExecHandler.",
      "commit_id" : "756bed0529b46944162c02c783ecc804f802b637",
      "created_at" : "2024-01-29T17:36:23Z",
      "diff_hunk" : "@@ -36,11 +36,26 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class ExecHandler",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1469966356",
      "id" : 1469966356,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XnegU",
      "original_commit_id" : "53c4f1334ee300e2228974b4abca51c38087c51c",
      "original_line" : 39,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : null,
      "pull_request_review_id" : 1849338675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469966356/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-29T19:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469966356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470026684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470026684"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: guard against dangling to-be-reverted db transactions\" (0bf3a7356db224d28a86194b004ca30549197f27)\r\n\r\nI think this comment might be more harmful than helpful in its current form, because it isn't communicating the most important thing, which is that this code path is never expected to be hit under normal conditions, and if it is hit, it means something is seriously wrong and there has probably been data loss, if not data corruption. By saying this failure can happen when the connection is \"busy\", it makes it sound like database could just be waiting for a lock. But locking alone could never trigger this, so suggesting that it could raises doubts about the rest of the code, and makes the handling here seem to be unnecessary.\r\n\r\nAlso saying \"this action will automatically rollback the transaction ensuring...\" seems like an overstatement. Even if it's probably true, we are in the middle of recovering from some other significant bug or I/O error, so this comment seems to be going out on a limb to make a guarantee that isn't clearly significant. It is also unclear to me what \"transaction data outside the context of the 'SQLiteBatch'\" would refer to if SQLiteBatch is the class responsible for creating transactions.\r\n\r\nConsidering all this, I'd probably suggest still going with my original comment from https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466966956 which was \"// If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back.\"\r\n\r\nBut maybe this comment is missing some other information that you wanted to get across?",
      "commit_id" : "756bed0529b46944162c02c783ecc804f802b637",
      "created_at" : "2024-01-29T18:28:52Z",
      "diff_hunk" : "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470026684",
      "id" : 1470026684,
      "line" : 418,
      "node_id" : "PRRC_kwDOABII585XntO8",
      "original_commit_id" : "0bf3a7356db224d28a86194b004ca30549197f27",
      "original_line" : 418,
      "original_position" : 15,
      "original_start_line" : 415,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 35,
      "pull_request_review_id" : 1849338675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470026684/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 415,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-29T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470026684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470035536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470035536"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466968974\r\n\r\n> I tend to call the `WalletBatch` handler because 'batch' refers to a class that groups operations and dumps the result all at once atomically at the end of the process.\r\n\r\n:grinning: yeah very used to seeing bland names that don't mean anything because someone rejected an an actually descriptive name for a pedantic reason. In this case, I think a batch is just a collection of actions done together. Metaphors are ok once in a while.",
      "commit_id" : "756bed0529b46944162c02c783ecc804f802b637",
      "created_at" : "2024-01-29T18:36:30Z",
      "diff_hunk" : "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470035536",
      "id" : 1470035536,
      "in_reply_to_id" : 1466968974,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XnvZQ",
      "original_commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "original_line" : 254,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/test/db_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1849338675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 1,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470035536/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-29T19:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470035536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471199191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471199191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It is also unclear to me what \"transaction data outside the context of the 'SQLiteBatch'\" would refer to if SQLiteBatch is the class responsible for creating transactions.\r\n\r\nThe purpose of this sentence was to describe what could happen if we don't rollback the transaction and explain why we rollback the transaction inside the `SQLiteBatch` destructor.\r\n\r\nThe complete sentence, \"This prevents dangling transaction data outside the context of the 'SQLiteBatch' that initiated such a transaction,\" refers to the `SQLiteBatch` instance, not the class. Each `SQLiteBatch` can create a single transaction at a time; no concurrent `SQLiteBatch` instances are allowed (#29112). Thus, the code rolls back the db txn within the `SQLiteBatch` object destructor. This links the db txn to the `SQLiteBatch` instance lifecycle, isolating data changes and preventing other `SQLiteBatch` instances from dumping data that does not correspond to them.\r\n\r\n> But maybe this comment is missing some other information that you wanted to get across?\r\n\r\nI wanted to emphasize the importance of rolling back the transaction by explaining the consequences of leaving the transaction dangling. Also, wanted to mention that the error could be transient (so we don't forget about this possibility) and describe why we want to keep the transaction data changes isolated within the `SQLiteBatch` instance that initiated the transaction.\r\n\r\n---------------------\r\n\r\nIf, after reading this response, you still have doubts and find the comment confusing, I can replace it with your comment. No problem; the idea was to provide a clearer description of the situation.",
      "commit_id" : "756bed0529b46944162c02c783ecc804f802b637",
      "created_at" : "2024-01-30T13:21:47Z",
      "diff_hunk" : "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471199191",
      "id" : 1471199191,
      "in_reply_to_id" : 1470026684,
      "line" : 418,
      "node_id" : "PRRC_kwDOABII585XsLfX",
      "original_commit_id" : "0bf3a7356db224d28a86194b004ca30549197f27",
      "original_line" : 418,
      "original_position" : 15,
      "original_start_line" : 415,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 35,
      "pull_request_review_id" : 1851256310,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471199191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 415,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-30T13:25:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471199191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471205237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471205237"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Great, thanks ðð¼. Unified `ExecHandler` and `SQliteExecHandler` and added your doxygen comment.",
      "commit_id" : "756bed0529b46944162c02c783ecc804f802b637",
      "created_at" : "2024-01-30T13:25:51Z",
      "diff_hunk" : "@@ -36,11 +36,26 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class ExecHandler",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471205237",
      "id" : 1471205237,
      "in_reply_to_id" : 1469966356,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XsM91",
      "original_commit_id" : "53c4f1334ee300e2228974b4abca51c38087c51c",
      "original_line" : 39,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : null,
      "pull_request_review_id" : 1851256310,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471205237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-30T13:25:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471205237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471209737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471209737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "756bed0529b46944162c02c783ecc804f802b637",
      "created_at" : "2024-01-30T13:28:50Z",
      "diff_hunk" : "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471209737",
      "id" : 1471209737,
      "in_reply_to_id" : 1466968974,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XsOEJ",
      "original_commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "original_line" : 254,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/test/db_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1851270902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471209737/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-30T13:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471209737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471833134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471833134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: add ability to interrupt statements\" (177ff954c1221a00d4bf5ea63e6bfc415ba706c8)\r\n\r\nIt's technically not an abstract class anymore since it doesn't contain any `= 0` pure virtual methods. Would maybe suggest \"Class responsible for executing SQL statements in SQLite databases. Methods are virtual so they can be overridden by unit tests testing unusual database conditions.\"\r\n",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-30T19:29:09Z",
      "diff_hunk" : "@@ -36,11 +36,21 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+/** Abstract class responsible for executing SQL statements in SQLite databases.\n+ *  It is abstract so it can be overridden by unit tests testing unusual database conditions. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471833134",
      "id" : 1471833134,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XumQu",
      "original_commit_id" : "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "original_line" : 40,
      "original_position" : 5,
      "original_start_line" : 39,
      "path" : "src/wallet/sqlite.h",
      "position" : null,
      "pull_request_review_id" : 1852174380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471833134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-30T19:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471833134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471840452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471840452"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: add ability to interrupt statements\" (177ff954c1221a00d4bf5ea63e6bfc415ba706c8)\r\n\r\nThis doesn't seem right because the `&&` operator will convert the integer return value into a bool. Also if m_exec_handler is null the `res` value will be 0 which is SQLITE_OK so the call will appear to succed.\r\n\r\nIt probably would make more sense to do `int res = Assert(m_exec_handler)->Exec(...)`",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-30T19:34:39Z",
      "diff_hunk" : "@@ -607,7 +612,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n bool SQLiteBatch::TxnBegin()\n {\n     if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n-    int res = sqlite3_exec(m_database.m_db, \"BEGIN TRANSACTION\", nullptr, nullptr, nullptr);\n+    int res = m_exec_handler && m_exec_handler->Exec(m_database, \"BEGIN TRANSACTION\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471840452",
      "id" : 1471840452,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XuoDE",
      "original_commit_id" : "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "original_line" : 615,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1852174380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471840452/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-30T19:48:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471840452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471853965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471853965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471199191\r\n\r\nThanks for clarifying.\r\n\r\n> I wanted to emphasize the importance of rolling back the transaction by explaining the consequences of leaving the transaction dangling.\r\n\r\nThat seems ok. Would maybe suggest adding to the previously suggested comment:\r\n\r\n* // If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back **and future transactions can succeed without committing old data**.\r\n\r\n> Also, wanted to mention that the error could be transient (so we don't forget about this possibility)\r\n\r\nThis is exactly what I think the comment should not be saying because the error cannot be transient. And it's confusing to suggest that it could be transient, because it either makes the rest of the code seem broken, or it makes this code seem unnecessary.\r\n\r\nIf you want talk about a theoretical future state, in some future version of sqlite or future version of the wallet codebase where a rollback statement could return SQLITE_BUSY, I guess you could do that but it seems speculative and confusing if you don't distinguish that scenario with what is actually happening in the current code.\r\n\r\n> and describe why we want to keep the transaction data changes isolated within the `SQLiteBatch` instance that initiated the transaction.\r\n\r\nI think that's mostly clear from the context but if you want to say more about it, the best place to put it would be on line 410 before the TxnAbort() call is made, to explain why the TxnAbort() call is being made and why it's important. Trying to get into why the rollback is important after the rolllback fails seems like going down a tangent and not putting information where it is most helpful.",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-30T19:44:52Z",
      "diff_hunk" : "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471853965",
      "id" : 1471853965,
      "in_reply_to_id" : 1470026684,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XurWN",
      "original_commit_id" : "0bf3a7356db224d28a86194b004ca30549197f27",
      "original_line" : 418,
      "original_position" : 15,
      "original_start_line" : 415,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1852174380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471853965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-30T19:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471853965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471915202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes, fixed. Thanks. God knows why I did that.. it seems that I wasn't focused.",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-30T20:32:37Z",
      "diff_hunk" : "@@ -607,7 +612,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n bool SQLiteBatch::TxnBegin()\n {\n     if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n-    int res = sqlite3_exec(m_database.m_db, \"BEGIN TRANSACTION\", nullptr, nullptr, nullptr);\n+    int res = m_exec_handler && m_exec_handler->Exec(m_database, \"BEGIN TRANSACTION\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471915202",
      "id" : 1471915202,
      "in_reply_to_id" : 1471840452,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Xu6TC",
      "original_commit_id" : "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "original_line" : 615,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1852300328,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915202/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-30T20:32:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471915666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, fixed. I pasted your doc suggestion first, then made the classes consolidation..",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-30T20:33:05Z",
      "diff_hunk" : "@@ -36,11 +36,21 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+/** Abstract class responsible for executing SQL statements in SQLite databases.\n+ *  It is abstract so it can be overridden by unit tests testing unusual database conditions. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471915666",
      "id" : 1471915666,
      "in_reply_to_id" : 1471833134,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Xu6aS",
      "original_commit_id" : "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "original_line" : 40,
      "original_position" : 5,
      "original_start_line" : 39,
      "path" : "src/wallet/sqlite.h",
      "position" : null,
      "pull_request_review_id" : 1852300936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915666/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-30T20:33:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471941289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471941289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "All good, applied your suggestion. Thanks!\r\n\r\n> This is exactly what I think the comment should not be saying because the error cannot be transient. And it's confusing to suggest that it could be transient, because it either makes the rest of the code seem broken, or it makes this code seem unnecessary.\r\n\r\nI was also thinking about an I/O hardware malfunctioning error, which \"could\" be transient; sqlite has return codes for it. But it's probably better to abort the program if something like this ever happens.",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-30T20:52:56Z",
      "diff_hunk" : "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471941289",
      "id" : 1471941289,
      "in_reply_to_id" : 1470026684,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585XvAqp",
      "original_commit_id" : "0bf3a7356db224d28a86194b004ca30549197f27",
      "original_line" : 418,
      "original_position" : 15,
      "original_start_line" : 415,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1852338645,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471941289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-30T20:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471941289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1473087294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473087294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sqlite: add ability to interrupt statements\" (dca874e838c2599bd24433675b291168f8e7b055)\r\n\r\nIt's a little better to pass plain `unique_ptr` instead of `unique_ptr&&`, because former guarantees unique_ptr argument will be moved-from and null afterward, while latter means the move may or may not happen depending on internals of the function. In general you want explicit && references for template programming and perfect forwarding, but should use values and & references otherwise.. Can see https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-conventional for guidelines.\r\n",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-31T16:11:15Z",
      "diff_hunk" : "@@ -61,6 +71,8 @@ class SQLiteBatch : public DatabaseBatch\n     explicit SQLiteBatch(SQLiteDatabase& database);\n     ~SQLiteBatch() override { Close(); }\n \n+    void SetExecHandler(std::unique_ptr<SQliteExecHandler>&& handler) { m_exec_handler = std::move(handler); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1473087294",
      "id" : 1473087294,
      "line" : 74,
      "node_id" : "PRRC_kwDOABII585XzYc-",
      "original_commit_id" : "dca874e838c2599bd24433675b291168f8e7b055",
      "original_line" : 74,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : 26,
      "pull_request_review_id" : 1854204356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473087294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-31T17:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473087294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> It wouldn't be ideal if the error is still recoverable (e.g. [SQLITE_BUSY](https://sqlite.org/rescode.html#busy) if we ever introduce concurrent txns).\r\n> At least in this scenario, where we are destroying the object that created the transaction, I believe triggering the database connection reset is acceptable as a first measure.\r\n\r\nIf we do have recoverable errors, then we should be handling them, not hitting them with the hammer of closing and reopening the database.\r\n\r\n***\r\n\r\nThis PR feels like it's the wrong approach to dealing with this particular database failure. It shouldn't be possible for a transaction commit or abort to currently fail in way that isn't catastrophic. In that case, we should be shutting the wallet rather than reopening the database connection and pretending that nothing happened. This could potentially lead to a state where the wallet's in-memory state does not match the database, which is really bad and could lead to loss of funds.",
      "created_at" : "2024-01-31T18:55:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919735812",
      "id" : 1919735812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585ybNgE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919735812/reactions"
      },
      "updated_at" : "2024-01-31T19:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919735812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> This PR feels like it's the wrong approach to dealing with this particular database failure. It shouldn't be possible for a transaction commit or abort to currently fail in way that isn't catastrophic. In that case, we should be shutting the wallet rather than reopening the database connection and pretending that nothing happened. This could potentially lead to a state where the wallet's in-memory state does not match the database, which is really bad and could lead to loss of funds.\r\n\r\nIt seems like if there is failure to rollback a transaction one way, with a rollback statement, this PR is just retrying again a different way, by closing and reopening the database. In theory the code could always roll back transactions by closing and reopening the database, so the new behavior in this PR doesn't seem worse than current behavior.\r\n\r\nOne way the PR seems better than the current code is that the current code just logs \"SQLiteBatch: Batch closed and failed to abort transaction\" if the rollback fails, which is not even an obvious error message, and it continues like nothing happened. The new code at least raises an exception if the rollback fails.\r\n\r\nAll of this seems very theoretical to me since I have no idea why a rollback statement would ever fail. But I think this PR seems reasonable, adds some test coverage, and probably is a small improvement even if better approaches are also possible.",
      "created_at" : "2024-01-31T19:24:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919780817",
      "id" : 1919780817,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585ybYfR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919780817/reactions"
      },
      "updated_at" : "2024-01-31T19:24:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919780817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-31T20:02:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919841411",
      "id" : 1919841411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585ybnSD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919841411/reactions"
      },
      "updated_at" : "2024-01-31T20:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919841411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1473503275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473503275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok noted, thanks!",
      "commit_id" : "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "created_at" : "2024-01-31T21:44:47Z",
      "diff_hunk" : "@@ -61,6 +71,8 @@ class SQLiteBatch : public DatabaseBatch\n     explicit SQLiteBatch(SQLiteDatabase& database);\n     ~SQLiteBatch() override { Close(); }\n \n+    void SetExecHandler(std::unique_ptr<SQliteExecHandler>&& handler) { m_exec_handler = std::move(handler); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1473503275",
      "id" : 1473503275,
      "in_reply_to_id" : 1473087294,
      "line" : 74,
      "node_id" : "PRRC_kwDOABII585X0-Ar",
      "original_commit_id" : "dca874e838c2599bd24433675b291168f8e7b055",
      "original_line" : 74,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : 26,
      "pull_request_review_id" : 1854901398,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473503275/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-31T21:44:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473503275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
