[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29253).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1906252904) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29112](https://github.com/bitcoin/bitcoin/pull/29112) (sqlite: Disallow writing from multiple `SQLiteBatch`s by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-01-16T00:41:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1892913940",
      "id" : 1892913940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585w05MU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1892913940/reactions"
      },
      "updated_at" : "2024-01-23T15:09:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1892913940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453968110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 83c807a380b41787214806c6440236ea1a9dabd7 \"sqlite: introduce HasActiveTxn method\"\r\n\r\n`HasActiveTxn()` checks for `m_db` already, so no need to do check that here too.\r\n\r\nSame for `TxnCommit()` and `TxnAbort()`.",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-16T20:10:05Z",
      "diff_hunk" : "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453968110",
      "id" : 1453968110,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Wqcru",
      "original_commit_id" : "83c807a380b41787214806c6440236ea1a9dabd7",
      "original_line" : 620,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1824875743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:11:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453982729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "upps done",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-16T20:22:19Z",
      "diff_hunk" : "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453982729",
      "id" : 1453982729,
      "in_reply_to_id" : 1453968110,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585WqgQJ",
      "original_commit_id" : "83c807a380b41787214806c6440236ea1a9dabd7",
      "original_line" : 620,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1824891279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-16T20:22:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1461745349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1461745349"
         }
      },
      "author_association" : "NONE",
      "body" : "src/wallet/sqlite.h\r\n",
      "commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "created_at" : "2024-01-22T11:46:31Z",
      "diff_hunk" : "@@ -57,10 +66,15 @@ class SQLiteBatch : public DatabaseBatch\n     bool HasKey(DataStream&& key) override;\n     bool ErasePrefix(Span<const std::byte> prefix) override;\n \n+    // Execute statement\n+    int Exec(const std::string& statement);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1461745349",
      "id" : 1461745349,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII585XIHbF",
      "original_commit_id" : "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "original_line" : 71,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : 27,
      "pull_request_review_id" : 1836280625,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1461745349/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-22T11:46:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1461745349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/156127317?v=4",
         "events_url" : "https://api.github.com/users/moemat12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/moemat12/followers",
         "following_url" : "https://api.github.com/users/moemat12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/moemat12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/moemat12",
         "id" : 156127317,
         "login" : "moemat12",
         "node_id" : "U_kgDOCU5QVQ",
         "organizations_url" : "https://api.github.com/users/moemat12/orgs",
         "received_events_url" : "https://api.github.com/users/moemat12/received_events",
         "repos_url" : "https://api.github.com/users/moemat12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/moemat12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/moemat12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/moemat12"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm trying to understand this, but confused about why executing \"ROLLBACK TRANSACTION\" would be expected to fail in sqlite. It seems like the fix in e5217fea1516120643f4a7a55a474648e21e2269 is handling failure to roll back by trying to close and reopen the database. But I don't understand why rolling back a transaction would fail to begin with, unless there was some serious error like disk corruption. Probably to make the this fix clearer and safer it would be good to check the specific error code from the failed rollback instead of just checking res == SQLITE_OK. But I'm generally just confused.\r\n",
      "created_at" : "2024-01-23T15:09:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1906252904",
      "id" : 1906252904,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585xnxxo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906252904/reactions"
      },
      "updated_at" : "2024-01-23T15:09:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906252904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">  if there is a failure during the WalletBatch destruction (independently on if it is due to a fatal or transient and recoverable error, like a busy db or a loss of the db connection)\r\n\r\nYes I've started reviewing both PR's and the code changes seem reasonable, I just don't understand what motivated this PR, because \"failure during the WalletBatch destruction\" seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs? Or did you just notice that the error handling in the destructor wasn't very good, and decide to fix it? Or can failures to roll back actually happen in more cases than it seems, and this is a bug that could happen during normal operation without data corruption?",
      "created_at" : "2024-01-25T16:09:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910522489",
      "id" : 1910522489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585x4EJ5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910522489/reactions"
      },
      "updated_at" : "2024-01-25T16:09:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910522489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs?\r\n\r\nIt shouldn't ever happen.\r\n\r\nIn general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?",
      "created_at" : "2024-01-25T16:33:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910567093",
      "id" : 1910567093,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
      "node_id" : "IC_kwDOABII585x4PC1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910567093/reactions"
      },
      "updated_at" : "2024-01-25T16:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910567093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
