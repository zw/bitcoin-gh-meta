[
   {
      "author_association" : "NONE",
      "body" : "> When disabling the \"test-only\" assumptions in CheckBlockIndex, the check fails. This is problematic, because test-only code should not affect the behavior of the program in production.\n> \n> \n> \n> Current diff:\n> \n> \n> \n> ```diff\n> \n> diff --git a/src/validation.cpp b/src/validation.cpp\n> \n> index 8c583c586c..00d7ee3736 100644\n> \n> --- a/src/validation.cpp\n> \n> +++ b/src/validation.cpp\n> \n> @@ -4866,9 +4866,9 @@ void ChainstateManager::CheckBlockIndex()\n> \n>          unsigned int prev_chain_tx = pindex->pprev ? pindex->pprev->nChainTx : 0;\n> \n>          assert((pindex->nChainTx == pindex->nTx + prev_chain_tx)\n> \n>                 // For testing, allow transaction counts to be completely unset.\n> \n> -               || (pindex->nChainTx == 0 && pindex->nTx == 0)\n> \n> +               //|| (pindex->nChainTx == 0 && pindex->nTx == 0)\n> \n>                 // For testing, allow this nChainTx to be unset if previous is also unset.\n> \n> -               || (pindex->nChainTx == 0 && prev_chain_tx == 0 && pindex->pprev)\n> \n> +               //|| (pindex->nChainTx == 0 && prev_chain_tx == 0 && pindex->pprev)\n> \n>                 // Transaction counts prior to snapshot are unknown.\n> \n>                 || pindex->IsAssumedValid());\n> \n>  \n> \n> ```\n> \n> \n> \n> Steps to reproduce the crash:\n> \n> \n> \n> ```\n> \n> $ ./src/qt/bitcoin-qt -datadir=/tmp -regtest\n> \n> > generatetodescriptor 1 raw(ff)\n> \n> ```\n> \n> \n> \n> Related to https://github.com/bitcoin/bitcoin/pull/28791 and https://github.com/bitcoin/bitcoin/pull/28562#discussion_r1350470707\n\nTo address the issue of failing checks when disabling \"test-only\" assumptions in `CheckBlockIndex`, you might consider the following steps:\n\n1. **Review Test-Only Code:**\n   - Examine the specific test-only code in the `CheckBlockIndex` and ensure it doesn't introduce unintended dependencies or affect production behavior.\n\n2. **Conditional Compilation:**\n   - If possible, use conditional compilation or preprocessor directives to isolate test-only code. This way, it's excluded from the production build.\n\n3. **Separate Test Code:**\n   - Consider moving the test-only code to a separate file or section within the codebase. This helps in maintaining a clear separation between production and testing logic.\n\n4. **Dependency Injection:**\n   - If the test-only code is interacting with external dependencies, use dependency injection or mocks during testing to isolate the behavior without affecting production.\n\n5. **Unit Testing:**\n   - Ensure comprehensive unit tests for the production code, including the areas covered by the test-only assumptions. This helps catch issues early and ensures that changes to test-only code don't impact production.\n\n6. **Documentation:**\n   - Clearly document the purpose and scope of test-only code to inform developers about its intended use and limitations.\n\n7. **Code Review:**\n   - When making changes related to test-only code, conduct thorough code reviews to catch any potential issues and ensure adherence to coding standards.",
      "created_at" : "2024-01-19T08:48:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29261#issuecomment-1899994384",
      "id" : 1899994384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29261",
      "node_id" : "IC_kwDOABII585xP50Q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899994384/reactions"
      },
      "updated_at" : "2024-01-19T08:48:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1899994384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/155118385?v=4",
         "events_url" : "https://api.github.com/users/Olayiwolaxiii/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Olayiwolaxiii/followers",
         "following_url" : "https://api.github.com/users/Olayiwolaxiii/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Olayiwolaxiii/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Olayiwolaxiii",
         "id" : 155118385,
         "login" : "Olayiwolaxiii",
         "node_id" : "U_kgDOCT7rMQ",
         "organizations_url" : "https://api.github.com/users/Olayiwolaxiii/orgs",
         "received_events_url" : "https://api.github.com/users/Olayiwolaxiii/received_events",
         "repos_url" : "https://api.github.com/users/Olayiwolaxiii/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Olayiwolaxiii/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Olayiwolaxiii/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Olayiwolaxiii"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> `$ ./src/qt/bitcoin-qt -datadir=/tmp -regtest`\r\n\r\nDo we not consider regtest \"testing\"?\r\n\r\nISTM that only \"test mode\" (regtest) will fail the assertion with the lines removed.",
      "created_at" : "2024-01-22T19:58:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29261#issuecomment-1904709745",
      "id" : 1904709745,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29261",
      "node_id" : "IC_kwDOABII585xh5Bx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1904709745/reactions"
      },
      "updated_at" : "2024-01-22T19:58:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1904709745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Do we not consider regtest \"testing\"?\r\n\r\nThe comment is vague, but it's really referring to unit tests.\r\n\r\nWhen I suggested adding the two conditions allowing `pindex->nChainTx == 0` \"for testing\" in https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1323226418, the reason was to avoid crashes in unit tests, because some unit tests skipped calling `ReceivedBlockTransactions` and therefore skipped setting a `nChainTx` value:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/651fb034d85eb5db561bfd24b74f7271417defa5/src/validation.cpp#L3613\r\n\r\nBut outside unit tests the condition `pindex->nChainTx == pindex->nTx + prev_chain_tx` should be true and the assert should succeed.\r\n\r\nSo there is unexpected behavior here if bitcoin-qt is crashing without these conditions, and maybe there is a real bug. Also this code could probably be improved by updating unit tests to set nChainTx correctly, so the two special case conditions in the assert allowing `pindex->nChainTx == 0` could be dropped.",
      "created_at" : "2024-01-22T20:45:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29261#issuecomment-1904776805",
      "id" : 1904776805,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29261",
      "node_id" : "IC_kwDOABII585xiJZl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1904776805/reactions"
      },
      "updated_at" : "2024-01-22T20:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1904776805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> So there is unexpected behavior here if bitcoin-qt is crashing without these conditions\r\n\r\nThis is not specific to `bitcoin-qt`, or assumeutxo. For example, It also happens with `bitcoin-cli -regtest -generate 1` (after creating an empty wallet) on an empty datadir.\r\n\r\nI think the comment `// For testing, allow transaction counts to be completely unset.` is wrong. `CheckBlockIndex` traverses the entire block index tree, no matter if we have the block on disk or not. If we don't have it, `ReceivedBlockTransactions`  hasn't been called, and both `nTx` and `nChainTx` are 0.\r\n\r\nTherefore, the check `assert((pindex->nChainTx == pindex->nTx + prev_chain_tx)`  cannot be applied to headers for which we never processed the block data, and this has nothing to do with AssumeUtxo or Testing.\r\n\r\nI'll open a PR with a fix tomorrow unless someone disagrees.",
      "created_at" : "2024-01-23T00:17:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29261#issuecomment-1905064561",
      "id" : 1905064561,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29261",
      "node_id" : "IC_kwDOABII585xjPpx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1905064561/reactions"
      },
      "updated_at" : "2024-01-23T00:40:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1905064561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Oops, sorry I missed that context so my explanation doesn't really describe what the checks are doing (although it does describe what they were intending to do). If the PR is just going to change the comments and delete the words \"For testing,\" that sounds good.",
      "created_at" : "2024-01-23T00:41:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29261#issuecomment-1905087355",
      "id" : 1905087355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29261",
      "node_id" : "IC_kwDOABII585xjVN7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1905087355/reactions"
      },
      "updated_at" : "2024-01-23T00:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1905087355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Other notes on improving this assert:\r\n\r\n- The final pindex->IsAssumedValid() check added in [#28791](https://github.com/bitcoin/bitcoin/pull/28791) seems a little overbroad. I think the condition `(pindex->nChainTx == pindex->nTx + prev_chain_tx)` should actually be true for all assumed-valid blocks except the first one and the last one, so that check could be tightened up\r\n- It might possible to add a test covering the assert failure that pindex->IsAssumedValid() from [#28791](https://github.com/bitcoin/bitcoin/pull/28791) fixes, since [#28791](https://github.com/bitcoin/bitcoin/pull/28791) didn't seem to include a test",
      "created_at" : "2024-01-23T01:16:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29261#issuecomment-1905118176",
      "id" : 1905118176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29261",
      "node_id" : "IC_kwDOABII585xjcvg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1905118176/reactions"
      },
      "updated_at" : "2024-01-23T01:16:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1905118176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
