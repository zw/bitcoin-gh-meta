[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28724).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [laanwj](https://github.com/bitcoin/bitcoin/pull/28724#pullrequestreview-1706334932), [willcl-ark](https://github.com/bitcoin/bitcoin/pull/28724#pullrequestreview-1707986305) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29136](https://github.com/bitcoin/bitcoin/pull/29136) (wallet: `addhdkey` RPC to add just keys to wallets via new `void(KEY)` descriptor by achow101)\n* [#29130](https://github.com/bitcoin/bitcoin/pull/29130) (wallet: Add `createwalletdescriptor` and `gethdkeys` RPCs for adding new automatically generated descriptors by achow101)\n* [#26728](https://github.com/bitcoin/bitcoin/pull/26728) (wallet: Have the wallet store the key for automatically generated descriptors by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-10-24T23:02:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#issuecomment-1778189273",
      "id" : 1778189273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28724",
      "node_id" : "IC_kwDOABII585p_QPZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778189273/reactions"
      },
      "updated_at" : "2024-01-02T19:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1778189273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378227825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378227825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "why do we only have the first few digits here, I tried with `046d6b657901000000` and it worked fine\r\n\r\n`assert_equal(all([not line == \"046d6b657901000000\" for line in f]), True)`",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-10-31T22:40:38Z",
      "diff_hunk" : "@@ -100,6 +102,64 @@ def run_test(self):\n             sig = self.nodes[0].signmessage(address, msg)\n             assert self.nodes[0].verifymessage(address, sig, msg)\n \n+        self.log.info(\"Test that wallets without private keys cannot be encrypted\")\n+        self.nodes[0].createwallet(wallet_name=\"noprivs\", disable_private_keys=True)\n+        noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs\")\n+        assert_raises_rpc_error(-16, \"Error: wallet does not contain private keys, nothing to encrypt.\", noprivs_wallet.encryptwallet, \"pass\")\n+\n+        if self.is_wallet_tool_compiled():\n+            self.log.info(\"Test that encryption keys in wallets without privkeys are removed\")\n+\n+            def do_wallet_tool(*args):\n+                proc = subprocess.Popen(\n+                    [self.options.bitcoinwallet, f\"-datadir={self.nodes[0].datadir_path}\", f\"-chain={self.chain}\"] + list(args),\n+                    stdin=subprocess.PIPE,\n+                    stdout=subprocess.PIPE,\n+                    stderr=subprocess.PIPE,\n+                    text=True\n+                )\n+                stdout, stderr = proc.communicate()\n+                assert_equal(proc.poll(), 0)\n+                assert_equal(stderr, \"\")\n+\n+            # Since it is no longer possible to encrypt a wallet without privkeys, we need to force one into the wallet\n+            # 1. Make a dump of the wallet\n+            # 2. Add mkey record to the dump\n+            # 3. Create a new wallet from the dump\n+\n+            # Make the dump\n+            noprivs_wallet.unloadwallet()\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs.dump\"\n+            do_wallet_tool(\"-wallet=noprivs\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+\n+            # Modify the dump\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                dump_content = f.readlines()\n+            # Drop the checksum line\n+            dump_content = dump_content[:-1]\n+            # Insert a valid mkey line. This corresponds to a passphrase of \"pass\".\n+            dump_content.append(\"046d6b657901000000,300dc926f3b3887aad3d5d5f5a0fc1b1a4a1722f9284bd5c6ff93b64a83902765953939c58fe144013c8b819f42cf698b208e9911e5f0c544fa300000000cc52050000\\n\")\n+            with open(dumpfile_path, \"w\", encoding=\"utf-8\") as f:\n+                contents = \"\".join(dump_content)\n+                f.write(contents)\n+                checksum = hash256(contents.encode())\n+                f.write(f\"checksum,{checksum.hex()}\\n\")\n+\n+            # Load the dump into a new wallet\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"createfromdump\")\n+            # Load the wallet and make sure it is no longer encrypted\n+            with self.nodes[0].assert_debug_log([\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\"]):\n+                self.nodes[0].loadwallet(\"noprivs_enc\")\n+            noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs_enc\")\n+            assert_raises_rpc_error(-15, \"Error: running with an unencrypted wallet, but walletpassphrase was called.\", noprivs_wallet.walletpassphrase, \"pass\", 1)\n+            noprivs_wallet.unloadwallet()\n+\n+            # Make a new dump and check that there are no mkeys\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs_enc.dump\"\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                assert_equal(all([not line.startswith(\"046d6b6579\") for line in f]), True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378227825",
      "id" : 1378227825,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585SJhZx",
      "original_commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "original_line" : 161,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/wallet_encryption.py",
      "position" : 70,
      "pull_request_review_id" : 1707333703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378227825/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T22:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378227825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378328199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378328199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This prefix matches all possible `mkey` records so it can make sure that there are no `mkey`s slipping in elsewhere.",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-01T02:18:51Z",
      "diff_hunk" : "@@ -100,6 +102,64 @@ def run_test(self):\n             sig = self.nodes[0].signmessage(address, msg)\n             assert self.nodes[0].verifymessage(address, sig, msg)\n \n+        self.log.info(\"Test that wallets without private keys cannot be encrypted\")\n+        self.nodes[0].createwallet(wallet_name=\"noprivs\", disable_private_keys=True)\n+        noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs\")\n+        assert_raises_rpc_error(-16, \"Error: wallet does not contain private keys, nothing to encrypt.\", noprivs_wallet.encryptwallet, \"pass\")\n+\n+        if self.is_wallet_tool_compiled():\n+            self.log.info(\"Test that encryption keys in wallets without privkeys are removed\")\n+\n+            def do_wallet_tool(*args):\n+                proc = subprocess.Popen(\n+                    [self.options.bitcoinwallet, f\"-datadir={self.nodes[0].datadir_path}\", f\"-chain={self.chain}\"] + list(args),\n+                    stdin=subprocess.PIPE,\n+                    stdout=subprocess.PIPE,\n+                    stderr=subprocess.PIPE,\n+                    text=True\n+                )\n+                stdout, stderr = proc.communicate()\n+                assert_equal(proc.poll(), 0)\n+                assert_equal(stderr, \"\")\n+\n+            # Since it is no longer possible to encrypt a wallet without privkeys, we need to force one into the wallet\n+            # 1. Make a dump of the wallet\n+            # 2. Add mkey record to the dump\n+            # 3. Create a new wallet from the dump\n+\n+            # Make the dump\n+            noprivs_wallet.unloadwallet()\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs.dump\"\n+            do_wallet_tool(\"-wallet=noprivs\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+\n+            # Modify the dump\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                dump_content = f.readlines()\n+            # Drop the checksum line\n+            dump_content = dump_content[:-1]\n+            # Insert a valid mkey line. This corresponds to a passphrase of \"pass\".\n+            dump_content.append(\"046d6b657901000000,300dc926f3b3887aad3d5d5f5a0fc1b1a4a1722f9284bd5c6ff93b64a83902765953939c58fe144013c8b819f42cf698b208e9911e5f0c544fa300000000cc52050000\\n\")\n+            with open(dumpfile_path, \"w\", encoding=\"utf-8\") as f:\n+                contents = \"\".join(dump_content)\n+                f.write(contents)\n+                checksum = hash256(contents.encode())\n+                f.write(f\"checksum,{checksum.hex()}\\n\")\n+\n+            # Load the dump into a new wallet\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"createfromdump\")\n+            # Load the wallet and make sure it is no longer encrypted\n+            with self.nodes[0].assert_debug_log([\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\"]):\n+                self.nodes[0].loadwallet(\"noprivs_enc\")\n+            noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs_enc\")\n+            assert_raises_rpc_error(-15, \"Error: running with an unencrypted wallet, but walletpassphrase was called.\", noprivs_wallet.walletpassphrase, \"pass\", 1)\n+            noprivs_wallet.unloadwallet()\n+\n+            # Make a new dump and check that there are no mkeys\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs_enc.dump\"\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                assert_equal(all([not line.startswith(\"046d6b6579\") for line in f]), True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378328199",
      "id" : 1378328199,
      "in_reply_to_id" : 1378227825,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585SJ56H",
      "original_commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "original_line" : 161,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/wallet_encryption.py",
      "position" : 70,
      "pull_request_review_id" : 1707482250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378328199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T02:18:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378328199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378657380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378657380"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I notice that nothing in this block requires any locks (even though `cs_wallet` will be locked at this stage in this function).\r\n\r\nFor my own understanding, is this because the db operations, i.e. writing to the on-disk file, have their synchronisation handled by the db's transaction system?\r\n\r\nI see for example in `LoadEncryptionKey` that we lock `cs_wallet` to load the keys _into_ the wallet, which makes intuitive sense. But it feels that conversely there should be something asserting the lock is held here too, as we remove encryption keys from the wallet? Or at least when `pwallet->mapMasterKeys.clear();` is called.\r\n\r\nPerhaps it doesn't matter as it's done during loading from the db, so nothing else will have started to access the Wallet?",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-01T11:02:48Z",
      "diff_hunk" : "@@ -1227,6 +1232,21 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Since it was accidentally possible to \"encrypt\" a wallet with private keys disabled, we should check if this is\n+    // such a wallet and remove the encryption key records to avoid any future issues.\n+    // Although wallets without private keys should not have *ckey records, we should double check that.\n+    // Removing the mkey records is only safe if there are no *ckey records.\n+    if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && pwallet->HasEncryptionKeys() && !pwallet->HaveCryptedKeys()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378657380",
      "id" : 1378657380,
      "line" : 1239,
      "node_id" : "PRRC_kwDOABII585SLKRk",
      "original_commit_id" : "4db9b63fdcb5d32fa1ad98f263c9f77edf1af8a4",
      "original_line" : 1239,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 20,
      "pull_request_review_id" : 1707986305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378657380/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T11:57:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378657380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378673670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378673670"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I was wondering if if could be a good idea to log the removed keys at this point as a backup (safe-ish seeing as we are deleting), but I'm struggling to think of a scenario where a user with this type of wallet might somehow need these keys again...",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-01T11:22:48Z",
      "diff_hunk" : "@@ -1227,6 +1232,21 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Since it was accidentally possible to \"encrypt\" a wallet with private keys disabled, we should check if this is\n+    // such a wallet and remove the encryption key records to avoid any future issues.\n+    // Although wallets without private keys should not have *ckey records, we should double check that.\n+    // Removing the mkey records is only safe if there are no *ckey records.\n+    if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && pwallet->HasEncryptionKeys() && !pwallet->HaveCryptedKeys()) {\n+        pwallet->WalletLogPrintf(\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378673670",
      "id" : 1378673670,
      "line" : 1240,
      "node_id" : "PRRC_kwDOABII585SLOQG",
      "original_commit_id" : "4db9b63fdcb5d32fa1ad98f263c9f77edf1af8a4",
      "original_line" : 1240,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 21,
      "pull_request_review_id" : 1707986305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378673670/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T11:57:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378673670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378684726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378684726"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps a comment to that effect would be useful here as it's not clear directly from the code?",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-01T11:35:58Z",
      "diff_hunk" : "@@ -100,6 +102,64 @@ def run_test(self):\n             sig = self.nodes[0].signmessage(address, msg)\n             assert self.nodes[0].verifymessage(address, sig, msg)\n \n+        self.log.info(\"Test that wallets without private keys cannot be encrypted\")\n+        self.nodes[0].createwallet(wallet_name=\"noprivs\", disable_private_keys=True)\n+        noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs\")\n+        assert_raises_rpc_error(-16, \"Error: wallet does not contain private keys, nothing to encrypt.\", noprivs_wallet.encryptwallet, \"pass\")\n+\n+        if self.is_wallet_tool_compiled():\n+            self.log.info(\"Test that encryption keys in wallets without privkeys are removed\")\n+\n+            def do_wallet_tool(*args):\n+                proc = subprocess.Popen(\n+                    [self.options.bitcoinwallet, f\"-datadir={self.nodes[0].datadir_path}\", f\"-chain={self.chain}\"] + list(args),\n+                    stdin=subprocess.PIPE,\n+                    stdout=subprocess.PIPE,\n+                    stderr=subprocess.PIPE,\n+                    text=True\n+                )\n+                stdout, stderr = proc.communicate()\n+                assert_equal(proc.poll(), 0)\n+                assert_equal(stderr, \"\")\n+\n+            # Since it is no longer possible to encrypt a wallet without privkeys, we need to force one into the wallet\n+            # 1. Make a dump of the wallet\n+            # 2. Add mkey record to the dump\n+            # 3. Create a new wallet from the dump\n+\n+            # Make the dump\n+            noprivs_wallet.unloadwallet()\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs.dump\"\n+            do_wallet_tool(\"-wallet=noprivs\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+\n+            # Modify the dump\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                dump_content = f.readlines()\n+            # Drop the checksum line\n+            dump_content = dump_content[:-1]\n+            # Insert a valid mkey line. This corresponds to a passphrase of \"pass\".\n+            dump_content.append(\"046d6b657901000000,300dc926f3b3887aad3d5d5f5a0fc1b1a4a1722f9284bd5c6ff93b64a83902765953939c58fe144013c8b819f42cf698b208e9911e5f0c544fa300000000cc52050000\\n\")\n+            with open(dumpfile_path, \"w\", encoding=\"utf-8\") as f:\n+                contents = \"\".join(dump_content)\n+                f.write(contents)\n+                checksum = hash256(contents.encode())\n+                f.write(f\"checksum,{checksum.hex()}\\n\")\n+\n+            # Load the dump into a new wallet\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"createfromdump\")\n+            # Load the wallet and make sure it is no longer encrypted\n+            with self.nodes[0].assert_debug_log([\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\"]):\n+                self.nodes[0].loadwallet(\"noprivs_enc\")\n+            noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs_enc\")\n+            assert_raises_rpc_error(-15, \"Error: running with an unencrypted wallet, but walletpassphrase was called.\", noprivs_wallet.walletpassphrase, \"pass\", 1)\n+            noprivs_wallet.unloadwallet()\n+\n+            # Make a new dump and check that there are no mkeys\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs_enc.dump\"\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                assert_equal(all([not line.startswith(\"046d6b6579\") for line in f]), True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1378684726",
      "id" : 1378684726,
      "in_reply_to_id" : 1378227825,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585SLQ82",
      "original_commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "original_line" : 161,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/wallet_encryption.py",
      "position" : 70,
      "pull_request_review_id" : 1707986305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378684726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T11:57:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378684726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1379059681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379059681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The lock is already being held from the top of the function.",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-01T16:54:59Z",
      "diff_hunk" : "@@ -1227,6 +1232,21 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Since it was accidentally possible to \"encrypt\" a wallet with private keys disabled, we should check if this is\n+    // such a wallet and remove the encryption key records to avoid any future issues.\n+    // Although wallets without private keys should not have *ckey records, we should double check that.\n+    // Removing the mkey records is only safe if there are no *ckey records.\n+    if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && pwallet->HasEncryptionKeys() && !pwallet->HaveCryptedKeys()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1379059681",
      "id" : 1379059681,
      "in_reply_to_id" : 1378657380,
      "line" : 1239,
      "node_id" : "PRRC_kwDOABII585SMsfh",
      "original_commit_id" : "4db9b63fdcb5d32fa1ad98f263c9f77edf1af8a4",
      "original_line" : 1239,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 20,
      "pull_request_review_id" : 1708632982,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379059681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T16:55:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379059681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1379378823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379378823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm still not sure about #28142 but, if we ever do something like that, we could have an encrypted wallet without encrypted private keys. So, might want to change the \"without private keys\" to \"without any encrypted record\".",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-01T22:05:51Z",
      "diff_hunk" : "@@ -1227,6 +1232,21 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Since it was accidentally possible to \"encrypt\" a wallet with private keys disabled, we should check if this is\n+    // such a wallet and remove the encryption key records to avoid any future issues.\n+    // Although wallets without private keys should not have *ckey records, we should double check that.\n+    // Removing the mkey records is only safe if there are no *ckey records.\n+    if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && pwallet->HasEncryptionKeys() && !pwallet->HaveCryptedKeys()) {\n+        pwallet->WalletLogPrintf(\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1379378823",
      "id" : 1379378823,
      "line" : 1240,
      "node_id" : "PRRC_kwDOABII585SN6aH",
      "original_commit_id" : "4db9b63fdcb5d32fa1ad98f263c9f77edf1af8a4",
      "original_line" : 1240,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 21,
      "pull_request_review_id" : 1709154451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379378823/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T22:07:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379378823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1411216955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411216955"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will add a comment if I re-touch",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-30T20:18:45Z",
      "diff_hunk" : "@@ -100,6 +102,64 @@ def run_test(self):\n             sig = self.nodes[0].signmessage(address, msg)\n             assert self.nodes[0].verifymessage(address, sig, msg)\n \n+        self.log.info(\"Test that wallets without private keys cannot be encrypted\")\n+        self.nodes[0].createwallet(wallet_name=\"noprivs\", disable_private_keys=True)\n+        noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs\")\n+        assert_raises_rpc_error(-16, \"Error: wallet does not contain private keys, nothing to encrypt.\", noprivs_wallet.encryptwallet, \"pass\")\n+\n+        if self.is_wallet_tool_compiled():\n+            self.log.info(\"Test that encryption keys in wallets without privkeys are removed\")\n+\n+            def do_wallet_tool(*args):\n+                proc = subprocess.Popen(\n+                    [self.options.bitcoinwallet, f\"-datadir={self.nodes[0].datadir_path}\", f\"-chain={self.chain}\"] + list(args),\n+                    stdin=subprocess.PIPE,\n+                    stdout=subprocess.PIPE,\n+                    stderr=subprocess.PIPE,\n+                    text=True\n+                )\n+                stdout, stderr = proc.communicate()\n+                assert_equal(proc.poll(), 0)\n+                assert_equal(stderr, \"\")\n+\n+            # Since it is no longer possible to encrypt a wallet without privkeys, we need to force one into the wallet\n+            # 1. Make a dump of the wallet\n+            # 2. Add mkey record to the dump\n+            # 3. Create a new wallet from the dump\n+\n+            # Make the dump\n+            noprivs_wallet.unloadwallet()\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs.dump\"\n+            do_wallet_tool(\"-wallet=noprivs\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+\n+            # Modify the dump\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                dump_content = f.readlines()\n+            # Drop the checksum line\n+            dump_content = dump_content[:-1]\n+            # Insert a valid mkey line. This corresponds to a passphrase of \"pass\".\n+            dump_content.append(\"046d6b657901000000,300dc926f3b3887aad3d5d5f5a0fc1b1a4a1722f9284bd5c6ff93b64a83902765953939c58fe144013c8b819f42cf698b208e9911e5f0c544fa300000000cc52050000\\n\")\n+            with open(dumpfile_path, \"w\", encoding=\"utf-8\") as f:\n+                contents = \"\".join(dump_content)\n+                f.write(contents)\n+                checksum = hash256(contents.encode())\n+                f.write(f\"checksum,{checksum.hex()}\\n\")\n+\n+            # Load the dump into a new wallet\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"createfromdump\")\n+            # Load the wallet and make sure it is no longer encrypted\n+            with self.nodes[0].assert_debug_log([\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\"]):\n+                self.nodes[0].loadwallet(\"noprivs_enc\")\n+            noprivs_wallet = self.nodes[0].get_wallet_rpc(\"noprivs_enc\")\n+            assert_raises_rpc_error(-15, \"Error: running with an unencrypted wallet, but walletpassphrase was called.\", noprivs_wallet.walletpassphrase, \"pass\", 1)\n+            noprivs_wallet.unloadwallet()\n+\n+            # Make a new dump and check that there are no mkeys\n+            dumpfile_path = self.nodes[0].datadir_path / \"noprivs_enc.dump\"\n+            do_wallet_tool(\"-wallet=noprivs_enc\", f\"-dumpfile={dumpfile_path}\", \"dump\")\n+            with open(dumpfile_path, \"r\", encoding=\"utf-8\") as f:\n+                assert_equal(all([not line.startswith(\"046d6b6579\") for line in f]), True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1411216955",
      "id" : 1411216955,
      "in_reply_to_id" : 1378227825,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585UHXY7",
      "original_commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "original_line" : 161,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/wallet_encryption.py",
      "position" : 70,
      "pull_request_review_id" : 1758376924,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411216955/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-30T20:18:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411216955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1411217384"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411217384"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it would be useful to log them.",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-30T20:19:10Z",
      "diff_hunk" : "@@ -1227,6 +1232,21 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Since it was accidentally possible to \"encrypt\" a wallet with private keys disabled, we should check if this is\n+    // such a wallet and remove the encryption key records to avoid any future issues.\n+    // Although wallets without private keys should not have *ckey records, we should double check that.\n+    // Removing the mkey records is only safe if there are no *ckey records.\n+    if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && pwallet->HasEncryptionKeys() && !pwallet->HaveCryptedKeys()) {\n+        pwallet->WalletLogPrintf(\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1411217384",
      "id" : 1411217384,
      "in_reply_to_id" : 1378673670,
      "line" : 1240,
      "node_id" : "PRRC_kwDOABII585UHXfo",
      "original_commit_id" : "4db9b63fdcb5d32fa1ad98f263c9f77edf1af8a4",
      "original_line" : 1240,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 21,
      "pull_request_review_id" : 1758377486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411217384/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-30T20:19:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411217384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1411218639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411218639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is fine as is. It can be updated in the future if it becomes outdated.",
      "commit_id" : "aaa6b709d164052c8b2496cbedccf8ccf48c4aa2",
      "created_at" : "2023-11-30T20:20:39Z",
      "diff_hunk" : "@@ -1227,6 +1232,21 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n         result = DBErrors::CORRUPT;\n     }\n \n+    // Since it was accidentally possible to \"encrypt\" a wallet with private keys disabled, we should check if this is\n+    // such a wallet and remove the encryption key records to avoid any future issues.\n+    // Although wallets without private keys should not have *ckey records, we should double check that.\n+    // Removing the mkey records is only safe if there are no *ckey records.\n+    if (pwallet->IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) && pwallet->HasEncryptionKeys() && !pwallet->HaveCryptedKeys()) {\n+        pwallet->WalletLogPrintf(\"Detected extraneous encryption keys in this wallet without private keys. Removing extraneous encryption keys.\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#discussion_r1411218639",
      "id" : 1411218639,
      "in_reply_to_id" : 1379378823,
      "line" : 1240,
      "node_id" : "PRRC_kwDOABII585UHXzP",
      "original_commit_id" : "4db9b63fdcb5d32fa1ad98f263c9f77edf1af8a4",
      "original_line" : 1240,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 21,
      "pull_request_review_id" : 1758379433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28724",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411218639/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-30T20:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411218639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Guessing that in the case of adding a new type of encrypted record in the future for private keys disabled wallets, we would be forced to add downgrade protection if we merge this PR?\r\n\r\nYes, but I think it's unlikely such usage of encryption keys would be added, and if it were, it could still be added in a way that does not interact with this PR.\r\n\r\nFor example,although #28142 allows for encryption of records regardless of the wallet flags, it does this at the database level and uses separate records, so this PR doesn't affect it at all.",
      "created_at" : "2024-01-02T23:26:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28724#issuecomment-1874681373",
      "id" : 1874681373,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28724",
      "node_id" : "IC_kwDOABII585vvV4d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1874681373/reactions"
      },
      "updated_at" : "2024-01-02T23:27:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1874681373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
