[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28758).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26711](https://github.com/bitcoin/bitcoin/pull/26711) (validate package transactions with their in-package ancestor sets by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-10-31T09:14:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#issuecomment-1786805691",
      "id" : 1786805691,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28758",
      "node_id" : "IC_kwDOABII585qgH27",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1786805691/reactions"
      },
      "updated_at" : "2023-10-31T10:40:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1786805691",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377326791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377326791"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `IsSorted` does not convey what is being checked for sortedness.\r\n\r\n```suggestion\r\nbool IsPackageSorted(const Package& txns);\r\n```",
      "commit_id" : "f60560bf39c031e0ba4b6e04baf3b6deb6cdc07f",
      "created_at" : "2023-10-31T09:54:21Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsSorted(const Package& txns);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377326791",
      "id" : 1377326791,
      "line" : 60,
      "node_id" : "PRRC_kwDOABII585SGFbH",
      "original_commit_id" : "f60560bf39c031e0ba4b6e04baf3b6deb6cdc07f",
      "original_line" : 60,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : 21,
      "pull_request_review_id" : 1705880534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377326791/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T09:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377326791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377493306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377493306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, renamed this to `IsTopoSortedPackage`, i.e. \"is a topologically sorted package\" to be more descriptive.",
      "commit_id" : "6432d249fa6dbd8bc154ceb9608b9cab9abdd044",
      "created_at" : "2023-10-31T12:14:07Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsSorted(const Package& txns);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377493306",
      "id" : 1377493306,
      "in_reply_to_id" : 1377326791,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SGuE6",
      "original_commit_id" : "f60560bf39c031e0ba4b6e04baf3b6deb6cdc07f",
      "original_line" : 60,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 1706151209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377493306/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T12:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377493306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377497946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377497946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can you do the same for `IsConsistent`? e.g. `IsPackageConsistent`",
      "commit_id" : "6432d249fa6dbd8bc154ceb9608b9cab9abdd044",
      "created_at" : "2023-10-31T12:18:23Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsSorted(const Package& txns);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377497946",
      "id" : 1377497946,
      "in_reply_to_id" : 1377326791,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SGvNa",
      "original_commit_id" : "f60560bf39c031e0ba4b6e04baf3b6deb6cdc07f",
      "original_line" : 60,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 1706159997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377497946/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T12:18:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377497946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377697411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377697411"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Renamed to `IsConsistentPackage`",
      "commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "created_at" : "2023-10-31T14:38:19Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsSorted(const Package& txns);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1377697411",
      "id" : 1377697411,
      "in_reply_to_id" : 1377326791,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SHf6D",
      "original_commit_id" : "f60560bf39c031e0ba4b6e04baf3b6deb6cdc07f",
      "original_line" : 60,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 1706483972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377697411/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-31T14:38:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1377697411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378307864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378307864"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could alternatively make these member functions of `Package` ?",
      "commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "created_at" : "2023-11-01T01:29:56Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsSorted(const Package& txns);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378307864",
      "id" : 1378307864,
      "in_reply_to_id" : 1377326791,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SJ08Y",
      "original_commit_id" : "f60560bf39c031e0ba4b6e04baf3b6deb6cdc07f",
      "original_line" : 60,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 1707452030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378307864/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T01:29:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378307864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378634066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378634066"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This can be dropped from the header, nothing is using it externally.",
      "commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "created_at" : "2023-11-01T10:35:28Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsTopoSortedPackage(const Package& txns);\n+\n+/** IsTopoSortedPackage where a set of txids has been pre-populated. The set is assumed to be correct and\n+ * is mutated within this function (even if return value is false). */\n+bool IsTopoSortedPackage(const Package& txns, std::unordered_set<uint256, SaltedTxidHasher>& all_txids);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378634066",
      "id" : 1378634066,
      "line" : 64,
      "node_id" : "PRRC_kwDOABII585SLElS",
      "original_commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "original_line" : 64,
      "original_position" : 25,
      "original_start_line" : 62,
      "path" : "src/policy/packages.h",
      "position" : 25,
      "pull_request_review_id" : 1707949712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378634066/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 62,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-01T10:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378634066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378636413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378636413"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: the naming is slightly inconsistent now, it would be nicer if all the functions are either `IsPackage*` or `Is*Package` instead of a mix. Would also not be opposed to turning `Package` into a class and have these be member functions.",
      "commit_id" : "b5a60abe8783852f5b31bc1e63b5836530410e65",
      "created_at" : "2023-11-01T10:38:07Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsTopoSortedPackage(const Package& txns);\n+\n+/** IsTopoSortedPackage where a set of txids has been pre-populated. The set is assumed to be correct and\n+ * is mutated within this function (even if return value is false). */\n+bool IsTopoSortedPackage(const Package& txns, std::unordered_set<uint256, SaltedTxidHasher>& all_txids);\n+\n+/** Checks that these transactions don't conflict, i.e., spend the same prevout. This includes\n+ * checking that there are no duplicate transactions. Since these checks require looking at the inputs\n+ * of a transaction, returns false immediately if any transactions have empty vin.\n+ *\n+ * Does not check consistency of a transaction with oneself; does not check if a transaction spends\n+ * the same prevout multiple times (see bad-txns-inputs-duplicate in CheckTransaction()).\n+ *\n+ * @returns true if there are no conflicts. False if any two transactions spend the same prevout.\n+ * */\n+bool IsConsistentPackage(const Package& txns);\n+\n /** Context-free package policy checks:\n  * 1. The number of transactions cannot exceed MAX_PACKAGE_COUNT.\n  * 2. The total weight cannot exceed MAX_PACKAGE_WEIGHT.\n  * 3. If any dependencies exist between transactions, parents must appear before children.\n  * 4. Transactions cannot conflict, i.e., spend the same inputs.\n  */\n-bool CheckPackage(const Package& txns, PackageValidationState& state);\n+bool IsPackageWellFormed(const Package& txns, PackageValidationState& state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378636413",
      "id" : 1378636413,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SLFJ9",
      "original_commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "original_line" : 83,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 1707949712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378636413/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T14:07:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378636413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378645903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378645903"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    CMutableTransaction dup_tx;\r\n    dup_tx.vin.emplace_back(uint256{}, 0);\r\n    dup_tx.vin.emplace_back(uint256{}, 0);\r\n    Package package_with_dup_tx{MakeTransactionRef(dup_tx)};\r\n    BOOST_CHECK(IsConsistentPackage(package_with_dup_tx));\r\n    package_with_dup_tx.emplace_back(create_placeholder_tx(1, 1));\r\n    BOOST_CHECK(IsConsistentPackage(package_with_dup_tx));\r\n```\r\n\r\n`dup_tx` is otherwise unused and does not conflict with itself.",
      "commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "created_at" : "2023-11-01T10:49:17Z",
      "diff_hunk" : "@@ -73,9 +74,38 @@ BOOST_FIXTURE_TEST_CASE(package_sanitization_tests, TestChain100Setup)\n         package_duplicate_txids_empty.emplace_back(MakeTransactionRef(empty_tx));\n     }\n     PackageValidationState state_duplicates;\n-    BOOST_CHECK(!CheckPackage(package_duplicate_txids_empty, state_duplicates));\n+    BOOST_CHECK(!IsPackageWellFormed(package_duplicate_txids_empty, state_duplicates));\n     BOOST_CHECK_EQUAL(state_duplicates.GetResult(), PackageValidationResult::PCKG_POLICY);\n     BOOST_CHECK_EQUAL(state_duplicates.GetRejectReason(), \"package-contains-duplicates\");\n+    BOOST_CHECK(!IsConsistentPackage(package_duplicate_txids_empty));\n+\n+    // Packages can't have transactions spending the same prevout\n+    CMutableTransaction tx_zero_1;\n+    CMutableTransaction tx_zero_2;\n+    COutPoint same_prevout{InsecureRand256(), 0};\n+    tx_zero_1.vin.emplace_back(same_prevout);\n+    tx_zero_2.vin.emplace_back(same_prevout);\n+    // Different vouts (not the same tx)\n+    tx_zero_1.vout.emplace_back(CENT, P2WSH_OP_TRUE);\n+    tx_zero_2.vout.emplace_back(2 * CENT, P2WSH_OP_TRUE);\n+    Package package_conflicts{MakeTransactionRef(tx_zero_1), MakeTransactionRef(tx_zero_2)};\n+    BOOST_CHECK(!IsConsistentPackage(package_conflicts));\n+    // Transactions are considered sorted when they have no dependencies.\n+    BOOST_CHECK(IsTopoSortedPackage(package_conflicts));\n+    PackageValidationState state_conflicts;\n+    BOOST_CHECK(!IsPackageWellFormed(package_conflicts, state_conflicts));\n+    BOOST_CHECK_EQUAL(state_conflicts.GetResult(), PackageValidationResult::PCKG_POLICY);\n+    BOOST_CHECK_EQUAL(state_conflicts.GetRejectReason(), \"conflict-in-package\");\n+\n+    // IsConsistentPackage only cares about conflicts between transactions, not about a transaction\n+    // conflicting with itself (i.e. duplicate prevouts in vin).\n+    CMutableTransaction dup_tx;\n+    dup_tx.vin.emplace_back(InsecureRand256(), 0);\n+    dup_tx.vin.emplace_back(InsecureRand256(), 0);\n+    Package package_with_dup_tx;\n+    BOOST_CHECK(IsConsistentPackage(package_with_dup_tx));\n+    package_with_dup_tx.emplace_back(create_placeholder_tx(1, 1));\n+    BOOST_CHECK(IsConsistentPackage(package_with_dup_tx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1378645903",
      "id" : 1378645903,
      "line" : 108,
      "node_id" : "PRRC_kwDOABII585SLHeP",
      "original_commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "original_line" : 108,
      "original_position" : 62,
      "original_start_line" : 102,
      "path" : "src/test/txpackage_tests.cpp",
      "position" : 62,
      "pull_request_review_id" : 1707949712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378645903/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 102,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-01T10:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1378645903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1379095337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok",
      "commit_id" : "b5a60abe8783852f5b31bc1e63b5836530410e65",
      "created_at" : "2023-11-01T17:23:05Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsTopoSortedPackage(const Package& txns);\n+\n+/** IsTopoSortedPackage where a set of txids has been pre-populated. The set is assumed to be correct and\n+ * is mutated within this function (even if return value is false). */\n+bool IsTopoSortedPackage(const Package& txns, std::unordered_set<uint256, SaltedTxidHasher>& all_txids);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1379095337",
      "id" : 1379095337,
      "in_reply_to_id" : 1378634066,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SM1Mp",
      "original_commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "original_line" : 64,
      "original_position" : 25,
      "original_start_line" : 62,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 1708690726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-01T17:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1379095561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I made it iswellformedpackage",
      "commit_id" : "b5a60abe8783852f5b31bc1e63b5836530410e65",
      "created_at" : "2023-11-01T17:23:14Z",
      "diff_hunk" : "@@ -49,13 +51,36 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsTopoSortedPackage(const Package& txns);\n+\n+/** IsTopoSortedPackage where a set of txids has been pre-populated. The set is assumed to be correct and\n+ * is mutated within this function (even if return value is false). */\n+bool IsTopoSortedPackage(const Package& txns, std::unordered_set<uint256, SaltedTxidHasher>& all_txids);\n+\n+/** Checks that these transactions don't conflict, i.e., spend the same prevout. This includes\n+ * checking that there are no duplicate transactions. Since these checks require looking at the inputs\n+ * of a transaction, returns false immediately if any transactions have empty vin.\n+ *\n+ * Does not check consistency of a transaction with oneself; does not check if a transaction spends\n+ * the same prevout multiple times (see bad-txns-inputs-duplicate in CheckTransaction()).\n+ *\n+ * @returns true if there are no conflicts. False if any two transactions spend the same prevout.\n+ * */\n+bool IsConsistentPackage(const Package& txns);\n+\n /** Context-free package policy checks:\n  * 1. The number of transactions cannot exceed MAX_PACKAGE_COUNT.\n  * 2. The total weight cannot exceed MAX_PACKAGE_WEIGHT.\n  * 3. If any dependencies exist between transactions, parents must appear before children.\n  * 4. Transactions cannot conflict, i.e., spend the same inputs.\n  */\n-bool CheckPackage(const Package& txns, PackageValidationState& state);\n+bool IsPackageWellFormed(const Package& txns, PackageValidationState& state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1379095561",
      "id" : 1379095561,
      "in_reply_to_id" : 1378636413,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SM1QJ",
      "original_commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "original_line" : 83,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 1708690726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095561/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T17:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1379095637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "b5a60abe8783852f5b31bc1e63b5836530410e65",
      "created_at" : "2023-11-01T17:23:19Z",
      "diff_hunk" : "@@ -73,9 +74,38 @@ BOOST_FIXTURE_TEST_CASE(package_sanitization_tests, TestChain100Setup)\n         package_duplicate_txids_empty.emplace_back(MakeTransactionRef(empty_tx));\n     }\n     PackageValidationState state_duplicates;\n-    BOOST_CHECK(!CheckPackage(package_duplicate_txids_empty, state_duplicates));\n+    BOOST_CHECK(!IsPackageWellFormed(package_duplicate_txids_empty, state_duplicates));\n     BOOST_CHECK_EQUAL(state_duplicates.GetResult(), PackageValidationResult::PCKG_POLICY);\n     BOOST_CHECK_EQUAL(state_duplicates.GetRejectReason(), \"package-contains-duplicates\");\n+    BOOST_CHECK(!IsConsistentPackage(package_duplicate_txids_empty));\n+\n+    // Packages can't have transactions spending the same prevout\n+    CMutableTransaction tx_zero_1;\n+    CMutableTransaction tx_zero_2;\n+    COutPoint same_prevout{InsecureRand256(), 0};\n+    tx_zero_1.vin.emplace_back(same_prevout);\n+    tx_zero_2.vin.emplace_back(same_prevout);\n+    // Different vouts (not the same tx)\n+    tx_zero_1.vout.emplace_back(CENT, P2WSH_OP_TRUE);\n+    tx_zero_2.vout.emplace_back(2 * CENT, P2WSH_OP_TRUE);\n+    Package package_conflicts{MakeTransactionRef(tx_zero_1), MakeTransactionRef(tx_zero_2)};\n+    BOOST_CHECK(!IsConsistentPackage(package_conflicts));\n+    // Transactions are considered sorted when they have no dependencies.\n+    BOOST_CHECK(IsTopoSortedPackage(package_conflicts));\n+    PackageValidationState state_conflicts;\n+    BOOST_CHECK(!IsPackageWellFormed(package_conflicts, state_conflicts));\n+    BOOST_CHECK_EQUAL(state_conflicts.GetResult(), PackageValidationResult::PCKG_POLICY);\n+    BOOST_CHECK_EQUAL(state_conflicts.GetRejectReason(), \"conflict-in-package\");\n+\n+    // IsConsistentPackage only cares about conflicts between transactions, not about a transaction\n+    // conflicting with itself (i.e. duplicate prevouts in vin).\n+    CMutableTransaction dup_tx;\n+    dup_tx.vin.emplace_back(InsecureRand256(), 0);\n+    dup_tx.vin.emplace_back(InsecureRand256(), 0);\n+    Package package_with_dup_tx;\n+    BOOST_CHECK(IsConsistentPackage(package_with_dup_tx));\n+    package_with_dup_tx.emplace_back(create_placeholder_tx(1, 1));\n+    BOOST_CHECK(IsConsistentPackage(package_with_dup_tx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1379095637",
      "id" : 1379095637,
      "in_reply_to_id" : 1378645903,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SM1RV",
      "original_commit_id" : "80cd897945193e03a4b0776537de219d12203373",
      "original_line" : 109,
      "original_position" : 62,
      "original_start_line" : 102,
      "path" : "src/test/txpackage_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1708690726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095637/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-01T17:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379095637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1380874443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380874443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "âas unconfirmed transactions are not allowed to have no inputs at consensus validation (see CheckTransaction)\"",
      "commit_id" : "b5a60abe8783852f5b31bc1e63b5836530410e65",
      "created_at" : "2023-11-02T23:09:35Z",
      "diff_hunk" : "@@ -6,16 +6,77 @@\n #include <policy/policy.h>\n #include <primitives/transaction.h>\n #include <uint256.h>\n-#include <util/hasher.h>\n+#include <util/check.h>\n \n #include <algorithm>\n #include <cassert>\n #include <iterator>\n #include <memory>\n #include <numeric>\n-#include <unordered_set>\n \n-bool CheckPackage(const Package& txns, PackageValidationState& state)\n+/** IsTopoSortedPackage where a set of txids has been pre-populated. The set is assumed to be correct and\n+ * is mutated within this function (even if return value is false). */\n+bool IsTopoSortedPackage(const Package& txns, std::unordered_set<uint256, SaltedTxidHasher>& later_txids)\n+{\n+    // Avoid misusing this function: later_txids should contain the txids of txns.\n+    Assume(txns.size() == later_txids.size());\n+\n+    // later_txids always contains the txids of this transaction and the ones that come later in\n+    // txns. If any transaction's input spends a tx in that set, we've found a parent placed later\n+    // than its child.\n+    for (const auto& tx : txns) {\n+        for (const auto& input : tx->vin) {\n+            if (later_txids.find(input.prevout.hash) != later_txids.end()) {\n+                // The parent is a subsequent transaction in the package.\n+                return false;\n+            }\n+        }\n+        // Avoid misusing this function: later_txids must contain every tx.\n+        Assume(later_txids.erase(tx->GetHash()) == 1);\n+    }\n+\n+    // Avoid misusing this function: later_txids should have contained the txids of txns.\n+    Assume(later_txids.empty());\n+    return true;\n+}\n+\n+bool IsTopoSortedPackage(const Package& txns)\n+{\n+    std::unordered_set<uint256, SaltedTxidHasher> later_txids;\n+    std::transform(txns.cbegin(), txns.cend(), std::inserter(later_txids, later_txids.end()),\n+                   [](const auto& tx) { return tx->GetHash(); });\n+\n+    return IsTopoSortedPackage(txns, later_txids);\n+}\n+\n+bool IsConsistentPackage(const Package& txns)\n+{\n+    // Don't allow any conflicting transactions, i.e. spending the same inputs, in a package.\n+    std::unordered_set<COutPoint, SaltedOutpointHasher> inputs_seen;\n+    for (const auto& tx : txns) {\n+        if (tx->vin.empty()) {\n+            // This function checks consistency based on inputs, and we can't do that if there are\n+            // no inputs. Duplicate empty transactions are also not consistent with one another.\n+            // This doesn't create false negatives, as unconfirmed transactions are not allowed to\n+            // have no inputs.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1380874443",
      "id" : 1380874443,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII585STnjL",
      "original_commit_id" : "da9aceba217bbded6909f06144eaa1e1a4ebcb69",
      "original_line" : 61,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/policy/packages.cpp",
      "position" : 59,
      "pull_request_review_id" : 1711387126,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380874443/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T23:12:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380874443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1380876016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380876016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I donât know what is mean by consistency of a transaction with oneself (e.g if txouts are under 0 or over `MAX_MONEY`) or youâre only implying âdoes not spend same prevout multiple timesâ. ",
      "commit_id" : "b5a60abe8783852f5b31bc1e63b5836530410e65",
      "created_at" : "2023-11-02T23:12:05Z",
      "diff_hunk" : "@@ -49,13 +51,32 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsTopoSortedPackage(const Package& txns);\n+\n+/** Checks that these transactions don't conflict, i.e., spend the same prevout. This includes\n+ * checking that there are no duplicate transactions. Since these checks require looking at the inputs\n+ * of a transaction, returns false immediately if any transactions have empty vin.\n+ *\n+ * Does not check consistency of a transaction with oneself; does not check if a transaction spends",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1380876016",
      "id" : 1380876016,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585STn7w",
      "original_commit_id" : "da9aceba217bbded6909f06144eaa1e1a4ebcb69",
      "original_line" : 66,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : 27,
      "pull_request_review_id" : 1711387126,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380876016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T23:12:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380876016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1381323292"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1381323292"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's that helpful to list more things this function *doesn't* check.",
      "commit_id" : "b5a60abe8783852f5b31bc1e63b5836530410e65",
      "created_at" : "2023-11-03T08:59:55Z",
      "diff_hunk" : "@@ -49,13 +51,32 @@ using Package = std::vector<CTransactionRef>;\n \n class PackageValidationState : public ValidationState<PackageValidationResult> {};\n \n+/** If any direct dependencies exist between transactions (i.e. a child spending the output of a\n+ * parent), checks that all parents appear somewhere in the list before their respective children.\n+ * No other ordering is enforced. This function cannot detect indirect dependencies (e.g. a\n+ * transaction's grandparent if its parent is not present).\n+ * @returns true if sorted. False if any tx spends the output of a tx that appears later in txns.\n+ */\n+bool IsTopoSortedPackage(const Package& txns);\n+\n+/** Checks that these transactions don't conflict, i.e., spend the same prevout. This includes\n+ * checking that there are no duplicate transactions. Since these checks require looking at the inputs\n+ * of a transaction, returns false immediately if any transactions have empty vin.\n+ *\n+ * Does not check consistency of a transaction with oneself; does not check if a transaction spends",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28758#discussion_r1381323292",
      "id" : 1381323292,
      "in_reply_to_id" : 1380876016,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585SVVIc",
      "original_commit_id" : "da9aceba217bbded6909f06144eaa1e1a4ebcb69",
      "original_line" : 66,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : 27,
      "pull_request_review_id" : 1712089855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28758",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1381323292/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-03T08:59:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1381323292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
