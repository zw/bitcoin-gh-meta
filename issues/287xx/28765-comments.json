[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28765).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [brunoerg](https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1790706698), [sr-gi](https://github.com/bitcoin/bitcoin/pull/28765#pullrequestreview-1737983905) |\n| Approach ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/28765#pullrequestreview-1709034021) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#21515](https://github.com/bitcoin/bitcoin/pull/21515) (Erlay: bandwidth-efficient transaction relay protocol by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-11-01T09:06:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1788632672",
      "id" : 1788632672,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585qnF5g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1788632672/reactions"
      },
      "updated_at" : "2023-11-21T21:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1788632672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379299664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379299664"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could you explain a bit more why this is necessary, what is the lock order that would get violated if we did the locking later (just here, not necessarily in the comment)?",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-01T20:27:58Z",
      "diff_hunk" : "@@ -5752,9 +5759,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379299664",
      "id" : 1379299664,
      "line" : 5762,
      "node_id" : "PRRC_kwDOABII585SNnFQ",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 5762,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379299664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T21:45:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379299664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306577"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: remove one `//`",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:35:43Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.\n+    for (int i = 1; i < 31; ++i) {\n+        tracker.PreRegisterPeer(i);\n+        BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+\n+    }\n+\n+    // Relay to a fraction of registered inbound peers.\n+    for (int j = 0; j < 100; ++j) {\n+        size_t total_fanouted = 0;\n+        auto wtxid = GetRandHash();\n+        for (int i = 1; i < 31; ++i) {\n+            total_fanouted += tracker.ShouldFanoutTo(wtxid, hasher, i,\n+                                               /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0);\n+        }\n+        BOOST_CHECK_EQUAL(total_fanouted, 3);\n+    }\n+\n+    // // Don't relay if there is sufficient non-reconciling peers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306577",
      "id" : 1379306577,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII585SNoxR",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 144,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 64,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306928"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306928"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder if this algorithm (which took me a while to fully understand) could be simpler. \r\nE.g., if we used a sorted container for `best_peers` instead of a vector, inserted all of the peers, and then finally return the first `targets` elements of that container, I think we could do without the `try_fanout_candidate` lambda.\r\nOr would that be incorrect / less performant?\r\n\r\nI'm thinking of something like the following (just to show idea, I didn't test it):\r\n\r\n    struct ComparePairs {\r\n        bool operator()(const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) const {\r\n            return left.first > right.first;\r\n        }\r\n    };\r\n    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\r\n                                         bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\r\n    {\r\n        // The algorithm works as follows. We iterate through the peers (of a given direction)\r\n        // hashing them with the given wtxid, and sort them by this hash.\r\n        // We then consider top `limit` peers to be low-fanout flood targets.\r\n        // The randomness should be seeded with wtxid to return consistent results for every call.\r\n\r\n        double integer_part;\r\n        double fractional_peer = std::modf(limit, &integer_part);\r\n        const bool drop_peer_if_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\r\n        const size_t targets = drop_peer_if_extra ? size_t(integer_part): size_t(integer_part) + 1;\r\n\r\n        std::set<std::pair<uint64_t, NodeId>, ComparePairs> best_peers;\r\n\r\n        for (auto indexed_state : m_states) {\r\n            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\r\n            if (cur_state && cur_state->m_we_initiate == we_initiate) {\r\n                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\r\n                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\r\n            }\r\n        }\r\n\r\n        std::vector<NodeId> result;\r\n        auto it = best_peers.begin();\r\n        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\r\n            result.push_back(it->second);\r\n        }\r\n        return result;\r\n    }",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:36:07Z",
      "diff_hunk" : "@@ -193,6 +210,104 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306928",
      "id" : 1379306928,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585SNo2w",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 214,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 44,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306928/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306928",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379309905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379309905"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do we have to first add and then (maybe) drop a peer here (instead of determining how many peers we want at the beginning, and then getting as many peers as we can up the desired number).",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:39:46Z",
      "diff_hunk" : "@@ -193,6 +210,104 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                         bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // To handle fractional values, we add one peer optimistically and then probabilistically\n+        // drop it later.\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        const size_t targets = size_t(integer_part) + 1;\n+        const bool drop_peer_if_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379309905",
      "id" : 1379309905,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII585SNplR",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 227,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 57,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379309905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379309905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379312851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379312851"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "10% of 30 is integer, so maybe also add an example with a fraction. If we run it  often enough, we could probably assert that two values for `total_fanouted` are possible.",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:43:10Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379312851",
      "id" : 1379312851,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII585SNqTT",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 126,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 46,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379312851/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379312851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379313360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379313360"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: remove empty line",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:43:47Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.\n+    for (int i = 1; i < 31; ++i) {\n+        tracker.PreRegisterPeer(i);\n+        BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379313360",
      "id" : 1379313360,
      "line" : 130,
      "node_id" : "PRRC_kwDOABII585SNqbQ",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 130,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 50,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379313360/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379313360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379714659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379714659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried a whole bunch of combinations. Say, you move the `LOCK(m_peer_mutex);` to L5831, where `m_peer_map` is used.\r\n\r\nThen you get something [like this](https://cirrus-ci.com/task/6561881997967360?logs=ci#L3228) in Cirrus (not exactly!).\r\n\r\n```\r\n node0 2023-08-17T12:01:53.647510Z [msghand] [sync.cpp:97] [potential_deadlock_detected] POTENTIAL DEADLOCK DETECTED \r\n node0 2023-08-17T12:01:53.647516Z [msghand] [sync.cpp:98] [potential_deadlock_detected] Previous lock order was: \r\n node0 2023-08-17T12:01:53.647523Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'NetEventsInterface::g_msgproc_mutex' in net.cpp:2095 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647531Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'cs_main' in net_processing.cpp:5473 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647574Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  (2) 'm_peer_mutex' in net_processing.cpp:5686 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647581Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'tx_relay->m_tx_inventory_mutex' in net_processing.cpp:5688 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647587Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'tx_relay->m_bloom_filter_mutex' in net_processing.cpp:5768 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647593Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  (1) 'm_mempool.cs' in net_processing.cpp:5850 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647598Z [msghand] [sync.cpp:111] [potential_deadlock_detected] Current lock order is: \r\n node0 2023-08-17T12:01:53.647604Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'NetEventsInterface::g_msgproc_mutex' in net.cpp:2095 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647610Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'm_chainstate_mutex' in validation.cpp:3102 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647616Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'cs_main' in validation.cpp:3124 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647622Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  (1) 'MempoolMutex()' in validation.cpp:3126 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647627Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'cs_main' in net_processing.cpp:2013 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647633Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  (2) 'm_peer_mutex' in net_processing.cpp:1593 (in thread 'msghand') \r\n```\r\n\r\nFrom this log you see that `m_peer_mutex` should go before `m_mempool.cs`. I admit it might be not the 100% optimal placement, feels NP-hard to me :) Do you know how to approach this better?",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T07:58:03Z",
      "diff_hunk" : "@@ -5752,9 +5759,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379714659",
      "id" : 1379714659,
      "in_reply_to_id" : 1379299664,
      "line" : 5762,
      "node_id" : "PRRC_kwDOABII585SPMZj",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 5762,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 1709638838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379714659/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T07:58:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379714659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379723181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379723181"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is certainly better. For no good reason, i just chose to follow a pattern we use elsewhere and never reconsidered it. I will take this code.",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T08:06:46Z",
      "diff_hunk" : "@@ -193,6 +210,104 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379723181",
      "id" : 1379723181,
      "in_reply_to_id" : 1379306928,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585SPOet",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 214,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 122,
      "pull_request_review_id" : 1709653011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379723181/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T08:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379723181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379749369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379749369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm always not sure what to do with these kinds of probabilistic scenarios... Say you run 1000 experiments, and get 1000/0, so the assert fails. Is 1,000,000 sufficient in that case? Or how do you think this should be asserted otherwise.",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T08:32:01Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379749369",
      "id" : 1379749369,
      "in_reply_to_id" : 1379312851,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII585SPU35",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 126,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 46,
      "pull_request_review_id" : 1709693742,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379749369/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T08:32:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379749369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-11-02T13:16:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1790706698",
      "id" : 1790706698,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585qvAQK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1790706698/reactions"
      },
      "updated_at" : "2023-11-02T13:16:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1790706698",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380105208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380105208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 983f8c6e305fd9707c109c2a92637825262b9b09: Since `fanout` is already initialized `true`, couldn't we simplify it?\r\n\r\n```diff\r\n@@ -5878,19 +5878,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\r\n                         if (reconciles_txs) {\r\n                             auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\r\n                             if (txiter) {\r\n-                                if ((*txiter)->GetCountWithDescendants() > 1) {\r\n-                                    // If a transaction has in-mempool children, always fanout it.\r\n-                                    // Until package relay is implemented, this is needed to avoid\r\n-                                    // breaking parent+child relay expectations in some cases.\r\n-                                    //\r\n-                                    // Potentially reconciling parent+child would mean that for every\r\n-                                    // child we need to to check if any of the parents is currently\r\n-                                    // reconciled so that the child isn't fanouted ahead. But then\r\n-                                    // it gets tricky when reconciliation sets are full: a) the child\r\n-                                    // can't just be added; b) removing parents from reconciliation\r\n-                                    // sets for this one child is not good either.\r\n-                                    fanout = true;\r\n-                                } else {\r\n+                                // If a transaction has in-mempool children, always fanout it.\r\n+                                // Until package relay is implemented, this is needed to avoid\r\n+                                // breaking parent+child relay expectations in some cases.\r\n+                                //\r\n+                                // Potentially reconciling parent+child would mean that for every\r\n+                                // child we need to to check if any of the parents is currently\r\n+                                // reconciled so that the child isn't fanouted ahead. But then\r\n+                                // it gets tricky when reconciliation sets are full: a) the child\r\n+                                // can't just be added; b) removing parents from reconciliation\r\n+                                // sets for this one child is not good either.\r\n+                                if ((*txiter)->GetCountWithDescendants() <= 1) {\r\n                                     auto fanout_randomizer = m_connman.GetDeterministicRandomizer(RANDOMIZER_ID_FANOUTTARGET);\r\n                                     fanout = m_txreconciliat\r\nion->ShouldFanoutTo(wtxid, fanout_randomizer, pto->GetId(),\r\n                                                             \r\n                    inbounds_nonrcncl_tx_relay, outbounds_non\r\nrcncl_tx_relay);\r\n```",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T13:28:33Z",
      "diff_hunk" : "@@ -5841,7 +5873,35 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                    // If a transaction has in-mempool children, always fanout it.\n+                                    // Until package relay is implemented, this is needed to avoid\n+                                    // breaking parent+child relay expectations in some cases.\n+                                    //\n+                                    // Potentially reconciling parent+child would mean that for every\n+                                    // child we need to to check if any of the parents is currently\n+                                    // reconciled so that the child isn't fanouted ahead. But then\n+                                    // it gets tricky when reconciliation sets are full: a) the child\n+                                    // can't just be added; b) removing parents from reconciliation\n+                                    // sets for this one child is not good either.\n+                                    fanout = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380105208",
      "id" : 1380105208,
      "line" : 5892,
      "node_id" : "PRRC_kwDOABII585SQrv4",
      "original_commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "original_line" : 5892,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 91,
      "pull_request_review_id" : 1710245379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380105208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T13:28:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380105208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380216381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380216381"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 983f8c6e305fd9707c109c2a92637825262b9b09: Correct me if I'm wrong, but we're going use `inbounds_nonrcncl_tx_relay` and `outbounds_nonrcncl_tx_relay` only whether `reconciles_txs` is true, couldn't we only fill them if so?:\r\n```suggestion\r\n                    if (reconciles_txs) {\r\n```",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T14:16:01Z",
      "diff_hunk" : "@@ -5814,6 +5824,28 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n+\n+                    size_t inbounds_nonrcncl_tx_relay = 0, outbounds_nonrcncl_tx_relay = 0;\n+                    if (m_txreconciliation) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380216381",
      "id" : 1380216381,
      "line" : 5829,
      "node_id" : "PRRC_kwDOABII585SRG49",
      "original_commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "original_line" : 5829,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 47,
      "pull_request_review_id" : 1710413774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380216381/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T14:16:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380216381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think a test can be added to exercise `AddToSet` and the check of the boundary `MAX_SET_SIZE` value.",
      "commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "created_at" : "2023-11-12T18:51:21Z",
      "diff_hunk" : "@@ -81,4 +81,75 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462533",
      "id" : 1390462533,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII585S4MZF",
      "original_commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "original_line" : 84,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1726306685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462533/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-12T18:54:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462790"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think can be `>` only. Generally sounds maximum in net_processing is understood as strictly superior, e.g `MAX_INV_SZ` usage.",
      "commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "created_at" : "2023-11-12T18:53:48Z",
      "diff_hunk" : "@@ -125,6 +133,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462790",
      "id" : 1390462790,
      "line" : 171,
      "node_id" : "PRRC_kwDOABII585S4MdG",
      "original_commit_id" : "7c4f8d9956efb7c239665ce6a66eae65ecfd5215",
      "original_line" : 154,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 78,
      "pull_request_review_id" : 1726306685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462790/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-12T18:54:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1394020665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1394020665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This happens before the addition. Your suggestion would mean that the size could be 3001, which is not desired.",
      "commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "created_at" : "2023-11-15T10:50:38Z",
      "diff_hunk" : "@@ -125,6 +133,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1394020665",
      "id" : 1394020665,
      "in_reply_to_id" : 1390462790,
      "line" : 171,
      "node_id" : "PRRC_kwDOABII585TFxE5",
      "original_commit_id" : "7c4f8d9956efb7c239665ce6a66eae65ecfd5215",
      "original_line" : 154,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 78,
      "pull_request_review_id" : 1731754235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1394020665/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-15T10:50:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1394020665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\nnode/txreconciliation.cpp:173 AddToSet: Assertion `recon_state.m_local_set.insert(wtxid).second' failed.",
      "created_at" : "2023-11-16T11:43:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1814283859",
      "id" : 1814283859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585sI8ZT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814283859/reactions"
      },
      "updated_at" : "2023-11-16T11:43:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814283859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1397919287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397919287"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Given the docs on `{Pre}RegisterPeer` and the last paragraph on `TryRemovingFromSet`, shouldn't this also advise the caller to make sure the peer is registered?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-17T21:47:02Z",
      "diff_hunk" : "@@ -74,6 +74,22 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether it was added.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1397919287",
      "id" : 1397919287,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585TUo43",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 81,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 8,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397919287/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397919287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399472433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399472433"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: *the* reconciliation set",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T16:39:31Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399472433",
      "id" : 1399472433,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585TakEx",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 160,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 67,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399472433/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399472433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399659166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399659166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is a bit counter-intuitive. If the transaction to be added is already in the set, we will treat this as if it was added when that is actually not the case. \r\n\r\nI guess the reasoning is that there should be no way of adding the same transaction more than once, so `false` is being used to signal failures. However, this seems like a way to potentially shoot ourselves in the foot.\r\n\r\nIf we want to keep the logic as is, I'd suggest that we at least mention this in the functions docs, given it currently reads: \r\n\r\n```\r\n[...]\r\n* Returns whether it was added.\r\n```",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T19:34:47Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      wtxid.ToString(), peer_id, recon_state.m_local_set.size());\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399659166",
      "id" : 1399659166,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585TbRqe",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 177,
      "original_position" : 84,
      "original_start_line" : 173,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 84,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399659166/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 173,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399659166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399699565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399699565"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this being used?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:13:05Z",
      "diff_hunk" : "@@ -77,6 +85,11 @@ class TxReconciliationTracker::Impl\n private:\n     mutable Mutex m_txreconciliation_mutex;\n \n+    /**\n+     * ReconciliationTracker-wide randomness to choose fanout targets for a given txid.\n+     */\n+    const SaltedTxidHasher m_txid_hasher;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399699565",
      "id" : 1399699565,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585Tbbht",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 92,
      "original_position" : 31,
      "original_start_line" : 88,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 31,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399699565/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 88,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399699565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399703593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399703593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm guessing this is supposed to be **integral**\\_part and fractional\\_**part** (?)\r\n\r\nsource: https://en.cppreference.com/w/cpp/numeric/math/modf",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:17:46Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399703593",
      "id" : 1399703593,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585Tbcgp",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 223,
      "original_position" : 49,
      "original_start_line" : 222,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 49,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399703593/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 222,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399703593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399709981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399709981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this need to be the other way around?\r\n\r\nMaybe I'm confused by the name of the variables, but it seems like if `add_extra` is true, then you should do `x+1`",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:22:40Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399709981",
      "id" : 1399709981,
      "line" : 226,
      "node_id" : "PRRC_kwDOABII585TbeEd",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 226,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399709981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399709981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399729409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399729409"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The TODOs for the pubic fields referring to `m_we_initiate` and `m_k0` should be fixable at this point, given they are both used by `GetFanoutTargets`, shouldn't they?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:44:40Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399729409",
      "id" : 1399729409,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585Tbi0B",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 1,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399729409/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399729409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399750369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399750369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: also, `tagets_size` may be a better name, in lieu of `limit` which is already being used, given this does not really refer to the `targets` themselves, but to the size of the returned `targets` collection",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T21:10:28Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399750369",
      "id" : 1399750369,
      "in_reply_to_id" : 1399709981,
      "line" : 226,
      "node_id" : "PRRC_kwDOABII585Tbn7h",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 226,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399750369/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399750369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399769486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399769486"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Where does this value come from? If we are going to use an arbitrary number, shouldn't we at least make it constant and add some reasoning? ",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T21:33:50Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399769486",
      "id" : 1399769486,
      "line" : 286,
      "node_id" : "PRRC_kwDOABII585TbsmO",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 286,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 112,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399769486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399769486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399810614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399810614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't we move this a bit down the method given it may not even be used if we return early? (such as is the destinations are too small)",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T22:07:24Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399810614",
      "id" : 1399810614,
      "line" : 259,
      "node_id" : "PRRC_kwDOABII585Tb2o2",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 259,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 85,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399810614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399810614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400824727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400824727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "no, I don't know a better approach, but thanks for the explanation!",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T16:02:07Z",
      "diff_hunk" : "@@ -5752,9 +5759,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400824727",
      "id" : 1400824727,
      "in_reply_to_id" : 1379299664,
      "line" : 5761,
      "node_id" : "PRRC_kwDOABII585TfuOX",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 5761,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 1742389495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400824727/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T18:33:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400824727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400838979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400838979"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Isn't `reconciles_txs` only used within `fSendTrickle == true`? Wouldn't it be worth moving it to that context?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T16:11:52Z",
      "diff_hunk" : "@@ -5751,9 +5758,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.\n+                LOCK2(m_mempool.cs, m_peer_mutex);\n                 LOCK(tx_relay->m_tx_inventory_mutex);\n                 // Check whether periodic sends should happen\n                 bool fSendTrickle = pto->HasPermission(NetPermissionFlags::NoBan);\n+                const bool reconciles_txs = m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400838979",
      "id" : 1400838979,
      "line" : 5766,
      "node_id" : "PRRC_kwDOABII585TfxtD",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5766,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 37,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400838979/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400838979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400876966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400876966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could this use the `Wtxid` type?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T16:39:52Z",
      "diff_hunk" : "@@ -74,6 +74,22 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether it was added.\n+     */\n+    bool AddToSet(NodeId peer_id, const uint256& wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400876966",
      "id" : 1400876966,
      "line" : 82,
      "node_id" : "PRRC_kwDOABII585Tf6-m",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 82,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 9,
      "pull_request_review_id" : 1742493305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400876966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T16:39:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400876966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401009634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401009634"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The test fails in debug mode because this assume conflicts with the test saying \"Adding a duplicate transaction should not happen, but it does happen, nothing should break.\".",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T18:32:58Z",
      "diff_hunk" : "@@ -125,6 +137,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401009634",
      "id" : 1401009634,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585TgbXi",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 160,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 80,
      "pull_request_review_id" : 1742389495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401009634/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T18:33:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401009634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401014445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401014445"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Although this reduced it, I think the situation where the child is fanouted ahead could still happen if we receive the parent first, add it to the recon set, and only after that receive the child and decide to fanout it.\r\nNot sure if that is a problem though.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T18:37:33Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401014445",
      "id" : 1401014445,
      "line" : 5891,
      "node_id" : "PRRC_kwDOABII585Tgcit",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5891,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1742817892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401014445/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T18:37:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401014445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401081104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401081104"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder why are we using `std::count` here when we will find, at most, a single instance of `peer_id` within `fanout_candidates`. Wouldn't `std::find` be a better option?\r\n\r\nOn the same line, it may even be worth making `GetFanoutTargets` return a set instead of a vector, given we are sure that the elements of the collection won't be repeated ",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T19:38:41Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {\n+            return false;\n+        }\n+\n+        auto fanout_candidates = GetFanoutTargets(deterministic_randomizer, recon_state.m_we_initiate, destinations);\n+        return std::count(fanout_candidates.begin(), fanout_candidates.end(), peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401081104",
      "id" : 1401081104,
      "line" : 291,
      "node_id" : "PRRC_kwDOABII585Tgs0Q",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 291,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 199,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401081104/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401081104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401091147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401091147"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is the assumption that we will never call this method more than once for the same `wtxid`? I wonder because it feels like the results may be deterministic based on the ordering of the `m_states`, which may not be persistent if a peer changes (?)",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T19:48:01Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401091147",
      "id" : 1401091147,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII585TgvRL",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 220,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 128,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401091147/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 217,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401091147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401116371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401116371"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Either that, or seed it outside the method so you don't even need to pass the `wtxid` in, is writing to the randomizer is cheap enough.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T20:11:28Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401116371",
      "id" : 1401116371,
      "in_reply_to_id" : 1399810614,
      "line" : 259,
      "node_id" : "PRRC_kwDOABII585Tg1bT",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 259,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 85,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401116371/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401116371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401146680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401146680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you give more context regarding this?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T20:39:28Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401146680",
      "id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585Tg804",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401146680/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401146680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1402993598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1402993598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm going to drop this test, unless you know a way how to handle this better.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:32:26Z",
      "diff_hunk" : "@@ -125,6 +137,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1402993598",
      "id" : 1402993598,
      "in_reply_to_id" : 1401009634,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585Tn_u-",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 160,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 80,
      "pull_request_review_id" : 1745827471,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1402993598/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:32:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1402993598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403006667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403006667"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right.\r\n\r\nMy fear with this is unexpected behavior for tx sender: e.g., you craft a \"package\" thinking parent always goes ahead, but then child gets ahead (potentially with the attacker's help) and dropped on the floor due to some policy. Something along this, but maybe I'm making it up.\r\nAre these concerns at least semi-valid? @glozow\r\n\r\nI can add \"see whether a parent is in the set already\" check, when looking at a child, if we think it's worth it.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:49:12Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403006667",
      "id" : 1403006667,
      "in_reply_to_id" : 1401014445,
      "line" : 5891,
      "node_id" : "PRRC_kwDOABII585ToC7L",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5891,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1745848167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403006667/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:49:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403006667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403013326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403013326"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think i'd rather drop it from `TryRemovingFromSet`. It's not that strong anymore anyway, doesn't help much and pretty obvious i think. Let me know if you think differently.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:57:24Z",
      "diff_hunk" : "@@ -74,6 +74,22 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether it was added.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403013326",
      "id" : 1403013326,
      "in_reply_to_id" : 1397919287,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585ToEjO",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 81,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 8,
      "pull_request_review_id" : 1745858364,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403013326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:57:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403013326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403014150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403014150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "took this, but generally i think we have these mistakes all over the code and it's fine :)",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:58:26Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403014150",
      "id" : 1403014150,
      "in_reply_to_id" : 1399472433,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585ToEwG",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 160,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 67,
      "pull_request_review_id" : 1745859712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403014150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:58:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403014150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018216"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right, i shall think how to make it better.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T08:03:46Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      wtxid.ToString(), peer_id, recon_state.m_local_set.size());\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018216",
      "id" : 1403018216,
      "in_reply_to_id" : 1399659166,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585ToFvo",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 177,
      "original_position" : 84,
      "original_start_line" : 173,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 84,
      "pull_request_review_id" : 1745866672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018216/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 173,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T08:03:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "no, it's legacy i guess. wondering why the compiler haven't found it.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T08:04:24Z",
      "diff_hunk" : "@@ -77,6 +85,11 @@ class TxReconciliationTracker::Impl\n private:\n     mutable Mutex m_txreconciliation_mutex;\n \n+    /**\n+     * ReconciliationTracker-wide randomness to choose fanout targets for a given txid.\n+     */\n+    const SaltedTxidHasher m_txid_hasher;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018671",
      "id" : 1403018671,
      "in_reply_to_id" : 1399699565,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585ToF2v",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 92,
      "original_position" : 31,
      "original_start_line" : 88,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 31,
      "pull_request_review_id" : 1745867492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018671/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 88,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T08:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403019080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403019080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "i think it's from the latter commits. can be dropped here.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T08:04:52Z",
      "diff_hunk" : "@@ -77,6 +85,11 @@ class TxReconciliationTracker::Impl\n private:\n     mutable Mutex m_txreconciliation_mutex;\n \n+    /**\n+     * ReconciliationTracker-wide randomness to choose fanout targets for a given txid.\n+     */\n+    const SaltedTxidHasher m_txid_hasher;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403019080",
      "id" : 1403019080,
      "in_reply_to_id" : 1399699565,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585ToF9I",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 92,
      "original_position" : 31,
      "original_start_line" : 88,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 31,
      "pull_request_review_id" : 1745868104,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403019080/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 88,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T08:04:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403019080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403197577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403197577"
         }
      },
      "author_association" : "MEMBER",
      "body" : "flipped the `<` and flipped the ternary conditions. The behavior remains the same. Indeed, it was double-upside-down before.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:36:46Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403197577",
      "id" : 1403197577,
      "in_reply_to_id" : 1399709981,
      "line" : 226,
      "node_id" : "PRRC_kwDOABII585ToxiJ",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 226,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1746162764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403197577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T10:36:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403197577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403205396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403205396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this stuff remained from the legacy code where its use was encapsulated.... just deleting the comments.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:44:06Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403205396",
      "id" : 1403205396,
      "in_reply_to_id" : 1399729409,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585TozcU",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 1,
      "pull_request_review_id" : 1746175005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403205396/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-11-23T10:44:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403205396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403207296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403207296"
         }
      },
      "author_association" : "MEMBER",
      "body" : "eh, it's just a workaround to handle almost-0-fractional-value C++ thing i guess. Might as well be 0.0001 or 0.000000001. Not sure how to make it beautiful.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:45:57Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403207296",
      "id" : 1403207296,
      "in_reply_to_id" : 1399769486,
      "line" : 286,
      "node_id" : "PRRC_kwDOABII585Toz6A",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 286,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 112,
      "pull_request_review_id" : 1746178118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403207296/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T10:45:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403207296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403216806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403216806"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it will have to be moved in the following PR, but yeah, I'll stick to your suggestion in this one.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:54:46Z",
      "diff_hunk" : "@@ -5751,9 +5758,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.\n+                LOCK2(m_mempool.cs, m_peer_mutex);\n                 LOCK(tx_relay->m_tx_inventory_mutex);\n                 // Check whether periodic sends should happen\n                 bool fSendTrickle = pto->HasPermission(NetPermissionFlags::NoBan);\n+                const bool reconciles_txs = m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403216806",
      "id" : 1403216806,
      "in_reply_to_id" : 1400838979,
      "line" : 5766,
      "node_id" : "PRRC_kwDOABII585To2Om",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5766,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 37,
      "pull_request_review_id" : 1746193064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403216806/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T10:54:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403216806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403256259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403256259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We call this for every peer. So there might be, say, 8 calls for the same `wtxid`. The risk of changing `m_states` i thought is acceptable, it's a rare event (outbound peers) and hard to exploit in a meaningful way.  But I'm open to more analysis.",
      "commit_id" : "94e6ea6fb8d81ccadb3bafbbf40596c7937e1e32",
      "created_at" : "2023-11-23T11:32:52Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403256259",
      "id" : 1403256259,
      "in_reply_to_id" : 1401091147,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585To_3D",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 209,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 133,
      "pull_request_review_id" : 1746254164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403256259/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 206,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T11:32:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403256259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403265334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, what exactly?\r\n\r\nhere I talk about an alternative way to implement this.\r\nSay, we want to add a child to the set, because the parent is already there, and we don't want child ahead of parent. But the set is full. We can't ignore the limit âÂ that's (a). (b) means that we could fanout child+parent in this case, but this `remove parent from set` operation is harder to reason about. Should we then remove parents of a parent too?\r\n\r\nMaybe I overthink this issue.",
      "commit_id" : "94e6ea6fb8d81ccadb3bafbbf40596c7937e1e32",
      "created_at" : "2023-11-23T11:42:22Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403265334",
      "id" : 1403265334,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585TpCE2",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1746268353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T11:42:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1404092298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404092298"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Improved the documentation around it a bit.",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-24T08:53:16Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      wtxid.ToString(), peer_id, recon_state.m_local_set.size());\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1404092298",
      "id" : 1404092298,
      "in_reply_to_id" : 1399659166,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585TsL-K",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 170,
      "original_position" : 84,
      "original_start_line" : 173,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1747541696,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404092298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-24T08:53:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404092298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed the comments, mostly refactoring. Some conversations pending above. The code is good for review.",
      "created_at" : "2023-11-24T08:53:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1825334360",
      "id" : 1825334360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585szGRY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1825334360/reactions"
      },
      "updated_at" : "2023-11-24T08:53:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1825334360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406343895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406343895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, got you. I guess we can also ask this the other way around to see if there is a cleaner workaround. In what case is `destinations` smaller than 1 but we still want to pass it to `GetFanoutTargets`?",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-27T15:33:31Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406343895",
      "id" : 1406343895,
      "in_reply_to_id" : 1399769486,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585T0xrX",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 276,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 200,
      "pull_request_review_id" : 1750735506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406343895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-27T15:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406343895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406355079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406355079"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was referring to b). So this is trying to prevent a situation in which, potentially, the whole set is a cluster and once we are full, a new transaction belonging to the cluster is tried to be added, triggering a cascade removal and making us waste resources?",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-27T15:39:22Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406355079",
      "id" : 1406355079,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585T00aH",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1750748050,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406355079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-27T15:39:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406355079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411316794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411316794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not just make a copy of the seeded randomizer instead of accumulating to it all the changes from `m_states`? That way you ensure that a change in the ordering is not going to, potentially, produce a completely different order of the whole `best_peers` set. In this case, the worst that could happen would be that the newly added peer jumps places, and becomes one of the selected/not selected peers, instead of a complete rearrange of the collection",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-30T21:58:29Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411316794",
      "id" : 1411316794,
      "in_reply_to_id" : 1401091147,
      "line" : 213,
      "node_id" : "PRRC_kwDOABII585UHvw6",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 213,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 137,
      "pull_request_review_id" : 1758534171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411316794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 210,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-30T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411316794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411756962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411756962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Say we have 5 inbound Erlay peers and 0 inbound legacy peers.\r\n`inbound_targets = (5+0) * 0.1 = 0.5`\r\n`destinations = 0.5 - 0 = 0.5`\r\n\r\nIt just means that we will take 1 inbound peer for fanout with a 50% chance.\r\n\r\nI guess it will work just fine if i drop the `0.01` (1% or less chance) check. It's kinda unfortunate we have to do the compute if chance is that small. Fine with me either way, let me know what you think.",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T08:17:47Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411756962",
      "id" : 1411756962,
      "in_reply_to_id" : 1399769486,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585UJbOi",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 276,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 200,
      "pull_request_review_id" : 1759247791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411756962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-01T08:17:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411756962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411776086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411776086"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T08:35:52Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411776086",
      "id" : 1411776086,
      "in_reply_to_id" : 1401091147,
      "line" : 213,
      "node_id" : "PRRC_kwDOABII585UJf5W",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 213,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 137,
      "pull_request_review_id" : 1759276774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411776086/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 210,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-01T08:35:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411776086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411780306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411780306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. My primary concern is the complexity though. Cascade removal is more difficult to reason about. I just thought it was not worth it.",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T08:40:27Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411780306",
      "id" : 1411780306,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585UJg7S",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1759283425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411780306/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-01T08:40:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411780306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412243707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412243707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just adding a comment with some context, saying that for chances lower than 1% it may not be worth the computation may be fine. It just struck me as weird where that value came from.",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T15:24:11Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412243707",
      "id" : 1412243707,
      "in_reply_to_id" : 1399769486,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585ULSD7",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 276,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 200,
      "pull_request_review_id" : 1760033220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412243707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-01T15:24:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412243707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412244443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412244443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fair",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T15:24:53Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412244443",
      "id" : 1412244443,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585ULSPb",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1760034404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412244443/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-01T15:24:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412244443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   }
]
