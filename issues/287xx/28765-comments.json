[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28765).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [brunoerg](https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1790706698) |\n| Stale ACK | [sr-gi](https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1845736014), [mzumsande](https://github.com/bitcoin/bitcoin/pull/28765#pullrequestreview-1778050698) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28031](https://github.com/bitcoin/bitcoin/pull/28031) (Package Relay 1/3: Introduce TxDownloadManager and improve orphan-handling by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-11-01T09:06:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1788632672",
      "id" : 1788632672,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585qnF5g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1788632672/reactions"
      },
      "updated_at" : "2023-12-18T23:30:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1788632672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379299664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379299664"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could you explain a bit more why this is necessary, what is the lock order that would get violated if we did the locking later (just here, not necessarily in the comment)?",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-01T20:27:58Z",
      "diff_hunk" : "@@ -5752,9 +5759,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379299664",
      "id" : 1379299664,
      "line" : 5762,
      "node_id" : "PRRC_kwDOABII585SNnFQ",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 5762,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379299664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T21:45:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379299664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306577"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: remove one `//`",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:35:43Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.\n+    for (int i = 1; i < 31; ++i) {\n+        tracker.PreRegisterPeer(i);\n+        BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+\n+    }\n+\n+    // Relay to a fraction of registered inbound peers.\n+    for (int j = 0; j < 100; ++j) {\n+        size_t total_fanouted = 0;\n+        auto wtxid = GetRandHash();\n+        for (int i = 1; i < 31; ++i) {\n+            total_fanouted += tracker.ShouldFanoutTo(wtxid, hasher, i,\n+                                               /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0);\n+        }\n+        BOOST_CHECK_EQUAL(total_fanouted, 3);\n+    }\n+\n+    // // Don't relay if there is sufficient non-reconciling peers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306577",
      "id" : 1379306577,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII585SNoxR",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 144,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 64,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306928"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306928"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder if this algorithm (which took me a while to fully understand) could be simpler. \r\nE.g., if we used a sorted container for `best_peers` instead of a vector, inserted all of the peers, and then finally return the first `targets` elements of that container, I think we could do without the `try_fanout_candidate` lambda.\r\nOr would that be incorrect / less performant?\r\n\r\nI'm thinking of something like the following (just to show idea, I didn't test it):\r\n\r\n    struct ComparePairs {\r\n        bool operator()(const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) const {\r\n            return left.first > right.first;\r\n        }\r\n    };\r\n    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\r\n                                         bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\r\n    {\r\n        // The algorithm works as follows. We iterate through the peers (of a given direction)\r\n        // hashing them with the given wtxid, and sort them by this hash.\r\n        // We then consider top `limit` peers to be low-fanout flood targets.\r\n        // The randomness should be seeded with wtxid to return consistent results for every call.\r\n\r\n        double integer_part;\r\n        double fractional_peer = std::modf(limit, &integer_part);\r\n        const bool drop_peer_if_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\r\n        const size_t targets = drop_peer_if_extra ? size_t(integer_part): size_t(integer_part) + 1;\r\n\r\n        std::set<std::pair<uint64_t, NodeId>, ComparePairs> best_peers;\r\n\r\n        for (auto indexed_state : m_states) {\r\n            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\r\n            if (cur_state && cur_state->m_we_initiate == we_initiate) {\r\n                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\r\n                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\r\n            }\r\n        }\r\n\r\n        std::vector<NodeId> result;\r\n        auto it = best_peers.begin();\r\n        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\r\n            result.push_back(it->second);\r\n        }\r\n        return result;\r\n    }",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:36:07Z",
      "diff_hunk" : "@@ -193,6 +210,104 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379306928",
      "id" : 1379306928,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585SNo2w",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 214,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 44,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306928/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379306928",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379309905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379309905"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do we have to first add and then (maybe) drop a peer here (instead of determining how many peers we want at the beginning, and then getting as many peers as we can up the desired number).",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:39:46Z",
      "diff_hunk" : "@@ -193,6 +210,104 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                         bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // To handle fractional values, we add one peer optimistically and then probabilistically\n+        // drop it later.\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        const size_t targets = size_t(integer_part) + 1;\n+        const bool drop_peer_if_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379309905",
      "id" : 1379309905,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII585SNplR",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 227,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 57,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379309905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379309905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379312851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379312851"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "10% of 30 is integer, so maybe also add an example with a fraction. If we run it  often enough, we could probably assert that two values for `total_fanouted` are possible.",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:43:10Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379312851",
      "id" : 1379312851,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII585SNqTT",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 126,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 46,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379312851/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379312851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379313360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379313360"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: remove empty line",
      "commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "created_at" : "2023-11-01T20:43:47Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.\n+    for (int i = 1; i < 31; ++i) {\n+        tracker.PreRegisterPeer(i);\n+        BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379313360",
      "id" : 1379313360,
      "line" : 130,
      "node_id" : "PRRC_kwDOABII585SNqbQ",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 130,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 50,
      "pull_request_review_id" : 1709034021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379313360/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-01T20:45:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379313360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379714659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379714659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried a whole bunch of combinations. Say, you move the `LOCK(m_peer_mutex);` to L5831, where `m_peer_map` is used.\r\n\r\nThen you get something [like this](https://cirrus-ci.com/task/6561881997967360?logs=ci#L3228) in Cirrus (not exactly!).\r\n\r\n```\r\n node0 2023-08-17T12:01:53.647510Z [msghand] [sync.cpp:97] [potential_deadlock_detected] POTENTIAL DEADLOCK DETECTED \r\n node0 2023-08-17T12:01:53.647516Z [msghand] [sync.cpp:98] [potential_deadlock_detected] Previous lock order was: \r\n node0 2023-08-17T12:01:53.647523Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'NetEventsInterface::g_msgproc_mutex' in net.cpp:2095 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647531Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'cs_main' in net_processing.cpp:5473 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647574Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  (2) 'm_peer_mutex' in net_processing.cpp:5686 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647581Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'tx_relay->m_tx_inventory_mutex' in net_processing.cpp:5688 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647587Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  'tx_relay->m_bloom_filter_mutex' in net_processing.cpp:5768 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647593Z [msghand] [sync.cpp:107] [potential_deadlock_detected]  (1) 'm_mempool.cs' in net_processing.cpp:5850 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647598Z [msghand] [sync.cpp:111] [potential_deadlock_detected] Current lock order is: \r\n node0 2023-08-17T12:01:53.647604Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'NetEventsInterface::g_msgproc_mutex' in net.cpp:2095 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647610Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'm_chainstate_mutex' in validation.cpp:3102 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647616Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'cs_main' in validation.cpp:3124 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647622Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  (1) 'MempoolMutex()' in validation.cpp:3126 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647627Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  'cs_main' in net_processing.cpp:2013 (in thread 'msghand') \r\n node0 2023-08-17T12:01:53.647633Z [msghand] [sync.cpp:122] [potential_deadlock_detected]  (2) 'm_peer_mutex' in net_processing.cpp:1593 (in thread 'msghand') \r\n```\r\n\r\nFrom this log you see that `m_peer_mutex` should go before `m_mempool.cs`. I admit it might be not the 100% optimal placement, feels NP-hard to me :) Do you know how to approach this better?",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T07:58:03Z",
      "diff_hunk" : "@@ -5752,9 +5759,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379714659",
      "id" : 1379714659,
      "in_reply_to_id" : 1379299664,
      "line" : 5762,
      "node_id" : "PRRC_kwDOABII585SPMZj",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 5762,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 1709638838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379714659/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T07:58:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379714659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379723181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379723181"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is certainly better. For no good reason, i just chose to follow a pattern we use elsewhere and never reconsidered it. I will take this code.",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T08:06:46Z",
      "diff_hunk" : "@@ -193,6 +210,104 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379723181",
      "id" : 1379723181,
      "in_reply_to_id" : 1379306928,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585SPOet",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 214,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 122,
      "pull_request_review_id" : 1709653011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379723181/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T08:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379723181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379749369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379749369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm always not sure what to do with these kinds of probabilistic scenarios... Say you run 1000 experiments, and get 1000/0, so the assert fails. Is 1,000,000 sufficient in that case? Or how do you think this should be asserted otherwise.",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T08:32:01Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1379749369",
      "id" : 1379749369,
      "in_reply_to_id" : 1379312851,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII585SPU35",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 126,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 46,
      "pull_request_review_id" : 1709693742,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379749369/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T08:32:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1379749369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-11-02T13:16:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1790706698",
      "id" : 1790706698,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585qvAQK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1790706698/reactions"
      },
      "updated_at" : "2023-11-02T13:16:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1790706698",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380105208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380105208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 983f8c6e305fd9707c109c2a92637825262b9b09: Since `fanout` is already initialized `true`, couldn't we simplify it?\r\n\r\n```diff\r\n@@ -5878,19 +5878,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\r\n                         if (reconciles_txs) {\r\n                             auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\r\n                             if (txiter) {\r\n-                                if ((*txiter)->GetCountWithDescendants() > 1) {\r\n-                                    // If a transaction has in-mempool children, always fanout it.\r\n-                                    // Until package relay is implemented, this is needed to avoid\r\n-                                    // breaking parent+child relay expectations in some cases.\r\n-                                    //\r\n-                                    // Potentially reconciling parent+child would mean that for every\r\n-                                    // child we need to to check if any of the parents is currently\r\n-                                    // reconciled so that the child isn't fanouted ahead. But then\r\n-                                    // it gets tricky when reconciliation sets are full: a) the child\r\n-                                    // can't just be added; b) removing parents from reconciliation\r\n-                                    // sets for this one child is not good either.\r\n-                                    fanout = true;\r\n-                                } else {\r\n+                                // If a transaction has in-mempool children, always fanout it.\r\n+                                // Until package relay is implemented, this is needed to avoid\r\n+                                // breaking parent+child relay expectations in some cases.\r\n+                                //\r\n+                                // Potentially reconciling parent+child would mean that for every\r\n+                                // child we need to to check if any of the parents is currently\r\n+                                // reconciled so that the child isn't fanouted ahead. But then\r\n+                                // it gets tricky when reconciliation sets are full: a) the child\r\n+                                // can't just be added; b) removing parents from reconciliation\r\n+                                // sets for this one child is not good either.\r\n+                                if ((*txiter)->GetCountWithDescendants() <= 1) {\r\n                                     auto fanout_randomizer = m_connman.GetDeterministicRandomizer(RANDOMIZER_ID_FANOUTTARGET);\r\n                                     fanout = m_txreconciliat\r\nion->ShouldFanoutTo(wtxid, fanout_randomizer, pto->GetId(),\r\n                                                             \r\n                    inbounds_nonrcncl_tx_relay, outbounds_non\r\nrcncl_tx_relay);\r\n```",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T13:28:33Z",
      "diff_hunk" : "@@ -5841,7 +5873,35 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                if ((*txiter)->GetCountWithDescendants() > 1) {\n+                                    // If a transaction has in-mempool children, always fanout it.\n+                                    // Until package relay is implemented, this is needed to avoid\n+                                    // breaking parent+child relay expectations in some cases.\n+                                    //\n+                                    // Potentially reconciling parent+child would mean that for every\n+                                    // child we need to to check if any of the parents is currently\n+                                    // reconciled so that the child isn't fanouted ahead. But then\n+                                    // it gets tricky when reconciliation sets are full: a) the child\n+                                    // can't just be added; b) removing parents from reconciliation\n+                                    // sets for this one child is not good either.\n+                                    fanout = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380105208",
      "id" : 1380105208,
      "line" : 5892,
      "node_id" : "PRRC_kwDOABII585SQrv4",
      "original_commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "original_line" : 5892,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 91,
      "pull_request_review_id" : 1710245379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380105208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T13:28:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380105208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380216381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380216381"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 983f8c6e305fd9707c109c2a92637825262b9b09: Correct me if I'm wrong, but we're going use `inbounds_nonrcncl_tx_relay` and `outbounds_nonrcncl_tx_relay` only whether `reconciles_txs` is true, couldn't we only fill them if so?:\r\n```suggestion\r\n                    if (reconciles_txs) {\r\n```",
      "commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "created_at" : "2023-11-02T14:16:01Z",
      "diff_hunk" : "@@ -5814,6 +5824,28 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n+\n+                    size_t inbounds_nonrcncl_tx_relay = 0, outbounds_nonrcncl_tx_relay = 0;\n+                    if (m_txreconciliation) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1380216381",
      "id" : 1380216381,
      "line" : 5829,
      "node_id" : "PRRC_kwDOABII585SRG49",
      "original_commit_id" : "983f8c6e305fd9707c109c2a92637825262b9b09",
      "original_line" : 5829,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 47,
      "pull_request_review_id" : 1710413774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380216381/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-02T14:16:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1380216381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think a test can be added to exercise `AddToSet` and the check of the boundary `MAX_SET_SIZE` value.",
      "commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "created_at" : "2023-11-12T18:51:21Z",
      "diff_hunk" : "@@ -81,4 +81,75 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462533",
      "id" : 1390462533,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII585S4MZF",
      "original_commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "original_line" : 84,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1726306685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462533/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-12T18:54:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462790"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think can be `>` only. Generally sounds maximum in net_processing is understood as strictly superior, e.g `MAX_INV_SZ` usage.",
      "commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "created_at" : "2023-11-12T18:53:48Z",
      "diff_hunk" : "@@ -125,6 +133,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1390462790",
      "id" : 1390462790,
      "line" : 171,
      "node_id" : "PRRC_kwDOABII585S4MdG",
      "original_commit_id" : "7c4f8d9956efb7c239665ce6a66eae65ecfd5215",
      "original_line" : 154,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 78,
      "pull_request_review_id" : 1726306685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462790/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-12T18:54:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390462790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1394020665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1394020665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This happens before the addition. Your suggestion would mean that the size could be 3001, which is not desired.",
      "commit_id" : "2af4d12410aebce6b806a101d797357a49d6852b",
      "created_at" : "2023-11-15T10:50:38Z",
      "diff_hunk" : "@@ -125,6 +133,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1394020665",
      "id" : 1394020665,
      "in_reply_to_id" : 1390462790,
      "line" : 171,
      "node_id" : "PRRC_kwDOABII585TFxE5",
      "original_commit_id" : "7c4f8d9956efb7c239665ce6a66eae65ecfd5215",
      "original_line" : 154,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 78,
      "pull_request_review_id" : 1731754235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1394020665/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-15T10:50:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1394020665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\nnode/txreconciliation.cpp:173 AddToSet: Assertion `recon_state.m_local_set.insert(wtxid).second' failed.",
      "created_at" : "2023-11-16T11:43:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1814283859",
      "id" : 1814283859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585sI8ZT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814283859/reactions"
      },
      "updated_at" : "2023-11-16T11:43:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814283859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1397919287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397919287"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Given the docs on `{Pre}RegisterPeer` and the last paragraph on `TryRemovingFromSet`, shouldn't this also advise the caller to make sure the peer is registered?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-17T21:47:02Z",
      "diff_hunk" : "@@ -74,6 +74,22 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether it was added.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1397919287",
      "id" : 1397919287,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585TUo43",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 81,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 8,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397919287/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397919287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399472433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399472433"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: *the* reconciliation set",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T16:39:31Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399472433",
      "id" : 1399472433,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585TakEx",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 160,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 67,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399472433/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399472433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399659166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399659166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is a bit counter-intuitive. If the transaction to be added is already in the set, we will treat this as if it was added when that is actually not the case. \r\n\r\nI guess the reasoning is that there should be no way of adding the same transaction more than once, so `false` is being used to signal failures. However, this seems like a way to potentially shoot ourselves in the foot.\r\n\r\nIf we want to keep the logic as is, I'd suggest that we at least mention this in the functions docs, given it currently reads: \r\n\r\n```\r\n[...]\r\n* Returns whether it was added.\r\n```",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T19:34:47Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      wtxid.ToString(), peer_id, recon_state.m_local_set.size());\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399659166",
      "id" : 1399659166,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585TbRqe",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 177,
      "original_position" : 84,
      "original_start_line" : 173,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 84,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399659166/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 173,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399659166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399699565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399699565"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this being used?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:13:05Z",
      "diff_hunk" : "@@ -77,6 +85,11 @@ class TxReconciliationTracker::Impl\n private:\n     mutable Mutex m_txreconciliation_mutex;\n \n+    /**\n+     * ReconciliationTracker-wide randomness to choose fanout targets for a given txid.\n+     */\n+    const SaltedTxidHasher m_txid_hasher;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399699565",
      "id" : 1399699565,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585Tbbht",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 92,
      "original_position" : 31,
      "original_start_line" : 88,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 31,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399699565/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 88,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399699565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399703593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399703593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm guessing this is supposed to be **integral**\\_part and fractional\\_**part** (?)\r\n\r\nsource: https://en.cppreference.com/w/cpp/numeric/math/modf",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:17:46Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399703593",
      "id" : 1399703593,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585Tbcgp",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 223,
      "original_position" : 49,
      "original_start_line" : 222,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 49,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399703593/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 222,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399703593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399709981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399709981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this need to be the other way around?\r\n\r\nMaybe I'm confused by the name of the variables, but it seems like if `add_extra` is true, then you should do `x+1`",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:22:40Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399709981",
      "id" : 1399709981,
      "line" : 226,
      "node_id" : "PRRC_kwDOABII585TbeEd",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 226,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399709981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399709981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399729409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399729409"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The TODOs for the pubic fields referring to `m_we_initiate` and `m_k0` should be fixable at this point, given they are both used by `GetFanoutTargets`, shouldn't they?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T20:44:40Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399729409",
      "id" : 1399729409,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585Tbi0B",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 1,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399729409/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399729409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399750369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399750369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: also, `tagets_size` may be a better name, in lieu of `limit` which is already being used, given this does not really refer to the `targets` themselves, but to the size of the returned `targets` collection",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T21:10:28Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399750369",
      "id" : 1399750369,
      "in_reply_to_id" : 1399709981,
      "line" : 226,
      "node_id" : "PRRC_kwDOABII585Tbn7h",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 226,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399750369/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399750369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399769486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399769486"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Where does this value come from? If we are going to use an arbitrary number, shouldn't we at least make it constant and add some reasoning? ",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T21:33:50Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399769486",
      "id" : 1399769486,
      "line" : 286,
      "node_id" : "PRRC_kwDOABII585TbsmO",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 286,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 112,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399769486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399769486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399810614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399810614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't we move this a bit down the method given it may not even be used if we return early? (such as is the destinations are too small)",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-20T22:07:24Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1399810614",
      "id" : 1399810614,
      "line" : 259,
      "node_id" : "PRRC_kwDOABII585Tb2o2",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 259,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 85,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399810614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1399810614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400824727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400824727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "no, I don't know a better approach, but thanks for the explanation!",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T16:02:07Z",
      "diff_hunk" : "@@ -5752,9 +5759,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400824727",
      "id" : 1400824727,
      "in_reply_to_id" : 1379299664,
      "line" : 5761,
      "node_id" : "PRRC_kwDOABII585TfuOX",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 5761,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 1742389495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400824727/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T18:33:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400824727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400838979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400838979"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Isn't `reconciles_txs` only used within `fSendTrickle == true`? Wouldn't it be worth moving it to that context?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T16:11:52Z",
      "diff_hunk" : "@@ -5751,9 +5758,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.\n+                LOCK2(m_mempool.cs, m_peer_mutex);\n                 LOCK(tx_relay->m_tx_inventory_mutex);\n                 // Check whether periodic sends should happen\n                 bool fSendTrickle = pto->HasPermission(NetPermissionFlags::NoBan);\n+                const bool reconciles_txs = m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400838979",
      "id" : 1400838979,
      "line" : 5766,
      "node_id" : "PRRC_kwDOABII585TfxtD",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5766,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 37,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400838979/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400838979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400876966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400876966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could this use the `Wtxid` type?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T16:39:52Z",
      "diff_hunk" : "@@ -74,6 +74,22 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether it was added.\n+     */\n+    bool AddToSet(NodeId peer_id, const uint256& wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1400876966",
      "id" : 1400876966,
      "line" : 82,
      "node_id" : "PRRC_kwDOABII585Tf6-m",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 82,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 9,
      "pull_request_review_id" : 1742493305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400876966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T16:39:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1400876966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401009634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401009634"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The test fails in debug mode because this assume conflicts with the test saying \"Adding a duplicate transaction should not happen, but it does happen, nothing should break.\".",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T18:32:58Z",
      "diff_hunk" : "@@ -125,6 +137,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401009634",
      "id" : 1401009634,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585TgbXi",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 160,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 80,
      "pull_request_review_id" : 1742389495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401009634/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T18:33:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401009634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401014445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401014445"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Although this reduced it, I think the situation where the child is fanouted ahead could still happen if we receive the parent first, add it to the recon set, and only after that receive the child and decide to fanout it.\r\nNot sure if that is a problem though.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T18:37:33Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401014445",
      "id" : 1401014445,
      "line" : 5891,
      "node_id" : "PRRC_kwDOABII585Tgcit",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5891,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1742817892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401014445/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T18:37:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401014445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401081104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401081104"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder why are we using `std::count` here when we will find, at most, a single instance of `peer_id` within `fanout_candidates`. Wouldn't `std::find` be a better option?\r\n\r\nOn the same line, it may even be worth making `GetFanoutTargets` return a set instead of a vector, given we are sure that the elements of the collection won't be repeated ",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T19:38:41Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {\n+            return false;\n+        }\n+\n+        auto fanout_candidates = GetFanoutTargets(deterministic_randomizer, recon_state.m_we_initiate, destinations);\n+        return std::count(fanout_candidates.begin(), fanout_candidates.end(), peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401081104",
      "id" : 1401081104,
      "line" : 291,
      "node_id" : "PRRC_kwDOABII585Tgs0Q",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 291,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 199,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401081104/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401081104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401091147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401091147"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is the assumption that we will never call this method more than once for the same `wtxid`? I wonder because it feels like the results may be deterministic based on the ordering of the `m_states`, which may not be persistent if a peer changes (?)",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T19:48:01Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401091147",
      "id" : 1401091147,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII585TgvRL",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 220,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 128,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401091147/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 217,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401091147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401116371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401116371"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Either that, or seed it outside the method so you don't even need to pass the `wtxid` in, is writing to the randomizer is cheap enough.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T20:11:28Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401116371",
      "id" : 1401116371,
      "in_reply_to_id" : 1399810614,
      "line" : 259,
      "node_id" : "PRRC_kwDOABII585Tg1bT",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 259,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 85,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401116371/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401116371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401146680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401146680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you give more context regarding this?",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-21T20:39:28Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401146680",
      "id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585Tg804",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 1737983905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401146680/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-21T21:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1401146680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1402993598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1402993598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm going to drop this test, unless you know a way how to handle this better.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:32:26Z",
      "diff_hunk" : "@@ -125,6 +137,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1402993598",
      "id" : 1402993598,
      "in_reply_to_id" : 1401009634,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585Tn_u-",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 160,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 80,
      "pull_request_review_id" : 1745827471,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1402993598/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:32:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1402993598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403006667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403006667"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right.\r\n\r\nMy fear with this is unexpected behavior for tx sender: e.g., you craft a \"package\" thinking parent always goes ahead, but then child gets ahead (potentially with the attacker's help) and dropped on the floor due to some policy. Something along this, but maybe I'm making it up.\r\nAre these concerns at least semi-valid? @glozow\r\n\r\nI can add \"see whether a parent is in the set already\" check, when looking at a child, if we think it's worth it.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:49:12Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403006667",
      "id" : 1403006667,
      "in_reply_to_id" : 1401014445,
      "line" : 5891,
      "node_id" : "PRRC_kwDOABII585ToC7L",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5891,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1745848167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403006667/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:49:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403006667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403013326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403013326"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think i'd rather drop it from `TryRemovingFromSet`. It's not that strong anymore anyway, doesn't help much and pretty obvious i think. Let me know if you think differently.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:57:24Z",
      "diff_hunk" : "@@ -74,6 +74,22 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether it was added.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403013326",
      "id" : 1403013326,
      "in_reply_to_id" : 1397919287,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585ToEjO",
      "original_commit_id" : "6977a5a156db691758779093c7e7b19039331e3a",
      "original_line" : 81,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 8,
      "pull_request_review_id" : 1745858364,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403013326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:57:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403013326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403014150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403014150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "took this, but generally i think we have these mistakes all over the code and it's fine :)",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T07:58:26Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403014150",
      "id" : 1403014150,
      "in_reply_to_id" : 1399472433,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585ToEwG",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 160,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 67,
      "pull_request_review_id" : 1745859712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403014150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T07:58:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403014150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018216"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right, i shall think how to make it better.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T08:03:46Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      wtxid.ToString(), peer_id, recon_state.m_local_set.size());\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018216",
      "id" : 1403018216,
      "in_reply_to_id" : 1399659166,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585ToFvo",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 177,
      "original_position" : 84,
      "original_start_line" : 173,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 84,
      "pull_request_review_id" : 1745866672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018216/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 173,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T08:03:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "no, it's legacy i guess. wondering why the compiler haven't found it.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T08:04:24Z",
      "diff_hunk" : "@@ -77,6 +85,11 @@ class TxReconciliationTracker::Impl\n private:\n     mutable Mutex m_txreconciliation_mutex;\n \n+    /**\n+     * ReconciliationTracker-wide randomness to choose fanout targets for a given txid.\n+     */\n+    const SaltedTxidHasher m_txid_hasher;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403018671",
      "id" : 1403018671,
      "in_reply_to_id" : 1399699565,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585ToF2v",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 92,
      "original_position" : 31,
      "original_start_line" : 88,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 31,
      "pull_request_review_id" : 1745867492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018671/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 88,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T08:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403018671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403019080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403019080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "i think it's from the latter commits. can be dropped here.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T08:04:52Z",
      "diff_hunk" : "@@ -77,6 +85,11 @@ class TxReconciliationTracker::Impl\n private:\n     mutable Mutex m_txreconciliation_mutex;\n \n+    /**\n+     * ReconciliationTracker-wide randomness to choose fanout targets for a given txid.\n+     */\n+    const SaltedTxidHasher m_txid_hasher;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403019080",
      "id" : 1403019080,
      "in_reply_to_id" : 1399699565,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585ToF9I",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 92,
      "original_position" : 31,
      "original_start_line" : 88,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 31,
      "pull_request_review_id" : 1745868104,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403019080/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 88,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T08:04:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403019080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403197577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403197577"
         }
      },
      "author_association" : "MEMBER",
      "body" : "flipped the `<` and flipped the ternary conditions. The behavior remains the same. Indeed, it was double-upside-down before.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:36:46Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403197577",
      "id" : 1403197577,
      "in_reply_to_id" : 1399709981,
      "line" : 226,
      "node_id" : "PRRC_kwDOABII585ToxiJ",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 226,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1746162764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403197577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T10:36:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403197577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403205396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403205396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this stuff remained from the legacy code where its use was encapsulated.... just deleting the comments.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:44:06Z",
      "diff_hunk" : "",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403205396",
      "id" : 1403205396,
      "in_reply_to_id" : 1399729409,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585TozcU",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 1,
      "pull_request_review_id" : 1746175005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403205396/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "file",
      "updated_at" : "2023-11-23T10:44:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403205396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403207296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403207296"
         }
      },
      "author_association" : "MEMBER",
      "body" : "eh, it's just a workaround to handle almost-0-fractional-value C++ thing i guess. Might as well be 0.0001 or 0.000000001. Not sure how to make it beautiful.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:45:57Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403207296",
      "id" : 1403207296,
      "in_reply_to_id" : 1399769486,
      "line" : 286,
      "node_id" : "PRRC_kwDOABII585Toz6A",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 286,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 112,
      "pull_request_review_id" : 1746178118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403207296/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T10:45:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403207296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403216806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403216806"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it will have to be moved in the following PR, but yeah, I'll stick to your suggestion in this one.",
      "commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "created_at" : "2023-11-23T10:54:46Z",
      "diff_hunk" : "@@ -5751,9 +5758,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         }\n \n         if (auto tx_relay = peer->GetTxRelay(); tx_relay != nullptr) {\n+                // Lock way before it's used to maintain lock ordering.\n+                LOCK2(m_mempool.cs, m_peer_mutex);\n                 LOCK(tx_relay->m_tx_inventory_mutex);\n                 // Check whether periodic sends should happen\n                 bool fSendTrickle = pto->HasPermission(NetPermissionFlags::NoBan);\n+                const bool reconciles_txs = m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403216806",
      "id" : 1403216806,
      "in_reply_to_id" : 1400838979,
      "line" : 5766,
      "node_id" : "PRRC_kwDOABII585To2Om",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5766,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 37,
      "pull_request_review_id" : 1746193064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403216806/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T10:54:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403216806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403256259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403256259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We call this for every peer. So there might be, say, 8 calls for the same `wtxid`. The risk of changing `m_states` i thought is acceptable, it's a rare event (outbound peers) and hard to exploit in a meaningful way.  But I'm open to more analysis.",
      "commit_id" : "94e6ea6fb8d81ccadb3bafbbf40596c7937e1e32",
      "created_at" : "2023-11-23T11:32:52Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403256259",
      "id" : 1403256259,
      "in_reply_to_id" : 1401091147,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585To_3D",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 209,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 133,
      "pull_request_review_id" : 1746254164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403256259/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 206,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T11:32:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403256259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403265334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, what exactly?\r\n\r\nhere I talk about an alternative way to implement this.\r\nSay, we want to add a child to the set, because the parent is already there, and we don't want child ahead of parent. But the set is full. We can't ignore the limit âÂ that's (a). (b) means that we could fanout child+parent in this case, but this `remove parent from set` operation is harder to reason about. Should we then remove parents of a parent too?\r\n\r\nMaybe I overthink this issue.",
      "commit_id" : "94e6ea6fb8d81ccadb3bafbbf40596c7937e1e32",
      "created_at" : "2023-11-23T11:42:22Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1403265334",
      "id" : 1403265334,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585TpCE2",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1746268353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-23T11:42:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1404092298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404092298"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Improved the documentation around it a bit.",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-24T08:53:16Z",
      "diff_hunk" : "@@ -125,6 +150,43 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const uint256& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return false;\n+        auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+\n+        // Check if reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (recon_state.m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        Assume(recon_state.m_local_set.insert(wtxid).second);\n+        LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                    \"Now the set contains %i transactions.\\n\",\n+                      wtxid.ToString(), peer_id, recon_state.m_local_set.size());\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1404092298",
      "id" : 1404092298,
      "in_reply_to_id" : 1399659166,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585TsL-K",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 170,
      "original_position" : 84,
      "original_start_line" : 173,
      "path" : "src/node/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1747541696,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404092298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-24T08:53:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1404092298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed the comments, mostly refactoring. Some conversations pending above. The code is good for review.",
      "created_at" : "2023-11-24T08:53:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1825334360",
      "id" : 1825334360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585szGRY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1825334360/reactions"
      },
      "updated_at" : "2023-11-24T08:53:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1825334360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406343895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406343895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, got you. I guess we can also ask this the other way around to see if there is a cleaner workaround. In what case is `destinations` smaller than 1 but we still want to pass it to `GetFanoutTargets`?",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-27T15:33:31Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406343895",
      "id" : 1406343895,
      "in_reply_to_id" : 1399769486,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585T0xrX",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 276,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 200,
      "pull_request_review_id" : 1750735506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406343895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-27T15:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406343895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406355079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406355079"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was referring to b). So this is trying to prevent a situation in which, potentially, the whole set is a cluster and once we are full, a new transaction belonging to the cluster is tried to be added, triggering a cascade removal and making us waste resources?",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-27T15:39:22Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1406355079",
      "id" : 1406355079,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585T00aH",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1750748050,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406355079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-27T15:39:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406355079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411316794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411316794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not just make a copy of the seeded randomizer instead of accumulating to it all the changes from `m_states`? That way you ensure that a change in the ordering is not going to, potentially, produce a completely different order of the whole `best_peers` set. In this case, the worst that could happen would be that the newly added peer jumps places, and becomes one of the selected/not selected peers, instead of a complete rearrange of the collection",
      "commit_id" : "e5018f28b9055836d2f3891865a532a3ebb0b7ca",
      "created_at" : "2023-11-30T21:58:29Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411316794",
      "id" : 1411316794,
      "in_reply_to_id" : 1401091147,
      "line" : 213,
      "node_id" : "PRRC_kwDOABII585UHvw6",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 213,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 137,
      "pull_request_review_id" : 1758534171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411316794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 210,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-30T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411316794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411756962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411756962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Say we have 5 inbound Erlay peers and 0 inbound legacy peers.\r\n`inbound_targets = (5+0) * 0.1 = 0.5`\r\n`destinations = 0.5 - 0 = 0.5`\r\n\r\nIt just means that we will take 1 inbound peer for fanout with a 50% chance.\r\n\r\nI guess it will work just fine if i drop the `0.01` (1% or less chance) check. It's kinda unfortunate we have to do the compute if chance is that small. Fine with me either way, let me know what you think.",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T08:17:47Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411756962",
      "id" : 1411756962,
      "in_reply_to_id" : 1399769486,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585UJbOi",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 276,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 200,
      "pull_request_review_id" : 1759247791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411756962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-01T08:17:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411756962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411776086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411776086"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T08:35:52Z",
      "diff_hunk" : "@@ -134,14 +196,100 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411776086",
      "id" : 1411776086,
      "in_reply_to_id" : 1401091147,
      "line" : 213,
      "node_id" : "PRRC_kwDOABII585UJf5W",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 213,
      "original_position" : 128,
      "original_start_line" : 217,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 137,
      "pull_request_review_id" : 1759276774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411776086/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 210,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-01T08:35:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411776086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411780306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411780306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. My primary concern is the complexity though. Cascade removal is more difficult to reason about. I just thought it was not worth it.",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T08:40:27Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1411780306",
      "id" : 1411780306,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585UJg7S",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1759283425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411780306/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-01T08:40:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411780306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412243707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412243707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just adding a comment with some context, saying that for chances lower than 1% it may not be worth the computation may be fine. It just struck me as weird where that value came from.",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T15:24:11Z",
      "diff_hunk" : "@@ -197,6 +210,86 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::vector<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                        bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integer_part;\n+        double fractional_peer = std::modf(limit, &integer_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() > fractional_peer * double(UINT64_MAX);\n+        const size_t targets = add_extra ? size_t(integer_part): size_t(integer_part) + 1;\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = deterministic_randomizer_with_wtxid.Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::vector<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets && it != best_peers.end(); ++i, ++it) {\n+            result.push_back(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+                        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.GetUint64(0));\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                        [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                            const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                            if (cur_state) return !cur_state->m_we_initiate;\n+                                                            return false;\n+                                                        });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        if (destinations < 0.01) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412243707",
      "id" : 1412243707,
      "in_reply_to_id" : 1399769486,
      "line" : 276,
      "node_id" : "PRRC_kwDOABII585ULSD7",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 276,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 200,
      "pull_request_review_id" : 1760033220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412243707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-01T15:24:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412243707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412244443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412244443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fair",
      "commit_id" : "0a59a3f63a5211ff7866c24861f6d9730fd156b7",
      "created_at" : "2023-12-01T15:24:53Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1412244443",
      "id" : 1412244443,
      "in_reply_to_id" : 1401146680,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585ULSPb",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5894,
      "original_position" : 89,
      "original_start_line" : 5893,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 1760034404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412244443/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5893,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-01T15:24:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1412244443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed all comments. Ready for review.",
      "created_at" : "2023-12-04T09:13:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1838126153",
      "id" : 1838126153,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585tj5RJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1838126153/reactions"
      },
      "updated_at" : "2023-12-04T09:13:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1838126153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1414062310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414062310"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: if you have created a refactor commit to deal with removing the TODOs, it may be worth moving that change there.\r\n\r\nNot sure if you're planning to squash it or not. Feel free to disregard.",
      "commit_id" : "f895ae4b7aa7263acba1adb3886c47a36f40b024",
      "created_at" : "2023-12-04T15:20:36Z",
      "diff_hunk" : "@@ -51,9 +59,6 @@ class TxReconciliationState\n     bool m_we_initiate;\n \n     /**\n-     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n-     * the following commits.\n-     *",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1414062310",
      "id" : 1414062310,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII585USODm",
      "original_commit_id" : "150aad376413922983b172e0e503047c93c4d05b",
      "original_line" : 56,
      "original_position" : 29,
      "original_start_line" : 54,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 45,
      "pull_request_review_id" : 1762709866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414062310/reactions"
      },
      "side" : "LEFT",
      "start_line" : 50,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:20:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414062310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sr-gi implemented your suggestion and moved the last commit to the front, so that these legacy field don't distract reviewers.",
      "created_at" : "2023-12-05T08:23:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1840243574",
      "id" : 1840243574,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585tr-N2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840243574/reactions"
      },
      "updated_at" : "2023-12-05T08:23:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840243574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK [3a062b2](https://github.com/bitcoin/bitcoin/pull/28765/commits/3a062b2bdc6dc787b967947872f55131522cd2ac) the diff is mainly moving the removal of TODOs between commits.\r\n\r\nI've noticed that the co-authorship of 3a062b2bdc6dc787b967947872f55131522cd2ac was dropped, which may have been unintended.\r\n\r\nAlso, looks like this is failing CI, but it may be unrelated.",
      "created_at" : "2023-12-05T16:49:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1841206307",
      "id" : 1841206307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585tvpQj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1841206307/reactions"
      },
      "updated_at" : "2023-12-05T16:49:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1841206307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1416006054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1416006054"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems better to use a deterministic fast random context in tests, so that failures, if they happen, are deterministic?",
      "commit_id" : "dca7990c3b8b8ecb963c068b4a8a215e0c2b3cd0",
      "created_at" : "2023-12-05T17:06:38Z",
      "diff_hunk" : "@@ -134,5 +134,75 @@ BOOST_AUTO_TEST_CASE(TryRemovingFromSetTest)\n     BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1416006054",
      "id" : 1416006054,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UZomm",
      "original_commit_id" : "3a062b2bdc6dc787b967947872f55131522cd2ac",
      "original_line" : 146,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1765676669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1416006054/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T17:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1416006054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sr-gi fixed the co-authorship. Thank you for patience :)\r\n\r\ntook @maflcko suggestion on deterministic tests.",
      "created_at" : "2023-12-06T10:26:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1842597688",
      "id" : 1842597688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585t0884",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1842597688/reactions"
      },
      "updated_at" : "2023-12-06T10:26:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1842597688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1417583518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417583518"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ups, I forgot to add this.\r\n\r\nnit: Shouldn't this also be `Wtxid&` for consistency with the rest of the interface?\r\n\r\nThis is non-blocking, but I realized when reviewing the last changes to the tests",
      "commit_id" : "dca7990c3b8b8ecb963c068b4a8a215e0c2b3cd0",
      "created_at" : "2023-12-06T15:59:15Z",
      "diff_hunk" : "@@ -84,6 +98,12 @@ class TxReconciliationTracker\n      * Check if a peer is registered to reconcile transactions with us.\n      */\n     bool IsPeerRegistered(NodeId peer_id) const;\n+\n+    /**\n+     * Returns whether the peer is chosen as a low-fanout destination for a given tx.\n+     */\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1417583518",
      "id" : 1417583518,
      "line" : 105,
      "node_id" : "PRRC_kwDOABII585Ufpue",
      "original_commit_id" : "dca7990c3b8b8ecb963c068b4a8a215e0c2b3cd0",
      "original_line" : 105,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : 29,
      "pull_request_review_id" : 1767986165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417583518/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-06T15:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417583518",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1418548663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418548663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "as long as you reack a new version it's fine, since no other acks are pending yet :)",
      "commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "created_at" : "2023-12-07T08:20:07Z",
      "diff_hunk" : "@@ -84,6 +98,12 @@ class TxReconciliationTracker\n      * Check if a peer is registered to reconcile transactions with us.\n      */\n     bool IsPeerRegistered(NodeId peer_id) const;\n+\n+    /**\n+     * Returns whether the peer is chosen as a low-fanout destination for a given tx.\n+     */\n+    bool ShouldFanoutTo(const uint256& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1418548663",
      "id" : 1418548663,
      "in_reply_to_id" : 1417583518,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UjVW3",
      "original_commit_id" : "dca7990c3b8b8ecb963c068b4a8a215e0c2b3cd0",
      "original_line" : 105,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.h",
      "position" : null,
      "pull_request_review_id" : 1769464844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418548663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-07T08:20:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1418548663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Took a minor suggestion from @sr-gi, fixed clang-formatting, fixed code distribution between the two last commits.",
      "created_at" : "2023-12-07T08:42:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1844906757",
      "id" : 1844906757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585t9wsF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1844906757/reactions"
      },
      "updated_at" : "2023-12-07T08:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1844906757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK [f56ec8a](https://github.com/bitcoin/bitcoin/pull/28765/commits/f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9)",
      "created_at" : "2023-12-07T17:08:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1845736014",
      "id" : 1845736014,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585uA7JO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1845736014/reactions"
      },
      "updated_at" : "2023-12-07T17:08:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1845736014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1424331514"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424331514"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that `deterministic_randomizer` could be passed by reference",
      "commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "created_at" : "2023-12-12T17:14:51Z",
      "diff_hunk" : "@@ -195,6 +203,89 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::set<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            result.insert(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1424331514",
      "id" : 1424331514,
      "line" : 243,
      "node_id" : "PRRC_kwDOABII585U5ZL6",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 243,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 64,
      "pull_request_review_id" : 1778050698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424331514/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-12T18:21:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424331514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1424980831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424980831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will fix if i end up retouching it :)",
      "commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "created_at" : "2023-12-13T08:04:28Z",
      "diff_hunk" : "@@ -195,6 +203,89 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::set<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            result.insert(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1424980831",
      "id" : 1424980831,
      "in_reply_to_id" : 1424331514,
      "line" : 243,
      "node_id" : "PRRC_kwDOABII585U73tf",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 243,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 64,
      "pull_request_review_id" : 1779045693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424980831/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T08:04:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1424980831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande Previously I also felt it's unfortunate, but never found a good way to fix it. Now I think perhaps we should compute `GetFanoutTargets` once for every transaction, and then memorize it in a `std::map<Wtxid, list_of_peers>` inside the TxReconciliation module. We can cap the map at 1000 in a FIFO-fashion. Worst case we drop a relevant transaction and then have to recompute it (that's current behaviour default case). Memory should be ok too: `1000 txs * 120 peers * 0.1 ratio = 12,000 entries of NodeId`. What do you think?",
      "created_at" : "2023-12-13T08:11:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1853445405",
      "id" : 1853445405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585ueVUd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853445405/reactions"
      },
      "updated_at" : "2023-12-13T08:11:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1853445405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> What do you think?\r\n\r\nTo get an estimate about performance, I wrote a simple benchmark, see https://github.com/mzumsande/bitcoin/commit/22f98d6f54042b3e8ee41889ceb362f6355e4fa0. On my computer (neither particularly fast nor slow) I get `~1000op/s` per wtxid to call `ShouldFanoutTo()` for all 120 peers, so a batch of 3000 txs should take ~3s time in `ShouldFanoutTo`. \r\nSo I think that caching could make sense.\r\n\r\nI wonder if there is there a good way to restrict this map to wtxids that are still in some peer's inv queue and remove them afterwards, or would the map just always fill up?",
      "created_at" : "2023-12-13T20:08:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1854630701",
      "id" : 1854630701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585ui2st",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1854630701/reactions"
      },
      "updated_at" : "2023-12-13T20:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1854630701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425842632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425842632"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `deterministic_randomizer_with_wtxid` variable could be `const CSipHasher&` here (to make it clear that this object is only ever used as a starting point for (independent) hashes).",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:18:23Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425842632",
      "id" : 1425842632,
      "line" : 207,
      "node_id" : "PRRC_kwDOABII585U_KHI",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 207,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 131,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425842632/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425842632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425845551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425845551"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe it would be significantly faster to make this an `std::vector<std::pair<uint64_t, NodeId>>`, `.reserve()` it once, fill it up like in the loop below, and then `std::sort` it in-place using `cmp_by_key`. This has far better memory locality, less allocation overhead, and ought to have the same asymptotic complexity (O(n log n)).",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:21:32Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425845551",
      "id" : 1425845551,
      "line" : 225,
      "node_id" : "PRRC_kwDOABII585U_K0v",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 225,
      "original_position" : 149,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 149,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425845551/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425845551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425854190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425854190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Constructing the full set of fanout candidates any time you want to consider relaying anything to any node has O(n^2 log n) scaling (you'll call `GetFanoutTargets` O(n) times, and each does O(n log n) work going over all nodes), I believe.\r\n\r\nThat may or may not matter, but I'd consider at least one of these variants:\r\n* Cache the `GetFanoutTargets` result per transaction as discussed elsewhere in this PR, making it O(n log n) only.\r\n* Instead of computing an `std::set<NodeId>` in `GetFanoutTargets` (which at least involves an allocation per result), pass the `peer_id` to `GetFanoutTargets`, which can then just return a boolean (see if the `peer_id` appears in the first `target_size` elements of `best_peers` after sorting). This doesn't change the asymptotic behavior, but means there is just one allocation per `ShouldFanoutTo`.",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:31:09Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::set<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            result.insert(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                             [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {\n+                                                                 const auto* cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+                                                                 if (cur_state) return !cur_state->m_we_initiate;\n+                                                                 return false;\n+                                                             });\n+\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + inbound_rcncl_peers) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        // Pure optimization to avoid going through the peers when the odds of picking one are\n+        // too low.\n+        if (destinations < 0.001) {\n+            return false;\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        auto fanout_candidates = GetFanoutTargets(deterministic_randomizer, recon_state.m_we_initiate, destinations);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425854190",
      "id" : 1425854190,
      "line" : 286,
      "node_id" : "PRRC_kwDOABII585U_M7u",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 286,
      "original_position" : 210,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 210,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425854190/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425854190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425856345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425856345"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe the appropriate type in this case is `CSipHasher&& deterministic_randomizer`. This avoids a copy, allows the local variable inside `ShouldFanoutTo` to be modified, and the caller is constructing a fresh `CSipHasher` anyway.",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:33:37Z",
      "diff_hunk" : "@@ -195,6 +203,89 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::set<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            result.insert(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425856345",
      "id" : 1425856345,
      "in_reply_to_id" : 1424331514,
      "line" : 243,
      "node_id" : "PRRC_kwDOABII585U_NdZ",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 243,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 167,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425856345/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425856345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425857575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425857575"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: `const size_t targets_size = integral_part + add_extra`.",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:34:54Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425857575",
      "id" : 1425857575,
      "line" : 219,
      "node_id" : "PRRC_kwDOABII585U_Nwn",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 219,
      "original_position" : 143,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 143,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425857575/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425857575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425862263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425862263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pass `indexed_state` by reference. This is creating a copy of the entire `TxReconciliationState` for every element in `m_states`.\r\n\r\n`[](const auto& indexed_state) { ... }` works.",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:40:36Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));\n+            }\n+        }\n+\n+        std::set<NodeId> result;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            result.insert(it->second);\n+        }\n+        return result;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, CSipHasher deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),\n+                                                             [](std::pair<NodeId, std::variant<uint64_t, TxReconciliationState>> indexed_state) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425862263",
      "id" : 1425862263,
      "line" : 264,
      "node_id" : "PRRC_kwDOABII585U_O53",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 264,
      "original_position" : 188,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 188,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425862263/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425862263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425865073"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425865073"
         }
      },
      "author_association" : "MEMBER",
      "body" : "An alternative which may be slightly faster (unsure, depends on how fast `std::modf` is):\r\n\r\n`const size_t targets_size = ((deterministic_randomizer_with_wtxid.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;`\r\n\r\nIt has lower precision, but I suspect 32 bits is more than sufficient here.",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:43:50Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425865073",
      "id" : 1425865073,
      "line" : 219,
      "node_id" : "PRRC_kwDOABII585U_Plx",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 219,
      "original_position" : 143,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 143,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425865073/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425865073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425866501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425866501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`best_peers.emplace(hash_key, indexed_state.first);` (avoids a temporary `std::pair` object in the caller).\r\n\r\n(it'd become `best_peers.emplace_back(hash_key indexed_state.first);` if `best_peers` is converted to a vector as suggested above.",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:45:33Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.insert(std::make_pair(hash_key, indexed_state.first));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425866501",
      "id" : 1425866501,
      "line" : 231,
      "node_id" : "PRRC_kwDOABII585U_P8F",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 231,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 155,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425866501/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425866501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425866970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425866970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Use `const auto& indexed_state : m_states)` here; you're making a copy of the entire `TxReconciliationState` for every iteration as written here.",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:46:07Z",
      "diff_hunk" : "@@ -134,14 +189,103 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    std::set<NodeId> GetFanoutTargets(CSipHasher& deterministic_randomizer_with_wtxid,\n+                                      bool we_initiate, double limit) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        double integral_part;\n+        double fractional_part = std::modf(limit, &integral_part);\n+        // Handle fractional value.\n+        const bool add_extra = deterministic_randomizer_with_wtxid.Finalize() < fractional_part * double(UINT64_MAX);\n+        const size_t targets_size = add_extra ? size_t(integral_part) + 1 : size_t(integral_part);\n+\n+        auto cmp_by_key = [](const std::pair<uint64_t, NodeId>& left, const std::pair<uint64_t, NodeId>& right) {\n+            return left.first > right.first;\n+        };\n+\n+        std::set<std::pair<uint64_t, NodeId>, decltype(cmp_by_key)> best_peers(cmp_by_key);\n+\n+        for (auto indexed_state : m_states) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425866970",
      "id" : 1425866970,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII585U_QDa",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 227,
      "original_position" : 151,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 151,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425866970/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425866970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425870404"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425870404"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Use `const auto& [cur_peer_id, cur_peer] : m_peer_map` here. You're making a copy of the `PeerRef` object for every iteration here (which isn't the end of the world, it's just a shared pointer, but copying those does involve an atomic memory operation).",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2023-12-13T20:50:09Z",
      "diff_hunk" : "@@ -5818,6 +5827,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n+\n+                    size_t inbounds_nonrcncl_tx_relay = 0, outbounds_nonrcncl_tx_relay = 0;\n+                    const bool reconciles_txs = m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId());\n+                    if (reconciles_txs) {\n+                        for (auto [cur_peer_id, cur_peer] : m_peer_map) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1425870404",
      "id" : 1425870404,
      "line" : 5834,
      "node_id" : "PRRC_kwDOABII585U_Q5E",
      "original_commit_id" : "f56ec8a3b086b0f2f8a0fbde861447e40ffbc3d9",
      "original_line" : 5834,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 45,
      "pull_request_review_id" : 1780420519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425870404/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-13T20:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1425870404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Before @sipa optimization:\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,401,785.00 |              713.38 |    1.6% |      0.02 | `ShouldFanoutTo`\r\n```\r\n\r\nAfter:\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          369,620.50 |            2,705.48 |    1.4% |      0.01 | `ShouldFanoutTo`\r\n```\r\n\r\n4x improvement, I think batching is still worth implementing. I will suggest code changes shortly.",
      "created_at" : "2023-12-14T09:23:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1855476801",
      "id" : 1855476801,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585umFRB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1855476801/reactions"
      },
      "updated_at" : "2023-12-14T09:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1855476801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Finally submitted the optimized code.\r\nI also [tried caching](https://github.com/naumenkogs/bitcoin/commit/ae19891dfb588daefcda475a860464587f0480dc), but the speed went _down_ 10x (either map or unordered_map). Perhaps @sipa @mzumsande have interest in looking what could be the issue.",
      "created_at" : "2023-12-20T09:02:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1864100266",
      "id" : 1864100266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585vG-mq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1864100266/reactions"
      },
      "updated_at" : "2023-12-20T09:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1864100266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1445562578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1445562578"
         }
      },
      "author_association" : "NONE",
      "body" : "Une fois terminer tout ceux qui m'auront aidÃ© seront rÃ©compensÃ©",
      "commit_id" : "985b5970a75528c2fb68e1d56abef3b7f37f1ea5",
      "created_at" : "2024-01-09T02:27:58Z",
      "diff_hunk" : "@@ -134,5 +134,75 @@ BOOST_AUTO_TEST_CASE(TryRemovingFromSetTest)\n     BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1445562578",
      "id" : 1445562578,
      "in_reply_to_id" : 1416006054,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585WKYjS",
      "original_commit_id" : "3a062b2bdc6dc787b967947872f55131522cd2ac",
      "original_line" : 146,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1810312555,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1445562578/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-09T02:27:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1445562578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/142675685?v=4",
         "events_url" : "https://api.github.com/users/BombayN1/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BombayN1/followers",
         "following_url" : "https://api.github.com/users/BombayN1/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BombayN1/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BombayN1",
         "id" : 142675685,
         "login" : "BombayN1",
         "node_id" : "U_kgDOCIEO5Q",
         "organizations_url" : "https://api.github.com/users/BombayN1/orgs",
         "received_events_url" : "https://api.github.com/users/BombayN1/received_events",
         "repos_url" : "https://api.github.com/users/BombayN1/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BombayN1/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BombayN1/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BombayN1"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande you're right i lost between branches, sorry.\r\n\r\nApparently caching gives another 12x boost, assuming it works correctly :)\r\n\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|           35,617.11 |           28,076.40 |    1.9% |      0.01 | `ShouldFanoutTo`\r\n```",
      "created_at" : "2024-01-09T08:37:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#issuecomment-1882620655",
      "id" : 1882620655,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28765",
      "node_id" : "IC_kwDOABII585wNoLv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1882620655/reactions"
      },
      "updated_at" : "2024-01-09T08:37:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1882620655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1446503850"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446503850"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `targes` -> `targets`",
      "commit_id" : "c7c6bcc5c6ba7b5590470d2029fbc27321b35c8d",
      "created_at" : "2024-01-09T19:19:07Z",
      "diff_hunk" : "@@ -76,6 +90,19 @@ class TxReconciliationTracker::Impl\n      */\n     std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n \n+    /*\n+     * A least-recently-added cache tracking which peers we should fanout a transaction to.\n+     *\n+     * Since the time between cache accesses is on the order of seconds, returning an outdated\n+     * set of peers is not a concern (especially since we fanout to outbound peers, which should\n+     * be hard to manipulate).\n+     *\n+     * No need to use LRU (bump transaction order upon access) because in most cases\n+     * transactions are processed almost-sequentially.\n+     */\n+    std::deque<Wtxid> tx_fanout_targes_cache_order;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1446503850",
      "id" : 1446503850,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII585WN-Wq",
      "original_commit_id" : "c7c6bcc5c6ba7b5590470d2029fbc27321b35c8d",
      "original_line" : 103,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 75,
      "pull_request_review_id" : 1811832956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446503850/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-09T19:42:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446503850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1446517082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446517082"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I'd be nice to define this as a constant",
      "commit_id" : "c7c6bcc5c6ba7b5590470d2029fbc27321b35c8d",
      "created_at" : "2024-01-09T19:34:12Z",
      "diff_hunk" : "@@ -134,14 +202,119 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    bool IsFanoutTarget(CSipHasher&& deterministic_randomizer,\n+                        bool we_initiate, double limit,\n+                        NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != tx_fanout_targets_cache_data.end()) {\n+            return fanout_candidates->second.find(peer_id) != fanout_candidates->second.end();\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        static constexpr auto cmp_by_key = [](const auto& left, const auto& right) {\n+            return left.first > right.first;\n+        };\n+        std::sort(best_peers.begin(), best_peers.end(), cmp_by_key);\n+\n+        std::set<NodeId> new_fanout_candidates;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            new_fanout_candidates.insert(it->second);\n+        }\n+\n+        tx_fanout_targets_cache_data.emplace(wtxid, new_fanout_candidates);\n+        // Replace the oldest cache item with this new one.\n+        if (tx_fanout_targes_cache_order.size () == 3000) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1446517082",
      "id" : 1446517082,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII585WOBla",
      "original_commit_id" : "c7c6bcc5c6ba7b5590470d2029fbc27321b35c8d",
      "original_line" : 268,
      "original_position" : 199,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 199,
      "pull_request_review_id" : 1811832956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446517082/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-09T19:42:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446517082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1446518794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446518794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is right(?), this logic is never triggered.\r\n\r\nYou are checking whether the size of `tx_fanout_targes_cache_order` is over the limit, but you are only adding elements to the queue within that same `if` context, meaning that the queue is always empty.",
      "commit_id" : "c7c6bcc5c6ba7b5590470d2029fbc27321b35c8d",
      "created_at" : "2024-01-09T19:36:15Z",
      "diff_hunk" : "@@ -134,14 +202,119 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n     {\n-        AssertLockNotHeld(m_txreconciliation_mutex);\n-        LOCK(m_txreconciliation_mutex);\n+        AssertLockHeld(m_txreconciliation_mutex);\n         auto recon_state = m_states.find(peer_id);\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    bool IsPeerRegisteredExternal(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        return IsPeerRegistered(peer_id);\n+    }\n+\n+    bool IsFanoutTarget(CSipHasher&& deterministic_randomizer,\n+                        bool we_initiate, double limit,\n+                        NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != tx_fanout_targets_cache_data.end()) {\n+            return fanout_candidates->second.find(peer_id) != fanout_candidates->second.end();\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        static constexpr auto cmp_by_key = [](const auto& left, const auto& right) {\n+            return left.first > right.first;\n+        };\n+        std::sort(best_peers.begin(), best_peers.end(), cmp_by_key);\n+\n+        std::set<NodeId> new_fanout_candidates;\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            new_fanout_candidates.insert(it->second);\n+        }\n+\n+        tx_fanout_targets_cache_data.emplace(wtxid, new_fanout_candidates);\n+        // Replace the oldest cache item with this new one.\n+        if (tx_fanout_targes_cache_order.size () == 3000) {\n+            auto expired_tx = tx_fanout_targes_cache_order.front();\n+            tx_fanout_targets_cache_data.erase(expired_tx);\n+            tx_fanout_targes_cache_order.pop_front();\n+            tx_fanout_targes_cache_order.push_back(wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1446518794",
      "id" : 1446518794,
      "line" : 272,
      "node_id" : "PRRC_kwDOABII585WOCAK",
      "original_commit_id" : "c7c6bcc5c6ba7b5590470d2029fbc27321b35c8d",
      "original_line" : 272,
      "original_position" : 203,
      "original_start_line" : 268,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 203,
      "pull_request_review_id" : 1811832956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446518794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 268,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-01-09T19:42:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446518794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447390077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447390077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In \"refactor: Add a pre-mutexed version of IsPeerRegistered\":\r\n\r\nI'd prefer to swap the names (= have an external `IsPeerRegistered`, and an internal `IsPeerRegisteredInternal`), as external callers ought to only care about the external one. Also is it possible to make the internal one `private`?\r\n\r\n",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T13:31:51Z",
      "diff_hunk" : "@@ -128,14 +128,20 @@ class TxReconciliationTracker::Impl\n         }\n     }\n \n-    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool IsPeerRegistered(NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447390077",
      "id" : 1447390077,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585WRWt9",
      "original_commit_id" : "1d06576d748d76f8dfa3f983307a110e9aad6a7a",
      "original_line" : 131,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 138,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447390077/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T15:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447390077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447401962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447401962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If this set may contain up to 3000 (=`MAX_SET_SIZE`) elements, it may be worth using an `std::unordered_set` instead (with something like `SaltedTxidHasher` as hasher).",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T13:42:20Z",
      "diff_hunk" : "@@ -48,6 +52,14 @@ class TxReconciliationState\n      */\n     uint64_t m_k0, m_k1;\n \n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)\n+     * in this set instead of announcing them right away. When reconciliation time comes, we will\n+     * compute a compressed representation of this set (\"sketch\") and use it to efficiently\n+     * reconcile this set with a set on the peer's side.\n+     */\n+    std::set<Wtxid> m_local_set;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447401962",
      "id" : 1447401962,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585WRZnq",
      "original_commit_id" : "64cae4514b065cd5db3dd48eebcdf7509694e4d1",
      "original_line" : 61,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 60,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447401962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T15:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447401962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447502258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447502258"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"p2p: Add transactions to reconciliation sets\"\r\n\r\nIt doesn't actually matter whether we pick the lowest-`hash_key` entries or highest-`hash_key` entries to fanout to, I think? If so, can just use `std::sort(best_peers.begin(), best_peers.end());`, and drop the `cmp_by_key`.\r\n\r\nAlso, since you only care about the top `targets_size` results, I believe using `std::partial_sort` *may* be faster (but benchmark it).",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T14:58:16Z",
      "diff_hunk" : "@@ -195,6 +203,89 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool IsFanoutTarget(const CSipHasher& deterministic_randomizer_with_wtxid,\n+                        bool we_initiate, double limit,\n+                        NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer_with_wtxid.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        static constexpr auto cmp_by_key = [](const auto& left, const auto& right) {\n+            return left.first > right.first;\n+        };\n+        std::sort(best_peers.begin(), best_peers.end(), cmp_by_key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447502258",
      "id" : 1447502258,
      "line" : 262,
      "node_id" : "PRRC_kwDOABII585WRyGy",
      "original_commit_id" : "baaf390c758fbe173c4b440c8c26048b58f63b9c",
      "original_line" : 236,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 193,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447502258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T15:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447502258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447504347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447504347"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"p2p: Add transactions to reconciliation set\"\r\n\r\nWould it make sense to have an (internal) helper function instead of `IsPeerRegistered`, that instead of returning a `bool` returns a `TxReconciliationState*` (`nullptr` if not found)? That would avoid locking/finding twice. I suspect it'd be usable in other places too.",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T14:59:46Z",
      "diff_hunk" : "@@ -195,6 +203,89 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool IsFanoutTarget(const CSipHasher& deterministic_randomizer_with_wtxid,\n+                        bool we_initiate, double limit,\n+                        NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer_with_wtxid.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        static constexpr auto cmp_by_key = [](const auto& left, const auto& right) {\n+            return left.first > right.first;\n+        };\n+        std::sort(best_peers.begin(), best_peers.end(), cmp_by_key);\n+\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            if (it->second == peer_id) return true;\n+        }\n+        return false;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, CSipHasher&& deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447504347",
      "id" : 1447504347,
      "line" : 288,
      "node_id" : "PRRC_kwDOABII585WRynb",
      "original_commit_id" : "baaf390c758fbe173c4b440c8c26048b58f63b9c",
      "original_line" : 251,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 219,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447504347/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T18:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447504347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447509119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447509119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"p2p: Add transactions to reconciliation set\"\r\n\r\nThis value could be cached inside `TxReconciliationTracker::Impl` I think, and updated on registering/deregister, to avoid recomputating it every time?",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T15:02:53Z",
      "diff_hunk" : "@@ -195,6 +203,89 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool IsFanoutTarget(const CSipHasher& deterministic_randomizer_with_wtxid,\n+                        bool we_initiate, double limit,\n+                        NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer_with_wtxid.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        static constexpr auto cmp_by_key = [](const auto& left, const auto& right) {\n+            return left.first > right.first;\n+        };\n+        std::sort(best_peers.begin(), best_peers.end(), cmp_by_key);\n+\n+        auto it = best_peers.begin();\n+        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n+            if (it->second == peer_id) return true;\n+        }\n+        return false;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, CSipHasher&& deterministic_randomizer, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+        const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        if (!IsPeerRegistered(peer_id)) return true;\n+        const auto& recon_state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (recon_state.m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            const size_t inbound_rcncl_peers = std::count_if(m_states.begin(), m_states.end(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447509119",
      "id" : 1447509119,
      "line" : 302,
      "node_id" : "PRRC_kwDOABII585WRzx_",
      "original_commit_id" : "baaf390c758fbe173c4b440c8c26048b58f63b9c",
      "original_line" : 265,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 233,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447509119/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T15:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447509119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447514047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447514047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"p2p: Add transactions to reconciliation set\"\r\n\r\nYou could pick a fixed seed and wtxid for which you assert that with say 35 peers 3 are picked, and another seed/wtxid for which you assert that with 35 peers 4 are picked. That would at least show that the fractional probability code isn't just rounding down.",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T15:06:39Z",
      "diff_hunk" : "@@ -81,4 +81,76 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    TxReconciliationTracker tracker(1);\n+    NodeId peer_id0 = 0;\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                            /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(GetRandHash(), hasher, peer_id0,\n+                                           /*inbounds_nonrcncl_tx_relay=*/0, /*outbounds_nonrcncl_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447514047",
      "id" : 1447514047,
      "in_reply_to_id" : 1379312851,
      "line" : 183,
      "node_id" : "PRRC_kwDOABII585WR0-_",
      "original_commit_id" : "b07029a67c800c679214a28f935fa221b44e7ead",
      "original_line" : 183,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/test/txreconciliation_tests.cpp",
      "position" : 103,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447514047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T15:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447514047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447521744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447521744"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Cache fanout candidates to optimize txreconciliation\"\r\n\r\nSince the cache entry `std::set<NodeId>` don't change until being replaced entirely, I believe it would be more efficient to use a `std::vector<NodeId>`, with the nodeids in sorted order. You can then use `std::binary_search` to query in that vector.\r\n\r\nIt'd be more efficient as `std::vector` has much better memory locality than `std::set`, and fewer indirections.\r\n\r\nIf you do this, can also just reuse the `best_peers` vector, and shrink it to `target_size` (but make sure to call `shrink_to_fit`, as otherwise the memory for the remainder won't be released.",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T15:12:25Z",
      "diff_hunk" : "@@ -90,6 +94,19 @@ class TxReconciliationTracker::Impl\n      */\n     std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n \n+    /*\n+     * A least-recently-added cache tracking which peers we should fanout a transaction to.\n+     *\n+     * Since the time between cache accesses is on the order of seconds, returning an outdated\n+     * set of peers is not a concern (especially since we fanout to outbound peers, which should\n+     * be hard to manipulate).\n+     *\n+     * No need to use LRU (bump transaction order upon access) because in most cases\n+     * transactions are processed almost-sequentially.\n+     */\n+    std::deque<Wtxid> tx_fanout_targets_cache_order;\n+    std::map<Wtxid, std::set<NodeId>> tx_fanout_targets_cache_data GUARDED_BY(m_txreconciliation_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447521744",
      "id" : 1447521744,
      "line" : 108,
      "node_id" : "PRRC_kwDOABII585WR23Q",
      "original_commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "original_line" : 108,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 26,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447521744/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T15:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447521744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447531912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447531912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Cache fanout candidates to optimize txreconciliation\"\r\n\r\nUse `std::move` around `new_fanout_candidates` (or `best_peers` if you take my earlier suggestion to use a vector), to avoid a copy. If so, lookup the `peer_id` in it before moving, so you can return that value.",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-10T15:19:51Z",
      "diff_hunk" : "@@ -235,16 +261,27 @@ class TxReconciliationTracker::Impl\n         };\n         std::sort(best_peers.begin(), best_peers.end(), cmp_by_key);\n \n+        std::set<NodeId> new_fanout_candidates;\n         auto it = best_peers.begin();\n         for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n-            if (it->second == peer_id) return true;\n+            new_fanout_candidates.insert(it->second);\n         }\n-        return false;\n+\n+        tx_fanout_targets_cache_data.emplace(wtxid, new_fanout_candidates);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1447531912",
      "id" : 1447531912,
      "line" : 270,
      "node_id" : "PRRC_kwDOABII585WR5WI",
      "original_commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "original_line" : 270,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 83,
      "pull_request_review_id" : 1813233994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447531912/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-10T18:53:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1447531912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1450168792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1450168792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`ShouldFanoutTo` looks fitting for benchmarking, and `partial_sort` had no effect.\r\nI took the former suggestion of course.",
      "commit_id" : "b54d8ec9ff524fb0986db78b22fe8d7c6277eb99",
      "created_at" : "2024-01-12T10:01:19Z",
      "diff_hunk" : "@@ -195,6 +203,89 @@ class TxReconciliationTracker::Impl\n         LOCK(m_txreconciliation_mutex);\n         return IsPeerRegistered(peer_id);\n     }\n+\n+    bool IsFanoutTarget(const CSipHasher& deterministic_randomizer_with_wtxid,\n+                        bool we_initiate, double limit,\n+                        NodeId peer_id) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer_with_wtxid.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer_with_wtxid).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        static constexpr auto cmp_by_key = [](const auto& left, const auto& right) {\n+            return left.first > right.first;\n+        };\n+        std::sort(best_peers.begin(), best_peers.end(), cmp_by_key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1450168792",
      "id" : 1450168792,
      "in_reply_to_id" : 1447502258,
      "line" : 262,
      "node_id" : "PRRC_kwDOABII585Wb9HY",
      "original_commit_id" : "baaf390c758fbe173c4b440c8c26048b58f63b9c",
      "original_line" : 236,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 193,
      "pull_request_review_id" : 1817828695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1450168792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-12T10:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1450168792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1496674625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496674625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "for code readability, such variables could be renamed `inbounds_flooding_tx_relay` / `outbounds_flooding_tx_relay`, which is matching the low-fanout flooding strategy used for them.",
      "commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "created_at" : "2024-02-20T23:23:24Z",
      "diff_hunk" : "@@ -5818,6 +5828,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n+\n+                    size_t inbounds_nonrcncl_tx_relay = 0, outbounds_nonrcncl_tx_relay = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1496674625",
      "id" : 1496674625,
      "line" : 5832,
      "node_id" : "PRRC_kwDOABII585ZNXFB",
      "original_commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "original_line" : 5832,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 70,
      "pull_request_review_id" : 1891766080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496674625/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T23:56:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496674625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1496683339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496683339"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can add a `LogPrint(BCLog::NET, âNon-signaling reconciliation inbound peers flooding %d Outbound peers flooding %d for debugâ);` for debug purpose and observation",
      "commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "created_at" : "2024-02-20T23:36:45Z",
      "diff_hunk" : "@@ -5845,7 +5878,32 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.\n+                                if ((*txiter)->GetCountWithDescendants() <= 1) {\n+                                    fanout = m_txreconciliation->ShouldFanoutTo(wtxid, pto->GetId(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1496683339",
      "id" : 1496683339,
      "line" : 5897,
      "node_id" : "PRRC_kwDOABII585ZNZNL",
      "original_commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "original_line" : 5897,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 116,
      "pull_request_review_id" : 1891766080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496683339/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T23:56:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496683339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1496695880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496695880"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I confirm with current implemented bip331 approach there is currently a `MAX_ORPHAN_TOTAL_SIZE` limit.\r\nYou can always get a non-standard parent (e.g an under-dust output) and yet the child be policy valid.\r\nThere is currently no sanitization of policy equivalence among a set of parent within `ancpkginfo`.\r\nIn the future, you could have reconciliation at the `pkgtxns`-level or at package announcement (`ancpkginfo`).\r\nIdeally both, though that something that can be seen once erlay or bip331 are deployed.\r\n\r\nAssuming there is no substantial timely delay between the parent being reconciliated and the child being fanout to the peer which would allow an overflow of `MAX_ORPHAN_TOTAL_SIZE`, I donât think itâs altering the package acceptance of the receiving peer.\r\n\r\nAssuming no exploitable timers, one can still make the simulation to quantity the âchild driftâ risk for a distribution of parent / child being reconciliated / fanout on the average time discrepancies between those 2 tx announcement strategy. Ideally in the future, we would move to sender-initiated package, which would remove this concern from my understanding. However, this is already a post-bip331 future, weâre talking about.\r\n",
      "commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "created_at" : "2024-02-20T23:56:42Z",
      "diff_hunk" : "@@ -5845,7 +5877,33 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1496695880",
      "id" : 1496695880,
      "in_reply_to_id" : 1401014445,
      "line" : 5892,
      "node_id" : "PRRC_kwDOABII585ZNcRI",
      "original_commit_id" : "50dc9bf21688afbf8404d4737636f0f8f742e6ed",
      "original_line" : 5892,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 111,
      "pull_request_review_id" : 1891766080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496695880/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-20T23:56:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1496695880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1498025796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498025796"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can be constified same than `OUTBOUND_FANOUT_DESTINATIONS` and `INBOUND_FANOUT_DESTINATIONS_FRACTION` as explanation for this value is tight to them",
      "commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "created_at" : "2024-02-21T17:56:23Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = m_tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(fanout_candidates->second.begin(), fanout_candidates->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                 [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (peer_state->m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        // Pure optimization to avoid going through the peers when the odds of picking one are\n+        // too low.\n+        if (destinations < 0.001) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1498025796",
      "id" : 1498025796,
      "line" : 342,
      "node_id" : "PRRC_kwDOABII585ZSg9E",
      "original_commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "original_line" : 342,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 281,
      "pull_request_review_id" : 1894054084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498025796/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-21T17:57:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498025796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1498754677"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498754677"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not really related. Change these constants in any way, and the `0.001` value won't be affected.",
      "commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "created_at" : "2024-02-22T07:09:38Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = m_tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(fanout_candidates->second.begin(), fanout_candidates->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                 [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (peer_state->m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        // Pure optimization to avoid going through the peers when the odds of picking one are\n+        // too low.\n+        if (destinations < 0.001) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1498754677",
      "id" : 1498754677,
      "in_reply_to_id" : 1498025796,
      "line" : 342,
      "node_id" : "PRRC_kwDOABII585ZVS51",
      "original_commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "original_line" : 342,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 281,
      "pull_request_review_id" : 1895074163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498754677/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T07:09:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1498754677",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1499802603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499802603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "okay will read back the txrelayism issue on const selection.",
      "commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "created_at" : "2024-02-22T19:24:18Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = m_tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(fanout_candidates->second.begin(), fanout_candidates->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                 [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_nonrcncl_tx_relay, size_t outbounds_nonrcncl_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double destinations;\n+        if (peer_state->m_we_initiate) {\n+            destinations = OUTBOUND_FANOUT_DESTINATIONS - outbounds_nonrcncl_tx_relay;\n+        } else {\n+            // Since we use the fraction for inbound peers, we first need to compute the total\n+            // number of inbound targets.\n+            const double inbound_targets = (inbounds_nonrcncl_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+            destinations = inbound_targets - inbounds_nonrcncl_tx_relay;\n+        }\n+\n+        // Pure optimization to avoid going through the peers when the odds of picking one are\n+        // too low.\n+        if (destinations < 0.001) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1499802603",
      "id" : 1499802603,
      "in_reply_to_id" : 1498025796,
      "line" : 342,
      "node_id" : "PRRC_kwDOABII585ZZSvr",
      "original_commit_id" : "82126d3ca527e5c06606a50ee8d8baf792193ef4",
      "original_line" : 342,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 281,
      "pull_request_review_id" : 1896771509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499802603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T19:24:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499802603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1499825828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499825828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In the eventuality of an influx of inbound transactions, faster than we can flush out them to low-fanout flooding peers, my understanding of dropping the upfront wtxid candidate, we would keep propagating this transaction only according to tx-relay policy and connection state of other peers (not this `NodeId` anymore).\r\n\r\nI understand weâre fanning out only to outbound peers (`m_tx_fanout_targets_cache_data` doc), though here itâs more a dependency on the perfomance capabilities of the full-node itself (i.e how fast you process `vInv(MSG_WTX`) and how fast you-reannounce them to downstream peers if valid). To interferes with a transaction propagation, assuming a non-listening node, an attacker would have to be puppet or compromise all our low-fanout outbound peers, I think ? Obviously more outbound peers would make things better on this front, which should be allowed by Erlay tx-relay bandwidth savings.",
      "commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "created_at" : "2024-02-22T19:37:19Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = m_tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(fanout_candidates->second.begin(), fanout_candidates->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                 [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1499825828",
      "id" : 1499825828,
      "line" : 306,
      "node_id" : "PRRC_kwDOABII585ZZYak",
      "original_commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "original_line" : 306,
      "original_position" : 245,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 245,
      "pull_request_review_id" : 1896793349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499825828/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-22T19:39:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1499825828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1501318816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501318816"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In terms of peers-side policy check (i.e `m_fee_filter_received`), this policy limit is at the tx-relay link level and this is unilaterally initiated by the peer. As such I think there is no guarantee that between time point A we add a `Wtxid` in `m_local_set` and time point B we reconciliate, we have not received a new bip133 message, updating the `m_fee_filter_received`. I believe we can retro-actively stale stored `Wtxid` and as such a bandwidth performance leak, under situations of sudden network mempool spikes.\r\n\r\nI donât think there is that much a tx-announcement strategy (either flooding or reconciliation) can do it in itself, unless assuming some extensions to bip133 messages to commit on a feerate-level duration. As such, I think any improvement is out of scope for this PR.",
      "commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "created_at" : "2024-02-24T02:08:42Z",
      "diff_hunk" : "@@ -47,13 +61,18 @@ class TxReconciliationState\n     bool m_we_initiate;\n \n     /**\n-     * TODO: These fields are public to ignore -Wunused-private-field. Make private once used in\n-     * the following commits.\n-     *\n      * These values are used to salt short IDs, which is necessary for transaction reconciliations.\n      */\n     uint64_t m_k0, m_k1;\n \n+    /**\n+     * Store all wtxids which we would announce to the peer (policy checks passed, etc.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1501318816",
      "id" : 1501318816,
      "line" : 69,
      "node_id" : "PRRC_kwDOABII585ZfE6g",
      "original_commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "original_line" : 69,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 55,
      "pull_request_review_id" : 1899172885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501318816/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-24T02:35:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501318816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1501322675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501322675"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think â(1)â can be extended a bit more e.g âMemory DoS issue for a laggy peer are bounded by `DEFAULT_MAX_PEER_CONNECTIONS` and reconciliation state is clean up with `FinalizeNode`\".",
      "commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "created_at" : "2024-02-24T02:33:49Z",
      "diff_hunk" : "@@ -121,19 +171,77 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n+        if (is_peer_inbound && m_inbounds_count < std::numeric_limits<size_t>::max()) {\n+            ++m_inbounds_count;\n+        }\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n-    void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n-        if (m_states.erase(peer_id)) {\n-            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1501322675",
      "id" : 1501322675,
      "line" : 197,
      "node_id" : "PRRC_kwDOABII585ZfF2z",
      "original_commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "original_line" : 197,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 137,
      "pull_request_review_id" : 1899172885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501322675/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-24T02:35:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1501322675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1502598818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1502598818"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 17ae36c0f60b976c237bdb522059c31cf113c773: Is there any reason to define `rand_i` into `bench.run`? Couldn't we have it out of it? Notice that without it, the bench is 70% faster.",
      "commit_id" : "b3db2bcd011c70292079f1f95c72e744678d2299",
      "created_at" : "2024-02-26T13:18:15Z",
      "diff_hunk" : "@@ -0,0 +1,41 @@\n+// Copyright (c) 2020-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <net.h>\n+#include <node/txreconciliation.h>\n+\n+\n+/* Benchmarks */\n+\n+static void ShouldFanoutTo(benchmark::Bench& bench)\n+{\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+    CSipHasher hasher(frc.rand64(), frc.rand64());\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    // Register 120 inbound peers\n+    int num_peers{120};\n+    for (NodeId peer = 0; peer < num_peers; peer++) {\n+        tracker.PreRegisterPeer(peer);\n+        tracker.RegisterPeer(peer, /*is_peer_inbound=*/true, 1, 1);\n+    }\n+    FastRandomContext rc{/*fDeterministic=*/true};\n+\n+    // The target function uses caching, so we want to mimic tx repetitions\n+    // of the real-world behavior.\n+    std::vector<Wtxid> txs;\n+    for (size_t i = 0; i < 1000; i++) {\n+        txs.push_back(Wtxid::FromUint256(rc.rand256()));\n+    }\n+\n+    bench.run([&] {\n+        size_t rand_i = rand() % txs.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1502598818",
      "id" : 1502598818,
      "line" : 34,
      "node_id" : "PRRC_kwDOABII585Zj9ai",
      "original_commit_id" : "17ae36c0f60b976c237bdb522059c31cf113c773",
      "original_line" : 34,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/bench/txreconciliation.cpp",
      "position" : 34,
      "pull_request_review_id" : 1900853776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1502598818/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-26T13:48:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1502598818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1503966435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503966435"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm dropping it.\r\nDo you understand why this simple op as var assignment eats so much perf? :)",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-02-27T10:03:50Z",
      "diff_hunk" : "@@ -0,0 +1,41 @@\n+// Copyright (c) 2020-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <net.h>\n+#include <node/txreconciliation.h>\n+\n+\n+/* Benchmarks */\n+\n+static void ShouldFanoutTo(benchmark::Bench& bench)\n+{\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+    CSipHasher hasher(frc.rand64(), frc.rand64());\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    // Register 120 inbound peers\n+    int num_peers{120};\n+    for (NodeId peer = 0; peer < num_peers; peer++) {\n+        tracker.PreRegisterPeer(peer);\n+        tracker.RegisterPeer(peer, /*is_peer_inbound=*/true, 1, 1);\n+    }\n+    FastRandomContext rc{/*fDeterministic=*/true};\n+\n+    // The target function uses caching, so we want to mimic tx repetitions\n+    // of the real-world behavior.\n+    std::vector<Wtxid> txs;\n+    for (size_t i = 0; i < 1000; i++) {\n+        txs.push_back(Wtxid::FromUint256(rc.rand256()));\n+    }\n+\n+    bench.run([&] {\n+        size_t rand_i = rand() % txs.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1503966435",
      "id" : 1503966435,
      "in_reply_to_id" : 1502598818,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZpLTj",
      "original_commit_id" : "17ae36c0f60b976c237bdb522059c31cf113c773",
      "original_line" : 34,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/bench/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1903064980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503966435/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T10:03:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1503966435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1504039991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504039991"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Do you understand why this simple op as var assignment eats so much perf? :)\r\n\r\nI don't think `std::rand()` has any quality or performance documentations, so it is free to do whatever it wants",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-02-27T10:57:13Z",
      "diff_hunk" : "@@ -0,0 +1,41 @@\n+// Copyright (c) 2020-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <net.h>\n+#include <node/txreconciliation.h>\n+\n+\n+/* Benchmarks */\n+\n+static void ShouldFanoutTo(benchmark::Bench& bench)\n+{\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+    CSipHasher hasher(frc.rand64(), frc.rand64());\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    // Register 120 inbound peers\n+    int num_peers{120};\n+    for (NodeId peer = 0; peer < num_peers; peer++) {\n+        tracker.PreRegisterPeer(peer);\n+        tracker.RegisterPeer(peer, /*is_peer_inbound=*/true, 1, 1);\n+    }\n+    FastRandomContext rc{/*fDeterministic=*/true};\n+\n+    // The target function uses caching, so we want to mimic tx repetitions\n+    // of the real-world behavior.\n+    std::vector<Wtxid> txs;\n+    for (size_t i = 0; i < 1000; i++) {\n+        txs.push_back(Wtxid::FromUint256(rc.rand256()));\n+    }\n+\n+    bench.run([&] {\n+        size_t rand_i = rand() % txs.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1504039991",
      "id" : 1504039991,
      "in_reply_to_id" : 1502598818,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ZpdQ3",
      "original_commit_id" : "17ae36c0f60b976c237bdb522059c31cf113c773",
      "original_line" : 34,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/bench/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 1903185791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504039991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T10:57:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504039991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1504998267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504998267"
         }
      },
      "author_association" : "MEMBER",
      "body" : "One follow-up improvement, all the descendants in `GetCountWithDescendants()` could be marked with `parent_fanout=true`, that way we guarantee more stringently that all the members of a chain of transactions are tx-announcement relayed through the same strategy (either erlay or low-fanout flooding). Iâll check if there is test coverage here.",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-02-27T21:12:13Z",
      "diff_hunk" : "@@ -5845,7 +5878,32 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         }\n                         if (tx_relay->m_bloom_filter && !tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(inv);\n+                        bool fanout = true;\n+                        const auto wtxid = txinfo.tx->GetWitnessHash();\n+                        if (reconciles_txs) {\n+                            auto txiter = m_mempool.GetIter(txinfo.tx->GetHash());\n+                            if (txiter) {\n+                                // If a transaction has in-mempool children, always fanout it.\n+                                // Until package relay is implemented, this is needed to avoid\n+                                // breaking parent+child relay expectations in some cases.\n+                                //\n+                                // Potentially reconciling parent+child would mean that for every\n+                                // child we need to check if any of the parents is currently\n+                                // reconciled so that the child isn't fanouted ahead. But then\n+                                // it gets tricky when reconciliation sets are full: a) the child\n+                                // can't just be added; b) removing parents from reconciliation\n+                                // sets for this one child is not good either.\n+                                if ((*txiter)->GetCountWithDescendants() <= 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1504998267",
      "id" : 1504998267,
      "line" : 5896,
      "node_id" : "PRRC_kwDOABII585ZtHN7",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 5896,
      "original_position" : 115,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 115,
      "pull_request_review_id" : 1904815825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504998267/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-27T21:12:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1504998267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1508172289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508172289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`constexpr`?",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-02-29T20:46:36Z",
      "diff_hunk" : "@@ -175,6 +175,8 @@ static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};\n static constexpr size_t MAX_ADDR_PROCESSING_TOKEN_BUCKET{MAX_ADDR_TO_SEND};\n /** The compactblocks version we support. See BIP 152. */\n static constexpr uint64_t CMPCTBLOCKS_VERSION{2};\n+/** Used to determine whether to use low-fanout flooding (or reconciliation) for a tx relay event. */\n+static const uint64_t RANDOMIZER_ID_FANOUTTARGET = 0xbac89af818407b6aULL; // SHA256(\"fanouttarget\")[0:8]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1508172289",
      "id" : 1508172289,
      "line" : 179,
      "node_id" : "PRRC_kwDOABII585Z5OIB",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 179,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1909842426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508172289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-29T20:46:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508172289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1508173354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508173354"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`FANOUTTARGET` -> `FANOUT_TARGET`?",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-02-29T20:47:27Z",
      "diff_hunk" : "@@ -175,6 +175,8 @@ static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};\n static constexpr size_t MAX_ADDR_PROCESSING_TOKEN_BUCKET{MAX_ADDR_TO_SEND};\n /** The compactblocks version we support. See BIP 152. */\n static constexpr uint64_t CMPCTBLOCKS_VERSION{2};\n+/** Used to determine whether to use low-fanout flooding (or reconciliation) for a tx relay event. */\n+static const uint64_t RANDOMIZER_ID_FANOUTTARGET = 0xbac89af818407b6aULL; // SHA256(\"fanouttarget\")[0:8]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1508173354",
      "id" : 1508173354,
      "in_reply_to_id" : 1508172289,
      "line" : 179,
      "node_id" : "PRRC_kwDOABII585Z5OYq",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 179,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1909843672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508173354/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-29T20:47:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508173354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1508189664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508189664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`std::for_each`?",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-02-29T21:01:43Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = m_tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(fanout_candidates->second.begin(), fanout_candidates->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();\n+                best_peers.emplace_back(hash_key, indexed_state.first);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1508189664",
      "id" : 1508189664,
      "line" : 295,
      "node_id" : "PRRC_kwDOABII585Z5SXg",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 295,
      "original_position" : 234,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 234,
      "pull_request_review_id" : 1909866954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508189664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-02-29T21:01:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1508189664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1509447879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1509447879"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looking on `CSipHasher`, given itâs a pseudo-random hash function, verified itâs well-initialized from two hidden random 64-bit seeds in `src/init.cpp` (`L1239`). Then we add a `CSipHasher` instance provided by `CConman` at `TxReconciliationTracker` initialization in `src/net_processing.cpp`. This respect the SipHashâs PRFâs requirement to initialize it with a random 128-bit key. I still wonder if in the future `TxReconciliationTracker` shouldnât get itâs own random seed (i.e use `GetRand()`, it promises fast entropy generation) to isolate tx-announcement from the rest of network connection management.",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-03-01T19:30:44Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = m_tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(fanout_candidates->second.begin(), fanout_candidates->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1509447879",
      "id" : 1509447879,
      "line" : 265,
      "node_id" : "PRRC_kwDOABII585Z-FjH",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 265,
      "original_position" : 204,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 204,
      "pull_request_review_id" : 1911873457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1509447879/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-01T19:33:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1509447879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1509450208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1509450208"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This variable name can be called `destination` rather than `limit` to be consistent with `ShouldFanoutTo` and denotates more clearly itâs the sample space boundary.",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-03-01T19:33:28Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1509450208",
      "id" : 1509450208,
      "line" : 255,
      "node_id" : "PRRC_kwDOABII585Z-GHg",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 255,
      "original_position" : 194,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 194,
      "pull_request_review_id" : 1911873457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1509450208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-01T19:33:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1509450208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1516808629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1516808629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the comment L66 in `src/node/txreconciliation.cpp` can be updated to reflect the usage of `m_k0` as a siphash input string for low-fanout flood peers selection. Not only used in `ComputeShortID`.",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-03-07T20:53:10Z",
      "diff_hunk" : "@@ -142,9 +250,104 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double limit) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        auto fanout_candidates = m_tx_fanout_targets_cache_data.find(wtxid);\n+        if (fanout_candidates != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(fanout_candidates->second.begin(), fanout_candidates->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction,\n+        // thus making sure that no transaction gets \"unlucky\" if every per-peer roll fails.\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // The algorithm works as follows. We iterate through the peers (of a given direction)\n+        // hashing them with the given wtxid, and sort them by this hash.\n+        // We then consider top `limit` peers to be low-fanout flood targets.\n+        // The randomness should be seeded with wtxid to return consistent results for every call.\n+\n+        // The integral part of `limit` is accounted in the higher 32 bits of the second element.\n+        // The fractional part of `limit` is stored in the lower 32 bits, and then we check\n+        // whether adding a random lower 32-bit value (first element) would end up modifying\n+        // the higher bits.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(limit * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& indexed_state : m_states) {\n+            const auto cur_state = std::get_if<TxReconciliationState>(&indexed_state.second);\n+            if (cur_state && cur_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(cur_state->m_k0).Finalize();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1516808629",
      "id" : 1516808629,
      "line" : 284,
      "node_id" : "PRRC_kwDOABII585aaKm1",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 284,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 223,
      "pull_request_review_id" : 1923513359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1516808629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-07T20:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1516808629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1534389520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1534389520"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: you could return it directly.",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-03-21T17:58:23Z",
      "diff_hunk" : "@@ -70,6 +84,16 @@ class TxReconciliationTracker::Impl\n      */\n     std::unordered_map<NodeId, std::variant<uint64_t, TxReconciliationState>> m_states GUARDED_BY(m_txreconciliation_mutex);\n \n+    TxReconciliationState* GetRegisteredPeerState(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        AssertLockHeld(m_txreconciliation_mutex);\n+        auto salt_or_state = m_states.find(peer_id);\n+        if (salt_or_state == m_states.end()) return nullptr;\n+\n+        auto* state = std::get_if<TxReconciliationState>(&salt_or_state->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1534389520",
      "id" : 1534389520,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII585bdO0Q",
      "original_commit_id" : "be8ef38d29c1b0e8b608536ec7d4ff6212ec8e83",
      "original_line" : 93,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 96,
      "pull_request_review_id" : 1953029553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1534389520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-21T17:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1534389520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1534405289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1534405289"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What does \"laggy peer\" mean?",
      "commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "created_at" : "2024-03-21T18:08:29Z",
      "diff_hunk" : "@@ -121,19 +171,77 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n+        if (is_peer_inbound && m_inbounds_count < std::numeric_limits<size_t>::max()) {\n+            ++m_inbounds_count;\n+        }\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n-    void ForgetPeer(NodeId peer_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n         AssertLockNotHeld(m_txreconciliation_mutex);\n         LOCK(m_txreconciliation_mutex);\n-        if (m_states.erase(peer_id)) {\n-            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Forget txreconciliation state of peer=%d\\n\", peer_id);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1534405289",
      "id" : 1534405289,
      "line" : 199,
      "node_id" : "PRRC_kwDOABII585bdSqp",
      "original_commit_id" : "a14dfd9c873d1e196252c77ad7a8b32bd21b6f6d",
      "original_line" : 199,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/node/txreconciliation.cpp",
      "position" : 139,
      "pull_request_review_id" : 1953049614,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28765",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1534405289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-21T18:08:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1534405289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   }
]
