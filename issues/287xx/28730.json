{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Current behaviour\r\n\r\nWriting this issue on behalf of several reported cases (see below), so the exact bitcoind specifications are different in each case.\r\n\r\nAll lightning implementation scan for the preimage in case an HTLC as to be resolved onchain. Doing this we analyse the witness data of related outputs because we know what to expect. Example for this is an offered HTLC we have to resolve onchain. Let's imagine that we locally force-closed a channel, this would lead to the following Witnessscript for the offered [HTLC](https://github.com/lightning/bolts/blob/master/03-transactions.md#offered-htlc-outputs):\r\n\r\n```\r\n# To remote node with revocation key\r\nOP_DUP OP_HASH160 <RIPEMD160(SHA256(revocationpubkey))> OP_EQUAL\r\nOP_IF\r\n    OP_CHECKSIG\r\nOP_ELSE\r\n    <remote_htlcpubkey> OP_SWAP OP_SIZE 32 OP_EQUAL\r\n    OP_NOTIF\r\n        # To local node via HTLC-timeout transaction (timelocked).\r\n        OP_DROP 2 OP_SWAP <local_htlcpubkey> 2 OP_CHECKMULTISIG\r\n    OP_ELSE\r\n        # To remote node with preimage.\r\n        OP_HASH160 <RIPEMD160(payment_hash)> OP_EQUALVERIFY\r\n        OP_CHECKSIG\r\n    OP_ENDIF\r\nOP_ENDIF\r\n```\r\nThis Script can only be unlocked by the following 3 types of [witness data](https://github.com/lightningnetwork/lnd/blob/master/contractcourt/htlc_timeout_resolver.go#L368-L370):\r\n\r\n```\r\n//  SENDR: <0> <sendr sig>  <recvr sig> <0> (2nd level timeout)\r\n//  RECVR: <recvr sig>  <preimage>\r\n//  REVOK: <revoke sig> <revoke key>\r\n```\r\n\r\nSo we can conclude that the witness data will be at least of size 2. In lnd we therefore do a check for the second witness element to be a 32 byte preimage.\r\n\r\nNow comes the problem. People reported now several times, that their lightning-node was crashing because of this behaviour. And when queried their backend with `bitcoin-cli getrawtransaction` their output did also not have the witness data populated. A reindexing of the blockchain helped I think in all cases which reported this behaviour. I am reporting this issue here because I have the feeling that somehow bitcoind might have an edge case for this behaviour (in case the hardware is not the problem).\r\n\r\nReported cases:\r\n1.https://github.com/lightningnetwork/lnd/issues/8028#issuecomment-1778777711\r\n2.https://github.com/lightningnetwork/lnd/issues/7803\r\n3.https://github.com/lightningnetwork/lnd/issues/5977\r\n4.https://github.com/lightningnetwork/lnd/issues/6381\r\n\r\nWondering whether some of you have an idea where to look at. Can I assume that a bitcoin node could only report this transaction (hence accepting it via a block) if the witness data was not provided? Otherwise we would have failed the block verification I guess?\r\n\r\nHappy to get your thoughts on this.\r\n\r\nThank you in advance!\r\n\r\n\r\n\r\n\r\n\r\n\r\n### Expected behaviour\r\n\r\nNot sure whether this is just a hardware failure which manifests itself via the above described behaviour. So no expected behaviour yet.\r\n\r\n### Steps to reproduce\r\n\r\nTBD.\r\n\r\n### Relevant log output\r\n\r\n_No response_\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nPre-built binaries\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\n-\r\n\r\n### Operating system and version\r\n\r\n-\r\n\r\n### Machine specifications\r\n\r\n_No response_",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 6,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28730/comments",
   "created_at" : "2023-10-25T14:16:25Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28730/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/28730",
   "id" : 1961538897,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "description" : null,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28730/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII58506rVR",
   "number" : 28730,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28730/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28730/timeline",
   "title" : "Empty Witness Data, although transaction has witness populated in other full-nodes",
   "updated_at" : "2023-10-25T15:47:11Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28730",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/90319354?v=4",
      "events_url" : "https://api.github.com/users/ziggie1984/events{/privacy}",
      "followers_url" : "https://api.github.com/users/ziggie1984/followers",
      "following_url" : "https://api.github.com/users/ziggie1984/following{/other_user}",
      "gists_url" : "https://api.github.com/users/ziggie1984/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/ziggie1984",
      "id" : 90319354,
      "login" : "ziggie1984",
      "node_id" : "MDQ6VXNlcjkwMzE5MzU0",
      "organizations_url" : "https://api.github.com/users/ziggie1984/orgs",
      "received_events_url" : "https://api.github.com/users/ziggie1984/received_events",
      "repos_url" : "https://api.github.com/users/ziggie1984/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/ziggie1984/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/ziggie1984/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/ziggie1984"
   }
}
