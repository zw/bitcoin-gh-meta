[
   {
      "author_association" : "MEMBER",
      "body" : "See also  \"Unbounded reorg memory usage\" #9027  about resource usage of blocks kept in memory and the wallet lagging behind too much.",
      "created_at" : "2018-09-21T22:56:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-423691783",
      "id" : 423691783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMzY5MTc4Mw==",
      "updated_at" : "2018-09-21T22:56:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/423691783",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Are you sure (1) is a regression?\r\n\r\nThe discussion in (2) isn't entirely true - if you actually fully break lockdeps (which I think is a long-term goal here, especially across validation/wallet and like is bbeing worked towards in #12934), that isn't an issue. Its only when you have circular deps and cs_main that it becomes a problem.\r\n\r\n(3) has been discussed a number of times and even had a TODO for it at some point, though I can't find it anymore. Also appears to be a dup of #9027.",
      "created_at" : "2018-09-22T14:19:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-423747313",
      "id" : 423747313,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMzc0NzMxMw==",
      "updated_at" : "2018-09-22T14:19:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/423747313",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Even if it's not a regression, the deeper SegWit activation is burried, the more strain is put on `RewindBlockIndex`. Perhaps at some depth the node should not automatically upgrade, but promt the user whether they want to do that, or if they prefer to delete and resync (probably faster), or even ignore SegWit until some later moment.",
      "created_at" : "2018-09-22T17:30:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-423760281",
      "id" : 423760281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMzc2MDI4MQ==",
      "updated_at" : "2018-09-22T17:30:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/423760281",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It's a regression. At least before a walletless, txindexless node could happily invalidate down to 0 without causing extreme memory usage. It doesn't now.  The memory usage never goes down, even after returning back to the tip.   64GB of usage is hit after invalidating only 40k blocks too.\r\n\r\n> The discussion in (2) isn't entirely true - if you actually fully break lockdeps\r\n\r\nSipa wrote \"whenever a background queue is used to break a dependency\".\r\n\r\nThe use of this to break locking dependencies is just wrong. It should not be used to break locking dependencies. Any uses of the queues for the exclusive purpose of breaking locking dependencies should be probably be removed because by definition every one of those cases results in \"unbounded\" memory usage.  (technically there may be a \"bound\" but the resulting bound is impossible to reason about without consider the total behaviour of every lock touched by every piece of code that takes the lock(s) in question-- e.g. the entire codebase).  Effectively proving that the memory usage isn't unbound is equivalent to proving that multiuse contention of the lock without the unbounded queue couldn't deadlock.\r\n\r\nAlso, as we've learned elsewhere the queue is actually pretty slow. So it may not be a suitable tool for improving performance through concurrency in many applications. It certainly shouldn't be deployed as such without benchmarks that show that it actually improves performance.",
      "created_at" : "2018-09-22T21:00:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-423773100",
      "id" : 423773100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMzc3MzEwMA==",
      "updated_at" : "2018-09-22T21:08:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/423773100",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm syncing a v0.13.0 node now on AWS (i3.2xlarge) and plan to upgrade to v0.17.0rc4 once it's near or at the tip, to see how memory behaves. (update: syncing it again because I turned it off without realizing the storage is ephemeral)",
      "created_at" : "2018-09-24T14:27:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-423994168",
      "id" : 423994168,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMzk5NDE2OA==",
      "updated_at" : "2018-09-25T07:12:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/423994168",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "After syncing v0.13 I upgraded to v0.17.0rc. It first upgraded the UTXO database as expected and then started rolling back blocks as expected.\r\n\r\nMemory uses blows up... I have a copy of the v0.13.0 database, so will try with 0.16 later and I can try fixes.\r\n\r\nCache 1.5 GB, RAM 12.9 GB at height 533K:\r\n![schermafbeelding 2018-09-25 om 21 36 18](https://user-images.githubusercontent.com/10217/46044659-b1703a00-c11b-11e8-9d65-4dde6ceba6aa.png)\r\n\r\nCache 2.4 GB, RAM 20 GB at height 527K:\r\n<img width=\"1440\" alt=\"schermafbeelding 2018-09-25 om 21 44 31\" src=\"https://user-images.githubusercontent.com/10217/46044660-b1703a00-c11b-11e8-9109-6ff8f2381ad4.png\">\r\n\r\nNo graceful stopping this either:\r\n<img width=\"460\" alt=\"schermafbeelding 2018-09-25 om 21 44 57\" src=\"https://user-images.githubusercontent.com/10217/46044662-b1703a00-c11b-11e8-8ff7-76864e7bfdd1.png\">\r\n",
      "created_at" : "2018-09-25T21:37:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-424510417",
      "id" : 424510417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNDUxMDQxNw==",
      "updated_at" : "2018-09-26T14:32:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/424510417",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Using a backup of the fully synced v0.13.0 database, I tried v0.16.3. It also first upgraded the UTXO database as expected and then started rolling back blocks as expected.\r\n\r\nCache  1.4 GB, RAM 11.2  GB at height 533K:\r\n<img width=\"2131\" alt=\"533k\" src=\"https://user-images.githubusercontent.com/10217/46087458-ab756a00-c1aa-11e8-9226-2f7a4a79580b.png\">",
      "created_at" : "2018-09-26T14:45:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-424743209",
      "id" : 424743209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNDc0MzIwOQ==",
      "updated_at" : "2018-09-26T14:45:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/424743209",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "v0.15.2 does not have this bug. It rolled back to 533K with only 3.2 GB of RAM usage (it loaded the full UTXO database during the database upgrade). It's still pretty slow, so I don't think automatic rollback is a great user experience.",
      "created_at" : "2018-09-26T18:41:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-424826227",
      "id" : 424826227,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNDgyNjIyNw==",
      "updated_at" : "2018-09-26T18:41:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/424826227",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Using a backup of the fully synced v0.13.0 database, I tried v0.16.3. It also first upgraded the UTXO database as expected and then started rolling back blocks as expected.\r\n> Cache 1.4 GB, RAM 11.2 GB at height 533K:\r\n\r\nIs that with wallet and txindex disabled?",
      "created_at" : "2018-09-26T19:21:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-424838714",
      "id" : 424838714,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNDgzODcxNA==",
      "updated_at" : "2018-09-26T19:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/424838714",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "No wallet, no indexes.",
      "created_at" : "2018-09-26T19:40:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-424844062",
      "id" : 424844062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNDg0NDA2Mg==",
      "updated_at" : "2018-09-26T19:40:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/424844062",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Which weakly indicates that this is not a regression in 0.17.0",
      "created_at" : "2018-09-26T19:56:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14289#issuecomment-424848866",
      "id" : 424848866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14289",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNDg0ODg2Ng==",
      "updated_at" : "2018-09-26T19:56:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/424848866",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
