{
   "assignee" : null,
   "assignees" : [],
   "body" : "Depends on (includes) #9289. This is what I ultimately set out to fix with the net refactor.\r\n\r\nIn my (short) tests, it cuts network latency to ~50%. In some cases, more like 30%.\r\n\r\nTest method: 1 fresh node (macbook) connected to a single other node (desktop). Testnet. Running until synced to block 10000. Results:\r\n```\r\nnew = patched with this PR.\r\nold = running #9289.\r\nclient / server\r\nold / old: 100000 in 8:05\r\nnew / old: 100000 in 3:24\r\nnew / new: 100000 in 2:16\r\n```\r\nThe results are very reproducible, always within a few seconds. Not only is it a nice improvement for the fresh node, but it compounds when its peer is running the updated code as well.\r\n\r\nI had hoped to have the abstraction complete in time for 0.14, but it looks like that's unlikely at this point. For reference, it would look something more like https://github.com/theuni/bitcoin/commit/1a6b10aea129ac363727c2d68fae809c2861e4da.\r\n\r\nAnyway, this is an attempt to fix the actual issue in time for 0.14, and putting off the last bit of refactor until after that. This addresses the issue observed in #9415, but also cleans up the nasty locking issues.\r\n\r\nI labeled this WIP because there are probably still several racy bits. Quite a bit of test-writing remains.\r\n\r\nSee the individual commits for the details. tl;dr: We currently either process a peer's message or read from their socket, but never both simultaneously. The changes here remove that restriction. ",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 14,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441/comments",
   "created_at" : "2016-12-29T08:07:21Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441",
   "id" : 197969318,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "id" : 98298007,
         "name" : "P2P",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      },
      {
         "color" : "E6F6D6",
         "default" : false,
         "id" : 135961,
         "name" : "Refactoring",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 47,
      "created_at" : "2016-06-13T14:18:51Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestone/21",
      "id" : 1823680,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/21/labels",
      "number" : 21,
      "open_issues" : 35,
      "state" : "open",
      "title" : "0.14.0",
      "updated_at" : "2017-01-06T16:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/21"
   },
   "number" : 9441,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/9441.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/9441.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Net: Massive speedup. Net locks overhaul",
   "updated_at" : "2017-01-06T15:12:03Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
      "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
      "followers_url" : "https://api.github.com/users/theuni/followers",
      "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/theuni",
      "id" : 417043,
      "login" : "theuni",
      "organizations_url" : "https://api.github.com/users/theuni/orgs",
      "received_events_url" : "https://api.github.com/users/theuni/received_events",
      "repos_url" : "https://api.github.com/users/theuni/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/theuni"
   }
}
