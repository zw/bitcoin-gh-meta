[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [theStack](https://github.com/bitcoin/bitcoin/pull/28331#pullrequestreview-1653679049), [mzumsande](https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1743939613), [Sjors](https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1744557221) |\n| Approach ACK | [jonatack](https://github.com/bitcoin/bitcoin/pull/28331#pullrequestreview-1625394283) |\n| Stale ACK | [ajtowns](https://github.com/bitcoin/bitcoin/pull/28331#pullrequestreview-1641976091), [vasild](https://github.com/bitcoin/bitcoin/pull/28331#pullrequestreview-1652460362) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#bitcoin-core/gui/754](https://github.com/bitcoin-core/gui/pull/754) (Add BIP324-specific labels to peer details by hebasto)\n* [#28464](https://github.com/bitcoin/bitcoin/pull/28464) (net: improve max-connection limits code by mzumsande)\n* [#28463](https://github.com/bitcoin/bitcoin/pull/28463) (p2p: Increase inbound capacity for block-relay only connections by mzumsande)\n* [#28155](https://github.com/bitcoin/bitcoin/pull/28155) (net: improves addnode / m_added_nodes logic by sr-gi)\n* [#27600](https://github.com/bitcoin/bitcoin/pull/27600) (net: Add new permission `forceinbound` to evict a random unprotected connection if all slots are otherwise full by pinheadmz)\n* [#27581](https://github.com/bitcoin/bitcoin/pull/27581) (net: Continuous ASMap health check by fjahr)\n* [#27114](https://github.com/bitcoin/bitcoin/pull/27114) (p2p: Allow whitelisting outgoing connections by brunoerg)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#26863](https://github.com/bitcoin/bitcoin/pull/26863) (test: merge banning test from p2p_disconnect_ban to rpc_setban by brunoerg)\n* [#26728](https://github.com/bitcoin/bitcoin/pull/26728) (wallet: Have the wallet store the key for automatically generated descriptors by achow101)\n* [#26114](https://github.com/bitcoin/bitcoin/pull/26114) (net: Make AddrFetch connections to fixed seeds by mzumsande)\n* [#25907](https://github.com/bitcoin/bitcoin/pull/25907) (wallet: rpc to add automatically generated descriptors by achow101)\n* [#22341](https://github.com/bitcoin/bitcoin/pull/22341) (rpc: add getxpub by Sjors)\n* [#20892](https://github.com/bitcoin/bitcoin/pull/20892) (tests: Run both descriptor and legacy tests within a single test invocation by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-08-24T00:25:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1690809934",
      "id" : 1690809934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585kx7ZO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1690809934/reactions"
      },
      "updated_at" : "2023-10-03T09:12:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1690809934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not needed for testing here, but it would still be cool to have a lock icon in the peers tab in the GUI, and reveal the session id if you click on it. cc @hebasto \r\n\r\nTested a manual connection between macOS and Ubuntu, found matching session ids, pfew - no man in the middle attack on my local network :-)\r\n\r\nMy DNS seed hasn't discovered any peers yet announcing the service flag, that could take a while. https://github.com/sipa/bitcoin-seeder/pull/102",
      "created_at" : "2023-08-25T11:53:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1693239025",
      "id" : 1693239025,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585k7Mbx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693239025/reactions"
      },
      "updated_at" : "2023-08-25T12:21:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693239025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors Re https://github.com/bitcoin/bitcoin/pull/28196#issuecomment-1689980940:\r\n\r\nI've changed a net debug-level log message to say \"trying v2 connection ... lastseen=...hrs\\n\"",
      "created_at" : "2023-08-29T14:07:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1697514804",
      "id" : 1697514804,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585lLgU0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697514804/reactions"
      },
      "updated_at" : "2023-08-29T14:07:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697514804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I've changed a net debug-level log message to say \"trying v2 connection ... lastseen=...hrs\\n\"\r\n\r\nNice! Though I'm not seeing that in your latest push f770273b3842e45a612cb8bb81d46e3d0883230a.",
      "created_at" : "2023-08-30T14:09:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1699262624",
      "id" : 1699262624,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585lSLCg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699262624/reactions"
      },
      "updated_at" : "2023-08-30T14:09:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699262624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors https://github.com/bitcoin/bitcoin/blob/f770273b3842e45a612cb8bb81d46e3d0883230a/src/net.cpp#L470",
      "created_at" : "2023-08-30T17:10:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1699553968",
      "id" : 1699553968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585lTSKw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699553968/reactions"
      },
      "updated_at" : "2023-08-30T17:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699553968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oh sorry, I lazy grepped for \"v2 connection\". ",
      "created_at" : "2023-08-31T08:01:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1700553281",
      "id" : 1700553281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585lXGJB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1700553281/reactions"
      },
      "updated_at" : "2023-08-31T08:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1700553281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Marked as ready for review.",
      "created_at" : "2023-09-10T15:20:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1712841353",
      "id" : 1712841353,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mF-KJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1712841353/reactions"
      },
      "updated_at" : "2023-09-10T15:20:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1712841353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-11T09:23:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1713504110",
      "id" : 1713504110,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mIf9u",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713504110/reactions"
      },
      "updated_at" : "2023-09-11T09:23:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713504110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> ... it would still be cool to have a lock icon in the peers tab in the GUI...\r\n\r\nSee https://github.com/bitcoin-core/gui/pull/754 (however, not a lock icon).",
      "created_at" : "2023-09-11T11:19:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1713679095",
      "id" : 1713679095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mJKr3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713679095/reactions"
      },
      "updated_at" : "2023-09-11T11:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713679095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1321845616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321845616"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in commit 1768aff56d6feedcb22b21df12e8926924fdac6a: this flag should also be added to the `ALL_SERVICE_FLAGS` array in `test/util/net.h`, I guess (used by fuzz tests):\r\nhttps://github.com/bitcoin/bitcoin/blob/8f7b9eb8711fdb32e8bdb59d2a7462a46c7a8086/src/test/util/net.h#L61-L68",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-11T17:12:07Z",
      "diff_hunk" : "@@ -291,6 +291,9 @@ enum ServiceFlags : uint64_t {\n     // See BIP159 for details on how this is implemented.\n     NODE_NETWORK_LIMITED = (1 << 10),\n \n+    // NODE_P2P_V2 means the node supports BIP324 transport\n+    NODE_P2P_V2 = (1 << 11),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1321845616",
      "id" : 1321845616,
      "line" : 295,
      "node_id" : "PRRC_kwDOABII585OycNw",
      "original_commit_id" : "1768aff56d6feedcb22b21df12e8926924fdac6a",
      "original_line" : 295,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 5,
      "pull_request_review_id" : 1620466774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321845616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-11T17:21:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321845616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1321852444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321852444"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in commit be8a5dcddd36be8a5f137baf3ebd32d590a0747d: Somewhere around here it might make sense to verify that v2 is indeed used by checking the new `getpeerinfo` fields (\"transport_protocol_type\" and \"session_id\") for nodes 0 and 1.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-11T17:19:13Z",
      "diff_hunk" : "@@ -0,0 +1,91 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test BIP324 v2 transport\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class P2PV2Test(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        self.nodes[0].generatetoaddress(5, \"bcrt1q0yq2azut8gn2xu3y2g0xucf8pny6w8uxmyf220\", invalid_call=False)\n+        assert_equal(self.nodes[0].getblockcount(), 5)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, True)\n+        # sync_all() verifies that the block tips match\n+        self.sync_all(self.nodes[0:2])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1321852444",
      "id" : 1321852444,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Oyd4c",
      "original_commit_id" : "be8a5dcddd36be8a5f137baf3ebd32d590a0747d",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : 35,
      "path" : "test/functional/p2p_v2.py",
      "position" : null,
      "pull_request_review_id" : 1620466774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321852444/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-11T17:21:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321852444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322583238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322583238"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Not really a fan of hard-coding default value in the code syntax. If the default was changed, this would require changing the code syntax. It would be better to hard-code the default value itself. Even best would be to not hard-code anything anywhere, which should be possible with `self.Arg<bool>(2)`, or similar.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-12T07:39:36Z",
      "diff_hunk" : "@@ -309,17 +320,21 @@ static RPCHelpMan addnode()\n     CConnman& connman = EnsureConnman(node);\n \n     std::string strNode = request.params[0].get_str();\n+    bool use_p2p_v2 = !request.params[2].isNull() && request.params[2].get_bool();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322583238",
      "id" : 1322583238,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O1QTG",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 323,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1621530741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322583238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T08:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322583238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322591734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322591734"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const bool use_p2p_v2(addrConnect.nServices & GetLocalServices() & NODE_P2P_V2);\r\n```\r\n\r\nnit: Can be written shorter",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-12T07:46:51Z",
      "diff_hunk" : "@@ -465,7 +465,11 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         }\n     }\n \n-    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"trying connection %s lastseen=%.1fhrs\\n\",\n+    // Use v2 transport when both us and them signal NODE_P2P_V2.\n+    const bool use_p2p_v2 = !!(addrConnect.nServices & GetLocalServices() & NODE_P2P_V2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322591734",
      "id" : 1322591734,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O1SX2",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 469,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1621530741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322591734/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T08:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322591734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322592221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322592221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-12T07:47:13Z",
      "diff_hunk" : "@@ -1822,6 +1894,10 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+    // The V2Transport transparently falls back to V1 behavior when an incoming V1 connection is\n+    // detected, so use it whenever we signal NODE_P2P_V2.\n+    const bool use_p2p_v2 = !!(nodeServices & NODE_P2P_V2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322592221",
      "id" : 1322592221,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O1Sfd",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 1899,
      "original_position" : 198,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1621530741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322592221/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T08:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322592221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322606364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322606364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "q in be8a5dcddd36be8a5f137baf3ebd32d590a0747d: Is it required to re-write the logic here? Seems a smaller diff would be to  replace `24` and `32`?",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-12T07:55:29Z",
      "diff_hunk" : "@@ -581,26 +586,50 @@ def restart_node(self, i, extra_args=None):\n     def wait_for_node_exit(self, i, timeout):\n         self.nodes[i].process.wait(timeout)\n \n-    def connect_nodes(self, a, b):\n+    def connect_nodes(self, a, b, peer_advertises_v2=None):\n         from_connection = self.nodes[a]\n         to_connection = self.nodes[b]\n         from_num_peers = 1 + len(from_connection.getpeerinfo())\n         to_num_peers = 1 + len(to_connection.getpeerinfo())\n         ip_port = \"127.0.0.1:\" + str(p2p_port(b))\n-        from_connection.addnode(ip_port, \"onetry\")\n+\n+        if peer_advertises_v2 is None:\n+            peer_advertises_v2 = self.options.v2transport\n+\n+        if peer_advertises_v2:\n+            from_connection.addnode(ip_port, \"onetry\", True)\n+        else:\n+            # skip the optional third argument (default false) for\n+            # compatibility with older clients\n+            from_connection.addnode(ip_port, \"onetry\")\n+\n+        min_verack_msg_bytes = 21 if peer_advertises_v2 else 24\n         # poll until version handshake complete to avoid race conditions\n         # with transaction relaying\n         # See comments in net_processing:\n         # * Must have a version message before anything else\n         # * Must have a verack message before anything else\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in to_connection.getpeerinfo()) == to_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) == 24 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) == 24 for peer in to_connection.getpeerinfo()) == to_num_peers)\n-        # The message bytes are counted before processing the message, so make\n-        # sure it was fully processed by waiting for a ping.\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 32 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 32 for peer in to_connection.getpeerinfo()) == to_num_peers)\n+        # * The message bytes are counted before processing the message, so make\n+        #   sure it was fully processed by waiting for a ping.\n+\n+        def check_initiator_handshake():\n+            peerinfo = from_connection.getpeerinfo()\n+            if len(peerinfo) != from_num_peers:\n+                return False\n+\n+            responder = list(filter(lambda x: x[\"addr\"] == ip_port, peerinfo))[0]\n+            return responder['version'] != 0 and responder['bytesrecv_per_msg'].pop('verack', 0) >= min_verack_msg_bytes and responder['bytesrecv_per_msg'].pop(\"pong\", 0) >= 29\n+\n+        def check_responder_handshake():\n+            peerinfo = to_connection.getpeerinfo()\n+            if len(peerinfo) != to_num_peers:\n+                return False\n+\n+            initiator = list(filter(lambda x: x[\"addrbind\"] == ip_port, peerinfo))[0]\n+            return initiator['version'] != 0 and initiator['bytesrecv_per_msg'].pop('verack', 0) >= min_verack_msg_bytes and initiator['bytesrecv_per_msg'].pop(\"pong\", 0) >= 29\n+\n+        self.wait_until(check_initiator_handshake)\n+        self.wait_until(check_responder_handshake)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322606364",
      "id" : 1322606364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O1V8c",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 632,
      "original_position" : 85,
      "original_start_line" : 612,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : null,
      "pull_request_review_id" : 1621530741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322606364/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-12T08:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322606364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322610190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322610190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        assert \"P2P_V2\" in network_info[\"localservicesnames\"]\r\n            \r\n```\r\n\r\nnit: Can be written shorter? Also, the full test can be removed and the two checks can be added to the p2p_v2.py test? This avoids having to spin up a node twice to call a single RPC each time.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-12T07:58:42Z",
      "diff_hunk" : "@@ -0,0 +1,32 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test v2 transport\n+\"\"\"\n+\n+from test_framework.messages import NODE_P2P_V2\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class V2TransportTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain=True\n+        self.num_nodes = 1\n+        self.extra_args = [[\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        network_info = self.nodes[0].getnetworkinfo()\n+        assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n+        if \"P2P_V2\" in network_info[\"localservicesnames\"]:\n+            raise AssertionError(\"Did not expect P2P_V2 to be signaled for a v1 node\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322610190",
      "id" : 1322610190,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O1W4O",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 23,
      "original_position" : 23,
      "original_start_line" : 22,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : null,
      "pull_request_review_id" : 1621530741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322610190/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-12T08:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322610190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322611559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322611559"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: The call is \"invalid\". `self.generate...` would be more valid.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-12T07:59:52Z",
      "diff_hunk" : "@@ -0,0 +1,91 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test BIP324 v2 transport\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class P2PV2Test(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        self.nodes[0].generatetoaddress(5, \"bcrt1q0yq2azut8gn2xu3y2g0xucf8pny6w8uxmyf220\", invalid_call=False)\n+        assert_equal(self.nodes[0].getblockcount(), 5)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, True)\n+        # sync_all() verifies that the block tips match\n+        self.sync_all(self.nodes[0:2])\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+\n+        # V1 nodes can sync with each other\n+        assert_equal(self.nodes[2].getblockcount(), 0)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        self.nodes[2].generatetoaddress(8, \"bcrt1qyr5lnc2g8aa3qa9c4th9d46n5uu4y0m9nvq2cv\", invalid_call=False)\n+        assert_equal(self.nodes[2].getblockcount(), 8)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 3, False)\n+        self.sync_all(self.nodes[2:4])\n+        assert_equal(self.nodes[3].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[2].getbestblockhash()\n+\n+        # V1 nodes can sync with V2 nodes\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 3)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 1, True)\n+        self.sync_all(self.nodes[1:3])\n+        assert_equal(self.nodes[1].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[1].getbestblockhash()\n+\n+        # V2 nodes can sync with V1 nodes\n+        self.disconnect_nodes(1, 2)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(0, 3, False)\n+        self.sync_all([self.nodes[0], self.nodes[3]])\n+        assert_equal(self.nodes[0].getblockcount(), 8)\n+\n+        # V2 node mines another block and everyone gets it\n+        self.connect_nodes(0, 1, True)\n+        self.connect_nodes(1, 2, False)\n+        self.nodes[1].generatetoaddress(1, \"bcrt1q3zsxn3qx0cqyyxgv90k7j6786mpe543wc4vy2v\", invalid_call=False)\n+        self.sync_all(self.nodes[0:4])\n+        assert_equal(self.nodes[0].getblockcount(), 9) # sync_all() verifies tip hashes match\n+\n+        # V1 node mines another block and everyone gets it\n+        self.nodes[3].generatetoaddress(2, \"bcrt1q3zsxn3qx0cqyyxgv90k7j6786mpe543wc4vy2v\", invalid_call=False)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322611559",
      "id" : 1322611559,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O1XNn",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 78,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2.py",
      "position" : null,
      "pull_request_review_id" : 1621530741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322611559/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T08:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322611559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322613818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322613818"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    def connect_nodes(self, a, b, *, peer_advertises_v2=None):\r\n```\r\n\r\noptional integral types should use named arguments",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-12T08:01:44Z",
      "diff_hunk" : "@@ -581,26 +586,50 @@ def restart_node(self, i, extra_args=None):\n     def wait_for_node_exit(self, i, timeout):\n         self.nodes[i].process.wait(timeout)\n \n-    def connect_nodes(self, a, b):\n+    def connect_nodes(self, a, b, peer_advertises_v2=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1322613818",
      "id" : 1322613818,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O1Xw6",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 589,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : null,
      "pull_request_review_id" : 1621530741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322613818/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T08:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1322613818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Couple things while testing this out:\r\n\r\n* Would be nice to have the transport type and session id also show in the GUI's peer info page\r\n* Could we log the connection version once the connection is established? Maybe once we receive their version message? The transport version can be figured out from the logs for outbound connections, but not for inbound.",
      "created_at" : "2023-09-13T18:41:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1718137057",
      "id" : 1718137057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585maLDh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718137057/reactions"
      },
      "updated_at" : "2023-09-13T18:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718137057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(deleted my last comment, forgot to add `true` to the RPC call)",
      "created_at" : "2023-09-13T19:06:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1718168633",
      "id" : 1718168633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585maSw5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718168633/reactions"
      },
      "updated_at" : "2023-09-13T19:06:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718168633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1324997532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1324997532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1fa8efaff73bda19b7e8f2e27d24b08ccf0de764: we could add something like a `-addnodev2` cli arg and then use `.m_added_v2_nodes`?\r\n\r\nAlternatively can we look the node up in our known addresses and use whatever the service flag says?",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T19:44:39Z",
      "diff_hunk" : "@@ -1077,7 +1081,11 @@ class CConnman\n         vWhitelistedRange = connOptions.vWhitelistedRange;\n         {\n             LOCK(m_added_nodes_mutex);\n-            m_added_nodes = connOptions.m_added_nodes;\n+\n+            for (const std::string& strAddedNode : connOptions.m_added_nodes) {\n+                // -addnode cli arg does not currently have a way to signal BIP324 support",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1324997532",
      "id" : 1324997532,
      "line" : 1123,
      "node_id" : "PRRC_kwDOABII585O-duc",
      "original_commit_id" : "1fa8efaff73bda19b7e8f2e27d24b08ccf0de764",
      "original_line" : 1123,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 131,
      "pull_request_review_id" : 1625319787,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1324997532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T20:12:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1324997532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325007449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325007449"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8672b854fb7a81a400150ef09e99a06c829b68f8: can you add some documentation for what this class is?",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T19:49:59Z",
      "diff_hunk" : "@@ -309,25 +309,33 @@ class CSemaphore\n     int value;\n \n public:\n-    explicit CSemaphore(int init) : value(init) {}\n+    explicit CSemaphore(int init) noexcept : value(init) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325007449",
      "id" : 1325007449,
      "line" : 316,
      "node_id" : "PRRC_kwDOABII585O-gJZ",
      "original_commit_id" : "8672b854fb7a81a400150ef09e99a06c829b68f8",
      "original_line" : 316,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 16,
      "pull_request_review_id" : 1625319787,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325007449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T20:12:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325007449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325029773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325029773"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b Nice! Only three tests fail when I enable this for _all_ tests:\r\n* p2p_node_network_limited.py\r\n* p2p_timeouts.py\r\n* rpc_net.py",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T20:12:04Z",
      "diff_hunk" : "@@ -189,6 +189,8 @@ def parse_args(self):\n         parser.add_argument(\"--randomseed\", type=int,\n                             help=\"set a random seed for deterministically reproducing a previous test run\")\n         parser.add_argument(\"--timeout-factor\", dest=\"timeout_factor\", type=float, help=\"adjust test timeouts by a factor. Setting it to 0 disables all timeouts\")\n+        parser.add_argument(\"--v2transport\", dest=\"v2transport\", default=False, action=\"store_true\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325029773",
      "id" : 1325029773,
      "line" : 192,
      "node_id" : "PRRC_kwDOABII585O-lmN",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 192,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 4,
      "pull_request_review_id" : 1625319787,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325029773/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T20:12:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325029773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325042158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325042158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that both the `AddNode()` and `RemoveAddedNode()` methods become one-liners with the change in [`7caaa9e` (#28248)](https://github.com/bitcoin/bitcoin/pull/28248/commits/7caaa9ecf4444116a0ef34f4b6e7f67b2f0f477c), if you'd like to pull it in before this change.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T20:25:35Z",
      "diff_hunk" : "@@ -3392,22 +3504,22 @@ std::vector<CAddress> CConnman::GetAddresses(CNode& requestor, size_t max_addres\n     return cache_entry.m_addrs_response_cache;\n }\n \n-bool CConnman::AddNode(const std::string& strNode)\n+bool CConnman::AddNode(const AddedNodeParams& added_node_params)\n {\n     LOCK(m_added_nodes_mutex);\n-    for (const std::string& it : m_added_nodes) {\n-        if (strNode == it) return false;\n+    for (const auto& it : m_added_nodes) {\n+        if (added_node_params.m_added_node == it.m_added_node) return false;\n     }\n \n-    m_added_nodes.push_back(strNode);\n+    m_added_nodes.push_back(added_node_params);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325042158",
      "id" : 1325042158,
      "line" : 3503,
      "node_id" : "PRRC_kwDOABII585O-onu",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 3503,
      "original_position" : 361,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 379,
      "pull_request_review_id" : 1625394283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325042158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T20:30:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325042158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">    * Would be nice to have the transport type and session id also show in the GUI's peer info page\r\n\r\nhttps://github.com/bitcoin-core/gui/pull/754",
      "created_at" : "2023-09-13T22:22:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1718391205",
      "id" : 1718391205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mbJGl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718391205/reactions"
      },
      "updated_at" : "2023-09-13T22:22:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718391205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Would be nice to have the transport type and session id also show in the GUI's peer info page\r\n\r\nAm updating `-netinfo` for bip324 / v2 p2p as well.\r\n",
      "created_at" : "2023-09-13T22:26:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1718394831",
      "id" : 1718394831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mbJ_P",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718394831/reactions"
      },
      "updated_at" : "2023-09-13T22:26:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718394831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:37:33Z",
      "diff_hunk" : "@@ -291,6 +291,9 @@ enum ServiceFlags : uint64_t {\n     // See BIP159 for details on how this is implemented.\n     NODE_NETWORK_LIMITED = (1 << 10),\n \n+    // NODE_P2P_V2 means the node supports BIP324 transport\n+    NODE_P2P_V2 = (1 << 11),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141603",
      "id" : 1325141603,
      "in_reply_to_id" : 1321845616,
      "line" : 295,
      "node_id" : "PRRC_kwDOABII585O_A5j",
      "original_commit_id" : "1768aff56d6feedcb22b21df12e8926924fdac6a",
      "original_line" : 295,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 5,
      "pull_request_review_id" : 1625548981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:37:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:37:39Z",
      "diff_hunk" : "@@ -0,0 +1,91 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test BIP324 v2 transport\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class P2PV2Test(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        self.nodes[0].generatetoaddress(5, \"bcrt1q0yq2azut8gn2xu3y2g0xucf8pny6w8uxmyf220\", invalid_call=False)\n+        assert_equal(self.nodes[0].getblockcount(), 5)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, True)\n+        # sync_all() verifies that the block tips match\n+        self.sync_all(self.nodes[0:2])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141643",
      "id" : 1325141643,
      "in_reply_to_id" : 1321852444,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_A6L",
      "original_commit_id" : "be8a5dcddd36be8a5f137baf3ebd32d590a0747d",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : 35,
      "path" : "test/functional/p2p_v2.py",
      "position" : null,
      "pull_request_review_id" : 1625549037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141643/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:37:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, used `self.Arg<bool>(2)` (which needed adding an instantiation for).",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:37:59Z",
      "diff_hunk" : "@@ -309,17 +320,21 @@ static RPCHelpMan addnode()\n     CConnman& connman = EnsureConnman(node);\n \n     std::string strNode = request.params[0].get_str();\n+    bool use_p2p_v2 = !request.params[2].isNull() && request.params[2].get_bool();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141793",
      "id" : 1325141793,
      "in_reply_to_id" : 1322583238,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_A8h",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 323,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1625549246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:37:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:38:05Z",
      "diff_hunk" : "@@ -465,7 +465,11 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         }\n     }\n \n-    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"trying connection %s lastseen=%.1fhrs\\n\",\n+    // Use v2 transport when both us and them signal NODE_P2P_V2.\n+    const bool use_p2p_v2 = !!(addrConnect.nServices & GetLocalServices() & NODE_P2P_V2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141840",
      "id" : 1325141840,
      "in_reply_to_id" : 1322591734,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_A9Q",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 469,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1625549311,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141840/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:38:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:38:10Z",
      "diff_hunk" : "@@ -1822,6 +1894,10 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+    // The V2Transport transparently falls back to V1 behavior when an incoming V1 connection is\n+    // detected, so use it whenever we signal NODE_P2P_V2.\n+    const bool use_p2p_v2 = !!(nodeServices & NODE_P2P_V2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325141884",
      "id" : 1325141884,
      "in_reply_to_id" : 1322592221,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_A98",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 1899,
      "original_position" : 198,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1625549372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141884/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325141884",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Apparently not needed, done.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:38:29Z",
      "diff_hunk" : "@@ -581,26 +586,50 @@ def restart_node(self, i, extra_args=None):\n     def wait_for_node_exit(self, i, timeout):\n         self.nodes[i].process.wait(timeout)\n \n-    def connect_nodes(self, a, b):\n+    def connect_nodes(self, a, b, peer_advertises_v2=None):\n         from_connection = self.nodes[a]\n         to_connection = self.nodes[b]\n         from_num_peers = 1 + len(from_connection.getpeerinfo())\n         to_num_peers = 1 + len(to_connection.getpeerinfo())\n         ip_port = \"127.0.0.1:\" + str(p2p_port(b))\n-        from_connection.addnode(ip_port, \"onetry\")\n+\n+        if peer_advertises_v2 is None:\n+            peer_advertises_v2 = self.options.v2transport\n+\n+        if peer_advertises_v2:\n+            from_connection.addnode(ip_port, \"onetry\", True)\n+        else:\n+            # skip the optional third argument (default false) for\n+            # compatibility with older clients\n+            from_connection.addnode(ip_port, \"onetry\")\n+\n+        min_verack_msg_bytes = 21 if peer_advertises_v2 else 24\n         # poll until version handshake complete to avoid race conditions\n         # with transaction relaying\n         # See comments in net_processing:\n         # * Must have a version message before anything else\n         # * Must have a verack message before anything else\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in to_connection.getpeerinfo()) == to_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) == 24 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) == 24 for peer in to_connection.getpeerinfo()) == to_num_peers)\n-        # The message bytes are counted before processing the message, so make\n-        # sure it was fully processed by waiting for a ping.\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 32 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 32 for peer in to_connection.getpeerinfo()) == to_num_peers)\n+        # * The message bytes are counted before processing the message, so make\n+        #   sure it was fully processed by waiting for a ping.\n+\n+        def check_initiator_handshake():\n+            peerinfo = from_connection.getpeerinfo()\n+            if len(peerinfo) != from_num_peers:\n+                return False\n+\n+            responder = list(filter(lambda x: x[\"addr\"] == ip_port, peerinfo))[0]\n+            return responder['version'] != 0 and responder['bytesrecv_per_msg'].pop('verack', 0) >= min_verack_msg_bytes and responder['bytesrecv_per_msg'].pop(\"pong\", 0) >= 29\n+\n+        def check_responder_handshake():\n+            peerinfo = to_connection.getpeerinfo()\n+            if len(peerinfo) != to_num_peers:\n+                return False\n+\n+            initiator = list(filter(lambda x: x[\"addrbind\"] == ip_port, peerinfo))[0]\n+            return initiator['version'] != 0 and initiator['bytesrecv_per_msg'].pop('verack', 0) >= min_verack_msg_bytes and initiator['bytesrecv_per_msg'].pop(\"pong\", 0) >= 29\n+\n+        self.wait_until(check_initiator_handshake)\n+        self.wait_until(check_responder_handshake)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142059",
      "id" : 1325142059,
      "in_reply_to_id" : 1322606364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_BAr",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 632,
      "original_position" : 85,
      "original_start_line" : 612,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : null,
      "pull_request_review_id" : 1625549580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142059/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:38:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142165"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, and done.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:38:40Z",
      "diff_hunk" : "@@ -0,0 +1,32 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test v2 transport\n+\"\"\"\n+\n+from test_framework.messages import NODE_P2P_V2\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class V2TransportTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain=True\n+        self.num_nodes = 1\n+        self.extra_args = [[\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        network_info = self.nodes[0].getnetworkinfo()\n+        assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n+        if \"P2P_V2\" in network_info[\"localservicesnames\"]:\n+            raise AssertionError(\"Did not expect P2P_V2 to be signaled for a v1 node\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142165",
      "id" : 1325142165,
      "in_reply_to_id" : 1322610190,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_BCV",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 23,
      "original_position" : 23,
      "original_start_line" : 22,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : null,
      "pull_request_review_id" : 1625549712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142165/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:38:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142520"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've stuck to `self.nodes[3].generate(2)` (and similarly elsewhere) because the synchronization is explicit and separate in the lines that follow.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:39:21Z",
      "diff_hunk" : "@@ -0,0 +1,91 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test BIP324 v2 transport\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class P2PV2Test(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        self.nodes[0].generatetoaddress(5, \"bcrt1q0yq2azut8gn2xu3y2g0xucf8pny6w8uxmyf220\", invalid_call=False)\n+        assert_equal(self.nodes[0].getblockcount(), 5)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, True)\n+        # sync_all() verifies that the block tips match\n+        self.sync_all(self.nodes[0:2])\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+\n+        # V1 nodes can sync with each other\n+        assert_equal(self.nodes[2].getblockcount(), 0)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        self.nodes[2].generatetoaddress(8, \"bcrt1qyr5lnc2g8aa3qa9c4th9d46n5uu4y0m9nvq2cv\", invalid_call=False)\n+        assert_equal(self.nodes[2].getblockcount(), 8)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 3, False)\n+        self.sync_all(self.nodes[2:4])\n+        assert_equal(self.nodes[3].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[2].getbestblockhash()\n+\n+        # V1 nodes can sync with V2 nodes\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 3)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 1, True)\n+        self.sync_all(self.nodes[1:3])\n+        assert_equal(self.nodes[1].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[1].getbestblockhash()\n+\n+        # V2 nodes can sync with V1 nodes\n+        self.disconnect_nodes(1, 2)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(0, 3, False)\n+        self.sync_all([self.nodes[0], self.nodes[3]])\n+        assert_equal(self.nodes[0].getblockcount(), 8)\n+\n+        # V2 node mines another block and everyone gets it\n+        self.connect_nodes(0, 1, True)\n+        self.connect_nodes(1, 2, False)\n+        self.nodes[1].generatetoaddress(1, \"bcrt1q3zsxn3qx0cqyyxgv90k7j6786mpe543wc4vy2v\", invalid_call=False)\n+        self.sync_all(self.nodes[0:4])\n+        assert_equal(self.nodes[0].getblockcount(), 9) # sync_all() verifies tip hashes match\n+\n+        # V1 node mines another block and everyone gets it\n+        self.nodes[3].generatetoaddress(2, \"bcrt1q3zsxn3qx0cqyyxgv90k7j6786mpe543wc4vy2v\", invalid_call=False)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142520",
      "id" : 1325142520,
      "in_reply_to_id" : 1322611559,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_BH4",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 78,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2.py",
      "position" : null,
      "pull_request_review_id" : 1625550211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:39:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142582"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:39:28Z",
      "diff_hunk" : "@@ -581,26 +586,50 @@ def restart_node(self, i, extra_args=None):\n     def wait_for_node_exit(self, i, timeout):\n         self.nodes[i].process.wait(timeout)\n \n-    def connect_nodes(self, a, b):\n+    def connect_nodes(self, a, b, peer_advertises_v2=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325142582",
      "id" : 1325142582,
      "in_reply_to_id" : 1322613818,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585O_BI2",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 589,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : null,
      "pull_request_review_id" : 1625550291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142582/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325142582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325143334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325143334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Possibly, but at this stage my goal is to get enough code in for basic tests and experimentation, and for that, an RPC suffices. Further on, we'll certainly want more convenient ways of interacting with this (perhaps we can treat it as a whitelist permission or so, too, but I don't want to bikeshed about that here).",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:40:56Z",
      "diff_hunk" : "@@ -1077,7 +1081,11 @@ class CConnman\n         vWhitelistedRange = connOptions.vWhitelistedRange;\n         {\n             LOCK(m_added_nodes_mutex);\n-            m_added_nodes = connOptions.m_added_nodes;\n+\n+            for (const std::string& strAddedNode : connOptions.m_added_nodes) {\n+                // -addnode cli arg does not currently have a way to signal BIP324 support",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325143334",
      "id" : 1325143334,
      "in_reply_to_id" : 1324997532,
      "line" : 1123,
      "node_id" : "PRRC_kwDOABII585O_BUm",
      "original_commit_id" : "1fa8efaff73bda19b7e8f2e27d24b08ccf0de764",
      "original_line" : 1123,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 131,
      "pull_request_review_id" : 1625551374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325143334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325143334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325143444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325143444"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've linked to the Wikipedia article about it.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T22:41:08Z",
      "diff_hunk" : "@@ -309,25 +309,33 @@ class CSemaphore\n     int value;\n \n public:\n-    explicit CSemaphore(int init) : value(init) {}\n+    explicit CSemaphore(int init) noexcept : value(init) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325143444",
      "id" : 1325143444,
      "in_reply_to_id" : 1325007449,
      "line" : 316,
      "node_id" : "PRRC_kwDOABII585O_BWU",
      "original_commit_id" : "8672b854fb7a81a400150ef09e99a06c829b68f8",
      "original_line" : 316,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 16,
      "pull_request_review_id" : 1625551523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325143444/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T22:41:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325143444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@achow101 \r\n\r\n> * Would be nice to have the transport type and session id also show in the GUI's peer info page\r\n\r\nhttps://github.com/bitcoin-core/gui/pull/754\r\n\r\n> * Could we log the connection version once the connection is established? Maybe once we receive their version message? The transport version can be figured out from the logs for outbound connections, but not for inbound.\r\n\r\nI've added logging on VERACK for both inbound and outbound (but only with -debug=net for inbound, because possible spam).\r\n\r\n@Sjors\r\n\r\n> I assume https://github.com/bitcoin/bitcoin/commit/55079fedeeca488f360d200b1d2d24c2f614bc73 will be replaced with whatever ends up merged in https://github.com/bitcoin/bitcoin/pull/28452?\r\n\r\nRebased on top of it.\r\n\r\n> Can you expand the description of https://github.com/bitcoin/bitcoin/commit/4cfbbceff35fcf22a232c66278c4ababd750d9bb a bit to explain under what circumstances PerformReconnections() is called and elaborate a bit on the various delays? Particuarly, if we tried a v2 connection and failed, how long do we wait before retrying with v1?\r\n\r\nIt should be pretty much immediately - the very next time a connection is attempted to be created.",
      "created_at" : "2023-09-13T22:43:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1718407366",
      "id" : 1718407366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mbNDG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718407366/reactions"
      },
      "updated_at" : "2023-09-13T22:43:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718407366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325160737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325160737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It can wait indeed. It's just that I have some nodes that I'd like to connect by default.",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T23:15:32Z",
      "diff_hunk" : "@@ -1077,7 +1081,11 @@ class CConnman\n         vWhitelistedRange = connOptions.vWhitelistedRange;\n         {\n             LOCK(m_added_nodes_mutex);\n-            m_added_nodes = connOptions.m_added_nodes;\n+\n+            for (const std::string& strAddedNode : connOptions.m_added_nodes) {\n+                // -addnode cli arg does not currently have a way to signal BIP324 support",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325160737",
      "id" : 1325160737,
      "in_reply_to_id" : 1324997532,
      "line" : 1123,
      "node_id" : "PRRC_kwDOABII585O_Fkh",
      "original_commit_id" : "1fa8efaff73bda19b7e8f2e27d24b08ccf0de764",
      "original_line" : 1123,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 131,
      "pull_request_review_id" : 1625577178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325160737/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T23:15:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325160737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325161965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325161965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't this wait for 60 seconds? (context: https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1718407366)",
      "commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "created_at" : "2023-09-13T23:18:00Z",
      "diff_hunk" : "@@ -2834,6 +2883,8 @@ void CConnman::ThreadOpenAddedConnections()\n         // Retry every 60 seconds if a connection was attempted, otherwise two seconds\n         if (!interruptNet.sleep_for(std::chrono::seconds(tried ? 60 : 2)))\n             return;\n+        // See if any reconnections are desired.\n+        PerformReconnections();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325161965",
      "id" : 1325161965,
      "line" : 2921,
      "node_id" : "PRRC_kwDOABII585O_F3t",
      "original_commit_id" : "f2048453190df06282e515977cd805db709c7e60",
      "original_line" : 2887,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 348,
      "pull_request_review_id" : 1625578789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325161965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T23:18:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325161965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325403945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325403945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        self.generate(self.nodes[3], 2, sync_fun=lambda: self.sync_all(self.nodes[0:4]))\r\n```\r\n\r\nnit: Can be written shorter by combining the call with the line below.\r\n\r\nThe general idea is that for each call to `generate` the dev is forced to specify which nodes are expected to be synced after the call, to make intermittent races/errors less common and assumptions easier to follow.\r\n\r\n(Same above)\r\n\r\n(My idea was to force devs to type `invalid_call`, which would make them realize that the call is considered \"invalid\", but maybe that doesn't work :sweat_smile:)",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-14T06:10:02Z",
      "diff_hunk" : "@@ -0,0 +1,136 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test v2 transport\n+\"\"\"\n+\n+from test_framework.messages import NODE_P2P_V2\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class V2TransportTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # verify local services\n+        network_info = self.nodes[2].getnetworkinfo()\n+        assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n+        assert \"P2P_V2\" not in network_info[\"localservicesnames\"]\n+        network_info = self.nodes[1].getnetworkinfo()\n+        assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, NODE_P2P_V2)\n+        assert \"P2P_V2\" in network_info[\"localservicesnames\"]\n+\n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        self.nodes[0].generate(5, invalid_call=False)\n+        assert_equal(self.nodes[0].getblockcount(), 5)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        # sync_all() verifies that the block tips match\n+        self.sync_all(self.nodes[0:2])\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+        # verify there is a v2 connection between node 0 and 1\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_1_info = self.nodes[0].getpeerinfo()\n+        assert_equal(len(node_0_info), 1)\n+        assert_equal(len(node_1_info), 1)\n+        assert_equal(node_0_info[0][\"transport_protocol_type\"], \"v2\")\n+        assert_equal(node_1_info[0][\"transport_protocol_type\"], \"v2\")\n+        assert_equal(len(node_0_info[0][\"session_id\"]), 64)\n+        assert_equal(len(node_1_info[0][\"session_id\"]), 64)\n+        assert_equal(node_0_info[0][\"session_id\"], node_1_info[0][\"session_id\"])\n+\n+        # V1 nodes can sync with each other\n+        assert_equal(self.nodes[2].getblockcount(), 0)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        self.nodes[2].generate(8, invalid_call=False)\n+        assert_equal(self.nodes[2].getblockcount(), 8)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 3, peer_advertises_v2=False)\n+        self.sync_all(self.nodes[2:4])\n+        assert_equal(self.nodes[3].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[2].getbestblockhash()\n+        # verify there is a v1 connection between node 2 and 3\n+        node_2_info = self.nodes[2].getpeerinfo()\n+        node_3_info = self.nodes[3].getpeerinfo()\n+        assert_equal(len(node_2_info), 1)\n+        assert_equal(len(node_3_info), 1)\n+        assert_equal(node_2_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(node_3_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(len(node_2_info[0][\"session_id\"]), 0)\n+        assert_equal(len(node_3_info[0][\"session_id\"]), 0)\n+\n+        # V1 nodes can sync with V2 nodes\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 3)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 1, peer_advertises_v2=True)\n+        self.sync_all(self.nodes[1:3])\n+        assert_equal(self.nodes[1].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[1].getbestblockhash()\n+        # verify there is a v1 connection between node 1 and 2\n+        node_1_info = self.nodes[1].getpeerinfo()\n+        node_2_info = self.nodes[2].getpeerinfo()\n+        assert_equal(len(node_1_info), 1)\n+        assert_equal(len(node_2_info), 1)\n+        assert_equal(node_1_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(node_2_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(len(node_1_info[0][\"session_id\"]), 0)\n+        assert_equal(len(node_2_info[0][\"session_id\"]), 0)\n+\n+        # V2 nodes can sync with V1 nodes\n+        self.disconnect_nodes(1, 2)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(0, 3, peer_advertises_v2=False)\n+        self.sync_all([self.nodes[0], self.nodes[3]])\n+        assert_equal(self.nodes[0].getblockcount(), 8)\n+        # verify there is a v1 connection between node 0 and 3\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_3_info = self.nodes[3].getpeerinfo()\n+        assert_equal(len(node_0_info), 1)\n+        assert_equal(len(node_3_info), 1)\n+        assert_equal(node_0_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(node_3_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(len(node_0_info[0][\"session_id\"]), 0)\n+        assert_equal(len(node_3_info[0][\"session_id\"]), 0)\n+\n+        # V2 node mines another block and everyone gets it\n+        self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        self.connect_nodes(1, 2, peer_advertises_v2=False)\n+        self.nodes[1].generate(1, invalid_call=False)\n+        self.sync_all(self.nodes[0:4])\n+        assert_equal(self.nodes[0].getblockcount(), 9) # sync_all() verifies tip hashes match\n+\n+        # V1 node mines another block and everyone gets it\n+        self.nodes[3].generate(2, invalid_call=False)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325403945",
      "id" : 1325403945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PAA8p",
      "original_commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "original_line" : 124,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : null,
      "pull_request_review_id" : 1625946910,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325403945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T06:15:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325403945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325406995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325406995"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n# Copyright (c) 2021-present The Bitcoin Core developers\r\n```\r\n\r\nnit: To avoid having to ever touch this file again, for new code, could use `-present`, or drop the years?",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-14T06:14:05Z",
      "diff_hunk" : "@@ -0,0 +1,136 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325406995",
      "id" : 1325406995,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PABsT",
      "original_commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "original_line" : 2,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : null,
      "pull_request_review_id" : 1625946910,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325406995/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T06:15:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325406995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-14T10:37:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1719203363",
      "id" : 1719203363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mePYj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719203363/reactions"
      },
      "updated_at" : "2023-09-14T10:37:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719203363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325850948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325850948"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you only have a `ThreadOpenAddedConnections` and no `ThreadOpenConnections`, indeed - though I think that only happens if you have a `-connect=` option.",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-14T12:08:33Z",
      "diff_hunk" : "@@ -2834,6 +2883,8 @@ void CConnman::ThreadOpenAddedConnections()\n         // Retry every 60 seconds if a connection was attempted, otherwise two seconds\n         if (!interruptNet.sleep_for(std::chrono::seconds(tried ? 60 : 2)))\n             return;\n+        // See if any reconnections are desired.\n+        PerformReconnections();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325850948",
      "id" : 1325850948,
      "in_reply_to_id" : 1325161965,
      "line" : 2921,
      "node_id" : "PRRC_kwDOABII585PBuFE",
      "original_commit_id" : "f2048453190df06282e515977cd805db709c7e60",
      "original_line" : 2921,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 348,
      "pull_request_review_id" : 1626730527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325850948/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T12:08:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325850948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325864392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325864392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ooh! I interpreted it as \"don't expect an exception to be thrown\" or so. Done.\r\n\r\nPerhaps it should be called `i_know_test_framework_generate_exists_but_dont_want_to_use_it=True` instead of `invalid_call=False`.",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-14T12:20:02Z",
      "diff_hunk" : "@@ -0,0 +1,136 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test v2 transport\n+\"\"\"\n+\n+from test_framework.messages import NODE_P2P_V2\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class V2TransportTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n+\n+    def run_test(self):\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # verify local services\n+        network_info = self.nodes[2].getnetworkinfo()\n+        assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n+        assert \"P2P_V2\" not in network_info[\"localservicesnames\"]\n+        network_info = self.nodes[1].getnetworkinfo()\n+        assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, NODE_P2P_V2)\n+        assert \"P2P_V2\" in network_info[\"localservicesnames\"]\n+\n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        self.nodes[0].generate(5, invalid_call=False)\n+        assert_equal(self.nodes[0].getblockcount(), 5)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        # sync_all() verifies that the block tips match\n+        self.sync_all(self.nodes[0:2])\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+        # verify there is a v2 connection between node 0 and 1\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_1_info = self.nodes[0].getpeerinfo()\n+        assert_equal(len(node_0_info), 1)\n+        assert_equal(len(node_1_info), 1)\n+        assert_equal(node_0_info[0][\"transport_protocol_type\"], \"v2\")\n+        assert_equal(node_1_info[0][\"transport_protocol_type\"], \"v2\")\n+        assert_equal(len(node_0_info[0][\"session_id\"]), 64)\n+        assert_equal(len(node_1_info[0][\"session_id\"]), 64)\n+        assert_equal(node_0_info[0][\"session_id\"], node_1_info[0][\"session_id\"])\n+\n+        # V1 nodes can sync with each other\n+        assert_equal(self.nodes[2].getblockcount(), 0)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        self.nodes[2].generate(8, invalid_call=False)\n+        assert_equal(self.nodes[2].getblockcount(), 8)\n+        assert_equal(self.nodes[3].getblockcount(), 0)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 3, peer_advertises_v2=False)\n+        self.sync_all(self.nodes[2:4])\n+        assert_equal(self.nodes[3].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[2].getbestblockhash()\n+        # verify there is a v1 connection between node 2 and 3\n+        node_2_info = self.nodes[2].getpeerinfo()\n+        node_3_info = self.nodes[3].getpeerinfo()\n+        assert_equal(len(node_2_info), 1)\n+        assert_equal(len(node_3_info), 1)\n+        assert_equal(node_2_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(node_3_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(len(node_2_info[0][\"session_id\"]), 0)\n+        assert_equal(len(node_3_info[0][\"session_id\"]), 0)\n+\n+        # V1 nodes can sync with V2 nodes\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(2, 3)\n+        with self.nodes[2].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(2, 1, peer_advertises_v2=True)\n+        self.sync_all(self.nodes[1:3])\n+        assert_equal(self.nodes[1].getblockcount(), 8)\n+        assert self.nodes[0].getbestblockhash() != self.nodes[1].getbestblockhash()\n+        # verify there is a v1 connection between node 1 and 2\n+        node_1_info = self.nodes[1].getpeerinfo()\n+        node_2_info = self.nodes[2].getpeerinfo()\n+        assert_equal(len(node_1_info), 1)\n+        assert_equal(len(node_2_info), 1)\n+        assert_equal(node_1_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(node_2_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(len(node_1_info[0][\"session_id\"]), 0)\n+        assert_equal(len(node_2_info[0][\"session_id\"]), 0)\n+\n+        # V2 nodes can sync with V1 nodes\n+        self.disconnect_nodes(1, 2)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[],\n+                                            unexpected_msgs=[sending_handshake, downgrading_to_v1]):\n+            self.connect_nodes(0, 3, peer_advertises_v2=False)\n+        self.sync_all([self.nodes[0], self.nodes[3]])\n+        assert_equal(self.nodes[0].getblockcount(), 8)\n+        # verify there is a v1 connection between node 0 and 3\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_3_info = self.nodes[3].getpeerinfo()\n+        assert_equal(len(node_0_info), 1)\n+        assert_equal(len(node_3_info), 1)\n+        assert_equal(node_0_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(node_3_info[0][\"transport_protocol_type\"], \"v1\")\n+        assert_equal(len(node_0_info[0][\"session_id\"]), 0)\n+        assert_equal(len(node_3_info[0][\"session_id\"]), 0)\n+\n+        # V2 node mines another block and everyone gets it\n+        self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        self.connect_nodes(1, 2, peer_advertises_v2=False)\n+        self.nodes[1].generate(1, invalid_call=False)\n+        self.sync_all(self.nodes[0:4])\n+        assert_equal(self.nodes[0].getblockcount(), 9) # sync_all() verifies tip hashes match\n+\n+        # V1 node mines another block and everyone gets it\n+        self.nodes[3].generate(2, invalid_call=False)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325864392",
      "id" : 1325864392,
      "in_reply_to_id" : 1325403945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PBxXI",
      "original_commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "original_line" : 124,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : null,
      "pull_request_review_id" : 1626751755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325864392/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T12:57:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325864392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325910272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325910272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-14T12:56:37Z",
      "diff_hunk" : "@@ -0,0 +1,136 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1325910272",
      "id" : 1325910272,
      "in_reply_to_id" : 1325406995,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PB8kA",
      "original_commit_id" : "018594ef44dc57e828a9a38c9643f85fb6c2a1e4",
      "original_line" : 2,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : null,
      "pull_request_review_id" : 1626825784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325910272/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T12:56:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325910272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "One running on ln.uk.ms, see http://ln.uk.ms/bitcoin.txt or https://be.anyone.eu.org/node-details for addresses.",
      "created_at" : "2023-09-14T14:05:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1719522412",
      "id" : 1719522412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mfdRs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719522412/reactions"
      },
      "updated_at" : "2023-09-14T23:24:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719522412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/244565?v=4",
         "events_url" : "https://api.github.com/users/jsarenik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jsarenik/followers",
         "following_url" : "https://api.github.com/users/jsarenik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jsarenik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jsarenik",
         "id" : 244565,
         "login" : "jsarenik",
         "node_id" : "MDQ6VXNlcjI0NDU2NQ==",
         "organizations_url" : "https://api.github.com/users/jsarenik/orgs",
         "received_events_url" : "https://api.github.com/users/jsarenik/received_events",
         "repos_url" : "https://api.github.com/users/jsarenik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jsarenik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jsarenik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jsarenik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326453411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326453411"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There are also other means of making outbound connections based on user input, like `-connect` or `-seednode` for which at some later point a decision must be made (make configurable / keep default at v1 / switch to v2 ).",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-14T19:58:23Z",
      "diff_hunk" : "@@ -1077,7 +1081,11 @@ class CConnman\n         vWhitelistedRange = connOptions.vWhitelistedRange;\n         {\n             LOCK(m_added_nodes_mutex);\n-            m_added_nodes = connOptions.m_added_nodes;\n+\n+            for (const std::string& strAddedNode : connOptions.m_added_nodes) {\n+                // -addnode cli arg does not currently have a way to signal BIP324 support",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326453411",
      "id" : 1326453411,
      "in_reply_to_id" : 1324997532,
      "line" : 1125,
      "node_id" : "PRRC_kwDOABII585PEBKj",
      "original_commit_id" : "1fa8efaff73bda19b7e8f2e27d24b08ccf0de764",
      "original_line" : 1125,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 131,
      "pull_request_review_id" : 1627653998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326453411/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T19:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326453411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326464080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326464080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There is also the possibility of extending the reconnection mechanism to switch to V2 when you connect using V1 to a node and they tell you they support V2.",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-14T20:10:45Z",
      "diff_hunk" : "@@ -1077,7 +1081,11 @@ class CConnman\n         vWhitelistedRange = connOptions.vWhitelistedRange;\n         {\n             LOCK(m_added_nodes_mutex);\n-            m_added_nodes = connOptions.m_added_nodes;\n+\n+            for (const std::string& strAddedNode : connOptions.m_added_nodes) {\n+                // -addnode cli arg does not currently have a way to signal BIP324 support",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326464080",
      "id" : 1326464080,
      "in_reply_to_id" : 1324997532,
      "line" : 1125,
      "node_id" : "PRRC_kwDOABII585PEDxQ",
      "original_commit_id" : "1fa8efaff73bda19b7e8f2e27d24b08ccf0de764",
      "original_line" : 1125,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 131,
      "pull_request_review_id" : 1627671406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326464080/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-14T20:10:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326464080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326488045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326488045"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "could return an error if we explicitely set the bool with the RPC command but don't have activated `-v2transport` ourselves (instead of silently downgrading to v1).",
      "commit_id" : "ead7f966b9798d74477a49dabf0b21a026b7802c",
      "created_at" : "2023-09-14T20:34:13Z",
      "diff_hunk" : "@@ -309,17 +310,21 @@ static RPCHelpMan addnode()\n     CConnman& connman = EnsureConnman(node);\n \n     std::string strNode = request.params[0].get_str();\n+    bool use_v2transport = self.Arg<bool>(2);\n \n     if (strCommand == \"onetry\")\n     {\n         CAddress addr;\n+        if (use_v2transport) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326488045",
      "id" : 1326488045,
      "line" : 328,
      "node_id" : "PRRC_kwDOABII585PEJnt",
      "original_commit_id" : "eb05c921194010e2d93c9b756440a313fd5e45d8",
      "original_line" : 328,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 1627710444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326488045/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T15:34:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326488045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326714164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326714164"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, I've started to adapt those tests for `--v2transport` support, and at least for p2p_node_network_limited.py and rpc_net.py there weren't too many changes needed (see https://github.com/theStack/bitcoin/commits/enable_v2_transport_for_more_tests).",
      "commit_id" : "0ddc8a82f2b4f9751e1f474fe1138b7488b3ed27",
      "created_at" : "2023-09-15T02:32:52Z",
      "diff_hunk" : "@@ -189,6 +189,8 @@ def parse_args(self):\n         parser.add_argument(\"--randomseed\", type=int,\n                             help=\"set a random seed for deterministically reproducing a previous test run\")\n         parser.add_argument(\"--timeout-factor\", dest=\"timeout_factor\", type=float, help=\"adjust test timeouts by a factor. Setting it to 0 disables all timeouts\")\n+        parser.add_argument(\"--v2transport\", dest=\"v2transport\", default=False, action=\"store_true\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1326714164",
      "id" : 1326714164,
      "in_reply_to_id" : 1325029773,
      "line" : 192,
      "node_id" : "PRRC_kwDOABII585PFA00",
      "original_commit_id" : "2aabbdf4de01ef1a3fb0c1bb86ef163c9fba587b",
      "original_line" : 192,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 4,
      "pull_request_review_id" : 1628106395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326714164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T02:32:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326714164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theStack Good call, that's confusing.\r\n\r\nWhat's going on is that the code only reported \"detecting\" for inbound possibly-v2 connections where the 12-byte prefix hasn't been received yet. In inbound that's more or less correct, except that peer that send non-bitcoin traffic would also get incorrectly classified as v2.\r\n\r\nI've changed it to align the transport version and the session id: only say v2 when the garbage auth packet has been completely received; before that point \"detecting\" will be reported.\r\n\r\nDiff:\r\n\r\n```diff\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -1637,15 +1637,14 @@ Transport::Info V2Transport::GetInfo() const noexcept\r\n \r\n     Transport::Info info;\r\n \r\n-    // Report DETECTING as transport type if we don't know whether the peer is V1 or V2.\r\n-    info.transport_type = m_recv_state ==\r\n-        RecvState::KEY_MAYBE_V1 ? TransportProtocolType::DETECTING : TransportProtocolType::V2;\r\n-\r\n-    // Do not report the session ID until the garbage authentication packet has been received and\r\n-    // verified (confirming that the other side very likely has the same keys as us).\r\n+    // Do not report v2 and session ID until the garbage authentication packet has been received\r\n+    // and verified (confirming that the other side very likely has the same keys as us).\r\n     if (m_recv_state != RecvState::KEY_MAYBE_V1 && m_recv_state != RecvState::KEY &&\r\n         m_recv_state != RecvState::GARB_GARBTERM && m_recv_state != RecvState::GARBAUTH) {\r\n+        info.transport_type = TransportProtocolType::V2;\r\n         info.session_id = uint256(MakeUCharSpan(m_cipher.GetSessionID()));\r\n+    } else {\r\n+        info.transport_type = TransportProtocolType::DETECTING;\r\n     }\r\n \r\n     return info;\r\n```",
      "created_at" : "2023-09-15T12:06:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1721167073",
      "id" : 1721167073,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mluzh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721167073/reactions"
      },
      "updated_at" : "2023-09-15T12:06:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721167073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\n`-v2transport` is maybe a bit too obscure from the users' point of view? Something like `-p2pencryption` may be clearer.",
      "created_at" : "2023-09-15T15:14:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1721445548",
      "id" : 1721445548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mmyys",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721445548/reactions"
      },
      "updated_at" : "2023-09-15T15:14:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721445548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild \n\n* I consider the `-v2transport` an option just for people who want to experiment with it, before it gets enabled by default.\n* I worry that advertising the feature as \"encryption\" would result in incorrect assumptions about what it achieves (which is raising costs for large-scale observers, if deployed at scale; it doesn't really protect privacy for your own actions against a deliberate attacker).",
      "created_at" : "2023-09-15T15:18:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1721451993",
      "id" : 1721451993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585mm0XZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721451993/reactions"
      },
      "updated_at" : "2023-09-15T15:20:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1721451993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1327456191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327456191"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this means that reconnections for added nodes can be made from `ThreadOpenConnections`, and reconnections for automatic connections can be performed by `ThreadOpenAddedConnections` - which seems really weird, although I don't think it breaks anything. I wonder if it makes sense to perform the respective reconnection attempts only by their designated threads.",
      "commit_id" : "ead7f966b9798d74477a49dabf0b21a026b7802c",
      "created_at" : "2023-09-15T15:25:06Z",
      "diff_hunk" : "@@ -3779,6 +3832,24 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& address) const\n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup).Finalize();\n }\n \n+void CConnman::PerformReconnections()\n+{\n+    AssertLockNotHeld(m_reconnections_mutex);\n+    AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n+    while (true) {\n+        // Move first element of m_reconnections to todo (avoiding an allocation inside the lock).\n+        decltype(m_reconnections) todo;\n+        {\n+            LOCK(m_reconnections_mutex);\n+            if (m_reconnections.empty()) break;\n+            todo.splice(todo.end(), m_reconnections, m_reconnections.begin());\n+        }\n+\n+        auto& [addr_connect, count_failure, grant, dest, conn_type] = *todo.begin();\n+        OpenNetworkConnection(addr_connect, count_failure, &grant, dest.empty() ? nullptr : dest.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1327456191",
      "id" : 1327456191,
      "line" : 3882,
      "node_id" : "PRRC_kwDOABII585PH1-_",
      "original_commit_id" : "7d2bf51b9e3b5cd14d42614cb0fbe58ff9597f1b",
      "original_line" : 3849,
      "original_position" : 149,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 365,
      "pull_request_review_id" : 1627710444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327456191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T15:36:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327456191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1327778467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327778467"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-15T20:51:51Z",
      "diff_hunk" : "@@ -309,17 +310,21 @@ static RPCHelpMan addnode()\n     CConnman& connman = EnsureConnman(node);\n \n     std::string strNode = request.params[0].get_str();\n+    bool use_v2transport = self.Arg<bool>(2);\n \n     if (strCommand == \"onetry\")\n     {\n         CAddress addr;\n+        if (use_v2transport) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1327778467",
      "id" : 1327778467,
      "in_reply_to_id" : 1326488045,
      "line" : 330,
      "node_id" : "PRRC_kwDOABII585PJEqj",
      "original_commit_id" : "eb05c921194010e2d93c9b756440a313fd5e45d8",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 59,
      "pull_request_review_id" : 1629711581,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327778467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T20:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327778467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1327790459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327790459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree it's somewhat strange, but I'm not convinced that splitting them up is better.\r\n\r\nPro current approach:\r\n* Slightly lower latency for reconnections with 2 threads considering them.\r\n* Simpler implementation.\r\n* Not entirely clear what to do with connections not created by either thread (like `addnode oneshot`, unsure if there are others). I guess they can go in the addnode thread too.\r\n\r\nPro split:\r\n* No interference between the two types. For example, if you'd configure lots of addnodes errorneously as V2, with the currently approach they'll end up slowing down normal (random) peer connection establishment.\r\n",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-15T21:08:32Z",
      "diff_hunk" : "@@ -3779,6 +3832,24 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& address) const\n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup).Finalize();\n }\n \n+void CConnman::PerformReconnections()\n+{\n+    AssertLockNotHeld(m_reconnections_mutex);\n+    AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n+    while (true) {\n+        // Move first element of m_reconnections to todo (avoiding an allocation inside the lock).\n+        decltype(m_reconnections) todo;\n+        {\n+            LOCK(m_reconnections_mutex);\n+            if (m_reconnections.empty()) break;\n+            todo.splice(todo.end(), m_reconnections, m_reconnections.begin());\n+        }\n+\n+        auto& [addr_connect, count_failure, grant, dest, conn_type] = *todo.begin();\n+        OpenNetworkConnection(addr_connect, count_failure, &grant, dest.empty() ? nullptr : dest.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1327790459",
      "id" : 1327790459,
      "in_reply_to_id" : 1327456191,
      "line" : 3878,
      "node_id" : "PRRC_kwDOABII585PJHl7",
      "original_commit_id" : "7d2bf51b9e3b5cd14d42614cb0fbe58ff9597f1b",
      "original_line" : 3878,
      "original_position" : 149,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 365,
      "pull_request_review_id" : 1629728031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327790459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T21:08:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327790459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased to retrigger CI.",
      "created_at" : "2023-09-19T09:21:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1725138119",
      "id" : 1725138119,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585m04TH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1725138119/reactions"
      },
      "updated_at" : "2023-09-19T09:21:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1725138119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329835602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329835602"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "named argument nit:\r\n```suggestion\r\n        return std::make_unique<V2Transport>(id, /*initiating=*/!inbound, SER_NETWORK, INIT_PROTO_VERSION);\r\n```",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-19T09:26:00Z",
      "diff_hunk" : "@@ -3606,6 +3617,15 @@ ServiceFlags CConnman::GetLocalServices() const\n     return nLocalServices;\n }\n \n+static std::unique_ptr<Transport> MakeTransport(NodeId id, bool use_v2transport, bool inbound) noexcept\n+{\n+    if (use_v2transport) {\n+        return std::make_unique<V2Transport>(id, !inbound, SER_NETWORK, INIT_PROTO_VERSION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329835602",
      "id" : 1329835602,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PQ65S",
      "original_commit_id" : "54544ace5e4efc40bf248c1c4de6063c104cd549",
      "original_line" : 3623,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1632814911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329835602/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-19T10:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329835602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329843899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329843899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    DETECTING, //!< peer could be v1 or v2\r\n```\r\nsince the latest change in `V2Transport::GetInfo` (introduced in https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1721167073) the DETECTING state is now used both for in- and outbound connections",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-19T09:32:56Z",
      "diff_hunk" : "@@ -79,4 +79,14 @@ enum class ConnectionType {\n /** Convert ConnectionType enum to a string value */\n std::string ConnectionTypeAsString(ConnectionType conn_type);\n \n+/** Transport layer version */\n+enum class TransportProtocolType {\n+    DETECTING, //!< Incoming connection; peer could be v1 or v2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329843899",
      "id" : 1329843899,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PQ867",
      "original_commit_id" : "0c345514b8bb0c246bebaea8d2484a205a2ae72b",
      "original_line" : 84,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/node/connection_types.h",
      "position" : null,
      "pull_request_review_id" : 1632814911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329843899/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-19T10:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329843899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329845422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329845422"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: this operator seems to be not used anywhere",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-19T09:34:17Z",
      "diff_hunk" : "@@ -270,6 +274,20 @@ class Transport {\n public:\n     virtual ~Transport() {}\n \n+    struct Info\n+    {\n+        TransportProtocolType transport_type;\n+        std::optional<uint256> session_id;\n+\n+        friend bool operator==(const Info& a, const Info& b) noexcept\n+        {\n+            return std::tie(a.transport_type, a.session_id) == std::tie(b.transport_type, b.session_id);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329845422",
      "id" : 1329845422,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PQ9Su",
      "original_commit_id" : "0c345514b8bb0c246bebaea8d2484a205a2ae72b",
      "original_line" : 285,
      "original_position" : 23,
      "original_start_line" : 282,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1632814911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329845422/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-19T10:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329845422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329847746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329847746"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could use named arguments here and below\r\n```suggestion\r\n            from_connection.addnode(node=ip_port, command=\"onetry\", v2transport=True)\r\n```",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-19T09:36:08Z",
      "diff_hunk" : "@@ -581,26 +581,33 @@ def restart_node(self, i, extra_args=None):\n     def wait_for_node_exit(self, i, timeout):\n         self.nodes[i].process.wait(timeout)\n \n-    def connect_nodes(self, a, b):\n+    def connect_nodes(self, a, b, *, peer_advertises_v2=False):\n         from_connection = self.nodes[a]\n         to_connection = self.nodes[b]\n         from_num_peers = 1 + len(from_connection.getpeerinfo())\n         to_num_peers = 1 + len(to_connection.getpeerinfo())\n         ip_port = \"127.0.0.1:\" + str(p2p_port(b))\n-        from_connection.addnode(ip_port, \"onetry\")\n+\n+        if peer_advertises_v2:\n+            from_connection.addnode(ip_port, \"onetry\", True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1329847746",
      "id" : 1329847746,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PQ93C",
      "original_commit_id" : "4a363e9754ccf2b8ab3895b081fb201cb468c48e",
      "original_line" : 592,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : null,
      "pull_request_review_id" : 1632814911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329847746/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-19T10:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329847746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331928327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-20T16:49:44Z",
      "diff_hunk" : "@@ -581,26 +581,33 @@ def restart_node(self, i, extra_args=None):\n     def wait_for_node_exit(self, i, timeout):\n         self.nodes[i].process.wait(timeout)\n \n-    def connect_nodes(self, a, b):\n+    def connect_nodes(self, a, b, *, peer_advertises_v2=False):\n         from_connection = self.nodes[a]\n         to_connection = self.nodes[b]\n         from_num_peers = 1 + len(from_connection.getpeerinfo())\n         to_num_peers = 1 + len(to_connection.getpeerinfo())\n         ip_port = \"127.0.0.1:\" + str(p2p_port(b))\n-        from_connection.addnode(ip_port, \"onetry\")\n+\n+        if peer_advertises_v2:\n+            from_connection.addnode(ip_port, \"onetry\", True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331928327",
      "id" : 1331928327,
      "in_reply_to_id" : 1329847746,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PY50H",
      "original_commit_id" : "4a363e9754ccf2b8ab3895b081fb201cb468c48e",
      "original_line" : 592,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : null,
      "pull_request_review_id" : 1636110869,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:49:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331928692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928692"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gone.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-20T16:50:02Z",
      "diff_hunk" : "@@ -270,6 +274,20 @@ class Transport {\n public:\n     virtual ~Transport() {}\n \n+    struct Info\n+    {\n+        TransportProtocolType transport_type;\n+        std::optional<uint256> session_id;\n+\n+        friend bool operator==(const Info& a, const Info& b) noexcept\n+        {\n+            return std::tie(a.transport_type, a.session_id) == std::tie(b.transport_type, b.session_id);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331928692",
      "id" : 1331928692,
      "in_reply_to_id" : 1329845422,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PY550",
      "original_commit_id" : "0c345514b8bb0c246bebaea8d2484a205a2ae72b",
      "original_line" : 285,
      "original_position" : 23,
      "original_start_line" : 282,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1636111365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928692/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:50:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331928965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-20T16:50:21Z",
      "diff_hunk" : "@@ -79,4 +79,14 @@ enum class ConnectionType {\n /** Convert ConnectionType enum to a string value */\n std::string ConnectionTypeAsString(ConnectionType conn_type);\n \n+/** Transport layer version */\n+enum class TransportProtocolType {\n+    DETECTING, //!< Incoming connection; peer could be v1 or v2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331928965",
      "id" : 1331928965,
      "in_reply_to_id" : 1329843899,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PY5-F",
      "original_commit_id" : "0c345514b8bb0c246bebaea8d2484a205a2ae72b",
      "original_line" : 84,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/node/connection_types.h",
      "position" : null,
      "pull_request_review_id" : 1636111846,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:50:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331928965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331929144"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331929144"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-20T16:50:32Z",
      "diff_hunk" : "@@ -3606,6 +3617,15 @@ ServiceFlags CConnman::GetLocalServices() const\n     return nLocalServices;\n }\n \n+static std::unique_ptr<Transport> MakeTransport(NodeId id, bool use_v2transport, bool inbound) noexcept\n+{\n+    if (use_v2transport) {\n+        return std::make_unique<V2Transport>(id, !inbound, SER_NETWORK, INIT_PROTO_VERSION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1331929144",
      "id" : 1331929144,
      "in_reply_to_id" : 1329835602,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PY6A4",
      "original_commit_id" : "54544ace5e4efc40bf248c1c4de6063c104cd549",
      "original_line" : 3623,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1636112105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331929144/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-20T16:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1331929144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-21T10:43:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1729315715",
      "id" : 1729315715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585nE0OD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1729315715/reactions"
      },
      "updated_at" : "2023-09-21T10:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1729315715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.\r\n\r\n@theStack I guess the fact that the handshake bytes are reported in the send statistics but not in the receive statistics is inconsistent. There is a simple solution, I think, namely adding a \"message\" in the `ReceivedMessageComplete` sense to be retrieved to transition from `VERSION` to `APP` state (but one with no payload, and `reject = true`), to communicate the handshake bytes to the net layer. I prefer doing this in a follow-up, though, as there may be a wider question about how to report the various types of bytes (maybe we want to classify garbage/key/version separately, and maybe we want to support reporting decoy data too).",
      "created_at" : "2023-09-22T10:41:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1731202211",
      "id" : 1731202211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585nMAyj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1731202211/reactions"
      },
      "updated_at" : "2023-09-22T10:41:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1731202211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1335786208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335786208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`struct ReconnectionInfo { ... }; std::list<ReconnectionInfo> m_reconnections;` ? If you're going to comment names for the entries, might as well actually give them names.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T12:01:09Z",
      "diff_hunk" : "@@ -1542,6 +1558,25 @@ class CConnman\n      */\n     std::queue<std::unique_ptr<i2p::sam::Session>> m_unused_i2p_sessions GUARDED_BY(m_unused_i2p_sessions_mutex);\n \n+    /**\n+     * Mutex protecting m_reconnections.\n+     */\n+    Mutex m_reconnections_mutex;\n+\n+    /**\n+     * List of reconnections we have to make.\n+     */\n+    std::list<std::tuple<\n+        CAddress /*addr_connect*/,\n+        bool /*count_failure*/,\n+        CSemaphoreGrant /*grant*/,\n+        std::string /*dest*/,\n+        ConnectionType /*conn_type*/\n+    >> m_reconnections GUARDED_BY(m_reconnections_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1335786208",
      "id" : 1335786208,
      "line" : 1591,
      "node_id" : "PRRC_kwDOABII585Pnnrg",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1575,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 202,
      "pull_request_review_id" : 1641976091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335786208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T16:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335786208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1335820022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335820022"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems a little bit complex/brittle doesn't it?\r\n\r\nThe issue I'm thinking of is that `ThreadOpenConnections` will block on `CSemaphoreGrant grant(*semOutbound)` waiting for one to disconnect and release its grant, but the peer wanting a reconnection attempt doesn't release its grant, so the thread here won't be woken up. That's okay normally though: there's slots for 8 outbounds, 2 block relay connections and a feeler/extra block relay; so usually there will be a spare slot, so the code will continue through and arrive back to the 500ms wait, then handle reconnections again. And even if they are all used up, every minute, `ThreadOpenAddedConnections` will help out, unless all the slots there are also used up.\r\n\r\nI don't think that's super problematic -- at worst I think it just performs a bit poorly, by delaying a reconnect for a minute or until your feeler/extra block relay peer gets disconnected. But mostly it feels like gating this through semaphores is just a bit too simple for what we're trying to achieve.\r\n\r\nI guess I think it would be better to drop the semaphore approach and just have a queue of \"open connection\" work, one or two (or n) threads that attempt to open connections, and then they just wake up via a condition variable to see what work there is to do (outbound, block relay, addnode, or reconnection) and do it.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T12:29:58Z",
      "diff_hunk" : "@@ -2459,6 +2505,8 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         if (!interruptNet.sleep_for(std::chrono::milliseconds(500)))\n             return;\n \n+        PerformReconnections();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1335820022",
      "id" : 1335820022,
      "line" : 2541,
      "node_id" : "PRRC_kwDOABII585Pnv72",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 2508,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 205,
      "pull_request_review_id" : 1641976091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335820022/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T16:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335820022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1335876277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335876277"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Did you consider an approach where the `CNode` object is preserved across the reconnection attempt? I guess that would involve an annoying amount of messing with `ConnectNode`. It would be nice if the peer id didn't change between the v2 and v1 connection attempts though - it's a bit awkward to correlate the two attempts when you can't just grep for `peer=nnn`",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T13:16:43Z",
      "diff_hunk" : "@@ -1917,6 +1944,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(\n+                        /*addr_connect=*/CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\n+                        /*count_failure=*/pnode->m_count_failure_after_reconnect,\n+                        /*grant=*/std::move(pnode->grantOutbound),\n+                        /*dest=*/pnode->m_dest,\n+                        /*conn_type=*/pnode->m_conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1335876277",
      "id" : 1335876277,
      "line" : 1989,
      "node_id" : "PRRC_kwDOABII585Pn9q1",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1956,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 174,
      "pull_request_review_id" : 1641976091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335876277/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T16:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1335876277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336025006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336025006"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems to be an okay way of getting addresses to try:\r\n\r\n`bitcoin-cli getnodeaddresses 10000 | jq -r '.[] | select(.services >= 2047 and .services < 4096 and .network == \"ipv4\" and .port == 8333) | .address'`\r\n\r\nGives lots of false positives though (ie, nodes that don't actually support v2, or addresses that aren't actually accepting connections).",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T15:04:25Z",
      "diff_hunk" : "@@ -52,6 +52,7 @@\n NODE_WITNESS = (1 << 3)\n NODE_COMPACT_FILTERS = (1 << 6)\n NODE_NETWORK_LIMITED = (1 << 10)\n+NODE_P2P_V2 = (1 << 11)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336025006",
      "id" : 1336025006,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585Poh-u",
      "original_commit_id" : "4988d8ef0c4073c8df4214261138817345a32d6d",
      "original_line" : 55,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/messages.py",
      "position" : 4,
      "pull_request_review_id" : 1641976091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336025006/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T16:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336025006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336030845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336030845"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder how much sense it really makes to have the `Transport` virtual class -- every `V2Transport` has a `V1Transport m_v1_fallback` member, so could just use `V2Transport` everywhere, and set `m_recv_state` and `m_send_state` to `V1` when we want v1, instead of allocating a different structure.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T15:08:59Z",
      "diff_hunk" : "@@ -3602,6 +3613,15 @@ ServiceFlags CConnman::GetLocalServices() const\n     return nLocalServices;\n }\n \n+static std::unique_ptr<Transport> MakeTransport(NodeId id, bool use_v2transport, bool inbound) noexcept\n+{\n+    if (use_v2transport) {\n+        return std::make_unique<V2Transport>(id, /*initiating=*/!inbound, SER_NETWORK, INIT_PROTO_VERSION);\n+    } else {\n+        return std::make_unique<V1Transport>(id, SER_NETWORK, INIT_PROTO_VERSION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336030845",
      "id" : 1336030845,
      "line" : 3711,
      "node_id" : "PRRC_kwDOABII585PojZ9",
      "original_commit_id" : "bcde50035e02dc0b04693423bc89a029b3468ca4",
      "original_line" : 3621,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 322,
      "pull_request_review_id" : 1641976091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336030845/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T16:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336030845",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336037214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336037214"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should you release the `m_recv_mutex` lock before taking the `m_send_mutex` lock? Presumably it shouldn't possibly matter by the time you're worrying about reconnecting, though.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T15:14:00Z",
      "diff_hunk" : "@@ -1575,13 +1576,34 @@ void V2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n \n     m_send_pos += bytes_sent;\n     Assume(m_send_pos <= m_send_buffer.size());\n+    if (m_send_pos >= CMessageHeader::HEADER_SIZE) {\n+        m_sent_v1_header_worth = true;\n+    }\n     // Wipe the buffer when everything is sent.\n     if (m_send_pos == m_send_buffer.size()) {\n         m_send_pos = 0;\n         ClearShrink(m_send_buffer);\n     }\n }\n \n+bool V2Transport::ShouldReconnectV1() const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    // Only outgoing connections need reconnection.\n+    if (!m_initiating) return false;\n+\n+    LOCK(m_recv_mutex);\n+    // Only in the very first state (where m_recv_buffer.empty() means nothing received) do\n+    // we reconnect.\n+    if (m_recv_state != RecvState::KEY) return false;\n+    // Only when nothing has been received do we reconnect.\n+    if (!m_recv_buffer.empty()) return false;\n+    // Check if we've sent enough for the other side to disconnect us (if it was V1).\n+    LOCK(m_send_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336037214",
      "id" : 1336037214,
      "line" : 1615,
      "node_id" : "PRRC_kwDOABII585Pok9e",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1603,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 95,
      "pull_request_review_id" : 1641976091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336037214/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T16:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336037214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336044983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336044983"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it worth adding a comment that removing `NODE_P2P_V2` here is what ensures it's retried as a v1 connection in `ConnectNode` ?",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T15:19:50Z",
      "diff_hunk" : "@@ -1917,6 +1944,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(\n+                        /*addr_connect=*/CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336044983",
      "id" : 1336044983,
      "line" : 1985,
      "node_id" : "PRRC_kwDOABII585Pom23",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1952,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 170,
      "pull_request_review_id" : 1641976091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336044983/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T16:22:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336044983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336075612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336075612"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: would prefer \"Attempt to connect with BIP324 v2 transport protocol\" or something similar, we usually don't know for sure if the peer actually supports it (and will downgrade if they don't).",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T15:43:18Z",
      "diff_hunk" : "@@ -289,11 +289,12 @@ static RPCHelpMan addnode()\n                 {\n                     {\"node\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The address of the peer to connect to\"},\n                     {\"command\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'add' to add a node to the list, 'remove' to remove a node from the list, 'onetry' to try a connection to the node once\"},\n+                    {\"v2transport\", RPCArg::Type::BOOL, RPCArg::Default{false}, \"Peer supports BIP324 v2 transport protocol\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336075612",
      "id" : 1336075612,
      "line" : 302,
      "node_id" : "PRRC_kwDOABII585PouVc",
      "original_commit_id" : "1ca110830801bcb0bd14b35c01d8ba6420cd3816",
      "original_line" : 292,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 35,
      "pull_request_review_id" : 1642480842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336075612/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T19:50:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336075612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336152800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336152800"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: maybe call it `m_added_node_params`? The naming becomes a bit confusing, e.g. when we loop over `m_added_nodes` to access the `m_added_node` member.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T16:46:50Z",
      "diff_hunk" : "@@ -1392,7 +1400,10 @@ class CConnman\n     const NetGroupManager& m_netgroupman;\n     std::deque<std::string> m_addr_fetches GUARDED_BY(m_addr_fetches_mutex);\n     Mutex m_addr_fetches_mutex;\n-    std::vector<std::string> m_added_nodes GUARDED_BY(m_added_nodes_mutex);\n+\n+    // connection string and whether to use v2 p2p\n+    std::vector<AddedNodeParams> m_added_nodes GUARDED_BY(m_added_nodes_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336152800",
      "id" : 1336152800,
      "line" : 1437,
      "node_id" : "PRRC_kwDOABII585PpBLg",
      "original_commit_id" : "1ca110830801bcb0bd14b35c01d8ba6420cd3816",
      "original_line" : 1405,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 179,
      "pull_request_review_id" : 1642480842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336152800/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T19:50:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336152800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336265284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336265284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "also, I think that this might lead to (temporary) overshoots in the number of connection subtypes that share `semOutbound`, for example:\r\n1) Make 8th full-relay connection using v2, get disconnected and add to `m_reconnections`.\r\n2) Make another outbound from `ThreadOpenConnections()`\r\n3) call `PerformReconnections()` and make a 9th full outbound\r\n\r\nAlthough this shouldn't be too bad since `EvictExtraOutboundPeers` should deal with this and disconnect one of the extra connections both for block-relay and full outbound case.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T18:44:36Z",
      "diff_hunk" : "@@ -1917,6 +1944,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(\n+                        /*addr_connect=*/CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\n+                        /*count_failure=*/pnode->m_count_failure_after_reconnect,\n+                        /*grant=*/std::move(pnode->grantOutbound),\n+                        /*dest=*/pnode->m_dest,\n+                        /*conn_type=*/pnode->m_conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336265284",
      "id" : 1336265284,
      "in_reply_to_id" : 1335876277,
      "line" : 1989,
      "node_id" : "PRRC_kwDOABII585PpcpE",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1956,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 174,
      "pull_request_review_id" : 1642480842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336265284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T19:50:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336265284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336305486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336305486"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok - as pointed out below it could also help resolve problems with a blocking semaphore to have another thread trying as well.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-25T19:28:15Z",
      "diff_hunk" : "@@ -3779,6 +3832,24 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& address) const\n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup).Finalize();\n }\n \n+void CConnman::PerformReconnections()\n+{\n+    AssertLockNotHeld(m_reconnections_mutex);\n+    AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n+    while (true) {\n+        // Move first element of m_reconnections to todo (avoiding an allocation inside the lock).\n+        decltype(m_reconnections) todo;\n+        {\n+            LOCK(m_reconnections_mutex);\n+            if (m_reconnections.empty()) break;\n+            todo.splice(todo.end(), m_reconnections, m_reconnections.begin());\n+        }\n+\n+        auto& [addr_connect, count_failure, grant, dest, conn_type] = *todo.begin();\n+        OpenNetworkConnection(addr_connect, count_failure, &grant, dest.empty() ? nullptr : dest.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1336305486",
      "id" : 1336305486,
      "in_reply_to_id" : 1327456191,
      "line" : 3878,
      "node_id" : "PRRC_kwDOABII585PpmdO",
      "original_commit_id" : "7d2bf51b9e3b5cd14d42614cb0fbe58ff9597f1b",
      "original_line" : 3878,
      "original_position" : 149,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 365,
      "pull_request_review_id" : 1642480842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336305486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-25T19:50:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336305486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1337847714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337847714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ajtowns I agree it would be a better to have a more integrated design for managing the creation of open connections. Do you think the code changes for that are simple enough to do something like that in this PR, or should we keep it for a follow-up improvement?",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-26T22:36:12Z",
      "diff_hunk" : "@@ -2459,6 +2505,8 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         if (!interruptNet.sleep_for(std::chrono::milliseconds(500)))\n             return;\n \n+        PerformReconnections();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1337847714",
      "id" : 1337847714,
      "in_reply_to_id" : 1335820022,
      "line" : 2541,
      "node_id" : "PRRC_kwDOABII585Pve-i",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 2508,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 205,
      "pull_request_review_id" : 1645302945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337847714/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T22:36:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337847714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1337874217"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337874217"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I did consider reusing the `CNode` object, but it seems hard to do, because in general we only construct a `CNode` object after the connection is established. I guess it would be possible to instead leave to-be-reconnected nodes in the nodes array, but it would need more substantial changes (factoring out initialization logic from the `CNode` constructor, figuring out the interaction with various special states, dealing with any code that assumes any node in the array is active, ...). This would however solve both of the mentioned issues (node id numbers changing on reconnect, and accounting of connection subtypes).\r\n\r\nJust making the `NodeId` be reused would be a much smaller change, though I'm not convinced there is no code somewhere that assumes that distinct objects use distinct ids (and it seems possible in theory that the old object survives in `m_nodes_disconnected` actually while the new one is already created?).\r\n\r\nIf possible, I'd prefer to keep this for a follow-up.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-26T23:28:05Z",
      "diff_hunk" : "@@ -1917,6 +1944,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(\n+                        /*addr_connect=*/CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\n+                        /*count_failure=*/pnode->m_count_failure_after_reconnect,\n+                        /*grant=*/std::move(pnode->grantOutbound),\n+                        /*dest=*/pnode->m_dest,\n+                        /*conn_type=*/pnode->m_conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1337874217",
      "id" : 1337874217,
      "in_reply_to_id" : 1335876277,
      "line" : 1989,
      "node_id" : "PRRC_kwDOABII585Pvlcp",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1956,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 174,
      "pull_request_review_id" : 1645340954,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337874217/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T23:28:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337874217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338017975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338017975"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems better as a follow-up to me; even if the code changes ended up being simple, thinking through all the possible edge cases seems complex enough to justify its own PR.",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-27T04:07:57Z",
      "diff_hunk" : "@@ -2459,6 +2505,8 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         if (!interruptNet.sleep_for(std::chrono::milliseconds(500)))\n             return;\n \n+        PerformReconnections();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338017975",
      "id" : 1338017975,
      "in_reply_to_id" : 1335820022,
      "line" : 2541,
      "node_id" : "PRRC_kwDOABII585PwIi3",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 2508,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 205,
      "pull_request_review_id" : 1645552137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338017975/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T04:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338017975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338082701"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338082701"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Certainly fine as a follow-up, if it's changed at all. I was thinking something along the lines of https://github.com/ajtowns/bitcoin/commits/202309-reconnect-same-cnode might be workable:\r\n\r\n```\r\n2023-09-27T06:01:39Z [net:debug] trying v2 connection XXX lastseen=0.0hrs\r\n2023-09-27T06:01:39Z [net] Added connection peer=1\r\n2023-09-27T06:01:39Z [net] sending version (103 bytes) peer=1\r\n2023-09-27T06:01:39Z [net] send version message: version 70016, blocks=162396, txrelay=1, peer=1\r\n2023-09-27T06:01:39Z [net] start sending v2 handshake to peer=1\r\n2023-09-27T06:01:39Z [net] socket closed for peer=1\r\n2023-09-27T06:01:39Z [net] disconnecting peer=1\r\n2023-09-27T06:01:39Z [net] will retry with v1 transport protocol for peer=1\r\n2023-09-27T06:01:41Z [net] reconnected with v1 transport protocol for peer=1\r\n2023-09-27T06:01:41Z [net] received: version (103 bytes) peer=1\r\n2023-09-27T06:01:41Z [net] sending wtxidrelay (0 bytes) peer=1\r\n```",
      "commit_id" : "964a8b88ef69643181e11475f03f94cc2780772e",
      "created_at" : "2023-09-27T06:04:17Z",
      "diff_hunk" : "@@ -1917,6 +1944,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(\n+                        /*addr_connect=*/CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\n+                        /*count_failure=*/pnode->m_count_failure_after_reconnect,\n+                        /*grant=*/std::move(pnode->grantOutbound),\n+                        /*dest=*/pnode->m_dest,\n+                        /*conn_type=*/pnode->m_conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338082701",
      "id" : 1338082701,
      "in_reply_to_id" : 1335876277,
      "line" : 1989,
      "node_id" : "PRRC_kwDOABII585PwYWN",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1956,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 174,
      "pull_request_review_id" : 1645660932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338082701/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T06:04:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338082701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338518276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338518276"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fair point, when starting off with this approach I think we were assuming that downgrade from V2 to V1 would happen at the `CNode` level rather than inside the transports.\r\n\r\nIt's pretty easy to address this: add a `start_v1` parameter to the `V2Transport` constructors, and change the `std::unique_ptr<Transport>` to `V2Transport`. Even if they keep deriving from `Transport`, the fact that they're `final` classes means no virtual function call overhead.\r\n\r\nStill, as long as we don't enable `-v2transport` by default though, the virtual class approach makes sure that no `V2Transport` code is active unless enabled, though at the cost of virtual function calls. I think that's fine, but it's also easy to change.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:19:47Z",
      "diff_hunk" : "@@ -3602,6 +3613,15 @@ ServiceFlags CConnman::GetLocalServices() const\n     return nLocalServices;\n }\n \n+static std::unique_ptr<Transport> MakeTransport(NodeId id, bool use_v2transport, bool inbound) noexcept\n+{\n+    if (use_v2transport) {\n+        return std::make_unique<V2Transport>(id, /*initiating=*/!inbound, SER_NETWORK, INIT_PROTO_VERSION);\n+    } else {\n+        return std::make_unique<V1Transport>(id, SER_NETWORK, INIT_PROTO_VERSION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338518276",
      "id" : 1338518276,
      "in_reply_to_id" : 1336030845,
      "line" : 3714,
      "node_id" : "PRRC_kwDOABII585PyCsE",
      "original_commit_id" : "bcde50035e02dc0b04693423bc89a029b3468ca4",
      "original_line" : 3714,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 351,
      "pull_request_review_id" : 1646326936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338518276/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:19:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338518276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338523567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338523567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this matters; the connection is already closed here, so nothing except `V2Transport::ShouldReconnectV1` should be accessing these locks anymore anyway. And if `m_recv_mutex` is released before, an overly keen code reviewer may wonder if the receive state couldn't change in between the release and the grab of `m_send_mutex`.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:24:15Z",
      "diff_hunk" : "@@ -1575,13 +1576,34 @@ void V2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n \n     m_send_pos += bytes_sent;\n     Assume(m_send_pos <= m_send_buffer.size());\n+    if (m_send_pos >= CMessageHeader::HEADER_SIZE) {\n+        m_sent_v1_header_worth = true;\n+    }\n     // Wipe the buffer when everything is sent.\n     if (m_send_pos == m_send_buffer.size()) {\n         m_send_pos = 0;\n         ClearShrink(m_send_buffer);\n     }\n }\n \n+bool V2Transport::ShouldReconnectV1() const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    // Only outgoing connections need reconnection.\n+    if (!m_initiating) return false;\n+\n+    LOCK(m_recv_mutex);\n+    // Only in the very first state (where m_recv_buffer.empty() means nothing received) do\n+    // we reconnect.\n+    if (m_recv_state != RecvState::KEY) return false;\n+    // Only when nothing has been received do we reconnect.\n+    if (!m_recv_buffer.empty()) return false;\n+    // Check if we've sent enough for the other side to disconnect us (if it was V1).\n+    LOCK(m_send_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338523567",
      "id" : 1338523567,
      "in_reply_to_id" : 1336037214,
      "line" : 1615,
      "node_id" : "PRRC_kwDOABII585PyD-v",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1615,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 95,
      "pull_request_review_id" : 1646336242,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338523567/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:24:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338523567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338542657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338542657"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:38:15Z",
      "diff_hunk" : "@@ -1542,6 +1558,25 @@ class CConnman\n      */\n     std::queue<std::unique_ptr<i2p::sam::Session>> m_unused_i2p_sessions GUARDED_BY(m_unused_i2p_sessions_mutex);\n \n+    /**\n+     * Mutex protecting m_reconnections.\n+     */\n+    Mutex m_reconnections_mutex;\n+\n+    /**\n+     * List of reconnections we have to make.\n+     */\n+    std::list<std::tuple<\n+        CAddress /*addr_connect*/,\n+        bool /*count_failure*/,\n+        CSemaphoreGrant /*grant*/,\n+        std::string /*dest*/,\n+        ConnectionType /*conn_type*/\n+    >> m_reconnections GUARDED_BY(m_reconnections_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338542657",
      "id" : 1338542657,
      "in_reply_to_id" : 1335786208,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PyIpB",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1575,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1646369871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338542657/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:38:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338542657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338547173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Listed as a potential follow-up in #27634",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:41:47Z",
      "diff_hunk" : "@@ -2459,6 +2505,8 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         if (!interruptNet.sleep_for(std::chrono::milliseconds(500)))\n             return;\n \n+        PerformReconnections();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338547173",
      "id" : 1338547173,
      "in_reply_to_id" : 1335820022,
      "line" : 2544,
      "node_id" : "PRRC_kwDOABII585PyJvl",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 2544,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 217,
      "pull_request_review_id" : 1646377317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547173/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:41:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338547506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547506"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Listed as a potential follow-up in #27634",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:42:05Z",
      "diff_hunk" : "@@ -1917,6 +1944,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(\n+                        /*addr_connect=*/CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\n+                        /*count_failure=*/pnode->m_count_failure_after_reconnect,\n+                        /*grant=*/std::move(pnode->grantOutbound),\n+                        /*dest=*/pnode->m_dest,\n+                        /*conn_type=*/pnode->m_conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338547506",
      "id" : 1338547506,
      "in_reply_to_id" : 1335876277,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PyJ0y",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1956,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1646377931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547506/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:42:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338547782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:42:18Z",
      "diff_hunk" : "@@ -1917,6 +1944,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(\n+                        /*addr_connect=*/CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338547782",
      "id" : 1338547782,
      "in_reply_to_id" : 1336044983,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PyJ5G",
      "original_commit_id" : "5917b6b5d798b18daa949f03de7c37b6038011fd",
      "original_line" : 1952,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1646378356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547782/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:42:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338547782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338548046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548046"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Listed as a potential follow-up in #27634",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:42:32Z",
      "diff_hunk" : "@@ -3602,6 +3613,15 @@ ServiceFlags CConnman::GetLocalServices() const\n     return nLocalServices;\n }\n \n+static std::unique_ptr<Transport> MakeTransport(NodeId id, bool use_v2transport, bool inbound) noexcept\n+{\n+    if (use_v2transport) {\n+        return std::make_unique<V2Transport>(id, /*initiating=*/!inbound, SER_NETWORK, INIT_PROTO_VERSION);\n+    } else {\n+        return std::make_unique<V1Transport>(id, SER_NETWORK, INIT_PROTO_VERSION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338548046",
      "id" : 1338548046,
      "in_reply_to_id" : 1336030845,
      "line" : 3714,
      "node_id" : "PRRC_kwDOABII585PyJ9O",
      "original_commit_id" : "bcde50035e02dc0b04693423bc89a029b3468ca4",
      "original_line" : 3714,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 351,
      "pull_request_review_id" : 1646378816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548046/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:42:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338548242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548242"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:42:44Z",
      "diff_hunk" : "@@ -289,11 +289,12 @@ static RPCHelpMan addnode()\n                 {\n                     {\"node\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The address of the peer to connect to\"},\n                     {\"command\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'add' to add a node to the list, 'remove' to remove a node from the list, 'onetry' to try a connection to the node once\"},\n+                    {\"v2transport\", RPCArg::Type::BOOL, RPCArg::Default{false}, \"Peer supports BIP324 v2 transport protocol\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338548242",
      "id" : 1338548242,
      "in_reply_to_id" : 1336075612,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PyKAS",
      "original_commit_id" : "1ca110830801bcb0bd14b35c01d8ba6420cd3816",
      "original_line" : 292,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1646379155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548242/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:42:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338548596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548596"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Renamed, and also renamed some related variables in other places to avoid name collisions.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-27T12:43:01Z",
      "diff_hunk" : "@@ -1392,7 +1400,10 @@ class CConnman\n     const NetGroupManager& m_netgroupman;\n     std::deque<std::string> m_addr_fetches GUARDED_BY(m_addr_fetches_mutex);\n     Mutex m_addr_fetches_mutex;\n-    std::vector<std::string> m_added_nodes GUARDED_BY(m_added_nodes_mutex);\n+\n+    // connection string and whether to use v2 p2p\n+    std::vector<AddedNodeParams> m_added_nodes GUARDED_BY(m_added_nodes_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1338548596",
      "id" : 1338548596,
      "in_reply_to_id" : 1336152800,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585PyKF0",
      "original_commit_id" : "1ca110830801bcb0bd14b35c01d8ba6420cd3816",
      "original_line" : 1405,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1646379716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548596/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T12:43:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338548596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theStack I've included your patch to not include v2 handshake bytes in the per-message-type send byte statistics, as a separate commit. I've also mentioned the idea as a potential follow-up in #27634.\r\n\r\n@real-or-random I've added a commit to mention BIP324 in `doc/bips.md`.",
      "created_at" : "2023-09-27T12:48:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1737331315",
      "id" : 1737331315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585njZJz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 3,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 3,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737331315/reactions"
      },
      "updated_at" : "2023-09-27T20:47:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737331315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340031401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340031401"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The two comments don't quite match the two conditions - the first comment mentions `m_recv_buffer.empty()` which is checked in the second condition. Maybe move `(where m_recv_buffer.empty() means nothing received)` from the first comment to the second.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-28T12:09:20Z",
      "diff_hunk" : "@@ -1567,15 +1582,40 @@ void V2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n     LOCK(m_send_mutex);\n     if (m_send_state == SendState::V1) return m_v1_fallback.MarkBytesSent(bytes_sent);\n \n+    if (m_send_state == SendState::AWAITING_KEY && m_send_pos == 0 && bytes_sent > 0) {\n+        LogPrint(BCLog::NET, \"start sending v2 handshake to peer=%d\\n\", m_nodeid);\n+    }\n+\n     m_send_pos += bytes_sent;\n     Assume(m_send_pos <= m_send_buffer.size());\n+    if (m_send_pos >= CMessageHeader::HEADER_SIZE) {\n+        m_sent_v1_header_worth = true;\n+    }\n     // Wipe the buffer when everything is sent.\n     if (m_send_pos == m_send_buffer.size()) {\n         m_send_pos = 0;\n         ClearShrink(m_send_buffer);\n     }\n }\n \n+bool V2Transport::ShouldReconnectV1() const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    // Only outgoing connections need reconnection.\n+    if (!m_initiating) return false;\n+\n+    LOCK(m_recv_mutex);\n+    // Only in the very first state (where m_recv_buffer.empty() means nothing received) do\n+    // we reconnect.\n+    if (m_recv_state != RecvState::KEY) return false;\n+    // Only when nothing has been received do we reconnect.\n+    if (!m_recv_buffer.empty()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340031401",
      "id" : 1340031401,
      "line" : 1613,
      "node_id" : "PRRC_kwDOABII585P30Gp",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1613,
      "original_position" : 93,
      "original_start_line" : 1609,
      "path" : "src/net.cpp",
      "position" : 93,
      "pull_request_review_id" : 1648656534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340031401/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1609,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T13:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340031401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340038726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340038726"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Commit 75c02891b1 `net: use V2Transport when NODE_P2P_V2 service flag is present` is somewhat broken in isolation because it would try to connect using V2 without a fallback to V1. This is later amended in commit d22f715331 `net: reconnect with V1Transport under certain conditions`. Maybe squash both into one commit?",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-28T12:14:02Z",
      "diff_hunk" : "@@ -1567,15 +1582,40 @@ void V2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n     LOCK(m_send_mutex);\n     if (m_send_state == SendState::V1) return m_v1_fallback.MarkBytesSent(bytes_sent);\n \n+    if (m_send_state == SendState::AWAITING_KEY && m_send_pos == 0 && bytes_sent > 0) {\n+        LogPrint(BCLog::NET, \"start sending v2 handshake to peer=%d\\n\", m_nodeid);\n+    }\n+\n     m_send_pos += bytes_sent;\n     Assume(m_send_pos <= m_send_buffer.size());\n+    if (m_send_pos >= CMessageHeader::HEADER_SIZE) {\n+        m_sent_v1_header_worth = true;\n+    }\n     // Wipe the buffer when everything is sent.\n     if (m_send_pos == m_send_buffer.size()) {\n         m_send_pos = 0;\n         ClearShrink(m_send_buffer);\n     }\n }\n \n+bool V2Transport::ShouldReconnectV1() const noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340038726",
      "id" : 1340038726,
      "line" : 1601,
      "node_id" : "PRRC_kwDOABII585P315G",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1601,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 81,
      "pull_request_review_id" : 1648656534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340038726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-28T13:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340038726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340069761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340069761"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might as well set `other.sem = nullptr;`.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-28T12:29:33Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340069761",
      "id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P39eB",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1648656534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340069761/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T13:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340069761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340093132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340093132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This will create a temporary object of type `ReconnectionInfo`, and will move-construct a new element in `reconnections_to_add` from the temporary. This defeats the purpose of `emplace_back()`, might as well use `push_back()`, or drop `ReconnectionInfo{`.",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-28T12:45:26Z",
      "diff_hunk" : "@@ -1906,6 +1979,20 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(ReconnectionInfo{\n+                        // Removing NODE_P2P_V2 here ensures we reconnect using V1.\n+                        .addr_connect = CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\n+                        .count_failure = pnode->m_count_failure_after_reconnect,\n+                        .grant = std::move(pnode->grantOutbound),\n+                        .destination = pnode->m_dest,\n+                        .conn_type = pnode->m_conn_type});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340093132",
      "id" : 1340093132,
      "line" : 1992,
      "node_id" : "PRRC_kwDOABII585P4DLM",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1992,
      "original_position" : 186,
      "original_start_line" : 1986,
      "path" : "src/net.cpp",
      "position" : 186,
      "pull_request_review_id" : 1648656534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340093132/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1986,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T13:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340093132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340123892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340123892"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** The pszDest argument provided to ConnectNode(). Only used for reconnections. */\r\n```",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-28T13:06:20Z",
      "diff_hunk" : "@@ -704,8 +739,12 @@ class CNode\n     // Bind address of our side of the connection\n     const CAddress addrBind;\n     const std::string m_addr_name;\n+    /** The pszDest argument provided ConnectNode(). Only used for reconnections. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340123892",
      "id" : 1340123892,
      "line" : 742,
      "node_id" : "PRRC_kwDOABII585P4Kr0",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 742,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 110,
      "pull_request_review_id" : 1648656534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340123892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-28T13:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340123892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340130617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340130617"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "When we fail to connect using V2 and succeed to connect using V1, should we bother removing `NODE_P2P_V2` for that node from addrman?",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-28T13:10:04Z",
      "diff_hunk" : "@@ -1906,6 +1979,20 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340130617",
      "id" : 1340130617,
      "line" : 1985,
      "node_id" : "PRRC_kwDOABII585P4MU5",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1985,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 179,
      "pull_request_review_id" : 1648656534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340130617/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-28T13:27:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340130617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340150936"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340150936"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't know why I don't see this warning when compiling, but only inside youcompleteme. Both should be using the same flags. Anyway, mentioning it here:\r\n\r\n> src/node/connection_types.h|17 col 12 error| Enum 'ConnectionType' uses a larger base type ('int', size: 4 bytes) than necessary for its value set, consider using 'std::uint8_t' (1 byte) as the base type to reduce its size [performance-  enum-size]    ",
      "commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "created_at" : "2023-09-28T13:22:36Z",
      "diff_hunk" : "@@ -79,4 +79,14 @@ enum class ConnectionType {\n /** Convert ConnectionType enum to a string value */\n std::string ConnectionTypeAsString(ConnectionType conn_type);\n \n+/** Transport layer version */\n+enum class TransportProtocolType {\n+    DETECTING, //!< Peer could be v1 or v2\n+    V1, //!< Unencrypted, plaintext protocol\n+    V2, //!< BIP324 protocol\n+};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340150936",
      "id" : 1340150936,
      "line" : 87,
      "node_id" : "PRRC_kwDOABII585P4RSY",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 87,
      "original_position" : 9,
      "original_start_line" : 83,
      "path" : "src/node/connection_types.h",
      "position" : 9,
      "pull_request_review_id" : 1648656534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340150936/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 83,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T13:27:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340150936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340405559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340405559"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I feel they're sufficiently distinct aspects that having them in separate commits is helpful for review. Sure, the first commit on its own may not result in exactly ideal behavior, but I also don't think it's broken.",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-28T16:29:46Z",
      "diff_hunk" : "@@ -1567,15 +1582,40 @@ void V2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n     LOCK(m_send_mutex);\n     if (m_send_state == SendState::V1) return m_v1_fallback.MarkBytesSent(bytes_sent);\n \n+    if (m_send_state == SendState::AWAITING_KEY && m_send_pos == 0 && bytes_sent > 0) {\n+        LogPrint(BCLog::NET, \"start sending v2 handshake to peer=%d\\n\", m_nodeid);\n+    }\n+\n     m_send_pos += bytes_sent;\n     Assume(m_send_pos <= m_send_buffer.size());\n+    if (m_send_pos >= CMessageHeader::HEADER_SIZE) {\n+        m_sent_v1_header_worth = true;\n+    }\n     // Wipe the buffer when everything is sent.\n     if (m_send_pos == m_send_buffer.size()) {\n         m_send_pos = 0;\n         ClearShrink(m_send_buffer);\n     }\n }\n \n+bool V2Transport::ShouldReconnectV1() const noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340405559",
      "id" : 1340405559,
      "in_reply_to_id" : 1340038726,
      "line" : 1576,
      "node_id" : "PRRC_kwDOABII585P5Pc3",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1576,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 240,
      "pull_request_review_id" : 1649267468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340405559/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-28T16:29:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340405559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340409803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340409803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That already happens; whenever an outbound peer's services are received from them, we overwrite their entry in addrman (see `m_addrman.SetServices(pfrom.addr, nServices);` line in net_processing). It's not dependent on the actual transport used for the current connection, but I don't think that incorporating that is helpful. If a peer lies about their supported services, they only hurt their own ability of being connected to.",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-28T16:32:23Z",
      "diff_hunk" : "@@ -1906,6 +1979,20 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340409803",
      "id" : 1340409803,
      "in_reply_to_id" : 1340130617,
      "line" : 1959,
      "node_id" : "PRRC_kwDOABII585P5QfL",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1959,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 337,
      "pull_request_review_id" : 1649276560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340409803/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-28T16:32:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340409803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340452505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340452505"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've rewritten the comments (and merged them into one).",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-28T17:10:13Z",
      "diff_hunk" : "@@ -1567,15 +1582,40 @@ void V2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n     LOCK(m_send_mutex);\n     if (m_send_state == SendState::V1) return m_v1_fallback.MarkBytesSent(bytes_sent);\n \n+    if (m_send_state == SendState::AWAITING_KEY && m_send_pos == 0 && bytes_sent > 0) {\n+        LogPrint(BCLog::NET, \"start sending v2 handshake to peer=%d\\n\", m_nodeid);\n+    }\n+\n     m_send_pos += bytes_sent;\n     Assume(m_send_pos <= m_send_buffer.size());\n+    if (m_send_pos >= CMessageHeader::HEADER_SIZE) {\n+        m_sent_v1_header_worth = true;\n+    }\n     // Wipe the buffer when everything is sent.\n     if (m_send_pos == m_send_buffer.size()) {\n         m_send_pos = 0;\n         ClearShrink(m_send_buffer);\n     }\n }\n \n+bool V2Transport::ShouldReconnectV1() const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    // Only outgoing connections need reconnection.\n+    if (!m_initiating) return false;\n+\n+    LOCK(m_recv_mutex);\n+    // Only in the very first state (where m_recv_buffer.empty() means nothing received) do\n+    // we reconnect.\n+    if (m_recv_state != RecvState::KEY) return false;\n+    // Only when nothing has been received do we reconnect.\n+    if (!m_recv_buffer.empty()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340452505",
      "id" : 1340452505,
      "in_reply_to_id" : 1340031401,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P5a6Z",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1587,
      "original_position" : 93,
      "original_start_line" : 1609,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1649354743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340452505/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T17:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340452505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340452828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340452828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~~Done.~~\r\n\r\nEDIT: reverted. Apparently the (existing) semantics related moving of semaphore *grants* is that the grant moves, but the associated semaphore remains.",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-28T17:10:36Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340452828",
      "id" : 1340452828,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P5a_c",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1649355304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340452828/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T22:16:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340452828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340453104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453104"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Switched to `push_back` and dropped `ReconnectionInfo{`.",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-28T17:10:52Z",
      "diff_hunk" : "@@ -1906,6 +1979,20 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.emplace_back(ReconnectionInfo{\n+                        // Removing NODE_P2P_V2 here ensures we reconnect using V1.\n+                        .addr_connect = CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\n+                        .count_failure = pnode->m_count_failure_after_reconnect,\n+                        .grant = std::move(pnode->grantOutbound),\n+                        .destination = pnode->m_dest,\n+                        .conn_type = pnode->m_conn_type});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340453104",
      "id" : 1340453104,
      "in_reply_to_id" : 1340093132,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P5bDw",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1966,
      "original_position" : 186,
      "original_start_line" : 1986,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1649355698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453104/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T17:10:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340453199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-28T17:10:59Z",
      "diff_hunk" : "@@ -704,8 +739,12 @@ class CNode\n     // Bind address of our side of the connection\n     const CAddress addrBind;\n     const std::string m_addr_name;\n+    /** The pszDest argument provided ConnectNode(). Only used for reconnections. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340453199",
      "id" : 1340453199,
      "in_reply_to_id" : 1340123892,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P5bFP",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 742,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1649355862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-28T17:10:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340453612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-28T17:11:25Z",
      "diff_hunk" : "@@ -79,4 +79,14 @@ enum class ConnectionType {\n /** Convert ConnectionType enum to a string value */\n std::string ConnectionTypeAsString(ConnectionType conn_type);\n \n+/** Transport layer version */\n+enum class TransportProtocolType {\n+    DETECTING, //!< Peer could be v1 or v2\n+    V1, //!< Unencrypted, plaintext protocol\n+    V2, //!< BIP324 protocol\n+};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1340453612",
      "id" : 1340453612,
      "in_reply_to_id" : 1340150936,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P5bLs",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 88,
      "original_position" : 9,
      "original_start_line" : 83,
      "path" : "src/node/connection_types.h",
      "position" : null,
      "pull_request_review_id" : 1649356498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453612/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-28T17:11:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1340453612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on top of #28525 as I don't think we should merge this PR without the BIP change, and this makes testing of the combined result easier.\r\n\r\nNote that this is a breaking change: earlier versions of this PR won't be able to establish v2 connections with the new version.",
      "created_at" : "2023-09-28T20:38:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1739971226",
      "id" : 1739971226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585ntdqa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739971226/reactions"
      },
      "updated_at" : "2023-09-28T22:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1739971226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Running e69f990...",
      "created_at" : "2023-09-29T07:41:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1740452851",
      "id" : 1740452851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585nvTPz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1740452851/reactions"
      },
      "updated_at" : "2023-09-29T07:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1740452851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341152648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341152648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is that necessary? I find it unexpected to leave the semaphore. Usually moved-from objects remain in some empty but valid state, e.g. as if default constructed. A semaphore grant that has a semaphore in it is not that. Did something break when you set `other.sem = nullptr`? I tried this patch:\r\n\r\n```diff\r\n@@ -390,20 +390,22 @@ public:\r\n     // Allow move.\r\n     CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\r\n     {   \r\n         sem = other.sem;\r\n         fHaveGrant = other.fHaveGrant;\r\n         other.fHaveGrant = false;\r\n+        other.sem = nullptr;\r\n     }\r\n     \r\n     CSemaphoreGrant& operator=(CSemaphoreGrant&& other) noexcept\r\n     {   \r\n         Release();\r\n         sem = other.sem;\r\n         fHaveGrant = other.fHaveGrant;\r\n         other.fHaveGrant = false;\r\n+        other.sem = nullptr;\r\n         return *this;\r\n     }\r\n```\r\n\r\nand both unit tests and functional tests passed. I think the moved-from semaphore grant is not used after the move and is destroyed shortly afterwards.",
      "commit_id" : "e69f990618e489b9576cd50c312afa0f99db2c10",
      "created_at" : "2023-09-29T09:52:33Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341152648",
      "id" : 1341152648,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P8F2I",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1650446579,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341152648/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T09:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341152648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341260059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341260059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It very quickly crashes on normal mainnet for me with this patch, possibly because it's related to automatic connections which aren't used in the functional test framework.\n\nI do want to investigate more what's actually necessary here, because I agree that relying on the state of a moved-from object is strange.",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T11:39:10Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341260059",
      "id" : 1341260059,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P8gEb",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1650609000,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341260059/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T11:39:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341260059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341327680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341327680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "af8a90d0c27c3b0787b66094e7db6662596bed71 test seems unrelated to this commit and probably could have been introduced earlier in 9b378d3093a3c7ae3c944e469faf5bea67459b07.",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T12:52:32Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-present The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test v2 transport\n+\"\"\"\n+\n+from test_framework.messages import NODE_P2P_V2\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class V2TransportTest(BitcoinTestFramework):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341327680",
      "id" : 1341327680,
      "line" : 13,
      "node_id" : "PRRC_kwDOABII585P8wlA",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 13,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : 13,
      "pull_request_review_id" : 1650718473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341327680/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T16:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341327680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341336060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341336060"
         }
      },
      "author_association" : "MEMBER",
      "body" : "af8a90d0c27c3b0787b66094e7db6662596bed71: isn't it usually (always?) the case that either `addrConnect` _or_ `pszDest` is provided by the caller? In which case this wouldn't do anything, but it's not harmful.\r\n\r\ncc @vasild who added this in #23077.",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T13:00:47Z",
      "diff_hunk" : "@@ -472,7 +472,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341336060",
      "id" : 1341336060,
      "line" : 475,
      "node_id" : "PRRC_kwDOABII585P8yn8",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 475,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 1650718473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341336060/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T16:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341336060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341578475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341578475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`ThreadOpenAddedConnections` creates a `CSemaphoreGrant` before it loops over `vInfo`. Maybe that causes problems for a subsequent item? This function seems to relate to manually added connections.\r\n\r\nMost functional tests use the `onetry` command when they call `addnode`, which calls `OpenNetworkConnection` directly. Except for `rpc_net.py` which uses `add`, but it's never trying more than 1 node at a time.\r\n\r\nI'm able to illustrate the crash by modifying the above test to add a second peer connection: https://github.com/Sjors/bitcoin/commit/0079c5143a4efc50a016e970bcedbbf6eca79007 (and lowering the wait in `ThreadOpenAddedConnections` and having the test wait a bit)",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T16:29:12Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341578475",
      "id" : 1341578475,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P9tzr",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1650718473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341578475/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T16:32:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341578475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341590904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341590904"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"in which case this wouldn't do anything\" -> what is the \"this\" referring to?",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T16:42:55Z",
      "diff_hunk" : "@@ -472,7 +472,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341590904",
      "id" : 1341590904,
      "in_reply_to_id" : 1341336060,
      "line" : 475,
      "node_id" : "PRRC_kwDOABII585P9w14",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 475,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 1651149686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341590904/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T16:42:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341590904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341603742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341603742"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> either addrConnect or pszDest is provided by the caller\r\n\r\nThat used to be the case before this PR. This PR changes that to pass information via both params. I do not like this as I find it confusing but I did not bother mentioning it as too minor and subjective and I did not see a clear better way. Now that this has been raised already:\r\n\r\nThis PR uses `addrConnect` to pass the service flags even if the address to connect to is in `pszDest`. Can this be improved? Maybe instead of `pzsDest` pass `struct X { const char* dest, ServiceFlags services}`? And then pass `std::variant` of either `CAddress` or `X` (one argument instead of two).",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T16:58:05Z",
      "diff_hunk" : "@@ -472,7 +472,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341603742",
      "id" : 1341603742,
      "in_reply_to_id" : 1341336060,
      "line" : 475,
      "node_id" : "PRRC_kwDOABII585P9z-e",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 475,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 1651170038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341603742/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T16:58:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341603742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341621796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341621796"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, so the code in `CConnman::ThreadOpenAddedConnections()` acquires the grant once and then opens connections to all entries in `vInfo`. Is this intended? Looks like a bug to me. It might as well exceed `MAX_ADDNODE_CONNECTIONS`. Unrelated to this PR, but should it acquire the grant inside the `for (const AddedNodeInfo& info : vInfo) {` loop?",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T17:10:39Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341621796",
      "id" : 1341621796,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P94Yk",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1651198103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341621796/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T17:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341621796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341628661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341628661"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Wouldn't [`grant.TryAcquire()`](https://github.com/sipa/bitcoin/blob/ee80555c30eb18bec8fc30ba4679f55464878074/src/net.cpp#L2872) inside the for loop fail and `break` once we reach `MAX_ADDNODE_CONNECTIONS`?",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T17:19:15Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341628661",
      "id" : 1341628661,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P96D1",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1651209365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341628661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T17:19:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341628661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341635479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341635479"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@vasild Agree. The code is fine at the moment, because passing `&grant` into `OpenNetworkConnections` at most only releases our grant, without invalidating it. Changing it to invalidate the grant makes our next addnode attempt fail due to reusing an invalid object.\r\n\r\n(There's no bug here I think -- if we hid max addnode connections, the `grant.TryAcquire()` will fail and we'll break out of the loop. Moving it into the loop as `CSemaphoreGrant grant(*semAddNode, /*fTry=*/tried);` would work, I think)",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T17:26:47Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341635479",
      "id" : 1341635479,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P97uX",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1651219657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341635479/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T17:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341635479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341652305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341652305"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, I did not see the `TryAcquire()` call :facepalm:, no bug in master.\r\n\r\nNow the question that is relevant to this PR: what about moving the grant creation inside the `for` loop:\r\n\r\n```diff\r\n--- i/src/net.cpp\r\n+++ w/src/net.cpp\r\n@@ -2861,18 +2861,18 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\r\n void CConnman::ThreadOpenAddedConnections()\r\n {   \r\n     AssertLockNotHeld(m_unused_i2p_sessions_mutex);\r\n     AssertLockNotHeld(m_reconnections_mutex);\r\n     while (true)\r\n     {\r\n-        CSemaphoreGrant grant(*semAddnode);\r\n         std::vector<AddedNodeInfo> vInfo = GetAddedNodeInfo();\r\n         bool tried = false;\r\n         for (const AddedNodeInfo& info : vInfo) {\r\n             if (!info.fConnected) {\r\n-                if (!grant.TryAcquire()) {\r\n+                CSemaphoreGrant grant(*semAddnode, /*fTry=*/true);\r\n+                if (!grant) {\r\n                     // If we've used up our semaphore and need a new one, let's not wait here since while we are waiti\r\n                     // the addednodeinfo state might change.\r\n                     break;\r\n                 }\r\n```\r\n\r\nand having the move semantic (more naturally) leave the moved-from object in a default-constructed state (have grant=false, sem=null)?",
      "commit_id" : "ee80555c30eb18bec8fc30ba4679f55464878074",
      "created_at" : "2023-09-29T17:48:08Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341652305",
      "id" : 1341652305,
      "in_reply_to_id" : 1340069761,
      "line" : 396,
      "node_id" : "PRRC_kwDOABII585P9_1R",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 396,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : 97,
      "pull_request_review_id" : 1651247280,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341652305/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 391,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T17:48:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341652305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341677408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341677408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've re-introduced the `other.sem = nullptr;` statements in the move constructor/assignment, and made the corresponding fix in `ThreadOpenAddedConnections` too. I've also refactored the semaphore modernization commit a bit more to get rid of the pointers and use rvalue reference instead when moving is intended (to make it clearer when a variable shouldn't be used anymore).",
      "commit_id" : "bc591d42d00b91482989bbbb07f2c03c8e2bbb52",
      "created_at" : "2023-09-29T18:21:12Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341677408",
      "id" : 1341677408,
      "in_reply_to_id" : 1340069761,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P-F9g",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 397,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1651289304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341677408/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T18:21:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341677408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341678508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341678508"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@Sjors Thanks a lot for reproducing the error. It helped locate the issue, and I used it to confirm the code I just pushed fixes the problem. Would you mind adding the test as a separate PR, if possible?",
      "commit_id" : "bc591d42d00b91482989bbbb07f2c03c8e2bbb52",
      "created_at" : "2023-09-29T18:22:31Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341678508",
      "id" : 1341678508,
      "in_reply_to_id" : 1340069761,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P-GOs",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 397,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1651291013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341678508/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-29T18:22:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341678508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341678891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341678891"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, done.",
      "commit_id" : "bc591d42d00b91482989bbbb07f2c03c8e2bbb52",
      "created_at" : "2023-09-29T18:22:54Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021-present The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test v2 transport\n+\"\"\"\n+\n+from test_framework.messages import NODE_P2P_V2\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+class V2TransportTest(BitcoinTestFramework):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341678891",
      "id" : 1341678891,
      "in_reply_to_id" : 1341327680,
      "line" : 13,
      "node_id" : "PRRC_kwDOABII585P-GUr",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 13,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : 13,
      "pull_request_review_id" : 1651291635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341678891/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T18:22:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341678891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341683278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341683278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with making a change like this, but I fear the scope of that could easily grow too large for this PR. There are several other places in the network code where this \"string name or CAddress\" variant concept exist, and if we're going to introduce a variant type or something similar for that, I'd prefer for it to be done everywhere. It is also relevant for #28155 (@sr-gi) I think.\r\n\r\nIf you feel the mixing of the two argument is a problem in this PR, what about the more narrow change of adding a `use_v2transport` boolean argument to `ConnectNode` and `OpenNetworkConnection` instead, and ignoring the `addrConnect.nServices` field?",
      "commit_id" : "bc591d42d00b91482989bbbb07f2c03c8e2bbb52",
      "created_at" : "2023-09-29T18:27:59Z",
      "diff_hunk" : "@@ -472,7 +472,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341683278",
      "id" : 1341683278,
      "in_reply_to_id" : 1341336060,
      "line" : 475,
      "node_id" : "PRRC_kwDOABII585P-HZO",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 475,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 1651298244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341683278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-29T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341683278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341919793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341919793"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">  what is the \"this\" referring to?\r\n\r\nSetting it to `addrConnect.nServices` instead of leaving the default initialized `NODE_NONE`.\r\n\r\n> This PR changes that to pass information via both params. I do not like this\r\n\r\nAh, I didn't notice that. No strong opinion but in that case I think we should document the `pszDest` and `addrConnect ` arguments of `ConnectNode` and `OpenNetworkConnection`.\r\n\r\n> adding a `use_v2transport` boolean argument to `ConnectNode` and `OpenNetworkConnection` instead\r\n\r\nThat sounds good.",
      "commit_id" : "bc591d42d00b91482989bbbb07f2c03c8e2bbb52",
      "created_at" : "2023-09-30T06:49:25Z",
      "diff_hunk" : "@@ -472,7 +472,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341919793",
      "id" : 1341919793,
      "in_reply_to_id" : 1341336060,
      "line" : 475,
      "node_id" : "PRRC_kwDOABII585P_BIx",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 475,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 1651649221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341919793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-30T06:49:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341919793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341920164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341920164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice! I don't think my test is usable other than for manual testing. We currently can't mock the 60 second delay involved. We also can't configure the maximum connection count so it would need 10 test nodes, though that's doable. I'll open an issue.\r\n\r\nSee also #28464 for some related changes.",
      "commit_id" : "bc591d42d00b91482989bbbb07f2c03c8e2bbb52",
      "created_at" : "2023-09-30T06:53:00Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341920164",
      "id" : 1341920164,
      "in_reply_to_id" : 1340069761,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585P_BOk",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 397,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1651649556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341920164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-30T06:54:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341920164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341960742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341960742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've pushed again with this approach.",
      "commit_id" : "e4decda0804c8000dee07591f00456da5a42c8c8",
      "created_at" : "2023-09-30T13:12:25Z",
      "diff_hunk" : "@@ -472,7 +472,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341960742",
      "id" : 1341960742,
      "in_reply_to_id" : 1341336060,
      "line" : 472,
      "node_id" : "PRRC_kwDOABII585P_LIm",
      "original_commit_id" : "e07a6bff37d4cbad8266117492ed544c4727ef96",
      "original_line" : 472,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 1651695840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341960742/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-30T13:12:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1341960742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've added a `use_v2transport` argument to `OpenNetworkConnection` and `ConnectNode`, rather than looking at the `addrConnect.nServices` (as not all call sites use `addrConnect`):\r\n\r\n```diff\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 8bd4aebbae..7e70a0586a 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -439,7 +439,7 @@ static CAddress GetBindAddress(const Sock& sock)\r\n     return addr_bind;\r\n }\r\n \r\n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)\r\n+CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type, bool use_v2transport)\r\n {\r\n     AssertLockNotHeld(m_unused_i2p_sessions_mutex);\r\n     assert(conn_type != ConnectionType::INBOUND);\r\n@@ -457,9 +457,6 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\r\n         }\r\n     }\r\n \r\n-    // Use v2 transport when both us and them signal NODE_P2P_V2.\r\n-    const bool use_v2transport(addrConnect.nServices & GetLocalServices() & NODE_P2P_V2);\r\n-\r\n     LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"trying %s connection %s lastseen=%.1fhrs\\n\",\r\n         use_v2transport ? \"v2\" : \"v1\",\r\n         pszDest ? pszDest : addrConnect.ToStringAddrPort(),\r\n@@ -572,7 +569,6 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\r\n     if (!addr_bind.IsValid()) {\r\n         addr_bind = GetBindAddress(*sock);\r\n     }\r\n-\r\n     CNode* pnode = new CNode(id,\r\n                              std::move(sock),\r\n                              addrConnect,\r\n@@ -1920,7 +1916,7 @@ bool CConnman::AddConnection(const std::string& address, ConnectionType conn_typ\r\n     CSemaphoreGrant grant(*semOutbound, true);\r\n     if (!grant) return false;\r\n \r\n-    OpenNetworkConnection(CAddress(), false, std::move(grant), address.c_str(), conn_type);\r\n+    OpenNetworkConnection(CAddress(), false, std::move(grant), address.c_str(), conn_type, /*use_v2transport=*/false);\r\n     return true;\r\n }\r\n \r\n@@ -1958,8 +1954,7 @@ void CConnman::DisconnectNodes()\r\n                 // and we don't want to hold up the socket handler thread for that long.\r\n                 if (pnode->m_transport->ShouldReconnectV1()) {\r\n                     reconnections_to_add.push_back({\r\n-                        // Removing NODE_P2P_V2 here ensures we reconnect using V1.\r\n-                        .addr_connect = CAddress{pnode->addr, ServiceFlags{pnode->addr.nServices & ~NODE_P2P_V2}},\r\n+                        .addr_connect = pnode->addr,\r\n                         .count_failure = pnode->m_count_failure_after_reconnect,\r\n                         .grant = std::move(pnode->grantOutbound),\r\n                         .destination = pnode->m_dest,\r\n@@ -2378,7 +2373,7 @@ void CConnman::ProcessAddrFetch()\r\n     CAddress addr;\r\n     CSemaphoreGrant grant(*semOutbound, /*fTry=*/true);\r\n     if (grant) {\r\n-        OpenNetworkConnection(addr, false, std::move(grant), strDest.c_str(), ConnectionType::ADDR_FETCH);\r\n+        OpenNetworkConnection(addr, false, std::move(grant), strDest.c_str(), ConnectionType::ADDR_FETCH, /*use_v2transport=*/false);\r\n     }\r\n }\r\n \r\n@@ -2481,7 +2476,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\r\n             for (const std::string& strAddr : connect)\r\n             {\r\n                 CAddress addr(CService(), NODE_NONE);\r\n-                OpenNetworkConnection(addr, false, {}, strAddr.c_str(), ConnectionType::MANUAL);\r\n+                OpenNetworkConnection(addr, false, {}, strAddr.c_str(), ConnectionType::MANUAL, /*use_v2transport=*/false);\r\n                 for (int i = 0; i < 10 && i < nLoop; i++)\r\n                 {\r\n                     if (!interruptNet.sleep_for(std::chrono::milliseconds(500)))\r\n@@ -2786,7 +2781,9 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\r\n             // Don't record addrman failure attempts when node is offline. This can be identified since all local\r\n             // network connections (if any) belong in the same netgroup, and the size of `outbound_ipv46_peer_netgroups` would only be 1.\r\n             const bool count_failures{((int)outbound_ipv46_peer_netgroups.size() + outbound_privacy_network_peers) >= std::min(nMaxConnections - 1, 2)};\r\n-            OpenNetworkConnection(addrConnect, count_failures, std::move(grant), /*strDest=*/nullptr, conn_type);\r\n+            // Use BIP324 transport when both us and them have NODE_V2_P2P set.\r\n+            const bool use_v2transport(addrConnect.nServices & GetLocalServices() & NODE_P2P_V2);\r\n+            OpenNetworkConnection(addrConnect, count_failures, std::move(grant), /*strDest=*/nullptr, conn_type, use_v2transport);\r\n         }\r\n     }\r\n }\r\n@@ -2876,12 +2873,7 @@ void CConnman::ThreadOpenAddedConnections()\r\n                 }\r\n                 tried = true;\r\n                 CAddress addr(CService(), NODE_NONE);\r\n-\r\n-                if (info.m_params.m_use_v2transport) {\r\n-                    addr.nServices = ServiceFlags(addr.nServices | NODE_P2P_V2);\r\n-                }\r\n-\r\n-                OpenNetworkConnection(addr, false, std::move(grant), info.m_params.m_added_node.c_str(), ConnectionType::MANUAL);\r\n+                OpenNetworkConnection(addr, false, std::move(grant), info.m_params.m_added_node.c_str(), ConnectionType::MANUAL, info.m_params.m_use_v2transport);\r\n                 if (!interruptNet.sleep_for(std::chrono::milliseconds(500)))\r\n                     return;\r\n             }\r\n@@ -2895,7 +2887,7 @@ void CConnman::ThreadOpenAddedConnections()\r\n }\r\n \r\n // if successful, this moves the passed grant to the constructed node\r\n-void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant&& grant_outbound, const char *pszDest, ConnectionType conn_type)\r\n+void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant&& grant_outbound, const char *pszDest, ConnectionType conn_type, bool use_v2transport)\r\n {\r\n     AssertLockNotHeld(m_unused_i2p_sessions_mutex);\r\n     assert(conn_type != ConnectionType::INBOUND);\r\n@@ -2917,7 +2909,7 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\r\n     } else if (FindNode(std::string(pszDest)))\r\n         return;\r\n \r\n-    CNode* pnode = ConnectNode(addrConnect, pszDest, fCountFailure, conn_type);\r\n+    CNode* pnode = ConnectNode(addrConnect, pszDest, fCountFailure, conn_type, use_v2transport);\r\n \r\n     if (!pnode)\r\n         return;\r\n@@ -3854,7 +3846,8 @@ void CConnman::PerformReconnections()\r\n                               item.count_failure,\r\n                               std::move(item.grant),\r\n                               item.destination.empty() ? nullptr : item.destination.c_str(),\r\n-                              item.conn_type);\r\n+                              item.conn_type,\r\n+                              /*use_v2transport=*/false);\r\n     }\r\n }\r\n \r\ndiff --git a/src/net.h b/src/net.h\r\nindex c9a0afdd97..25a9814f63 100644\r\n--- a/src/net.h\r\n+++ b/src/net.h\r\n@@ -1139,7 +1139,7 @@ public:\r\n     bool GetNetworkActive() const { return fNetworkActive; };\r\n     bool GetUseAddrmanOutgoing() const { return m_use_addrman_outgoing; };\r\n     void SetNetworkActive(bool active);\r\n-    void OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant&& grant_outbound, const char* strDest, ConnectionType conn_type) EXCLUSIVE_LOCKS_REQUIRED(!m_unused_i2p_sessions_mutex);\r\n+    void OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant&& grant_outbound, const char* strDest, ConnectionType conn_type, bool use_v2transport) EXCLUSIVE_LOCKS_REQUIRED(!m_unused_i2p_sessions_mutex);\r\n     bool CheckIncomingNonce(uint64_t nonce);\r\n \r\n     // alias for thread safety annotations only, not defined\r\n@@ -1355,7 +1355,7 @@ private:\r\n     bool AlreadyConnectedToAddress(const CAddress& addr);\r\n \r\n     bool AttemptToEvictConnection();\r\n-    CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type) EXCLUSIVE_LOCKS_REQUIRED(!m_unused_i2p_sessions_mutex);\r\n+    CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type, bool use_v2transport) EXCLUSIVE_LOCKS_REQUIRED(!m_unused_i2p_sessions_mutex);\r\n     void AddWhitelistPermissionFlags(NetPermissionFlags& flags, const CNetAddr &addr) const;\r\n \r\n     void DeleteNode(CNode* pnode);\r\ndiff --git a/src/rpc/net.cpp b/src/rpc/net.cpp\r\nindex 8f6ec29813..8d796b8e9b 100644\r\n--- a/src/rpc/net.cpp\r\n+++ b/src/rpc/net.cpp\r\n@@ -299,7 +299,7 @@ static RPCHelpMan addnode()\r\n                 {\r\n                     {\"node\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The address of the peer to connect to\"},\r\n                     {\"command\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'add' to add a node to the list, 'remove' to remove a node from the list, 'onetry' to try a connection to the node once\"},\r\n-                    {\"v2transport\", RPCArg::Type::BOOL, RPCArg::Default{false}, \"Attempt to connect using BIP324 v2 transport protocol\"},\r\n+                    {\"v2transport\", RPCArg::Type::BOOL, RPCArg::Default{false}, \"Attempt to connect using BIP324 v2 transport protocol (ignored for 'remove' command)\"},\r\n                 },\r\n                 RPCResult{RPCResult::Type::NONE, \"\", \"\"},\r\n                 RPCExamples{\r\n@@ -327,10 +327,7 @@ static RPCHelpMan addnode()\r\n     if (command == \"onetry\")\r\n     {\r\n         CAddress addr;\r\n-        if (use_v2transport) {\r\n-            addr.nServices = ServiceFlags(addr.nServices | NODE_P2P_V2);\r\n-        }\r\n-        connman.OpenNetworkConnection(addr, /*fCountFailure=*/false, /*grant_outbound=*/{}, node_arg.c_str(), ConnectionType::MANUAL);\r\n+        connman.OpenNetworkConnection(addr, /*fCountFailure=*/false, /*grant_outbound=*/{}, node_arg.c_str(), ConnectionType::MANUAL, use_v2transport);\r\n         return UniValue::VNULL;\r\n     }\r\n ```",
      "created_at" : "2023-09-30T13:14:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1741764258",
      "id" : 1741764258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n0Tai",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741764258/reactions"
      },
      "updated_at" : "2023-09-30T13:14:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1741764258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342179199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342179199"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've intentionally tested connecting to a node running a version that still uses the garbage authentication packet (i.e. it doesn't have the recent BIP324 change included yet: https://github.com/bitcoin/bitcoin/pull/28525) and noticed that we report v2 and the session id too early, before the garbage authentication (now included in VERSION) is received. I think that's fixed by the following patch:\r\n```suggestion\r\n        m_recv_state != RecvState::GARB_GARBTERM && m_recv_state != RecvState::VERSION) {\r\n```",
      "commit_id" : "e4decda0804c8000dee07591f00456da5a42c8c8",
      "created_at" : "2023-10-01T19:38:47Z",
      "diff_hunk" : "@@ -1583,6 +1591,27 @@ size_t V2Transport::GetSendMemoryUsage() const noexcept\n     return sizeof(m_send_buffer) + memusage::DynamicUsage(m_send_buffer);\n }\n \n+Transport::Info V2Transport::GetInfo() const noexcept\n+{\n+    AssertLockNotHeld(m_recv_mutex);\n+    LOCK(m_recv_mutex);\n+    if (m_recv_state == RecvState::V1) return m_v1_fallback.GetInfo();\n+\n+    Transport::Info info;\n+\n+    // Do not report v2 and session ID until the garbage authentication packet has been received\n+    // and verified (confirming that the other side very likely has the same keys as us).\n+    if (m_recv_state != RecvState::KEY_MAYBE_V1 && m_recv_state != RecvState::KEY &&\n+        m_recv_state != RecvState::GARB_GARBTERM) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342179199",
      "id" : 1342179199,
      "line" : 1609,
      "node_id" : "PRRC_kwDOABII585QAAd_",
      "original_commit_id" : "d5c8b42a1612e84e7bb5cea6bbc98247ce52128c",
      "original_line" : 1605,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 114,
      "pull_request_review_id" : 1651952488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342179199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-01T19:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342179199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342233509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342233509"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that this is a small change in behavior (fyi @vasild because of https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1341652305):\r\nOn master, the thread will block here if all addnode slots are taken because we call `Acquire()` (and not `TryAcquire()`) so there won't be any `sleep_for` and no continuous calls to `GetAddedNodeInfo()` in this situation (until the grant is released because one of the existing added nodes has disconnected).\r\nWith this PR removing non-fTry acquiry of the grant, it means that we will now continuously cycle through the while loop, calling `GetAddedNodeInfo()` and sleeping for 2 seconds in the same situation where all addnode slots are taken.\r\nIs this change intended / better than the behavior on master? On first glance, repeated calls to `GetAddedNodeInfo()` seem unnecessary when we don't have a grant anyway, so the behavior on master seems more natural.\r\n ",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T02:00:14Z",
      "diff_hunk" : "@@ -2780,19 +2780,19 @@ void CConnman::ThreadOpenAddedConnections()\n     AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n     while (true)\n     {\n-        CSemaphoreGrant grant(*semAddnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342233509",
      "id" : 1342233509,
      "line" : 2772,
      "node_id" : "PRRC_kwDOABII585QANul",
      "original_commit_id" : "5784e825b7d06fef9d86b56a462fa4e42c23eaf7",
      "original_line" : 2783,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 310,
      "pull_request_review_id" : 1652029682,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342233509/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T02:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342233509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342251395"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342251395"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice catch. Since the version packet now takes on the role of garbage authentication, we need to wait for the version packet before deciding it's confirmed to be a v2 peer.",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T03:09:10Z",
      "diff_hunk" : "@@ -1583,6 +1591,27 @@ size_t V2Transport::GetSendMemoryUsage() const noexcept\n     return sizeof(m_send_buffer) + memusage::DynamicUsage(m_send_buffer);\n }\n \n+Transport::Info V2Transport::GetInfo() const noexcept\n+{\n+    AssertLockNotHeld(m_recv_mutex);\n+    LOCK(m_recv_mutex);\n+    if (m_recv_state == RecvState::V1) return m_v1_fallback.GetInfo();\n+\n+    Transport::Info info;\n+\n+    // Do not report v2 and session ID until the garbage authentication packet has been received\n+    // and verified (confirming that the other side very likely has the same keys as us).\n+    if (m_recv_state != RecvState::KEY_MAYBE_V1 && m_recv_state != RecvState::KEY &&\n+        m_recv_state != RecvState::GARB_GARBTERM) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342251395",
      "id" : 1342251395,
      "in_reply_to_id" : 1342179199,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QASGD",
      "original_commit_id" : "d5c8b42a1612e84e7bb5cea6bbc98247ce52128c",
      "original_line" : 1605,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1652058557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342251395/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T03:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342251395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342251633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342251633"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice find. I've adapted the code to match the old behavior (I hope; please have a look); even if we decide different behavior is desirable, this isn't the PR to introduce it.",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T03:10:13Z",
      "diff_hunk" : "@@ -2780,19 +2780,19 @@ void CConnman::ThreadOpenAddedConnections()\n     AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n     while (true)\n     {\n-        CSemaphoreGrant grant(*semAddnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342251633",
      "id" : 1342251633,
      "in_reply_to_id" : 1342233509,
      "line" : 2772,
      "node_id" : "PRRC_kwDOABII585QASJx",
      "original_commit_id" : "5784e825b7d06fef9d86b56a462fa4e42c23eaf7",
      "original_line" : 2783,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 310,
      "pull_request_review_id" : 1652058967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342251633/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T03:10:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342251633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Changes to address the comments by @mzumsande and @theStack above:\r\n\r\n```diff\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 7e70a0586a..a17c215a2c 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -1603,10 +1603,10 @@ Transport::Info V2Transport::GetInfo() const noexcept\r\n \r\n     Transport::Info info;\r\n \r\n-    // Do not report v2 and session ID until the garbage authentication packet has been received\r\n+    // Do not report v2 and session ID until the version packet has been received\r\n     // and verified (confirming that the other side very likely has the same keys as us).\r\n     if (m_recv_state != RecvState::KEY_MAYBE_V1 && m_recv_state != RecvState::KEY &&\r\n-        m_recv_state != RecvState::GARB_GARBTERM) {\r\n+        m_recv_state != RecvState::GARB_GARBTERM && m_recv_state != RecvState::VERSION) {\r\n         info.transport_type = TransportProtocolType::V2;\r\n         info.session_id = uint256(MakeUCharSpan(m_cipher.GetSessionID()));\r\n     } else {\r\n@@ -2861,11 +2861,12 @@ void CConnman::ThreadOpenAddedConnections()\r\n     AssertLockNotHeld(m_reconnections_mutex);\r\n     while (true)\r\n     {\r\n+        CSemaphoreGrant grant(*semAddnode);\r\n         std::vector<AddedNodeInfo> vInfo = GetAddedNodeInfo();\r\n         bool tried = false;\r\n         for (const AddedNodeInfo& info : vInfo) {\r\n             if (!info.fConnected) {\r\n-                CSemaphoreGrant grant(*semAddnode, /*fTry=*/true);\r\n+                if (!grant) grant = CSemaphoreGrant(*semAddnode, /*fTry=*/true);\r\n                 if (!grant) {\r\n                     // If we've used up our semaphore and need a new one, let's not wait here since while we are waiting\r\n                     // the addednodeinfo state might change.\r\n```",
      "created_at" : "2023-10-02T03:10:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1742345114",
      "id" : 1742345114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n2hOa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742345114/reactions"
      },
      "updated_at" : "2023-10-02T03:10:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742345114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342450439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342450439"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated test that demonstrates the crash issue has been fixed: https://github.com/Sjors/bitcoin/commit/bc3995c66300fb3139c5360e8f6ee807b02ea86e",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T09:10:54Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342450439",
      "id" : 1342450439,
      "in_reply_to_id" : 1340069761,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QBCsH",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 397,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1652375193,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342450439/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-02T09:11:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342450439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From clang-tidy (https://github.com/bitcoin/bitcoin/pull/28331/checks?check_run_id=17301328580):\r\n```bash\r\nclang-tidy-16 -p=/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu -quiet -load=/tidy-build/libbitcoin-tidy.so /ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/net.cpp\r\nnet.cpp:2869:22: error: 'grant' used after it was moved [bugprone-use-after-move,-warnings-as-errors]\r\n                if (!grant) grant = CSemaphoreGrant(*semAddnode, /*fTry=*/true);\r\n                     ^\r\nnet.cpp:2877:17: note: move occurred here\r\n                OpenNetworkConnection(addr, false, std::move(grant), info.m_params.m_added_node.c_str(), ConnectionType::MANUAL, info.m_params.m_use_v2transport);\r\n                ^\r\n--\r\n```",
      "created_at" : "2023-10-02T09:15:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1742669269",
      "id" : 1742669269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n3wXV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742669269/reactions"
      },
      "updated_at" : "2023-10-02T09:15:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742669269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342506186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342506186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This adds a way to specify a v2 peer to `addnode`. What about something similar for `-connect=` peers? Right now there is no way to specify \"use v2\" for addresses provided to `-connect=`. What about if `-v2transport=1` then always try v2 first (and on failure v1) for all `addnode` and `connect` peers? Then this extra argument to `addnode` is not needed.",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T10:09:36Z",
      "diff_hunk" : "@@ -289,11 +299,12 @@ static RPCHelpMan addnode()\n                 {\n                     {\"node\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The address of the peer to connect to\"},\n                     {\"command\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'add' to add a node to the list, 'remove' to remove a node from the list, 'onetry' to try a connection to the node once\"},\n+                    {\"v2transport\", RPCArg::Type::BOOL, RPCArg::Default{false}, \"Attempt to connect using BIP324 v2 transport protocol (ignored for 'remove' command)\"},\n                 },\n                 RPCResult{RPCResult::Type::NONE, \"\", \"\"},\n                 RPCExamples{\n-                    HelpExampleCli(\"addnode\", \"\\\"192.168.0.6:8333\\\" \\\"onetry\\\"\")\n-            + HelpExampleRpc(\"addnode\", \"\\\"192.168.0.6:8333\\\", \\\"onetry\\\"\")\n+                    HelpExampleCli(\"addnode\", \"\\\"192.168.0.6:8333\\\" \\\"onetry\\\" true\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342506186",
      "id" : 1342506186,
      "line" : 306,
      "node_id" : "PRRC_kwDOABII585QBQTK",
      "original_commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "original_line" : 306,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 41,
      "pull_request_review_id" : 1652460362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342506186/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T10:12:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342506186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342562148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342562148"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> If a peer lies about their supported services, they only hurt their own ability of being connected to\r\n\r\nPeers could lie about each-other in gossip. But it doesn't matter here, as you say.",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T11:17:50Z",
      "diff_hunk" : "@@ -1906,6 +1979,20 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342562148",
      "id" : 1342562148,
      "in_reply_to_id" : 1340130617,
      "line" : 1955,
      "node_id" : "PRRC_kwDOABII585QBd9k",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1955,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 183,
      "pull_request_review_id" : 1652547217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342562148/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T11:17:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342562148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342567406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342567406"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6a2dbed1209b18d923da64b019f6f378d3c30695: could a comment here that we `// Use temporary variable to track new reconnection candidates, because m_reconnections_mutex may be blocked [also for several seconds??? or much shorter but still don't want that]` (supplementing the comment below why we don't do the reconnect itself here either).",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T11:23:14Z",
      "diff_hunk" : "@@ -1868,6 +1889,11 @@ bool CConnman::AddConnection(const std::string& address, ConnectionType conn_typ\n \n void CConnman::DisconnectNodes()\n {\n+    AssertLockNotHeld(m_nodes_mutex);\n+    AssertLockNotHeld(m_reconnections_mutex);\n+\n+    decltype(m_reconnections) reconnections_to_add;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342567406",
      "id" : 1342567406,
      "line" : 1928,
      "node_id" : "PRRC_kwDOABII585QBfPu",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 1895,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 171,
      "pull_request_review_id" : 1652554967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342567406/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T11:50:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342567406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342572783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342572783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6a2dbed1209b18d923da64b019f6f378d3c30695 `ReconnectionInfo` could specify `use_v2transport` so that `PerformReconnections` can be used more broadly than just `v2` -> `v1` downgrades. Can always be done later of course.",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T11:30:18Z",
      "diff_hunk" : "@@ -3744,6 +3796,29 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& address) const\n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup).Finalize();\n }\n \n+void CConnman::PerformReconnections()\n+{\n+    AssertLockNotHeld(m_reconnections_mutex);\n+    AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n+    while (true) {\n+        // Move first element of m_reconnections to todo (avoiding an allocation inside the lock).\n+        decltype(m_reconnections) todo;\n+        {\n+            LOCK(m_reconnections_mutex);\n+            if (m_reconnections.empty()) break;\n+            todo.splice(todo.end(), m_reconnections, m_reconnections.begin());\n+        }\n+\n+        auto& item = *todo.begin();\n+        OpenNetworkConnection(item.addr_connect,\n+                              item.count_failure,\n+                              std::move(item.grant),\n+                              item.destination.empty() ? nullptr : item.destination.c_str(),\n+                              item.conn_type,\n+                              /*use_v2transport=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342572783",
      "id" : 1342572783,
      "line" : 3851,
      "node_id" : "PRRC_kwDOABII585QBgjv",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 3818,
      "original_position" : 153,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 447,
      "pull_request_review_id" : 1652554967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342572783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T11:50:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342572783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342573672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342573672"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6a2dbed1209b18d923da64b019f6f378d3c30695 could make this more generic `ShouldReconnect()` (see comment above).",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T11:31:25Z",
      "diff_hunk" : "@@ -361,6 +361,11 @@ class Transport {\n \n     /** Return the memory usage of this transport attributable to buffered data to send. */\n     virtual size_t GetSendMemoryUsage() const noexcept = 0;\n+\n+    // 3. Miscellaneous functions.\n+\n+    /** Whether upon disconnections, a reconnect with V1 is warranted. */\n+    virtual bool ShouldReconnectV1() const noexcept = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342573672",
      "id" : 1342573672,
      "line" : 381,
      "node_id" : "PRRC_kwDOABII585QBgxo",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 368,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 56,
      "pull_request_review_id" : 1652554967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342573672/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T11:50:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342573672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342584337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342584337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6a2dbed1209b18d923da64b019f6f378d3c30695 I'm confused about the intention of `count_failure` / `m_count_failure_after_reconnect`. If this is set to `true` then `AddrManImpl` marks the most recent failed attempt and bumps `info.nAttempts`.\r\n\r\nThe latter suggests that we should set this to `false` if we'r trying a `v2` -> `v1` downgrade, otherwise we'd be counting double. Even better: we should not count the failed `v2` attempt if we intend to try again with `v1`. ",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T11:45:01Z",
      "diff_hunk" : "@@ -1890,6 +1916,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.push_back({\n+                        .addr_connect = pnode->addr,\n+                        .count_failure = pnode->m_count_failure_after_reconnect,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342584337",
      "id" : 1342584337,
      "line" : 1958,
      "node_id" : "PRRC_kwDOABII585QBjYR",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 1925,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 186,
      "pull_request_review_id" : 1652554967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342584337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T11:50:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342584337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342586915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342586915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "6a2dbed1209b18d923da64b019f6f378d3c30695: The word `count` is ambigous here, because `AddrManImpl` literally counts failures, but I think the meaning here is \"it counts / we care about it\".\r\n\r\nSee also my above comment. Depending how this is intended to work, maybe I can think of a better name.",
      "commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "created_at" : "2023-10-02T11:47:49Z",
      "diff_hunk" : "@@ -662,6 +673,7 @@ struct CNodeOptions\n     bool prefer_evict = false;\n     size_t recv_flood_size{DEFAULT_MAXRECEIVEBUFFER * 1000};\n     bool use_v2transport = false;\n+    bool count_failure_after_reconnect = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342586915",
      "id" : 1342586915,
      "line" : 692,
      "node_id" : "PRRC_kwDOABII585QBkAj",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 676,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 102,
      "pull_request_review_id" : 1652554967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342586915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T11:50:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342586915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342617148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342617148"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Worth noting here is that if an address is already in addrman and we receive it via gossip we update its services, but in a cumulative manner - only add new services, without removing existent services from addrman:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/dcf6230f92d491f46d2bf6cfc096ab5874e385c9/src/addrman.cpp#L572\r\n\r\n",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T12:21:20Z",
      "diff_hunk" : "@@ -1906,6 +1979,20 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342617148",
      "id" : 1342617148,
      "in_reply_to_id" : 1340130617,
      "line" : 1956,
      "node_id" : "PRRC_kwDOABII585QBrY8",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1956,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 184,
      "pull_request_review_id" : 1652631446,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342617148/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T12:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342617148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed comments by @Sjors, and (hopefully for real) fixed the semaphore move issue.\r\n\r\n```diff\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex a17c215a2c..c4c2d55c77 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -582,7 +582,6 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\r\n                                  .i2p_sam_session = std::move(i2p_transient_session),\r\n                                  .recv_flood_size = nReceiveFloodSize,\r\n                                  .use_v2transport = use_v2transport,\r\n-                                 .count_failure_after_reconnect = fCountFailure,\r\n                              });\r\n     pnode->AddRef();\r\n \r\n@@ -1925,6 +1924,8 @@ void CConnman::DisconnectNodes()\r\n     AssertLockNotHeld(m_nodes_mutex);\r\n     AssertLockNotHeld(m_reconnections_mutex);\r\n \r\n+    // Use a temporary variable to accumulate desired reconnections, so we don't need\r\n+    // m_reconnections_mutex while holding m_nodes_mutex.\r\n     decltype(m_reconnections) reconnections_to_add;\r\n \r\n     {\r\n@@ -1955,10 +1956,10 @@ void CConnman::DisconnectNodes()\r\n                 if (pnode->m_transport->ShouldReconnectV1()) {\r\n                     reconnections_to_add.push_back({\r\n                         .addr_connect = pnode->addr,\r\n-                        .count_failure = pnode->m_count_failure_after_reconnect,\r\n                         .grant = std::move(pnode->grantOutbound),\r\n                         .destination = pnode->m_dest,\r\n-                        .conn_type = pnode->m_conn_type});\r\n+                        .conn_type = pnode->m_conn_type,\r\n+                        .use_v2transport = false});\r\n                     LogPrint(BCLog::NET, \"retrying with v1 transport protocol for peer=%d\\n\", pnode->GetId());\r\n                 }\r\n \r\n@@ -2866,7 +2867,6 @@ void CConnman::ThreadOpenAddedConnections()\r\n         bool tried = false;\r\n         for (const AddedNodeInfo& info : vInfo) {\r\n             if (!info.fConnected) {\r\n-                if (!grant) grant = CSemaphoreGrant(*semAddnode, /*fTry=*/true);\r\n                 if (!grant) {\r\n                     // If we've used up our semaphore and need a new one, let's not wait here since while we are waiting\r\n                     // the addednodeinfo state might change.\r\n@@ -2875,8 +2875,8 @@ void CConnman::ThreadOpenAddedConnections()\r\n                 tried = true;\r\n                 CAddress addr(CService(), NODE_NONE);\r\n                 OpenNetworkConnection(addr, false, std::move(grant), info.m_params.m_added_node.c_str(), ConnectionType::MANUAL, info.m_params.m_use_v2transport);\r\n-                if (!interruptNet.sleep_for(std::chrono::milliseconds(500)))\r\n-                    return;\r\n+                if (!interruptNet.sleep_for(std::chrono::milliseconds(500))) return;\r\n+                grant = CSemaphoreGrant(*semAddnode, /*fTry=*/true);\r\n             }\r\n         }\r\n         // Retry every 60 seconds if a connection was attempted, otherwise two seconds\r\n@@ -3699,7 +3699,6 @@ CNode::CNode(NodeId idIn,\r\n       m_addr_name{addrNameIn.empty() ? addr.ToStringAddrPort() : addrNameIn},\r\n       m_dest(addrNameIn),\r\n       m_inbound_onion{inbound_onion},\r\n-      m_count_failure_after_reconnect{node_opts.count_failure_after_reconnect},\r\n       m_prefer_evict{node_opts.prefer_evict},\r\n       nKeyedNetGroup{nKeyedNetGroupIn},\r\n       m_conn_type{conn_type_in},\r\n@@ -3844,11 +3843,15 @@ void CConnman::PerformReconnections()\r\n \r\n         auto& item = *todo.begin();\r\n         OpenNetworkConnection(item.addr_connect,\r\n-                              item.count_failure,\r\n+                              // We only reconnect if the first attempt to connect succeeded at\r\n+                              // connection time, but then failed after the CNode object was\r\n+                              // created. Since we already know connecting is possible, do not\r\n+                              // count failure to reconnect.\r\n+                              /*fCountFailure=*/false,\r\n                               std::move(item.grant),\r\n                               item.destination.empty() ? nullptr : item.destination.c_str(),\r\n                               item.conn_type,\r\n-                              /*use_v2transport=*/false);\r\n+                              item.use_v2transport);\r\n     }\r\n }\r\n \r\ndiff --git a/src/net.h b/src/net.h\r\nindex 25a9814f63..2f7b832fba 100644\r\n--- a/src/net.h\r\n+++ b/src/net.h\r\n@@ -689,7 +689,6 @@ struct CNodeOptions\r\n     bool prefer_evict = false;\r\n     size_t recv_flood_size{DEFAULT_MAXRECEIVEBUFFER * 1000};\r\n     bool use_v2transport = false;\r\n-    bool count_failure_after_reconnect = false;\r\n };\r\n \r\n /** Information about a peer */\r\n@@ -738,8 +737,6 @@ public:\r\n     const std::string m_dest;\r\n     //! Whether this peer is an inbound onion, i.e. connected via our Tor onion service.\r\n     const bool m_inbound_onion;\r\n-    //! Whether (reconnections of) connections to this peer should count as failure.\r\n-    const bool m_count_failure_after_reconnect;\r\n     std::atomic<int> nVersion{0};\r\n     Mutex m_subver_mutex;\r\n     /**\r\n@@ -1578,10 +1575,10 @@ private:\r\n     struct ReconnectionInfo\r\n     {\r\n         CAddress addr_connect;\r\n-        bool count_failure;\r\n         CSemaphoreGrant grant;\r\n         std::string destination;\r\n         ConnectionType conn_type;\r\n+        bool use_v2transport;\r\n     };\r\n \r\n     /**\r\n```\r\n",
      "created_at" : "2023-10-02T13:19:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1743003932",
      "id" : 1743003932,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n5CEc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743003932/reactions"
      },
      "updated_at" : "2023-10-02T13:35:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743003932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342690792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342690792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There have been several comments related to this before. The situation is certainly incomplete w.r.t. the ability to specify v1/v2 for manual connections (e.g. also the `-addnode` / `-seednode` options lacks that), but my goal with this PR is getting the minimal in to support testing. Making things convenient for wider adoption I think needs some more UX discussion (e.g. do we permit specifying IP address/ranges to be V2, or do we use a network permission, or some special suffix `-addnode=IP@v2`; also how does this interact with a potential future where peer pubkeys can be specified, ...), which I think is better done separately.\r\n\r\nRegarding automatically assuming v2 for all addnode... that would (for now) mean 2 connection attempts for every manual peer; I'm not sure that's an acceptable tradeoff right now.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T13:24:09Z",
      "diff_hunk" : "@@ -289,11 +299,12 @@ static RPCHelpMan addnode()\n                 {\n                     {\"node\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The address of the peer to connect to\"},\n                     {\"command\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'add' to add a node to the list, 'remove' to remove a node from the list, 'onetry' to try a connection to the node once\"},\n+                    {\"v2transport\", RPCArg::Type::BOOL, RPCArg::Default{false}, \"Attempt to connect using BIP324 v2 transport protocol (ignored for 'remove' command)\"},\n                 },\n                 RPCResult{RPCResult::Type::NONE, \"\", \"\"},\n                 RPCExamples{\n-                    HelpExampleCli(\"addnode\", \"\\\"192.168.0.6:8333\\\" \\\"onetry\\\"\")\n-            + HelpExampleRpc(\"addnode\", \"\\\"192.168.0.6:8333\\\", \\\"onetry\\\"\")\n+                    HelpExampleCli(\"addnode\", \"\\\"192.168.0.6:8333\\\" \\\"onetry\\\" true\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342690792",
      "id" : 1342690792,
      "in_reply_to_id" : 1342506186,
      "line" : 306,
      "node_id" : "PRRC_kwDOABII585QB9Xo",
      "original_commit_id" : "cd5e72d6fb82c580dbf693b14e842d6204327311",
      "original_line" : 306,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 41,
      "pull_request_review_id" : 1652746189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342690792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T13:24:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342690792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342691501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342691501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's to avoid a lock dependency between `m_nodes_mutex` and `m_reconnections_mutex`. I've added a comment.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T13:24:48Z",
      "diff_hunk" : "@@ -1868,6 +1889,11 @@ bool CConnman::AddConnection(const std::string& address, ConnectionType conn_typ\n \n void CConnman::DisconnectNodes()\n {\n+    AssertLockNotHeld(m_nodes_mutex);\n+    AssertLockNotHeld(m_reconnections_mutex);\n+\n+    decltype(m_reconnections) reconnections_to_add;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342691501",
      "id" : 1342691501,
      "in_reply_to_id" : 1342567406,
      "line" : 1929,
      "node_id" : "PRRC_kwDOABII585QB9it",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 1929,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 172,
      "pull_request_review_id" : 1652747385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342691501/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T13:24:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342691501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342691666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342691666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea, done.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T13:24:57Z",
      "diff_hunk" : "@@ -3744,6 +3796,29 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& address) const\n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup).Finalize();\n }\n \n+void CConnman::PerformReconnections()\n+{\n+    AssertLockNotHeld(m_reconnections_mutex);\n+    AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n+    while (true) {\n+        // Move first element of m_reconnections to todo (avoiding an allocation inside the lock).\n+        decltype(m_reconnections) todo;\n+        {\n+            LOCK(m_reconnections_mutex);\n+            if (m_reconnections.empty()) break;\n+            todo.splice(todo.end(), m_reconnections, m_reconnections.begin());\n+        }\n+\n+        auto& item = *todo.begin();\n+        OpenNetworkConnection(item.addr_connect,\n+                              item.count_failure,\n+                              std::move(item.grant),\n+                              item.destination.empty() ? nullptr : item.destination.c_str(),\n+                              item.conn_type,\n+                              /*use_v2transport=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342691666",
      "id" : 1342691666,
      "in_reply_to_id" : 1342572783,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QB9lS",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 3818,
      "original_position" : 153,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1652747666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342691666/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T13:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342691666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342692419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342692419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think that works, because even while `ReconnectionInfo` can be generic for any kind of reconnection attempt, this function and its call site are very much specific to a V2 connection downgrading to a V1.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T13:25:39Z",
      "diff_hunk" : "@@ -361,6 +361,11 @@ class Transport {\n \n     /** Return the memory usage of this transport attributable to buffered data to send. */\n     virtual size_t GetSendMemoryUsage() const noexcept = 0;\n+\n+    // 3. Miscellaneous functions.\n+\n+    /** Whether upon disconnections, a reconnect with V1 is warranted. */\n+    virtual bool ShouldReconnectV1() const noexcept = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342692419",
      "id" : 1342692419,
      "in_reply_to_id" : 1342573672,
      "line" : 381,
      "node_id" : "PRRC_kwDOABII585QB9xD",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 381,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 56,
      "pull_request_review_id" : 1652748923,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342692419/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T13:25:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342692419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342695574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342695574"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice catch. I was clearly confused when writing this.\r\n\r\nThe situation is even simpler, because the `fCountFailure` argument to `OpenNetworkConnection` is only related to *connection* failure (i.e., TCP/IP failing to establish a connection) and not related to failures that happen after that point (perhaps it should, but that seems out of scope for this PR). We only ever attempt a V1 reconnection if the establishment of the V2 connection succeeded before that point, so by the time we reconnect, we already *know* the peer can be reached (in a TCP/IP sense), and there is no need to keep track of failure counting after that.\r\n\r\nI've changed it to set `fCountFailure` always to `false` on reconnect.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T13:28:21Z",
      "diff_hunk" : "@@ -1890,6 +1916,19 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {\n+                    reconnections_to_add.push_back({\n+                        .addr_connect = pnode->addr,\n+                        .count_failure = pnode->m_count_failure_after_reconnect,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342695574",
      "id" : 1342695574,
      "in_reply_to_id" : 1342584337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QB-iW",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 1925,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1652754021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342695574/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T13:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342695574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342695789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342695789"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This code is gone.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T13:28:33Z",
      "diff_hunk" : "@@ -662,6 +673,7 @@ struct CNodeOptions\n     bool prefer_evict = false;\n     size_t recv_flood_size{DEFAULT_MAXRECEIVEBUFFER * 1000};\n     bool use_v2transport = false;\n+    bool count_failure_after_reconnect = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342695789",
      "id" : 1342695789,
      "in_reply_to_id" : 1342586915,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QB-lt",
      "original_commit_id" : "6a2dbed1209b18d923da64b019f6f378d3c30695",
      "original_line" : 676,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1652754389,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342695789/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T13:28:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342695789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342700659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342700659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@vasild FWIW, that's the primary reason why we really need a v1-reconnect concept when v2 connections fail; otherwise it'd be trivial for attackers to inject the `NODE_P2P_V2` flag in all addresses they relay and cause widespread inability to connect.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T13:32:49Z",
      "diff_hunk" : "@@ -1906,6 +1979,20 @@ void CConnman::DisconnectNodes()\n                 // remove from m_nodes\n                 m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n+                // Add to reconnection list if appropriate. We don't reconnect right here, because\n+                // the creation of a connection is a blocking operation (up to several seconds),\n+                // and we don't want to hold up the socket handler thread for that long.\n+                if (pnode->m_transport->ShouldReconnectV1()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342700659",
      "id" : 1342700659,
      "in_reply_to_id" : 1340130617,
      "line" : 1956,
      "node_id" : "PRRC_kwDOABII585QB_xz",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 1956,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 184,
      "pull_request_review_id" : 1652762407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342700659/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T13:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342700659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild I've switched to a slightly different approach to avoid the use-after-move (see diff above).",
      "created_at" : "2023-10-02T13:34:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1743028933",
      "id" : 1743028933,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n5ILF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743028933/reactions"
      },
      "updated_at" : "2023-10-02T13:34:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743028933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342881393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342881393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2e0f8a6d39a15ecac60b9d463606e16ba5707bb5: I'm confused by this change. I see `!fgrant` calls the `bool()` operator which checks `fHaveGrant`. But if that returns false we now break out of the `for` loop. Wheveras we used to call `TryAcquire()` and continue if that worked.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T15:56:50Z",
      "diff_hunk" : "@@ -2785,16 +2785,16 @@ void CConnman::ThreadOpenAddedConnections()\n         bool tried = false;\n         for (const AddedNodeInfo& info : vInfo) {\n             if (!info.fConnected) {\n-                if (!grant.TryAcquire()) {\n+                if (!grant) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342881393",
      "id" : 1342881393,
      "line" : 2870,
      "node_id" : "PRRC_kwDOABII585QCr5x",
      "original_commit_id" : "2e0f8a6d39a15ecac60b9d463606e16ba5707bb5",
      "original_line" : 2788,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 317,
      "pull_request_review_id" : 1653050182,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342881393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T15:56:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342881393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342882636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342882636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We try acquire at the end of the previous loop iteration, or before entering the loop.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T15:58:03Z",
      "diff_hunk" : "@@ -2785,16 +2785,16 @@ void CConnman::ThreadOpenAddedConnections()\n         bool tried = false;\n         for (const AddedNodeInfo& info : vInfo) {\n             if (!info.fConnected) {\n-                if (!grant.TryAcquire()) {\n+                if (!grant) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342882636",
      "id" : 1342882636,
      "in_reply_to_id" : 1342881393,
      "line" : 2870,
      "node_id" : "PRRC_kwDOABII585QCsNM",
      "original_commit_id" : "2e0f8a6d39a15ecac60b9d463606e16ba5707bb5",
      "original_line" : 2788,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 317,
      "pull_request_review_id" : 1653052187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342882636/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T15:58:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342882636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342894361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342894361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> before entering the loop\r\n\r\nOh I see. The `CSemaphoreGrant grant(*semAddnode)` constructor before the loop doesn't `fTry`, but uses `Acquire()`, which waits (unchanged behavior) and always sets `grant` to `true`.\r\n\r\nAt the end of the first iteration we set `fTry`, so we either get a grant for the next iteration or we don't.\r\n\r\nThe first time we don't get a grant we bail out of the loop. This is effectively the same as before, it's just that we did `TryAquire()` at the start of each iteration (which also always would have succeed in the first iteration). ",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T16:09:51Z",
      "diff_hunk" : "@@ -2785,16 +2785,16 @@ void CConnman::ThreadOpenAddedConnections()\n         bool tried = false;\n         for (const AddedNodeInfo& info : vInfo) {\n             if (!info.fConnected) {\n-                if (!grant.TryAcquire()) {\n+                if (!grant) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1342894361",
      "id" : 1342894361,
      "in_reply_to_id" : 1342881393,
      "line" : 2870,
      "node_id" : "PRRC_kwDOABII585QCvEZ",
      "original_commit_id" : "2e0f8a6d39a15ecac60b9d463606e16ba5707bb5",
      "original_line" : 2788,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 317,
      "pull_request_review_id" : 1653071468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342894361/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T16:09:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1342894361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "tACK 7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T16:46:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1743369372",
      "id" : 1743369372,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n6bSc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743369372/reactions"
      },
      "updated_at" : "2023-10-02T16:46:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743369372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343157537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343157537"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "pedantic nit to avoid the \"support for ... is supported\" repetition:\r\n```suggestion\r\n* [`BIP 324`](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki): The BIP324 v2 transport protocol and the associated `NODE_P2P_V2` service bit is supported as of **v26.0**, but off by default ([PR 28331](https://github.com/bitcoin/bitcoin/pull/28331)).\r\n```",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T20:57:29Z",
      "diff_hunk" : "@@ -49,6 +49,7 @@ BIPs that are implemented by Bitcoin Core:\n * [`BIP 173`](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki): Bech32 addresses for native Segregated Witness outputs are supported as of **v0.16.0** ([PR 11167](https://github.com/bitcoin/bitcoin/pull/11167)). Bech32 addresses are generated by default as of **v0.20.0** ([PR 16884](https://github.com/bitcoin/bitcoin/pull/16884)).\n * [`BIP 174`](https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki): RPCs to operate on Partially Signed Bitcoin Transactions (PSBT) are present as of **v0.17.0** ([PR 13557](https://github.com/bitcoin/bitcoin/pull/13557)).\n * [`BIP 176`](https://github.com/bitcoin/bips/blob/master/bip-0176.mediawiki): Bits Denomination [QT only] is supported as of **v0.16.0** ([PR 12035](https://github.com/bitcoin/bitcoin/pull/12035)).\n+* [`BIP 324`](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki): Support for the BIP324 v2 transport protocol and the associated `NODE_P2P_V2` service bit is supported as of **v26.0**, but off by default ([PR 28331](https://github.com/bitcoin/bitcoin/pull/28331)).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343157537",
      "id" : 1343157537,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII585QDvUh",
      "original_commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "original_line" : 52,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "doc/bips.md",
      "position" : 4,
      "pull_request_review_id" : 1653503507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343157537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T20:58:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343157537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343171523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343171523"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that changing this line is no longer necessary after adding the `use_v2transport` bool.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T21:15:17Z",
      "diff_hunk" : "@@ -469,7 +469,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343171523",
      "id" : 1343171523,
      "line" : 472,
      "node_id" : "PRRC_kwDOABII585QDyvD",
      "original_commit_id" : "4aaf81533010939cc9ea5a1e299c46a43527a6ae",
      "original_line" : 472,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 1653525921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343171523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T21:41:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343171523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343193200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343193200"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks good, I tested that the behavior doesn't change anymore.",
      "commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "created_at" : "2023-10-02T21:40:54Z",
      "diff_hunk" : "@@ -2780,19 +2780,19 @@ void CConnman::ThreadOpenAddedConnections()\n     AssertLockNotHeld(m_unused_i2p_sessions_mutex);\n     while (true)\n     {\n-        CSemaphoreGrant grant(*semAddnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343193200",
      "id" : 1343193200,
      "in_reply_to_id" : 1342233509,
      "line" : 2772,
      "node_id" : "PRRC_kwDOABII585QD4Bw",
      "original_commit_id" : "5784e825b7d06fef9d86b56a462fa4e42c23eaf7",
      "original_line" : 2772,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 311,
      "pull_request_review_id" : 1653525921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343193200/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T21:41:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343193200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed nits by @mzumsande and @theStack:\r\n\r\n```diff\r\ndiff --git a/doc/bips.md b/doc/bips.md\r\nindex 87b5918c72..952d289daa 100644\r\n--- a/doc/bips.md\r\n+++ b/doc/bips.md\r\n@@ -49,7 +49,7 @@ BIPs that are implemented by Bitcoin Core:\r\n * [`BIP 173`](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki): Bech32 addresses for native Segregated Witness outputs are supported as of **v0.16.0** ([PR 11167](https://github.com/bitcoin/bitcoin/pull/11167)). Bech32 addresses are generated by default as of **v0.20.0** ([PR 16884](https://github.com/bitcoin/bitcoin/pull/16884)).\r\n * [`BIP 174`](https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki): RPCs to operate on Partially Signed Bitcoin Transactions (PSBT) are present as of **v0.17.0** ([PR 13557](https://github.com/bitcoin/bitcoin/pull/13557)).\r\n * [`BIP 176`](https://github.com/bitcoin/bips/blob/master/bip-0176.mediawiki): Bits Denomination [QT only] is supported as of **v0.16.0** ([PR 12035](https://github.com/bitcoin/bitcoin/pull/12035)).\r\n-* [`BIP 324`](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki): Support for the BIP324 v2 transport protocol and the associated `NODE_P2P_V2` service bit is supported as of **v26.0**, but off by default ([PR 28331](https://github.com/bitcoin/bitcoin/pull/28331)).\r\n+* [`BIP 324`](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki): The v2 transport protocol specified by BIP324 and the associated `NODE_P2P_V2` service bit are supported as of **v26.0**, but off by default ([PR 28331](https://github.com/bitcoin/bitcoin/pull/28331)).\r\n * [`BIP 325`](https://github.com/bitcoin/bips/blob/master/bip-0325.mediawiki): Signet test network is supported as of **v0.21.0** ([PR 18267](https://github.com/bitcoin/bitcoin/pull/18267)).\r\n * [`BIP 339`](https://github.com/bitcoin/bips/blob/master/bip-0339.mediawiki): Relay of transactions by wtxid is supported as of **v0.21.0** ([PR 18044](https://github.com/bitcoin/bitcoin/pull/18044)).\r\n * [`BIP 340`](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki)\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex c4c2d55c77..6b2ef5f43d 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -469,7 +469,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\r\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\r\n         if (!resolved.empty()) {\r\n             const CService& rnd{resolved[GetRand(resolved.size())]};\r\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};\r\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\r\n             if (!addrConnect.IsValid()) {\r\n                 LogPrint(BCLog::NET, \"Resolver returned invalid address %s for %s\\n\", addrConnect.ToStringAddrPort(), pszDest);\r\n                 return nullptr;\r\n```\r\n",
      "created_at" : "2023-10-02T22:29:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1743858843",
      "id" : 1743858843,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n8Syb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743858843/reactions"
      },
      "updated_at" : "2023-10-02T22:29:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743858843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343223966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343223966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-10-02T22:29:21Z",
      "diff_hunk" : "@@ -469,7 +469,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         const std::vector<CService> resolved{Lookup(pszDest, default_port, fNameLookup && !HaveNameProxy(), 256)};\n         if (!resolved.empty()) {\n             const CService& rnd{resolved[GetRand(resolved.size())]};\n-            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), NODE_NONE};\n+            addrConnect = CAddress{MaybeFlipIPv6toCJDNS(rnd), addrConnect.nServices};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343223966",
      "id" : 1343223966,
      "in_reply_to_id" : 1343171523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QD_ie",
      "original_commit_id" : "4aaf81533010939cc9ea5a1e299c46a43527a6ae",
      "original_line" : 472,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1653608319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343223966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T22:29:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343223966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343224142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343224142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (made some more editorial changes to this sentence).",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-10-02T22:29:39Z",
      "diff_hunk" : "@@ -49,6 +49,7 @@ BIPs that are implemented by Bitcoin Core:\n * [`BIP 173`](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki): Bech32 addresses for native Segregated Witness outputs are supported as of **v0.16.0** ([PR 11167](https://github.com/bitcoin/bitcoin/pull/11167)). Bech32 addresses are generated by default as of **v0.20.0** ([PR 16884](https://github.com/bitcoin/bitcoin/pull/16884)).\n * [`BIP 174`](https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki): RPCs to operate on Partially Signed Bitcoin Transactions (PSBT) are present as of **v0.17.0** ([PR 13557](https://github.com/bitcoin/bitcoin/pull/13557)).\n * [`BIP 176`](https://github.com/bitcoin/bips/blob/master/bip-0176.mediawiki): Bits Denomination [QT only] is supported as of **v0.16.0** ([PR 12035](https://github.com/bitcoin/bitcoin/pull/12035)).\n+* [`BIP 324`](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki): Support for the BIP324 v2 transport protocol and the associated `NODE_P2P_V2` service bit is supported as of **v26.0**, but off by default ([PR 28331](https://github.com/bitcoin/bitcoin/pull/28331)).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1343224142",
      "id" : 1343224142,
      "in_reply_to_id" : 1343157537,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585QD_lO",
      "original_commit_id" : "7b255b56698392019dd575c3bb73f6d8b1334f4b",
      "original_line" : 52,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "doc/bips.md",
      "position" : null,
      "pull_request_review_id" : 1653608536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343224142/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-02T22:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1343224142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK 75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-10-02T23:59:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1743939613",
      "id" : 1743939613,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n8mgd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743939613/reactions"
      },
      "updated_at" : "2023-10-02T23:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1743939613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-10-03T09:12:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1744557221",
      "id" : 1744557221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n-9Sl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1744557221/reactions"
      },
      "updated_at" : "2023-10-03T09:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1744557221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-10-03T09:36:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1744598085",
      "id" : 1744598085,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585n_HRF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1744598085/reactions"
      },
      "updated_at" : "2023-10-03T09:36:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1744598085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "any clear reason why noise protocol hasn't been considered here ? ",
      "created_at" : "2023-10-04T08:13:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1746363314",
      "id" : 1746363314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585oF2Oy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1746363314/reactions"
      },
      "updated_at" : "2023-10-04T08:13:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1746363314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/112706229?v=4",
         "events_url" : "https://api.github.com/users/rsantacroce/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rsantacroce/followers",
         "following_url" : "https://api.github.com/users/rsantacroce/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rsantacroce/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rsantacroce",
         "id" : 112706229,
         "login" : "rsantacroce",
         "node_id" : "U_kgDOBrfCtQ",
         "organizations_url" : "https://api.github.com/users/rsantacroce/orgs",
         "received_events_url" : "https://api.github.com/users/rsantacroce/received_events",
         "repos_url" : "https://api.github.com/users/rsantacroce/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rsantacroce/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rsantacroce/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rsantacroce"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@rsantacroce the BIP explains this under \"Why not use a general-purpose transport encryption protocol?\": https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki",
      "created_at" : "2023-10-04T08:22:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1746377459",
      "id" : 1746377459,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585oF5rz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1746377459/reactions"
      },
      "updated_at" : "2023-10-04T08:22:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1746377459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Thank you, i missed that one! very good explanation now it's the other way around why we don't use it on stratumv2 .... this is for the other repo. thank you and thank you for the great work.",
      "created_at" : "2023-10-04T08:35:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#issuecomment-1746398804",
      "id" : 1746398804,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28331",
      "node_id" : "IC_kwDOABII585oF-5U",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1746398804/reactions"
      },
      "updated_at" : "2023-10-04T08:36:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1746398804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/112706229?v=4",
         "events_url" : "https://api.github.com/users/rsantacroce/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rsantacroce/followers",
         "following_url" : "https://api.github.com/users/rsantacroce/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rsantacroce/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rsantacroce",
         "id" : 112706229,
         "login" : "rsantacroce",
         "node_id" : "U_kgDOBrfCtQ",
         "organizations_url" : "https://api.github.com/users/rsantacroce/orgs",
         "received_events_url" : "https://api.github.com/users/rsantacroce/received_events",
         "repos_url" : "https://api.github.com/users/rsantacroce/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rsantacroce/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rsantacroce/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rsantacroce"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1354481455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354481455"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Issue to add a test: #28635",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-10-11T08:57:21Z",
      "diff_hunk" : "@@ -345,53 +357,70 @@ class CSemaphoreGrant\n     bool fHaveGrant;\n \n public:\n-    void Acquire()\n+    void Acquire() noexcept\n     {\n-        if (fHaveGrant)\n+        if (fHaveGrant) {\n             return;\n+        }\n         sem->wait();\n         fHaveGrant = true;\n     }\n \n-    void Release()\n+    void Release() noexcept\n     {\n-        if (!fHaveGrant)\n+        if (!fHaveGrant) {\n             return;\n+        }\n         sem->post();\n         fHaveGrant = false;\n     }\n \n-    bool TryAcquire()\n+    bool TryAcquire() noexcept\n     {\n-        if (!fHaveGrant && sem->try_wait())\n+        if (!fHaveGrant && sem->try_wait()) {\n             fHaveGrant = true;\n+        }\n         return fHaveGrant;\n     }\n \n-    void MoveTo(CSemaphoreGrant& grant)\n+    // Disallow copy.\n+    CSemaphoreGrant(const CSemaphoreGrant&) = delete;\n+    CSemaphoreGrant& operator=(const CSemaphoreGrant&) = delete;\n+\n+    // Allow move.\n+    CSemaphoreGrant(CSemaphoreGrant&& other) noexcept\n+    {\n+        sem = other.sem;\n+        fHaveGrant = other.fHaveGrant;\n+        other.fHaveGrant = false;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1354481455",
      "id" : 1354481455,
      "in_reply_to_id" : 1340069761,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qu78v",
      "original_commit_id" : "830b23ab80ac089c15e232d1b1e6bbd781ddc749",
      "original_line" : 397,
      "original_position" : 97,
      "original_start_line" : 391,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_review_id" : 1670484720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354481455/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-11T08:57:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1354481455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389597811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389597811"
         }
      },
      "author_association" : "NONE",
      "body" : "@sipa, am I missing something or should this line read:\r\n\r\n`node_1_info = self.nodes[1].getpeerinfo()`",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-11-10T16:04:29Z",
      "diff_hunk" : "@@ -12,19 +12,116 @@\n \n class V2TransportTest(BitcoinTestFramework):\n     def set_test_params(self):\n-        self.setup_clean_chain=True\n-        self.num_nodes = 1\n-        self.extra_args = [[\"-v2transport=0\"]]\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n \n     def run_test(self):\n-        network_info = self.nodes[0].getnetworkinfo()\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # verify local services\n+        network_info = self.nodes[2].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n         assert \"P2P_V2\" not in network_info[\"localservicesnames\"]\n-\n-        self.restart_node(0, [\"-v2transport=1\"])\n-        network_info = self.nodes[0].getnetworkinfo()\n+        network_info = self.nodes[1].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, NODE_P2P_V2)\n         assert \"P2P_V2\" in network_info[\"localservicesnames\"]\n \n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        self.generate(self.nodes[0], 5, sync_fun=lambda: self.sync_all(self.nodes[0:2]))\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+        # verify there is a v2 connection between node 0 and 1\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_1_info = self.nodes[0].getpeerinfo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389597811",
      "id" : 1389597811,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585S05Rz",
      "original_commit_id" : "05d19fbcc10f26c7f1e3a9afc660eb7fa71b1d8c",
      "original_line" : 45,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : 45,
      "pull_request_review_id" : 1725109880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389597811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-10T16:04:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389597811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1489460?v=4",
         "events_url" : "https://api.github.com/users/kashifs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kashifs/followers",
         "following_url" : "https://api.github.com/users/kashifs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kashifs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kashifs",
         "id" : 1489460,
         "login" : "kashifs",
         "node_id" : "MDQ6VXNlcjE0ODk0NjA=",
         "organizations_url" : "https://api.github.com/users/kashifs/orgs",
         "received_events_url" : "https://api.github.com/users/kashifs/received_events",
         "repos_url" : "https://api.github.com/users/kashifs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kashifs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kashifs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kashifs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389608289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389608289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This indeed looks like a bug.",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-11-10T16:13:50Z",
      "diff_hunk" : "@@ -12,19 +12,116 @@\n \n class V2TransportTest(BitcoinTestFramework):\n     def set_test_params(self):\n-        self.setup_clean_chain=True\n-        self.num_nodes = 1\n-        self.extra_args = [[\"-v2transport=0\"]]\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n \n     def run_test(self):\n-        network_info = self.nodes[0].getnetworkinfo()\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # verify local services\n+        network_info = self.nodes[2].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n         assert \"P2P_V2\" not in network_info[\"localservicesnames\"]\n-\n-        self.restart_node(0, [\"-v2transport=1\"])\n-        network_info = self.nodes[0].getnetworkinfo()\n+        network_info = self.nodes[1].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, NODE_P2P_V2)\n         assert \"P2P_V2\" in network_info[\"localservicesnames\"]\n \n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        self.generate(self.nodes[0], 5, sync_fun=lambda: self.sync_all(self.nodes[0:2]))\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+        # verify there is a v2 connection between node 0 and 1\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_1_info = self.nodes[0].getpeerinfo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389608289",
      "id" : 1389608289,
      "in_reply_to_id" : 1389597811,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585S071h",
      "original_commit_id" : "05d19fbcc10f26c7f1e3a9afc660eb7fa71b1d8c",
      "original_line" : 45,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : 45,
      "pull_request_review_id" : 1725126851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389608289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-10T16:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389608289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389692101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389692101"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cc @theStack ",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-11-10T17:35:13Z",
      "diff_hunk" : "@@ -12,19 +12,116 @@\n \n class V2TransportTest(BitcoinTestFramework):\n     def set_test_params(self):\n-        self.setup_clean_chain=True\n-        self.num_nodes = 1\n-        self.extra_args = [[\"-v2transport=0\"]]\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n \n     def run_test(self):\n-        network_info = self.nodes[0].getnetworkinfo()\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # verify local services\n+        network_info = self.nodes[2].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n         assert \"P2P_V2\" not in network_info[\"localservicesnames\"]\n-\n-        self.restart_node(0, [\"-v2transport=1\"])\n-        network_info = self.nodes[0].getnetworkinfo()\n+        network_info = self.nodes[1].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, NODE_P2P_V2)\n         assert \"P2P_V2\" in network_info[\"localservicesnames\"]\n \n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        self.generate(self.nodes[0], 5, sync_fun=lambda: self.sync_all(self.nodes[0:2]))\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+        # verify there is a v2 connection between node 0 and 1\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_1_info = self.nodes[0].getpeerinfo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389692101",
      "id" : 1389692101,
      "in_reply_to_id" : 1389597811,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585S1QTF",
      "original_commit_id" : "05d19fbcc10f26c7f1e3a9afc660eb7fa71b1d8c",
      "original_line" : 45,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : 45,
      "pull_request_review_id" : 1725258154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389692101/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-10T17:35:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389692101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389710284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389710284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch @kashifs. Do you want to open a PR for the fix? If not (for whatever reason), I'm happy to do it and add the commit with your authorship.",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-11-10T17:54:51Z",
      "diff_hunk" : "@@ -12,19 +12,116 @@\n \n class V2TransportTest(BitcoinTestFramework):\n     def set_test_params(self):\n-        self.setup_clean_chain=True\n-        self.num_nodes = 1\n-        self.extra_args = [[\"-v2transport=0\"]]\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n \n     def run_test(self):\n-        network_info = self.nodes[0].getnetworkinfo()\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # verify local services\n+        network_info = self.nodes[2].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n         assert \"P2P_V2\" not in network_info[\"localservicesnames\"]\n-\n-        self.restart_node(0, [\"-v2transport=1\"])\n-        network_info = self.nodes[0].getnetworkinfo()\n+        network_info = self.nodes[1].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, NODE_P2P_V2)\n         assert \"P2P_V2\" in network_info[\"localservicesnames\"]\n \n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        self.generate(self.nodes[0], 5, sync_fun=lambda: self.sync_all(self.nodes[0:2]))\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+        # verify there is a v2 connection between node 0 and 1\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_1_info = self.nodes[0].getpeerinfo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389710284",
      "id" : 1389710284,
      "in_reply_to_id" : 1389597811,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585S1UvM",
      "original_commit_id" : "05d19fbcc10f26c7f1e3a9afc660eb7fa71b1d8c",
      "original_line" : 45,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : 45,
      "pull_request_review_id" : 1725286239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389710284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-10T17:54:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389710284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389939970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389939970"
         }
      },
      "author_association" : "NONE",
      "body" : "I've opened a PR [here](https://github.com/bitcoin/bitcoin/pull/28849). Please let me know if it's done correctly and if there is more that I should do.",
      "commit_id" : "75a329103505736acb9036224da2dfa8ab038c43",
      "created_at" : "2023-11-10T21:28:55Z",
      "diff_hunk" : "@@ -12,19 +12,116 @@\n \n class V2TransportTest(BitcoinTestFramework):\n     def set_test_params(self):\n-        self.setup_clean_chain=True\n-        self.num_nodes = 1\n-        self.extra_args = [[\"-v2transport=0\"]]\n+        self.setup_clean_chain = True\n+        self.num_nodes = 5\n+        self.extra_args = [[\"-v2transport=1\"], [\"-v2transport=1\"], [\"-v2transport=0\"], [\"-v2transport=0\"], [\"-v2transport=0\"]]\n \n     def run_test(self):\n-        network_info = self.nodes[0].getnetworkinfo()\n+        sending_handshake = \"start sending v2 handshake to peer\"\n+        downgrading_to_v1 = \"retrying with v1 transport protocol for peer\"\n+        self.disconnect_nodes(0, 1)\n+        self.disconnect_nodes(1, 2)\n+        self.disconnect_nodes(2, 3)\n+        self.disconnect_nodes(3, 4)\n+\n+        # verify local services\n+        network_info = self.nodes[2].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, 0)\n         assert \"P2P_V2\" not in network_info[\"localservicesnames\"]\n-\n-        self.restart_node(0, [\"-v2transport=1\"])\n-        network_info = self.nodes[0].getnetworkinfo()\n+        network_info = self.nodes[1].getnetworkinfo()\n         assert_equal(int(network_info[\"localservices\"], 16) & NODE_P2P_V2, NODE_P2P_V2)\n         assert \"P2P_V2\" in network_info[\"localservicesnames\"]\n \n+        # V2 nodes can sync with V2 nodes\n+        assert_equal(self.nodes[0].getblockcount(), 0)\n+        assert_equal(self.nodes[1].getblockcount(), 0)\n+        with self.nodes[0].assert_debug_log(expected_msgs=[sending_handshake],\n+                                            unexpected_msgs=[downgrading_to_v1]):\n+            self.connect_nodes(0, 1, peer_advertises_v2=True)\n+        self.generate(self.nodes[0], 5, sync_fun=lambda: self.sync_all(self.nodes[0:2]))\n+        assert_equal(self.nodes[1].getblockcount(), 5)\n+        # verify there is a v2 connection between node 0 and 1\n+        node_0_info = self.nodes[0].getpeerinfo()\n+        node_1_info = self.nodes[0].getpeerinfo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28331#discussion_r1389939970",
      "id" : 1389939970,
      "in_reply_to_id" : 1389597811,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII585S2M0C",
      "original_commit_id" : "05d19fbcc10f26c7f1e3a9afc660eb7fa71b1d8c",
      "original_line" : 45,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "test/functional/p2p_v2_transport.py",
      "position" : 45,
      "pull_request_review_id" : 1725670432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28331",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389939970/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-10T21:30:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1389939970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1489460?v=4",
         "events_url" : "https://api.github.com/users/kashifs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kashifs/followers",
         "following_url" : "https://api.github.com/users/kashifs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kashifs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kashifs",
         "id" : 1489460,
         "login" : "kashifs",
         "node_id" : "MDQ6VXNlcjE0ODk0NjA=",
         "organizations_url" : "https://api.github.com/users/kashifs/orgs",
         "received_events_url" : "https://api.github.com/users/kashifs/received_events",
         "repos_url" : "https://api.github.com/users/kashifs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kashifs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kashifs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kashifs"
      }
   }
]
