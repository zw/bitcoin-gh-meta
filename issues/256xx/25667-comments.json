[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25977](https://github.com/bitcoin/bitcoin/pull/25977) (refactor: Replace `std::optional<bilingual_str>` with `util::Result` by ryanofsky)\n* [#25862](https://github.com/bitcoin/bitcoin/pull/25862) (refactor, kernel: Remove gArgs accesses from dbwrapper and txdb by ryanofsky)\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n* [#25704](https://github.com/bitcoin/bitcoin/pull/25704) (refactor: Remove almost all validation option globals by MarcoFalke)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n* [#25038](https://github.com/bitcoin/bitcoin/pull/25038) (policy: nVersion=3 and Package RBF by glozow)\n* [#23443](https://github.com/bitcoin/bitcoin/pull/23443) (p2p: Erlay support signaling by naumenkogs)\n* [#22663](https://github.com/bitcoin/bitcoin/pull/22663) (dbwrapper: properly destroy objects in case CDBWrapper ctor throws by Crypt-iQ)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n* [#17786](https://github.com/bitcoin/bitcoin/pull/17786) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n* [#16545](https://github.com/bitcoin/bitcoin/pull/16545) (refactor: Implement missing error checking for ArgsManager flags by ryanofsky)\n* [#10443](https://github.com/bitcoin/bitcoin/pull/10443) (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-21T18:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1191798486",
      "id" : 1191798486,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585HCWbW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191798486/reactions"
      },
      "updated_at" : "2022-09-23T10:39:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191798486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r927693341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/927693341"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add testcases for snapshot initialization\" (15da925f2951eaadf81aea9d5b67ec1646581d30)\r\n\r\nMight be a little more robust to destroy the old chainman before creating a new one. I.e. add another blank `chainman.reset()` call before this.",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-07-22T14:11:53Z",
      "diff_hunk" : "@@ -328,6 +354,31 @@ struct SnapshotTestSetup : TestChain100Setup {\n             loaded_snapshot_blockhash);\n         return std::make_tuple(&validation_chainstate, &snapshot_chainstate);\n     }\n+\n+    // Simulate a restart of the node by flushing all state to disk, clearing the\n+    // existing ChainstateManager, and unloading the block index.\n+    //\n+    // @returns a reference to the \"restarted\" ChainstateManager\n+    ChainstateManager& SimulateNodeRestart()\n+    {\n+        ChainstateManager& chainman = *Assert(m_node.chainman);\n+\n+        BOOST_TEST_MESSAGE(\"Simulating node restart\");\n+        {\n+            LOCK(::cs_main);\n+            for (CChainState* cs : chainman.GetAll()) {\n+                cs->ForceFlushStateToDisk();\n+            }\n+            chainman.ResetChainstates();\n+            BOOST_CHECK_EQUAL(chainman.GetAll().size(), 0);\n+            const ChainstateManager::Options chainman_opts{\n+                ::Params(),\n+                static_cast<int64_t(*)()>(::GetTime),\n+            };\n+            m_node.chainman.reset(new ChainstateManager(chainman_opts));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r927693341",
      "id" : 927693341,
      "line" : 378,
      "node_id" : "PRRC_kwDOABII5843S3od",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 378,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 90,
      "pull_request_review_id" : 1047965884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/927693341/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-22T14:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/927693341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934682927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934682927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Am I correct this is not documented in `design/assumeutxo.md` ? I think this is the case where the user already loaded a snapshot UTXO through `loadtxoutset`, a `chainstate_[SHA256 blockhash of snapshot base block]` has been created and the `bitcoind` process is restarted.\r\n\r\n(can be done in a follow-up)",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T15:55:01Z",
      "diff_hunk" : "@@ -31,10 +31,15 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     };\n \n     LOCK(cs_main);\n-    chainman.InitializeChainstate(options.mempool);\n     chainman.m_total_coinstip_cache = cache_sizes.coins;\n     chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n \n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934682927",
      "id" : 934682927,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII5843tiEv",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 41,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 12,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934682927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934682927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934711915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note for reviewers: for now `is_snapshot` is always true as there is a single usage. This is not the case anymore with the remaining commits of the #24232 patchset.",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:27:20Z",
      "diff_hunk" : "@@ -4720,6 +4708,46 @@ const AssumeutxoData* ExpectedAssumeutxo(\n     return nullptr;\n }\n \n+static bool DeleteCoinsDBFromDisk(const fs::path db_path, bool is_snapshot)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934711915",
      "id" : 934711915,
      "line" : 4711,
      "node_id" : "PRRC_kwDOABII5843tpJr",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 4711,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934720426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934720426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "even if name is explicit, could be documented \"Switch active chainstate to snapshot one\" in case of future refactor to check function correctness (and `DetectSnapshotChainstate` could say it activates the snapshot if any)",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:38:11Z",
      "diff_hunk" : "@@ -990,6 +984,15 @@ class ChainstateManager\n     /** Produce the necessary coinbase commitment for a block (modifies the hash, don't call for mined blocks). */\n     std::vector<unsigned char> GenerateCoinbaseCommitment(CBlock& block, const CBlockIndex* pindexPrev) const;\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool* mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    void ResetChainstates() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    CChainState& ActivateExistingSnapshot(CTxMemPool* mempool, uint256 base_blockhash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934720426",
      "id" : 934720426,
      "line" : 993,
      "node_id" : "PRRC_kwDOABII5843trOq",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 993,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 30,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934720426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934720426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934727831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934727831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "comment can be extended \"There should be a single snapshot at any given time\"",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:47:54Z",
      "diff_hunk" : "@@ -33,6 +39,30 @@ class SnapshotMetadata\n \n     SERIALIZE_METHODS(SnapshotMetadata, obj) { READWRITE(obj.m_base_blockhash, obj.m_coins_count); }\n };\n+\n+//! The file in the snapshot chainstate dir which stores the base blockhash. This\n+//! is needed to reconstruct snapshot chainstates on init.\n+const fs::path SNAPSHOT_BLOCKHASH_FILENAME{\"base_blockhash\"};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934727831",
      "id" : 934727831,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII5843ttCX",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 45,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.h",
      "position" : 22,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934727831/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934727831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934731872"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934731872"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note to reviewers: this method is used in the remaining #24232 patchset.",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:52:56Z",
      "diff_hunk" : "@@ -990,6 +984,15 @@ class ChainstateManager\n     /** Produce the necessary coinbase commitment for a block (modifies the hash, don't call for mined blocks). */\n     std::vector<unsigned char> GenerateCoinbaseCommitment(CBlock& block, const CBlockIndex* pindexPrev) const;\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool* mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    void ResetChainstates() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934731872",
      "id" : 934731872,
      "line" : 991,
      "node_id" : "PRRC_kwDOABII5843tuBg",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 991,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 28,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934731872/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934731872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dergoegge I think you could be interested to review the assumeutxo work. In case of future hypothetical integration of libutreexo in Core, I believe there would be intersecting code paths and data structure modified. It might also prepare for future [synergies](https://github.com/jamesob/assumeutxo-docs/tree/master/proposal#how-will-this-work-with-accumulators-uhs-or-utreexo-if-those-things-come-around) between utreexo and assumeutxo.",
      "created_at" : "2022-08-01T17:00:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1201469507",
      "id" : 1201469507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585HnPhD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201469507/reactions"
      },
      "updated_at" : "2022-08-01T17:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201469507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Planning on diving deeply into this, thanks for splitting it up @jamesob!\r\n\r\nQuestions from going over the commits:\r\n\r\nQ1:  Is the intended layout:\r\n- `<datadir>`\r\n  - `chainstate`\r\n    - `*.ldb`\r\n    - `*.log`\r\n    - `CURRENT`\r\n    - `LOCK`\r\n    - `MANIFEST-*`\r\n  - `chainstate_snapshot`\r\n    - `base_blockhash`\r\n    - `*.ldb`\r\n    - `*.log`\r\n    - `CURRENT`\r\n    - `LOCK`\r\n    - `MANIFEST-*` \r\n\r\nQ2: The last 6 commits seem to be focused on unit tests, but it seems to me that the functionality being added here is better tested with functional tests. Is there something we need to test here that a functional test won't be able to do?",
      "created_at" : "2022-08-02T19:51:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1203150779",
      "id" : 1203150779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585Htp-7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203150779/reactions"
      },
      "updated_at" : "2022-08-02T19:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203150779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r935973938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935973938"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note to other reviewers: the call to `DestroyDB` will actually remove the entire directory, including the blockhash file if it still existed since we place the blockhash file inside what leveldb considers to be its directory, but it's probably better (more polite?) to remove it ourselves just so we can print nice errors.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/de3c46c93818c6e4000175bcdbf7dd332f54768d/src/leveldb/db/db_impl.cc#L1550",
      "commit_id" : "2dcb2bda6bda1062880d5a949fd2e4e7f57ef41d",
      "created_at" : "2022-08-02T19:56:04Z",
      "diff_hunk" : "@@ -4708,6 +4708,46 @@ const AssumeutxoData* ExpectedAssumeutxo(\n     return nullptr;\n }\n \n+static bool DeleteCoinsDBFromDisk(const fs::path db_path, bool is_snapshot)\n+    EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+{\n+    AssertLockHeld(::cs_main);\n+\n+    if (is_snapshot) {\n+        fs::path base_blockhash_path = db_path / node::SNAPSHOT_BLOCKHASH_FILENAME;\n+\n+        if (fs::exists(base_blockhash_path)) {\n+            bool removed = fs::remove(base_blockhash_path);\n+            if (!removed) {\n+                LogPrintf(\"[snapshot] failed to remove file %s\\n\",\n+                          fs::PathToString(base_blockhash_path));\n+            }\n+        } else {\n+            LogPrintf(\"[snapshot] snapshot chainstate dir being removed lacks %s file\\n\",\n+                    fs::PathToString(node::SNAPSHOT_BLOCKHASH_FILENAME));\n+        }\n+    }\n+\n+    std::string path_str = fs::PathToString(db_path);\n+    LogPrintf(\"Removing leveldb dir at %s\\n\", path_str);\n+\n+    // We have to destruct before this call leveldb::DB in order to release the db\n+    // lock, otherwise `DestroyDB` will fail. See `leveldb::~DBImpl()`.\n+    const bool destroyed = dbwrapper::DestroyDB(path_str, {}).ok();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r935973938",
      "id" : 935973938,
      "line" : 4796,
      "node_id" : "PRRC_kwDOABII5843ydQy",
      "original_commit_id" : "aa26b508fb3424169108aade3083a9f771dbcab2",
      "original_line" : 4796,
      "original_position" : 29,
      "original_start_line" : 4720,
      "path" : "src/validation.cpp",
      "position" : 81,
      "pull_request_review_id" : 1059352598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935973938/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4780,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-03T01:57:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935973938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-03T09:23:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1203703035",
      "id" : 1203703035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585Hvwz7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203703035/reactions"
      },
      "updated_at" : "2022-08-03T09:23:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203703035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This PR needs rebase.",
      "created_at" : "2022-08-23T01:47:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1223418904",
      "id" : 1223418904,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585I6-QY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1223418904/reactions"
      },
      "updated_at" : "2022-08-23T01:47:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1223418904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964070932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964070932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "2dcb2bda6bda1062880d5a949fd2e4e7f57ef41d",
      "created_at" : "2022-09-06T19:03:56Z",
      "diff_hunk" : "@@ -328,6 +354,31 @@ struct SnapshotTestSetup : TestChain100Setup {\n             loaded_snapshot_blockhash);\n         return std::make_tuple(&validation_chainstate, &snapshot_chainstate);\n     }\n+\n+    // Simulate a restart of the node by flushing all state to disk, clearing the\n+    // existing ChainstateManager, and unloading the block index.\n+    //\n+    // @returns a reference to the \"restarted\" ChainstateManager\n+    ChainstateManager& SimulateNodeRestart()\n+    {\n+        ChainstateManager& chainman = *Assert(m_node.chainman);\n+\n+        BOOST_TEST_MESSAGE(\"Simulating node restart\");\n+        {\n+            LOCK(::cs_main);\n+            for (CChainState* cs : chainman.GetAll()) {\n+                cs->ForceFlushStateToDisk();\n+            }\n+            chainman.ResetChainstates();\n+            BOOST_CHECK_EQUAL(chainman.GetAll().size(), 0);\n+            const ChainstateManager::Options chainman_opts{\n+                ::Params(),\n+                static_cast<int64_t(*)()>(::GetTime),\n+            };\n+            m_node.chainman.reset(new ChainstateManager(chainman_opts));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964070932",
      "id" : 964070932,
      "in_reply_to_id" : 927693341,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII5845do4U",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 382,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 378,
      "pull_request_review_id" : 1098110998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964070932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T19:03:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964070932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964072176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This wasn't documented, but I've just added some related doc in this PR. There are more doc updates, of course, in the follow-on PR (#25740).",
      "commit_id" : "2dcb2bda6bda1062880d5a949fd2e4e7f57ef41d",
      "created_at" : "2022-09-06T19:05:31Z",
      "diff_hunk" : "@@ -31,10 +31,15 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     };\n \n     LOCK(cs_main);\n-    chainman.InitializeChainstate(options.mempool);\n     chainman.m_total_coinstip_cache = cache_sizes.coins;\n     chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n \n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964072176",
      "id" : 964072176,
      "in_reply_to_id" : 934682927,
      "line" : 58,
      "node_id" : "PRRC_kwDOABII5845dpLw",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 58,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 12,
      "pull_request_review_id" : 1098112709,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072176/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T19:05:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964072299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072299"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "2dcb2bda6bda1062880d5a949fd2e4e7f57ef41d",
      "created_at" : "2022-09-06T19:05:40Z",
      "diff_hunk" : "@@ -990,6 +984,15 @@ class ChainstateManager\n     /** Produce the necessary coinbase commitment for a block (modifies the hash, don't call for mined blocks). */\n     std::vector<unsigned char> GenerateCoinbaseCommitment(CBlock& block, const CBlockIndex* pindexPrev) const;\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool* mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    void ResetChainstates() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    CChainState& ActivateExistingSnapshot(CTxMemPool* mempool, uint256 base_blockhash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964072299",
      "id" : 964072299,
      "in_reply_to_id" : 934720426,
      "line" : 1058,
      "node_id" : "PRRC_kwDOABII5845dpNr",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 1058,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 32,
      "pull_request_review_id" : 1098112889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072299/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T19:05:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964072430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "2dcb2bda6bda1062880d5a949fd2e4e7f57ef41d",
      "created_at" : "2022-09-06T19:05:49Z",
      "diff_hunk" : "@@ -33,6 +39,30 @@ class SnapshotMetadata\n \n     SERIALIZE_METHODS(SnapshotMetadata, obj) { READWRITE(obj.m_base_blockhash, obj.m_coins_count); }\n };\n+\n+//! The file in the snapshot chainstate dir which stores the base blockhash. This\n+//! is needed to reconstruct snapshot chainstates on init.\n+const fs::path SNAPSHOT_BLOCKHASH_FILENAME{\"base_blockhash\"};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964072430",
      "id" : 964072430,
      "in_reply_to_id" : 934727831,
      "line" : 48,
      "node_id" : "PRRC_kwDOABII5845dpPu",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 48,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.h",
      "position" : 25,
      "pull_request_review_id" : 1098113062,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072430/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T19:05:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964072430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hi all, sorry for the delay. My spirit has been weak the last few months, and I took two weeks off to try and shake the burnout. \r\n\r\nI've addressed all feedback listed here and rebased.\r\n\r\n@dongcarl asks:\r\n\r\n> Q1: Is the intended layout:\r\n\r\nYep, it is.\r\n\r\n> Q2: The last 6 commits seem to be focused on unit tests, but it seems to me that the functionality being added here is better tested with functional tests. Is there something we need to test here that a functional test won't be able to do?\r\n\r\nWe can't have functional tests to exercise this behavior until we add `loadtxoutset` to the RPC interface, which will effectively reveal assumeutxo to end users before all the necessary changes have been made to make it usable. Plus, I think the unittests allow us to more easily express granular testcases and assertions.",
      "created_at" : "2022-09-06T19:09:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1238548918",
      "id" : 1238548918,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585J0sG2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238548918/reactions"
      },
      "updated_at" : "2022-09-06T19:09:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238548918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964637337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964637337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "isn't this outdated now after d59db4ff4b585d2b86b68ea0db206ec1c0cc5022?",
      "commit_id" : "f73ca14c2f26b74312d4a43cb7cbc622f12739b7",
      "created_at" : "2022-09-07T09:55:54Z",
      "diff_hunk" : "@@ -77,7 +77,9 @@ original chainstate remains in use as active.\n Once the snapshot chainstate is loaded and validated, it is promoted to active\n chainstate and a sync to tip begins. A new chainstate directory is created in the\n datadir for the snapshot chainstate called\n-`chainstate_[SHA256 blockhash of snapshot base block]`.\n+`chainstate_[SHA256 blockhash of snapshot base block]`. When this directory is present",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r964637337",
      "id" : 964637337,
      "line" : 80,
      "node_id" : "PRRC_kwDOABII5845fzKZ",
      "original_commit_id" : "f73ca14c2f26b74312d4a43cb7cbc622f12739b7",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "doc/design/assumeutxo.md",
      "position" : 5,
      "pull_request_review_id" : 1098881912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964637337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-07T09:55:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964637337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r965061476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/965061476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, good catch.",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-07T16:34:00Z",
      "diff_hunk" : "@@ -77,7 +77,9 @@ original chainstate remains in use as active.\n Once the snapshot chainstate is loaded and validated, it is promoted to active\n chainstate and a sync to tip begins. A new chainstate directory is created in the\n datadir for the snapshot chainstate called\n-`chainstate_[SHA256 blockhash of snapshot base block]`.\n+`chainstate_[SHA256 blockhash of snapshot base block]`. When this directory is present",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r965061476",
      "id" : 965061476,
      "in_reply_to_id" : 964637337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845hatk",
      "original_commit_id" : "f73ca14c2f26b74312d4a43cb7cbc622f12739b7",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "doc/design/assumeutxo.md",
      "position" : null,
      "pull_request_review_id" : 1099495631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/965061476/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-07T16:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/965061476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 1430518eeced979449c3b031bea02fd707b26d1a",
      "created_at" : "2022-09-07T16:59:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1239651688",
      "id" : 1239651688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585J45Vo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1239651688/reactions"
      },
      "updated_at" : "2022-09-07T16:59:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1239651688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969714945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969714945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in 75bb0c54b383e434695bf6bc1d60ef5bcd83cd70:\r\n\r\nCan combine both into\r\n\r\n```cpp\r\n    //! path to filesystem storage or std::nullopt if database resides in memory\r\n    std::optional<fs::path> m_path;",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T14:37:10Z",
      "diff_hunk" : "@@ -219,6 +223,12 @@ class CDBWrapper\n \n     std::vector<unsigned char> CreateObfuscateKey() const;\n \n+    //! path to filesystem storage\n+    const fs::path m_path;\n+\n+    //! whether or not the database resides in memory\n+    bool m_is_memory;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969714945",
      "id" : 969714945,
      "line" : 231,
      "node_id" : "PRRC_kwDOABII5845zK0B",
      "original_commit_id" : "75bb0c54b383e434695bf6bc1d60ef5bcd83cd70",
      "original_line" : 231,
      "original_position" : 20,
      "original_start_line" : 226,
      "path" : "src/dbwrapper.h",
      "position" : 20,
      "pull_request_review_id" : 1105931238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969714945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 226,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T14:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969714945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969724670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969724670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in d59db4ff4b585d2b86b68ea0db206ec1c0cc5022:\r\n\r\n```diff\r\ndiff --git a/src/node/utxo_snapshot.cpp b/src/node/utxo_snapshot.cpp\r\nindex 9c9947df95..2c5885198b 100644\r\n--- a/src/node/utxo_snapshot.cpp\r\n+++ b/src/node/utxo_snapshot.cpp\r\n@@ -25,7 +25,7 @@ bool WriteSnapshotBaseBlockhash(CChainState& snapshot_chainstate)\r\n     const fs::path write_to = *chaindir / node::SNAPSHOT_BLOCKHASH_FILENAME;\r\n \r\n     FILE* file{fsbridge::fopen(write_to, \"wb\")};\r\n-    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\r\n+    AutoFile afile{file};\r\n     if (afile.IsNull()) {\r\n         LogPrintf(\"[snapshot] failed to open base blockhash file for writing: %s\\n\",\r\n                   fs::PathToString(write_to));\r\n@@ -60,7 +60,7 @@ std::optional<uint256> ReadSnapshotBaseBlockhash(fs::path chaindir)\r\n \r\n     uint256 base_blockhash;\r\n     FILE* file{fsbridge::fopen(read_from, \"rb\")};\r\n-    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\r\n+    AutoFile afile{file};\r\n     if (afile.IsNull()) {\r\n         LogPrintf(\"[snapshot] failed to open base blockhash file for reading: %s\\n\",\r\n             read_from_str);\r\n",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T14:45:11Z",
      "diff_hunk" : "@@ -0,0 +1,79 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/utxo_snapshot.h>\n+\n+#include <fs.h>\n+#include <logging.h>\n+#include <streams.h>\n+#include <uint256.h>\n+#include <validation.h>\n+\n+#include <cstdio>\n+#include <optional>\n+\n+namespace node {\n+\n+bool WriteSnapshotBaseBlockhash(CChainState& snapshot_chainstate)\n+{\n+    AssertLockHeld(::cs_main);\n+    assert(snapshot_chainstate.m_from_snapshot_blockhash);\n+\n+    const std::optional<fs::path> chaindir = snapshot_chainstate.CoinsDB().StoragePath();\n+    assert(chaindir); // Sanity check that chainstate isn't in-memory.\n+    const fs::path write_to = *chaindir / node::SNAPSHOT_BLOCKHASH_FILENAME;\n+\n+    FILE* file{fsbridge::fopen(write_to, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969724670",
      "id" : 969724670,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zNL-",
      "original_commit_id" : "d59db4ff4b585d2b86b68ea0db206ec1c0cc5022",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.cpp",
      "position" : null,
      "pull_request_review_id" : 1105931238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969724670/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T14:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969724670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969727651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969727651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "question in https://github.com/bitcoin/bitcoin/commit/d59db4ff4b585d2b86b68ea0db206ec1c0cc5022: why can't the blockhash be read from the metadata in the dump?",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T14:47:36Z",
      "diff_hunk" : "@@ -0,0 +1,79 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/utxo_snapshot.h>\n+\n+#include <fs.h>\n+#include <logging.h>\n+#include <streams.h>\n+#include <uint256.h>\n+#include <validation.h>\n+\n+#include <cstdio>\n+#include <optional>\n+\n+namespace node {\n+\n+bool WriteSnapshotBaseBlockhash(CChainState& snapshot_chainstate)\n+{\n+    AssertLockHeld(::cs_main);\n+    assert(snapshot_chainstate.m_from_snapshot_blockhash);\n+\n+    const std::optional<fs::path> chaindir = snapshot_chainstate.CoinsDB().StoragePath();\n+    assert(chaindir); // Sanity check that chainstate isn't in-memory.\n+    const fs::path write_to = *chaindir / node::SNAPSHOT_BLOCKHASH_FILENAME;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969727651",
      "id" : 969727651,
      "line" : 26,
      "node_id" : "PRRC_kwDOABII5845zN6j",
      "original_commit_id" : "d59db4ff4b585d2b86b68ea0db206ec1c0cc5022",
      "original_line" : 26,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.cpp",
      "position" : 26,
      "pull_request_review_id" : 1105931238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969727651/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T14:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969727651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969731792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969731792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            Assert(chain.LoadGenesisBlock());\r\n```\r\n\r\nmight be better to not continue execution when this fails?",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T14:50:54Z",
      "diff_hunk" : "@@ -48,7 +62,39 @@ CreateAndActivateUTXOSnapshot(node::NodeContext& node, const fs::path root, F ma\n \n     malleation(auto_infile, metadata);\n \n-    return node.chainman->ActivateSnapshot(auto_infile, metadata, /*in_memory=*/true);\n+    if (reset_chainstate) {\n+        {\n+            // What follows is code to selectively reset chainstate data without\n+            // disturbing the existing BlockManager instance, which is needed to\n+            // recognize the headers chain previously generated by the chainstate we're\n+            // removing. Without those headers, we can't activate the snapshot below.\n+            //\n+            // This is a stripped-down version of node::LoadChainstate which\n+            // preserves the block index.\n+            LOCK(::cs_main);\n+            uint256 gen_hash = node.chainman->ActiveChainstate().m_chain[0]->GetBlockHash();\n+            node.chainman->ResetChainstates();\n+            node.chainman->InitializeChainstate(node.mempool.get());\n+            CChainState& chain = node.chainman->ActiveChainstate();\n+            BOOST_CHECK(chain.LoadGenesisBlock());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969731792",
      "id" : 969731792,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zO7Q",
      "original_commit_id" : "1430518eeced979449c3b031bea02fd707b26d1a",
      "original_line" : 79,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 1105931238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969731792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T14:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969731792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969732428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969732428"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        Assert(\r\n```",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T14:51:26Z",
      "diff_hunk" : "@@ -48,7 +62,39 @@ CreateAndActivateUTXOSnapshot(node::NodeContext& node, const fs::path root, F ma\n \n     malleation(auto_infile, metadata);\n \n-    return node.chainman->ActivateSnapshot(auto_infile, metadata, /*in_memory=*/true);\n+    if (reset_chainstate) {\n+        {\n+            // What follows is code to selectively reset chainstate data without\n+            // disturbing the existing BlockManager instance, which is needed to\n+            // recognize the headers chain previously generated by the chainstate we're\n+            // removing. Without those headers, we can't activate the snapshot below.\n+            //\n+            // This is a stripped-down version of node::LoadChainstate which\n+            // preserves the block index.\n+            LOCK(::cs_main);\n+            uint256 gen_hash = node.chainman->ActiveChainstate().m_chain[0]->GetBlockHash();\n+            node.chainman->ResetChainstates();\n+            node.chainman->InitializeChainstate(node.mempool.get());\n+            CChainState& chain = node.chainman->ActiveChainstate();\n+            BOOST_CHECK(chain.LoadGenesisBlock());\n+            // These cache values will be corrected shortly in `MaybeRebalanceCaches`.\n+            chain.InitCoinsDB(1 << 20, true, false, \"\");\n+            chain.InitCoinsCache(1 << 20);\n+            chain.CoinsTip().SetBestBlock(gen_hash);\n+            chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n+            chain.LoadChainTip();\n+            node.chainman->MaybeRebalanceCaches();\n+        }\n+        BlockValidationState state;\n+        if (!node.chainman->ActiveChainstate().ActivateBestChain(state)) {\n+            throw std::runtime_error(strprintf(\"ActivateBestChain failed. (%s)\", state.ToString()));\n+        }\n+        BOOST_CHECK_EQUAL(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969732428",
      "id" : 969732428,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zPFM",
      "original_commit_id" : "1430518eeced979449c3b031bea02fd707b26d1a",
      "original_line" : 92,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 1105931238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969732428/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T14:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969732428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969850661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969850661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "By \"dump\" do you mean the UTXO snapshot? If so, I don't think we can expect users to keep the snapshot on-hand after they've loaded it; it's essentially unnecessary at that point, and multiple GBs.",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T16:31:51Z",
      "diff_hunk" : "@@ -0,0 +1,79 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/utxo_snapshot.h>\n+\n+#include <fs.h>\n+#include <logging.h>\n+#include <streams.h>\n+#include <uint256.h>\n+#include <validation.h>\n+\n+#include <cstdio>\n+#include <optional>\n+\n+namespace node {\n+\n+bool WriteSnapshotBaseBlockhash(CChainState& snapshot_chainstate)\n+{\n+    AssertLockHeld(::cs_main);\n+    assert(snapshot_chainstate.m_from_snapshot_blockhash);\n+\n+    const std::optional<fs::path> chaindir = snapshot_chainstate.CoinsDB().StoragePath();\n+    assert(chaindir); // Sanity check that chainstate isn't in-memory.\n+    const fs::path write_to = *chaindir / node::SNAPSHOT_BLOCKHASH_FILENAME;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969850661",
      "id" : 969850661,
      "in_reply_to_id" : 969727651,
      "line" : 26,
      "node_id" : "PRRC_kwDOABII5845zr8l",
      "original_commit_id" : "d59db4ff4b585d2b86b68ea0db206ec1c0cc5022",
      "original_line" : 26,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.cpp",
      "position" : 26,
      "pull_request_review_id" : 1106120535,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969850661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T16:31:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969850661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-09-13T16:34:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1245663392",
      "id" : 1245663392,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585KP1Cg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245663392/reactions"
      },
      "updated_at" : "2022-09-13T16:34:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245663392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969857674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969857674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, makes sense.",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T16:39:07Z",
      "diff_hunk" : "@@ -0,0 +1,79 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/utxo_snapshot.h>\n+\n+#include <fs.h>\n+#include <logging.h>\n+#include <streams.h>\n+#include <uint256.h>\n+#include <validation.h>\n+\n+#include <cstdio>\n+#include <optional>\n+\n+namespace node {\n+\n+bool WriteSnapshotBaseBlockhash(CChainState& snapshot_chainstate)\n+{\n+    AssertLockHeld(::cs_main);\n+    assert(snapshot_chainstate.m_from_snapshot_blockhash);\n+\n+    const std::optional<fs::path> chaindir = snapshot_chainstate.CoinsDB().StoragePath();\n+    assert(chaindir); // Sanity check that chainstate isn't in-memory.\n+    const fs::path write_to = *chaindir / node::SNAPSHOT_BLOCKHASH_FILENAME;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969857674",
      "id" : 969857674,
      "in_reply_to_id" : 969727651,
      "line" : 26,
      "node_id" : "PRRC_kwDOABII5845ztqK",
      "original_commit_id" : "d59db4ff4b585d2b86b68ea0db206ec1c0cc5022",
      "original_line" : 26,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.cpp",
      "position" : 26,
      "pull_request_review_id" : 1106130537,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969857674/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T16:39:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969857674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969909254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969909254"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think @ryanofsky brought this up earlier; while I agree it would be a good change, it will broaden the scope of this PR quite a bit because all uses of CDBWrapper will have to change, since `path` is currently a required argument. PR is already large, so this could be a follow-up.",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-13T17:36:11Z",
      "diff_hunk" : "@@ -219,6 +223,12 @@ class CDBWrapper\n \n     std::vector<unsigned char> CreateObfuscateKey() const;\n \n+    //! path to filesystem storage\n+    const fs::path m_path;\n+\n+    //! whether or not the database resides in memory\n+    bool m_is_memory;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r969909254",
      "id" : 969909254,
      "in_reply_to_id" : 969714945,
      "line" : 231,
      "node_id" : "PRRC_kwDOABII5845z6QG",
      "original_commit_id" : "75bb0c54b383e434695bf6bc1d60ef5bcd83cd70",
      "original_line" : 231,
      "original_position" : 20,
      "original_start_line" : 226,
      "path" : "src/dbwrapper.h",
      "position" : 20,
      "pull_request_review_id" : 1106202565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969909254/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 226,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T17:36:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969909254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the feedback @MarcoFalke, all addressed.",
      "created_at" : "2022-09-13T17:36:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1245729555",
      "id" : 1245729555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585KQFMT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245729555/reactions"
      },
      "updated_at" : "2022-09-13T17:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245729555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-14T07:39:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1246368360",
      "id" : 1246368360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585KShJo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1246368360/reactions"
      },
      "updated_at" : "2022-09-14T07:39:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1246368360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r972513942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/972513942"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it could be valuable to document `CAutoFile` in `streams.h`, there is no document to explain the diff compared to `AutoFile`. From my understanding, it's a wrapper to handle file pointer, without having to bother with serialization type and versioning.",
      "commit_id" : "bf9597606166323158bbf631137b82d41f39334f",
      "created_at" : "2022-09-16T00:24:43Z",
      "diff_hunk" : "@@ -0,0 +1,79 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <node/utxo_snapshot.h>\n+\n+#include <fs.h>\n+#include <logging.h>\n+#include <streams.h>\n+#include <uint256.h>\n+#include <validation.h>\n+\n+#include <cstdio>\n+#include <optional>\n+\n+namespace node {\n+\n+bool WriteSnapshotBaseBlockhash(CChainState& snapshot_chainstate)\n+{\n+    AssertLockHeld(::cs_main);\n+    assert(snapshot_chainstate.m_from_snapshot_blockhash);\n+\n+    const std::optional<fs::path> chaindir = snapshot_chainstate.CoinsDB().StoragePath();\n+    assert(chaindir); // Sanity check that chainstate isn't in-memory.\n+    const fs::path write_to = *chaindir / node::SNAPSHOT_BLOCKHASH_FILENAME;\n+\n+    FILE* file{fsbridge::fopen(write_to, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r972513942",
      "id" : 972513942,
      "in_reply_to_id" : 969724670,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584592KW",
      "original_commit_id" : "d59db4ff4b585d2b86b68ea0db206ec1c0cc5022",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.cpp",
      "position" : null,
      "pull_request_review_id" : 1109968403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/972513942/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-16T00:24:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/972513942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm counting 4 ACKs here - what more is needed to merge?",
      "created_at" : "2022-10-04T17:40:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1267341291",
      "id" : 1267341291,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585Lihfr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1267341291/reactions"
      },
      "updated_at" : "2022-10-04T17:40:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1267341291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
