[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926102164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926102164"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can remove the bottom `scriptChange = GetScriptForDestination(dest);` call if `GetReservedDestination` failed (no valid destination).\r\n```c++\r\nauto op_dest = reservedest.GetReservedDestination(true);\r\nif (!op_dest) {\r\n    error = _(\"Transaction needs a change address, but we can't generate it.\") + Untranslated(\" \") + op_dest.GetError();\r\n} else {\r\n    scriptChange = GetScriptForDestination(op_dest.GetObj());\r\n}\r\n```",
      "commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "created_at" : "2022-07-20T22:26:10Z",
      "diff_hunk" : "@@ -706,9 +706,11 @@ static BResult<CreatedTransactionResult> CreateTransactionInternal(\n         // Reserve a new key pair from key pool. If it fails, provide a dummy\n         // destination in case we don't need change.\n         CTxDestination dest;\n-        bilingual_str dest_err;\n-        if (!reservedest.GetReservedDestination(dest, true, dest_err)) {\n-            error = _(\"Transaction needs a change address, but we can't generate it.\") + Untranslated(\" \") + dest_err;\n+        auto op_dest = reservedest.GetReservedDestination(true);\n+        if (op_dest.HasRes()) {\n+            dest = op_dest.ReleaseObj();\n+        } else {\n+            error = _(\"Transaction needs a change address, but we can't generate it.\") + Untranslated(\" \") + op_dest.GetError();\n         }\n         scriptChange = GetScriptForDestination(dest);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926102164",
      "id" : 926102164,
      "line" : 715,
      "node_id" : "PRRC_kwDOABII5843MzKU",
      "original_commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "original_line" : 715,
      "original_position" : 13,
      "original_start_line" : 708,
      "path" : "src/wallet/spend.cpp",
      "position" : 13,
      "pull_request_review_id" : 1045739783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926102164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 708,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-20T22:26:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926102164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926104644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926104644"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Because CTxDestination default value is `CNoDestination`, this will return a succeed `BResult` object.\r\nWould be better to do:\r\n```c+++\r\nreturn Untranslated(\"Not supported\");\r\n```\r\n\r\n(same as we are doing for the base `GetNewDestination`)",
      "commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "created_at" : "2022-07-20T22:30:44Z",
      "diff_hunk" : "@@ -179,7 +179,7 @@ class ScriptPubKeyMan\n     virtual bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) { return false; }\n     virtual bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) { return false; }\n \n-    virtual bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool, bilingual_str& error) { return false; }\n+    virtual BResult<CTxDestination> GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool) { return {}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926104644",
      "id" : 926104644,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII5843MzxE",
      "original_commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "original_line" : 182,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 5,
      "pull_request_review_id" : 1045745491,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926104644/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-20T22:37:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926104644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926108015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926108015"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about this:\r\n```c++\r\nconst auto& op_address = m_spk_man->GetReservedDestination(type, internal, nIndex, keypool);\r\nif (!op_address) return op_address;\r\nfInternal = keypool.fInternal;\r\naddress = op_address.ReleaseObj();\r\n```",
      "commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "created_at" : "2022-07-20T22:37:01Z",
      "diff_hunk" : "@@ -2423,27 +2419,28 @@ std::set<std::string> CWallet::ListAddrBookLabels(const std::string& purpose) co\n     return label_set;\n }\n \n-bool ReserveDestination::GetReservedDestination(CTxDestination& dest, bool internal, bilingual_str& error)\n+BResult<CTxDestination> ReserveDestination::GetReservedDestination(bool internal)\n {\n     m_spk_man = pwallet->GetScriptPubKeyMan(type, internal);\n     if (!m_spk_man) {\n-        error = strprintf(_(\"Error: No %s addresses available.\"), FormatOutputType(type));\n-        return false;\n+        return strprintf(_(\"Error: No %s addresses available.\"), FormatOutputType(type));\n     }\n \n-\n     if (nIndex == -1)\n     {\n         m_spk_man->TopUp();\n \n         CKeyPool keypool;\n-        if (!m_spk_man->GetReservedDestination(type, internal, address, nIndex, keypool, error)) {\n-            return false;\n+\n+        auto op_address = m_spk_man->GetReservedDestination(type, internal, nIndex, keypool);\n+        if (op_address.HasRes()) {\n+            address = op_address.ReleaseObj();\n+        } else {\n+            return op_address.GetError();\n         }\n         fInternal = keypool.fInternal;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926108015",
      "id" : 926108015,
      "line" : 2441,
      "node_id" : "PRRC_kwDOABII5843M0lv",
      "original_commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "original_line" : 2441,
      "original_position" : 48,
      "original_start_line" : 2435,
      "path" : "src/wallet/wallet.cpp",
      "position" : 48,
      "pull_request_review_id" : 1045745491,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926108015/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2435,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-20T22:37:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926108015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926266371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926266371"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would have expected for `{}` to return an empty error message. Is there any way to avoid this confusion at compile time?",
      "commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "created_at" : "2022-07-21T05:30:40Z",
      "diff_hunk" : "@@ -179,7 +179,7 @@ class ScriptPubKeyMan\n     virtual bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) { return false; }\n     virtual bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) { return false; }\n \n-    virtual bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool, bilingual_str& error) { return false; }\n+    virtual BResult<CTxDestination> GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool) { return {}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926266371",
      "id" : 926266371,
      "in_reply_to_id" : 926104644,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII5843NbQD",
      "original_commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "original_line" : 182,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 5,
      "pull_request_review_id" : 1045953160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926266371/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-21T05:30:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926266371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25526](https://github.com/bitcoin/bitcoin/pull/25526) (wallet: avoid double keypool TopUp() calls on descriptor wallets by furszy)\n* [#25297](https://github.com/bitcoin/bitcoin/pull/25297) (wallet: speedup transactions sync, rescan and load by grouping all independent db writes on a single batched db transaction by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-21T06:47:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25656#issuecomment-1191106100",
      "id" : 1191106100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25656",
      "node_id" : "IC_kwDOABII585G_tY0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191106100/reactions"
      },
      "updated_at" : "2022-07-21T06:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191106100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926646522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926646522"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I would have expected for `{}` to return an empty error message. Is there any way to avoid this confusion at compile time?\r\n\r\nI think the silent conversion of bilingual_str into errors is an anti-feature. Not every translated string is necessarily an error string, and the conversion makes it not possible to use a `BResult<bilingual_str>` type that returns a normal translated string. #25665 improves this by adding an explicit error contructor",
      "commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "created_at" : "2022-07-21T13:01:00Z",
      "diff_hunk" : "@@ -179,7 +179,7 @@ class ScriptPubKeyMan\n     virtual bool CheckDecryptionKey(const CKeyingMaterial& master_key, bool accept_no_keys = false) { return false; }\n     virtual bool Encrypt(const CKeyingMaterial& master_key, WalletBatch* batch) { return false; }\n \n-    virtual bool GetReservedDestination(const OutputType type, bool internal, CTxDestination& address, int64_t& index, CKeyPool& keypool, bilingual_str& error) { return false; }\n+    virtual BResult<CTxDestination> GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool) { return {}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25656#discussion_r926646522",
      "id" : 926646522,
      "in_reply_to_id" : 926104644,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII5843O4D6",
      "original_commit_id" : "d7c37ed9897ed791c998163c7fd93cc968441bdb",
      "original_line" : 182,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 5,
      "pull_request_review_id" : 1046489449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25656",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926646522/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-21T13:01:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926646522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
