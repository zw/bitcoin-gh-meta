[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r346960653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346960653"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use the ternary operator instead for less code and no captures?\r\n\r\n```cpp\r\nfor ( ... ; it = erase ? mapCoins.erase(it) : ++it) {",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2019-11-15T18:45:55Z",
      "diff_hunk" : "@@ -144,8 +144,15 @@ void CCoinsViewCache::SetBestBlock(const uint256 &hashBlockIn) {\n     hashBlock = hashBlockIn;\n }\n \n-bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn) {\n-    for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); it = mapCoins.erase(it)) {\n+bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn, bool erase) {\n+    auto iter_fnc = [&mapCoins, erase](CCoinsMap::iterator it) {\n+        if (erase) {\n+            return mapCoins.erase(it);\n+        } else {\n+            return it++;\n+        }\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r346960653",
      "id" : 346960653,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Njk2MDY1Mw==",
      "original_commit_id" : "bd44f51d790edc07b7e1224e0f8bfce4252c74d5",
      "original_line" : 154,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 317801224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346960653",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Does this speed up IBD with low dbcache? If so, a benchmark would be nice\r\n\r\nNo, this PR doesn't change any existing behavior - it simply introduces the option to avoid erasing the cache (which is later used by assumeutxo's snapshot activation code). This changeset shouldn't cause any sort of performance difference.",
      "created_at" : "2019-11-15T18:51:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-554483423",
      "id" : 554483423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDQ4MzQyMw==",
      "updated_at" : "2019-11-15T18:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554483423",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r346999363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346999363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Isn't passing the argument explicitly better than with a default one? Also it's worthy to extend method comment a bit with effect of argument on cache.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2019-11-15T20:30:51Z",
      "diff_hunk" : "@@ -275,7 +275,7 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * Failure to call this method before destruction will cause the changes to be forgotten.\n      * If false is returned, the state of this cache (and its backing view) will be undefined.\n      */\n-    bool Flush();\n+    bool Flush(bool clear_cache = true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r346999363",
      "id" : 346999363,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0Njk5OTM2Mw==",
      "original_commit_id" : "bd44f51d790edc07b7e1224e0f8bfce4252c74d5",
      "original_line" : 278,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 317853720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346999363",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/17487#pullrequestreview-847197360), [achow101](https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-1386240386) |\n| Concept ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-555608657), [Sjors](https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-832916004) |\n| Stale ACK | [ariard](https://github.com/bitcoin/bitcoin/pull/17487#pullrequestreview-317853720), [dongcarl](https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-554534416), [jnewbery](https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-637156481), [jonatack](https://github.com/bitcoin/bitcoin/pull/17487#pullrequestreview-422785077), [andrewtoth](https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-638494243) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25325](https://github.com/bitcoin/bitcoin/pull/25325) (Add pool based memory resource by martinus)\n* [#9384](https://github.com/bitcoin/bitcoin/pull/9384) (CCoinsViewCache code cleanup & deduplication by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2019-11-15T21:08:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-554529034",
      "id" : 554529034,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDUyOTAzNA==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554529034/reactions"
      },
      "updated_at" : "2023-01-17T23:35:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554529034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code Review ACK bd44f51d790edc07b7e1224e0f8bfce4252c74d5\r\nChecked that it doesn't change any behavior, if the compiler is smart enough about detecting unused codepaths/function signatures, it will probably even emit an unchanged binary.",
      "created_at" : "2019-11-15T21:25:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-554534416",
      "id" : 554534416,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDUzNDQxNg==",
      "updated_at" : "2019-11-15T21:25:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554534416",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the looks, everyone. I've incorporated feedback from @MarcoFalke and @ariard. [(diff)](https://github.com/bitcoin/bitcoin/compare/bd44f51d790edc07b7e1224e0f8bfce4252c74d5..a22b1fb1d4a239a47790a0522bb3f5e493cb9e57)",
      "created_at" : "2019-11-15T21:38:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-554538716",
      "id" : 554538716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDUzODcxNg==",
      "updated_at" : "2019-11-15T21:38:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554538716",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Why is it that you don't need this bit in your followup PR? https://github.com/bitcoin/bitcoin/pull/15265/files#diff-cd7b305fd4b4280f22ae88960e60398eR210-R222",
      "created_at" : "2019-11-19T16:31:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-555591310",
      "id" : 555591310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTU5MTMxMA==",
      "updated_at" : "2019-11-19T16:31:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555591310",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Given that this does not improve performance (see https://github.com/bitcoin/bitcoin/pull/15265#issuecomment-458657451), is this needed at all? If so, sharing a benchmark with steps to reproduce would be helpful.\r\n\r\nAnyway, I'd like to see the tests in `src/test/coins_tests.cpp` updated to cover the newly added paths.",
      "created_at" : "2019-11-19T16:57:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-555603581",
      "id" : 555603581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTYwMzU4MQ==",
      "updated_at" : "2019-11-19T16:57:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555603581",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, but:\r\n\r\n- I think the PR description should be clearer that this change by itself doesn't change behavior.\r\n- I don't understand how this speeds up UTXO snapshot activation if conclusion from #15265 is that the cache is only really functioning as a write cache and not a read cache.\r\n- I agree with Marco about testing. This definitely needs unit tests or some coverage to unsure this isn't adding broken functionality, or code that could easily be broken in the future with no one noticing.\r\n- I agree with Antoine about the Flush method signature. Using a default boolean argument seems error prone. Explicit parameter would be ok, but better would just be to have separate methods like `Flush()` and `Sync()` or `Flush()` and `Write()`",
      "created_at" : "2019-11-19T17:08:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-555608657",
      "id" : 555608657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTYwODY1Nw==",
      "updated_at" : "2019-11-19T17:08:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555608657",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Alright, given the controversy here now is probably as good a time as any to back up and figure out exactly what `cacheCoins`' impact is on performance, for both this PR and posterity, so I'm going to benchmark\r\n1. a reindex to 550,000 with and without an in-memory UTXO cache, and then\r\n1. UTXO snapshot sync-to-tip with and without this changeset.\r\n\r\nI'll get back with some results in the next few days, and hopefully will write up an elucidation on where exactly CCoinsViewCache does or doesn't provide benefit.\r\n\r\n(Though I wonder how cross-platform differences beyond SSD-or-not play into this, e.g. the cache may or may not show importance based on leveldb's use of mmap & `max_open_files`, which is particularly relevant on Win32.)",
      "created_at" : "2019-11-19T17:18:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-555613237",
      "id" : 555613237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTYxMzIzNw==",
      "updated_at" : "2019-11-19T17:18:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555613237",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> the cache may or may not show importance based on leveldb's use of mmap & max_open_files, which is particularly relevant on Win32\r\n\r\nFWIW, #17398 adds leveldb mmap support on Windows, might want to try with and without that PR  when doing benchmarking on Windows.",
      "created_at" : "2019-11-20T11:42:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-555967785",
      "id" : 555967785,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTk2Nzc4NQ==",
      "updated_at" : "2019-11-20T11:42:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555967785",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "After benching, I stand by this change as being significantly useful. I compare HEAD of the assumeutxo parent PR ([`utxo-dumpload-compressed`](https://github.com/jamesob/bitcoin/tree/utxo-dumpload-compressed)) to a branch of it which drops use of the `erase=false` parameter, erasing the coins after snapshot load ([`bench/au.no-erase`](https://github.com/jamesob/bitcoin/tree/bench/au.no-erase), [changes](https://github.com/jamesob/bitcoin/commit/85a73a074389c80c09e2acc877f45e06ab3f5976)). The benchmark compares the time taken to sync to block 604,667 after loading a snapshot taken at height 600,000.\r\n\r\nThe result is a significant degradation in performance on spinning disk hosts (4.5 hours vs. 1.5 hours) - see the `bench-hdd-3` results. There is a modest but probably negligible degradation on SSD hosts.\r\n\r\n```\r\nhost         tag                      time       time% maxmem  cpu%  dbcache\r\nbench-ssd-4  bench/au.no-erase        47:42.80   1.00  6689.85MB 125%  5000MB\r\nbench-ssd-4  bench/au.no-erase        44:15.66   0.93  6560.45MB 136%  5000MB\r\nbench-ssd-4  utxo-dumpload-compressed 40:13.30   0.84  6662.75MB 149%  5000MB\r\nbench-ssd-4  utxo-dumpload-compressed 41:36.01   0.87  6652.87MB 143%  5000MB\r\n\r\nbench-ssd-5  bench/au.no-erase        41:33.65   0.95  6754.54MB 144%  5000MB\r\nbench-ssd-5  bench/au.no-erase        41:32.42   0.95  6561.39MB 145%  5000MB\r\nbench-ssd-5  utxo-dumpload-compressed 43:51.50   1.00  6758.98MB 135%  5000MB\r\nbench-ssd-5  utxo-dumpload-compressed 36:39.94   0.84  6649.31MB 162%  5000MB\r\n\r\nbench-hdd-3  utxo-dumpload-compressed 1:47:08    0.38  6654.23MB 57%   5000MB\r\nbench-hdd-3  utxo-dumpload-compressed 1:30:48    0.32  6612.49MB 66%   5000MB\r\nbench-hdd-3  bench/au.no-erase        4:24:53    0.93  6578.77MB 23%   5000MB\r\nbench-hdd-3  bench/au.no-erase        4:45:29    1.00  6583.10MB 21%   5000MB\r\n```\r\n\r\nThis benchmark is reproducible by running [this script](https://github.com/chaincodelabs/bitcoinperf/blob/master/bin/run_remote.py#L147-L183):\r\n```sh\r\n./bin/run_remote.py au --hosts [hostnames ...]\r\n```\r\n\r\nI'll add tests to make sure this change works as-advertised, but I think it's pretty clearly a useful option for us to have. ",
      "created_at" : "2019-11-21T19:04:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-557226923",
      "id" : 557226923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzIyNjkyMw==",
      "updated_at" : "2019-11-21T19:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557226923",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sdaftuar just pointed out to me that this code is very wrong - because I don't wipe the flags of flushed coins, this code ends up with an incorrect on-disk UTXO set (since a coin with the `FRESH` flag will only be removed from the in-memory cache and the delete will not propagate to leveldb). Going to fix this bug and reevaluate and pledge to never doubt Suhas' benchmarks again.",
      "created_at" : "2019-11-21T19:37:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-557239614",
      "id" : 557239614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzIzOTYxNA==",
      "updated_at" : "2019-11-21T19:37:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557239614",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(FWIW @Sjors wins Employee of the Month for spotting this bug in a previous comment.)",
      "created_at" : "2019-11-21T19:38:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-557240133",
      "id" : 557240133,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzI0MDEzMw==",
      "updated_at" : "2019-11-21T19:38:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557240133",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Took me a while to understand what you're doing here. To rephrase in my own words: when you load the snapshot from disk you end up with a coin cache at e.g. 600,000. Depending on the users dbcache setting, part of this is already in RAM, which is potentially nice when continuing IBD.\r\n\r\nhttps://github.com/jamesob/bitcoin/commit/85a73a074389c80c09e2acc877f45e06ab3f5976#diff-24efdb00bfbe56b140fb006b562cc70bL5514-L5530\r\n\r\nIf -dbcache is less than the size of the snapshot, the only the most recent (?) coins of the snapshot will in RAM, the rest would already have been flushed. This is probably similar to what happens during a normal IBD when dbcache overflows. (we could use some heuristics to sort coins by life expectancy)\r\n\r\nFor some reason (why?) you need to flush at the end of loading the snapshot, which normally means no coins are in RAM. This PR changes that last flush to keep stuff around.\r\n\r\nIIUC the main benefit of this cache is to reduce the number of unnecessary writes, i.e. when a coin is created and then destroyed we save 2 disk writes. But when we flush, even without deleting the coins from RAM, we expect 1 write if the coin is spent before the tip, otherwise no write.\r\n\r\nLooking forward to the new benchmark. I suggest doing this with a ~1 month old snapshot (realistic for users who download immediately after a 1 month release candidates) and a 4 month old snapshot (the average age if we ship every 6 months).",
      "created_at" : "2019-11-22T11:59:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-557505590",
      "id" : 557505590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzUwNTU5MA==",
      "updated_at" : "2019-11-22T12:03:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557505590",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm surprised to report that even after fixing the (consensus!) bug that @Sjors and @sdaftuar pointed out, this change still shows considerable improvement for the assumeutxo snapshot-load use. We're still seeing 3x reduction in time with this change applied for spinning disks while doing a from-600k snapshot IBD.\r\n\r\n```\r\nhost         tag                      time       time% maxmem  cpu%  dbcache\r\nbench-ssd-4  utxo-dumpload-compressed 31:48.95   0.70  6787.93MB 179%  5000MB\r\nbench-ssd-4  utxo-dumpload-compressed 36:06.14   0.80  6689.20MB 157%  5000MB\r\nbench-ssd-4  bench/au.no-erase.1      43:21.22   0.96  6689.82MB 137%  5000MB\r\nbench-ssd-4  bench/au.no-erase.1      45:14.75   1.00  6739.20MB 131%  5000MB\r\n\r\nbench-ssd-5  utxo-dumpload-compressed 33:08.03   0.77  6787.14MB 172%  5000MB\r\nbench-ssd-5  utxo-dumpload-compressed 31:13.55   0.73  6731.26MB 182%  5000MB\r\nbench-ssd-5  bench/au.no-erase.1      42:49.74   1.00  6754.30MB 139%  5000MB\r\nbench-ssd-5  bench/au.no-erase.1      41:22.71   0.97  6557.05MB 144%  5000MB\r\n\r\nbench-hdd-3  bench/au.no-erase.1      4:34:00    0.98  6530.24MB 22%   5000MB\r\nbench-hdd-3  bench/au.no-erase.1      4:39:21    1.00  6562.12MB 21%   5000MB\r\nbench-hdd-3  utxo-dumpload-compressed 1:30:11    0.32  6736.32MB 63%   5000MB\r\nbench-hdd-3  utxo-dumpload-compressed 1:33:19    0.33  6702.03MB 61%   5000MB\r\n```\r\n[(host specs here)](https://gist.github.com/jamesob/012154e6c1c0ac893dc602fadfdd5f1d)\r\n\r\nApplying @sdaftuar's fix ([here](https://github.com/jamesob/bitcoin/commit/6dbb76e5a254095effc776c07bf954bd7a874406) in `bench/au.no-erase.1`, and [here](https://github.com/jamesob/bitcoin/commit/352af3801da0c0a870e01df8e1926df36f40e572#diff-cd7b305fd4b4280f22ae88960e60398eR217-R229) in `utxo-dumpload-compressed`) I think actually improves runtime for the single `Flush(erase=false)` call that we make after finishing the snapshot load because now we're actually removing spent coins from `cacheCoins`, thus freeing up more cache space going into the IBD.\r\n\r\n---\r\n\r\n> For some reason (why?) you need to flush at the end of loading the snapshot, which normally means no coins are in RAM. This PR changes that last flush to keep stuff around.\r\n\r\nThanks for the nice summary, @Sjors. I'm not sure that we necessarily need to flush after loading the snapshot, but I figured it was prudent to ensure that we'd resume the snapshot-based sync even after an unclean shutdown - maybe it's better to just omit the `Flush()` call altogether after loading the snapshot?\r\n\r\nTangentially, @sdaftuar mentioned the other day a potential technique for partial flushes that may accomplish the kind of optimization that this branch and #15265 are aiming for. The idea would be to allocate some of the `cacheCoins` memory to a secondary data structure that would serve as an index into `cacheCoins`, allowing fast lookup by spentness and height of the in-memory coins. That way, on `FlushStateToDisk()` we could do a partial flush, only making disk writes for those coins which are either unspent and of a certain age *or* spent and on-disk. This would make use of the fact that most coins are very short-lived (see [figure 2](https://eprint.iacr.org/2019/611.pdf) in @adiabat's excellent utreexo paper).\r\n\r\nI think this is a promising idea and I'll be experimenting with it soon - though of course that's outside the scope of this PR. ",
      "created_at" : "2019-11-22T16:16:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-557595582",
      "id" : 557595582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzU5NTU4Mg==",
      "updated_at" : "2019-11-22T16:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557595582",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "What about using `Flush(erase=false)` for all periodic flushes after IBD? That way when running with a high enough `dbcache` a flush would never empty `cacheCoins`, which would surely improve performance. That's also the only real issue with #15218 .",
      "created_at" : "2019-11-22T20:22:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-557680581",
      "id" : 557680581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzY4MDU4MQ==",
      "updated_at" : "2019-11-22T20:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557680581",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've pushed some test coverage for the new `erase` parameter (and more generally some explicit tests for coins cache behavior). Notably, the new test cases use `CCoinsViewDB` at the base of the cache structure, which isn't currently tested explicitly anywhere else in the unittest suite - though of course an instance lives at the heart of every `CChainState`.\r\n\r\nThroughout the course of writing (and debugging) the tests, I found yet another bug that had to do with `std::move`ing the coins in `CCoinsView::BatchWrite` even when `erase=false`, which was causing the `coin.out.scriptPubKey` to appear null in the child-most cache. This is just another testament to how tricky the coins cache code is to get right (as I was warned months ago by @sdaftuar). But that said, I feel pretty confident that this change is now correct.",
      "created_at" : "2019-12-03T20:42:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-561348373",
      "id" : 561348373,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MTM0ODM3Mw==",
      "updated_at" : "2019-12-03T20:42:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/561348373",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r353418761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353418761"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it true that this loop is very slow with high dbcache? If so, a comment would be appropriate.\r\n\r\nOther than that I also agree with @ryanofsky comment to have \"separate methods like Flush() and Sync() or Flush() and Write()\". As a rule of thumb, if two functions have a completely different implementation, they should not be bundled in one and switched by a boolean.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2019-12-03T21:00:29Z",
      "diff_hunk" : "@@ -202,10 +202,24 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n     return true;\n }\n \n-bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n-    cacheCoins.clear();\n-    cachedCoinsUsage = 0;\n+bool CCoinsViewCache::Flush(bool clear_cache) {\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ clear_cache);\n+    if (clear_cache) {\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+    } else {\n+        // Instead of clearing the cache, just clear the FRESH/DIRTY\n+        // flags, and erase any spent coins\n+        for (auto it = cacheCoins.begin(); it != cacheCoins.end(); ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r353418761",
      "id" : 353418761,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MzQxODc2MQ==",
      "original_commit_id" : "1e68aad46ed122c85ed60e1529c6cf512bbefa86",
      "original_line" : 213,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 326444938,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353418761",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r353872539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353872539"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In my own benchmarking, I haven't seen anything to support the notion that this loop takes a long time. In the newest benchmarks (to be posted), calling `Flush(erase=true)` on a cache of size 3826 MB takes **7:17** and calling `Flush(erase=false)` on a cache of the same size takes **6:03** so the difference is either negligible or favorable. \r\n\r\nI got the times by subtracting timestamps from the last and second-to-last loglines below for each branch during snapshot activation.\r\n\r\n### Before this change\r\n```\r\n2019-12-03T23:18:26Z [snapshot] 63000000 coins loaded (99.39%, 3826 MB)\r\n2019-12-03T23:18:26Z [snapshot] loaded 63389760 (3877 MB) coins from snapshot 00000000000000000007316856900e76b4f7a9139cfbfba89842c8d196cd5f91\r\n2019-12-03T23:18:26Z [snapshot] flushing snapshot chainstate to disk\r\n2019-12-03T23:25:43Z [snapshot] validated snapshot (592 MB)\r\n```\r\n\r\n### After this change\r\n```\r\n2019-12-03T23:48:09Z [snapshot] 63000000 coins loaded (99.39%, 3826 MB)\r\n2019-12-03T23:48:10Z [snapshot] loaded 63389760 (3877 MB) coins from snapshot 00000000000000000007316856900e76b4f7a9139cfbfba89842c8d196cd5f91\r\n2019-12-03T23:48:10Z [snapshot] flushing snapshot chainstate to disk\r\n2019-12-03T23:54:13Z [snapshot] validated snapshot (3877 MB)\r\n```\r\n\r\n---\r\n\r\nI'll make the Flush() + Sync() change.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2019-12-04T17:10:23Z",
      "diff_hunk" : "@@ -202,10 +202,24 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n     return true;\n }\n \n-bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n-    cacheCoins.clear();\n-    cachedCoinsUsage = 0;\n+bool CCoinsViewCache::Flush(bool clear_cache) {\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ clear_cache);\n+    if (clear_cache) {\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+    } else {\n+        // Instead of clearing the cache, just clear the FRESH/DIRTY\n+        // flags, and erase any spent coins\n+        for (auto it = cacheCoins.begin(); it != cacheCoins.end(); ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r353872539",
      "id" : 353872539,
      "in_reply_to_id" : 353418761,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1Mzg3MjUzOQ==",
      "original_commit_id" : "1e68aad46ed122c85ed60e1529c6cf512bbefa86",
      "original_line" : 213,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 327012115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353872539",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Latest round of benchmarks for the current tip of this branch continues to show good performance improvements for UTXO snapshot load, even on SSD. (same setup as https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-557595582)\r\n\r\n```\r\nhost         tag                      time       time% maxmem  cpu%  dbcache\r\nbench-ssd-4  bench/au.no-erase.1      43:27.79   0.98  6572.45MB 137%  5000MB\r\nbench-ssd-4  bench/au.no-erase.1      44:10.18   1.00  6690.36MB 135%  5000MB\r\nbench-ssd-4  utxo-dumpload.54         32:59.07   0.75  6733.55MB 173%  5000MB\r\nbench-ssd-4  utxo-dumpload.54         33:19.00   0.75  6725.27MB 171%  5000MB\r\n\r\nbench-ssd-5  utxo-dumpload.54         31:32.39   0.60  6769.57MB 182%  5000MB\r\nbench-ssd-5  utxo-dumpload.54         31:11.39   0.60  6699.07MB 183%  5000MB\r\nbench-ssd-5  bench/au.no-erase.1      41:41.13   0.80  6772.39MB 142%  5000MB\r\nbench-ssd-5  bench/au.no-erase.1      52:16.76   1.00  6567.82MB 114%  5000MB\r\n\r\nbench-hdd-3  bench/au.no-erase.1      4:37:10    1.00  6569.48MB 21%   5000MB\r\nbench-hdd-3  bench/au.no-erase.1      4:36:03    1.00  6523.61MB 21%   5000MB\r\nbench-hdd-3  utxo-dumpload.54         1:30:22    0.33  6705.20MB 63%   5000MB\r\nbench-hdd-3  utxo-dumpload.54         1:36:20    0.35  6735.74MB 59%   5000MB\r\n```",
      "created_at" : "2019-12-04T17:12:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-561741590",
      "id" : 561741590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MTc0MTU5MA==",
      "updated_at" : "2019-12-04T17:12:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/561741590",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've split `Flush(bool erase)` into `Sync()` and `Flush()` as requested by @ryanofsky @MarcoFalke. ([changes](https://github.com/bitcoin/bitcoin/compare/1e68aad46ed122c85ed60e1529c6cf512bbefa86..eebaca7620bbd0af0ec385c6c7d47b2b4b524d55))",
      "created_at" : "2019-12-05T16:53:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-562216092",
      "id" : 562216092,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MjIxNjA5Mg==",
      "updated_at" : "2019-12-05T16:53:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562216092",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Review club notes: https://bitcoincore.reviews/17487.html",
      "created_at" : "2020-01-27T21:02:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-578950782",
      "id" : 578950782,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODk1MDc4Mg==",
      "updated_at" : "2020-01-27T21:02:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578950782",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Review club notes:\r\n\r\nPreparation notes; it's scheduled for ~Wednesday the 29th~ tonight, which explains why I couldn't find the minutes :-)\r\n\r\n",
      "created_at" : "2020-01-29T11:57:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-579723127",
      "id" : 579723127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTcyMzEyNw==",
      "updated_at" : "2020-01-29T11:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579723127",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372353051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372353051"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If `COutPoint(txid, 0)` doesn't exist and `COutPoint(txid, 0)` does, then `AccessByTxid` will randomly behave different from `AccessCoin`. But the coins are random anyway.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-01-29T12:26:12Z",
      "diff_hunk" : "@@ -150,9 +150,16 @@ BOOST_AUTO_TEST_CASE(coins_cache_simulation_test)\n             bool test_havecoin_after = InsecureRandBits(2) == 0;\n \n             bool result_havecoin = test_havecoin_before ? stack.back()->HaveCoin(COutPoint(txid, 0)) : false;\n-            const Coin& entry = (InsecureRandRange(500) == 0) ? AccessByTxid(*stack.back(), txid) : stack.back()->AccessCoin(COutPoint(txid, 0));\n+\n+            // Infrequently, test usage of AccessByTxid instead of AccessCoin - the\n+            // former just delegates to the latter and returns the first unspent in a txn.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372353051",
      "id" : 372353051,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1MzA1MQ==",
      "original_commit_id" : "640861a52a7d2ad6f9f1242946ad43ba20e8a9d7",
      "original_line" : 160,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 35,
      "pull_request_review_id" : 350067640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372353051",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372393219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372393219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Comment above should be \"Flush or sync the top cache\". Are you sure this test is working as advertised? What does `delete stack.back();` and  `stack.pop_back();` do here? Making them conditional doesn't break the test.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-01-29T13:52:42Z",
      "diff_hunk" : "@@ -223,14 +223,18 @@ BOOST_AUTO_TEST_CASE(coins_cache_simulation_test)\n             // Every 100 iterations, flush an intermediate cache\n             if (stack.size() > 1 && InsecureRandBool() == 0) {\n                 unsigned int flushIndex = InsecureRandRange(stack.size() - 1);\n-                BOOST_CHECK(stack[flushIndex]->Flush());\n+                bool should_erase = InsecureRandRange(4) < 3;\n+                BOOST_CHECK(should_erase ? stack[flushIndex]->Flush() : stack[flushIndex]->Sync());\n+                flushed_without_erase |= !should_erase;\n             }\n         }\n         if (InsecureRandRange(100) == 0) {\n             // Every 100 iterations, change the cache stack.\n             if (stack.size() > 0 && InsecureRandBool() == 0) {\n                 //Remove the top cache\n-                BOOST_CHECK(stack.back()->Flush());\n+                bool should_erase = InsecureRandRange(4) < 3;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372393219",
      "id" : 372393219,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM5MzIxOQ==",
      "original_commit_id" : "b12c4b092de159a38342fb7069cd1903bf5ce680",
      "original_line" : 242,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 96,
      "pull_request_review_id" : 350067640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372393219",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372404143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372404143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: \"either ... and\"?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-01-29T14:12:52Z",
      "diff_hunk" : "@@ -878,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372404143",
      "id" : 372404143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQwNDE0Mw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 909,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 350067640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372404143",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> You may want to rebase, because without that on macOS I get errors during `make`:\r\n\r\nWith gcc (Debian 8.3.0-6) and `--enable-debug --enable-bench` eebaca7620bbd0af0ec385c6c7d47b2b4b524d55 builds and all tests are passing for me. Starting code review.",
      "created_at" : "2020-01-29T16:23:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-579838548",
      "id" : 579838548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTgzODU0OA==",
      "updated_at" : "2020-01-29T16:23:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579838548",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372525830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372525830"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "SchrÃ¶dinger's `COutPoint(txid, 0)`? :P",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-01-29T17:30:53Z",
      "diff_hunk" : "@@ -150,9 +150,16 @@ BOOST_AUTO_TEST_CASE(coins_cache_simulation_test)\n             bool test_havecoin_after = InsecureRandBits(2) == 0;\n \n             bool result_havecoin = test_havecoin_before ? stack.back()->HaveCoin(COutPoint(txid, 0)) : false;\n-            const Coin& entry = (InsecureRandRange(500) == 0) ? AccessByTxid(*stack.back(), txid) : stack.back()->AccessCoin(COutPoint(txid, 0));\n+\n+            // Infrequently, test usage of AccessByTxid instead of AccessCoin - the\n+            // former just delegates to the latter and returns the first unspent in a txn.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r372525830",
      "id" : 372525830,
      "in_reply_to_id" : 372353051,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUyNTgzMA==",
      "original_commit_id" : "640861a52a7d2ad6f9f1242946ad43ba20e8a9d7",
      "original_line" : 160,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 35,
      "pull_request_review_id" : 350291630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372525830",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Code review ACK of commit b2abb396c64e96585a0c38a269372b35cced08bd. The changes are straightforward and do not appear to change behavior.",
      "created_at" : "2020-01-29T17:53:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-579879560",
      "id" : 579879560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTg3OTU2MA==",
      "updated_at" : "2020-05-18T08:22:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579879560",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "PR title \"coins: allow Flush() without cache drop\" seems out of date. Would suggest something like \"coins: Add new unused CCoinsViewCache::Sync() method\"",
      "created_at" : "2020-01-29T18:09:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-579887330",
      "id" : 579887330,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTg4NzMzMA==",
      "updated_at" : "2020-01-29T18:09:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579887330",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-02-02T13:55:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-581137919",
      "id" : 581137919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MTEzNzkxOQ==",
      "updated_at" : "2020-02-02T13:55:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/581137919",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377374863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377374863"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is simply copying the pattern of `Flush()`, but `BatchWrite()` never returns `false`, so this parameter does nothing. I think all three functions should be cleaned up to not return anything so that the calling pattern is clear, but that can be done in a follow-up PR.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-02-10T23:18:05Z",
      "diff_hunk" : "@@ -203,12 +203,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);\n     cacheCoins.clear();\n     cachedCoinsUsage = 0;\n     return fOk;\n }\n \n+bool CCoinsViewCache::Sync()\n+{\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377374863",
      "id" : 377374863,
      "line" : 239,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3NDg2Mw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 239,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 74,
      "pull_request_review_id" : 356335551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377374863",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377375703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377375703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: \"Hack to allow flushing\" isn't very illuminating. Perhaps \"A cache's hashBlock must be filled before flushing to disk. That's normally done in connect/disconnect block. Do it manually here\"",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-02-10T23:20:36Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377375703",
      "id" : 377375703,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3NTcwMw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 936,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 356335551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377375703",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377375875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377375875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I don't think pruned is the right terminolgy, but this can be cleaned up with all the rest in a future PR.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-02-10T23:21:08Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377375875",
      "id" : 377375875,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3NTg3NQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1010,
      "original_position" : 245,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 356335551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377375875",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377376396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377376396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this should say \"ensure that a FRESH spent coin is deleted by Sync()\". If the coin is FRESH but not spent, then a `Sync()` won't delete it.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-02-10T23:22:39Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, PRUNED);\n+    BOOST_CHECK_EQUAL(flags, DIRTY);\n+    BOOST_CHECK(!view->HaveCoin(outp)); // Coin should be considered spent in `view`.\n+    BOOST_CHECK(base.HaveCoin(outp));  // But coin should still be unspent in `base`.\n+\n+    flush_all(/*erase*/ false);\n+\n+    // Coin should be considered spent in both views.\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    // Spent coin should not be spendable.\n+    BOOST_CHECK(!view->SpendCoin(outp));\n+\n+    // --- Bonus check: ensure that a coin added to the base view via one cache\n+    //     can be spent by another cache which has never seen it.\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+    all_caches[0]->Sync();\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoinInCache(outp));\n+\n+    BOOST_CHECK(all_caches[1]->SpendCoin(outp));\n+    flush_all(/*erase*/ false);\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    flush_all(/*erase*/ true); // Erase all cache content.\n+\n+    // --- Bonus check 2: ensure that a FRESH coin is deleted by Sync()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377376396",
      "id" : 377376396,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3NjM5Ng==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1050,
      "original_position" : 285,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 356335551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377376396",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377376708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377376708"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I don't think we need these three lines. Just checking that `HaveCoinInCache()` fails is enough to show that the coin doesn't exist in the cache.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-02-10T23:23:39Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, PRUNED);\n+    BOOST_CHECK_EQUAL(flags, DIRTY);\n+    BOOST_CHECK(!view->HaveCoin(outp)); // Coin should be considered spent in `view`.\n+    BOOST_CHECK(base.HaveCoin(outp));  // But coin should still be unspent in `base`.\n+\n+    flush_all(/*erase*/ false);\n+\n+    // Coin should be considered spent in both views.\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    // Spent coin should not be spendable.\n+    BOOST_CHECK(!view->SpendCoin(outp));\n+\n+    // --- Bonus check: ensure that a coin added to the base view via one cache\n+    //     can be spent by another cache which has never seen it.\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+    all_caches[0]->Sync();\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoinInCache(outp));\n+\n+    BOOST_CHECK(all_caches[1]->SpendCoin(outp));\n+    flush_all(/*erase*/ false);\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    flush_all(/*erase*/ true); // Erase all cache content.\n+\n+    // --- Bonus check 2: ensure that a FRESH coin is deleted by Sync()\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    // Add and spend from same cache without flushing.\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+\n+    // Coin should be FRESH in the cache.\n+    GetCoinsMapEntry(all_caches[0]->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // Base shouldn't have seen coin.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    BOOST_CHECK(all_caches[0]->SpendCoin(outp));\n+    all_caches[0]->Sync();\n+\n+    // Ensure there is no sign of the coin after spend/flush.\n+    GetCoinsMapEntry(all_caches[0]->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, ABSENT);\n+    BOOST_CHECK_EQUAL(flags, NO_ENTRY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r377376708",
      "id" : 377376708,
      "line" : 1078,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3NjcwOA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1078,
      "original_position" : 311,
      "original_start_line" : 1058,
      "path" : "src/test/coins_tests.cpp",
      "position" : 306,
      "pull_request_review_id" : 356335551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : 1076,
      "start_side" : "RIGHT",
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/377376708",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r379682087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379682087"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I like the naming destinction between `Sync()` and `Flush()` in the code because it made it easier to parse and that naming could have been used more here in the test as well. Now the destinction it is kind of hidden behind this `do_erasing_flush` parameter.  There could have been a `sync_all` helper method for example. But it's probably not worth the effort of changing now.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-02-14T23:00:56Z",
      "diff_hunk" : "@@ -878,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r379682087",
      "id" : 379682087,
      "line" : 939,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4MjA4Nw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 939,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 167,
      "pull_request_review_id" : 359265516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379682087",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r379689269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379689269"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: If I look at this comment outside of the context of this PR \"Instead of clearing the cache\" might not make much sense because there is no cache clearing going on inside of this function and the relation to `Flush()` may not be immediately clear.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-02-14T23:33:25Z",
      "diff_hunk" : "@@ -203,12 +203,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);\n     cacheCoins.clear();\n     cachedCoinsUsage = 0;\n     return fOk;\n }\n \n+bool CCoinsViewCache::Sync()\n+{\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ false);\n+    // Instead of clearing the cache, just clear the FRESH/DIRTY",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r379689269",
      "id" : 379689269,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4OTI2OQ==",
      "original_commit_id" : "b2abb396c64e96585a0c38a269372b35cced08bd",
      "original_line" : 226,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 359265516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/379689269",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the reviews, all. I'll address some of the nits if there's a need to rebase, otherwise I'm going for ACK-preservation at this point.",
      "created_at" : "2020-02-17T16:37:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-587075723",
      "id" : 587075723,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NzA3NTcyMw==",
      "updated_at" : "2020-02-17T16:37:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587075723",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This has two ACKs on the latest branch (@jnewbery and @fjahr), but previous concept ACKs from @ryanofsky @jonatack @dongcarl @ariard , and other review comments from @Sjors @andrewtoth @MarcoFalke . What can we do to get this over the line?",
      "created_at" : "2020-03-13T17:20:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-598830130",
      "id" : 598830130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODgzMDEzMA==",
      "updated_at" : "2020-03-13T17:20:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598830130",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r402037193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402037193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is the `std::move` gain really worth the added code complexity here?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-02T03:52:16Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r402037193",
      "id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAzNzE5Mw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 386091788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402037193",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r402040674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402040674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This has no effect, I think. All std::move does is cast to an rvalue reference. The ternary operator merges it back to the same type with the other branch.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-02T04:08:04Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r402040674",
      "id" : 402040674,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0MDY3NA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 386095540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/402040674",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403710128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403710128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is indeed required. Try recompiling without this change and running the coins tests (`./src/test/test_bitcoin -t coins_tests`).\r\n\r\nThe std::move is necessary to erase the contents of the map being written to the parent.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T14:33:52Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403710128",
      "id" : 403710128,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcxMDEyOA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387825369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403710128",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403738538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403738538"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jamesob The `std::move` here has no effect; it is equivalent to `entry.coin = it->second.coin`. If you want to conditionally move, you need two separate statements.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T18:20:33Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403738538",
      "id" : 403738538,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczODUzOA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387846183,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403738538",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403740488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403740488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Did you actually try recompiling with your suggested change and running the tests? The result on my platform (`gcc (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0`) is failure.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T18:37:43Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403740488",
      "id" : 403740488,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0MDQ4OA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387847780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403740488",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403742681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403742681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jamesob It sounds like you're relying on the side effect of the moved-from object being cleared or something, but AFAIK it is in fact left in an undefined state...\r\n\r\nProbably should just copy and explicitly clear.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T18:56:44Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403742681",
      "id" : 403742681,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0MjY4MQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387849448,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403742681",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403743080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403743080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems I'm wrong; your code is correct.\r\n\r\nApparently what happens in this case is that a temporary variable is created, which `it->second.coin` is either copied or moved to (depending on `erase`), and then that temporary variable is move-assigned to `entry.coin`. This has the desired effect, though there is possibly an unnecessary (but cheap) move.\r\n\r\nIf you write it as\r\n\r\n```c++\r\nif (erase) {\r\n    entry.coin = std::move(it->second.coin);\r\n} else {\r\n    entry.coin = it->second.coin;\r\n}\r\n```\r\n\r\nI think you get the same semantics, but without the additional move.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T19:00:17Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403743080",
      "id" : 403743080,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0MzA4MA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387849763,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403743080",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403743513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403743513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@luke-jr Well, the only member with move semantics is CScript, which is a prevector, and move assigning is well defined (it's in our own code), namely swapping.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T19:04:11Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403743513",
      "id" : 403743513,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0MzUxMw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387850119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403743513",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403743776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403743776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Abstractly, it is undefined, and `std::move` AFAIK does not guarantee move assignment, only allows it?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T19:06:35Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403743776",
      "id" : 403743776,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0Mzc3Ng==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387850351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403743776",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403744322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403744322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@luke-jr `std::move` just casts to an rvalue reference, nothing else. It's up to the involved classes to define what to do when assigned with or constructed from an rvalue.\r\n\r\nThe standard also defines what standard library classes do in this case: moved-from objects are in a valid but unspecified state (which means that you're only allowed to run operations on them that have no preconditions; e.g. empty() on them or assigning to them is ok).\r\n\r\nHowever, no standard library classes are involved here, so it doesn't apply.\r\n\r\nI agree with you insofar that if the desired effect is clearing, the code should just explicitly clear (potentially after a move, if that's more efficient). But it isn't UB to rely on the rvalue semantics of a class we defined ourselves.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-04-05T19:11:26Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r403744322",
      "id" : 403744322,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0NDMyMg==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 387850787,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/403744322",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-16T18:24:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-614819703",
      "id" : 614819703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDgxOTcwMw==",
      "updated_at" : "2020-04-16T18:24:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614819703",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tested ACK 8bb1163805121b2863fef1c16c9b104803e8dfdd\r\nI've been running [this patch](https://github.com/andrewtoth/bitcoin/commit/e851e772197f10362818c7e38a7776ba03a71d48) on top of this branch for the last week to test non-erasing periodic flushes. I haven't had any issues.",
      "created_at" : "2020-05-18T03:46:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-629929852",
      "id" : 629929852,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTkyOTg1Mg==",
      "updated_at" : "2020-05-18T03:47:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629929852",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427429354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427429354"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: it seems a bit odd to clear the flags immediately before deleting in the case where the coin is spent. If you retouch this PR, the flag clearing can be moved into the else branch below.\r\n\r\nYou might also want to update the comment to reflect that change: \"Erase any spent coins and clear the FRESH/DIRTY flags for unspent coins\".",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T16:18:00Z",
      "diff_hunk" : "@@ -214,12 +214,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);\n     cacheCoins.clear();\n     cachedCoinsUsage = 0;\n     return fOk;\n }\n \n+bool CCoinsViewCache::Sync()\n+{\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ false);\n+    // Instead of clearing the cache, just clear the FRESH/DIRTY\n+    // flags, and erase any spent coins\n+    for (auto it = cacheCoins.begin(); it != cacheCoins.end(); ) {\n+        it->second.flags = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427429354",
      "id" : 427429354,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyOTM1NA==",
      "original_commit_id" : "8bb1163805121b2863fef1c16c9b104803e8dfdd",
      "original_line" : 229,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 414611820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427429354",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427435879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427435879"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I think it'd be clearer to avoid this use-once local variable by using the same pattern that you used in coins.cpp:\r\n\r\n```\r\nit = erase ? mapCoins.erase(it) : ++it;\r\n```",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T16:27:41Z",
      "diff_hunk" : "@@ -116,7 +116,9 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n         }\n         count++;\n         CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        if (erase) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427435879",
      "id" : 427435879,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzNTg3OQ==",
      "original_commit_id" : "8bb1163805121b2863fef1c16c9b104803e8dfdd",
      "original_line" : 119,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 414611820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427435879",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427454512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427454512"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I like sipa's alternative.\r\n\r\nFWIW I also get a flood of errors when using `entry.coin = std::move(it->second.coin);` with `erase = false`. Conversely if I drop `std::move` it works fine, but I haven't looked at performance. In other words, we're not depending on some side-effect `std::move`, it's just a performance enhancer. ",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T16:55:49Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427454512",
      "id" : 427454512,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ1NDUxMg==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 414643354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427454512",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427508528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427508528"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed. In addition, let's not assume there won't be new flags in the future, so maybe clear the `FRESH/DIRTY` flags explicitly with an `=&`?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T18:21:24Z",
      "diff_hunk" : "@@ -214,12 +214,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);\n     cacheCoins.clear();\n     cachedCoinsUsage = 0;\n     return fOk;\n }\n \n+bool CCoinsViewCache::Sync()\n+{\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ false);\n+    // Instead of clearing the cache, just clear the FRESH/DIRTY\n+    // flags, and erase any spent coins\n+    for (auto it = cacheCoins.begin(); it != cacheCoins.end(); ) {\n+        it->second.flags = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427508528",
      "id" : 427508528,
      "in_reply_to_id" : 427429354,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwODUyOA==",
      "original_commit_id" : "8bb1163805121b2863fef1c16c9b104803e8dfdd",
      "original_line" : 229,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 414643354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427508528",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427509760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427509760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `* the contents of this cache except for FRESH spent coins.`",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T18:23:34Z",
      "diff_hunk" : "@@ -297,12 +297,22 @@ class CCoinsViewCache : public CCoinsViewBacked\n     bool SpendCoin(const COutPoint &outpoint, Coin* moveto = nullptr);\n \n     /**\n-     * Push the modifications applied to this cache to its base.\n-     * Failure to call this method before destruction will cause the changes to be forgotten.\n+     * Push the modifications applied to this cache to its base and wipe local state.\n+     * Failure to call this method or Sync() before destruction will cause the changes\n+     * to be forgotten.\n      * If false is returned, the state of this cache (and its backing view) will be undefined.\n      */\n     bool Flush();\n \n+    /**\n+     * Push the modifications applied to this cache to its base while retaining\n+     * the contents of this cache.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427509760",
      "id" : 427509760,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwOTc2MA==",
      "original_commit_id" : "d5f4f7bcdb5e18702fcdcbaff922ce9c8f9f5654",
      "original_line" : 309,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 414643354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427509760",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427512576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427512576"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does this need an exception, to always delete `FRESH` spent coins? Or those can't exist at this level? ",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T18:28:26Z",
      "diff_hunk" : "@@ -116,7 +116,9 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n         }\n         count++;\n         CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        if (erase) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427512576",
      "id" : 427512576,
      "in_reply_to_id" : 427435879,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxMjU3Ng==",
      "original_commit_id" : "8bb1163805121b2863fef1c16c9b104803e8dfdd",
      "original_line" : 119,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 414643354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427512576",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427517198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427517198"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why did you switch the second argument of `assign` to `1`?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T18:36:17Z",
      "diff_hunk" : "@@ -168,24 +175,29 @@ void SimulationTest(CCoinsView* base, bool fake_best_block)\n                 Coin newcoin;\n                 newcoin.out.nValue = InsecureRand32();\n                 newcoin.nHeight = 1;\n+\n+                // Infrequently test adding unspendable coins.\n                 if (InsecureRandRange(16) == 0 && coin.IsSpent()) {\n                     newcoin.out.scriptPubKey.assign(1 + InsecureRandBits(6), OP_RETURN);\n                     BOOST_CHECK(newcoin.out.scriptPubKey.IsUnspendable());\n                     added_an_unspendable_entry = true;\n                 } else {\n-                    newcoin.out.scriptPubKey.assign(InsecureRandBits(6), 0); // Random sizes so we can test memory usage accounting\n+                    // Random sizes so we can test memory usage accounting\n+                    newcoin.out.scriptPubKey.assign(InsecureRandBits(6), 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427517198",
      "id" : 427517198,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxNzE5OA==",
      "original_commit_id" : "f2abc6338204c8f593fb4d1c7d220270b7171b35",
      "original_line" : 186,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 414643354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427517198",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427525125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427525125"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[nit bump](https://github.com/bitcoin/bitcoin/pull/17487/commits/8bb1163805121b2863fef1c16c9b104803e8dfdd#r377375703)",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T18:49:26Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427525125",
      "id" : 427525125,
      "in_reply_to_id" : 377375703,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNTEyNQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 936,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 414643354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427525125",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427526583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427526583"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[nit bump](https://github.com/bitcoin/bitcoin/pull/17487/commits/8bb1163805121b2863fef1c16c9b104803e8dfdd#r377376396)",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-19T18:51:55Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, PRUNED);\n+    BOOST_CHECK_EQUAL(flags, DIRTY);\n+    BOOST_CHECK(!view->HaveCoin(outp)); // Coin should be considered spent in `view`.\n+    BOOST_CHECK(base.HaveCoin(outp));  // But coin should still be unspent in `base`.\n+\n+    flush_all(/*erase*/ false);\n+\n+    // Coin should be considered spent in both views.\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    // Spent coin should not be spendable.\n+    BOOST_CHECK(!view->SpendCoin(outp));\n+\n+    // --- Bonus check: ensure that a coin added to the base view via one cache\n+    //     can be spent by another cache which has never seen it.\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+    all_caches[0]->Sync();\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoinInCache(outp));\n+\n+    BOOST_CHECK(all_caches[1]->SpendCoin(outp));\n+    flush_all(/*erase*/ false);\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    flush_all(/*erase*/ true); // Erase all cache content.\n+\n+    // --- Bonus check 2: ensure that a FRESH coin is deleted by Sync()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r427526583",
      "id" : 427526583,
      "in_reply_to_id" : 377376396,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNjU4Mw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1050,
      "original_position" : 285,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 414643354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427526583",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the feedback, all. I'll push some responses later today.",
      "created_at" : "2020-05-20T16:27:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-631583791",
      "id" : 631583791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTU4Mzc5MQ==",
      "updated_at" : "2020-05-20T16:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631583791",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432012334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432012334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, the point is to exercise cases where we do delete/pop parts of the cache stack - the test should pass in any case.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T17:43:04Z",
      "diff_hunk" : "@@ -223,14 +223,18 @@ BOOST_AUTO_TEST_CASE(coins_cache_simulation_test)\n             // Every 100 iterations, flush an intermediate cache\n             if (stack.size() > 1 && InsecureRandBool() == 0) {\n                 unsigned int flushIndex = InsecureRandRange(stack.size() - 1);\n-                BOOST_CHECK(stack[flushIndex]->Flush());\n+                bool should_erase = InsecureRandRange(4) < 3;\n+                BOOST_CHECK(should_erase ? stack[flushIndex]->Flush() : stack[flushIndex]->Sync());\n+                flushed_without_erase |= !should_erase;\n             }\n         }\n         if (InsecureRandRange(100) == 0) {\n             // Every 100 iterations, change the cache stack.\n             if (stack.size() > 0 && InsecureRandBool() == 0) {\n                 //Remove the top cache\n-                BOOST_CHECK(stack.back()->Flush());\n+                bool should_erase = InsecureRandRange(4) < 3;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432012334",
      "id" : 432012334,
      "in_reply_to_id" : 372393219,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxMjMzNA==",
      "original_commit_id" : "b12c4b092de159a38342fb7069cd1903bf5ce680",
      "original_line" : 242,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 96,
      "pull_request_review_id" : 420347257,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432012334",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432014219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432014219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand the original comment - is there a typo in one of your `COutPoint`s?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T17:46:24Z",
      "diff_hunk" : "@@ -150,9 +150,16 @@ BOOST_AUTO_TEST_CASE(coins_cache_simulation_test)\n             bool test_havecoin_after = InsecureRandBits(2) == 0;\n \n             bool result_havecoin = test_havecoin_before ? stack.back()->HaveCoin(COutPoint(txid, 0)) : false;\n-            const Coin& entry = (InsecureRandRange(500) == 0) ? AccessByTxid(*stack.back(), txid) : stack.back()->AccessCoin(COutPoint(txid, 0));\n+\n+            // Infrequently, test usage of AccessByTxid instead of AccessCoin - the\n+            // former just delegates to the latter and returns the first unspent in a txn.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432014219",
      "id" : 432014219,
      "in_reply_to_id" : 372353051,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNDIxOQ==",
      "original_commit_id" : "640861a52a7d2ad6f9f1242946ad43ba20e8a9d7",
      "original_line" : 160,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 35,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432014219",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432015340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432015340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good question... can't remember doing that. Will revert.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T17:48:24Z",
      "diff_hunk" : "@@ -168,24 +175,29 @@ void SimulationTest(CCoinsView* base, bool fake_best_block)\n                 Coin newcoin;\n                 newcoin.out.nValue = InsecureRand32();\n                 newcoin.nHeight = 1;\n+\n+                // Infrequently test adding unspendable coins.\n                 if (InsecureRandRange(16) == 0 && coin.IsSpent()) {\n                     newcoin.out.scriptPubKey.assign(1 + InsecureRandBits(6), OP_RETURN);\n                     BOOST_CHECK(newcoin.out.scriptPubKey.IsUnspendable());\n                     added_an_unspendable_entry = true;\n                 } else {\n-                    newcoin.out.scriptPubKey.assign(InsecureRandBits(6), 0); // Random sizes so we can test memory usage accounting\n+                    // Random sizes so we can test memory usage accounting\n+                    newcoin.out.scriptPubKey.assign(InsecureRandBits(6), 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432015340",
      "id" : 432015340,
      "in_reply_to_id" : 427517198,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNTM0MA==",
      "original_commit_id" : "f2abc6338204c8f593fb4d1c7d220270b7171b35",
      "original_line" : 186,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432015340",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432016064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432016064"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T17:49:51Z",
      "diff_hunk" : "@@ -878,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432016064",
      "id" : 432016064,
      "in_reply_to_id" : 372404143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNjA2NA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 909,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432016064",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432017156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432017156"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T17:51:50Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432017156",
      "id" : 432017156,
      "in_reply_to_id" : 377375875,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNzE1Ng==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1010,
      "original_position" : 245,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432017156",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432017479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432017479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T17:52:27Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, PRUNED);\n+    BOOST_CHECK_EQUAL(flags, DIRTY);\n+    BOOST_CHECK(!view->HaveCoin(outp)); // Coin should be considered spent in `view`.\n+    BOOST_CHECK(base.HaveCoin(outp));  // But coin should still be unspent in `base`.\n+\n+    flush_all(/*erase*/ false);\n+\n+    // Coin should be considered spent in both views.\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    // Spent coin should not be spendable.\n+    BOOST_CHECK(!view->SpendCoin(outp));\n+\n+    // --- Bonus check: ensure that a coin added to the base view via one cache\n+    //     can be spent by another cache which has never seen it.\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+    all_caches[0]->Sync();\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoinInCache(outp));\n+\n+    BOOST_CHECK(all_caches[1]->SpendCoin(outp));\n+    flush_all(/*erase*/ false);\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    flush_all(/*erase*/ true); // Erase all cache content.\n+\n+    // --- Bonus check 2: ensure that a FRESH coin is deleted by Sync()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432017479",
      "id" : 432017479,
      "in_reply_to_id" : 377376396,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNzQ3OQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1050,
      "original_position" : 285,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432017479",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432017919"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432017919"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm going to keep these in because I think it's worth being painfully explicit in coins tests.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T17:53:18Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, PRUNED);\n+    BOOST_CHECK_EQUAL(flags, DIRTY);\n+    BOOST_CHECK(!view->HaveCoin(outp)); // Coin should be considered spent in `view`.\n+    BOOST_CHECK(base.HaveCoin(outp));  // But coin should still be unspent in `base`.\n+\n+    flush_all(/*erase*/ false);\n+\n+    // Coin should be considered spent in both views.\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    // Spent coin should not be spendable.\n+    BOOST_CHECK(!view->SpendCoin(outp));\n+\n+    // --- Bonus check: ensure that a coin added to the base view via one cache\n+    //     can be spent by another cache which has never seen it.\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+    all_caches[0]->Sync();\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoinInCache(outp));\n+\n+    BOOST_CHECK(all_caches[1]->SpendCoin(outp));\n+    flush_all(/*erase*/ false);\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    flush_all(/*erase*/ true); // Erase all cache content.\n+\n+    // --- Bonus check 2: ensure that a FRESH coin is deleted by Sync()\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    // Add and spend from same cache without flushing.\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+\n+    // Coin should be FRESH in the cache.\n+    GetCoinsMapEntry(all_caches[0]->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // Base shouldn't have seen coin.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    BOOST_CHECK(all_caches[0]->SpendCoin(outp));\n+    all_caches[0]->Sync();\n+\n+    // Ensure there is no sign of the coin after spend/flush.\n+    GetCoinsMapEntry(all_caches[0]->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, ABSENT);\n+    BOOST_CHECK_EQUAL(flags, NO_ENTRY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432017919",
      "id" : 432017919,
      "in_reply_to_id" : 377376708,
      "line" : 1078,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNzkxOQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1078,
      "original_position" : 311,
      "original_start_line" : 1058,
      "path" : "src/test/coins_tests.cpp",
      "position" : 306,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : 1076,
      "start_side" : "RIGHT",
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432017919",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432026105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432026105"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@Sjors please see above - we do rely on the `std::move` to clear the entry from the child cache, it isn't just a performance optimization. If you remove the `move`, the coins unittests will fail.\r\n\r\nThat said I agree it seems tricky to rely upon this behavior implicitly based upon classes we've define ourselves, but I haven't tested the performance implications of adding `mapCoins.erase(it)`. Given that I'm essentially leaving the behavior as it was before this change in the case of the `move`, and we have unittests that will catch a change in behavior here, I don't feel the need to add an explicit `erase()` call. I have however clarified the phrasing with an explicit if-else as @sipa suggests.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T18:08:19Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432026105",
      "id" : 432026105,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAyNjEwNQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432026105",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432026636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432026636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "rephrased",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T18:09:20Z",
      "diff_hunk" : "@@ -203,12 +203,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);\n     cacheCoins.clear();\n     cachedCoinsUsage = 0;\n     return fOk;\n }\n \n+bool CCoinsViewCache::Sync()\n+{\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ false);\n+    // Instead of clearing the cache, just clear the FRESH/DIRTY",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432026636",
      "id" : 432026636,
      "in_reply_to_id" : 379689269,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAyNjYzNg==",
      "original_commit_id" : "b2abb396c64e96585a0c38a269372b35cced08bd",
      "original_line" : 226,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432026636",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432027751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432027751"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T18:11:21Z",
      "diff_hunk" : "@@ -214,12 +214,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);\n     cacheCoins.clear();\n     cachedCoinsUsage = 0;\n     return fOk;\n }\n \n+bool CCoinsViewCache::Sync()\n+{\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ false);\n+    // Instead of clearing the cache, just clear the FRESH/DIRTY\n+    // flags, and erase any spent coins\n+    for (auto it = cacheCoins.begin(); it != cacheCoins.end(); ) {\n+        it->second.flags = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432027751",
      "id" : 432027751,
      "in_reply_to_id" : 427429354,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAyNzc1MQ==",
      "original_commit_id" : "8bb1163805121b2863fef1c16c9b104803e8dfdd",
      "original_line" : 229,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432027751",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432028244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432028244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T18:12:12Z",
      "diff_hunk" : "@@ -297,12 +297,22 @@ class CCoinsViewCache : public CCoinsViewBacked\n     bool SpendCoin(const COutPoint &outpoint, Coin* moveto = nullptr);\n \n     /**\n-     * Push the modifications applied to this cache to its base.\n-     * Failure to call this method before destruction will cause the changes to be forgotten.\n+     * Push the modifications applied to this cache to its base and wipe local state.\n+     * Failure to call this method or Sync() before destruction will cause the changes\n+     * to be forgotten.\n      * If false is returned, the state of this cache (and its backing view) will be undefined.\n      */\n     bool Flush();\n \n+    /**\n+     * Push the modifications applied to this cache to its base while retaining\n+     * the contents of this cache.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432028244",
      "id" : 432028244,
      "in_reply_to_id" : 427509760,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAyODI0NA==",
      "original_commit_id" : "d5f4f7bcdb5e18702fcdcbaff922ce9c8f9f5654",
      "original_line" : 309,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432028244",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432039014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432039014"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good suggestion, thanks! Fixed.\r\n\r\n`FRESH` spent coins won't exist here because they will have been removed from the child cache first - for proof of this note that nothing calls `CCoinsViewDB::BatchWrite()` aside from CCoinsViewCache, and `SpendCoin()` only exists on CCoinsViewCache instances.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T18:31:58Z",
      "diff_hunk" : "@@ -116,7 +116,9 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n         }\n         count++;\n         CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        if (erase) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432039014",
      "id" : 432039014,
      "in_reply_to_id" : 427435879,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAzOTAxNA==",
      "original_commit_id" : "8bb1163805121b2863fef1c16c9b104803e8dfdd",
      "original_line" : 119,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 420349660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432039014",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432067601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432067601"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> If you remove the move, the coins unittests will fail.\r\n\r\nOdd, I tried that. Will try again.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T19:25:01Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432067601",
      "id" : 432067601,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2NzYwMQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420419755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432067601",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432088620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432088620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Odd, I tried that. Will try again.\r\n\r\nPerhaps you made the change in the relevant commit, but then didn't apply subsequent commits including the new tests? Just a guess.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T19:58:51Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432088620",
      "id" : 432088620,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA4ODYyMA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420447855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432088620",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432101304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432101304"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW I did try this before acking. I checked out this branch and changed the ternary to just use the copy assignment and the tests errored out. Will try again with updated commits.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T20:22:07Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432101304",
      "id" : 432101304,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEwMTMwNA==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420462970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432101304",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432161196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432161196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jnewbery has found that I was wrong - the std::move invocation isn't necessary for correctness, it's just an optimization. Thanks for pointing that out @Sjors. Will remove the new comment.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-28T22:34:49Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432161196",
      "id" : 432161196,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2MTE5Ng==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420538803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432161196",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432221525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432221525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since this has caused so much confusion, I think it'd be better to update the comment than remove it entirely. Perhaps something like:\r\n\r\n```\r\n// We'll erase this entry from the map in the for increase expression.\r\n// Move the coin to the parent cache instead of copying as an optimization.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-29T02:21:45Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432221525",
      "id" : 432221525,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyMTUyNQ==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 420611467,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432221525",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432902077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432902077"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should this also be updated to use an `if/else` block instead of a ternary like above?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-31T01:56:31Z",
      "diff_hunk" : "@@ -199,7 +205,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n             } else {\n                 // A normal modification.\n                 cachedCoinsUsage -= itUs->second.coin.DynamicMemoryUsage();\n-                itUs->second.coin = std::move(it->second.coin);\n+                itUs->second.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432902077",
      "id" : 432902077,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjA3Nw==",
      "original_commit_id" : "1ce5cd389f286627412bc5edc6cb34006b65ec0b",
      "original_line" : 208,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 421455405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432902077",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432957388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432957388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch. ",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-31T15:23:16Z",
      "diff_hunk" : "@@ -199,7 +205,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n             } else {\n                 // A normal modification.\n                 cachedCoinsUsage -= itUs->second.coin.DynamicMemoryUsage();\n-                itUs->second.coin = std::move(it->second.coin);\n+                itUs->second.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432957388",
      "id" : 432957388,
      "in_reply_to_id" : 432902077,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk1NzM4OA==",
      "original_commit_id" : "1ce5cd389f286627412bc5edc6cb34006b65ec0b",
      "original_line" : 208,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 421504390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432957388",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432989748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432989748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: the third part of the for loop is an expression, not a predicate (more precisely, the _increase_ or _iteration_ expression). A predicate is a function which returns true/false.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-05-31T22:12:47Z",
      "diff_hunk" : "@@ -199,7 +206,14 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n             } else {\n                 // A normal modification.\n                 cachedCoinsUsage -= itUs->second.coin.DynamicMemoryUsage();\n-                itUs->second.coin = std::move(it->second.coin);\n+                if (erase) {\n+                    // The `move` call here is purely an optimization; we rely on the\n+                    // `mapCoins.erase` call in the `for` predicate to actually remove",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r432989748",
      "id" : 432989748,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk4OTc0OA==",
      "original_commit_id" : "fdc1d80ce4348687ca87d544e8efe40e5344f5d3",
      "original_line" : 211,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 421532480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432989748",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433210377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433210377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pfew, I'm not insane :-) Thanks for adding the comment.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-01T12:41:01Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Otherwise we will need to create it in the parent\n                 // and move the data up and mark it as dirty\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                entry.coin = erase ? std::move(it->second.coin) : it->second.coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433210377",
      "id" : 433210377,
      "in_reply_to_id" : 402037193,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIxMDM3Nw==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 174,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 421810809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433210377",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-utACK 8d5994ef2235c6706440bc18968006cd04c22fb4",
      "created_at" : "2020-06-01T13:46:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-636870055",
      "id" : 636870055,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjg3MDA1NQ==",
      "updated_at" : "2020-06-01T13:46:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636870055",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433520706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433520706"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If `HaveCoinInCache()` isn't explicit enough, should it be removed from lower in the test, or is that different somehow?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-01T22:21:19Z",
      "diff_hunk" : "@@ -861,4 +879,207 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance and\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            cache->SetBestBlock(InsecureRand256());  // Hack to allow flushing.\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but pruned and marked dirty.\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, PRUNED);\n+    BOOST_CHECK_EQUAL(flags, DIRTY);\n+    BOOST_CHECK(!view->HaveCoin(outp)); // Coin should be considered spent in `view`.\n+    BOOST_CHECK(base.HaveCoin(outp));  // But coin should still be unspent in `base`.\n+\n+    flush_all(/*erase*/ false);\n+\n+    // Coin should be considered spent in both views.\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    // Spent coin should not be spendable.\n+    BOOST_CHECK(!view->SpendCoin(outp));\n+\n+    // --- Bonus check: ensure that a coin added to the base view via one cache\n+    //     can be spent by another cache which has never seen it.\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+    all_caches[0]->Sync();\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoinInCache(outp));\n+\n+    BOOST_CHECK(all_caches[1]->SpendCoin(outp));\n+    flush_all(/*erase*/ false);\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    flush_all(/*erase*/ true); // Erase all cache content.\n+\n+    // --- Bonus check 2: ensure that a FRESH coin is deleted by Sync()\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    // Add and spend from same cache without flushing.\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+\n+    // Coin should be FRESH in the cache.\n+    GetCoinsMapEntry(all_caches[0]->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // Base shouldn't have seen coin.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    BOOST_CHECK(all_caches[0]->SpendCoin(outp));\n+    all_caches[0]->Sync();\n+\n+    // Ensure there is no sign of the coin after spend/flush.\n+    GetCoinsMapEntry(all_caches[0]->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, ABSENT);\n+    BOOST_CHECK_EQUAL(flags, NO_ENTRY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433520706",
      "id" : 433520706,
      "in_reply_to_id" : 377376708,
      "line" : 1078,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyMDcwNg==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 1078,
      "original_position" : 311,
      "original_start_line" : 1058,
      "path" : "src/test/coins_tests.cpp",
      "position" : 306,
      "pull_request_review_id" : 422221355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : 1076,
      "start_side" : "RIGHT",
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433520706",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 8d5994ef2235c6706440bc18968006cd04c22fb4",
      "created_at" : "2020-06-01T22:21:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-637156481",
      "id" : 637156481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzE1NjQ4MQ==",
      "updated_at" : "2020-06-01T22:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637156481",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433961320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433961320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should `++it` be outside the ternary conditional here?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-02T15:23:51Z",
      "diff_hunk" : "@@ -115,8 +115,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             changed++;\n         }\n         count++;\n-        CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        it = erase ? mapCoins.erase(it) : ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433961320",
      "id" : 433961320,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2MTMyMA==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 115,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 422790091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433961320",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433962526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433962526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This is simply copying the pattern of `Flush()`, but `BatchWrite()` never returns `false`, so this parameter does nothing. I think all three functions should be cleaned up to not return anything so that the calling pattern is clear, but that can be done in a follow-up PR.\r\n\r\nI agree with @jnewbery here.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-02T15:25:33Z",
      "diff_hunk" : "@@ -203,12 +203,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);\n     cacheCoins.clear();\n     cachedCoinsUsage = 0;\n     return fOk;\n }\n \n+bool CCoinsViewCache::Sync()\n+{\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r433962526",
      "id" : 433962526,
      "in_reply_to_id" : 377374863,
      "line" : 239,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2MjUyNg==",
      "original_commit_id" : "eebaca7620bbd0af0ec385c6c7d47b2b4b524d55",
      "original_line" : 239,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 74,
      "pull_request_review_id" : 422791633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433962526",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434003002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434003002"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No. `std::unordered_map::erase()` returns an iterator to the next item in the map: https://en.cppreference.com/w/cpp/container/unordered_map/erase.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-02T16:13:15Z",
      "diff_hunk" : "@@ -115,8 +115,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             changed++;\n         }\n         count++;\n-        CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        it = erase ? mapCoins.erase(it) : ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434003002",
      "id" : 434003002,
      "in_reply_to_id" : 433961320,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMzAwMg==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 115,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 422840668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434003002",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434005792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434005792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh -- and it appears to be a convention. Thanks @jnewbery.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-02T16:17:42Z",
      "diff_hunk" : "@@ -115,8 +115,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             changed++;\n         }\n         count++;\n-        CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        it = erase ? mapCoins.erase(it) : ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434005792",
      "id" : 434005792,
      "in_reply_to_id" : 433961320,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNTc5Mg==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 115,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 422844267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434005792",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434011129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434011129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`it = ++it;` is kind of strange though. How about `it = mapCoins.erase(it) : std::next(it);` ?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-02T16:26:09Z",
      "diff_hunk" : "@@ -115,8 +115,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             changed++;\n         }\n         count++;\n-        CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        it = erase ? mapCoins.erase(it) : ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434011129",
      "id" : 434011129,
      "in_reply_to_id" : 433961320,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMTEyOQ==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 115,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 422851560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434011129",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434729703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434729703"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thinking about this more, is it not more than a pure optimization? If we copy instead of move, then we are increasing the memory footprint of our dbcache. For a large batch write won't all dirty entries exist in memory twice, potentially increasing the memory requirements of the node temporarily until the parent cache writes to disk?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-03T17:18:09Z",
      "diff_hunk" : "@@ -171,7 +171,14 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Create the coin in the parent cache, move the data up\n                 // and mark it as dirty.\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                if (erase) {\n+                    // The `move` call here is purely an optimization; we rely on the\n+                    // `mapCoins.erase` call in the `for` expression to actually remove\n+                    // the entry from the child map.\n+                    entry.coin = std::move(it->second.coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434729703",
      "id" : 434729703,
      "line" : 178,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyOTcwMw==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 178,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 38,
      "pull_request_review_id" : 423768662,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434729703",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434751546"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434751546"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@andrewtoth I think this is offset by the fact that we're erasing as we iterate through the map, so coins will only be duplicated in memory one by one. But that's a good consideration, thanks for raising the point.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-03T17:55:44Z",
      "diff_hunk" : "@@ -171,7 +171,14 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Create the coin in the parent cache, move the data up\n                 // and mark it as dirty.\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                if (erase) {\n+                    // The `move` call here is purely an optimization; we rely on the\n+                    // `mapCoins.erase` call in the `for` expression to actually remove\n+                    // the entry from the child map.\n+                    entry.coin = std::move(it->second.coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434751546",
      "id" : 434751546,
      "in_reply_to_id" : 434729703,
      "line" : 178,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTU0Ng==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 178,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 38,
      "pull_request_review_id" : 423796998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434751546",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434751700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434751700"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will change if I rebase.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-03T17:56:01Z",
      "diff_hunk" : "@@ -115,8 +115,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             changed++;\n         }\n         count++;\n-        CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        it = erase ? mapCoins.erase(it) : ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434751700",
      "id" : 434751700,
      "in_reply_to_id" : 433961320,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTcwMA==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 115,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 423797199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434751700",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434763783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434763783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@jamesob For this change we are no longer erasing as we iterate through the map, and also copying, right? For a `Sync()` with a large amount of dirty entries won't this cause memory usage to increase?",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-03T18:17:08Z",
      "diff_hunk" : "@@ -171,7 +171,14 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Create the coin in the parent cache, move the data up\n                 // and mark it as dirty.\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                if (erase) {\n+                    // The `move` call here is purely an optimization; we rely on the\n+                    // `mapCoins.erase` call in the `for` expression to actually remove\n+                    // the entry from the child map.\n+                    entry.coin = std::move(it->second.coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434763783",
      "id" : 434763783,
      "in_reply_to_id" : 434729703,
      "line" : 178,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc2Mzc4Mw==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 178,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 38,
      "pull_request_review_id" : 423812734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434763783",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434892478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434892478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm ok I guess I'm missing how we're erasing during the iteration with `erase=false`. I tested a reindex-chainstate with max dbcache and did a `Sync` instead of `Flush` on shutdown, and it didn't increase memory usage at all when syncing. LGTM.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-03T22:28:02Z",
      "diff_hunk" : "@@ -171,7 +171,14 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Create the coin in the parent cache, move the data up\n                 // and mark it as dirty.\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                if (erase) {\n+                    // The `move` call here is purely an optimization; we rely on the\n+                    // `mapCoins.erase` call in the `for` expression to actually remove\n+                    // the entry from the child map.\n+                    entry.coin = std::move(it->second.coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r434892478",
      "id" : 434892478,
      "in_reply_to_id" : 434729703,
      "line" : 178,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg5MjQ3OA==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 178,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 38,
      "pull_request_review_id" : 423981011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434892478",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK 8d5994ef2235c6706440bc18968006cd04c22fb4",
      "created_at" : "2020-06-03T22:28:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-638494243",
      "id" : 638494243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzODQ5NDI0Mw==",
      "updated_at" : "2020-06-03T22:28:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/638494243",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r435526117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/435526117"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@andrewtoth you don't see a big memory spike because in practice this implementation of `BatchWrite` is only called for small sets of coins [during `ConnectTip()`](https://github.com/jamesob/bitcoin/blob/8d5994ef2235c6706440bc18968006cd04c22fb4/src/validation.cpp#L2600-L2613) to make UTXO set changes atomic (i.e. a CCoinsViewCache on top of another CCoinsViewCache); calling `BatchWrite` for really sizable sets of coins happens on `CCoinsViewDB` (leveldb) objects (i.e. writing down from a CCoinsViewCache -> CCoinsViewDB). CCoinsViewDB doesn't have an in-memory cache (at least that we maintain) so there is no sizable duplication.\r\n\r\nBut once again, thanks for raising the point and testing.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-06-04T20:21:03Z",
      "diff_hunk" : "@@ -171,7 +171,14 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n                 // Create the coin in the parent cache, move the data up\n                 // and mark it as dirty.\n                 CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n+                if (erase) {\n+                    // The `move` call here is purely an optimization; we rely on the\n+                    // `mapCoins.erase` call in the `for` expression to actually remove\n+                    // the entry from the child map.\n+                    entry.coin = std::move(it->second.coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r435526117",
      "id" : 435526117,
      "in_reply_to_id" : 434729703,
      "line" : 178,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUyNjExNw==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 178,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 38,
      "pull_request_review_id" : 424798429,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/435526117",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-07-29T06:12:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-665454263",
      "id" : 665454263,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NTQ1NDI2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-29T06:12:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/665454263",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`au.coins-erase.7`](https://github.com/jamesob/bitcoin/tree/au.coins-erase.7) -> [`au.coins-erase.8`](https://github.com/jamesob/bitcoin/tree/au.coins-erase.8)\r\n\r\n<details><summary>Show range-diff</summary>\r\n\r\n```sh\r\n% git range-diff master au.coins-erase.7 au.coins-erase.8\r\n\r\n1:  8b9b51da04 ! 1:  58616e0b8b coins: add Sync() method to allow flush without cacheCoins drop\r\n    @@ -187,7 +187,7 @@\r\n\r\n     -bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\r\n     +bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock, bool erase) {\r\n    -     CDBBatch batch(db);\r\n    +     CDBBatch batch(*m_db);\r\n          size_t count = 0;\r\n          size_t changed = 0;\r\n     @@\r\n    @@ -199,7 +199,7 @@\r\n     +        it = erase ? mapCoins.erase(it) : ++it;\r\n              if (batch.SizeEstimate() > batch_size) {\r\n                  LogPrint(BCLog::COINDB, \"Writing partial batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\r\n    -             db.WriteBatch(batch);\r\n    +             m_db->WriteBatch(batch);\r\n\r\n      diff --git a/src/txdb.h b/src/txdb.h\r\n      --- a/src/txdb.h\r\n2:  09ef24a814 = 2:  48d3e92b06 test: refactor: clarify the coins simulation\r\n3:  c50373bfb7 = 3:  7239b0cee5 test: add use of Sync() to coins tests\r\n4:  8d5994ef22 = 4:  0292b01cc4 test: add test for coins view flush behavior using Sync()\r\n```\r\n\r\n</details>\r\n\r\nThis PR has gotten substantial review, testing, and ACK from a number of people (@andrewtoth, @jnewbery, @jonatack, @Sjors) but personally I would appreciate evaluation for at least a Concept ACK from someone who has a lot of experience in the coins department (e.g. @sipa, @sdaftuar, @ryanofsky) before this moves forward.\r\n\r\nTo reiterate, this has shown to be noticeably helpful when loading UTXO snapshots with assumeutxo and can potentially help shave some time off ConnectBlock (https://github.com/bitcoin/bitcoin/pull/18941#issuecomment-633684774 cc @andrewtoth). But I don't want to push a string here.",
      "created_at" : "2020-08-01T15:53:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-667551597",
      "id" : 667551597,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NzU1MTU5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-01T15:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667551597",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r463987009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463987009"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think `except for FRESH spent coins, which we erase` is true?\r\n\r\nIf a FRESH coin is spent, it is deleted immediately, so there shouldn't be any such entries in the first place.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-08-01T18:21:43Z",
      "diff_hunk" : "@@ -297,12 +297,22 @@ class CCoinsViewCache : public CCoinsViewBacked\n     bool SpendCoin(const COutPoint &outpoint, Coin* moveto = nullptr);\n \n     /**\n-     * Push the modifications applied to this cache to its base.\n-     * Failure to call this method before destruction will cause the changes to be forgotten.\n+     * Push the modifications applied to this cache to its base and wipe local state.\n+     * Failure to call this method or Sync() before destruction will cause the changes\n+     * to be forgotten.\n      * If false is returned, the state of this cache (and its backing view) will be undefined.\n      */\n     bool Flush();\n \n+    /**\n+     * Push the modifications applied to this cache to its base while retaining\n+     * the contents of this cache (except for FRESH spent coins, which we erase).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r463987009",
      "id" : 463987009,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk4NzAwOQ==",
      "original_commit_id" : "58616e0b8b37cae4d011062038fb6565064fe3d1",
      "original_line" : 309,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 459595094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463987009",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r463996447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463996447"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, [you're right](https://github.com/jamesob/bitcoin/blob/0292b01cc4be18e5eb37563064cced7d73cd7025/src/coins.cpp#L120-L121), not sure what I was thinking there.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-08-01T20:17:09Z",
      "diff_hunk" : "@@ -297,12 +297,22 @@ class CCoinsViewCache : public CCoinsViewBacked\n     bool SpendCoin(const COutPoint &outpoint, Coin* moveto = nullptr);\n \n     /**\n-     * Push the modifications applied to this cache to its base.\n-     * Failure to call this method before destruction will cause the changes to be forgotten.\n+     * Push the modifications applied to this cache to its base and wipe local state.\n+     * Failure to call this method or Sync() before destruction will cause the changes\n+     * to be forgotten.\n      * If false is returned, the state of this cache (and its backing view) will be undefined.\n      */\n     bool Flush();\n \n+    /**\n+     * Push the modifications applied to this cache to its base while retaining\n+     * the contents of this cache (except for FRESH spent coins, which we erase).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r463996447",
      "id" : 463996447,
      "in_reply_to_id" : 463987009,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk5NjQ0Nw==",
      "original_commit_id" : "58616e0b8b37cae4d011062038fb6565064fe3d1",
      "original_line" : 309,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 459601443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:17:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463996447",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`au.coins-erase.8`](https://github.com/jamesob/bitcoin/tree/au.coins-erase.8) -> [`au.coins-erase.9`](https://github.com/jamesob/bitcoin/tree/au.coins-erase.9)\r\n\r\n<details><summary><code>$ git range-diff master au.coins-erase.8 au.coins-erase.9</code></summary>\r\n\r\n```diff\r\n1:  58616e0b8b ! 1:  47d71fdb70 coins: add Sync() method to allow flush without cacheCoins drop\r\n    @@ -154,7 +154,7 @@\r\n\r\n     +    /**\r\n     +     * Push the modifications applied to this cache to its base while retaining\r\n    -+     * the contents of this cache (except for FRESH spent coins, which we erase).\r\n    ++     * the contents of this cache (except for spent coins, which we erase).\r\n     +     * Failure to call this method or Flush() before destruction will cause the changes\r\n     +     * to be forgotten.\r\n     +     * If false is returned, the state of this cache (and its backing view) will be undefined.\r\n    @@ -196,7 +196,7 @@\r\n              count++;\r\n     -        CCoinsMap::iterator itOld = it++;\r\n     -        mapCoins.erase(itOld);\r\n    -+        it = erase ? mapCoins.erase(it) : ++it;\r\n    ++        it = erase ? mapCoins.erase(it) : std::next(it);\r\n              if (batch.SizeEstimate() > batch_size) {\r\n                  LogPrint(BCLog::COINDB, \"Writing partial batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\r\n                  m_db->WriteBatch(batch);\r\n2:  48d3e92b06 = 2:  342ef935c4 test: refactor: clarify the coins simulation\r\n3:  7239b0cee5 = 3:  77897654a5 test: add use of Sync() to coins tests\r\n4:  0292b01cc4 = 4:  f4b56059b4 test: add test for coins view flush behavior using Sync()\r\n```\r\n\r\n</details>\r\n\r\nAddressed feedback from @sipa (thanks).",
      "created_at" : "2020-08-01T20:18:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-667582030",
      "id" : 667582030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NzU4MjAzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-01T20:18:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667582030",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r463996547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463996547"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "f4b56059b4c0a89f2b32f51e51285c734a245118",
      "created_at" : "2020-08-01T20:18:28Z",
      "diff_hunk" : "@@ -115,8 +115,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             changed++;\n         }\n         count++;\n-        CCoinsMap::iterator itOld = it++;\n-        mapCoins.erase(itOld);\n+        it = erase ? mapCoins.erase(it) : ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r463996547",
      "id" : 463996547,
      "in_reply_to_id" : 433961320,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk5NjU0Nw==",
      "original_commit_id" : "8d5994ef2235c6706440bc18968006cd04c22fb4",
      "original_line" : 115,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 459601537,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T20:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463996547",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I was able to rebase f4b5605 on master and run the test. Difference with my previous utACK seems trivial, but I haven't re-reviewed it.",
      "created_at" : "2021-05-05T18:33:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-832916004",
      "id" : 832916004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMjkxNjAwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-05T18:33:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/832916004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-23T17:23:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-867022143",
      "id" : 867022143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NzAyMjE0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-23T17:23:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/867022143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "tACK dfe6677e3d3a8b54d8017c0eb06d7e09efc62050",
      "created_at" : "2021-08-31T07:08:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-908961061",
      "id" : 908961061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "IC_kwDOABII5842LaUl",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-31T07:08:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908961061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10723538?v=4",
         "events_url" : "https://api.github.com/users/Kirandevraj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Kirandevraj/followers",
         "following_url" : "https://api.github.com/users/Kirandevraj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Kirandevraj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Kirandevraj",
         "id" : 10723538,
         "login" : "Kirandevraj",
         "node_id" : "MDQ6VXNlcjEwNzIzNTM4",
         "organizations_url" : "https://api.github.com/users/Kirandevraj/orgs",
         "received_events_url" : "https://api.github.com/users/Kirandevraj/received_events",
         "repos_url" : "https://api.github.com/users/Kirandevraj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Kirandevraj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Kirandevraj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Kirandevraj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r767146237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/767146237"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The following `TODO` comment in `src/validation.cpp` was removed in #23738. Making a note here so the `TODO` can be either be done in this PR or in a follow-up.\r\n```\r\n    coins_cache.Flush(); // TODO: if #17487 is merged, add erase=false here for better performance.\r\n```\r\n",
      "commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "created_at" : "2021-12-11T11:53:11Z",
      "diff_hunk" : "@@ -220,12 +234,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r767146237",
      "id" : 767146237,
      "line" : 237,
      "node_id" : "PRRC_kwDOABII584tubj9",
      "original_commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "original_line" : 237,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 66,
      "pull_request_review_id" : 829525974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/767146237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-15T13:56:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/767146237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r780710725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780710725"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: These three variables could have been initialized here.",
      "commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "created_at" : "2022-01-08T21:39:47Z",
      "diff_hunk" : "@@ -895,4 +895,209 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance or\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            // hashBlock must be filled before flushing to disk; value is\n+            // unimportant here. This is normally done during connect/disconnect block.\n+            cache->SetBestBlock(InsecureRand256());\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r780710725",
      "id" : 780710725,
      "line" : 943,
      "node_id" : "PRRC_kwDOABII584uiLNF",
      "original_commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "original_line" : 943,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 171,
      "pull_request_review_id" : 847197360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780710725/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-09T12:23:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780710725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r780774706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780774706"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note: I found that the tests don't fail if `erase` is flipped to `false` on this line, other than in `Sync()`. The tests would need to become more granular to catch this case but it certainly has not gotten worse than from before this PR so it can be kept for a follow-up if it seems beneficial to test.",
      "commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "created_at" : "2022-01-09T12:22:39Z",
      "diff_hunk" : "@@ -220,12 +234,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r780774706",
      "id" : 780774706,
      "in_reply_to_id" : 767146237,
      "line" : 237,
      "node_id" : "PRRC_kwDOABII584uia0y",
      "original_commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "original_line" : 237,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 66,
      "pull_request_review_id" : 847197360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780774706/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-09T12:23:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780774706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This PR has several stale ACKs. It seems like the most recent revision could be in a good enough state to go in (no conflicts with master, almost all comments have been addressed). Would any of the previous reviewers (@sjors @ryanofsky @jonatack @andrewtoth) like to give this a re-review?",
      "created_at" : "2023-01-17T23:17:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-1386213840",
      "id" : 1386213840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "IC_kwDOABII585Sn_HQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1386213840/reactions"
      },
      "updated_at" : "2023-01-17T23:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1386213840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "created_at" : "2023-01-17T23:35:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#issuecomment-1386240386",
      "id" : 1386240386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17487",
      "node_id" : "IC_kwDOABII585SoFmC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1386240386/reactions"
      },
      "updated_at" : "2023-01-17T23:35:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1386240386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r1073358171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073358171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```bash\r\ntest/coins_tests.cpp:1004:39: error: 'tmpCoin2' used after it was moved [bugprone-use-after-move,-warnings-as-errors]\r\n        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\r\n                                      ^\r\ntest/coins_tests.cpp:1004:15: note: move occurred here\r\n        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\r\n              ^\r\ntest/coins_tests.cpp:1004:39: note: the use happens in a later loop iteration than the move\r\n        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\r\n```",
      "commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "created_at" : "2023-01-18T10:29:08Z",
      "diff_hunk" : "@@ -878,4 +895,209 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance or\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            // hashBlock must be filled before flushing to disk; value is\n+            // unimportant here. This is normally done during connect/disconnect block.\n+            cache->SetBestBlock(InsecureRand256());\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r1073358171",
      "id" : 1073358171,
      "line" : 1004,
      "node_id" : "PRRC_kwDOABII584_-iVb",
      "original_commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "original_line" : 1004,
      "original_position" : 232,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 232,
      "pull_request_review_id" : 1253213780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073358171/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-18T10:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073358171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r1073358683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073358683"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```bash\r\ntest/coins_tests.cpp:1065:30: error: 'coin' used after it was moved [bugprone-use-after-move,-warnings-as-errors]\r\n    BOOST_CHECK_EQUAL(value, coin.out.nValue);\r\n                             ^\r\ntest/coins_tests.cpp:1061:20: note: move occurred here\r\n    all_caches[0]->AddCoin(outp, std::move(coin), false);\r\n                   ^\r\n```",
      "commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "created_at" : "2023-01-18T10:29:37Z",
      "diff_hunk" : "@@ -878,4 +895,209 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n                     CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n }\n \n+\n+Coin MakeCoin()\n+{\n+    Coin coin;\n+    coin.out.nValue = InsecureRand32();\n+    coin.nHeight = InsecureRandRange(4096);\n+    coin.fCoinBase = 0;\n+    return coin;\n+}\n+\n+\n+//! For CCoinsViewCache instances backed by either another cache instance or\n+//! leveldb, test cache behavior and flag state (DIRTY/FRESH) by\n+//!\n+//! 1. Adding a random coin to the child-most cache,\n+//! 2. Flushing all caches (without erasing),\n+//! 3. Ensure the entry still exists in the cache and has been written to parent,\n+//! 4. (if `do_erasing_flush`) Flushing the caches again (with erasing),\n+//! 5. (if `do_erasing_flush`) Ensure the entry has been written to the parent and is no longer in the cache,\n+//! 6. Spend the coin, ensure it no longer exists in the parent.\n+//!\n+void TestFlushBehavior(\n+    CCoinsViewCacheTest* view,\n+    CCoinsViewDB& base,\n+    std::vector<CCoinsViewCacheTest*>& all_caches,\n+    bool do_erasing_flush)\n+{\n+    CAmount value;\n+    char flags;\n+    uint256 txid;\n+    COutPoint outp;\n+    Coin coin;\n+    size_t cache_usage;\n+\n+    auto flush_all = [&all_caches](bool erase) {\n+        // Flush in reverse order to ensure that flushes happen from children up.\n+        for (auto i = all_caches.rbegin(); i != all_caches.rend(); ++i) {\n+            auto cache = *i;\n+            // hashBlock must be filled before flushing to disk; value is\n+            // unimportant here. This is normally done during connect/disconnect block.\n+            cache->SetBestBlock(InsecureRand256());\n+            erase ? cache->Flush() : cache->Sync();\n+        }\n+    };\n+\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    // Ensure the coins views haven't seen this coin before.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+\n+    // --- 1. Adding a random coin to the child cache\n+    //\n+    Coin tmpCoin{coin};\n+    view->AddCoin(outp, std::move(tmpCoin), false);\n+\n+    cache_usage = view->DynamicMemoryUsage();\n+    // `base` shouldn't have coin (no flush yet) but `view` should have cached it.\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, DIRTY|FRESH);\n+\n+    // --- 2. Flushing all caches (without erasing)\n+    //\n+    flush_all(/*erase*/ false);\n+\n+    // CoinsMap usage should be unchanged since we didn't erase anything.\n+    BOOST_CHECK_EQUAL(cache_usage, view->DynamicMemoryUsage());\n+\n+    // --- 3. Ensuring the entry still exists in the cache and has been written to parent\n+    //\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+    BOOST_CHECK_EQUAL(flags, 0);  // Flags should have been wiped.\n+\n+    // Both views should now have the coin.\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(view->HaveCoin(outp));\n+\n+    if (do_erasing_flush) {\n+        // --- 4. Flushing the caches again (with erasing)\n+        //\n+        flush_all(/*erase*/ true);\n+\n+        // Memory usage should have gone down.\n+        BOOST_CHECK(view->DynamicMemoryUsage() < cache_usage);\n+\n+        // --- 5. Ensuring the entry is no longer in the cache\n+        //\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, ABSENT);\n+        BOOST_CHECK_EQUAL(flags, NO_ENTRY);\n+\n+        view->AccessCoin(outp);\n+        GetCoinsMapEntry(view->map(), value, flags, outp);\n+        BOOST_CHECK_EQUAL(value, coin.out.nValue);\n+        BOOST_CHECK_EQUAL(flags, 0);\n+    }\n+\n+    // Can't overwrite an entry without specifying that an overwrite is\n+    // expected.\n+    Coin tmpCoin2{coin};\n+    BOOST_CHECK_THROW(\n+        view->AddCoin(outp, std::move(tmpCoin2), /*possible_overwrite*/ false),\n+        std::logic_error);\n+\n+    // --- 6. Spend the coin.\n+    //\n+    BOOST_CHECK(view->SpendCoin(outp));\n+\n+    // The coin should be in the cache, but spent and marked dirty.\n+    GetCoinsMapEntry(view->map(), value, flags, outp);\n+    BOOST_CHECK_EQUAL(value, SPENT);\n+    BOOST_CHECK_EQUAL(flags, DIRTY);\n+    BOOST_CHECK(!view->HaveCoin(outp)); // Coin should be considered spent in `view`.\n+    BOOST_CHECK(base.HaveCoin(outp));  // But coin should still be unspent in `base`.\n+\n+    flush_all(/*erase*/ false);\n+\n+    // Coin should be considered spent in both views.\n+    BOOST_CHECK(!view->HaveCoin(outp));\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+\n+    // Spent coin should not be spendable.\n+    BOOST_CHECK(!view->SpendCoin(outp));\n+\n+    // --- Bonus check: ensure that a coin added to the base view via one cache\n+    //     can be spent by another cache which has never seen it.\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);\n+    all_caches[0]->Sync();\n+    BOOST_CHECK(base.HaveCoin(outp));\n+    BOOST_CHECK(all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoinInCache(outp));\n+\n+    BOOST_CHECK(all_caches[1]->SpendCoin(outp));\n+    flush_all(/*erase*/ false);\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    flush_all(/*erase*/ true); // Erase all cache content.\n+\n+    // --- Bonus check 2: ensure that a FRESH, spent coin is deleted by Sync()\n+    //\n+    txid = InsecureRand256();\n+    outp = COutPoint(txid, 0);\n+    coin = MakeCoin();\n+    BOOST_CHECK(!base.HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[0]->HaveCoin(outp));\n+    BOOST_CHECK(!all_caches[1]->HaveCoin(outp));\n+\n+    // Add and spend from same cache without flushing.\n+    all_caches[0]->AddCoin(outp, std::move(coin), false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r1073358683",
      "id" : 1073358683,
      "line" : 1062,
      "node_id" : "PRRC_kwDOABII584_-idb",
      "original_commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "original_line" : 1062,
      "original_position" : 290,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 290,
      "pull_request_review_id" : 1253213780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073358683/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-18T10:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073358683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r1073360829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073360829"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can add the = to these comments so that clang-tidy will check them.\r\n```suggestion\r\n    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase=*/ true);\r\n```",
      "commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "created_at" : "2023-01-18T10:31:34Z",
      "diff_hunk" : "@@ -220,12 +234,29 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n }\n \n bool CCoinsViewCache::Flush() {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock);\n+    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase*/ true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17487#discussion_r1073360829",
      "id" : 1073360829,
      "line" : 237,
      "node_id" : "PRRC_kwDOABII584_-i-9",
      "original_commit_id" : "0c2fc5154e88b46725b8a1c2149aa94c552d1e03",
      "original_line" : 237,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 66,
      "pull_request_review_id" : 1253213780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17487",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073360829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-18T10:32:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1073360829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
