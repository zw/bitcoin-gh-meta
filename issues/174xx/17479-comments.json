[
   {
      "author_association" : "MEMBER",
      "body" : "This is the first two commits from #16279. Thanks for your work, @TheBlueMatt!",
      "created_at" : "2019-11-14T17:18:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-553988839",
      "id" : 553988839,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Mzk4ODgzOQ==",
      "updated_at" : "2019-11-14T17:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/553988839",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19791 ([net processing] Move Misbehaving() to PeerManager by jnewbery)\n* #15545 ([doc] explain why CheckBlock() is called before AcceptBlock by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-11-14T19:15:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554036805",
      "id" : 554036805,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDAzNjgwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-25T03:20:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554036805",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've added a commit that deduplicates post-block-checking code, which makes the main commit in this PR smaller and (I hope) easier to understand.",
      "created_at" : "2019-11-14T21:19:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554084723",
      "id" : 554084723,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDA4NDcyMw==",
      "updated_at" : "2019-11-14T21:19:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554084723",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've taken the final (behaviour change) commit from #16279 and PR'ed it as #17485. That gives some justification for this PR. If we get the anti-dos / mutation checks back from validation immediately, we can use that state to mark the block as no longer in-flight, rather than by indirectly checking that the block has been written to disk.\r\n\r\nSeparating into two PRs makes this easier to review. This PR should result in no behaviour changes (modulo the `BlockChecked()` callback in net processing now being called immediately instead of on the background scheduler thread), and the follow-up PR has the (minor) behaviour change along with lots of commenting and justification.",
      "created_at" : "2019-11-14T22:28:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554110522",
      "id" : 554110522,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDExMDUyMg==",
      "updated_at" : "2019-11-14T22:28:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554110522",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I found the last commit in this PR (71867666388bf1137b431f944fd430f262480eba) a bit hard to parse, so I split it up in my branch here: https://github.com/bitcoin/bitcoin/compare/master...dongcarl:2019-11-processnewblock-early-return-redo-last. The main change in the last commit on this branch resides in f46102be8fdd1ef8a21b821c121ed9fa027c9d32 on mine, and f46102be8fdd1ef8a21b821c121ed9fa027c9d32 also retains the same commit message. Feel free to use/use only to review/not use.",
      "created_at" : "2019-11-15T21:06:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554528497",
      "id" : 554528497,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDUyODQ5Nw==",
      "updated_at" : "2019-11-15T21:06:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554528497",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347011474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347011474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps I'm understanding wrong but this shouldn't apply anymore?",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-15T21:07:35Z",
      "diff_hunk" : "@@ -199,22 +199,33 @@ static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n  * block is made active. Note that it does not, however, guarantee that the\n  * specific block passed to it has been checked for validity!\n  *\n- * If you want to *possibly* get feedback on whether pblock is valid, you must\n- * install a CValidationInterface (see validationinterface.h) - this will have\n- * its BlockChecked method called whenever *any* block completes validation.\n+ * Performs initial sanity checks using the provided BlockValidationState before\n+ * connecting any block(s). If you want to *possibly* get feedback on whether\n+ * pblock is valid beyond just cursory mutation/DoS checks, you must install\n+ * a CValidationInterface (see validationinterface.h) - this will have its\n+ * BlockChecked method called whenever *any* block completes validation (note",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347011474",
      "id" : 347011474,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzAxMTQ3NA==",
      "original_commit_id" : "71867666388bf1137b431f944fd430f262480eba",
      "original_line" : 154,
      "original_position" : 11,
      "original_start_line" : 205,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 317869779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : 153,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347011474",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the branch @dongcarl ! I've reset to that and made a couple of minor comment changes.",
      "created_at" : "2019-11-15T22:19:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554551727",
      "id" : 554551727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDU1MTcyNw==",
      "updated_at" : "2019-11-15T22:19:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554551727",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347035231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347035231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "BlockChecked is called for any block that we try to connect to the chain. See the call in `ConnectTip()`:\r\n\r\n- if the call to `ConnectBlock()` failed, then we'll call `BlockChecked()` with a state that is NOT `IsValid()`.\r\n- if the call to `ConnectBlock()` succeeded, then the block has been connected and is part of the main chain, and we'll call `BlockChecked()` with a state that IS `IsValid()`.\r\n\r\nNote that we may never even call `ConnectTip()` if we don't try to connect the block to the most work chain.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-15T22:23:13Z",
      "diff_hunk" : "@@ -199,22 +199,33 @@ static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n  * block is made active. Note that it does not, however, guarantee that the\n  * specific block passed to it has been checked for validity!\n  *\n- * If you want to *possibly* get feedback on whether pblock is valid, you must\n- * install a CValidationInterface (see validationinterface.h) - this will have\n- * its BlockChecked method called whenever *any* block completes validation.\n+ * Performs initial sanity checks using the provided BlockValidationState before\n+ * connecting any block(s). If you want to *possibly* get feedback on whether\n+ * pblock is valid beyond just cursory mutation/DoS checks, you must install\n+ * a CValidationInterface (see validationinterface.h) - this will have its\n+ * BlockChecked method called whenever *any* block completes validation (note",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347035231",
      "id" : 347035231,
      "in_reply_to_id" : 347011474,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzAzNTIzMQ==",
      "original_commit_id" : "71867666388bf1137b431f944fd430f262480eba",
      "original_line" : 154,
      "original_position" : 11,
      "original_start_line" : 205,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 317901418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : 153,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347035231",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347577049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347577049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`submitblock_StateCacher` is the last client of validationinterface, I think we can go further, tweak it a bit and remove definitely `BlockChecked`, see : https://github.com/ariard/bitcoin/commits/2019-11-processnewblock-review\r\n(but maybe to include this in a follow-up cleanup PR?)",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-18T19:50:34Z",
      "diff_hunk" : "@@ -784,6 +784,9 @@ static UniValue submitblock(const JSONRPCRequest& request)\n     if (!new_block && accepted) {\n         return \"duplicate\";\n     }\n+    if (!dos_state.IsValid()) {\n+        return BIP22ValidationResult(dos_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347577049",
      "id" : 347577049,
      "line" : 955,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzU3NzA0OQ==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 955,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : 22,
      "pull_request_review_id" : 318587270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347577049",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347580252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347580252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Isn't this check break `BlockChecked` where we check `state.IsValid` for promoting peer to compact block announcement?",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-18T19:57:34Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347580252",
      "id" : 347580252,
      "line" : 1988,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzU4MDI1Mg==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 1988,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 318587270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347580252",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347582776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347582776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can't this branch combined with `BlockChecked` by passing new_block as param? Even wonder if we still need `fNewBlock` in PNB, as  `BlockChecked`  erase block from `mapBlockSource` independently of validity/novelty",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-18T20:03:34Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {\n+        // The block failed anti-dos / mutation checks. Call BlockChecked() callback here.\n+        // This clears the block from mapBlockSource.\n+        BlockChecked(*pblock, state, connman);\n+    } else if (!new_block) {\n+        // Block was valid but we've seen it before. Clear it from mapBlockSource.\n         LOCK(cs_main);\n         ::mapBlockSource.erase(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347582776",
      "id" : 347582776,
      "line" : 1995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzU4Mjc3Ng==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 1995,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 318587270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347582776",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347617540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347617540"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No. `BlockProcessed` is only called when `ProcessNewBlock()` returns early because the block failed `CheckBlock()` or `AcceptBlock()`. The logic you're talking about for promoting a peer to compact block announcement in `BlockChecked()` is only invoked when `BlockChecked()` is called after successfully connecting a valid block.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-18T21:25:55Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347617540",
      "id" : 347617540,
      "in_reply_to_id" : 347580252,
      "line" : 1988,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzYxNzU0MA==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 1988,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 318640247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347617540",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347618870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347618870"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`BlockChecked()` will only be called from `BlockProcessed()` if the block failed `CheckBlock()`/`AcceptBlock()`. This else branch is catching the case where the block didn't fail, but we've seen it before.\r\n\r\nIf you think this can be cleaned up further, perhaps we can do it in a follow-up PR.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-18T21:29:00Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {\n+        // The block failed anti-dos / mutation checks. Call BlockChecked() callback here.\n+        // This clears the block from mapBlockSource.\n+        BlockChecked(*pblock, state, connman);\n+    } else if (!new_block) {\n+        // Block was valid but we've seen it before. Clear it from mapBlockSource.\n         LOCK(cs_main);\n         ::mapBlockSource.erase(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347618870",
      "id" : 347618870,
      "in_reply_to_id" : 347582776,
      "line" : 1995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzYxODg3MA==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 1995,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 318640247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347618870",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347619936"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347619936"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I was planning to do this as a follow-up PR.\r\n\r\nI've had a quick look at your branch. I think it misses breaks the 'promote to announcing compact blocks' behaviour. We'd want to move that to a different validation interface event (probably `UpdatedBlockTip()`)",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-18T21:31:33Z",
      "diff_hunk" : "@@ -784,6 +784,9 @@ static UniValue submitblock(const JSONRPCRequest& request)\n     if (!new_block && accepted) {\n         return \"duplicate\";\n     }\n+    if (!dos_state.IsValid()) {\n+        return BIP22ValidationResult(dos_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347619936",
      "id" : 347619936,
      "in_reply_to_id" : 347577049,
      "line" : 955,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzYxOTkzNg==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 955,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : 22,
      "pull_request_review_id" : 318640247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347619936",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r348037038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348037038"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, right, the call to `BlockChecked` is still in `ConnectTip` path on your branch. I still think that's counter-intuitive to have both peer punishment and compact blocks promotion in one function, so would be down to split in a follow-up PR and like you said previously rely on `UpdatedBlockTip` for the latter.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-19T16:38:50Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r348037038",
      "id" : 348037038,
      "in_reply_to_id" : 347580252,
      "line" : 1988,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODAzNzAzOA==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 1988,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 319183434,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348037038",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r348038837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348038837"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah yes, agree with you, better to do it in a follow-up PR to avoid breaking things inadvertently.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-19T16:41:52Z",
      "diff_hunk" : "@@ -784,6 +784,9 @@ static UniValue submitblock(const JSONRPCRequest& request)\n     if (!new_block && accepted) {\n         return \"duplicate\";\n     }\n+    if (!dos_state.IsValid()) {\n+        return BIP22ValidationResult(dos_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r348038837",
      "id" : 348038837,
      "in_reply_to_id" : 347577049,
      "line" : 955,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODAzODgzNw==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 955,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : 22,
      "pull_request_review_id" : 319185866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348038837",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r349358840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349358840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The documentation strikes me as repetitive with the code. Perhaps it could be phrased differently such that if the code changes the comment doesn't need to be updated.\r\n\r\nnit: s/was failed/failed",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-21T22:53:01Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r349358840",
      "id" : 349358840,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTM1ODg0MA==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 1893,
      "original_position" : 7,
      "original_start_line" : 1891,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 321241524,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349358840",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r349799232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349799232"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Work in progress: https://github.com/jnewbery/bitcoin/tree/2019-11-remove-block-checked",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2019-11-22T21:21:32Z",
      "diff_hunk" : "@@ -784,6 +784,9 @@ static UniValue submitblock(const JSONRPCRequest& request)\n     if (!new_block && accepted) {\n         return \"duplicate\";\n     }\n+    if (!dos_state.IsValid()) {\n+        return BIP22ValidationResult(dos_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r349799232",
      "id" : 349799232,
      "in_reply_to_id" : 347577049,
      "line" : 955,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTc5OTIzMg==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_line" : 955,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : 22,
      "pull_request_review_id" : 321816657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-14T20:34:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349799232",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jkczyz . I've updated the function comment to be less redundant.",
      "created_at" : "2019-11-22T21:27:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-557700722",
      "id" : 557700722,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzcwMDcyMg==",
      "updated_at" : "2019-11-22T21:27:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557700722",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-12-16T21:53:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-566261209",
      "id" : 566261209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NjI2MTIwOQ==",
      "updated_at" : "2019-12-16T21:53:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/566261209",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2019-12-19T19:23:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-567627381",
      "id" : 567627381,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NzYyNzM4MQ==",
      "updated_at" : "2019-12-19T19:23:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/567627381",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-03-01T22:06:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-593151629",
      "id" : 593151629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MzE1MTYyOQ==",
      "updated_at" : "2020-03-01T22:06:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593151629",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-03-13T20:46:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-598904334",
      "id" : 598904334,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODkwNDMzNA==",
      "updated_at" : "2020-03-13T20:46:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598904334",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-16T15:16:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-599593329",
      "id" : 599593329,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTU5MzMyOQ==",
      "updated_at" : "2020-03-16T15:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599593329",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks :octopus: . I've rebased on master.",
      "created_at" : "2020-03-22T02:18:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-602137630",
      "id" : 602137630,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMjEzNzYzMA==",
      "updated_at" : "2020-03-22T02:18:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/602137630",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-08T16:45:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-611067478",
      "id" : 611067478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMTA2NzQ3OA==",
      "updated_at" : "2020-04-08T16:45:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/611067478",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-04-15T20:52:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-614274230",
      "id" : 614274230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDI3NDIzMA==",
      "updated_at" : "2020-04-15T20:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614274230",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-16T16:19:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-614752678",
      "id" : 614752678,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDc1MjY3OA==",
      "updated_at" : "2020-04-16T16:19:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614752678",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-04-16T19:33:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-614853019",
      "id" : 614853019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDg1MzAxOQ==",
      "updated_at" : "2020-04-16T19:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614853019",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oops. Bad rebase. Should be fixed now.",
      "created_at" : "2020-05-14T20:34:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-628872357",
      "id" : 628872357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODg3MjM1Nw==",
      "updated_at" : "2020-05-14T20:34:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628872357",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-05-23T12:06:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-633038846",
      "id" : 633038846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzAzODg0Ng==",
      "updated_at" : "2020-05-23T12:06:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633038846",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430114946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430114946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "db0eecc\r\n\r\nnit: Is there any guidelines on parameters sorting ? You can sort by param[in] then param[out]. It makes easier to reason on function. You can also precise in commit that new `dos_state` isn't used.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2020-05-26T01:31:47Z",
      "diff_hunk" : "@@ -157,12 +157,13 @@ extern uint64_t nPruneTarget;\n  * May not be called in a\n  * validationinterface callback.\n  *\n- * @param[in]   pblock  The block we want to process.\n- * @param[in]   fForceProcessing Process this block even if unrequested; used for non-network block sources and whitelisted peers.\n- * @param[out]  fNewBlock A boolean which is set to indicate if the block was first received via this call\n- * @returns     If the block was processed, independently of block validity\n+ * @param[in]   pblock            The block we want to process.\n+ * @param[out]  state             Currently unused.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430114946",
      "id" : 430114946,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNDk0Ng==",
      "original_commit_id" : "db0eecc2bd674c7c0b4400630dfbd40f1f6243a0",
      "original_line" : 161,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 417920876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T01:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430114946",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430115761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430115761"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a85e8b7\r\n\r\nIn `ConnectTip`, we call `ConnectBlock` then `BlockChecked` callback independently of success or failure of block validation ?",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2020-05-26T01:35:49Z",
      "diff_hunk" : "@@ -1332,8 +1332,11 @@ void PeerLogicValidation::UpdatedBlockTip(const CBlockIndex *pindexNew, const CB\n /**\n  * Handle invalid block rejection and consequent peer banning, maintain which\n  * peers announce compact blocks.\n+ * Called both in case of cursory DoS checks failing (implying the peer is likely\n+ * sending us bogus data) and after full validation of the block fails (which may",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430115761",
      "id" : 430115761,
      "line" : 1336,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNTc2MQ==",
      "original_commit_id" : "a85e8b7393b37e74ddd7ce0e5639bc1944f756f5",
      "original_line" : 1336,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 417920876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T01:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430115761",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430116434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430116434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8fc192c\r\n\r\nIs commit message right ? It mentions \"Net processing now passes a BlockValidationState object into\r\nProcessNewBlock()\" but in fact it's passing this object to `BlockProcessed` therefore making it used.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2020-05-26T01:39:39Z",
      "diff_hunk" : "@@ -147,18 +147,29 @@ extern uint64_t nPruneTarget;\n  * block is made active. Note that it does not, however, guarantee that the\n  * specific block passed to it has been checked for validity!\n  *\n- * If you want to *possibly* get feedback on whether pblock is valid, you must\n- * install a CValidationInterface (see validationinterface.h) - this will have\n- * its BlockChecked method called whenever *any* block completes validation.\n+ * Performs initial sanity checks using the provided BlockValidationState before\n+ * connecting any block(s). If you want to *possibly* get feedback on whether\n+ * pblock is valid beyond just cursory mutation/DoS checks, you must install\n+ * a CValidationInterface (see validationinterface.h) - this will have its\n+ * BlockChecked method called whenever *any* block completes validation (note\n+ * that any invalidity returned via state will *not* also be provided via\n+ * BlockChecked). There is, of course, no guarantee that any given block which\n+ * is not a part of the eventual best chain will ever be checked.\n  *\n- * Note that we guarantee that either the proof-of-work is valid on pblock, or\n- * (and possibly also) BlockChecked will have been called.\n+ * If the block pblock is built on is in our header tree, and pblock is a\n+ * candidate for accepting to disk (either because it is a candidate for the\n+ * best chain soon, or fForceProcessing is set), but pblock has been mutated,\n+ * state is guaranteed to be some non-IsValid() state.\n  *\n- * May not be called in a\n- * validationinterface callback.\n+ * If fForceProcessing is set (or fNewBlock returns true), and state.IsValid(),\n+ * barring pruning and a desire to re-download a pruned block, there should\n+ * never be any reason to re-ProcessNewBlock any block with the same hash.\n+ *\n+ * May not be called in a validationinterface callback.\n  *\n  * @param[in]   pblock            The block we want to process.\n- * @param[out]  state             Currently unused.\n+ * @param[out]  state             Only used for failures in CheckBlock/AcceptBlock. For failure in block connection,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430116434",
      "id" : 430116434,
      "line" : 171,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNjQzNA==",
      "original_commit_id" : "8fc192c3ecb40695ebddbe736684b152081ea4df",
      "original_line" : 171,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 36,
      "pull_request_review_id" : 417920876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T01:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430116434",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430116965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430116965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8fc192c\r\n\r\nStill on commit message, \"Net processing wants to know about those failed check immediately...\" Can you explain why ? Overall, PR needs better motivation, I think you can point to changes in #18963, and the [asynchronicity gain](https://github.com/bitcoin/bitcoin/pull/18963/commits/7532cf6c56d015e8bae646138d71df825d2684ab), instead of compact blocks ones.  ",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2020-05-26T01:42:40Z",
      "diff_hunk" : "@@ -147,18 +147,29 @@ extern uint64_t nPruneTarget;\n  * block is made active. Note that it does not, however, guarantee that the\n  * specific block passed to it has been checked for validity!\n  *\n- * If you want to *possibly* get feedback on whether pblock is valid, you must\n- * install a CValidationInterface (see validationinterface.h) - this will have\n- * its BlockChecked method called whenever *any* block completes validation.\n+ * Performs initial sanity checks using the provided BlockValidationState before\n+ * connecting any block(s). If you want to *possibly* get feedback on whether\n+ * pblock is valid beyond just cursory mutation/DoS checks, you must install\n+ * a CValidationInterface (see validationinterface.h) - this will have its\n+ * BlockChecked method called whenever *any* block completes validation (note\n+ * that any invalidity returned via state will *not* also be provided via\n+ * BlockChecked). There is, of course, no guarantee that any given block which\n+ * is not a part of the eventual best chain will ever be checked.\n  *\n- * Note that we guarantee that either the proof-of-work is valid on pblock, or\n- * (and possibly also) BlockChecked will have been called.\n+ * If the block pblock is built on is in our header tree, and pblock is a\n+ * candidate for accepting to disk (either because it is a candidate for the\n+ * best chain soon, or fForceProcessing is set), but pblock has been mutated,\n+ * state is guaranteed to be some non-IsValid() state.\n  *\n- * May not be called in a\n- * validationinterface callback.\n+ * If fForceProcessing is set (or fNewBlock returns true), and state.IsValid(),\n+ * barring pruning and a desire to re-download a pruned block, there should\n+ * never be any reason to re-ProcessNewBlock any block with the same hash.\n+ *\n+ * May not be called in a validationinterface callback.\n  *\n  * @param[in]   pblock            The block we want to process.\n- * @param[out]  state             Currently unused.\n+ * @param[out]  state             Only used for failures in CheckBlock/AcceptBlock. For failure in block connection,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430116965",
      "id" : 430116965,
      "in_reply_to_id" : 430116434,
      "line" : 171,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNjk2NQ==",
      "original_commit_id" : "8fc192c3ecb40695ebddbe736684b152081ea4df",
      "original_line" : 171,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 36,
      "pull_request_review_id" : 417920876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T01:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430116965",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430117481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430117481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8fc192c\r\n\r\nHow does this new check behaves with regards to write-failure, first-seen block ? In `AcceptBlock`, if `blockPos` returned by `SaveBlockToDisk` is null, an error is set and not an invalid state, so it won't be erased by above `BlockChecked` call. I think it's catch up in current code but not after changes.",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2020-05-26T01:45:17Z",
      "diff_hunk" : "@@ -1981,15 +1981,21 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n }\n \n /**\n- *  A block has been processed. Do housekeeping.\n+ *  A block has been processed. Handle potential peer punishment and housekeeping.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {\n+        // The block failed anti-dos / mutation checks. Call BlockChecked() callback here.\n+        // This clears the block from mapBlockSource.\n+        BlockChecked(*pblock, state, connman);\n+    } else if (!new_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430117481",
      "id" : 430117481,
      "line" : 1992,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNzQ4MQ==",
      "original_commit_id" : "8fc192c3ecb40695ebddbe736684b152081ea4df",
      "original_line" : 1992,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 37,
      "pull_request_review_id" : 417920876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T01:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430117481",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430118345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430118345"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8fc192c\r\n\r\nI think this whole comment can be made clearer. \r\n\r\n\"You have 2 types of feedbacks:\r\n- unconditional : submitted block validity with regards to mutation, anti-Dos is returned through `BlockValidationState`. It may be used for housekeeping as in `BlockProcessed`\r\n- conditional : if caller subscribe to `CValidationInterface` and if submitted block passed those first checks, `ActivateBestChain`,  will be called to try to make progress towards the best known block and make it the tip of our block chain. Submitted block may be among such tip candidates. Consensus-validity feedback on best known block may be used for peer punishment and compact block promotion as in `BlockChecked`.\"",
      "commit_id" : "50048f45a07fdced2b97209a17bfa0b161518773",
      "created_at" : "2020-05-26T01:49:32Z",
      "diff_hunk" : "@@ -147,18 +147,29 @@ extern uint64_t nPruneTarget;\n  * block is made active. Note that it does not, however, guarantee that the\n  * specific block passed to it has been checked for validity!\n  *\n- * If you want to *possibly* get feedback on whether pblock is valid, you must\n- * install a CValidationInterface (see validationinterface.h) - this will have\n- * its BlockChecked method called whenever *any* block completes validation.\n+ * Performs initial sanity checks using the provided BlockValidationState before\n+ * connecting any block(s). If you want to *possibly* get feedback on whether\n+ * pblock is valid beyond just cursory mutation/DoS checks, you must install\n+ * a CValidationInterface (see validationinterface.h) - this will have its\n+ * BlockChecked method called whenever *any* block completes validation (note\n+ * that any invalidity returned via state will *not* also be provided via\n+ * BlockChecked). There is, of course, no guarantee that any given block which\n+ * is not a part of the eventual best chain will ever be checked.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r430118345",
      "id" : 430118345,
      "line" : 157,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExODM0NQ==",
      "original_commit_id" : "8fc192c3ecb40695ebddbe736684b152081ea4df",
      "original_line" : 157,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 14,
      "pull_request_review_id" : 417920876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T01:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430118345",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review after rebase.",
      "created_at" : "2020-07-08T06:37:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-655319425",
      "id" : 655319425,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTMxOTQyNQ==",
      "updated_at" : "2020-07-08T06:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655319425",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-07-12T16:47:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-657247766",
      "id" : 657247766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NzI0Nzc2Ng==",
      "updated_at" : "2020-07-12T16:47:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/657247766",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Took some time to prove to myself that there are no unintended behaviour changes. It wasn't obvious to me that 5e5d58c829001a774e2481a4a8c3598917b06e53 is trivially correct, so I'm most likely missing some context here.\r\n\r\nMy understanding is that prior to 5e5d58c829001a774e2481a4a8c3598917b06e53, `BlockChecked` is only called when `CheckBlock` or `AcceptBlock` returns false in `ProcessNewBlock`, causing `ProcessNewBlock` to return early right after calling `BlockChecked`.\r\n\r\nHowever, it seems that after 5e5d58c829001a774e2481a4a8c3598917b06e53, it is possible for both `CheckBlock` and `AcceptBlock` to return true, but for `dos_state.IsValid()` to be false, causing `BlockChecked` to be called in `BlockProcessed` where it wouldn't have before. Perhaps this is fine and intended, but I just wanted to make sure.\r\n\r\nHere's the diff I used for testing, and it seems to fail at `validation_block_tests/processnewblock_signals_ordering`:\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 524ae94b9a..3f5737fd35 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3856,9 +3856,11 @@ bool ChainstateManager::ProcessNewBlock(const CChainParams& chainparams, const s\r\n             ret = ::ChainstateActive().AcceptBlock(pblock, dos_state, chainparams, &pindex, fForceProcessing, nullptr, fNewBlock);\r\n         }\r\n         if (!ret) {\r\n+            assert(!dos_state.IsValid());  // We should always trigger BlockChecked in BlockProcessed in this codepath\r\n             return error(\"%s: AcceptBlock FAILED (%s)\", __func__, dos_state.ToString());\r\n         }\r\n     }\r\n+    assert(dos_state.IsValid());  // We should NOT trigger BlockChecked in BlockProcessed in this codepath\r\n \r\n     NotifyHeaderTip();\r\n \r\n```",
      "created_at" : "2020-07-14T16:54:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-658293827",
      "id" : 658293827,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODI5MzgyNw==",
      "updated_at" : "2020-07-14T16:54:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658293827",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-15T14:46:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-658812502",
      "id" : 658812502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODgxMjUwMg==",
      "updated_at" : "2020-07-15T14:46:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658812502",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The first commit has now been merged in #19533. I've rebased the remaining commits on master.",
      "created_at" : "2020-07-16T14:03:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-659433523",
      "id" : 659433523,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1OTQzMzUyMw==",
      "updated_at" : "2020-07-16T14:03:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/659433523",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-08-24T14:30:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-679162173",
      "id" : 679162173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3OTE2MjE3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-24T14:30:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/679162173",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-07T17:41:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-688452423",
      "id" : 688452423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ1MjQyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T17:41:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688452423",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm focused on other things right now, so I'm going to close this with the intention of opening it again at some point in the future.",
      "created_at" : "2020-09-16T09:21:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-693284719",
      "id" : 693284719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzI4NDcxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T09:21:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693284719",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
