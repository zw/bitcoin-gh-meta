[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340280978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340280978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move SetWalletFlag out of LegacyScriptPubKeyMan::UpgradeKeyMetadata\" (a5ca4664e74201a08cef1d147ed4446fd74784f8)\r\n\r\nCould drop this reset line since batch is going out of scope anyway.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T19:26:40Z",
      "diff_hunk" : "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);\n+    batch.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340280978",
      "id" : 340280978,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI4MDk3OA==",
      "original_commit_id" : "a5ca4664e74201a08cef1d147ed4446fd74784f8",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340280978",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340285227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340285227"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move SetWalletFlag out of LegacyScriptPubKeyMan::UpgradeKeyMetadata\" (a5ca4664e74201a08cef1d147ed4446fd74784f8):\r\n\r\nWould it be possible to drop the WalletStorage SetWalletFlag method entirely after this? I don't see another call even in #17261",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T19:37:10Z",
      "diff_hunk" : "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340285227",
      "id" : 340285227,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI4NTIyNw==",
      "original_commit_id" : "a5ca4664e74201a08cef1d147ed4446fd74784f8",
      "original_position" : 5,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 74,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340285227",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340290082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340290082"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Remove UnsetWalletFlag call from LegacyScriptPubKeyMan::SetHDSeed\" (d35a98b6e04a3750c48bf21af64d0375fe2ae395)\r\n\r\nAll the UnsetWalletFlagWithDB calls are just unsetting `WALLET_FLAG_BLANK_WALLET`. Maybe WalletStorage should just have a specific `UnsetBlankWalletFlag` method and not expose more general flag set/unset methods. With multiple key managers per wallet, it might be safer if individual key managers don't have ability to arbitrarily set flags shared with other key managers.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T19:48:42Z",
      "diff_hunk" : "@@ -874,7 +874,8 @@ void LegacyScriptPubKeyMan::SetHDSeed(const CPubKey& seed)\n     newHdChain.seed_id = seed.GetID();\n     SetHDChain(newHdChain, false);\n     NotifyCanGetAddressesChanged();\n-    m_wallet.UnsetWalletFlag(WALLET_FLAG_BLANK_WALLET);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    m_storage.UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340290082",
      "id" : 340290082,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5MDA4Mg==",
      "original_commit_id" : "d35a98b6e04a3750c48bf21af64d0375fe2ae395",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340290082",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340291130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340291130"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move SetAddressBookWithDB call out of LegacyScriptPubKeyMan::ImportScriptPubKeys\" (974d7749f1d9e55a01a2e30db2bdf6b89c18baff)\r\n\r\nCould skip this whole block of code if `apply_label` is false",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T19:51:00Z",
      "diff_hunk" : "@@ -1401,9 +1401,17 @@ bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScri\n         return false;\n     }\n     AssertLockHeld(spk_man->cs_wallet);\n-    if (!spk_man->ImportScriptPubKeys(label, script_pub_keys, have_solving_data, apply_label, timestamp)) {\n+    if (!spk_man->ImportScriptPubKeys(script_pub_keys, have_solving_data, timestamp)) {\n         return false;\n     }\n+    WalletBatch batch(*database);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340291130",
      "id" : 340291130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5MTEzMA==",
      "original_commit_id" : "974d7749f1d9e55a01a2e30db2bdf6b89c18baff",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340291130",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340296308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340296308"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move GetMetadata code out of getaddressinfo\" (bdb538d2fa8b171f1a96580a0f0a7395d52b336e)\r\n\r\nIt doesn't seem strictly true that this commit doesn't change behavior. Before the code was looking up `key_id` only in `mapKeyMetadata` and `CScriptID(scriptPubKey)` only in `m_script_metadata`. Now it is looking up both values in both maps, which I guess is fine, but maybe more confusing and less efficient.\r\n\r\nI think it'd probably be clearer and more type-safe to have separate `GetKeyMetadata` and `GetScriptMetadata` methods.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T20:02:42Z",
      "diff_hunk" : "@@ -3756,26 +3756,24 @@ UniValue getaddressinfo(const JSONRPCRequest& request)\n         ret.pushKV(\"label\", pwallet->mapAddressBook[dest].name);\n     }\n     ret.pushKV(\"ischange\", pwallet->IsChange(scriptPubKey));\n-    const CKeyMetadata* meta = nullptr;\n-    CKeyID key_id = GetKeyForDestination(*provider, dest);\n-    if (!key_id.IsNull()) {\n-        auto it = pwallet->mapKeyMetadata.find(key_id);\n-        if (it != pwallet->mapKeyMetadata.end()) {\n-            meta = &it->second;\n+\n+    ScriptPubKeyMan* spk_man = pwallet->GetScriptPubKeyMan();\n+    if (spk_man) {\n+        CKeyID key_id = GetKeyForDestination(*provider, dest);\n+        const CKeyMetadata* meta = nullptr;\n+        if (!key_id.IsNull()) {\n+            meta = spk_man->GetMetadata(key_id);\n         }\n-    }\n-    if (!meta) {\n-        auto it = pwallet->m_script_metadata.find(CScriptID(scriptPubKey));\n-        if (it != pwallet->m_script_metadata.end()) {\n-            meta = &it->second;\n+        if (!meta) {\n+            meta = spk_man->GetMetadata(CScriptID(scriptPubKey));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340296308",
      "id" : 340296308,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5NjMwOA==",
      "original_commit_id" : "bdb538d2fa8b171f1a96580a0f0a7395d52b336e",
      "original_position" : 24,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 24,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340296308",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17283](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17283.html) (rpc: improve getaddressinfo test coverage, help, code docs by jonatack)\n* [#17261](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17261.html) (Make ScriptPubKeyMan an actual interface and the wallet to have multiple by achow101)\n* [#16946](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16946.html) (wallet: include a checksum of encrypted private keys by achow101)\n* [#16910](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16910.html) (wallet: reduce loading time by using unordered maps by achow101)\n* [#16895](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16895.html) (External signer multisig support by Sjors)\n* [#16549](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16549.html) ([WIP] UI external signer support (e.g. hardware wallet) by Sjors)\n* [#16546](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16546.html) ([WIP] External signer support - Wallet Box edition by Sjors)\n* [#16224](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16224.html) (gui: Bilingual GUI error messages by hebasto)\n* [#15761](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15761.html) (Replace -upgradewallet startup option with upgradewallet RPC by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-10-29T20:07:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547606545",
      "id" : 547606545,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzYwNjU0NQ==",
      "updated_at" : "2019-10-31T14:13:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547606545",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340299078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340299078"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move MarkUnusedAddresses code out of CWallet::AddToWalletIfInvolvingMe\" (8c47cb9202e27a86609d7b3af91dee1f09468125)\r\n\r\nNote for other reviews: lock assert added here is needed to satisfy clang lock annotations and be able to call `MarkReserveKeysAsUsed` below. This line will be replaced by `LOCK(cs_KeyStore);` later in commit \"Locking: Lock cs_KeyStore instead of cs_main in legacy keyman\" 87cc2282b278d3891fc59823d883eef112606da9 from #17261",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T20:09:20Z",
      "diff_hunk" : "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340299078",
      "id" : 340299078,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5OTA3OA==",
      "original_commit_id" : "8c47cb9202e27a86609d7b3af91dee1f09468125",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 51,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340299078",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340307903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340307903"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move MarkUnusedAddresses code out of CWallet::AddToWalletIfInvolvingMe\" (8c47cb9202e27a86609d7b3af91dee1f09468125)\r\n\r\nNote for other reviewers: The `LegacyScriptPubKeyMan::TopUp` call in the previous code is changed to a `LegacyScriptPubKeyMan::TopUpKeyPool` call here. The two methods will do the exact same thing even after all the other changes in #17261, so there is no difference in behavior.\r\n\r\nIt seems like the pattern is just to always call `TopUp()` externally and always call `TopUpKeyPool()` internally, but it's not clear why the two methods are separate and I think it probably would clearer to combine them.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T20:28:43Z",
      "diff_hunk" : "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340307903",
      "id" : 340307903,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMwNzkwMw==",
      "original_commit_id" : "8c47cb9202e27a86609d7b3af91dee1f09468125",
      "original_position" : 14,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 59,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340307903",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340311958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340311958"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Add new ScriptPubKeyMan virtual methods\" (80a44800f35c3183edd8fc0914ed8edbd5c5887b)\r\n\r\nNote for other reviewers: after future changes in #17261 there are some differences in functionality between the Reserve/Keep/Return **destination** methods and the Reserve/Keep/Return **key** methods, and they are called from different places, so there's some justification for keeping them separate, though I think ideally we could follow up by combining them, or at least making clear what the differences in behavior are supposed to be between the two sets of functions.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T20:37:41Z",
      "diff_hunk" : "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {\n+        if (!ReserveKeyFromKeyPool(index, keypool, internal)) {\n+            return false;\n+        }\n+    }\n+    return true;\n+}\n+\n+void LegacyScriptPubKeyMan::KeepDestination(int64_t index)\n+{\n+    KeepKey(index);\n+}\n+\n+void LegacyScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CPubKey& pubkey)\n+{\n+    ReturnKey(index, internal, pubkey);\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340311958",
      "id" : 340311958,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMxMTk1OA==",
      "original_commit_id" : "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
      "original_position" : 22,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 42,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340311958",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340314846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340314846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move Upgrade code out of CWallet::CreateWalletFromFile\" (3814d7550ca2d53a9aa1613d61f79dc72b95770b)\r\n\r\nI think this added lock assert line is not actually necessary and could be dropped. Clang compiler seems fine without out it as of this commit.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T20:43:34Z",
      "diff_hunk" : "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340314846",
      "id" : 340314846,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMxNDg0Ng==",
      "original_commit_id" : "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 97,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340314846",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340321878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340321878"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move nTimeFirstKey accesses out of CWallet\" (e1b1702449a9172185d4bfb5e9043748328132ee)\r\n\r\nI think the numeric_limits approach is not the clearest here, because if wallet doesn't have any key managers, the code winds up calling `findFirstBlock` with an strange `0x7fffffffffffffff - TIMESTAMP_WINDOW` value.\r\n\r\nBetter I think to use optional instead:\r\n\r\n```c++\r\nOptional<int64_t> first_time;\r\nif (auto spk_man = walletInstance->m_spk_man.get()) {\r\n    int64_t time = spk_man->GetTimeFirstKey();\r\n    if (!first_time || time < *first_time) first_time = time;\r\n}\r\nif (time_first_key) {\r\n    if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(*first_time - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\r\n        rescan_height = *first_block;\r\n    }\r\n}\r\n```",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T20:58:42Z",
      "diff_hunk" : "@@ -3794,8 +3794,12 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        int64_t time_first_key = std::numeric_limits<int64_t>::max();\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            time_first_key = std::min(time_first_key, spk_man->GetTimeFirstKey());\n+        }\n+        if (time_first_key) {\n+            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(time_first_key - TIMESTAMP_WINDOW, rescan_height, nullptr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340321878",
      "id" : 340321878,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMyMTg3OA==",
      "original_commit_id" : "e1b1702449a9172185d4bfb5e9043748328132ee",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340321878",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340326092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340326092"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move SetupGeneration code out of CWallet\" (f95750d52a21a69ad55db8422f10c563fb9e08ac)\r\n\r\nNote for other reviews: Previous code was calling TopUp, while new code is calling SetupGeneration which calls NewKeyPool which calls TopUpKeyPool. I think the effect is basically the same because fFirstRun is true here so the additional ErasePool calls in NewKeyPool should have no effect.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T21:07:57Z",
      "diff_hunk" : "@@ -3623,15 +3625,12 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         walletInstance->SetWalletFlags(wallet_creation_flags, false);\n         if (!(wallet_creation_flags & (WALLET_FLAG_DISABLE_PRIVATE_KEYS | WALLET_FLAG_BLANK_WALLET))) {\n-            // generate a new seed\n-            CPubKey seed = walletInstance->m_spk_man->GenerateNewSeed();\n-            walletInstance->m_spk_man->SetHDSeed(seed);\n-        }\n-\n-        // Top up the keypool\n-        if (walletInstance->m_spk_man->CanGenerateKeys() && !walletInstance->m_spk_man->TopUp()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340326092",
      "id" : 340326092,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMyNjA5Mg==",
      "original_commit_id" : "f95750d52a21a69ad55db8422f10c563fb9e08ac",
      "original_position" : 41,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340326092",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340329325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340329325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move SetupGeneration code out of CWallet\" (f95750d52a21a69ad55db8422f10c563fb9e08ac)\r\n\r\nShould this be checking the return code from SetupGeneration and setting an error if it fails? Old code wasn't checking the return value from NewKeyPool either, but that doesn't seem right.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T21:15:26Z",
      "diff_hunk" : "@@ -210,9 +210,11 @@ WalletCreationStatus CreateWallet(interfaces::Chain& chain, const SecureString&\n             }\n \n             // Set a seed for the wallet\n-            CPubKey master_pub_key = wallet->m_spk_man->GenerateNewSeed();\n-            wallet->m_spk_man->SetHDSeed(master_pub_key);\n-            wallet->m_spk_man->NewKeyPool();\n+            {\n+                if (auto spk_man = wallet->m_spk_man.get()) {\n+                    spk_man->SetupGeneration();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340329325",
      "id" : 340329325,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMyOTMyNQ==",
      "original_commit_id" : "f95750d52a21a69ad55db8422f10c563fb9e08ac",
      "original_position" : 9,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 308776012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340329325",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340345745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340345745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "From the ScriptPubKeyMan design view, it doesn't make sense to have different metadata for keys and scripts, at least exposed publicly to the wallet. It should really be `GetMetadata` that takes a scriptPubKey, but it fit better to use uint160 for right now.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T21:57:30Z",
      "diff_hunk" : "@@ -3756,26 +3756,24 @@ UniValue getaddressinfo(const JSONRPCRequest& request)\n         ret.pushKV(\"label\", pwallet->mapAddressBook[dest].name);\n     }\n     ret.pushKV(\"ischange\", pwallet->IsChange(scriptPubKey));\n-    const CKeyMetadata* meta = nullptr;\n-    CKeyID key_id = GetKeyForDestination(*provider, dest);\n-    if (!key_id.IsNull()) {\n-        auto it = pwallet->mapKeyMetadata.find(key_id);\n-        if (it != pwallet->mapKeyMetadata.end()) {\n-            meta = &it->second;\n+\n+    ScriptPubKeyMan* spk_man = pwallet->GetScriptPubKeyMan();\n+    if (spk_man) {\n+        CKeyID key_id = GetKeyForDestination(*provider, dest);\n+        const CKeyMetadata* meta = nullptr;\n+        if (!key_id.IsNull()) {\n+            meta = spk_man->GetMetadata(key_id);\n         }\n-    }\n-    if (!meta) {\n-        auto it = pwallet->m_script_metadata.find(CScriptID(scriptPubKey));\n-        if (it != pwallet->m_script_metadata.end()) {\n-            meta = &it->second;\n+        if (!meta) {\n+            meta = spk_man->GetMetadata(CScriptID(scriptPubKey));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340345745",
      "id" : 340345745,
      "in_reply_to_id" : 340296308,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM0NTc0NQ==",
      "original_commit_id" : "bdb538d2fa8b171f1a96580a0f0a7395d52b336e",
      "original_position" : 24,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 24,
      "pull_request_review_id" : 308860327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340345745",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T22:09:29Z",
      "diff_hunk" : "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);\n+    batch.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349757",
      "id" : 340349757,
      "in_reply_to_id" : 340280978,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM0OTc1Nw==",
      "original_commit_id" : "a5ca4664e74201a08cef1d147ed4446fd74784f8",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 308865371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349757",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a commit dropping SetWalletFlag. Also checked it isn't being used in Descriptor wallets.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T22:10:21Z",
      "diff_hunk" : "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349989",
      "id" : 340349989,
      "in_reply_to_id" : 340285227,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM0OTk4OQ==",
      "original_commit_id" : "a5ca4664e74201a08cef1d147ed4446fd74784f8",
      "original_position" : 5,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 74,
      "pull_request_review_id" : 308865694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349989",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350744"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a commit changing those to UnsetBlankWalletFlag. Also checked DescriptorScriptPubKeyMan doesn't use UnsetWalletFlag.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T22:12:35Z",
      "diff_hunk" : "@@ -874,7 +874,8 @@ void LegacyScriptPubKeyMan::SetHDSeed(const CPubKey& seed)\n     newHdChain.seed_id = seed.GetID();\n     SetHDChain(newHdChain, false);\n     NotifyCanGetAddressesChanged();\n-    m_wallet.UnsetWalletFlag(WALLET_FLAG_BLANK_WALLET);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    m_storage.UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350744",
      "id" : 340350744,
      "in_reply_to_id" : 340290082,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDc0NA==",
      "original_commit_id" : "d35a98b6e04a3750c48bf21af64d0375fe2ae395",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 308866623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350744",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T22:12:41Z",
      "diff_hunk" : "@@ -1401,9 +1401,17 @@ bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScri\n         return false;\n     }\n     AssertLockHeld(spk_man->cs_wallet);\n-    if (!spk_man->ImportScriptPubKeys(label, script_pub_keys, have_solving_data, apply_label, timestamp)) {\n+    if (!spk_man->ImportScriptPubKeys(script_pub_keys, have_solving_data, timestamp)) {\n         return false;\n     }\n+    WalletBatch batch(*database);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350776",
      "id" : 340350776,
      "in_reply_to_id" : 340291130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDc3Ng==",
      "original_commit_id" : "974d7749f1d9e55a01a2e30db2bdf6b89c18baff",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 308866655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350776",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T22:12:48Z",
      "diff_hunk" : "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350809",
      "id" : 340350809,
      "in_reply_to_id" : 340314846,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDgwOQ==",
      "original_commit_id" : "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 97,
      "pull_request_review_id" : 308866704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350809",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Made it an optional",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T22:12:56Z",
      "diff_hunk" : "@@ -3794,8 +3794,12 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        int64_t time_first_key = std::numeric_limits<int64_t>::max();\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            time_first_key = std::min(time_first_key, spk_man->GetTimeFirstKey());\n+        }\n+        if (time_first_key) {\n+            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(time_first_key - TIMESTAMP_WINDOW, rescan_height, nullptr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350852",
      "id" : 340350852,
      "in_reply_to_id" : 340321878,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDg1Mg==",
      "original_commit_id" : "e1b1702449a9172185d4bfb5e9043748328132ee",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 308866769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350852",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340351629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340351629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It should. Done.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-29T22:15:12Z",
      "diff_hunk" : "@@ -210,9 +210,11 @@ WalletCreationStatus CreateWallet(interfaces::Chain& chain, const SecureString&\n             }\n \n             // Set a seed for the wallet\n-            CPubKey master_pub_key = wallet->m_spk_man->GenerateNewSeed();\n-            wallet->m_spk_man->SetHDSeed(master_pub_key);\n-            wallet->m_spk_man->NewKeyPool();\n+            {\n+                if (auto spk_man = wallet->m_spk_man.get()) {\n+                    spk_man->SetupGeneration();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340351629",
      "id" : 340351629,
      "in_reply_to_id" : 340329325,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MTYyOQ==",
      "original_commit_id" : "f95750d52a21a69ad55db8422f10c563fb9e08ac",
      "original_position" : 9,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 308867696,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340351629",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure what your preference is @achow101, but it might be a good idea to replace #17261 with #17304 on the high priority review list https://github.com/bitcoin/bitcoin/projects/8, since #17261 builds on #17304.\r\n\r\nThis PR is also just making small and mostly obvious changes, so it should be more approachable for reviewers.",
      "created_at" : "2019-10-29T22:37:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547660167",
      "id" : 547660167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzY2MDE2Nw==",
      "updated_at" : "2019-10-29T22:37:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547660167",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Not sure what your preference is @achow101, but it might be a good idea to replace #17261 with #17304 on the high priority review list https://github.com/bitcoin/bitcoin/projects/8, since #17261 builds on #17304.\r\n\r\nYeah, it should replace that. #17261 was added to the list before I made this pr.\r\n",
      "created_at" : "2019-10-29T22:58:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547665962",
      "id" : 547665962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzY2NTk2Mg==",
      "updated_at" : "2019-10-29T22:58:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547665962",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340580879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340580879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340314846\r\n\r\n> Removed\r\n\r\nThe lock assert probably needs to be added back. I'm not sure why clang for me wasn't showing the same error, but clang on travis legitimately errors that it needs the assert to call `MarkPreSplitKeys():\r\n\r\n```\r\nwallet/scriptpubkeyman.cpp:399:9: error: calling function 'MarkPreSplitKeys' requires holding mutex 'cs_wallet' exclusively [-Werror,-Wthread-safety-analysis]\r\n        MarkPreSplitKeys();\r\n```",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-30T12:20:14Z",
      "diff_hunk" : "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340580879",
      "id" : 340580879,
      "in_reply_to_id" : 340314846,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDU4MDg3OQ==",
      "original_commit_id" : "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 97,
      "pull_request_review_id" : 309156187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340580879",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "mac build errors\r\n```\r\nMakefile:8720: recipe for target 'wallet/libbitcoin_wallet_a-scriptpubkeyman.o' failed\r\nwallet/scriptpubkeyman.cpp:399:9: error: calling function 'MarkPreSplitKeys' requires holding mutex 'cs_wallet' exclusively [-Werror,-Wthread-safety-analysis]\r\n        MarkPreSplitKeys();\r\n        ^\r\n```",
      "created_at" : "2019-10-30T15:13:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547956698",
      "id" : 547956698,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0Nzk1NjY5OA==",
      "updated_at" : "2019-10-30T15:13:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547956698",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340688363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340688363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added it back in.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-30T15:29:13Z",
      "diff_hunk" : "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340688363",
      "id" : 340688363,
      "in_reply_to_id" : 340314846,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDY4ODM2Mw==",
      "original_commit_id" : "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 97,
      "pull_request_review_id" : 309298572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-30T15:29:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340688363",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This PR has 18 commits, so it could be useful to get some Approach ACKS here on whether it's a reasonable size, or should be made smaller by dropping some number of commits, or dropping particular commits that seem more difficult to review. All of the commits should be small and straightforward, but it is also easily possible to scale back this PR if necessary.",
      "created_at" : "2019-10-31T13:28:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-548374757",
      "id" : 548374757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0ODM3NDc1Nw==",
      "updated_at" : "2019-10-31T13:28:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548374757",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341194391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341194391"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why the scope here?",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T15:09:22Z",
      "diff_hunk" : "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341194391",
      "id" : 341194391,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTE5NDM5MQ==",
      "original_commit_id" : "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 26,
      "pull_request_review_id" : 309955208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T15:36:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341194391",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341210205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341210205"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I realize this is stopping mid-way, but this was slightly confusing. Add a comment saying this is temporarily going to always be true until a loop is introduced?",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T15:35:38Z",
      "diff_hunk" : "@@ -3804,8 +3804,13 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        Optional<int64_t> time_first_key;\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            int64_t time = spk_man->GetTimeFirstKey();\n+            if (!time_first_key || time < *time_first_key) time_first_key = time;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341210205",
      "id" : 341210205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIxMDIwNQ==",
      "original_commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "original_position" : 9,
      "path" : "src/wallet/wallet.cpp",
      "position" : 312,
      "pull_request_review_id" : 309955208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T15:36:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341210205",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341229485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341229485"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A lock is going to be added in the next step",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T16:08:04Z",
      "diff_hunk" : "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341229485",
      "id" : 341229485,
      "in_reply_to_id" : 341194391,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIyOTQ4NQ==",
      "original_commit_id" : "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 26,
      "pull_request_review_id" : 310001130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T16:08:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341229485",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341230007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341230007"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That generally applies throughout this PR. So I guess a note to reviewers in the thread should be good enough?",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T16:09:00Z",
      "diff_hunk" : "@@ -3804,8 +3804,13 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        Optional<int64_t> time_first_key;\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            int64_t time = spk_man->GetTimeFirstKey();\n+            if (!time_first_key || time < *time_first_key) time_first_key = time;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341230007",
      "id" : 341230007,
      "in_reply_to_id" : 341210205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIzMDAwNw==",
      "original_commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "original_position" : 9,
      "path" : "src/wallet/wallet.cpp",
      "position" : 312,
      "pull_request_review_id" : 310001828,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T16:09:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341230007",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341233720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341233720"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok! Consider this your note, future reviewers ",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T16:15:35Z",
      "diff_hunk" : "@@ -3804,8 +3804,13 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        Optional<int64_t> time_first_key;\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            int64_t time = spk_man->GetTimeFirstKey();\n+            if (!time_first_key || time < *time_first_key) time_first_key = time;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341233720",
      "id" : 341233720,
      "in_reply_to_id" : 341210205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIzMzcyMA==",
      "original_commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "original_position" : 9,
      "path" : "src/wallet/wallet.cpp",
      "position" : 312,
      "pull_request_review_id" : 310006783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T16:15:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341233720",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341258866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341258866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> A lock is going to be added in the next step\r\n\r\nThe scope isn't needed even with the lock and all other changes from #17261:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/35b0f7b5447bce4eef360c7e4237a928bb0eba3c/src/wallet/scriptpubkeyman.cpp#L275-L290\r\n\r\nBut I don't think it's a big deal. Could clean this up later if reservekey and reservedestination methods are merged later (https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340311958)",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T17:03:17Z",
      "diff_hunk" : "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341258866",
      "id" : 341258866,
      "in_reply_to_id" : 341194391,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI1ODg2Ng==",
      "original_commit_id" : "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 26,
      "pull_request_review_id" : 310040055,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T17:03:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341258866",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm going through these commits now. I've seen this code a few times before, but if others want to eject one or more commits to get it merged faster, that could make sense. ",
      "created_at" : "2019-10-31T17:32:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-548486346",
      "id" : 548486346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0ODQ4NjM0Ng==",
      "updated_at" : "2019-10-31T17:32:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548486346",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341280713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341280713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll just leave this as is so it can get merged sooner :)",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T17:46:14Z",
      "diff_hunk" : "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341280713",
      "id" : 341280713,
      "in_reply_to_id" : 341194391,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI4MDcxMw==",
      "original_commit_id" : "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
      "original_position" : 6,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 26,
      "pull_request_review_id" : 310068608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T17:46:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341280713",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341286026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341286026"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Move SetupGeneration code out of CWallet\" (ef97f0b5451e4959c0d0bf649a71eec9b226210e)\r\n\r\nNo need to change now, but it seems like it'd probably be a good idea to check for an error from SetupGeneration here as well.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T17:56:29Z",
      "diff_hunk" : "@@ -561,11 +566,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         Unlock(strWalletPassphrase);\n \n         // if we are using HD, replace the HD seed with a new one\n-        if (m_spk_man->IsHDEnabled()) {\n-            m_spk_man->SetHDSeed(m_spk_man->GenerateNewSeed());\n+        if (auto spk_man = m_spk_man.get()) {\n+            if (spk_man->IsHDEnabled()) {\n+                spk_man->SetupGeneration(true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341286026",
      "id" : 341286026,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI4NjAyNg==",
      "original_commit_id" : "ef97f0b5451e4959c0d0bf649a71eec9b226210e",
      "original_position" : 26,
      "path" : "src/wallet/wallet.cpp",
      "position" : 43,
      "pull_request_review_id" : 310075600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T17:56:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341286026",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341296610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341296610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm also a bit confused about the distinction between `TopUpKeyPool()` and `Topup()`. In the native descriptor wallet PR there's an internal call to `Topup()` inside `DescriptorScriptPubKeyMan::GetNewDestination` and `DescriptorScriptPubKeyMan::MarkUnusedAddresses`: https://github.com/bitcoin/bitcoin/pull/16528/files#diff-5462ceb8a760a507152ab8b76bd48774R1459",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T18:17:49Z",
      "diff_hunk" : "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341296610",
      "id" : 341296610,
      "in_reply_to_id" : 340307903,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI5NjYxMA==",
      "original_commit_id" : "8c47cb9202e27a86609d7b3af91dee1f09468125",
      "original_position" : 14,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 59,
      "pull_request_review_id" : 310089570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T18:17:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341296610",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341304705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341304705"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In `LegacyScriptPubKeyMan`, `TopUp()` and `TopUpKeyPool()` are the same. Since `TopUpKeyPool` was already being used throughout existing `CWallet` code that was moved into `LegacyScriptPubKeyMan`, I decided to let those calls just keep using `TopUpKeyPool`. But for the `ScriptPubKeyMan` interface itself, I wanted it to be named `TopUp` because that conceptually made more sense than calling it `TopUpKeyPool`.",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T18:35:05Z",
      "diff_hunk" : "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341304705",
      "id" : 341304705,
      "in_reply_to_id" : 340307903,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTMwNDcwNQ==",
      "original_commit_id" : "8c47cb9202e27a86609d7b3af91dee1f09468125",
      "original_position" : 14,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 59,
      "pull_request_review_id" : 310100328,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T18:35:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341304705",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341309043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341309043"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Any reason you would not want to rename TopUpKeyPool method to TopUp and call it everywhere instead of having two LegacyScriptPubKeyMan methods that do the same thing?",
      "commit_id" : "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
      "created_at" : "2019-10-31T18:44:56Z",
      "diff_hunk" : "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341309043",
      "id" : 341309043,
      "in_reply_to_id" : 340307903,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTMwOTA0Mw==",
      "original_commit_id" : "8c47cb9202e27a86609d7b3af91dee1f09468125",
      "original_position" : 14,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 59,
      "pull_request_review_id" : 310106196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
      "updated_at" : "2019-10-31T18:44:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341309043",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
