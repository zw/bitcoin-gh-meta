[
   {
      "body" : "nit typo: \"SocketSendData re**s**urns written size\"",
      "created_at" : "2016-05-23T04:04:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-220883338",
      "id" : 220883338,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-05-23T04:04:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/220883338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r64405836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/64405836"
         }
      },
      "body" : "This won't work. It needs to be a ConnMan-scoped variable, not a CNode-scoped one, as the nonce will come back through another link than the one we sent it through.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-05-24T14:50:32Z",
      "diff_hunk" : "@@ -490,12 +490,17 @@ class CNode\n     CNode(const CNode&);\n     void operator=(const CNode&);\n \n+    uint64_t nLocalHostNonce;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r64405836",
      "id" : 64405836,
      "original_commit_id" : "46cf6754cf6ac7bab76fb61ad9494741de235f6c",
      "original_position" : 20,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/64405836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r64423396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/64423396"
         }
      },
      "body" : "@sipa See https://github.com/bitcoin/bitcoin/pull/8085/commits/46cf6754cf6ac7bab76fb61ad9494741de235f6c#diff-9a82240fe7dfe86564178691cc57f2f1R351.\r\n\r\nI started by simply moving this to CConnman as you suggest, but it's racy and dependent on the optimistic send succeeding (nonce is set in one thread, tested in another). With this change, I believe we now guard against rapid-fire connections that may connect to self, which would have been missed before.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-05-24T16:13:08Z",
      "diff_hunk" : "@@ -490,12 +490,17 @@ class CNode\n     CNode(const CNode&);\n     void operator=(const CNode&);\n \n+    uint64_t nLocalHostNonce;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r64423396",
      "id" : 64423396,
      "original_commit_id" : "46cf6754cf6ac7bab76fb61ad9494741de235f6c",
      "original_position" : 20,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/64423396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r64424128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/64424128"
         }
      },
      "body" : "Nevermind, indeed.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-05-24T16:17:14Z",
      "diff_hunk" : "@@ -490,12 +490,17 @@ class CNode\n     CNode(const CNode&);\n     void operator=(const CNode&);\n \n+    uint64_t nLocalHostNonce;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r64424128",
      "id" : 64424128,
      "original_commit_id" : "46cf6754cf6ac7bab76fb61ad9494741de235f6c",
      "original_position" : 20,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/64424128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "#8082 moves mapRelay from net to main. I think it indeed belongs with node processing code and not in base networking code.",
      "created_at" : "2016-05-24T16:37:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-221330283",
      "id" : 221330283,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-05-24T16:37:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/221330283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Indeed, that's definitely the correct approach and the change here can be dropped.",
      "created_at" : "2016-05-24T16:48:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-221333543",
      "id" : 221333543,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-05-24T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/221333543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@laanwj I pushed a bunch of new commits to address the review you gave me. The commit history doesn't really make sense now, though, as there's a good bit of reverting. Please let me know if you'd like me to squash down to a more logical history for easier review, or continue to pile up changes and squash at the end.",
      "created_at" : "2016-05-26T01:30:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-221754643",
      "id" : 221754643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-05-26T01:30:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/221754643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Rebased to master and squashed down changes so that the history makes sense again.\r\n\r\nThough there's still a good bit left to do, I think this is a good stopping point. I'll avoid making further changes here unless requested.",
      "created_at" : "2016-05-27T05:34:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-222063946",
      "id" : 222063946,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-05-27T05:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/222063946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Rebased to master after #8082, and dropped that commit here. Should be ready for review.",
      "created_at" : "2016-06-06T21:21:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-224092243",
      "id" : 224092243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-06-06T21:21:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/224092243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66666522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66666522"
         }
      },
      "body" : "I don't see g_connman requiring any refcounting, could this be a plain unique_ptr?",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:12:28Z",
      "diff_hunk" : "@@ -69,6 +70,7 @@ static const bool DEFAULT_REST_ENABLE = false;\n static const bool DEFAULT_DISABLE_SAFEMODE = false;\n static const bool DEFAULT_STOPAFTERBLOCKIMPORT = false;\n \n+std::shared_ptr<CConnman> g_connman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66666522",
      "id" : 66666522,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 12,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66666522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66667844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66667844"
         }
      },
      "body" : "This was originally passed around differently, but refactored to essentially be a unique_ptr. So yes :)\r\n\r\nThough it's worth mentioning that the global is only temporary until the rpc/qt interfaces learn how to accept/maintain an instance. So it's probably even more important to not encourage any sharing semantics.\r\n\r\nWill change.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:22:43Z",
      "diff_hunk" : "@@ -69,6 +70,7 @@ static const bool DEFAULT_REST_ENABLE = false;\n static const bool DEFAULT_DISABLE_SAFEMODE = false;\n static const bool DEFAULT_STOPAFTERBLOCKIMPORT = false;\n \n+std::shared_ptr<CConnman> g_connman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66667844",
      "id" : 66667844,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 12,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66667844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66667939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66667939"
         }
      },
      "body" : "Lifetime safety is more robust without the existence of constructed-not-started and stopped-not-destructed twilight states. What do you think about doing the Start/Stop stuff in the ctor/dtor -- would the stuff that AppInit2 currently does between construction and Start make sense to put into the CConnman::Options?",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:23:29Z",
      "diff_hunk" : "@@ -1945,9 +1919,45 @@ void static Discover(boost::thread_group& threadGroup)\n #endif\n }\n \n-void StartNode(boost::thread_group& threadGroup, CScheduler& scheduler)\n+CConnman::CConnman()\n+{\n+    setBannedIsDirty = false;\n+    fAddressesInitialized = false;\n+    nLastNodeId = 0;\n+    nSendBufferMaxSize = 0;\n+    nReceiveFloodSize = 0;\n+    semOutbound = NULL;\n+    nMaxConnections = 0;\n+    nMaxOutbound = 0;\n+    nBestHeight = 0;\n+    clientInterface = NULL;\n+}\n+\n+NodeId CConnman::GetNewNodeId()\n+{\n+    return nLastNodeId.fetch_add(1, std::memory_order_relaxed);\n+}\n+\n+bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options connOptions)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66667939",
      "id" : 66667939,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 689,
      "path" : "src/net.cpp",
      "position" : 723,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66667939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66669196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66669196"
         }
      },
      "body" : "Nit: std::function indirection is fairly heavyweight, templating these would make the functors inlineable.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:34:18Z",
      "diff_hunk" : "@@ -75,24 +80,218 @@ static const size_t DEFAULT_MAXSENDBUFFER    = 1 * 1000;\n // NOTE: When adjusting this, update rpcnet:setban's help (\"24h\")\n static const unsigned int DEFAULT_MISBEHAVING_BANTIME = 60 * 60 * 24;  // Default 24-hour ban\n \n-unsigned int ReceiveFloodSize();\n-unsigned int SendBufferSize();\n+typedef int NodeId;\n+\n+class CNodeStats;\n+class CClientUIInterface;\n+\n+class CConnman\n+{\n+public:\n+\n+    enum NumConnections {\n+        CONNECTIONS_NONE = 0,\n+        CONNECTIONS_IN = (1U << 0),\n+        CONNECTIONS_OUT = (1U << 1),\n+        CONNECTIONS_ALL = (CONNECTIONS_IN | CONNECTIONS_OUT),\n+    };\n+\n+    struct Options\n+    {\n+        uint64_t nLocalServices = 0;\n+        int nMaxConnections = 0;\n+        int nMaxOutbound = 0;\n+        int nBestHeight = 0;\n+        unsigned int nSendBufferMaxSize = 0;\n+        unsigned int nReceiveFloodSize = 0;\n+        CClientUIInterface* interface = nullptr;\n+    };\n+\n+    CConnman();\n+    ~CConnman();\n+    bool Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options options);\n+    void Stop();\n+    bool BindListenPort(const CService &bindAddr, std::string& strError, bool fWhitelisted = false);\n+    bool OpenNetworkConnection(const CAddress& addrConnect, CSemaphoreGrant *grantOutbound = NULL, const char *strDest = NULL, bool fOneShot = false);\n+    bool CheckIncomingNonce(uint64_t nonce);\n+\n+    bool ForEachNode(std::function<bool(CNode* pnode)> func);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66669196",
      "id" : 66669196,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 67,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66669196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66670406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66670406"
         }
      },
      "body" : "Nit: could use a comment documenting connman nullability.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:43:19Z",
      "diff_hunk" : "@@ -2927,7 +2920,7 @@ static void NotifyHeaderTip() {\n  * or an activated best chain. pblock is either NULL or a pointer to a block\n  * that is already loaded (to avoid loading it again from disk).\n  */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66670406",
      "id" : 66670406,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 51,
      "path" : "src/main.cpp",
      "position" : 78,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66670406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66671033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66671033"
         }
      },
      "body" : "There's a newer version of this initialization in master from #8173, the commit is 8884830.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:48:22Z",
      "diff_hunk" : "@@ -4418,17 +4412,60 @@ bool static AlreadyHave(const CInv& inv) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n     return true;\n }\n \n-void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParams)\n+static void RelayTransaction(const CTransaction& tx, CConnman& connman)\n+{\n+    CInv inv(MSG_TX, tx.GetHash());\n+    connman.ForEachNode([&inv](CNode* pnode)\n+    {\n+        pnode->PushInventory(inv);\n+        return true;\n+    });\n+}\n+\n+static void RelayAddress(const CAddress& addr, bool fReachable, CConnman& connman)\n+{\n+    int nRelayNodes = fReachable ? 2 : 1; // limited relaying of addresses outside our network(s)\n+\n+    // Relay to a limited number of other nodes\n+    // Use deterministic randomness to send to the same nodes for 24 hours\n+    // at a time so the addrKnowns of the chosen nodes prevent repeats\n+    static uint64_t salt0 = 0, salt1 = 0;\n+    while (salt0 == 0 && salt1 == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66671033",
      "id" : 66671033,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 119,
      "path" : "src/main.cpp",
      "position" : 152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66671033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66671837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66671837"
         }
      },
      "body" : "The reason for start/stop doesn't really become obvious until the async behavior comes in. As a next step, all of the connecting/resolving behavior will be replaced with async events handled via callbacks. It's necessary to be able to have some basic connman functionality before the event thread spins up (or in case it's never going to). The most straightforward example is that we'll want to stop app startup if all bind()s fail, before spawning any connection threads.\r\n\r\nAs a better example, you can see that none of the tests require that Start() has been called.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:55:06Z",
      "diff_hunk" : "@@ -1945,9 +1919,45 @@ void static Discover(boost::thread_group& threadGroup)\n #endif\n }\n \n-void StartNode(boost::thread_group& threadGroup, CScheduler& scheduler)\n+CConnman::CConnman()\n+{\n+    setBannedIsDirty = false;\n+    fAddressesInitialized = false;\n+    nLastNodeId = 0;\n+    nSendBufferMaxSize = 0;\n+    nReceiveFloodSize = 0;\n+    semOutbound = NULL;\n+    nMaxConnections = 0;\n+    nMaxOutbound = 0;\n+    nBestHeight = 0;\n+    clientInterface = NULL;\n+}\n+\n+NodeId CConnman::GetNewNodeId()\n+{\n+    return nLastNodeId.fetch_add(1, std::memory_order_relaxed);\n+}\n+\n+bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options connOptions)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66671837",
      "id" : 66671837,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 689,
      "path" : "src/net.cpp",
      "position" : 723,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66671837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66672120"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66672120"
         }
      },
      "body" : "Good point.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T19:57:02Z",
      "diff_hunk" : "@@ -75,24 +80,218 @@ static const size_t DEFAULT_MAXSENDBUFFER    = 1 * 1000;\n // NOTE: When adjusting this, update rpcnet:setban's help (\"24h\")\n static const unsigned int DEFAULT_MISBEHAVING_BANTIME = 60 * 60 * 24;  // Default 24-hour ban\n \n-unsigned int ReceiveFloodSize();\n-unsigned int SendBufferSize();\n+typedef int NodeId;\n+\n+class CNodeStats;\n+class CClientUIInterface;\n+\n+class CConnman\n+{\n+public:\n+\n+    enum NumConnections {\n+        CONNECTIONS_NONE = 0,\n+        CONNECTIONS_IN = (1U << 0),\n+        CONNECTIONS_OUT = (1U << 1),\n+        CONNECTIONS_ALL = (CONNECTIONS_IN | CONNECTIONS_OUT),\n+    };\n+\n+    struct Options\n+    {\n+        uint64_t nLocalServices = 0;\n+        int nMaxConnections = 0;\n+        int nMaxOutbound = 0;\n+        int nBestHeight = 0;\n+        unsigned int nSendBufferMaxSize = 0;\n+        unsigned int nReceiveFloodSize = 0;\n+        CClientUIInterface* interface = nullptr;\n+    };\n+\n+    CConnman();\n+    ~CConnman();\n+    bool Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options options);\n+    void Stop();\n+    bool BindListenPort(const CService &bindAddr, std::string& strError, bool fWhitelisted = false);\n+    bool OpenNetworkConnection(const CAddress& addrConnect, CSemaphoreGrant *grantOutbound = NULL, const char *strDest = NULL, bool fOneShot = false);\n+    bool CheckIncomingNonce(uint64_t nonce);\n+\n+    bool ForEachNode(std::function<bool(CNode* pnode)> func);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66672120",
      "id" : 66672120,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 67,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66672120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66672713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66672713"
         }
      },
      "body" : "Agreed, will do. In case it's not clear, the intention is to allow us to avoid skipping the network altogether for utility functions. Beyond the startup stuff where it's currently skipped, in the future it may be interesting to do things like on-the-fly reindexing without having to shut down.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T20:01:40Z",
      "diff_hunk" : "@@ -2927,7 +2920,7 @@ static void NotifyHeaderTip() {\n  * or an activated best chain. pblock is either NULL or a pointer to a block\n  * that is already loaded (to avoid loading it again from disk).\n  */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66672713",
      "id" : 66672713,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 51,
      "path" : "src/main.cpp",
      "position" : 78,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66672713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66672857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66672857"
         }
      },
      "body" : "Thanks, I'll note this for the next rebase round.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T20:02:41Z",
      "diff_hunk" : "@@ -4418,17 +4412,60 @@ bool static AlreadyHave(const CInv& inv) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n     return true;\n }\n \n-void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParams)\n+static void RelayTransaction(const CTransaction& tx, CConnman& connman)\n+{\n+    CInv inv(MSG_TX, tx.GetHash());\n+    connman.ForEachNode([&inv](CNode* pnode)\n+    {\n+        pnode->PushInventory(inv);\n+        return true;\n+    });\n+}\n+\n+static void RelayAddress(const CAddress& addr, bool fReachable, CConnman& connman)\n+{\n+    int nRelayNodes = fReachable ? 2 : 1; // limited relaying of addresses outside our network(s)\n+\n+    // Relay to a limited number of other nodes\n+    // Use deterministic randomness to send to the same nodes for 24 hours\n+    // at a time so the addrKnowns of the chosen nodes prevent repeats\n+    static uint64_t salt0 = 0, salt1 = 0;\n+    while (salt0 == 0 && salt1 == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66672857",
      "id" : 66672857,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 119,
      "path" : "src/main.cpp",
      "position" : 152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66672857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66676159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66676159"
         }
      },
      "body" : "I'd be more comfortable with a builder doing those binds or something -- it just seems like it would be easy for a future change to introduce an unchecked dependency on the CConnman state, that could make for subtle and unpredictable bugs. But this is a complex change you're certainly more familiar with than I, so ACK however you decide to ensure safety against that kind of case.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T20:28:56Z",
      "diff_hunk" : "@@ -1945,9 +1919,45 @@ void static Discover(boost::thread_group& threadGroup)\n #endif\n }\n \n-void StartNode(boost::thread_group& threadGroup, CScheduler& scheduler)\n+CConnman::CConnman()\n+{\n+    setBannedIsDirty = false;\n+    fAddressesInitialized = false;\n+    nLastNodeId = 0;\n+    nSendBufferMaxSize = 0;\n+    nReceiveFloodSize = 0;\n+    semOutbound = NULL;\n+    nMaxConnections = 0;\n+    nMaxOutbound = 0;\n+    nBestHeight = 0;\n+    clientInterface = NULL;\n+}\n+\n+NodeId CConnman::GetNewNodeId()\n+{\n+    return nLastNodeId.fetch_add(1, std::memory_order_relaxed);\n+}\n+\n+bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options connOptions)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66676159",
      "id" : 66676159,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 689,
      "path" : "src/net.cpp",
      "position" : 723,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66676159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66677551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66677551"
         }
      },
      "body" : "Roger. I see your point and agree, I'm just trying to avoid overthinking this until the async stuff is added. Once it's all hooked up, maybe we can switch to a model where Start() returns some kind of object that guarantees a certain state that CConnman does not.\r\n\r\nThe alternative would be to move out things that don't require a running state (addrman/bandb as examples) and let them have separate life-cycles, but I'd like to do that as a next step once all callers understand that those things aren't global.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-10T20:39:01Z",
      "diff_hunk" : "@@ -1945,9 +1919,45 @@ void static Discover(boost::thread_group& threadGroup)\n #endif\n }\n \n-void StartNode(boost::thread_group& threadGroup, CScheduler& scheduler)\n+CConnman::CConnman()\n+{\n+    setBannedIsDirty = false;\n+    fAddressesInitialized = false;\n+    nLastNodeId = 0;\n+    nSendBufferMaxSize = 0;\n+    nReceiveFloodSize = 0;\n+    semOutbound = NULL;\n+    nMaxConnections = 0;\n+    nMaxOutbound = 0;\n+    nBestHeight = 0;\n+    clientInterface = NULL;\n+}\n+\n+NodeId CConnman::GetNewNodeId()\n+{\n+    return nLastNodeId.fetch_add(1, std::memory_order_relaxed);\n+}\n+\n+bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options connOptions)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r66677551",
      "id" : 66677551,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 689,
      "path" : "src/net.cpp",
      "position" : 723,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/66677551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "utACK the src/\\*.\\* changes at f86d0be (with minor notes in comments) [didn't review the subdirectory stuff thoroughly; I'm less familiar with that code]",
      "created_at" : "2016-06-10T20:42:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-225290282",
      "id" : 225290282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-06-10T21:39:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225290282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "body" : "@kazcw Thanks for the excellent review! I'll pick this back up in ~2 weeks. Obviously if that's going to stall progress on lock refactors too much, go ahead with them and I'll cope with it here.",
      "created_at" : "2016-06-10T21:14:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-225297383",
      "id" : 225297383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-06-10T21:14:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225297383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67036736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67036736"
         }
      },
      "body" : "nit: unclear why interface is in options when it doesn't really seem to be an option. Perhaps having a struct Context to hold state such as interface, scheduler, and threadgroup would be a better encapsulation.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-14T19:10:53Z",
      "diff_hunk" : "@@ -96,9 +96,18 @@ class CConnman\n         CONNECTIONS_ALL = (CONNECTIONS_IN | CONNECTIONS_OUT),\n     };\n \n+    struct Options\n+    {\n+        uint64_t nLocalServices = 0;\n+        int nMaxConnections = 0;\n+        int nMaxOutbound = 0;\n+        int nBestHeight = 0;\n+        CClientUIInterface* interface = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67036736",
      "id" : 67036736,
      "original_commit_id" : "5b81b0aef597ebbb5e6859281c5cf217f841d287",
      "original_position" : 10,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67036736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67046665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67046665"
         }
      },
      "body" : "note: This section is a bit more than just a code move, but it seems to have no functional change.\r\n(the couple lines around this section)",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-14T20:10:07Z",
      "diff_hunk" : "@@ -303,23 +295,21 @@ UniValue getaddednodeinfo(const UniValue& params, bool fHelp)\n             + HelpExampleRpc(\"getaddednodeinfo\", \"true, \\\"192.168.0.201\\\"\")\n         );\n \n+    if(!g_connman)\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+\n     bool fDns = params[0].get_bool();\n \n     list<string> laddedNodes(0);\n-    if (params.size() == 1)\n-    {\n-        LOCK(cs_vAddedNodes);\n-        BOOST_FOREACH(const std::string& strAddNode, vAddedNodes)\n-            laddedNodes.push_back(strAddNode);\n-    }\n-    else\n+    g_connman->GetAddedNodes(laddedNodes);\n+\n+    if (params.size() > 1)\n     {\n         string strNode = params[1].get_str();\n-        LOCK(cs_vAddedNodes);\n-        BOOST_FOREACH(const std::string& strAddNode, vAddedNodes) {\n+        BOOST_FOREACH(const std::string& strAddNode, laddedNodes) {\n             if (strAddNode == strNode)\n             {\n-                laddedNodes.push_back(strAddNode);\n+                laddedNodes.assign(1, strAddNode);\n                 break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67046665",
      "id" : 67046665,
      "original_commit_id" : "9def7c0bb08c2ff956e54a0b0693aff63e8d615c",
      "original_position" : 55,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67046665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67075817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67075817"
         }
      },
      "body" : "Nit: I would rename `ForEachNode` as `ForEachNodeContinueIf` or something to signify that the return value being true is critical. I would then make a version of `ForEachNode` that does not check for the return value.\r\n\r\n- This is more consistent* with other \"foreach\" API's generally, eg, boost foreach or javascript foreach iterate over all elements\r\n * although boost foreach does allow break\r\n- It is unclear if `ForEachNodeContinueIf` is/will be used anywhere in the codebase, but it could introduce bugs (say, if false is somehow returned by buggy code elsewhere or later), so it's probably better to not have a check that is never used.\r\n",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-14T23:21:20Z",
      "diff_hunk" : "@@ -2531,6 +2521,50 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+bool CConnman::ForEachNode(std::function<bool(CNode* pnode)> func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67075817",
      "id" : 67075817,
      "original_commit_id" : "a01fa6c5a2e5884af64c0153dbfbd6a848128129",
      "original_position" : 75,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67075817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67076355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67076355"
         }
      },
      "body" : "Nit: appears correct, but isn't this the same code as in RelayTransaction?",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-14T23:26:42Z",
      "diff_hunk" : "@@ -1342,8 +1342,15 @@ bool CWalletTx::RelayWalletTransaction(CConnman* connman)\n     {\n         if (GetDepthInMainChain() == 0 && !isAbandoned() && InMempool()) {\n             LogPrintf(\"Relaying wtx %s\\n\", GetHash().ToString());\n-            RelayTransaction((CTransaction)*this);\n-            return true;\n+            if (connman) {\n+                CInv inv(MSG_TX, GetHash());\n+                connman->ForEachNode([&inv](CNode* pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67076355",
      "id" : 67076355,
      "original_commit_id" : "a01fa6c5a2e5884af64c0153dbfbd6a848128129",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67076355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67085848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67085848"
         }
      },
      "body" : "Ack. I meant to document these, but self-doc would be better.\n\nThe intention is to use these internally later, for example to replace the\nFindNode's which iterate and early-return when possible, to avoid holding\nthe lock longer than necessary.\n\nBut since those changes aren't part of this pull, I think that simply\ndropping the bool return and reintroducing it as ForEachNodeContinueIf\nlater is the way to go.\n",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T01:17:37Z",
      "diff_hunk" : "@@ -2531,6 +2521,50 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+bool CConnman::ForEachNode(std::function<bool(CNode* pnode)> func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67085848",
      "id" : 67085848,
      "original_commit_id" : "a01fa6c5a2e5884af64c0153dbfbd6a848128129",
      "original_position" : 75,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67085848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67086047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67086047"
         }
      },
      "body" : "Yes, but it's simple enough that I didn't bother factoring it out. No\nreason not to, except that there's not an obvious place to stick it.\nOn Jun 14, 2016 19:26, \"Jeremy Rubin\" <notifications@github.com> wrote:\n\n> In src/wallet/wallet.cpp\n> <https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67076355>:\n>\n> > @@ -1342,8 +1342,15 @@ bool CWalletTx::RelayWalletTransaction(CConnman* connman)\n> >      {\n> >          if (GetDepthInMainChain() == 0 && !isAbandoned() && InMempool()) {\n> >              LogPrintf(\"Relaying wtx %s\\n\", GetHash().ToString());\n> > -            RelayTransaction((CTransaction)*this);\n> > -            return true;\n> > +            if (connman) {\n> > +                CInv inv(MSG_TX, GetHash());\n> > +                connman->ForEachNode([&inv](CNode* pnode)\n>\n> Nit: appears correct, but isn't this the same code as in RelayTransaction?\n>\n> \n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/8085/files/a57b3f21e3228f838382e7510dc4e8f2bd023237..a01fa6c5a2e5884af64c0153dbfbd6a848128129#r67076355>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe/AAZdE-sEqwxHrvI3wdUKtoHlUCgD1RM2ks5qLzi2gaJpZM4Ij8mn>\n> .\n>\n",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T01:20:16Z",
      "diff_hunk" : "@@ -1342,8 +1342,15 @@ bool CWalletTx::RelayWalletTransaction(CConnman* connman)\n     {\n         if (GetDepthInMainChain() == 0 && !isAbandoned() && InMempool()) {\n             LogPrintf(\"Relaying wtx %s\\n\", GetHash().ToString());\n-            RelayTransaction((CTransaction)*this);\n-            return true;\n+            if (connman) {\n+                CInv inv(MSG_TX, GetHash());\n+                connman->ForEachNode([&inv](CNode* pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67086047",
      "id" : 67086047,
      "original_commit_id" : "a01fa6c5a2e5884af64c0153dbfbd6a848128129",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67086047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67086457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67086457"
         }
      },
      "body" : "This will eventually hold pointers to several structures, chainparams for\nexample.\n\nIt may be reasonable to split it into a set of truly immutable options, and\nstateful app pointers.\n",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T01:25:47Z",
      "diff_hunk" : "@@ -96,9 +96,18 @@ class CConnman\n         CONNECTIONS_ALL = (CONNECTIONS_IN | CONNECTIONS_OUT),\n     };\n \n+    struct Options\n+    {\n+        uint64_t nLocalServices = 0;\n+        int nMaxConnections = 0;\n+        int nMaxOutbound = 0;\n+        int nBestHeight = 0;\n+        CClientUIInterface* interface = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67086457",
      "id" : 67086457,
      "original_commit_id" : "5b81b0aef597ebbb5e6859281c5cf217f841d287",
      "original_position" : 10,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67086457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67177507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67177507"
         }
      },
      "body" : "I'm not sure this actually presents a bug, but it might at least exhibit some undesired behavior.\r\n\r\nThis should replace the value only if it is greater than the previous value, unless it is desirable to roll back (but this seems like a different case?).\r\n\r\n\r\n~~This may also not play well with out of order headers.~~ (ignore, headers aren't processed here/should be in order)\r\n\r\nIn any case, I'm not sure this is a consensus critical thing, but it could be the source of future bugs or further identity leaks.\r\n\r\nThis (might) also be fixed by moving the call to SetBestHeight inside of `Lock(cs_main)` in `ActivateBestChain`. Would also be reasonable to just document (or self-doc) it a bit better about what you are expecting this to do.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T14:54:37Z",
      "diff_hunk" : "@@ -2337,6 +2338,16 @@ uint64_t CConnman::GetLocalServices() const\n     return nLocalServices;\n }\n \n+void CConnman::SetBestHeight(int height)\n+{\n+    nBestHeight.store(height, std::memory_order_release);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67177507",
      "id" : 67177507,
      "original_commit_id" : "148163c9b1ce04ec9fa9c8ff9a4289520bd92127",
      "original_position" : 89,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67177507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67179071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67179071"
         }
      },
      "body" : "may want to null check...",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T15:02:05Z",
      "diff_hunk" : "@@ -1976,7 +1982,7 @@ bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, ui\n         }\n     }\n \n-    uiInterface.InitMessage(_(\"Loading banlist...\"));\n+    clientInterface->InitMessage(_(\"Loading banlist...\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67179071",
      "id" : 67179071,
      "original_commit_id" : "cb9c81ee780ca153e471cf275a815e507c94dec6",
      "original_position" : 81,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67179071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67179115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67179115"
         }
      },
      "body" : "may want to null check...",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T15:02:15Z",
      "diff_hunk" : "@@ -1962,7 +1967,8 @@ bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, ui\n \n     SetBestHeight(nBestHeightIn);\n \n-    uiInterface.InitMessage(_(\"Loading addresses...\"));\n+    clientInterface = interfaceIn;\n+    clientInterface->InitMessage(_(\"Loading addresses...\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67179115",
      "id" : 67179115,
      "original_commit_id" : "cb9c81ee780ca153e471cf275a815e507c94dec6",
      "original_position" : 72,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67179115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67180772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67180772"
         }
      },
      "body" : "nit: I think I would separate out the GetBoolArg put it into Options.\r\n\r\nThen keep the calls to MapPort into Start/Stop.\r\n\r\nseems a little more pragmatic & good for debugging (e.g., can dump a nodes options and know how the node was configured)",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T15:10:26Z",
      "diff_hunk" : "@@ -1423,9 +1424,14 @@ bool AppInit2(boost::thread_group& threadGroup, CScheduler& scheduler)\n     if (GetBoolArg(\"-listenonion\", DEFAULT_LISTEN_ONION))\n         StartTorControl(threadGroup, scheduler);\n \n+    Discover(threadGroup);\n+\n+    // Map ports with UPnP\n+    MapPort(GetBoolArg(\"-upnp\", DEFAULT_UPNP));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67180772",
      "id" : 67180772,
      "original_commit_id" : "2258f0730ee9034f951a217d4e645125cbe98a89",
      "original_position" : 17,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67180772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "utack, other than the atomic::store problem I marked this refactor seems safe.",
      "created_at" : "2016-06-15T15:11:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-226218468",
      "id" : 226218468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-06-15T15:11:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/226218468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67233085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67233085"
         }
      },
      "body" : "ChainParams seems like it could qualify as an option. In the long term I think it would make more sense for the UI to connect to the various backend signals rather than the net layer having any knowledge of the UI, but that change seems outside the scope of this PR.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T19:51:27Z",
      "diff_hunk" : "@@ -96,9 +96,18 @@ class CConnman\n         CONNECTIONS_ALL = (CONNECTIONS_IN | CONNECTIONS_OUT),\n     };\n \n+    struct Options\n+    {\n+        uint64_t nLocalServices = 0;\n+        int nMaxConnections = 0;\n+        int nMaxOutbound = 0;\n+        int nBestHeight = 0;\n+        CClientUIInterface* interface = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67233085",
      "id" : 67233085,
      "original_commit_id" : "5b81b0aef597ebbb5e6859281c5cf217f841d287",
      "original_position" : 10,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67233085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67258821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67258821"
         }
      },
      "body" : "I'll take care of it...",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-15T22:37:14Z",
      "diff_hunk" : "@@ -2531,6 +2521,50 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+bool CConnman::ForEachNode(std::function<bool(CNode* pnode)> func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67258821",
      "id" : 67258821,
      "original_commit_id" : "a01fa6c5a2e5884af64c0153dbfbd6a848128129",
      "original_position" : 75,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67258821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67349082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67349082"
         }
      },
      "body" : "nit: perhaps just add 0 if !g_connman or some relevant message",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-16T14:00:41Z",
      "diff_hunk" : "@@ -89,7 +89,8 @@ UniValue getinfo(const UniValue& params, bool fHelp)\n #endif\n     obj.push_back(Pair(\"blocks\",        (int)chainActive.Height()));\n     obj.push_back(Pair(\"timeoffset\",    GetTimeOffset()));\n-    obj.push_back(Pair(\"connections\",   (int)vNodes.size()));\n+    if(g_connman)\n+        obj.push_back(Pair(\"connections\",   (int)g_connman->GetNodeCount(CConnman::CONNECTIONS_ALL)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67349082",
      "id" : 67349082,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 6,
      "path" : "src/rpc/misc.cpp",
      "position" : 6,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67349082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67352999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67352999"
         }
      },
      "body" : "nit: I think this could use documentation that the setter requires cs_main to be held to prevent older values from overwriting newer values. Also, I don't see any other data that would need to be synchronized with the height via acquire/release semantics; if there are no writes before the release that need to be visible side-effects after the acquire, relaxed load/store would be clearer.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-16T14:21:32Z",
      "diff_hunk" : "@@ -2185,18 +2305,33 @@ uint64_t CNode::GetOutboundTargetBytesLeft()\n     return (nMaxOutboundTotalBytesSentInCycle >= nMaxOutboundLimit) ? 0 : nMaxOutboundLimit - nMaxOutboundTotalBytesSentInCycle;\n }\n \n-uint64_t CNode::GetTotalBytesRecv()\n+uint64_t CConnman::GetTotalBytesRecv()\n {\n     LOCK(cs_totalBytesRecv);\n     return nTotalBytesRecv;\n }\n \n-uint64_t CNode::GetTotalBytesSent()\n+uint64_t CConnman::GetTotalBytesSent()\n {\n     LOCK(cs_totalBytesSent);\n     return nTotalBytesSent;\n }\n \n+uint64_t CConnman::GetLocalServices() const\n+{\n+    return nLocalServices;\n+}\n+\n+void CConnman::SetBestHeight(int height)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67352999",
      "id" : 67352999,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 1103,
      "path" : "src/net.cpp",
      "position" : 1158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67352999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67358096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67358096"
         }
      },
      "body" : "@kazcw see https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67177507.\r\n\r\nI don't even think holding cs_main would help unless the new height is also checked to be > than the old one (suppose an orphaned block gets relayed, this would decrease the height).",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-16T14:45:28Z",
      "diff_hunk" : "@@ -2185,18 +2305,33 @@ uint64_t CNode::GetOutboundTargetBytesLeft()\n     return (nMaxOutboundTotalBytesSentInCycle >= nMaxOutboundLimit) ? 0 : nMaxOutboundLimit - nMaxOutboundTotalBytesSentInCycle;\n }\n \n-uint64_t CNode::GetTotalBytesRecv()\n+uint64_t CConnman::GetTotalBytesRecv()\n {\n     LOCK(cs_totalBytesRecv);\n     return nTotalBytesRecv;\n }\n \n-uint64_t CNode::GetTotalBytesSent()\n+uint64_t CConnman::GetTotalBytesSent()\n {\n     LOCK(cs_totalBytesSent);\n     return nTotalBytesSent;\n }\n \n+uint64_t CConnman::GetLocalServices() const\n+{\n+    return nLocalServices;\n+}\n+\n+void CConnman::SetBestHeight(int height)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67358096",
      "id" : 67358096,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 1103,
      "path" : "src/net.cpp",
      "position" : 1158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67358096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67374422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67374422"
         }
      },
      "body" : "Oh, I see... that issue is not introduced by this PR; what's called GetHeight in main and is not treated as non-decreasing is used in net as a \"best height\". Ensuring modification order for nBestHeight matches the order established by cs_main would be sufficient to maintain the current behaviour.\r\n\r\nIt does seem like it would be better to have a high-water-mark variable protected by cs_main that main code could use to signal when a new *best* height was reached. I don't see the need for that change necessarily to be included in this PR though.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-16T16:09:24Z",
      "diff_hunk" : "@@ -2185,18 +2305,33 @@ uint64_t CNode::GetOutboundTargetBytesLeft()\n     return (nMaxOutboundTotalBytesSentInCycle >= nMaxOutboundLimit) ? 0 : nMaxOutboundLimit - nMaxOutboundTotalBytesSentInCycle;\n }\n \n-uint64_t CNode::GetTotalBytesRecv()\n+uint64_t CConnman::GetTotalBytesRecv()\n {\n     LOCK(cs_totalBytesRecv);\n     return nTotalBytesRecv;\n }\n \n-uint64_t CNode::GetTotalBytesSent()\n+uint64_t CConnman::GetTotalBytesSent()\n {\n     LOCK(cs_totalBytesSent);\n     return nTotalBytesSent;\n }\n \n+uint64_t CConnman::GetLocalServices() const\n+{\n+    return nLocalServices;\n+}\n+\n+void CConnman::SetBestHeight(int height)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67374422",
      "id" : 67374422,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 1103,
      "path" : "src/net.cpp",
      "position" : 1158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67374422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67414899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67414899"
         }
      },
      "body" : "I would agree that this PR doesn't need any behavior change. Perhaps just renaming BestHeight -> LastSeenHeight or something. Also a proper best height is semantically unclear -- is it MaxHeight or MaxWorkHeight\r\n",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-16T20:07:37Z",
      "diff_hunk" : "@@ -2185,18 +2305,33 @@ uint64_t CNode::GetOutboundTargetBytesLeft()\n     return (nMaxOutboundTotalBytesSentInCycle >= nMaxOutboundLimit) ? 0 : nMaxOutboundLimit - nMaxOutboundTotalBytesSentInCycle;\n }\n \n-uint64_t CNode::GetTotalBytesRecv()\n+uint64_t CConnman::GetTotalBytesRecv()\n {\n     LOCK(cs_totalBytesRecv);\n     return nTotalBytesRecv;\n }\n \n-uint64_t CNode::GetTotalBytesSent()\n+uint64_t CConnman::GetTotalBytesSent()\n {\n     LOCK(cs_totalBytesSent);\n     return nTotalBytesSent;\n }\n \n+uint64_t CConnman::GetLocalServices() const\n+{\n+    return nLocalServices;\n+}\n+\n+void CConnman::SetBestHeight(int height)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r67414899",
      "id" : 67414899,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 1103,
      "path" : "src/net.cpp",
      "position" : 1158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/67414899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r68712667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/68712667"
         }
      },
      "body" : "Yes, I plan to move the remaining args into Options as a next step. There are a handful left to go still.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-28T07:58:40Z",
      "diff_hunk" : "@@ -1423,9 +1424,14 @@ bool AppInit2(boost::thread_group& threadGroup, CScheduler& scheduler)\n     if (GetBoolArg(\"-listenonion\", DEFAULT_LISTEN_ONION))\n         StartTorControl(threadGroup, scheduler);\n \n+    Discover(threadGroup);\n+\n+    // Map ports with UPnP\n+    MapPort(GetBoolArg(\"-upnp\", DEFAULT_UPNP));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r68712667",
      "id" : 68712667,
      "original_commit_id" : "2258f0730ee9034f951a217d4e645125cbe98a89",
      "original_position" : 17,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/68712667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r68712690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/68712690"
         }
      },
      "body" : "Yep, thanks.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-28T07:58:51Z",
      "diff_hunk" : "@@ -1962,7 +1967,8 @@ bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, ui\n \n     SetBestHeight(nBestHeightIn);\n \n-    uiInterface.InitMessage(_(\"Loading addresses...\"));\n+    clientInterface = interfaceIn;\n+    clientInterface->InitMessage(_(\"Loading addresses...\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r68712690",
      "id" : 68712690,
      "original_commit_id" : "cb9c81ee780ca153e471cf275a815e507c94dec6",
      "original_position" : 72,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/68712690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r68718012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/68718012"
         }
      },
      "body" : "Yea, I don't believe this deviates from the current behavior much, other than slightly obfuscating the exact current known height, since the value is grabbed at connection time now rather than during the handshake.\r\n\r\nThough there's the advantage of using the accurate cached value based on a push event, rather than requiring a lock-and-pull as before. I don't think there's any need to try to replicate that old behavior here.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-06-28T08:37:48Z",
      "diff_hunk" : "@@ -2185,18 +2305,33 @@ uint64_t CNode::GetOutboundTargetBytesLeft()\n     return (nMaxOutboundTotalBytesSentInCycle >= nMaxOutboundLimit) ? 0 : nMaxOutboundLimit - nMaxOutboundTotalBytesSentInCycle;\n }\n \n-uint64_t CNode::GetTotalBytesRecv()\n+uint64_t CConnman::GetTotalBytesRecv()\n {\n     LOCK(cs_totalBytesRecv);\n     return nTotalBytesRecv;\n }\n \n-uint64_t CNode::GetTotalBytesSent()\n+uint64_t CConnman::GetTotalBytesSent()\n {\n     LOCK(cs_totalBytesSent);\n     return nTotalBytesSent;\n }\n \n+uint64_t CConnman::GetLocalServices() const\n+{\n+    return nLocalServices;\n+}\n+\n+void CConnman::SetBestHeight(int height)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r68718012",
      "id" : 68718012,
      "original_commit_id" : "f86d0bebcba7102d68563b96b19fc1c0caa8d58f",
      "original_position" : 1103,
      "path" : "src/net.cpp",
      "position" : 1158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-01T00:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/68718012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Addressed most (all?) of the comments here, and added some commits.\r\n\r\nFor future comparison, the current tip is https://github.com/theuni/bitcoin/commit/f96d164f83239e74288ea6a707228be9a4f3ae27. I'll now work on rebasing to master.",
      "created_at" : "2016-06-28T08:48:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-228989553",
      "id" : 228989553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-06-28T08:48:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/228989553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "needs rebase.",
      "created_at" : "2016-08-24T20:23:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-242195853",
      "id" : 242195853,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-08-24T20:23:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242195853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "Yes, needs rebase, should be merged not very long after that IMO\r\n",
      "created_at" : "2016-08-25T06:50:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-242296120",
      "id" : 242296120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-08-25T06:50:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242296120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I have this rebased locally, I've been pulling out more controversial chunks for individual PR. Would you prefer to just do it all in one go here?",
      "created_at" : "2016-08-30T17:44:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-243520576",
      "id" : 243520576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-08-30T17:44:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/243520576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@theuni all in one go please. ",
      "created_at" : "2016-08-30T17:44:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-243520853",
      "id" : 243520853,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-08-30T17:44:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/243520853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "ok, will push up a rebased version tomorrow.",
      "created_at" : "2016-08-31T03:26:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-243648138",
      "id" : 243648138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-08-31T03:26:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/243648138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Rebased. This has been rebased through lots of changes, though I believe the newer stuff is accounted for.\r\n\r\nI'd recommend taking a look at the final CConnman first to get an idea of how it looks, then each individual commit should make more sense.\r\n\r\n@jonasschnelli 1cf69d418576a0096f8f3e83494a107774dde2ed is included as we discussed, so that kicking can be done in a more straightforward way, but it's also just nice to have in the gui.\r\n\r\nBecause this is such a monster, at this point I'd prefer to add fixes on top rather than rebasing to include them.",
      "created_at" : "2016-08-31T18:24:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-243855266",
      "id" : 243855266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-08-31T18:24:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/243855266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "~~Started IBDing a node with this PR (`-listen=0`, connected to a in-sync mainnet node on the same system). Its built with `--enable-debug` and IBDs with `-debug=net`, `-prune=550` and `-dbcache=4000`.~~\r\n\r\n~~Reached progress `progress=0.097296` after 4h where I normally do a full IBD (with `--enable-debug`)  under 4h on the same machine.~~\r\n\r\n~~Either the `-debug=net` is causing the slow down or something regarding this PR.\r\nI can try to run more authentic benchmarks though (direct compare master against this PR on a \"quite\" machine).~~",
      "created_at" : "2016-09-01T13:23:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-244077083",
      "id" : 244077083,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-09-08T07:21:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244077083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "@jonasschnelli Thanks for having a look. I'll try to reproduce.",
      "created_at" : "2016-09-02T02:16:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-244265995",
      "id" : 244265995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-09-02T02:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244265995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "> Either the -debug=net is causing the slow down \r\n\r\nHah, I wouldn't be surprised. Thanks for testing.\r\n\r\nIs this performance regression serious enough to block this, or shouldit be solved later? This is a large change, which has had a lot of review by now, and it again needs rebase...\r\n",
      "created_at" : "2016-09-08T07:19:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-245514444",
      "id" : 245514444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-09-08T07:21:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245514444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Sorry this was my fault in doing benchmark in conjunctions with `--enable-debug`",
      "created_at" : "2016-09-08T07:21:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-245514822",
      "id" : 245514822,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-09-08T07:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245514822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> Sorry this was my fault in doing benchmark in conjunctions with --enable-debug\r\n\r\nOk, good to know",
      "created_at" : "2016-09-08T07:34:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-245517235",
      "id" : 245517235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-09-08T07:34:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245517235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77985078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77985078"
         }
      },
      "body" : "Just a tip, and not a suggestion to change in this PR right now, you can just say 'struct ListenSocket;' here, and fully define it in the cpp file as 'struct CConnman::ListenSocket { ... };', since I don't think any of the users of this class need the fully materialized definition.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T10:56:57Z",
      "diff_hunk" : "@@ -95,28 +95,32 @@ CNode* FindNode(const CService& ip);\n CNode* FindNode(const NodeId id); //TODO: Remove this\n bool OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound = NULL, const char *strDest = NULL, bool fOneShot = false, bool fFeeler = false);\n \n-struct ListenSocket {\n-    SOCKET socket;\n-    bool whitelisted;\n-\n-    ListenSocket(SOCKET socket, bool whitelisted) : socket(socket), whitelisted(whitelisted) {}\n-};\n-\n class CConnman\n {\n public:\n     CConnman();\n     ~CConnman();\n     bool Start(boost::thread_group& threadGroup, std::string& strNodeError);\n     void Stop();\n+    bool BindListenPort(const CService &bindAddr, std::string& strError, bool fWhitelisted = false);\n+\n private:\n+    struct ListenSocket {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77985078",
      "id" : 77985078,
      "original_commit_id" : "d4fce84b9a87b2877fb0a9fa47bf5870a005657a",
      "original_position" : 21,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T10:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77985078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77985660"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77985660"
         }
      },
      "body" : "I am *so* happy to see these globals-disguised-as-static-fields disappear!",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T11:01:44Z",
      "diff_hunk" : "@@ -347,12 +393,6 @@ class CNode\n     const uint64_t nKeyedNetGroup;\n protected:\n \n-    // Denial-of-service detection/prevention\n-    // Key is IP address, value is banned-until-time\n-    static banmap_t setBanned;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77985660",
      "id" : 77985660,
      "original_commit_id" : "ac198b7dc479d32862cee9c2ae9b88e88f084142",
      "original_position" : 99,
      "path" : "src/net.h",
      "position" : 487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T11:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77985660",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77986785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77986785"
         }
      },
      "body" : "Style nit: space after if.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T11:11:31Z",
      "diff_hunk" : "@@ -489,6 +489,8 @@ UniValue setban(const UniValue& params, bool fHelp)\n                             + HelpExampleCli(\"setban\", \"\\\"192.168.0.0/24\\\" \\\"add\\\"\")\n                             + HelpExampleRpc(\"setban\", \"\\\"192.168.0.6\\\", \\\"add\\\", 86400\")\n                             );\n+    if(!g_connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77986785",
      "id" : 77986785,
      "original_commit_id" : "ac198b7dc479d32862cee9c2ae9b88e88f084142",
      "original_position" : 4,
      "path" : "src/rpc/net.cpp",
      "position" : 185,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T11:11:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77986785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77992333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77992333"
         }
      },
      "body" : "Not being very familiar with c++11 lambdas yet, what is the reason for explicitly listing the captures, rather than using [=] ?",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T12:01:29Z",
      "diff_hunk" : "@@ -484,11 +484,12 @@ void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pf\n         if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n             // As per BIP152, we only get 3 of our peers to announce\n             // blocks using compact encodings.\n-            CNode* pnodeStop = FindNode(lNodesAnnouncingHeaderAndIDs.front());\n-            if (pnodeStop) {\n+            bool found = connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77992333",
      "id" : 77992333,
      "original_commit_id" : "55af13c9fa598e33630723d1d7aef4df7ee033f7",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : 49,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T12:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77992333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77994574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77994574"
         }
      },
      "body" : "A universal reference rvalue seems unnecessary here, since they're just pointers you can copy.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T12:20:02Z",
      "diff_hunk" : "@@ -2671,6 +2659,63 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)\n+{\n+    CNode* found = nullptr;\n+    LOCK(cs_vNodes);\n+    for (auto&& pnode : vNodes) {\n+        if(pnode->id == id) {\n+            found = pnode;\n+            break;\n+        }\n+    }\n+    return found != nullptr && func(found);\n+}\n+\n+bool CConnman::ForEachNode(std::function<bool(CNode* pnode)> func)\n+{\n+    LOCK(cs_vNodes);\n+    for (auto&& node : vNodes)\n+        if(!func(node))\n+            return false;\n+    return true;\n+}\n+\n+bool CConnman::ForEachNode(std::function<bool(const CNode* pnode)> func) const\n+{\n+    LOCK(cs_vNodes);\n+    for (const auto& node : vNodes)\n+        if(!func(node))\n+            return false;\n+    return true;\n+}\n+\n+bool CConnman::ForEachNodeThen(std::function<bool(CNode* pnode)> pre, std::function<void()> post)\n+{\n+    bool ret = true;\n+    LOCK(cs_vNodes);\n+    for (auto&& node : vNodes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77994574",
      "id" : 77994574,
      "original_commit_id" : "55af13c9fa598e33630723d1d7aef4df7ee033f7",
      "original_position" : 128,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T12:20:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77994574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77995773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77995773"
         }
      },
      "body" : "Neat.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T12:29:26Z",
      "diff_hunk" : "@@ -2041,9 +2039,13 @@ bool StartNode(CConnman& connman, boost::thread_group& threadGroup, CScheduler&\n     return ret;\n }\n \n-bool CConnman::Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError)\n+NodeId CConnman::GetNewNodeId()\n {\n+    return nLastNodeId.fetch_add(1, std::memory_order_relaxed);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r77995773",
      "id" : 77995773,
      "original_commit_id" : "f1bd45d11ed47084a516964d16b08c991ee97831",
      "original_position" : 43,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T12:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/77995773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78002025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78002025"
         }
      },
      "body" : "I don't think this matters much.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:11:44Z",
      "diff_hunk" : "@@ -2337,6 +2338,16 @@ uint64_t CConnman::GetLocalServices() const\n     return nLocalServices;\n }\n \n+void CConnman::SetBestHeight(int height)\n+{\n+    nBestHeight.store(height, std::memory_order_release);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78002025",
      "id" : 78002025,
      "original_commit_id" : "148163c9b1ce04ec9fa9c8ff9a4289520bd92127",
      "original_position" : 89,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:11:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78002025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78002897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78002897"
         }
      },
      "body" : "rvalue reference for options?\r\n\r\nEDIT: nevermind, all of the fields are primitives.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:17:20Z",
      "diff_hunk" : "@@ -109,9 +109,18 @@ class CConnman\n         CONNECTIONS_ALL = (CONNECTIONS_IN | CONNECTIONS_OUT),\n     };\n \n+    struct Options\n+    {\n+        ServiceFlags nLocalServices = NODE_NONE;\n+        ServiceFlags nRelevantServices = NODE_NONE;\n+        int nMaxConnections = 0;\n+        int nMaxOutbound = 0;\n+        int nBestHeight = 0;\n+        CClientUIInterface* interface = nullptr;\n+    };\n     CConnman();\n     ~CConnman();\n-    bool Start(boost::thread_group& threadGroup, CScheduler& scheduler, ServiceFlags nLocalServicesIn, ServiceFlags nRelevantServicesIn, int nMaxConnectionsIn, int nMaxOutboundIn, int nBestHeightIn, CClientUIInterface* interfaceIn, std::string& strNodeError);\n+    bool Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options options);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78002897",
      "id" : 78002897,
      "original_commit_id" : "9f6a3ea5e2842f0b123db79dfb238a6f7fe2688c",
      "original_position" : 16,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:33:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78002897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78003400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78003400"
         }
      },
      "body" : "Just personal preference, I like being explicit about what the lambda is changing. In this case, = is probably desirable, it's [&] that I try to avoid.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:20:16Z",
      "diff_hunk" : "@@ -484,11 +484,12 @@ void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pf\n         if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n             // As per BIP152, we only get 3 of our peers to announce\n             // blocks using compact encodings.\n-            CNode* pnodeStop = FindNode(lNodesAnnouncingHeaderAndIDs.front());\n-            if (pnodeStop) {\n+            bool found = connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78003400",
      "id" : 78003400,
      "original_commit_id" : "55af13c9fa598e33630723d1d7aef4df7ee033f7",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : 49,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:20:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78003400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78003705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78003705"
         }
      },
      "body" : "Yea, this is just a habit I've picked up. See the \"notes\" here: http://en.cppreference.com/w/cpp/language/range-for",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:22:08Z",
      "diff_hunk" : "@@ -2671,6 +2659,63 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)\n+{\n+    CNode* found = nullptr;\n+    LOCK(cs_vNodes);\n+    for (auto&& pnode : vNodes) {\n+        if(pnode->id == id) {\n+            found = pnode;\n+            break;\n+        }\n+    }\n+    return found != nullptr && func(found);\n+}\n+\n+bool CConnman::ForEachNode(std::function<bool(CNode* pnode)> func)\n+{\n+    LOCK(cs_vNodes);\n+    for (auto&& node : vNodes)\n+        if(!func(node))\n+            return false;\n+    return true;\n+}\n+\n+bool CConnman::ForEachNode(std::function<bool(const CNode* pnode)> func) const\n+{\n+    LOCK(cs_vNodes);\n+    for (const auto& node : vNodes)\n+        if(!func(node))\n+            return false;\n+    return true;\n+}\n+\n+bool CConnman::ForEachNodeThen(std::function<bool(CNode* pnode)> pre, std::function<void()> post)\n+{\n+    bool ret = true;\n+    LOCK(cs_vNodes);\n+    for (auto&& node : vNodes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78003705",
      "id" : 78003705,
      "original_commit_id" : "55af13c9fa598e33630723d1d7aef4df7ee033f7",
      "original_position" : 128,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:22:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78003705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Concept and overall code review ACK. I think you still need to address https://github.com/bitcoin/bitcoin/pull/8085/files#r66671033. I also left a number of nits in various commits, but none of them are blockers.\r\n\r\nNeeds rebase, though.\r\n",
      "created_at" : "2016-09-08T13:24:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-245595815",
      "id" : 245595815,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-09-08T13:24:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245595815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78004260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78004260"
         }
      },
      "body" : "Seems reasonable.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:25:08Z",
      "diff_hunk" : "@@ -484,11 +484,12 @@ void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pf\n         if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n             // As per BIP152, we only get 3 of our peers to announce\n             // blocks using compact encodings.\n-            CNode* pnodeStop = FindNode(lNodesAnnouncingHeaderAndIDs.front());\n-            if (pnodeStop) {\n+            bool found = connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78004260",
      "id" : 78004260,
      "original_commit_id" : "55af13c9fa598e33630723d1d7aef4df7ee033f7",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : 49,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:25:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78004260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78004355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78004355"
         }
      },
      "body" : "Hmm, I've never had luck with forward-declaring nested classes. I'll give it a shot!",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:25:40Z",
      "diff_hunk" : "@@ -95,28 +95,32 @@ CNode* FindNode(const CService& ip);\n CNode* FindNode(const NodeId id); //TODO: Remove this\n bool OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound = NULL, const char *strDest = NULL, bool fOneShot = false, bool fFeeler = false);\n \n-struct ListenSocket {\n-    SOCKET socket;\n-    bool whitelisted;\n-\n-    ListenSocket(SOCKET socket, bool whitelisted) : socket(socket), whitelisted(whitelisted) {}\n-};\n-\n class CConnman\n {\n public:\n     CConnman();\n     ~CConnman();\n     bool Start(boost::thread_group& threadGroup, std::string& strNodeError);\n     void Stop();\n+    bool BindListenPort(const CService &bindAddr, std::string& strError, bool fWhitelisted = false);\n+\n private:\n+    struct ListenSocket {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78004355",
      "id" : 78004355,
      "original_commit_id" : "d4fce84b9a87b2877fb0a9fa47bf5870a005657a",
      "original_position" : 21,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:25:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78004355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78005054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78005054"
         }
      },
      "body" : "They're passed by value so that they can be std::move'd in if desired, but as-is, all members are fundamental, so they'll all be copied anyway",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:29:20Z",
      "diff_hunk" : "@@ -109,9 +109,18 @@ class CConnman\n         CONNECTIONS_ALL = (CONNECTIONS_IN | CONNECTIONS_OUT),\n     };\n \n+    struct Options\n+    {\n+        ServiceFlags nLocalServices = NODE_NONE;\n+        ServiceFlags nRelevantServices = NODE_NONE;\n+        int nMaxConnections = 0;\n+        int nMaxOutbound = 0;\n+        int nBestHeight = 0;\n+        CClientUIInterface* interface = nullptr;\n+    };\n     CConnman();\n     ~CConnman();\n-    bool Start(boost::thread_group& threadGroup, CScheduler& scheduler, ServiceFlags nLocalServicesIn, ServiceFlags nRelevantServicesIn, int nMaxConnectionsIn, int nMaxOutboundIn, int nBestHeightIn, CClientUIInterface* interfaceIn, std::string& strNodeError);\n+    bool Start(boost::thread_group& threadGroup, CScheduler& scheduler, std::string& strNodeError, Options options);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78005054",
      "id" : 78005054,
      "original_commit_id" : "9f6a3ea5e2842f0b123db79dfb238a6f7fe2688c",
      "original_position" : 16,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:29:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78005054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78005094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78005094"
         }
      },
      "body" : "It seems you can use [=,x&,y&,...] as well to mean \"capture everything by value, but x and y by reference\", neat.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:29:35Z",
      "diff_hunk" : "@@ -484,11 +484,12 @@ void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pf\n         if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n             // As per BIP152, we only get 3 of our peers to announce\n             // blocks using compact encodings.\n-            CNode* pnodeStop = FindNode(lNodesAnnouncingHeaderAndIDs.front());\n-            if (pnodeStop) {\n+            bool found = connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78005094",
      "id" : 78005094,
      "original_commit_id" : "55af13c9fa598e33630723d1d7aef4df7ee033f7",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : 49,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:29:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78005094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Yikes, thanks for noticing the missed changes. I'll rebase now and make sure that matches.\r\nThanks for the review!",
      "created_at" : "2016-09-08T13:33:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#issuecomment-245598279",
      "id" : 245598279,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8085",
      "updated_at" : "2016-09-08T13:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245598279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78007960"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78007960"
         }
      },
      "body" : "Ah, perfect. That's great as a general rule.",
      "commit_id" : "363e28d68647736ac9ddcb57a93878da5253bab9",
      "created_at" : "2016-09-08T13:44:00Z",
      "diff_hunk" : "@@ -484,11 +484,12 @@ void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pf\n         if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n             // As per BIP152, we only get 3 of our peers to announce\n             // blocks using compact encodings.\n-            CNode* pnodeStop = FindNode(lNodesAnnouncingHeaderAndIDs.front());\n-            if (pnodeStop) {\n+            bool found = connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8085#discussion_r78007960",
      "id" : 78007960,
      "original_commit_id" : "55af13c9fa598e33630723d1d7aef4df7ee033f7",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : 49,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8085",
      "updated_at" : "2016-09-08T13:44:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78007960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
