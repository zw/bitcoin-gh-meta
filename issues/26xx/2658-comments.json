[
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/3457681627384baf41c7b1d809d87a52a2c94e07 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2013-05-16T22:05:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-18032219",
      "id" : 18032219,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-05-16T22:05:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/18032219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "I think it would be nice to not just use our default cryptic message, but provide some details (not only for this new condition).",
      "created_at" : "2013-05-17T05:59:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-18045139",
      "id" : 18045139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-05-17T05:59:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/18045139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Overall looks good to me. Agree with Diapolo that the log message could be more helpful, like by including the fork block hash and stating why transactions may be incorrect.",
      "created_at" : "2013-05-17T22:22:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-18089071",
      "id" : 18089071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-05-17T22:22:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/18089071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "OK, rewrote the alert messages, now you get:\r\n'Warning: Large-work fork detected, forking after block $HASH' for %s in -alertnotify\r\n\"CheckForkWarningConditions: Warning: Large valid fork found\\n  forking the chain at height %d (%s)\\n  lasting to height %d (%s).\\n\" in debug.log for large valid-work fork\r\n\"CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\\n\" for the previous warning condition.\r\nand translated versions of either\r\n\"Warning: We do not appear to fully agree with our peers! You may need to upgrade, or other nodes may need to upgrade.\" for large, valid fork\r\nor\r\n\"Warning: The network does not appear to fully agree! Some miners appear to be experiencing issues.\" for the previous warning condition.\r\nin getinfo/status bar.",
      "created_at" : "2013-05-18T01:20:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-18093162",
      "id" : 18093162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-05-18T01:20:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/18093162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/7c4ad5d8dffb116cbb8c2e429f19452cbb056d38 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2013-05-18T01:47:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-18093475",
      "id" : 18093475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-05-18T01:47:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/18093475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "Looks good to me.",
      "created_at" : "2013-06-05T10:00:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-18966187",
      "id" : 18966187,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-06-05T10:00:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/18966187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "I think this code belongs in main rather than alert (rationale: it needs access to the current chainstate, which is maintained by main - alert shouldn't need a dependency on that).\r\n\r\nCode in general looks good, but needs a rebase.\r\n\r\nAlso, I expect the most common case for a message like this to be a locally corrupted database. Maybe that is worth mentioning is the text?",
      "created_at" : "2013-06-22T19:47:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-19863626",
      "id" : 19863626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-06-22T19:47:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/19863626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Interesting ... \"CheckForkWarningConditions: Warning: Large valid fork found\\n forking the chain at height\" can happen with a daemon that does not fail if your database is corrupted in just the right way.  Sorry I don't have a copy of the corrupted database to demonstrate this.  I can imagine this will be a false alarm for someone in the future, and it would be ideal if the daemon had a way to differentiate between database corruption and a genuine problem on the network.",
      "created_at" : "2013-07-04T10:18:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-20469689",
      "id" : 20469689,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-04T10:18:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/20469689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/93665?v=3",
         "events_url" : "https://api.github.com/users/wtogami/events{/privacy}",
         "followers_url" : "https://api.github.com/users/wtogami/followers",
         "following_url" : "https://api.github.com/users/wtogami/following{/other_user}",
         "gists_url" : "https://api.github.com/users/wtogami/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/wtogami",
         "id" : 93665,
         "login" : "wtogami",
         "organizations_url" : "https://api.github.com/users/wtogami/orgs",
         "received_events_url" : "https://api.github.com/users/wtogami/received_events",
         "repos_url" : "https://api.github.com/users/wtogami/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/wtogami/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/wtogami/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/wtogami"
      }
   },
   {
      "body" : "Also note that this puts lots of needlessly scary-looking warnings in debug.log during a reindex.  Perhaps it should be silent during a reindex if prior to the last checkpoint?",
      "created_at" : "2013-07-06T09:05:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-20551510",
      "id" : 20551510,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-06T09:05:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/20551510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/93665?v=3",
         "events_url" : "https://api.github.com/users/wtogami/events{/privacy}",
         "followers_url" : "https://api.github.com/users/wtogami/followers",
         "following_url" : "https://api.github.com/users/wtogami/following{/other_user}",
         "gists_url" : "https://api.github.com/users/wtogami/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/wtogami",
         "id" : 93665,
         "login" : "wtogami",
         "organizations_url" : "https://api.github.com/users/wtogami/orgs",
         "received_events_url" : "https://api.github.com/users/wtogami/received_events",
         "repos_url" : "https://api.github.com/users/wtogami/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/wtogami/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/wtogami/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/wtogami"
      }
   },
   {
      "body" : "@TheBlueMatt Rebase needed.",
      "created_at" : "2013-07-17T04:14:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21091143",
      "id" : 21091143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-17T04:14:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21091143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "@wtogami Hmm...I dont see any fork messages during -reindex, are you talking about a -reindex on a corrupted chainstate?",
      "created_at" : "2013-07-22T09:45:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21334120",
      "id" : 21334120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-22T09:45:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21334120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased, moved code to main.cpp, because its not like that file isnt already too full.",
      "created_at" : "2013-07-22T10:14:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21335281",
      "id" : 21335281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-22T10:14:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21335281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/f65e7092a200ee6e9453058c3dafbab62d9b4dcc for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2013-07-23T00:59:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21386907",
      "id" : 21386907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-23T00:59:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21386907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2658#discussion_r5352647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2658"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/5352647"
         }
      },
      "body" : "whose",
      "commit_id" : "f65e7092a200ee6e9453058c3dafbab62d9b4dcc",
      "created_at" : "2013-07-23T18:25:58Z",
      "diff_hunk" : "@@ -1383,6 +1383,82 @@ bool IsInitialBlockDownload()\n             pindexBest->GetBlockTime() < GetTime() - 24 * 60 * 60);\n }\n \n+bool fLargeWorkForkFound = false;\n+bool fLargeWorkInvalidChainFound = false;\n+CBlockIndex *pindexBestForkTip = NULL, *pindexBestForkBase = NULL;\n+\n+void CheckForkWarningConditions()\n+{\n+    // If our best fork is no longer within 72 blocks (+/- 12 hours if no one mines it)\n+    // of our head, drop it\n+    if (pindexBestForkTip && nBestHeight - pindexBestForkTip->nHeight >= 72)\n+        pindexBestForkTip = NULL;\n+\n+    if (pindexBestForkTip || nBestInvalidWork > nBestChainWork + (pindexBest->GetBlockWork() * 6).getuint256())\n+    {\n+        if (!fLargeWorkForkFound)\n+        {\n+            std::string strCmd = GetArg(\"-alertnotify\", \"\");\n+            if (!strCmd.empty())\n+            {\n+                std::string warning = std::string(\"'Warning: Large-work fork detected, forking after block \") +\n+                                      pindexBestForkBase->phashBlock->ToString() + std::string(\"'\");\n+                boost::replace_all(strCmd, \"%s\", warning);\n+                boost::thread t(runCommand, strCmd); // thread runs free\n+            }\n+        }\n+        if (pindexBestForkTip)\n+        {\n+            printf(\"CheckForkWarningConditions: Warning: Large valid fork found\\n  forking the chain at height %d (%s)\\n  lasting to height %d (%s).\\nChain state database corruption likely.\\n\",\n+                   pindexBestForkBase->nHeight, pindexBestForkBase->phashBlock->ToString().c_str(),\n+                   pindexBestForkTip->nHeight, pindexBestForkTip->phashBlock->ToString().c_str());\n+            fLargeWorkForkFound = true;\n+        }\n+        else\n+        {\n+            printf(\"CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\\nChain state database corruption likely.\\n\");\n+            fLargeWorkInvalidChainFound = true;\n+        }\n+    }\n+    else\n+    {\n+        fLargeWorkForkFound = false;\n+        fLargeWorkInvalidChainFound = false;\n+    }\n+}\n+\n+void CheckForkWarningConditionsOnNewFork(CBlockIndex* pindexNewForkTip)\n+{\n+    // If we are on a fork that is sufficiently large, set a warning flag\n+    CBlockIndex* pfork = pindexNewForkTip;\n+    CBlockIndex* plonger = pindexBest;\n+    while (pfork && pfork != plonger)\n+    {\n+        while (plonger && plonger->nHeight > pfork->nHeight)\n+            plonger = plonger->pprev;\n+        if (pfork == plonger)\n+            break;\n+        pfork = pfork->pprev;\n+    }\n+\n+    // We define a condition which we should warn the user about as a fork of at least 7 blocks\n+    // who's tip is within 72 blocks (+/- 12 hours if no one mines it) of ours",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#discussion_r5352647",
      "id" : 5352647,
      "original_commit_id" : "f65e7092a200ee6e9453058c3dafbab62d9b4dcc",
      "original_position" : 63,
      "path" : "src/main.cpp",
      "position" : 63,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2658",
      "updated_at" : "2013-07-23T18:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/5352647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "LGTM. Can we merge this now?",
      "created_at" : "2013-07-23T18:26:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21435281",
      "id" : 21435281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-23T18:26:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21435281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "Is the patch intended to warn about forks during the -reindex process where it is unnecessarily scary? Can it be somehow silent about forks until after the last checkpoint?",
      "created_at" : "2013-07-24T05:59:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21465367",
      "id" : 21465367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-25T07:26:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21465367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/93665?v=3",
         "events_url" : "https://api.github.com/users/wtogami/events{/privacy}",
         "followers_url" : "https://api.github.com/users/wtogami/followers",
         "following_url" : "https://api.github.com/users/wtogami/following{/other_user}",
         "gists_url" : "https://api.github.com/users/wtogami/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/wtogami",
         "id" : 93665,
         "login" : "wtogami",
         "organizations_url" : "https://api.github.com/users/wtogami/orgs",
         "received_events_url" : "https://api.github.com/users/wtogami/received_events",
         "repos_url" : "https://api.github.com/users/wtogami/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/wtogami/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/wtogami/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/wtogami"
      }
   },
   {
      "body" : "Please do not further overload checkpoints.  ... but yea, warning during reindex is obviously not good. :)",
      "created_at" : "2013-07-24T06:21:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21465993",
      "id" : 21465993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-24T06:21:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21465993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Probably a condition of this should be \"at least one block in the fork must have been rejected by us\"?",
      "created_at" : "2013-07-24T06:30:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21466257",
      "id" : 21466257,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-24T06:30:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21466257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "RE: warning during reindex: suppressing the alert if best-other-tip-time is more than a day (a week? or maybe if max(other-tip-time, best-tip-time) is...) in the past is probably the right thing to do: reasoning would be we don't care about old fork events that have long-since been resolved.\r\n\r\nBut before implementing that, can we get a block index that demonstrates false positives during a reindex?  (I've got a corrupt chain that I'll copy and then reindex if somebody else doesn't beat me to it).",
      "created_at" : "2013-07-25T06:18:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21535251",
      "id" : 21535251,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-25T06:18:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21535251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "I removed these three patches from litecoin-0.8.x not because it was broken, but from concern that it would unnecessarily scare people with false positives that appeared to me during a normal reindex.  Although I am not entirely certain it was the type of false positive you are asking for.  I didn't investigate too hard as it seemed best to simply remove the patches for the upcoming release meant to minimize risk.\r\n\r\nhttps://github.com/litecoin-project/litecoin/commits/exp-mark11b\r\nlitecoin-0.8.3.6 is comprised of a merge of the following two branches\r\nhttps://github.com/litecoin-project/litecoin/commits/exp-mark11\r\nlitecoin specific commits on top of bitcoin-0.8.3\r\nhttps://github.com/litecoin-project/litecoin/commits/exp-btc09backports\r\nSelect bitcoin-0.9 cherry-picks applied on top of bitcoin-0.8.3\r\n\r\nhttps://github.com/litecoin-project/litecoin/commit/286c31b45450eee0817de1ab7704c0911965eeb9\r\nhttps://github.com/litecoin-project/litecoin/commit/76cf1ab0802677a000aad8188667f1f3345baf24\r\nhttps://github.com/litecoin-project/litecoin/commit/e751fad2f78bcef601a601cc755809e98c7f0821\r\nAdd these back to litecoin-0.8.3.6 and -reindex to see noisy warnings.",
      "created_at" : "2013-07-25T07:20:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-21537259",
      "id" : 21537259,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-07-25T07:25:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/21537259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/93665?v=3",
         "events_url" : "https://api.github.com/users/wtogami/events{/privacy}",
         "followers_url" : "https://api.github.com/users/wtogami/followers",
         "following_url" : "https://api.github.com/users/wtogami/following{/other_user}",
         "gists_url" : "https://api.github.com/users/wtogami/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/wtogami",
         "id" : 93665,
         "login" : "wtogami",
         "organizations_url" : "https://api.github.com/users/wtogami/orgs",
         "received_events_url" : "https://api.github.com/users/wtogami/received_events",
         "repos_url" : "https://api.github.com/users/wtogami/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/wtogami/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/wtogami/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/wtogami"
      }
   },
   {
      "body" : "https://github.com/litecoin-project/litecoin/tree/exp-forkalert\r\nFYI: I tested it yesterday after re-applying the three patches above (an older version of this PR that applied cleanly to bitcoin-0.8.3, prior to the recent rebase).  A fresh Litecoin blockchain sync and a subsequent -reindex both were uneventful.\r\n\r\nA month ago I saw loud and scary warnings during -reindex twice in a row.  I don't know what is different now.  Would a fresh sync with additional checkpoints result in a different local blockchain sans historic forks?  Whatever the issue, I am unable to reproduce it with this freshly synced chain now.\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/2658#issuecomment-20469689\r\nA month ago I had a corrupted database that exhibited a great many errors in the log but did not crash.  sipa's post immediately before it said, \"Also, I expect the most common case for a message like this to be a locally corrupted database. Maybe that is worth mentioning is the text?\"\r\n\r\nWas his question addressed?",
      "created_at" : "2013-08-09T09:52:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-22385254",
      "id" : 22385254,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-08-09T09:52:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/22385254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/93665?v=3",
         "events_url" : "https://api.github.com/users/wtogami/events{/privacy}",
         "followers_url" : "https://api.github.com/users/wtogami/followers",
         "following_url" : "https://api.github.com/users/wtogami/following{/other_user}",
         "gists_url" : "https://api.github.com/users/wtogami/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/wtogami",
         "id" : 93665,
         "login" : "wtogami",
         "organizations_url" : "https://api.github.com/users/wtogami/orgs",
         "received_events_url" : "https://api.github.com/users/wtogami/received_events",
         "repos_url" : "https://api.github.com/users/wtogami/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/wtogami/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/wtogami/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/wtogami"
      }
   },
   {
      "body" : "ACK.  I re-indexed an old chain that has lots of forks and got no scary warnings.\r\n",
      "created_at" : "2013-08-13T06:33:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-22545695",
      "id" : 22545695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-08-13T06:33:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/22545695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "I updated BIP50 with the fact that this is done. Great work Matt!",
      "created_at" : "2013-08-13T09:01:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2658#issuecomment-22551666",
      "id" : 22551666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2658",
      "updated_at" : "2013-08-13T09:01:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/22551666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   }
]
