{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "Following a discussion that I started firstly on the Bitcoin dev's mailing list, and then on StackExchange and Reddit, regarding some weird inconsistencies I noticed when I was working on a function to derive the p2sh from a multisig script, I'm here now to report what seems to be a bug in `addmultisigaddress` method.\r\n\r\nReference of the discussions:\r\nhttps://bitcoin.stackexchange.com/questions/87579/multisig-scripts-hashing-p2sh-difference-between-legacy-and-segwit\r\nhttps://www.reddit.com/r/Bitcoin/comments/bmiuk5/multisig_scripts_hashing_p2sh_difference_between/\r\n\r\n## Example:\r\n\r\n```bash\r\nbitcoin-cli addmultisigaddress 1 '[\"045897fee25bd7c5692510b2f50fcae9aa20fbc4d49d59814f4c7fdb5c4bc6eb1c0ce382458f9588e922e0d509ed8d34856787380075b00418b02e0bf7c652ef9d\",\"02ac46c6d74d15e60f4f1035ff07ef740aca1d68d55ba0b8d336a73d7a35858831\",\"0224a4dc5620714a9ecf67a09583d1e4c04f5bedb8ecea99028da05bb15a2a7e07\"]'\r\n{\r\n  \"address\": \"36ULucjWUTrDvaJzCyhFoVbDoNS6Zum2Du\",\r\n  \"redeemScript\": \"5141045897fee25bd7c5692510b2f50fcae9aa20fbc4d49d59814f4c7fdb5c4bc6eb1c0ce382458f9588e922e0d509ed8d34856787380075b00418b02e0bf7c652ef9d2102ac46c6d74d15e60f4f1035ff07ef740aca1d68d55ba0b8d336a73d7a35858831210224a4dc5620714a9ecf67a09583d1e4c04f5bedb8ecea99028da05bb15a2a7e0753ae\"\r\n}\r\n\r\nbitcoin-cli createmultisig 1 '[\"045897fee25bd7c5692510b2f50fcae9aa20fbc4d49d59814f4c7fdb5c4bc6eb1c0ce382458f9588e922e0d509ed8d34856787380075b00418b02e0bf7c652ef9d\",\"02ac46c6d74d15e60f4f1035ff07ef740aca1d68d55ba0b8d336a73d7a35858831\",\"0224a4dc5620714a9ecf67a09583d1e4c04f5bedb8ecea99028da05bb15a2a7e07\"]'\r\n{\r\n  \"address\": \"3GiimyxF1R5VixfBFAbQZbuy9EesD2r6n1\",\r\n  \"redeemScript\": \"5141045897fee25bd7c5692510b2f50fcae9aa20fbc4d49d59814f4c7fdb5c4bc6eb1c0ce382458f9588e922e0d509ed8d34856787380075b00418b02e0bf7c652ef9d2102ac46c6d74d15e60f4f1035ff07ef740aca1d68d55ba0b8d336a73d7a35858831210224a4dc5620714a9ecf67a09583d1e4c04f5bedb8ecea99028da05bb15a2a7e0753ae\"\r\n}\r\n```\r\n\r\n## Expected behaviour:\r\n\r\nBoth the two calls should return the same legacy address, because `addmultisigaddress` uses p2sh-segwit which is the default address type for the wallet, but segwit does not support uncompressed keys, so the first call should fallback to legacy.\r\n\r\n## Actual behaviour:\r\n\r\nThe first call is returning an invalid segwit address.\r\n\r\n@achow101 answered to my email to the dev list and also to my question on StackExchange and he believes that this is a bug and it could be related to the fact that the uncompressed pubkey is not part of my wallet.\r\n\r\n---\r\n\r\nAnother interesting thing is that, as user @ugamkamat pointed out on StackExchange, changing the position of the uncompressed public key from the first to the last, the first call returns a legacy address:\r\n\r\n```bash\r\n./bitcoin-cli addmultisigaddress 1 '[\"02ac46c6d74d15e60f4f1035ff07ef740aca1d68d55ba0b8d336a73d7a35858831\",\"0224a4dc5620714a9ecf67a09583d1e4c04f5bedb8ecea99028da05bb15a2a7e07\",\"045897fee25bd7c5692510b2f50fcae9aa20fbc4d49d59814f4c7fdb5c4bc6eb1c0ce382458f9588e922e0d509ed8d34856787380075b00418b02e0bf7c652ef9d\"]'\r\n{\r\n  \"address\": \"35RZ8AHKWGGbNcRDaCUtznSVnPRWGqVPJu\",\r\n  \"redeemScript\": \"512102ac46c6d74d15e60f4f1035ff07ef740aca1d68d55ba0b8d336a73d7a35858831210224a4dc5620714a9ecf67a09583d1e4c04f5bedb8ecea99028da05bb15a2a7e0741045897fee25bd7c5692510b2f50fcae9aa20fbc4d49d59814f4c7fdb5c4bc6eb1c0ce382458f9588e922e0d509ed8d34856787380075b00418b02e0bf7c652ef9d53ae\"\r\n}\r\n```\r\n\r\nI'd really like to try to contribute to the project, so I'm trying to figure out where the problem could be in the code. Any suggestion is welcome.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16011/comments",
   "created_at" : "2019-05-12T11:07:32Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16011/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/16011",
   "id" : 443092144,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16011/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU0NDMwOTIxNDQ=",
   "number" : 16011,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "addmultisigaddress does not fallback to legacy when there are uncompressed public keys in the parameters",
   "updated_at" : "2019-05-12T14:32:10Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16011",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/10249616?v=4",
      "events_url" : "https://api.github.com/users/ps1dr3x/events{/privacy}",
      "followers_url" : "https://api.github.com/users/ps1dr3x/followers",
      "following_url" : "https://api.github.com/users/ps1dr3x/following{/other_user}",
      "gists_url" : "https://api.github.com/users/ps1dr3x/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/ps1dr3x",
      "id" : 10249616,
      "login" : "ps1dr3x",
      "node_id" : "MDQ6VXNlcjEwMjQ5NjE2",
      "organizations_url" : "https://api.github.com/users/ps1dr3x/orgs",
      "received_events_url" : "https://api.github.com/users/ps1dr3x/received_events",
      "repos_url" : "https://api.github.com/users/ps1dr3x/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/ps1dr3x/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/ps1dr3x/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/ps1dr3x"
   }
}
