[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29619).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/29619#pullrequestreview-1927508394), [instagibbs](https://github.com/bitcoin/bitcoin/pull/29619#issuecomment-1988515543) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-03-11T10:43:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#issuecomment-1988138515",
      "id" : 1988138515,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29619",
      "node_id" : "IC_kwDOABII5852gJYT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988138515/reactions"
      },
      "updated_at" : "2024-03-11T14:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988138515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519520754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519520754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    void ProcessInvalidTx(NodeId nodeid, const CTransactionRef& tx, const TxValidationState& result, bool was_rejected)\r\n        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, g_msgproc_mutex, cs_main);\r\n```\r\n\r\nnit: This is more inline with other method sigs in peerman.",
      "commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "created_at" : "2024-03-11T10:49:44Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being\n+     *                              reevaluated as an orphan. Used to avoid adding duplicate entries to\n+     *                              vExtraTxnForCompact.\n+     * Updates m_txrequest, m_recent_rejects, m_orphanage, and vExtraTxnForCompact. */\n+    void ProcessInvalidTx(const CTransactionRef& tx, const TxValidationState& result, bool was_rejected, NodeId nodeid)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, g_msgproc_mutex, cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519520754",
      "id" : 1519520754,
      "line" : 591,
      "node_id" : "PRRC_kwDOABII585akgvy",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 591,
      "original_position" : 10,
      "original_start_line" : 590,
      "path" : "src/net_processing.cpp",
      "position" : 10,
      "pull_request_review_id" : 1927508394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519520754/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 590,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-03-11T10:55:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519520754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519521103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519521103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    void ProcessValidTx(NodeId nodeid, const CTransactionRef& tx, const std::list<CTransactionRef>& replaced_transactions)\r\n```",
      "commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "created_at" : "2024-03-11T10:50:01Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being\n+     *                              reevaluated as an orphan. Used to avoid adding duplicate entries to\n+     *                              vExtraTxnForCompact.\n+     * Updates m_txrequest, m_recent_rejects, m_orphanage, and vExtraTxnForCompact. */\n+    void ProcessInvalidTx(const CTransactionRef& tx, const TxValidationState& result, bool was_rejected, NodeId nodeid)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, g_msgproc_mutex, cs_main);\n+\n+    /** Handle a transaction whose result was MempoolAcceptResult::ResultType::VALID.\n+     * Updates m_txrequest, m_orphanage, and vExtraTxnForCompact. Also queues the tx for relay. */\n+    void ProcessValidTx(const CTransactionRef& tx, NodeId nodeid, const std::list<CTransactionRef>& replaced_transactions)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519521103",
      "id" : 1519521103,
      "line" : 595,
      "node_id" : "PRRC_kwDOABII585akg1P",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 595,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1927508394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519521103/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T10:55:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519521103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519524297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519524297"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe `was_orphan` would be a better name?",
      "commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "created_at" : "2024-03-11T10:52:37Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519524297",
      "id" : 1519524297,
      "line" : 586,
      "node_id" : "PRRC_kwDOABII585akhnJ",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 586,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1927508394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519524297/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T10:55:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519524297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519528382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519528382"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was calling it this, but in the future it could also be `was_failed_for_too_low_fee`, so I changed it to `was_rejected` to be more generic.",
      "commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "created_at" : "2024-03-11T10:56:01Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519528382",
      "id" : 1519528382,
      "in_reply_to_id" : 1519524297,
      "line" : 586,
      "node_id" : "PRRC_kwDOABII585akim-",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 586,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1927520736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519528382/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T10:56:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519528382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519535370"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519535370"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, how about `add_to_extra_compact_txs`? ",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-11T11:01:29Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519535370",
      "id" : 1519535370,
      "in_reply_to_id" : 1519524297,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585akkUK",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 586,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1927531409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519535370/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T11:01:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519535370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Note to reviewers: this PR isn't supposed to change behavior at all. I have a [spreadsheet](https://docs.google.com/spreadsheets/d/1QFtQT1CB7-TagkDC2qwWubfYcoQHpAbJkkgdM9dy4TA/edit?usp=sharing) here enumerating what we do on master, and this PR should match that.\r\nFor tests, p2p_orphan_handling.py was written to hit some of these codepaths. Unit/fuzz tests for this are pretty difficult to achieve right now, but I would like to add some in the future after modularization - see #28031 (e.g.https://github.com/bitcoin/bitcoin/pull/28031/commits/ffa4d60bf11abac7aeeb9712e77245c67c15d3f6).",
      "created_at" : "2024-03-11T11:03:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#issuecomment-1988176325",
      "id" : 1988176325,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29619",
      "node_id" : "IC_kwDOABII5852gSnF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988176325/reactions"
      },
      "updated_at" : "2024-03-11T11:03:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988176325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519545033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519545033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-11T11:09:17Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being\n+     *                              reevaluated as an orphan. Used to avoid adding duplicate entries to\n+     *                              vExtraTxnForCompact.\n+     * Updates m_txrequest, m_recent_rejects, m_orphanage, and vExtraTxnForCompact. */\n+    void ProcessInvalidTx(const CTransactionRef& tx, const TxValidationState& result, bool was_rejected, NodeId nodeid)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, g_msgproc_mutex, cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519545033",
      "id" : 1519545033,
      "in_reply_to_id" : 1519520754,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585akmrJ",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 592,
      "original_position" : 10,
      "original_start_line" : 590,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1927546304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519545033/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-03-11T11:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519545033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519545150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519545150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-11T11:09:22Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being\n+     *                              reevaluated as an orphan. Used to avoid adding duplicate entries to\n+     *                              vExtraTxnForCompact.\n+     * Updates m_txrequest, m_recent_rejects, m_orphanage, and vExtraTxnForCompact. */\n+    void ProcessInvalidTx(const CTransactionRef& tx, const TxValidationState& result, bool was_rejected, NodeId nodeid)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, g_msgproc_mutex, cs_main);\n+\n+    /** Handle a transaction whose result was MempoolAcceptResult::ResultType::VALID.\n+     * Updates m_txrequest, m_orphanage, and vExtraTxnForCompact. Also queues the tx for relay. */\n+    void ProcessValidTx(const CTransactionRef& tx, NodeId nodeid, const std::list<CTransactionRef>& replaced_transactions)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519545150",
      "id" : 1519545150,
      "in_reply_to_id" : 1519521103,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585akms-",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 595,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1927546456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519545150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T11:09:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519545150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519581975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519581975"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok :handshake: `maybe_add_extra_compact_tx`",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-11T11:41:53Z",
      "diff_hunk" : "@@ -582,6 +582,19 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n+    /** Handle a transaction whose result was not MempoolAcceptResult::ResultType::VALID.\n+     * @param[in]   was_rejected    Whether this tx has already been rejected before and is being",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519581975",
      "id" : 1519581975,
      "in_reply_to_id" : 1519524297,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585akvsX",
      "original_commit_id" : "9696d66d14fe958c89a641ea506950a27f9b12be",
      "original_line" : 586,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1927606318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519581975/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T11:41:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519581975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks for doing this! concept ACK",
      "created_at" : "2024-03-11T14:01:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#issuecomment-1988515543",
      "id" : 1988515543,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29619",
      "node_id" : "IC_kwDOABII5852hlbX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988515543/reactions"
      },
      "updated_at" : "2024-03-11T14:01:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988515543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519819257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519819257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`value_or` here as well for belt and suspenders?",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-11T14:29:27Z",
      "diff_hunk" : "@@ -4276,24 +4301,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         const TxValidationState& state = result.m_state;\n \n         if (result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-            // As this version of the transaction was acceptable, we can forget about any\n-            // requests for it.\n-            m_txrequest.ForgetTxHash(tx.GetHash());\n-            m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash());\n-            m_orphanage.AddChildrenToWorkSet(tx);\n-\n+            ProcessValidTx(pfrom.GetId(), ptx, result.m_replaced_transactions.value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519819257",
      "id" : 1519819257,
      "line" : 4335,
      "node_id" : "PRRC_kwDOABII585alpn5",
      "original_commit_id" : "9353aa4066a85705154800efa61c5601036be921",
      "original_line" : 4304,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 205,
      "pull_request_review_id" : 1927994245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519819257/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T16:35:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519819257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519936505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519936505"
         }
      },
      "author_association" : "MEMBER",
      "body" : "now that it's one call-site, do we need this subroutine?",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-11T15:38:43Z",
      "diff_hunk" : "@@ -3037,6 +3046,63 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n     return;\n }\n \n+void PeerManagerImpl::ProcessInvalidTx(NodeId nodeid, const CTransactionRef& ptx, const TxValidationState& state,\n+                                       bool maybe_add_extra_compact_tx)\n+{\n+    AssertLockNotHeld(m_peer_mutex);\n+    AssertLockHeld(g_msgproc_mutex);\n+    AssertLockHeld(cs_main);\n+\n+    LogDebug(BCLog::MEMPOOLREJ, \"%s (wtxid=%s) from peer=%d was not accepted: %s\\n\",\n+        ptx->GetHash().ToString(),\n+        ptx->GetWitnessHash().ToString(),\n+        nodeid,\n+        state.ToString());\n+\n+    if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n+        return;\n+    } else if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+        // We can add the wtxid of this transaction to our reject filter.\n+        // Do not add txids of witness transactions or witness-stripped\n+        // transactions to the filter, as they can have been malleated;\n+        // adding such txids to the reject filter would potentially\n+        // interfere with relay of valid transactions from peers that\n+        // do not support wtxid-based relay. See\n+        // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+        // We can remove this restriction (and always add wtxids to\n+        // the filter even for witness stripped transactions) once\n+        // wtxid-based relay is broadly deployed.\n+        // See also comments in https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034\n+        // for concerns around weakening security of unupgraded nodes\n+        // if we start doing this too early.\n+        m_recent_rejects.insert(ptx->GetWitnessHash().ToUint256());\n+        m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n+        // If the transaction failed for TX_INPUTS_NOT_STANDARD,\n+        // then we know that the witness was irrelevant to the policy\n+        // failure, since this check depends only on the txid\n+        // (the scriptPubKey being spent is covered by the txid).\n+        // Add the txid to the reject filter to prevent repeated\n+        // processing of this transaction in the event that child\n+        // transactions are later received (resulting in\n+        // parent-fetching by txid via the orphan-handling logic).\n+        if (state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && ptx->HasWitness()) {\n+            m_recent_rejects.insert(ptx->GetHash().ToUint256());\n+            m_txrequest.ForgetTxHash(ptx->GetHash());\n+        }\n+        if (maybe_add_extra_compact_tx && RecursiveDynamicUsage(*ptx) < 100000) {\n+            AddToCompactExtraTransactions(ptx);\n+        }\n+    }\n+\n+    MaybePunishNodeForTx(nodeid, state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1519936505",
      "id" : 1519936505,
      "line" : 3097,
      "node_id" : "PRRC_kwDOABII585amGP5",
      "original_commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "original_line" : 3097,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 68,
      "pull_request_review_id" : 1927994245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519936505/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-11T16:35:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1519936505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1521152266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521152266"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought about this as well, but didn't think I should do anything with it in this PR. Seems like there are some ideas in the air wrt misbehavior and I'm not sure where it's going to land / don't want to conflict with them (#29575, #29530).",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-12T09:41:51Z",
      "diff_hunk" : "@@ -3037,6 +3046,63 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n     return;\n }\n \n+void PeerManagerImpl::ProcessInvalidTx(NodeId nodeid, const CTransactionRef& ptx, const TxValidationState& state,\n+                                       bool maybe_add_extra_compact_tx)\n+{\n+    AssertLockNotHeld(m_peer_mutex);\n+    AssertLockHeld(g_msgproc_mutex);\n+    AssertLockHeld(cs_main);\n+\n+    LogDebug(BCLog::MEMPOOLREJ, \"%s (wtxid=%s) from peer=%d was not accepted: %s\\n\",\n+        ptx->GetHash().ToString(),\n+        ptx->GetWitnessHash().ToString(),\n+        nodeid,\n+        state.ToString());\n+\n+    if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n+        return;\n+    } else if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n+        // We can add the wtxid of this transaction to our reject filter.\n+        // Do not add txids of witness transactions or witness-stripped\n+        // transactions to the filter, as they can have been malleated;\n+        // adding such txids to the reject filter would potentially\n+        // interfere with relay of valid transactions from peers that\n+        // do not support wtxid-based relay. See\n+        // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+        // We can remove this restriction (and always add wtxids to\n+        // the filter even for witness stripped transactions) once\n+        // wtxid-based relay is broadly deployed.\n+        // See also comments in https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034\n+        // for concerns around weakening security of unupgraded nodes\n+        // if we start doing this too early.\n+        m_recent_rejects.insert(ptx->GetWitnessHash().ToUint256());\n+        m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n+        // If the transaction failed for TX_INPUTS_NOT_STANDARD,\n+        // then we know that the witness was irrelevant to the policy\n+        // failure, since this check depends only on the txid\n+        // (the scriptPubKey being spent is covered by the txid).\n+        // Add the txid to the reject filter to prevent repeated\n+        // processing of this transaction in the event that child\n+        // transactions are later received (resulting in\n+        // parent-fetching by txid via the orphan-handling logic).\n+        if (state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && ptx->HasWitness()) {\n+            m_recent_rejects.insert(ptx->GetHash().ToUint256());\n+            m_txrequest.ForgetTxHash(ptx->GetHash());\n+        }\n+        if (maybe_add_extra_compact_tx && RecursiveDynamicUsage(*ptx) < 100000) {\n+            AddToCompactExtraTransactions(ptx);\n+        }\n+    }\n+\n+    MaybePunishNodeForTx(nodeid, state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1521152266",
      "id" : 1521152266,
      "in_reply_to_id" : 1519936505,
      "line" : 3097,
      "node_id" : "PRRC_kwDOABII585aqvEK",
      "original_commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "original_line" : 3097,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 68,
      "pull_request_review_id" : 1930559298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521152266/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-12T09:41:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521152266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1521153289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521153289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Adding in the next PR, or will squash if I retouch :+1:",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-12T09:42:34Z",
      "diff_hunk" : "@@ -4276,24 +4301,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         const TxValidationState& state = result.m_state;\n \n         if (result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-            // As this version of the transaction was acceptable, we can forget about any\n-            // requests for it.\n-            m_txrequest.ForgetTxHash(tx.GetHash());\n-            m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash());\n-            m_orphanage.AddChildrenToWorkSet(tx);\n-\n+            ProcessValidTx(pfrom.GetId(), ptx, result.m_replaced_transactions.value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1521153289",
      "id" : 1521153289,
      "in_reply_to_id" : 1519819257,
      "line" : 4335,
      "node_id" : "PRRC_kwDOABII585aqvUJ",
      "original_commit_id" : "9353aa4066a85705154800efa61c5601036be921",
      "original_line" : 4304,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 205,
      "pull_request_review_id" : 1930560975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521153289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-12T09:42:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521153289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1521653628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521653628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 07cd510ffe791a4dfc1824c67fb440be780a4e2b \"[refactor] consolidate invalid MempoolAcceptResult processing\"\r\n\r\nThis comment is lost.",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-12T15:13:41Z",
      "diff_hunk" : "@@ -3085,53 +3151,18 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n             ProcessValidTx(peer.m_id, porphanTx, result.m_replaced_transactions.value_or(empty_replacement_list));\n             return true;\n         } else if (state.GetResult() != TxValidationResult::TX_MISSING_INPUTS) {\n-            if (state.IsInvalid()) {\n-                LogPrint(BCLog::TXPACKAGES, \"   invalid orphan tx %s (wtxid=%s) from peer=%d. %s\\n\",\n-                    orphanHash.ToString(),\n-                    orphan_wtxid.ToString(),\n-                    peer.m_id,\n-                    state.ToString());\n-                LogPrint(BCLog::MEMPOOLREJ, \"%s (wtxid=%s) from peer=%d was not accepted: %s\\n\",\n-                    orphanHash.ToString(),\n-                    orphan_wtxid.ToString(),\n-                    peer.m_id,\n-                    state.ToString());\n-                // Maybe punish peer that gave us an invalid orphan tx\n-                MaybePunishNodeForTx(peer.m_id, state);\n-            }\n-            // Has inputs but not accepted to mempool\n-            // Probably non-standard or insufficient fee\n-            LogPrint(BCLog::TXPACKAGES, \"   removed orphan tx %s (wtxid=%s)\\n\", orphanHash.ToString(), orphan_wtxid.ToString());\n-            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n-                // We can add the wtxid of this transaction to our reject filter.\n-                // Do not add txids of witness transactions or witness-stripped\n-                // transactions to the filter, as they can have been malleated;\n-                // adding such txids to the reject filter would potentially\n-                // interfere with relay of valid transactions from peers that\n-                // do not support wtxid-based relay. See\n-                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n-                // We can remove this restriction (and always add wtxids to\n-                // the filter even for witness stripped transactions) once\n-                // wtxid-based relay is broadly deployed.\n-                // See also comments in https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034\n-                // for concerns around weakening security of unupgraded nodes\n-                // if we start doing this too early.\n-                m_recent_rejects.insert(porphanTx->GetWitnessHash().ToUint256());\n-                // If the transaction failed for TX_INPUTS_NOT_STANDARD,\n-                // then we know that the witness was irrelevant to the policy\n-                // failure, since this check depends only on the txid\n-                // (the scriptPubKey being spent is covered by the txid).\n-                // Add the txid to the reject filter to prevent repeated\n-                // processing of this transaction in the event that child\n-                // transactions are later received (resulting in\n-                // parent-fetching by txid via the orphan-handling logic).\n-                if (state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && porphanTx->HasWitness()) {\n-                    // We only add the txid if it differs from the wtxid, to\n-                    // avoid wasting entries in the rolling bloom filter.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1521653628",
      "id" : 1521653628,
      "line" : 3105,
      "node_id" : "PRRC_kwDOABII585aspd8",
      "original_commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "original_line" : 3130,
      "original_position" : 126,
      "original_start_line" : 3129,
      "path" : "src/net_processing.cpp",
      "position" : 126,
      "pull_request_review_id" : 1931370139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521653628/reactions"
      },
      "side" : "LEFT",
      "start_line" : 3104,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2024-03-12T15:20:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1521653628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523009904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523009904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: The var names differ from the declaration for `CTransactionsRef&` and `TxValidationState&`. Is there a reason for the `p` in `ptx`?",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-13T11:01:02Z",
      "diff_hunk" : "@@ -3037,6 +3046,63 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n     return;\n }\n \n+void PeerManagerImpl::ProcessInvalidTx(NodeId nodeid, const CTransactionRef& ptx, const TxValidationState& state,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523009904",
      "id" : 1523009904,
      "line" : 3049,
      "node_id" : "PRRC_kwDOABII585ax0lw",
      "original_commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "original_line" : 3049,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 1933805673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523009904/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-13T11:13:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523009904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523075233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523075233"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`p` as in \"pointer\". I usually use `CMutableTransaction mtx` and `CTransaction tx`. Though I agree there's a mix...",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-13T11:44:28Z",
      "diff_hunk" : "@@ -3037,6 +3046,63 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, Peer& peer,\n     return;\n }\n \n+void PeerManagerImpl::ProcessInvalidTx(NodeId nodeid, const CTransactionRef& ptx, const TxValidationState& state,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523075233",
      "id" : 1523075233,
      "in_reply_to_id" : 1523009904,
      "line" : 3049,
      "node_id" : "PRRC_kwDOABII585ayEih",
      "original_commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "original_line" : 3049,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 1933895830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523075233/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-13T11:44:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523075233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523094034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523094034"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added back in #28970",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-13T11:57:23Z",
      "diff_hunk" : "@@ -3085,53 +3151,18 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n             ProcessValidTx(peer.m_id, porphanTx, result.m_replaced_transactions.value_or(empty_replacement_list));\n             return true;\n         } else if (state.GetResult() != TxValidationResult::TX_MISSING_INPUTS) {\n-            if (state.IsInvalid()) {\n-                LogPrint(BCLog::TXPACKAGES, \"   invalid orphan tx %s (wtxid=%s) from peer=%d. %s\\n\",\n-                    orphanHash.ToString(),\n-                    orphan_wtxid.ToString(),\n-                    peer.m_id,\n-                    state.ToString());\n-                LogPrint(BCLog::MEMPOOLREJ, \"%s (wtxid=%s) from peer=%d was not accepted: %s\\n\",\n-                    orphanHash.ToString(),\n-                    orphan_wtxid.ToString(),\n-                    peer.m_id,\n-                    state.ToString());\n-                // Maybe punish peer that gave us an invalid orphan tx\n-                MaybePunishNodeForTx(peer.m_id, state);\n-            }\n-            // Has inputs but not accepted to mempool\n-            // Probably non-standard or insufficient fee\n-            LogPrint(BCLog::TXPACKAGES, \"   removed orphan tx %s (wtxid=%s)\\n\", orphanHash.ToString(), orphan_wtxid.ToString());\n-            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n-                // We can add the wtxid of this transaction to our reject filter.\n-                // Do not add txids of witness transactions or witness-stripped\n-                // transactions to the filter, as they can have been malleated;\n-                // adding such txids to the reject filter would potentially\n-                // interfere with relay of valid transactions from peers that\n-                // do not support wtxid-based relay. See\n-                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n-                // We can remove this restriction (and always add wtxids to\n-                // the filter even for witness stripped transactions) once\n-                // wtxid-based relay is broadly deployed.\n-                // See also comments in https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034\n-                // for concerns around weakening security of unupgraded nodes\n-                // if we start doing this too early.\n-                m_recent_rejects.insert(porphanTx->GetWitnessHash().ToUint256());\n-                // If the transaction failed for TX_INPUTS_NOT_STANDARD,\n-                // then we know that the witness was irrelevant to the policy\n-                // failure, since this check depends only on the txid\n-                // (the scriptPubKey being spent is covered by the txid).\n-                // Add the txid to the reject filter to prevent repeated\n-                // processing of this transaction in the event that child\n-                // transactions are later received (resulting in\n-                // parent-fetching by txid via the orphan-handling logic).\n-                if (state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && porphanTx->HasWitness()) {\n-                    // We only add the txid if it differs from the wtxid, to\n-                    // avoid wasting entries in the rolling bloom filter.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523094034",
      "id" : 1523094034,
      "in_reply_to_id" : 1521653628,
      "line" : 3105,
      "node_id" : "PRRC_kwDOABII585ayJIS",
      "original_commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "original_line" : 3130,
      "original_position" : 126,
      "original_start_line" : 3129,
      "path" : "src/net_processing.cpp",
      "position" : 126,
      "pull_request_review_id" : 1933921377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523094034/reactions"
      },
      "side" : "LEFT",
      "start_line" : 3104,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2024-03-13T11:57:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523094034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523094189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523094189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done in #28970",
      "commit_id" : "07cd510ffe791a4dfc1824c67fb440be780a4e2b",
      "created_at" : "2024-03-13T11:57:30Z",
      "diff_hunk" : "@@ -4276,24 +4301,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         const TxValidationState& state = result.m_state;\n \n         if (result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-            // As this version of the transaction was acceptable, we can forget about any\n-            // requests for it.\n-            m_txrequest.ForgetTxHash(tx.GetHash());\n-            m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash());\n-            m_orphanage.AddChildrenToWorkSet(tx);\n-\n+            ProcessValidTx(pfrom.GetId(), ptx, result.m_replaced_transactions.value());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29619#discussion_r1523094189",
      "id" : 1523094189,
      "in_reply_to_id" : 1519819257,
      "line" : 4335,
      "node_id" : "PRRC_kwDOABII585ayJKt",
      "original_commit_id" : "9353aa4066a85705154800efa61c5601036be921",
      "original_line" : 4304,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 205,
      "pull_request_review_id" : 1933921377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29619",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523094189/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-13T11:57:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1523094189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
