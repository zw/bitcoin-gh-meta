{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "I noticed while debugging #24230 that the `ChainStateFlushed` notification can be sent with a locator pointing to a different block than the block in the last `BlockConnected` notification. This is bad because it could cause the wallet to record that it is synced to a later block than it ever processed, and make it potentially fail to scan blocks for relevant transactions if it is unloaded and reloaded.\r\n\r\nThis problem should probably not happen in practice, because normally the locator in the `ChainStateFlushed` notification does point to the block sent in the last `BlockConnected` notification. But because of the way `ActivateBestChain` accumulates block connected notifications, and the fact that `FlushStateToDisk` is called from many different code paths, this isn't guaranteed. (The new assumeutxo logic also introduces a situation where this is never the case: when the background chain reaches the snapshot height and validates the snapshot, the background chain is flushed before block connected notifications are sent.)\r\n\r\nIn any case, it is better if the wallet writes a locator actually pointing to the last block that it processed instead of writing the locator validation code passes to `ChainStateFlushed`, so this commit switches to the right locator.\r\n\r\nA good followup to this change would probably be to drop the `ChainStateFlushed` locator argument entirely so it is not misused in the future. Indexing code already stopped using this locator argument a long time ago for identifying the best block (in 4368384f1d267b011e03a805f934f5c47e2ca1b2 from #14121), but it is still using the locator argument to log diagnostic warnings.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29652/comments",
   "created_at" : "2024-03-14T17:30:23Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29652/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/29652",
   "id" : 2186906515,
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      },
      {
         "color" : "cccccc",
         "default" : false,
         "description" : "",
         "id" : 5334691551,
         "name" : "CI failed",
         "node_id" : "LA_kwDOABII588AAAABPfju3w",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29652/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585pqQpc",
   "number" : 29652,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/29652.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29652",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/29652.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29652"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29652/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29652/timeline",
   "title" : "wallet: Avoid potentially writing incorrect best block locator",
   "updated_at" : "2024-03-14T18:42:57Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29652",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
      "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
      "followers_url" : "https://api.github.com/users/ryanofsky/followers",
      "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/ryanofsky",
      "id" : 7133040,
      "login" : "ryanofsky",
      "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
      "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
      "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
      "repos_url" : "https://api.github.com/users/ryanofsky/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/ryanofsky"
   }
}
