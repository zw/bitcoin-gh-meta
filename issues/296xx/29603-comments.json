[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hi @reivanen, thanks for your report.\r\n\r\nIt is documented in https://github.com/bitcoin/bitcoin/blob/master/doc/reduce-memory.md#in-memory-caches that higher dbcache settings give better IBD performance, and I think it stands to reason that this effect would be more pronounced on slower hardware.\r\n\r\nI do agree though that it could be stated more clearly (other than in a doc titled \"reduce memory\") that this known effect occurs.\r\n\r\nThere is also a somewhat-related [PR open ](https://github.com/bitcoin/bitcoin/pull/28358)to increase the maximum dbcache value, to further speed up IBD.\r\n\r\nIn my opinion the current program model of having a constrained memory footprint is preferable to making it unconstrained. If you want to speed up IDB then you can temporarily increase your cache size (to another known maximum size), and after IDB is complete and you are in sync, the (known) memory constraints make Bitcoin Core a more stable program to run and use overall.\r\n\r\nAdditionally, having the program notified that \"memory is running out\" is often more simply said-than-done, usually requiring workarounds which also in turn can make other internals harder to reason about than fixed sizes.\r\n\r\nI have a spinning HDD so may get around to try your cache size cutoff and see if I can also notice the performance differences you mention.",
      "created_at" : "2024-03-08T17:01:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986067957",
      "id" : 1986067957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852YP31",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986067957/reactions"
      },
      "updated_at" : "2024-03-08T17:01:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986067957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "This is not just an issue of \"better performance with larger dbcache\" but a completely different way of working (depending on how much dbcache is used of total allocated?).\r\n\r\nI tested by increasing the network speed to 2MB/s. It worked as good as with 1, HDD was more than able to keep up. Until RAM usage had gone to around 8000 used from 8500 total, then the 100% IO READ started and download happening only a fraction of the time. Restart bitcoin, and it continues to download at 2MB/s continuously, presumably until 8 gigs of ram has filled.\r\n\r\nSo after these data points i don't see any other easy \"fix\" than making the default dbcache size large enough to properly process segwit blocks, and then purge the cache every time it is starting to fill up, before the \"phase change\" happens in cache behavior.\r\n\r\nI should not need to periodically restart bitcoin to make it work properly. (also it seems like the source i read is outdated, because currently the whole chainstate does not seem to fit into 8 gigs and it starts throttling DL speed due to the random reads. I will test with dbcache 10000 if it will finally sync to the end properly.",
      "created_at" : "2024-03-09T10:56:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986824229",
      "id" : 1986824229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852bIgl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986824229/reactions"
      },
      "updated_at" : "2024-03-09T12:26:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986824229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6353462?v=4",
         "events_url" : "https://api.github.com/users/reivanen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/reivanen/followers",
         "following_url" : "https://api.github.com/users/reivanen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/reivanen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/reivanen",
         "id" : 6353462,
         "login" : "reivanen",
         "node_id" : "MDQ6VXNlcjYzNTM0NjI=",
         "organizations_url" : "https://api.github.com/users/reivanen/orgs",
         "received_events_url" : "https://api.github.com/users/reivanen/received_events",
         "repos_url" : "https://api.github.com/users/reivanen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/reivanen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/reivanen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/reivanen"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "One more data point came to mind: this seems to be related to segwit?\r\n\r\nBecause i was able to properly process the blockchain until around segwit activation using 450MB dbcache. But after that even 8500 dbcache was not enough, but started throttling as it (or RAM) came close to filling up.",
      "created_at" : "2024-03-09T11:16:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986828626",
      "id" : 1986828626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852bJlS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986828626/reactions"
      },
      "updated_at" : "2024-03-09T12:28:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986828626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6353462?v=4",
         "events_url" : "https://api.github.com/users/reivanen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/reivanen/followers",
         "following_url" : "https://api.github.com/users/reivanen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/reivanen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/reivanen",
         "id" : 6353462,
         "login" : "reivanen",
         "node_id" : "MDQ6VXNlcjYzNTM0NjI=",
         "organizations_url" : "https://api.github.com/users/reivanen/orgs",
         "received_events_url" : "https://api.github.com/users/reivanen/received_events",
         "repos_url" : "https://api.github.com/users/reivanen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/reivanen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/reivanen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/reivanen"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@reivanen is you node pruned? If it is, make sure to test on a recent version of master - #20827 may have improved performance for pruned nodes.\r\n\r\nIf your node is not pruned, then #28358 should help, but only until you run out of RAM (and if you don't there may be diminishing returns).\r\n\r\nThe `-dbcache` feature reduces frequent disk _writes_, because it delays the process of writing new coins to disk. If you use it all the way through IBD, then it also reduces disk _reads_, since all the coins you created are in RAM.\r\n\r\nOnce you run out of RAM the cache is flushed. So from that point onwards you still have the benefit of fewer writes (it waits until the next flush), but for reading you have to fetch coins from disk (unless the coins are from after the last flush, in which case they're in RAM).\r\n\r\n> I tried increasing db cache by 2x to 900MB, but absolutely nothing changed. RAM usage etc. same.\r\n\r\nThe RAM is only used when needed. So it takes a while before you should see a difference.\r\n\r\n> even a device with only 3 gigs of ram can use a value of 8500\r\n\r\nYou would run of out of memory and crash once dbcache grows beyond the size of your RAM.\r\n\r\nBefore that, things may grind to a halt if you have swap configured; your operating system will start writing RAM to disk, defeating the purpose of `-dbcache`. I'm not sure at what point that kicks in. But for benchmarking you may want to turn swap off.\r\n\r\n> Until RAM usage had gone to around 8000 used from 8500 total, then the 100% IO READ started and download happening only a fraction of the time.\r\n\r\nIf you're pushing this close to the limit of your machine, swap might be the reason it slows down (and you're risking a crash). ",
      "created_at" : "2024-03-11T11:48:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1988257599",
      "id" : 1988257599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852gmc_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988257599/reactions"
      },
      "updated_at" : "2024-03-11T11:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988257599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "i'm not running pruned.\r\n\r\nI did indeed turn off swap as first mitigation to see what is actually going on with RAM usage.\r\n\r\nFrom what you wrote it's curious why restarting bitcoin-qt will allow for it to continue syncing at high speed until dbcache fills up.",
      "created_at" : "2024-03-11T22:26:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1989553030",
      "id" : 1989553030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852liuG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1989553030/reactions"
      },
      "updated_at" : "2024-03-11T22:26:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1989553030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6353462?v=4",
         "events_url" : "https://api.github.com/users/reivanen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/reivanen/followers",
         "following_url" : "https://api.github.com/users/reivanen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/reivanen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/reivanen",
         "id" : 6353462,
         "login" : "reivanen",
         "node_id" : "MDQ6VXNlcjYzNTM0NjI=",
         "organizations_url" : "https://api.github.com/users/reivanen/orgs",
         "received_events_url" : "https://api.github.com/users/reivanen/received_events",
         "repos_url" : "https://api.github.com/users/reivanen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/reivanen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/reivanen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/reivanen"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Because if your dbcache is no longer in RAM but in swap on disk, it's going to slow down. When you restart dbcache is empty, so it's in RAM. Until it fills again and your OS moves it to swap. That's my theory anyway, you'd have to check if that's what's happening.",
      "created_at" : "2024-03-12T08:16:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1991010152",
      "id" : 1991010152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852rGdo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991010152/reactions"
      },
      "updated_at" : "2024-03-12T08:16:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991010152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, if you set dbcache higher than RAM available then the OS should start swapping it out when it runs out of (real) RAM. This should be expected to have bad performance because you are not using RAM cache for as much of the time as possible, and you become reliant on manually flushing the cache by restarting Bitcoin Core manually.\r\n\r\nIn the case that dbcache is set lower than available RAM, Bitcoin Core will process until the cache is filled, then flush it all to disk, largely emptying it's (fast, RAM) cache again. This should provide better performance, analagous to how you noticed that \"manually\" emptying the cache (by restarting bitcoind) did.\r\n\r\nBecause I was curious about the spinning disk speed I left a node syncing from a single LAN connection last night. This had a 7200rpm HDD and bitcoind used default settings apart from the following:\r\n\r\n```txt\r\ndaemon=1\r\nport=18833\r\nrpcport=18832\r\nblocksonly=1\r\nconnect=localhost:8833\r\n```\r\nThis implies a dbcache of 450MB.\r\n\r\nI plotted the times which blocks were processed according to the logfile in matplotlib, also marking segwit activation height:\r\n\r\n![spinning_IBD_529122](https://github.com/bitcoin/bitcoin/assets/6606587/b17419f8-bc0f-418b-849e-4f28ae27b78f)\r\n\r\nI also marked with red dots blocks who had an interval > 30 seconds from the last block, which in some cases might indicate cache flushes, but I did not log cache flushes so can't be sure.\r\n\r\nIt does not appear to me from the shape of the graph that there's any specific issue with segwit activation height and block processing times on IBD with default settings on a spinning disk. Rather the slope seems to follow general levels of the chains usage, which seems entriely in line with expectations.",
      "created_at" : "2024-03-12T09:09:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1991104111",
      "id" : 1991104111,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852rdZv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991104111/reactions"
      },
      "updated_at" : "2024-03-12T09:09:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991104111",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
