[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29671).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-03-17T19:39:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29671#issuecomment-2002592487",
      "id" : 2002592487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29671",
      "node_id" : "IC_kwDOABII5853XSLn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2002592487/reactions"
      },
      "updated_at" : "2024-03-18T01:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2002592487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Isn't more natural to move the last locator update to the end of the loop?\r\n\r\nI know what you mean by \"more natural\" but it requires a bigger change because 1. `pindex` is initially a `nullptr`, so either we have to set it before the loop when we do this change or add even more checks in the loop. And 2. we are also checking at the same time as updating `pindex` if we are synced already (no next `pindex`), and we would want to keep doing that at the beginning of the loop even if we update `pindex` later.\r\n\r\nMaybe there is a simpler way to do this refactoring but I am not seeing it right now :)",
      "created_at" : "2024-03-18T15:18:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29671#issuecomment-2004195609",
      "id" : 2004195609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29671",
      "node_id" : "IC_kwDOABII5853dZkZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2004195609/reactions"
      },
      "updated_at" : "2024-03-18T15:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2004195609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Maybe there is a simpler way to do this refactoring but I am not seeing it right now :)\r\n\r\nWhy this is not possible?\r\n```diff\r\ndiff --git a/src/index/base.cpp b/src/index/base.cpp\r\n--- a/src/index/base.cpp\t(revision aefa9a8fca467ffb26466741f0b6b90289d92e20)\r\n+++ b/src/index/base.cpp\t(date 1710785794630)\r\n@@ -184,13 +184,6 @@\r\n                 last_log_time = current_time;\r\n             }\r\n \r\n-            if (pindex->pprev && last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {\r\n-                SetBestBlockIndex(pindex->pprev);\r\n-                last_locator_write_time = current_time;\r\n-                // No need to handle errors in Commit. See rationale above.\r\n-                Commit();\r\n-            }\r\n-\r\n             CBlock block;\r\n             interfaces::BlockInfo block_info = kernel::MakeBlockInfo(pindex);\r\n             if (!m_chainstate->m_blockman.ReadBlockFromDisk(block, *pindex)) {\r\n@@ -205,6 +198,13 @@\r\n                            __func__, pindex->GetBlockHash().ToString());\r\n                 return;\r\n             }\r\n+\r\n+            if (last_locator_write_time + SYNC_LOCATOR_WRITE_INTERVAL < current_time) {\r\n+                SetBestBlockIndex(pindex);\r\n+                last_locator_write_time = current_time;\r\n+                // No need to handle errors in Commit. See rationale above.\r\n+                Commit();\r\n+            }\r\n         }\r\n     }\r\n \r\n\r\n```",
      "created_at" : "2024-03-18T18:28:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29671#issuecomment-2004645143",
      "id" : 2004645143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29671",
      "node_id" : "IC_kwDOABII5853fHUX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2004645143/reactions"
      },
      "updated_at" : "2024-03-18T18:28:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2004645143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Why this is not possible?\r\n\r\nThat works. I misunderstood your comment before, I thought by locator you meant `pindex` and wanted me to move that to the end to avoid the `pprev` stuff. All good now.",
      "created_at" : "2024-03-18T21:23:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29671#issuecomment-2005016285",
      "id" : 2005016285,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29671",
      "node_id" : "IC_kwDOABII5853gh7d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2005016285/reactions"
      },
      "updated_at" : "2024-03-18T21:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2005016285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
