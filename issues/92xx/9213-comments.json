[
   {
      "body" : "Agree that the stalling logic needs some fine tuning. I am pretty sure\nI hit the scenario you describe above when debugging #8518.\n",
      "created_at" : "2016-11-23T18:08:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9213#issuecomment-262590142",
      "id" : 262590142,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9213",
      "updated_at" : "2016-11-23T18:08:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/262590142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "#9337 shows some additional debug which may help here. Esssentially the current timeout logic is completely ignoring the fact that blocks are being downloaded, albeit more slowly than expected, and the current timeout on stallers is only 2 seconds - i.e. if it remains the node that is being waited on for more than 2 seconds (which is very likely) it gets disconnected. What is needed is extra logic to determine the speed of each peer and factor this in to the number of blocks being requested from each peer. I wrote code back in 2012 which did this, but it wasn't up to the standards needed to get it merged. (probably \"layer violations\").\r\n\r\nWithout the logic I am suggesting then it is often likely that nodes will become staller nodes. Part of the problem is that blocks are not \"striped\" amongst nodes, but instead are tasked with a bunch of consequtive blocks which makes occurrence of \"staller nodes\" far more likely.\r\n\r\nWhat I propose is that when the node starts up , as soon as it has calculated how many blocks behind it is, it works out how to spread these blocks over the nodes it will download them from. E.g. if it will be downlaoding from 6 peers, then it could skip 5 blocks for block height it requests from each node. This could be the initial logic, but if there is a lot to download, additional logic would also factor in the speed of each connection.",
      "created_at" : "2016-12-13T03:55:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9213#issuecomment-266634172",
      "id" : 266634172,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9213",
      "updated_at" : "2016-12-13T04:01:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266634172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Ok, have already been testing the above commit and it seems to work - it doesn't change the staller logic, but it will reduce it being invoked.",
      "created_at" : "2016-12-13T04:39:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/9213#issuecomment-266638909",
      "id" : 266638909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9213",
      "updated_at" : "2016-12-13T04:39:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266638909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
