[
   {
      "body" : "Is this related to #7488 as well?",
      "created_at" : "2016-02-20T21:45:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-186685821",
      "id" : 186685821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-02-20T21:45:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/186685821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "@btcdrak I believe so.",
      "created_at" : "2016-02-20T22:17:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-186691718",
      "id" : 186691718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-02-20T22:17:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/186691718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Oh yes, that was actually what prompted me.  I've asked Meni Rosenfeld and another person who ran simulations to comment.",
      "created_at" : "2016-02-20T22:52:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-186696716",
      "id" : 186696716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-02-20T22:52:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/186696716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "We use an arbitrary threshold of a once-in-fifty-years event.  We don't need to use a second arbitrary parameter for the sample interval.\r\n\r\nUpdated to sample at 130-minute intervals, instead of 240 minutes.  This is the minimum interval required for an observation of zero blocks to happen spuriously less than once in fifty years.  The high-side check works out to 33 or more blocks in 130 minutes.\r\n",
      "created_at" : "2016-02-23T01:52:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-187473848",
      "id" : 187473848,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-02-23T01:52:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/187473848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "The math is correct, i.e. the false positive rate is once every ~ 50 years assuming an average block time of 10 min. To be clear, this is the combined (two-sided) alert rate; the one-sided alerts (pHigh or pLow) have individual rates of every ~ 100 years.\r\n\r\nThis is in contrast to the original code, which from [simulation](https://gist.github.com/bitcoinfees/0f2203bdced119b98c30), gives an alert rate of ~ 3.5 years.\r\n\r\nAdditional statistics: assuming the block rate deviates from the proof-of-work target by 20% (due to changing hash rate), then pHigh / pLow will have rates of once per 3 / 8 years respectively, which seems reasonable.  If this is deemed too high, the test can be modified to allow for deviations up to a specified amount.\r\n\r\nThe other significant change here is that the test spans are made non-overlapping, and their frequency is reduced from once per 10 minutes to once per 130 minutes. This unfortunately reduces the potential statistical power (the ability to correctly detect an anomaly), and also adds latency to the alerts.\r\n\r\nThe main reason for this change is that is not trivial to determine the threshold for overlapping spans. It can be done by simulation, but that's not as a good as the closed-form solution that you would get for non-overlapping spans.",
      "created_at" : "2016-02-25T02:27:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-188570371",
      "id" : 188570371,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-02-25T02:27:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/188570371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/9492819?v=3",
         "events_url" : "https://api.github.com/users/bitcoinfees/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoinfees/followers",
         "following_url" : "https://api.github.com/users/bitcoinfees/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoinfees/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoinfees",
         "id" : 9492819,
         "login" : "bitcoinfees",
         "organizations_url" : "https://api.github.com/users/bitcoinfees/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoinfees/received_events",
         "repos_url" : "https://api.github.com/users/bitcoinfees/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoinfees/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoinfees/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitcoinfees"
      }
   },
   {
      "body" : "Concept ACK",
      "created_at" : "2016-03-07T19:31:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-193412955",
      "id" : 193412955,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-03-07T19:31:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/193412955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7568#discussion_r55281283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7568"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/55281283"
         }
      },
      "body" : "It took me a while to understand this, with PartitionCheck called once as the scheduled function, and once specially to determine the frequency.\r\n\r\nWouldn't it be easy to just schedule it once, and have each invocation schedule its own next call? That way the interval cal also be made dynamic more easily.",
      "commit_id" : "580aaa36a0f424b8d7af17ed6bc2c6e48febd842",
      "created_at" : "2016-03-07T22:07:22Z",
      "diff_hunk" : "@@ -1672,7 +1672,8 @@ bool AppInit2(boost::thread_group& threadGroup, CScheduler& scheduler)\n     int64_t nPowTargetSpacing = Params().GetConsensus().nPowTargetSpacing;\n     CScheduler::Function f = boost::bind(&PartitionCheck, &IsInitialBlockDownload,\n                                          boost::ref(cs_main), boost::cref(pindexBestHeader), nPowTargetSpacing);\n-    scheduler.scheduleEvery(f, nPowTargetSpacing);\n+    CBlockIndex *pdummy = NULL;\n+    scheduler.scheduleEvery(f, PartitionCheck(&IsInitialBlockDownload, boost::ref(cs_main), boost::cref(pdummy), nPowTargetSpacing));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#discussion_r55281283",
      "id" : 55281283,
      "original_commit_id" : "580aaa36a0f424b8d7af17ed6bc2c6e48febd842",
      "original_position" : 6,
      "path" : "src/init.cpp",
      "position" : 6,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7568",
      "updated_at" : "2016-03-07T22:07:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/55281283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7568#discussion_r55298715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7568"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/55298715"
         }
      },
      "body" : "I did this just to keep the constants out of global scope, which would probably be more readable.  A drawback of constant rescheduling would be some drift, probably not much.",
      "commit_id" : "580aaa36a0f424b8d7af17ed6bc2c6e48febd842",
      "created_at" : "2016-03-08T00:35:52Z",
      "diff_hunk" : "@@ -1672,7 +1672,8 @@ bool AppInit2(boost::thread_group& threadGroup, CScheduler& scheduler)\n     int64_t nPowTargetSpacing = Params().GetConsensus().nPowTargetSpacing;\n     CScheduler::Function f = boost::bind(&PartitionCheck, &IsInitialBlockDownload,\n                                          boost::ref(cs_main), boost::cref(pindexBestHeader), nPowTargetSpacing);\n-    scheduler.scheduleEvery(f, nPowTargetSpacing);\n+    CBlockIndex *pdummy = NULL;\n+    scheduler.scheduleEvery(f, PartitionCheck(&IsInitialBlockDownload, boost::ref(cs_main), boost::cref(pdummy), nPowTargetSpacing));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#discussion_r55298715",
      "id" : 55298715,
      "original_commit_id" : "580aaa36a0f424b8d7af17ed6bc2c6e48febd842",
      "original_position" : 6,
      "path" : "src/init.cpp",
      "position" : 6,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7568",
      "updated_at" : "2016-03-08T00:35:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/55298715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "In case it's still relevant, here's one issue that came up in my discussions with dgenr8:\r\n\r\nAs far as I understand, the test is conducted at 4 hour intervals after the node starts. With the computed threshold and assuming constant hashrate, the fail-high (>=33 blocks in 120 minutes) should trigger for this node every ~100 years.\r\n\r\nHowever, this is not the only node on the network; and different nodes start at different times, and so they sample on different schedules. So there are more opportunities for the alarm to be falsely triggered somewhere on the network.\r\n\r\nSo if the event we are trying to prevent is \"hashrate is constant and yet an alarm is triggered somewhere on the network\" then this is no better than the original method where each node sampled continuously (because the network as a whole sampled continuously). For the new parameters, I estimate it will trigger every ~18 years (I haven't run simulations yet).\r\n\r\nOn top of that we have the added confusion of some nodes reporting an alarm while others do not.\r\n\r\nIt would make more sense to me if each node tested for the alarm once when it starts, and then on a 4-hour schedule which is the same for all nodes.",
      "created_at" : "2016-03-15T22:16:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-197049602",
      "id" : 197049602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-03-15T22:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/197049602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/822642?v=3",
         "events_url" : "https://api.github.com/users/MeniRosenfeld/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeniRosenfeld/followers",
         "following_url" : "https://api.github.com/users/MeniRosenfeld/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeniRosenfeld/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeniRosenfeld",
         "id" : 822642,
         "login" : "MeniRosenfeld",
         "organizations_url" : "https://api.github.com/users/MeniRosenfeld/orgs",
         "received_events_url" : "https://api.github.com/users/MeniRosenfeld/received_events",
         "repos_url" : "https://api.github.com/users/MeniRosenfeld/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeniRosenfeld/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeniRosenfeld/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeniRosenfeld"
      }
   },
   {
      "body" : "@MeniRosenfeld What will happen is a more severe problem that lasts longer will get more nodes reporting it, while a shorter-lived problem will get fewer nodes reporting it.  It's similar to different nodes seeing different resolutions to block races, in proportion to the closeness of the race.\r\n\r\nSynchronizing the checks network-wide can't be a good idea.  Also, we must not check at startup because the last check may have been less than 130 minutes ago.",
      "created_at" : "2016-03-30T23:06:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7568#issuecomment-203676136",
      "id" : 203676136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7568",
      "updated_at" : "2016-03-30T23:23:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/203676136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   }
]
