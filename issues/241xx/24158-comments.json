[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25290](https://github.com/bitcoin/bitcoin/pull/25290) ([kernel 3a/n] Decouple `CTxMemPool` from `ArgsManager` by dongcarl)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-26T23:53:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1022710490",
      "id" : 1022710490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII58489VLa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022710490/reactions"
      },
      "updated_at" : "2022-06-27T20:04:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022710490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "What is the relationship of this PR to your #18191? Just judging from the title, they seem to do very similar things, although the code changes are not the same.",
      "created_at" : "2022-02-16T19:49:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1042101831",
      "id" : 1042101831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII584-HTZH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042101831/reactions"
      },
      "updated_at" : "2022-02-16T19:49:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042101831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "They were split out from an initial patch set to make it easier to review.\r\n\r\n#18191 is the component which has some behavioral change, #24158 is a pure optimization.",
      "created_at" : "2022-02-16T19:59:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1042110112",
      "id" : 1042110112,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII584-HVag",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042110112/reactions"
      },
      "updated_at" : "2022-02-16T19:59:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042110112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "see the pr description of #18191\r\n\r\n> There's potential for a better -- but more sophisticated -- algorithm that can be used taking advantage of epochs, but I figured it is better to do something that is simple and works first and upgrade it later as the other epoch mempool work proceeds as it makes the patches for the epoch algorithm simpler to understand, so you can consider this as preparatory work. It could either go in now if it is not controversial, or we could wait until the other patch is ready to go.",
      "created_at" : "2022-02-16T20:01:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1042111972",
      "id" : 1042111972,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII584-HV3k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042111972/reactions"
      },
      "updated_at" : "2022-02-16T20:01:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042111972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> see the pr description of #18191\r\n\r\nThat's from #21464 which was merged, my question is about the older #18191.",
      "created_at" : "2022-02-16T20:14:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1042123094",
      "id" : 1042123094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII584-HYlW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042123094/reactions"
      },
      "updated_at" : "2022-02-16T20:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042123094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "oh oops.\r\n\r\nuh yeah TBH I forgot I had that other PR open.\r\n\r\nThey should be mostly the same.\r\n\r\nThe main difference is the earlier one also applies an optimization getting rid of setExclude and just using the cache line presence instead, which ends up being redundant with the setExclude.\r\n\r\nWe can add that optimization as a separate PR since it's a little bit less obvious why it works, I left it out when I rewrote this one.",
      "created_at" : "2022-02-16T20:28:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1042219410",
      "id" : 1042219410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII584-HwGS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042219410/reactions"
      },
      "updated_at" : "2022-02-16T20:28:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042219410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808939277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808939277"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't you first look for `descendant` in `cachedDescendants` before fetching its children? If its descendant set is available there, you wasted a cycle looking at the first generation.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-17T11:15:52Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808939277",
      "id" : 808939277,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII584wN28N",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 144,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 40,
      "pull_request_review_id" : 874762333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808939277/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-17T12:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808939277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808951139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808951139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC, you're swapping here in order to insert all of the descendants between this child and the next entry in the descendants vector, so you can just increment `i` to skip to the next child in the same generation. Note that you're still moving everything downwards n times where n is the number of cached descendants.\r\nApproach-wise, perhaps a `std::deque` (linked list) is more appropriate if you really want the constant time insert at arbitrary position. Also, I'm not too familiar with the implementation of `std::vector`, but I feel like it should be optimized enough for you to feel okay using `insert(i+1)` without using swaps. It might even do that in the background.\r\n\r\nAlso, please add a comment because it was not immediately obvious that you're doing swaps to maintain ordering.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-17T11:30:56Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808951139",
      "id" : 808951139,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII584wN51j",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 156,
      "original_position" : 52,
      "original_start_line" : 154,
      "path" : "src/txmempool.cpp",
      "position" : 52,
      "pull_request_review_id" : 874762333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808951139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 154,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-17T12:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808951139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808951919"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808951919"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is the purpose of `i` here? You're re-assigning it later anyway.\r\n\r\nAlso, why can't you just do a `std::transform` from `children` to populate `descendants`?",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-17T11:31:59Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808951919",
      "id" : 808951919,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII584wN6Bv",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 132,
      "original_position" : 28,
      "original_start_line" : 128,
      "path" : "src/txmempool.cpp",
      "position" : 28,
      "pull_request_review_id" : 874762333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808951919/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 128,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-17T12:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808951919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808953118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808953118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is an appropriate use of epochs, but I think it's important to document what `visit`ing an entry means. IIUC, in this context it means you've added this entry to the `descendants` vector.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-17T11:33:33Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808953118",
      "id" : 808953118,
      "line" : 135,
      "node_id" : "PRRC_kwDOABII584wN6Ue",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 135,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 31,
      "pull_request_review_id" : 874762333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808953118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-17T12:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808953118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808967963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808967963"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would using `std::shrink_to_fit()` https://www.cplusplus.com/reference/vector/vector/shrink_to_fit/ \"guarantee we trim\" or no?",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-17T11:52:43Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }\n+                            // skip processing this element\n+                            ++i;\n+                        }\n+                    }\n+                } else if (!visited(mapTx.iterator_to(childEntry))) {\n+                    // Schedule for later processing\n+                    descendants.emplace_back(mapTx.iterator_to(childEntry));\n+                    ++n_to_process;\n                 }\n-            } else if (!descendants.count(childEntry)) {\n-                // Schedule for later processing\n-                stageEntries.insert(childEntry);\n             }\n         }\n-    }\n+    } // release epoch\n+\n+    // remove any descendants that are in setExclude\n+    auto included_upto = std::remove_if(descendants.begin(), descendants.end(),\n+            [&](txiter it) {\n+                return setExclude.count(it->GetTx().GetHash());\n+            });\n+\n+    // if none remain, we don't have to do any updating\n+    if (included_upto == descendants.begin()) return;\n+\n     // descendants now contains all in-mempool descendants of updateIt.\n     // Update and add to cached descendant map\n     int64_t modifySize = 0;\n     CAmount modifyFee = 0;\n     int64_t modifyCount = 0;\n-    for (const CTxMemPoolEntry& descendant : descendants) {\n-        if (!setExclude.count(descendant.GetTx().GetHash())) {\n-            modifySize += descendant.GetTxSize();\n-            modifyFee += descendant.GetModifiedFee();\n-            modifyCount++;\n-            cachedDescendants[updateIt].insert(mapTx.iterator_to(descendant));\n-            // Update ancestor state for each descendant\n-            mapTx.modify(mapTx.iterator_to(descendant), update_ancestor_state(updateIt->GetTxSize(), updateIt->GetModifiedFee(), 1, updateIt->GetSigOpCost()));\n-            // Don't directly remove the transaction here -- doing so would\n-            // invalidate iterators in cachedDescendants. Mark it for removal\n-            // by inserting into descendants_to_remove.\n-            if (descendant.GetCountWithAncestors() > ancestor_count_limit || descendant.GetSizeWithAncestors() > ancestor_size_limit) {\n-                descendants_to_remove.insert(descendant.GetTx().GetHash());\n-            }\n+    // Note: the below contains code which does some hacks to keep memory tight.\n+    // it could be improved in the future to detect if the vector is already tight\n+    // and then directly move it to cachedDescendants. For simplicity, we just\n+    // do a copy for now.\n+\n+    // emplace into a new vector to guarantee we trim memory\n+    const auto& it = cachedDescendants.emplace(std::piecewise_construct,\n+            std::forward_as_tuple(updateIt),\n+            std::forward_as_tuple(descendants.begin(), included_upto));\n+    // swap with descendants to release it early!\n+    std::vector<txiter>().swap(descendants);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808967963",
      "id" : 808967963,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII584wN98b",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 194,
      "original_position" : 108,
      "original_start_line" : 184,
      "path" : "src/txmempool.cpp",
      "position" : 108,
      "pull_request_review_id" : 874762333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808967963/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 184,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-17T12:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808967963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808974643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808974643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "actually it might make more sense to resize to the children's aggregated descendant counts. You could overestimate, but there's most likely even fewer resizes.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-17T12:01:27Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r808974643",
      "id" : 808974643,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII584wN_kz",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 127,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 23,
      "pull_request_review_id" : 874762333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808974643/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-17T12:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808974643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r809932699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809932699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also I'm curious as to why it's necessary to free this memory here. We don't need to allocate anything in the rest of the function, and `descendants` goes out of scope when we return.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-18T11:54:36Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }\n+                            // skip processing this element\n+                            ++i;\n+                        }\n+                    }\n+                } else if (!visited(mapTx.iterator_to(childEntry))) {\n+                    // Schedule for later processing\n+                    descendants.emplace_back(mapTx.iterator_to(childEntry));\n+                    ++n_to_process;\n                 }\n-            } else if (!descendants.count(childEntry)) {\n-                // Schedule for later processing\n-                stageEntries.insert(childEntry);\n             }\n         }\n-    }\n+    } // release epoch\n+\n+    // remove any descendants that are in setExclude\n+    auto included_upto = std::remove_if(descendants.begin(), descendants.end(),\n+            [&](txiter it) {\n+                return setExclude.count(it->GetTx().GetHash());\n+            });\n+\n+    // if none remain, we don't have to do any updating\n+    if (included_upto == descendants.begin()) return;\n+\n     // descendants now contains all in-mempool descendants of updateIt.\n     // Update and add to cached descendant map\n     int64_t modifySize = 0;\n     CAmount modifyFee = 0;\n     int64_t modifyCount = 0;\n-    for (const CTxMemPoolEntry& descendant : descendants) {\n-        if (!setExclude.count(descendant.GetTx().GetHash())) {\n-            modifySize += descendant.GetTxSize();\n-            modifyFee += descendant.GetModifiedFee();\n-            modifyCount++;\n-            cachedDescendants[updateIt].insert(mapTx.iterator_to(descendant));\n-            // Update ancestor state for each descendant\n-            mapTx.modify(mapTx.iterator_to(descendant), update_ancestor_state(updateIt->GetTxSize(), updateIt->GetModifiedFee(), 1, updateIt->GetSigOpCost()));\n-            // Don't directly remove the transaction here -- doing so would\n-            // invalidate iterators in cachedDescendants. Mark it for removal\n-            // by inserting into descendants_to_remove.\n-            if (descendant.GetCountWithAncestors() > ancestor_count_limit || descendant.GetSizeWithAncestors() > ancestor_size_limit) {\n-                descendants_to_remove.insert(descendant.GetTx().GetHash());\n-            }\n+    // Note: the below contains code which does some hacks to keep memory tight.\n+    // it could be improved in the future to detect if the vector is already tight\n+    // and then directly move it to cachedDescendants. For simplicity, we just\n+    // do a copy for now.\n+\n+    // emplace into a new vector to guarantee we trim memory\n+    const auto& it = cachedDescendants.emplace(std::piecewise_construct,\n+            std::forward_as_tuple(updateIt),\n+            std::forward_as_tuple(descendants.begin(), included_upto));\n+    // swap with descendants to release it early!\n+    std::vector<txiter>().swap(descendants);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r809932699",
      "id" : 809932699,
      "in_reply_to_id" : 808967963,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII584wRpeb",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 194,
      "original_position" : 108,
      "original_start_line" : 184,
      "path" : "src/txmempool.cpp",
      "position" : 108,
      "pull_request_review_id" : 887181840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809932699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 184,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-18T11:54:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809932699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810236818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810236818"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you have it backwards kinda. we do not care about ordering whatsoever, we are keeping a \"partition\" of processed and unprocessed elements.\r\n\r\nessentially we have a queue with processed and unprocessed elements and a pointer to where we should process next.\r\n\r\n```\r\n// start\r\n\r\n[P1 P2 P3 P4 *U5 U6 U7 U8]\r\n\r\n// process element\r\n\r\n[P1 P2 P3 P4 P5 *U6 U7 U8]\r\n\r\n// insert processed element using push back and swap\r\n[P1 P2 P3 P4 P5 *U6 U7 U8 P9]\r\n[P1 P2 P3 P4 P5 *P9 U7 U8 U6]\r\n[P1 P2 P3 P4 P5 P9 *U7 U8 U6]\r\n// insert unprocessed element\r\n[P1 P2 P3 P4 P5 P9 *U7 U8 U6 U10]\r\n```\r\n\r\nIf we were to try to do the same with inserts, it would cause N^2 behavior. As you can see, we also do not preserve order during the swap back approach.\r\n\r\nIf we were to do insert it would look like:\r\n\r\n```\r\n[P1 P2 P3 P4 P5 *U6 U7 U8]\r\n// insert processed element using insert\r\n[P1 P2 P3 P4 P5 *P9 U6 U7 U8 P9]\r\n[P1 P2 P3 P4 P5 P9 *U6 U7 U8 P9]\r\n```\r\n\r\nAnd the shifting would cost O(N).\r\n\r\nDeque is a good data structure, but has an awful lot of extra overhead making it a poor fit for a performance critical code section. One of the key benefits of this approach is that we keep our data structure quick to iterate/add to. \r\n\r\nThe swap approach is O(1) per element added, which is fine. If we used insert / shifting it would be O(N) per element, which would cause a quadratic blowup. \r\n",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-18T18:14:10Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810236818",
      "id" : 810236818,
      "in_reply_to_id" : 808951139,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII584wSzuS",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 156,
      "original_position" : 52,
      "original_start_line" : 154,
      "path" : "src/txmempool.cpp",
      "position" : 52,
      "pull_request_review_id" : 887614415,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810236818/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 154,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-18T18:14:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810236818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810241004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810241004"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "from what you cited:\r\n>The request is non-binding, and the container implementation is free to optimize otherwise and leave the [vector](https://www.cplusplus.com/vector) with a [capacity](https://www.cplusplus.com/vector::capacity) greater than its [size](https://www.cplusplus.com/vector::size).\r\n\r\nIdeally we would be happy trusting our shrink_to_fit, but I'd rather get exactly a trimmed vector here.\r\n\r\nwe do allocate (descendants_to_remove.insert), so it's a cautious approach to free it explicitly when it will never be used again than later.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-18T18:20:43Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }\n+                            // skip processing this element\n+                            ++i;\n+                        }\n+                    }\n+                } else if (!visited(mapTx.iterator_to(childEntry))) {\n+                    // Schedule for later processing\n+                    descendants.emplace_back(mapTx.iterator_to(childEntry));\n+                    ++n_to_process;\n                 }\n-            } else if (!descendants.count(childEntry)) {\n-                // Schedule for later processing\n-                stageEntries.insert(childEntry);\n             }\n         }\n-    }\n+    } // release epoch\n+\n+    // remove any descendants that are in setExclude\n+    auto included_upto = std::remove_if(descendants.begin(), descendants.end(),\n+            [&](txiter it) {\n+                return setExclude.count(it->GetTx().GetHash());\n+            });\n+\n+    // if none remain, we don't have to do any updating\n+    if (included_upto == descendants.begin()) return;\n+\n     // descendants now contains all in-mempool descendants of updateIt.\n     // Update and add to cached descendant map\n     int64_t modifySize = 0;\n     CAmount modifyFee = 0;\n     int64_t modifyCount = 0;\n-    for (const CTxMemPoolEntry& descendant : descendants) {\n-        if (!setExclude.count(descendant.GetTx().GetHash())) {\n-            modifySize += descendant.GetTxSize();\n-            modifyFee += descendant.GetModifiedFee();\n-            modifyCount++;\n-            cachedDescendants[updateIt].insert(mapTx.iterator_to(descendant));\n-            // Update ancestor state for each descendant\n-            mapTx.modify(mapTx.iterator_to(descendant), update_ancestor_state(updateIt->GetTxSize(), updateIt->GetModifiedFee(), 1, updateIt->GetSigOpCost()));\n-            // Don't directly remove the transaction here -- doing so would\n-            // invalidate iterators in cachedDescendants. Mark it for removal\n-            // by inserting into descendants_to_remove.\n-            if (descendant.GetCountWithAncestors() > ancestor_count_limit || descendant.GetSizeWithAncestors() > ancestor_size_limit) {\n-                descendants_to_remove.insert(descendant.GetTx().GetHash());\n-            }\n+    // Note: the below contains code which does some hacks to keep memory tight.\n+    // it could be improved in the future to detect if the vector is already tight\n+    // and then directly move it to cachedDescendants. For simplicity, we just\n+    // do a copy for now.\n+\n+    // emplace into a new vector to guarantee we trim memory\n+    const auto& it = cachedDescendants.emplace(std::piecewise_construct,\n+            std::forward_as_tuple(updateIt),\n+            std::forward_as_tuple(descendants.begin(), included_upto));\n+    // swap with descendants to release it early!\n+    std::vector<txiter>().swap(descendants);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810241004",
      "id" : 810241004,
      "in_reply_to_id" : 808967963,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII584wS0vs",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 194,
      "original_position" : 108,
      "original_start_line" : 184,
      "path" : "src/txmempool.cpp",
      "position" : 108,
      "pull_request_review_id" : 887620164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810241004/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 184,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-18T18:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810241004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810244989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810244989"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "i think you are right on this. The patch here is a 100% behavioral match, but it does seem like one could evade caching a little because we don't check if children are cached. Can you think of any functional differences? (this code is incredibly subtle, so i'm reticent to change it).\r\n",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-18T18:26:39Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810244989",
      "id" : 810244989,
      "in_reply_to_id" : 808939277,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII584wS1t9",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 144,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 40,
      "pull_request_review_id" : 887625677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810244989/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T18:26:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810244989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810247278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810247278"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "i is needed to index descendants which is allocated up front.\r\n\r\nit could be a std::transform I suppose, but I don't think std::transform provides a readability improvement here.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-18T18:29:43Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810247278",
      "id" : 810247278,
      "in_reply_to_id" : 808951919,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII584wS2Ru",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 132,
      "original_position" : 28,
      "original_start_line" : 128,
      "path" : "src/txmempool.cpp",
      "position" : 28,
      "pull_request_review_id" : 887628535,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810247278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 128,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-18T18:29:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810247278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810997869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810997869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> we are keeping a \"partition\" of processed and unprocessed elements.\r\n\r\nYeah that's what I meant by ordering, sorry for being unclear. Thanks for elaborating, this is helpful",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T10:43:57Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r810997869",
      "id" : 810997869,
      "in_reply_to_id" : 808951139,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII584wVtht",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 156,
      "original_position" : 52,
      "original_start_line" : 154,
      "path" : "src/txmempool.cpp",
      "position" : 52,
      "pull_request_review_id" : 888503020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810997869/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 154,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-21T10:43:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810997869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811004575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811004575"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good.\r\n\r\nAnd my other question - what's the point of releasing `descendants` early?",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T10:51:31Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }\n+                            // skip processing this element\n+                            ++i;\n+                        }\n+                    }\n+                } else if (!visited(mapTx.iterator_to(childEntry))) {\n+                    // Schedule for later processing\n+                    descendants.emplace_back(mapTx.iterator_to(childEntry));\n+                    ++n_to_process;\n                 }\n-            } else if (!descendants.count(childEntry)) {\n-                // Schedule for later processing\n-                stageEntries.insert(childEntry);\n             }\n         }\n-    }\n+    } // release epoch\n+\n+    // remove any descendants that are in setExclude\n+    auto included_upto = std::remove_if(descendants.begin(), descendants.end(),\n+            [&](txiter it) {\n+                return setExclude.count(it->GetTx().GetHash());\n+            });\n+\n+    // if none remain, we don't have to do any updating\n+    if (included_upto == descendants.begin()) return;\n+\n     // descendants now contains all in-mempool descendants of updateIt.\n     // Update and add to cached descendant map\n     int64_t modifySize = 0;\n     CAmount modifyFee = 0;\n     int64_t modifyCount = 0;\n-    for (const CTxMemPoolEntry& descendant : descendants) {\n-        if (!setExclude.count(descendant.GetTx().GetHash())) {\n-            modifySize += descendant.GetTxSize();\n-            modifyFee += descendant.GetModifiedFee();\n-            modifyCount++;\n-            cachedDescendants[updateIt].insert(mapTx.iterator_to(descendant));\n-            // Update ancestor state for each descendant\n-            mapTx.modify(mapTx.iterator_to(descendant), update_ancestor_state(updateIt->GetTxSize(), updateIt->GetModifiedFee(), 1, updateIt->GetSigOpCost()));\n-            // Don't directly remove the transaction here -- doing so would\n-            // invalidate iterators in cachedDescendants. Mark it for removal\n-            // by inserting into descendants_to_remove.\n-            if (descendant.GetCountWithAncestors() > ancestor_count_limit || descendant.GetSizeWithAncestors() > ancestor_size_limit) {\n-                descendants_to_remove.insert(descendant.GetTx().GetHash());\n-            }\n+    // Note: the below contains code which does some hacks to keep memory tight.\n+    // it could be improved in the future to detect if the vector is already tight\n+    // and then directly move it to cachedDescendants. For simplicity, we just\n+    // do a copy for now.\n+\n+    // emplace into a new vector to guarantee we trim memory\n+    const auto& it = cachedDescendants.emplace(std::piecewise_construct,\n+            std::forward_as_tuple(updateIt),\n+            std::forward_as_tuple(descendants.begin(), included_upto));\n+    // swap with descendants to release it early!\n+    std::vector<txiter>().swap(descendants);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811004575",
      "id" : 811004575,
      "in_reply_to_id" : 808967963,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII584wVvKf",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 194,
      "original_position" : 108,
      "original_start_line" : 184,
      "path" : "src/txmempool.cpp",
      "position" : 108,
      "pull_request_review_id" : 888511990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811004575/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 184,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-21T10:51:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811004575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811008835"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811008835"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> i is needed to index descendants which is allocated up front\r\n\r\nJust `push_back`, and you don't need to allocate anything",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T10:56:15Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811008835",
      "id" : 811008835,
      "in_reply_to_id" : 808951919,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII584wVwND",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 132,
      "original_position" : 28,
      "original_start_line" : 128,
      "path" : "src/txmempool.cpp",
      "position" : 28,
      "pull_request_review_id" : 888517662,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811008835/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 128,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-21T10:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811008835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811037367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811037367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "By preserve ordering, I merely meant that you're keeping the unprocessed elements behind the processed ones. We're saying the same thing, sorry for being unclear.\r\n\r\n> If we were to try to do the same with inserts, it would cause N^2 behavior.\r\n\r\nSure, this is the case if you're shifting everything per-insert inside the vector. This is why I suggested using a deque, where it's O(1) per element. It'd be the same performance as what you're doing here, except you just call `insert` instead of swapping. But my concerns with the complexity/readability of the code will be gone if you just comment what you're doing here.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T11:31:38Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811037367",
      "id" : 811037367,
      "in_reply_to_id" : 808951139,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII584wV3K3",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 156,
      "original_position" : 52,
      "original_start_line" : 154,
      "path" : "src/txmempool.cpp",
      "position" : 52,
      "pull_request_review_id" : 888556691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811037367/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 154,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-21T11:31:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811037367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811416671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811416671"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yeah deque is same complexity, but it's not the same performance, so it makes sense to continue using a vec even if we have to do a little bit of index management. can add a comment.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T20:38:21Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811416671",
      "id" : 811416671,
      "in_reply_to_id" : 808951139,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII584wXTxf",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 156,
      "original_position" : 52,
      "original_start_line" : 154,
      "path" : "src/txmempool.cpp",
      "position" : 52,
      "pull_request_review_id" : 889085530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811416671/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 154,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-21T20:38:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811416671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811418172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418172"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "if i do a call to reserve instead of the sized constructor https://en.cppreference.com/w/cpp/container/vector/vector, that would work w/o extra allocations.\r\n\r\nthe sized constructor + default insert + indexed insert is a bit better IMO because there are some overheads to push_back/emplace_back in terms of updating the vec bookkeeping that the simple indexed insert above does not have, but it's all something that would need measuring as the compiler probably does an OK job at it.\r\n\r\ndo you have a strong preference around this?",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T20:41:57Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811418172",
      "id" : 811418172,
      "in_reply_to_id" : 808951919,
      "line" : 132,
      "node_id" : "PRRC_kwDOABII584wXUI8",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 132,
      "original_position" : 28,
      "original_start_line" : 128,
      "path" : "src/txmempool.cpp",
      "position" : 28,
      "pull_request_review_id" : 889087412,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418172/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 128,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-21T20:41:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811418425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418425"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> e do allocate (descendants_to_remove.insert), so it's a cautious approach to free it explicitly when it will never be used again than later.",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T20:42:36Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    for (txiter cacheEntry : cacheIt->second) {\n+                        // Add all to descendants which have not yet been added\n+                        if (!visited(cacheEntry)) {\n+                            descendants.emplace_back(cacheEntry);\n+                            // skip self-swap because of buggy std::swap implementations\n+                            // on some platforms\n+                            if (!(descendants.size() == i+2)) {\n+                                std::swap(descendants[i+1], descendants.back());\n+                            }\n+                            // skip processing this element\n+                            ++i;\n+                        }\n+                    }\n+                } else if (!visited(mapTx.iterator_to(childEntry))) {\n+                    // Schedule for later processing\n+                    descendants.emplace_back(mapTx.iterator_to(childEntry));\n+                    ++n_to_process;\n                 }\n-            } else if (!descendants.count(childEntry)) {\n-                // Schedule for later processing\n-                stageEntries.insert(childEntry);\n             }\n         }\n-    }\n+    } // release epoch\n+\n+    // remove any descendants that are in setExclude\n+    auto included_upto = std::remove_if(descendants.begin(), descendants.end(),\n+            [&](txiter it) {\n+                return setExclude.count(it->GetTx().GetHash());\n+            });\n+\n+    // if none remain, we don't have to do any updating\n+    if (included_upto == descendants.begin()) return;\n+\n     // descendants now contains all in-mempool descendants of updateIt.\n     // Update and add to cached descendant map\n     int64_t modifySize = 0;\n     CAmount modifyFee = 0;\n     int64_t modifyCount = 0;\n-    for (const CTxMemPoolEntry& descendant : descendants) {\n-        if (!setExclude.count(descendant.GetTx().GetHash())) {\n-            modifySize += descendant.GetTxSize();\n-            modifyFee += descendant.GetModifiedFee();\n-            modifyCount++;\n-            cachedDescendants[updateIt].insert(mapTx.iterator_to(descendant));\n-            // Update ancestor state for each descendant\n-            mapTx.modify(mapTx.iterator_to(descendant), update_ancestor_state(updateIt->GetTxSize(), updateIt->GetModifiedFee(), 1, updateIt->GetSigOpCost()));\n-            // Don't directly remove the transaction here -- doing so would\n-            // invalidate iterators in cachedDescendants. Mark it for removal\n-            // by inserting into descendants_to_remove.\n-            if (descendant.GetCountWithAncestors() > ancestor_count_limit || descendant.GetSizeWithAncestors() > ancestor_size_limit) {\n-                descendants_to_remove.insert(descendant.GetTx().GetHash());\n-            }\n+    // Note: the below contains code which does some hacks to keep memory tight.\n+    // it could be improved in the future to detect if the vector is already tight\n+    // and then directly move it to cachedDescendants. For simplicity, we just\n+    // do a copy for now.\n+\n+    // emplace into a new vector to guarantee we trim memory\n+    const auto& it = cachedDescendants.emplace(std::piecewise_construct,\n+            std::forward_as_tuple(updateIt),\n+            std::forward_as_tuple(descendants.begin(), included_upto));\n+    // swap with descendants to release it early!\n+    std::vector<txiter>().swap(descendants);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811418425",
      "id" : 811418425,
      "in_reply_to_id" : 808967963,
      "line" : 194,
      "node_id" : "PRRC_kwDOABII584wXUM5",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 194,
      "original_position" : 108,
      "original_start_line" : 184,
      "path" : "src/txmempool.cpp",
      "position" : 108,
      "pull_request_review_id" : 889087767,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418425/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 184,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-21T20:42:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811418791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418791"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "this is a good point. But how do we know in advance of iterating what that would be? I figured we do not?",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-02-21T20:43:35Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r811418791",
      "id" : 811418791,
      "in_reply_to_id" : 808974643,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII584wXUSn",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 127,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 23,
      "pull_request_review_id" : 889088284,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418791/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-21T20:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811418791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r851008181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851008181"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it should only be done if `children` is non-empty - this change should also allow getting rid of the current `find` call in the children loop and just add straight to `descendants`. The current logic in master of checking `cachedDescendants` is a bit odd as if there are three txn's (t1 -> t2 -> t3) in a chain that depend on each other sequentially, then the `find` call will only get a \"hit\" when t3 is `updateIt` as it \"skips\" t2",
      "commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "created_at" : "2022-04-15T02:22:02Z",
      "diff_hunk" : "@@ -120,47 +120,91 @@ void CTxMemPool::UpdateForDescendants(txiter updateIt, cacheMap& cachedDescendan\n                                       const std::set<uint256>& setExclude, std::set<uint256>& descendants_to_remove,\n                                       uint64_t ancestor_size_limit, uint64_t ancestor_count_limit)\n {\n-    CTxMemPoolEntry::Children stageEntries, descendants;\n-    stageEntries = updateIt->GetMemPoolChildrenConst();\n-\n-    while (!stageEntries.empty()) {\n-        const CTxMemPoolEntry& descendant = *stageEntries.begin();\n-        descendants.insert(descendant);\n-        stageEntries.erase(descendant);\n-        const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n-        for (const CTxMemPoolEntry& childEntry : children) {\n-            cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));\n-            if (cacheIt != cachedDescendants.end()) {\n-                // We've already calculated this one, just add the entries for this set\n-                // but don't traverse again.\n-                for (txiter cacheEntry : cacheIt->second) {\n-                    descendants.insert(*cacheEntry);\n+    const CTxMemPoolEntry::Children& children = updateIt->GetMemPoolChildrenConst();\n+\n+    // initialize to hold all direct children\n+    // children guaranteed to be unique at this point\n+    std::vector<txiter> descendants(children.size());\n+    size_t i = 0;\n+    for (const auto& child: children) {\n+        descendants[i] = mapTx.iterator_to(child);\n+        ++i;\n+    }\n+\n+    {\n+        WITH_FRESH_EPOCH(m_epoch);\n+        // visit all children\n+        for (auto& child : descendants) {\n+            visited(child);\n+        }\n+        for (size_t i = 0, n_to_process = descendants.size(); i < n_to_process; ++i) {\n+            const CTxMemPoolEntry& descendant = *descendants[i];\n+            const CTxMemPoolEntry::Children& children = descendant.GetMemPoolChildrenConst();\n+            for (const CTxMemPoolEntry& childEntry : children) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(mapTx.iterator_to(childEntry));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#discussion_r851008181",
      "id" : 851008181,
      "in_reply_to_id" : 808939277,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII584yuVq1",
      "original_commit_id" : "1eac472976badf52312b52dcb119fa8b50ed408b",
      "original_line" : 144,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 40,
      "pull_request_review_id" : 943098911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24158",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851008181/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-15T02:22:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851008181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `UpdateForDescendants` should have the LOCKS_EXCLUDED annotation for m_epoch in txmempool.h",
      "created_at" : "2022-04-19T01:11:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1101897073",
      "id" : 1101897073,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII585BrZ1x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101897073/reactions"
      },
      "updated_at" : "2022-04-19T01:11:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101897073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-06-29T08:03:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24158#issuecomment-1169662009",
      "id" : 1169662009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24158",
      "node_id" : "IC_kwDOABII585Ft6A5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169662009/reactions"
      },
      "updated_at" : "2022-06-29T08:03:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169662009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
