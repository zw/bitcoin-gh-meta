[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102736267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102736267"
         }
      },
      "body" : "Perhaps we should have a comment here explaining that this function is used for all transaction notifications, and not just when things are added to the mempool?  I can imagine a future reader being confused about why BlockConnected and BlockDisconnected both call this function...",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-02-23T15:22:53Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102736267",
      "id" : 102736267,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 23501945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102736267",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102806507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102806507"
         }
      },
      "body" : "OK, added a few comments.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-02-23T20:10:56Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102806507",
      "id" : 102806507,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 23574836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102806507",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104512136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104512136"
         }
      },
      "body" : "To help others review, these two functions seem to mesh with current behavior. I don't see how they could possibly be usable by any client, but there ya go.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T20:18:37Z",
      "diff_hunk" : "@@ -160,3 +162,19 @@ void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CB\n         }\n     }\n }\n+\n+void CZMQNotificationInterface::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104512136",
      "id" : 104512136,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 17,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 19,
      "pull_request_review_id" : 25352756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104512136",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104514485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104514485"
         }
      },
      "body" : "Mind changing AddToWalletIfInvolvingMe to take a CTransactionRef here? Looks like we end up keeping 2 copies otherwise.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T20:29:10Z",
      "diff_hunk" : "@@ -1181,11 +1181,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);\n+void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pindexBlockConnected, int posInBlock) {\n+    const CTransaction& tx = *ptx;\n \n-    if (!AddToWalletIfInvolvingMe(tx, pindex, posInBlock, true))\n+    if (!AddToWalletIfInvolvingMe(tx, pindexBlockConnected, posInBlock, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104514485",
      "id" : 104514485,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25355088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104514485",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104524885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104524885"
         }
      },
      "body" : "The same set of conflicted transactions is sent here for each block.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T21:18:04Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);\n-                const CBlock& block = *(pair.second);\n-                for (unsigned int i = 0; i < block.vtx.size(); i++)\n-                    GetMainSignals().SyncTransaction(*block.vtx[i], pair.first, i);\n+                GetMainSignals().BlockConnected(pair.second, pair.first, *mrt.GetConflictedTransactions());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104524885",
      "id" : 104524885,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 103,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25366381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104524885",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104539518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104539518"
         }
      },
      "body" : "pindex can no longer be NULL here.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T22:22:29Z",
      "diff_hunk" : "@@ -1198,6 +1197,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before\n+    // connected transactions.  This shouldn't matter, but the abandoned\n+    // state of transactions in our wallet is currently cleared when we\n+    // receive another notification and there is a race condition where\n+    // notification of a connected conflict might cause an outside process\n+    // to abandon a transaction and then have it inadvertantly cleared by\n+    // the notification that the conflicted transaction was evicted.\n+\n+    for (const CTransactionRef& ptx : vtxConflicted) {\n+        SyncTransaction(ptx, NULL, -1);\n+    }\n+    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+        SyncTransaction(pblock->vtx[i], pindex, pindex ? i : -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104539518",
      "id" : 104539518,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25381496,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104539518",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104540672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104540672"
         }
      },
      "body" : "Assert pair.first here too, I think. It'd be nice to doc that the BlockConnected() params are now always non-null.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T22:28:00Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104540672",
      "id" : 104540672,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 99,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25382753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104540672",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Concept ACK.",
      "created_at" : "2017-03-06T22:30:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284555612",
      "id" : 284555612,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-06T22:30:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284555612",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549555"
         }
      },
      "body" : "Fixed, with a lot more code :(.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T23:13:52Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);\n-                const CBlock& block = *(pair.second);\n-                for (unsigned int i = 0; i < block.vtx.size(); i++)\n-                    GetMainSignals().SyncTransaction(*block.vtx[i], pair.first, i);\n+                GetMainSignals().BlockConnected(pair.second, pair.first, *mrt.GetConflictedTransactions());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549555",
      "id" : 104549555,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 103,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25392031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549555",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549592"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T23:14:04Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549592",
      "id" : 104549592,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 99,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25392075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549592",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549790"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T23:15:08Z",
      "diff_hunk" : "@@ -1198,6 +1197,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before\n+    // connected transactions.  This shouldn't matter, but the abandoned\n+    // state of transactions in our wallet is currently cleared when we\n+    // receive another notification and there is a race condition where\n+    // notification of a connected conflict might cause an outside process\n+    // to abandon a transaction and then have it inadvertantly cleared by\n+    // the notification that the conflicted transaction was evicted.\n+\n+    for (const CTransactionRef& ptx : vtxConflicted) {\n+        SyncTransaction(ptx, NULL, -1);\n+    }\n+    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+        SyncTransaction(pblock->vtx[i], pindex, pindex ? i : -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549790",
      "id" : 104549790,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25392265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549790",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104550406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104550406"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-06T23:18:30Z",
      "diff_hunk" : "@@ -1181,11 +1181,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);\n+void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pindexBlockConnected, int posInBlock) {\n+    const CTransaction& tx = *ptx;\n \n-    if (!AddToWalletIfInvolvingMe(tx, pindex, posInBlock, true))\n+    if (!AddToWalletIfInvolvingMe(tx, pindexBlockConnected, posInBlock, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104550406",
      "id" : 104550406,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25392873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104550406",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "To fix the issue @theuni found (\"The same set of conflicted transactions is sent here for each block.\"), I had to go rewrite a big chunk of how the mempool removal callback logic works. Now what was previously a standalone class which listens to mempool for transactions removed has gone into the ConnectTrace class, which is accessed in ActivateBestChain to generate callbacks.\r\nAlso, had to rebase.",
      "created_at" : "2017-03-06T23:24:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284568275",
      "id" : 284568275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-06T23:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284568275",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104680242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104680242"
         }
      },
      "body" : "In commit \"Add pblock to connectTrace at the end of ConnectTip, not start\":\r\n\r\nMaybe write \"The block is added to connectTrace only if the connection succeeds.\" ? \"Always\" and \"in the case\" imply contradictory things to me.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T14:37:06Z",
      "diff_hunk" : "@@ -2240,24 +2240,23 @@ struct ConnectTrace {\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  *\n- * The block is always added to connectTrace (either after loading from disk or by copying\n- * pblock) - if that is not intended, care must be taken to remove the last entry in\n- * blocksConnected in case of failure.\n+ * The block is always added to connectTrace in the case connection succeeds.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104680242",
      "id" : 104680242,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104680242",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104682862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104682862"
         }
      },
      "body" : "In commit \"Add pblock to connectTrace at the end of ConnectTip, not start\":\r\n\r\nThis does appear to be doing what the commit message says. But could you add a line like \"Cleanup, no change in behavior\" to the commit message if that is the intention here?\r\n\r\nAs someone interested in being able to contribute reviews, and in being able to understand the direction we're taking the code, it's really helpful to me when I can read a commit message that not only tells me what change the commit is making, but also provides a little hint about why the change is being made.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T14:46:27Z",
      "diff_hunk" : "@@ -2291,6 +2290,8 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n     int64_t nTime6 = GetTimeMicros(); nTimePostConnect += nTime6 - nTime5; nTimeTotal += nTime6 - nTime1;\n     LogPrint(\"bench\", \"  - Connect postprocess: %.2fms [%.2fs]\\n\", (nTime6 - nTime5) * 0.001, nTimePostConnect * 0.000001);\n     LogPrint(\"bench\", \"- Connect block: %.2fms [%.2fs]\\n\", (nTime6 - nTime1) * 0.001, nTimeTotal * 0.000001);\n+\n+    connectTrace.blocksConnected.emplace_back(pindexNew, pthisBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104682862",
      "id" : 104682862,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 35,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104682862",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "Rebased for trivial conflict from #9605.",
      "created_at" : "2017-03-07T15:12:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284749354",
      "id" : 284749354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-07T15:12:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284749354",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691509"
         }
      },
      "body" : "In commit \"Make ConnectTrace::blocksConnected private, hide behind accessors\":\r\n\r\nDoesn't really matter because this is only called in a single place, and that place happens to require a copy. But if you wanted to write this in a move-compatible way (giving callers flexibility to either move or copy), you could write:\r\n\r\n```\r\nvoid BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\r\n    blocksConnected.emplace_back(pindex, std::move(pblock));\r\n}\r\n```",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T15:17:47Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691509",
      "id" : 104691509,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691509",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691580"
         }
      },
      "body" : "In commit \"Make ConnectTrace::blocksConnected private, hide behind accessors\":\r\n\r\nNow we are copying the vector (as well as the shared_ptrs inside) whenever it is accessed, which we weren't doing before. Any reason for this not to return a const reference to the vector to avoid this?\r\n\r\nAlso the method itself should be marked const.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T15:18:01Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n+        blocksConnected.emplace_back(pindex, pblock);\n+    }\n+\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > GetBlocksConnected() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691580",
      "id" : 104691580,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691580",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104692562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104692562"
         }
      },
      "body" : "In commit \"Handle conflicted transactions directly in ConnectTrace\":\r\n\r\nUsing std::move and emplace would be slightly more efficient. Would also make this code have a more internally consistent style.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T15:21:33Z",
      "diff_hunk" : "@@ -2231,19 +2198,46 @@ static int64_t nTimePostConnect = 0;\n /**\n  * Used to track blocks whose transactions were applied to the UTXO state as a\n  * part of a single ActivateBestChainStep call.\n+ *\n+ * This class also tracks transactions that are removed from the mempool as\n+ * conflicts and and can be used to pass all those transactions through\n+ * SyncTransaction.\n  */\n-struct ConnectTrace {\n+class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+    std::vector<CTransactionRef> conflictedTxs;\n+    CTxMemPool &pool;\n \n public:\n+    ConnectTrace(CTxMemPool &_pool) : pool(_pool) {\n+        pool.NotifyEntryRemoved.connect(boost::bind(&ConnectTrace::NotifyEntryRemoved, this, _1, _2));\n+    }\n+\n+    ~ConnectTrace() {\n+        pool.NotifyEntryRemoved.disconnect(boost::bind(&ConnectTrace::NotifyEntryRemoved, this, _1, _2));\n+    }\n+\n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n         blocksConnected.emplace_back(pindex, pblock);\n     }\n \n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > GetBlocksConnected() {\n         return blocksConnected;\n     }\n+\n+    void NotifyEntryRemoved(CTransactionRef txRemoved, MemPoolRemovalReason reason) {\n+        if (reason == MemPoolRemovalReason::CONFLICT) {\n+            conflictedTxs.push_back(txRemoved);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104692562",
      "id" : 104692562,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 75,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104692562",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104693002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104693002"
         }
      },
      "body" : "In commit \"Handle conflicted transactions directly in ConnectTrace\":\r\n\r\nAgain, I would find it really helpful if the commit message gave a hint about why the change is being made instead of only saying what the change is.\r\n\r\nIs this just a cleanup not intended to change behavior? Is it important that signal connect/disconnect no longer happen under cs_main? Please mention in the commit message.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T15:23:06Z",
      "diff_hunk" : "@@ -2526,8 +2512,15 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             fInitialDownload = IsInitialBlockDownload();\n \n             // throw all transactions though the signal-interface\n-\n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n+            connectTrace.CallSyncTransactionOnConflictedTransactions();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104693002",
      "id" : 104693002,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 114,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104693002",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104694067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104694067"
         }
      },
      "body" : "In commit \"Keep conflictedTxs in ConnectTrace per-block\":\r\n\r\nCould construct the vector in the desired state initially (just pass `1` or `{{}}` to the constructor) instead of creating it empty and then pushing.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T15:27:02Z",
      "diff_hunk" : "@@ -2200,17 +2200,18 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  *\n  * This class also tracks transactions that are removed from the mempool as\n- * conflicts and and can be used to pass all those transactions through\n- * SyncTransaction.\n+ * conflicts (per block) and and can be used to pass all those transactions\n+ * through SyncTransaction.\n  */\n class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n-    std::vector<CTransactionRef> conflictedTxs;\n+    std::vector<std::vector<CTransactionRef> > conflictedTxs;\n     CTxMemPool &pool;\n \n public:\n     ConnectTrace(CTxMemPool &_pool) : pool(_pool) {\n+        conflictedTxs.emplace_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104694067",
      "id" : 104694067,
      "original_commit_id" : "5459aca910afe48fb53bbba4e9574e4790624d8c",
      "original_position" : 18,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104694067",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104697616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104697616"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nMaybe s/NULL/nullptr/.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T15:39:13Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104697616",
      "id" : 104697616,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104697616",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104701476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104701476"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nMaybe break assert into two lines so it's easier to know which condition failed.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T15:52:33Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104701476",
      "id" : 104701476,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 37,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104701476",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104703615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104703615"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nMaybe s/> > />>/.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T16:00:18Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;\n+    std::shared_ptr<const CBlock> pblock;\n+    std::shared_ptr<std::vector<CTransactionRef> > conflictedTxs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104703615",
      "id" : 104703615,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104703615",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104711671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104711671"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nThis awaitingClear variable never seems to be used anywhere except in asserts. It would definitely be worth mentioning this in a comment on the awaitingClear declaration, because otherwise the state this class is tracking appears to be more complicated than it really is.\r\n\r\nAlso, if possible, I think it would be better to make the interface less fragile and get rid of the need for any awaitingClear variable to detect misuse. It seems you could replace the GetBlocksConnected/ClearBlocksConnected function pair with a single function:\r\n\r\n```\r\nstd::vector<PerBlockConnectTrace> ClearBlocksConnected() {\r\n    if (!blocksConnected.back().pindex) {\r\n        blocksConnected.pop_back();\r\n    }\r\n    std::vector<PerBlockConnectTrace> ret(1);\r\n    ret.swap(blocksConnected);\r\n    return ret;\r\n}\r\n```\r\n\r\nIf you did this, another advantage would be that you could make conflictedTxs a plain vector instead of a shared_ptr to a vector, because you would no longer be creating copies of it. ",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T16:28:57Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace> GetBlocksConnected() {\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();\n+            assert(!awaitingClear);\n+            awaitingClear = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104711671",
      "id" : 104711671,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 47,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104711671",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104714457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104714457"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nCould you add a comment explaining this pop_back behavior? I thought the whole point of adding an initial null block to the blocksConnected vector was to support NotifyEntryRemoved calls prior to any BlockConnected call. But if this will now throw away the results of those calls, why not just avoid creating initial null block and have NotifyEntryRemoved do nothing if called when blocksConnected.empty()?\r\n\r\nI'm probably missing something, so a comment here mentioning the real purpose of the pop could be helpful.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T16:38:19Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace> GetBlocksConnected() {\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104714457",
      "id" : 104714457,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 45,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104714457",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104718278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104718278"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\":\r\n\r\nRealize you are only moving this, but this TODO comment seems to be describing what the current behavior is, not what the TODO is. Maybe remove TODO at the beginning of this comment, and add \"TODO: \\<thing to be done\\>\" at the end, where I'm guessing \\<thing to be done\\> is somehow fixing the race condition.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T16:52:29Z",
      "diff_hunk" : "@@ -1172,6 +1171,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104718278",
      "id" : 104718278,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 26,
      "path" : "src/wallet/wallet.cpp",
      "position" : 46,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104718278",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104732789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104732789"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\"\r\n\r\nCould you update the commit message to explicitly say which of the changes in the commit are changes in behavior as opposed to just internal code reorganization? Maybe the following would be accurate? \"This commit doesn't change the behavior of ZMQ notifications or network message processing in any way. It does slightly change the way the wallet processes transactions. The wallet now no longer releases cs_main and cs_wallet between transactions when it is processing multiple transactions from the same block.\"\r\n\r\nAlso if this is accurate, maybe consider changing the wallet locking in a separate commit (or even a separate PR), instead of mixing code cleanup and a locking improvement in the same change.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T17:50:26Z",
      "diff_hunk" : "@@ -1155,11 +1155,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104732789",
      "id" : 104732789,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104732789",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104734533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104734533"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\":\r\n\r\nWhat does the part of your commit message that says \"CValidationInterface starts listening to mempool directly, placing it in the middle\" mean?\r\n\r\nWasn't CValidationInterface always in the middle between validation code and the various listeners? And aren't the calls to the CValidationInterface still happening in the exact same places as before, just with updated function names and arguments?",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T17:57:53Z",
      "diff_hunk" : "@@ -33,7 +34,9 @@ void UnregisterAllValidationInterfaces();\n class CValidationInterface {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104734533",
      "id" : 104734533,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 17,
      "path" : "src/validationinterface.h",
      "position" : 20,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104734533",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104735895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104735895"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\"\r\n\r\n>> Perhaps we should have a comment here\r\n\r\n> OK, added a few comments.\r\n\r\nFWIW, not seeing a comment here. Maybe they were added elsewhere, but it would seem good to mention right in the top of the function body that this is not only called when a transaction is added to the mempool like the name would suggest. Alternately, you could leave this function named SyncTransaction and have TransactionAddedToMempool call SyncTransaction to avoid the misleading title.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T18:03:49Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104735895",
      "id" : 104735895,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104735895",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104737176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104737176"
         }
      },
      "body" : "In commit \"Add override to functions using CValidationInterface methods\"\r\n\r\nI think normally you drop \"virtual\" when you add \"override\" to make the two different types of method declarations more distinct. At least that's the style I'm used to, and we seem to follow it everywhere else we're currently using override.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T18:09:31Z",
      "diff_hunk" : "@@ -30,10 +30,10 @@ class PeerLogicValidation : public CValidationInterface {\n public:\n     PeerLogicValidation(CConnman* connmanIn);\n \n-    virtual void BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted);\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload);\n-    virtual void BlockChecked(const CBlock& block, const CValidationState& state);\n-    virtual void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock);\n+    virtual void BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104737176",
      "id" : 104737176,
      "original_commit_id" : "2897190e78e8733402be878c9e18c41bae6cb7f8",
      "original_position" : 8,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104737176",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756416"
         }
      },
      "body" : "Is there actually a difference between nullptr and NULL to the compiler (it overrides differently, sometimes, if you're calling a function, no?)",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:28:14Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756416",
      "id" : 104756416,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 25607210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756416",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756495"
         }
      },
      "body" : "Heh, I still find the pre-C++11 version to be easier to read :P",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:28:32Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;\n+    std::shared_ptr<const CBlock> pblock;\n+    std::shared_ptr<std::vector<CTransactionRef> > conflictedTxs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756495",
      "id" : 104756495,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25607290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756495",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757029"
         }
      },
      "body" : "Tweaked, carryover from too-little-diff-change.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:30:42Z",
      "diff_hunk" : "@@ -2240,24 +2240,23 @@ struct ConnectTrace {\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  *\n- * The block is always added to connectTrace (either after loading from disk or by copying\n- * pblock) - if that is not intended, care must be taken to remove the last entry in\n- * blocksConnected in case of failure.\n+ * The block is always added to connectTrace in the case connection succeeds.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757029",
      "id" : 104757029,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25607824,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757029",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757198"
         }
      },
      "body" : "I prefer to force peoplt to not take the atomic increment hit without changing the code :).",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:31:21Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757198",
      "id" : 104757198,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25607998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757198",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104758212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104758212"
         }
      },
      "body" : "Oops, indeed. Now it just returns a reference, which should also be fine. The method is not technically const later (without making things mutable), so I'll leave the second part.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:35:19Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n+        blocksConnected.emplace_back(pindex, pblock);\n+    }\n+\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > GetBlocksConnected() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104758212",
      "id" : 104758212,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25608986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104758212",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104759201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104759201"
         }
      },
      "body" : "Sure, added more to the commit message.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:39:36Z",
      "diff_hunk" : "@@ -2291,6 +2290,8 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n     int64_t nTime6 = GetTimeMicros(); nTimePostConnect += nTime6 - nTime5; nTimeTotal += nTime6 - nTime1;\n     LogPrint(\"bench\", \"  - Connect postprocess: %.2fms [%.2fs]\\n\", (nTime6 - nTime5) * 0.001, nTimePostConnect * 0.000001);\n     LogPrint(\"bench\", \"- Connect block: %.2fms [%.2fs]\\n\", (nTime6 - nTime1) * 0.001, nTimeTotal * 0.000001);\n+\n+    connectTrace.blocksConnected.emplace_back(pindexNew, pthisBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104759201",
      "id" : 104759201,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 35,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25610005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104759201",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104760269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104760269"
         }
      },
      "body" : "OK, did that for the whole patch set.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:43:57Z",
      "diff_hunk" : "@@ -2200,17 +2200,18 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  *\n  * This class also tracks transactions that are removed from the mempool as\n- * conflicts and and can be used to pass all those transactions through\n- * SyncTransaction.\n+ * conflicts (per block) and and can be used to pass all those transactions\n+ * through SyncTransaction.\n  */\n class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n-    std::vector<CTransactionRef> conflictedTxs;\n+    std::vector<std::vector<CTransactionRef> > conflictedTxs;\n     CTxMemPool &pool;\n \n public:\n     ConnectTrace(CTxMemPool &_pool) : pool(_pool) {\n+        conflictedTxs.emplace_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104760269",
      "id" : 104760269,
      "original_commit_id" : "5459aca910afe48fb53bbba4e9574e4790624d8c",
      "original_position" : 18,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25611109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104760269",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104761156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104761156"
         }
      },
      "body" : "Done.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:47:24Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104761156",
      "id" : 104761156,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 37,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25612021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104761156",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104761182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104761182"
         }
      },
      "body" : "Done.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:47:29Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace> GetBlocksConnected() {\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104761182",
      "id" : 104761182,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 45,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25612047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104761182",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104762386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104762386"
         }
      },
      "body" : "Sorry, the intention of making conflictedTxs a shared_ptr is so that it can be easily passed to CValidationInterface in a later patchset, not so that we can avoid copy here, forgot to mention that when I split up the patch set.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:52:13Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace> GetBlocksConnected() {\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();\n+            assert(!awaitingClear);\n+            awaitingClear = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104762386",
      "id" : 104762386,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 47,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25613363,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104762386",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104762813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104762813"
         }
      },
      "body" : "Indeed, done.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:53:53Z",
      "diff_hunk" : "@@ -2231,19 +2198,46 @@ static int64_t nTimePostConnect = 0;\n /**\n  * Used to track blocks whose transactions were applied to the UTXO state as a\n  * part of a single ActivateBestChainStep call.\n+ *\n+ * This class also tracks transactions that are removed from the mempool as\n+ * conflicts and and can be used to pass all those transactions through\n+ * SyncTransaction.\n  */\n-struct ConnectTrace {\n+class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+    std::vector<CTransactionRef> conflictedTxs;\n+    CTxMemPool &pool;\n \n public:\n+    ConnectTrace(CTxMemPool &_pool) : pool(_pool) {\n+        pool.NotifyEntryRemoved.connect(boost::bind(&ConnectTrace::NotifyEntryRemoved, this, _1, _2));\n+    }\n+\n+    ~ConnectTrace() {\n+        pool.NotifyEntryRemoved.disconnect(boost::bind(&ConnectTrace::NotifyEntryRemoved, this, _1, _2));\n+    }\n+\n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n         blocksConnected.emplace_back(pindex, pblock);\n     }\n \n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > GetBlocksConnected() {\n         return blocksConnected;\n     }\n+\n+    void NotifyEntryRemoved(CTransactionRef txRemoved, MemPoolRemovalReason reason) {\n+        if (reason == MemPoolRemovalReason::CONFLICT) {\n+            conflictedTxs.push_back(txRemoved);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104762813",
      "id" : 104762813,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 75,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25613825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104762813",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104763065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104763065"
         }
      },
      "body" : "Its removed later in the PR, so probably easier to just leave it",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:54:55Z",
      "diff_hunk" : "@@ -1172,6 +1171,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104763065",
      "id" : 104763065,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 26,
      "path" : "src/wallet/wallet.cpp",
      "position" : 46,
      "pull_request_review_id" : 25614095,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104763065",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104764225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104764225"
         }
      },
      "body" : "It all still happens under cs_main? There are no behavior changes there. I added another line to the commit message.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T19:59:34Z",
      "diff_hunk" : "@@ -2526,8 +2512,15 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             fInitialDownload = IsInitialBlockDownload();\n \n             // throw all transactions though the signal-interface\n-\n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n+            connectTrace.CallSyncTransactionOnConflictedTransactions();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104764225",
      "id" : 104764225,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 114,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25615372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104764225",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104764407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104764407"
         }
      },
      "body" : "There are no behavior changes here? Everything is still under cs_main from the previous commit.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T20:00:18Z",
      "diff_hunk" : "@@ -1155,11 +1155,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104764407",
      "id" : 104764407,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 25615544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104764407",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104764762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104764762"
         }
      },
      "body" : "CValidationInterface has never listened to mempool, it was just an interface between the things in validation.cpp and other callers, now its also listening to mempool, putting it in the middle of the various callbacks we have going.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T20:01:41Z",
      "diff_hunk" : "@@ -33,7 +34,9 @@ void UnregisterAllValidationInterfaces();\n class CValidationInterface {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104764762",
      "id" : 104764762,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 17,
      "path" : "src/validationinterface.h",
      "position" : 20,
      "pull_request_review_id" : 25615932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104764762",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104765224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104765224"
         }
      },
      "body" : "Added another comment.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T20:03:57Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104765224",
      "id" : 104765224,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 25616436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104765224",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104766145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104766145"
         }
      },
      "body" : "OK, done.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-07T20:08:11Z",
      "diff_hunk" : "@@ -30,10 +30,10 @@ class PeerLogicValidation : public CValidationInterface {\n public:\n     PeerLogicValidation(CConnman* connmanIn);\n \n-    virtual void BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted);\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload);\n-    virtual void BlockChecked(const CBlock& block, const CValidationState& state);\n-    virtual void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock);\n+    virtual void BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104766145",
      "id" : 104766145,
      "original_commit_id" : "2897190e78e8733402be878c9e18c41bae6cb7f8",
      "original_position" : 8,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 25617438,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104766145",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Added a bunch of comments and additional commit description at @ryanofsky's request. Also, note that the reason the std::vector<CTransactionRef> of conflicted transactions is passed back to ActivateBestChain as a shared_ptr is to make it easy to add that to a queue of events shared between threads later, not for anything in this function, forgot to make that clear when I mentioned this is part of a much longer patchset.",
      "created_at" : "2017-03-07T20:10:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284843897",
      "id" : 284843897,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-07T20:10:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284843897",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104945445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104945445"
         }
      },
      "body" : ">Is there actually a difference between nullptr and NULL to the compiler (it overrides differently, sometimes, if you're calling a function, no?)\r\n\r\nYes, but I only suggested nullptr because I thought it might be an oversight. (NULL seems retro to me, but if you prefer it, please keep.)",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T15:41:11Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104945445",
      "id" : 104945445,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 25802233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104945445",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104948081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104948081"
         }
      },
      "body" : "> I prefer to force peoplt to not take the atomic increment hit without changing the code :).\r\n\r\nYour version forces the atomic increment hit in every case, my version lets callers avoid it in the case where they are moving the shared pointer into the container.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T15:51:02Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104948081",
      "id" : 104948081,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25802233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104948081",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104949416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104949416"
         }
      },
      "body" : "> > Is it important that signal connect/disconnect no longer happen under cs_main?\r\n\r\n> It all still happens under cs_main? There are no behavior changes there. I added another line to the commit message.\r\n\r\nThe NotifyEntryRemoved.connect and disconnect calls happen in the ConnectTrace constructor/destructor above the LOCK(cs_main) call, instead of below it like before. Guessing this probably isn't significant, but I wanted to make sure it was intentional and thought it might be worth mentioning in the commit message as a possible change in behavior.\r\n",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T15:56:02Z",
      "diff_hunk" : "@@ -2526,8 +2512,15 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             fInitialDownload = IsInitialBlockDownload();\n \n             // throw all transactions though the signal-interface\n-\n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n+            connectTrace.CallSyncTransactionOnConflictedTransactions();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104949416",
      "id" : 104949416,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 114,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25802233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104949416",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104951802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104951802"
         }
      },
      "body" : "> > The wallet now no longer releases cs_main and cs_wallet between transactions when it is processing multiple transactions from the same block.\r\n\r\n> There are no behavior changes here? Everything is still under cs_main from the previous commit.\r\n\r\nEverything is still under cs_main, but previously cs_main and cs_wallet were released between processing individual transactions in the block, while now they are held until all transactions in the block are processed. You already mention this in your commit message, I was just suggesting moving the locking change to a separate commit so this one can be a pure refactoring, and the locking part can be understood on its own (and more easily identified and reverted if it causes problems).",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T16:05:28Z",
      "diff_hunk" : "@@ -1155,11 +1155,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104951802",
      "id" : 104951802,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 25802233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104951802",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104953316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104953316"
         }
      },
      "body" : "> CValidationInterface has never listened to mempool, it was just an interface between the things in validation.cpp and other callers, now its also listening to mempool, putting it in the middle of the various callbacks we have going.\r\n\r\nI guess I don't understand what \"listening to mempool\" means. CValidationInterface is a class with methods, and the methods seem to be called from the same places as before. I don't think it's an important point, I just don't get what this is trying to say.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T16:10:49Z",
      "diff_hunk" : "@@ -33,7 +34,9 @@ void UnregisterAllValidationInterfaces();\n class CValidationInterface {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104953316",
      "id" : 104953316,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 17,
      "path" : "src/validationinterface.h",
      "position" : 20,
      "pull_request_review_id" : 25802233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104953316",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104958171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104958171"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\"\r\n\r\nCould / should you `assert(blocksConnected.back().conflictedTxs.empty())` here?",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T16:29:06Z",
      "diff_hunk" : "@@ -2219,28 +2232,40 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We use\n+        // awaitingClear to keep track of this state, and pop the last\n+        // entry here to make sure the list we return is sane.\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104958171",
      "id" : 104958171,
      "original_commit_id" : "c36422e8831fc9c2268777b0689c02ea0b45ea5c",
      "original_position" : 61,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25802233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104958171",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104960141"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104960141"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\"\r\n\r\nWhat do you think of my suggestion to get merge the ClearBlocksConnected and GetBlocksConnected methods into a single method so you can get rid of the awaitingClear variable and all the asserts? \r\n\r\nLink: https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104711671\r\n\r\nSeems better to prevent the interface misuse instead of detecting it at runtime and crashing.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T16:36:39Z",
      "diff_hunk" : "@@ -2219,28 +2232,40 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We use\n+        // awaitingClear to keep track of this state, and pop the last\n+        // entry here to make sure the list we return is sane.\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();\n+            assert(!awaitingClear);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104960141",
      "id" : 104960141,
      "original_commit_id" : "c36422e8831fc9c2268777b0689c02ea0b45ea5c",
      "original_position" : 62,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25802233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104960141",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104971889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104971889"
         }
      },
      "body" : "Ahh, indeed, I hate this C++11 stuff, anyway, I took the proposed change.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T17:22:15Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104971889",
      "id" : 104971889,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25827361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104971889",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104977598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104977598"
         }
      },
      "body" : "Took this change (as a part of larger changes).",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T17:47:15Z",
      "diff_hunk" : "@@ -2219,28 +2232,40 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We use\n+        // awaitingClear to keep track of this state, and pop the last\n+        // entry here to make sure the list we return is sane.\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104977598",
      "id" : 104977598,
      "original_commit_id" : "c36422e8831fc9c2268777b0689c02ea0b45ea5c",
      "original_position" : 61,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25827361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104977598",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104978005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104978005"
         }
      },
      "body" : "Made the class use-once instead.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T17:49:09Z",
      "diff_hunk" : "@@ -2219,28 +2232,40 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We use\n+        // awaitingClear to keep track of this state, and pop the last\n+        // entry here to make sure the list we return is sane.\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();\n+            assert(!awaitingClear);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104978005",
      "id" : 104978005,
      "original_commit_id" : "c36422e8831fc9c2268777b0689c02ea0b45ea5c",
      "original_position" : 62,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25827361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104978005",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104978525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104978525"
         }
      },
      "body" : "Argh, I believe that could be a race which triggers a reachable assertion if there are two ActivateBestChain's going at once, moved the class into the cs_main lock, which simplified the whole thing a bit.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T17:51:17Z",
      "diff_hunk" : "@@ -2526,8 +2512,15 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             fInitialDownload = IsInitialBlockDownload();\n \n             // throw all transactions though the signal-interface\n-\n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n+            connectTrace.CallSyncTransactionOnConflictedTransactions();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104978525",
      "id" : 104978525,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 114,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25827361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104978525",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104980158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104980158"
         }
      },
      "body" : "Ahh, OK, split the commit.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T17:58:08Z",
      "diff_hunk" : "@@ -1155,11 +1155,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104980158",
      "id" : 104980158,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 25827361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104980158",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104981491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104981491"
         }
      },
      "body" : "Ahh, I see the issue. Yes, this is actually referring to something further in the change-set, but not in this PR (the full changeset is at https://github.com/TheBlueMatt/bitcoin/commits/2017-01-wallet-cache-inmempool, this is referring to https://github.com/TheBlueMatt/bitcoin/commit/71683dc0d8a00e16211194aaa66bfea1ae265f45).",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-08T18:04:15Z",
      "diff_hunk" : "@@ -33,7 +34,9 @@ void UnregisterAllValidationInterfaces();\n class CValidationInterface {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104981491",
      "id" : 104981491,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 17,
      "path" : "src/validationinterface.h",
      "position" : 20,
      "pull_request_review_id" : 25840154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104981491",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r105172038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105172038"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\":\r\n\r\nThis commit is currently removing LOCK2 at the top of SyncTransaction and then copying it 4 times over each place where SyncTransaction is called. Not a big deal, I guess, since the locks move again in the next commit. But just to be clear, what I was trying to suggest was only moving the locks in the _next_ commit, and leaving them completely alone in this commit.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-09T14:15:20Z",
      "diff_hunk" : "@@ -1155,11 +1155,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r105172038",
      "id" : 105172038,
      "original_commit_id" : "d95db78d185d5deb02fb31a45cbd0a9c9bfe531c",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 26038041,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105172038",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r105182611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105182611"
         }
      },
      "body" : "Ahh, oops, whatever, I'll just leave it.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-09T15:00:18Z",
      "diff_hunk" : "@@ -1155,11 +1155,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r105182611",
      "id" : 105182611,
      "original_commit_id" : "d95db78d185d5deb02fb31a45cbd0a9c9bfe531c",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 26049371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105182611",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased to fix trivial conflict in rpc/mining.cpp",
      "created_at" : "2017-03-09T15:05:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-285376280",
      "id" : 285376280,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-09T15:05:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285376280",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108502288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108502288"
         }
      },
      "body" : "Is this really missing?",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T18:35:34Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n #include \"validationinterface.h\"\n #include <string>\n #include <map>\n+#include <list>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108502288",
      "id" : 108502288,
      "original_commit_id" : "892ddf12e10f7a3c810d735362ab174a44be35c4",
      "original_position" : 4,
      "path" : "src/zmq/zmqnotificationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108502288",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108504557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108504557"
         }
      },
      "body" : "Maybe use std::move on the shared_ptr because we don't seem to use it after this point.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T18:43:38Z",
      "diff_hunk" : "@@ -2266,6 +2265,8 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n     int64_t nTime6 = GetTimeMicros(); nTimePostConnect += nTime6 - nTime5; nTimeTotal += nTime6 - nTime1;\n     LogPrint(\"bench\", \"  - Connect postprocess: %.2fms [%.2fs]\\n\", (nTime6 - nTime5) * 0.001, nTimePostConnect * 0.000001);\n     LogPrint(\"bench\", \"- Connect block: %.2fms [%.2fs]\\n\", (nTime6 - nTime1) * 0.001, nTimeTotal * 0.000001);\n+\n+    connectTrace.blocksConnected.emplace_back(pindexNew, pthisBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108504557",
      "id" : 108504557,
      "original_commit_id" : "bd60e24d27a73682d3814fac61c7d4c59d76603b",
      "original_position" : 35,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108504557",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108508829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108508829"
         }
      },
      "body" : "This is an API change probably outside the scope of this PR, but:\r\n\r\nIt might be nice to refactor ConnectTip to return an rvalue reference to a shared_ptr (and std::move pthisBlock) and have the caller decide what to do with it, because a connecttrace isn't really relevant to ConnectTip. Failing ConnectTip can return nullptr. (Could also keep the as-is ConnectTip around, calling the suggested version, if you're worried about any downstream API stuff).",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T18:59:09Z",
      "diff_hunk" : "@@ -2215,24 +2215,23 @@ struct ConnectTrace {\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  *\n- * The block is always added to connectTrace (either after loading from disk or by copying\n- * pblock) - if that is not intended, care must be taken to remove the last entry in\n- * blocksConnected in case of failure.\n+ * The block is added to connectTrace if connection succeeds.\n  */\n bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108508829",
      "id" : 108508829,
      "original_commit_id" : "bd60e24d27a73682d3814fac61c7d4c59d76603b",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : 150,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108508829",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108511218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108511218"
         }
      },
      "body" : "nit: extra whitespace",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:08:37Z",
      "diff_hunk" : "@@ -2175,17 +2175,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  *\n  * This class also tracks transactions that are removed from the mempool as\n- * conflicts and and can be used to pass all those transactions through\n- * SyncTransaction.\n+ * conflicts (per block) and and can be used to pass all those transactions\n+ * through SyncTransaction.\n  */\n class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n-    std::vector<CTransactionRef> conflictedTxs;\n+    std::vector<std::vector<CTransactionRef> > conflictedTxs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108511218",
      "id" : 108511218,
      "original_commit_id" : "a9c02d029aa027425c2f79f9e576167de7ef6e1c",
      "original_position" : 13,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108511218",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108511808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108511808"
         }
      },
      "body" : "Worth doing a shrink_to_fit/swap on empty vector here?\r\n\r\n```c++\r\n\r\nstd::vector<std::vector<CTransactionRef>>(1).swap(conflictedTxs);\r\n\r\n```",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:11:26Z",
      "diff_hunk" : "@@ -2203,15 +2204,18 @@ class ConnectTrace {\n \n     void NotifyEntryRemoved(CTransactionRef txRemoved, MemPoolRemovalReason reason) {\n         if (reason == MemPoolRemovalReason::CONFLICT) {\n-            conflictedTxs.push_back(txRemoved);\n+            conflictedTxs.back().push_back(txRemoved);\n         }\n     }\n \n     void CallSyncTransactionOnConflictedTransactions() {\n-        for (const auto& tx : conflictedTxs) {\n-            GetMainSignals().SyncTransaction(*tx, NULL, CMainSignals::SYNC_TRANSACTION_NOT_IN_BLOCK);\n+        for (const auto& txRemovedForBlock : conflictedTxs) {\n+            for (const auto& tx : txRemovedForBlock) {\n+                GetMainSignals().SyncTransaction(*tx, NULL, CMainSignals::SYNC_TRANSACTION_NOT_IN_BLOCK);\n+            }\n         }\n         conflictedTxs.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108511808",
      "id" : 108511808,
      "original_commit_id" : "a9c02d029aa027425c2f79f9e576167de7ef6e1c",
      "original_position" : 47,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108511808",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108513792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108513792"
         }
      },
      "body" : "I think given where we call BlockConnected you could make pblock be an rvalue and move from the caller, saving the pass by copy.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:20:08Z",
      "diff_hunk" : "@@ -2194,29 +2207,32 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        blocksConnected.emplace_back(pindex, std::move(pblock));\n-        conflictedTxs.emplace_back();\n-    }\n-\n-    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > >& GetBlocksConnected() {\n+        assert(!blocksConnected.back().pindex);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = std::move(pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108513792",
      "id" : 108513792,
      "original_commit_id" : "b275002930b394828c9c0affdf1fecba79f4d063",
      "original_position" : 52,
      "path" : "src/validation.cpp",
      "position" : 117,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108513792",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108514145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108514145"
         }
      },
      "body" : "Can you set a flag so that doing things with the instance after calling GetBlocksConnected is an assert(blocks_not_gotten)?\r\n\r\nOtherwise, could you return a pair of iterators instead?",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:21:41Z",
      "diff_hunk" : "@@ -2194,29 +2207,32 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        blocksConnected.emplace_back(pindex, std::move(pblock));\n-        conflictedTxs.emplace_back();\n-    }\n-\n-    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > >& GetBlocksConnected() {\n+        assert(!blocksConnected.back().pindex);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = std::move(pblock);\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We pop\n+        // the last entry here to make sure the list we return is sane.\n+        assert(!blocksConnected.back().pindex);\n+        assert(blocksConnected.back().conflictedTxs->empty());\n+        blocksConnected.pop_back();\n         return blocksConnected;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108514145",
      "id" : 108514145,
      "original_commit_id" : "b275002930b394828c9c0affdf1fecba79f4d063",
      "original_position" : 65,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108514145",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108517781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108517781"
         }
      },
      "body" : "please use make_shared",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:38:23Z",
      "diff_hunk" : "@@ -207,7 +206,7 @@ UniValue generatetoaddress(const JSONRPCRequest& request)\n     if (!address.IsValid())\n         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Error: Invalid address\");\n \n-    boost::shared_ptr<CReserveScript> coinbaseScript(new CReserveScript());\n+    std::shared_ptr<CReserveScript> coinbaseScript(new CReserveScript());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108517781",
      "id" : 108517781,
      "original_commit_id" : "c359a52e04514bfeb93fb45232573aff23b873d3",
      "original_position" : 31,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108517781",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108517857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108517857"
         }
      },
      "body" : "make_shared",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:38:46Z",
      "diff_hunk" : "@@ -3296,9 +3296,9 @@ void CWallet::UpdatedTransaction(const uint256 &hashTx)\n     }\n }\n \n-void CWallet::GetScriptForMining(boost::shared_ptr<CReserveScript> &script)\n+void CWallet::GetScriptForMining(std::shared_ptr<CReserveScript> &script)\n {\n-    boost::shared_ptr<CReserveKey> rKey(new CReserveKey(this));\n+    std::shared_ptr<CReserveKey> rKey(new CReserveKey(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108517857",
      "id" : 108517857,
      "original_commit_id" : "c359a52e04514bfeb93fb45232573aff23b873d3",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108517857",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108518435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108518435"
         }
      },
      "body" : "nit: could refactor API to pass up an rvalue reference rather than take an arg.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:41:30Z",
      "diff_hunk" : "@@ -42,7 +41,7 @@ class CValidationInterface {\n     virtual void Inventory(const uint256 &hash) {}\n     virtual void ResendWalletTransactions(int64_t nBestBlockTime, CConnman* connman) {}\n     virtual void BlockChecked(const CBlock&, const CValidationState&) {}\n-    virtual void GetScriptForMining(boost::shared_ptr<CReserveScript>&) {};\n+    virtual void GetScriptForMining(std::shared_ptr<CReserveScript>&) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108518435",
      "id" : 108518435,
      "original_commit_id" : "c359a52e04514bfeb93fb45232573aff23b873d3",
      "original_position" : 13,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108518435",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108519987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108519987"
         }
      },
      "body" : "You probably don't need to use a ref to a CTransactionRef because CWalletTx is going to make a copy anyways -- you could just move it from the CWalletTx constructor.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T19:48:55Z",
      "diff_hunk" : "@@ -958,8 +958,9 @@ bool CWallet::LoadToWallet(const CWalletTx& wtxIn)\n  * Abandoned state should probably be more carefully tracked via different\n  * posInBlock signals or by checking mempool presence when necessary.\n  */\n-bool CWallet::AddToWalletIfInvolvingMe(const CTransaction& tx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)\n+bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108519987",
      "id" : 108519987,
      "original_commit_id" : "3f677fe53390b18a9a38b5308351a9cf867e6a07",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 29537478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108519987",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108527880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108527880"
         }
      },
      "body" : "Yes, there is an std::list in CZMQNotificationInterface. It might not fail build due to current header organization, but it should be included if its used (and I believe it failed build when I was making changes).",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:25:28Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n #include \"validationinterface.h\"\n #include <string>\n #include <map>\n+#include <list>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108527880",
      "id" : 108527880,
      "original_commit_id" : "892ddf12e10f7a3c810d735362ab174a44be35c4",
      "original_position" : 4,
      "path" : "src/zmq/zmqnotificationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 29564762,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108527880",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108528396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108528396"
         }
      },
      "body" : "Well the other thing is I'd like to move the new mempool disconnect cache stuff into ConnectTrace, at which point ConnectTip again will end up needing to know about the connecttrace object. Anyway, agreed, lets table this for future work.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:27:43Z",
      "diff_hunk" : "@@ -2215,24 +2215,23 @@ struct ConnectTrace {\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  *\n- * The block is always added to connectTrace (either after loading from disk or by copying\n- * pblock) - if that is not intended, care must be taken to remove the last entry in\n- * blocksConnected in case of failure.\n+ * The block is added to connectTrace if connection succeeds.\n  */\n bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108528396",
      "id" : 108528396,
      "original_commit_id" : "bd60e24d27a73682d3814fac61c7d4c59d76603b",
      "original_position" : 9,
      "path" : "src/validation.cpp",
      "position" : 150,
      "pull_request_review_id" : 29565296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108528396",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108528728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108528728"
         }
      },
      "body" : "Done.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:29:10Z",
      "diff_hunk" : "@@ -2266,6 +2265,8 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n     int64_t nTime6 = GetTimeMicros(); nTimePostConnect += nTime6 - nTime5; nTimeTotal += nTime6 - nTime1;\n     LogPrint(\"bench\", \"  - Connect postprocess: %.2fms [%.2fs]\\n\", (nTime6 - nTime5) * 0.001, nTimePostConnect * 0.000001);\n     LogPrint(\"bench\", \"- Connect block: %.2fms [%.2fs]\\n\", (nTime6 - nTime1) * 0.001, nTimeTotal * 0.000001);\n+\n+    connectTrace.blocksConnected.emplace_back(pindexNew, pthisBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108528728",
      "id" : 108528728,
      "original_commit_id" : "bd60e24d27a73682d3814fac61c7d4c59d76603b",
      "original_position" : 35,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29565662,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108528728",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108529403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108529403"
         }
      },
      "body" : "Hmm, its removed by the end and there is no equivalent vector on which to do so, so I think its fine.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:32:04Z",
      "diff_hunk" : "@@ -2203,15 +2204,18 @@ class ConnectTrace {\n \n     void NotifyEntryRemoved(CTransactionRef txRemoved, MemPoolRemovalReason reason) {\n         if (reason == MemPoolRemovalReason::CONFLICT) {\n-            conflictedTxs.push_back(txRemoved);\n+            conflictedTxs.back().push_back(txRemoved);\n         }\n     }\n \n     void CallSyncTransactionOnConflictedTransactions() {\n-        for (const auto& tx : conflictedTxs) {\n-            GetMainSignals().SyncTransaction(*tx, NULL, CMainSignals::SYNC_TRANSACTION_NOT_IN_BLOCK);\n+        for (const auto& txRemovedForBlock : conflictedTxs) {\n+            for (const auto& tx : txRemovedForBlock) {\n+                GetMainSignals().SyncTransaction(*tx, NULL, CMainSignals::SYNC_TRANSACTION_NOT_IN_BLOCK);\n+            }\n         }\n         conflictedTxs.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108529403",
      "id" : 108529403,
      "original_commit_id" : "a9c02d029aa027425c2f79f9e576167de7ef6e1c",
      "original_position" : 47,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29566377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108529403",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108530562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108530562"
         }
      },
      "body" : "Likely, but the copy-from-rvalue is mostly free, and as you previously pointed out the caller now does std::move, so I dont think it matters.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:36:51Z",
      "diff_hunk" : "@@ -2194,29 +2207,32 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        blocksConnected.emplace_back(pindex, std::move(pblock));\n-        conflictedTxs.emplace_back();\n-    }\n-\n-    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > >& GetBlocksConnected() {\n+        assert(!blocksConnected.back().pindex);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = std::move(pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108530562",
      "id" : 108530562,
      "original_commit_id" : "b275002930b394828c9c0affdf1fecba79f4d063",
      "original_position" : 52,
      "path" : "src/validation.cpp",
      "position" : 117,
      "pull_request_review_id" : 29567643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108530562",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108531071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108531071"
         }
      },
      "body" : "Its already there implicitly, and I was trying to pair back the million asserts I had in this code (because if you have NotifyEntryRemoved(), you will assert the pindex on the back is empty, and BlockConnected will assert that its setting a pindex, so if you try to call either it will fail as the back().pindex is no longer null).",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:39:08Z",
      "diff_hunk" : "@@ -2194,29 +2207,32 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        blocksConnected.emplace_back(pindex, std::move(pblock));\n-        conflictedTxs.emplace_back();\n-    }\n-\n-    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > >& GetBlocksConnected() {\n+        assert(!blocksConnected.back().pindex);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = std::move(pblock);\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We pop\n+        // the last entry here to make sure the list we return is sane.\n+        assert(!blocksConnected.back().pindex);\n+        assert(blocksConnected.back().conflictedTxs->empty());\n+        blocksConnected.pop_back();\n         return blocksConnected;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108531071",
      "id" : 108531071,
      "original_commit_id" : "b275002930b394828c9c0affdf1fecba79f4d063",
      "original_position" : 65,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29568210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108531071",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108531167"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108531167"
         }
      },
      "body" : "Done.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:39:31Z",
      "diff_hunk" : "@@ -207,7 +206,7 @@ UniValue generatetoaddress(const JSONRPCRequest& request)\n     if (!address.IsValid())\n         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Error: Invalid address\");\n \n-    boost::shared_ptr<CReserveScript> coinbaseScript(new CReserveScript());\n+    std::shared_ptr<CReserveScript> coinbaseScript(new CReserveScript());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108531167",
      "id" : 108531167,
      "original_commit_id" : "c359a52e04514bfeb93fb45232573aff23b873d3",
      "original_position" : 31,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 29568307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108531167",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108532099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108532099"
         }
      },
      "body" : "CWalletTx now copies the ref that is passed in, so using a ref here should avoid a complete copy?",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:43:30Z",
      "diff_hunk" : "@@ -958,8 +958,9 @@ bool CWallet::LoadToWallet(const CWalletTx& wtxIn)\n  * Abandoned state should probably be more carefully tracked via different\n  * posInBlock signals or by checking mempool presence when necessary.\n  */\n-bool CWallet::AddToWalletIfInvolvingMe(const CTransaction& tx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)\n+bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108532099",
      "id" : 108532099,
      "original_commit_id" : "3f677fe53390b18a9a38b5308351a9cf867e6a07",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 29569264,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108532099",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108532380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108532380"
         }
      },
      "body" : "I'll leave that for someone else in a later PR.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:44:42Z",
      "diff_hunk" : "@@ -42,7 +41,7 @@ class CValidationInterface {\n     virtual void Inventory(const uint256 &hash) {}\n     virtual void ResendWalletTransactions(int64_t nBestBlockTime, CConnman* connman) {}\n     virtual void BlockChecked(const CBlock&, const CValidationState&) {}\n-    virtual void GetScriptForMining(boost::shared_ptr<CReserveScript>&) {};\n+    virtual void GetScriptForMining(std::shared_ptr<CReserveScript>&) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108532380",
      "id" : 108532380,
      "original_commit_id" : "c359a52e04514bfeb93fb45232573aff23b873d3",
      "original_position" : 13,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 29569558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108532380",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108532392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108532392"
         }
      },
      "body" : "Done",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:44:46Z",
      "diff_hunk" : "@@ -3296,9 +3296,9 @@ void CWallet::UpdatedTransaction(const uint256 &hashTx)\n     }\n }\n \n-void CWallet::GetScriptForMining(boost::shared_ptr<CReserveScript> &script)\n+void CWallet::GetScriptForMining(std::shared_ptr<CReserveScript> &script)\n {\n-    boost::shared_ptr<CReserveKey> rKey(new CReserveKey(this));\n+    std::shared_ptr<CReserveKey> rKey(new CReserveKey(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108532392",
      "id" : 108532392,
      "original_commit_id" : "c359a52e04514bfeb93fb45232573aff23b873d3",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 29569571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108532392",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108533173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108533173"
         }
      },
      "body" : "Done",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-28T20:48:08Z",
      "diff_hunk" : "@@ -2175,17 +2175,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  *\n  * This class also tracks transactions that are removed from the mempool as\n- * conflicts and and can be used to pass all those transactions through\n- * SyncTransaction.\n+ * conflicts (per block) and and can be used to pass all those transactions\n+ * through SyncTransaction.\n  */\n class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n-    std::vector<CTransactionRef> conflictedTxs;\n+    std::vector<std::vector<CTransactionRef> > conflictedTxs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108533173",
      "id" : 108533173,
      "original_commit_id" : "a9c02d029aa027425c2f79f9e576167de7ef6e1c",
      "original_position" : 13,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29570428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108533173",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108574758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108574758"
         }
      },
      "body" : "Agree, we shouldn't rely on indirect includes.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-29T01:24:39Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n #include \"validationinterface.h\"\n #include <string>\n #include <map>\n+#include <list>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108574758",
      "id" : 108574758,
      "original_commit_id" : "892ddf12e10f7a3c810d735362ab174a44be35c4",
      "original_position" : 4,
      "path" : "src/zmq/zmqnotificationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 29614488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108574758",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK acac363e574470be7ca26ab43b7c32c2beac9d9c.",
      "created_at" : "2017-03-29T02:13:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-289961098",
      "id" : 289961098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-29T02:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/289961098",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108581806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108581806"
         }
      },
      "body" : "Ah, I was viewing the diff and didn't realize it was truncated, so I didn't see the list :) ACK the include.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-29T02:46:48Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n #include \"validationinterface.h\"\n #include <string>\n #include <map>\n+#include <list>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108581806",
      "id" : 108581806,
      "original_commit_id" : "892ddf12e10f7a3c810d735362ab174a44be35c4",
      "original_position" : 4,
      "path" : "src/zmq/zmqnotificationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 29621842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108581806",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108762239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108762239"
         }
      },
      "body" : "nit: \"and and\"",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-29T19:11:35Z",
      "diff_hunk" : "@@ -2206,19 +2173,46 @@ static int64_t nTimePostConnect = 0;\n /**\n  * Used to track blocks whose transactions were applied to the UTXO state as a\n  * part of a single ActivateBestChainStep call.\n+ *\n+ * This class also tracks transactions that are removed from the mempool as\n+ * conflicts and and can be used to pass all those transactions through",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108762239",
      "id" : 108762239,
      "original_commit_id" : "ff3d20571b35fa2f8856ea58935cd4775a00cd0c",
      "original_position" : 46,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29815725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108762239",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108768338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108768338"
         }
      },
      "body" : "This is a second call to GetBlocksConnected(), which violates the single-use requirement.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-29T19:41:32Z",
      "diff_hunk" : "@@ -2502,12 +2515,20 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             // to abandon a transaction and then have it inadvertently cleared by\n             // the notification that the conflicted transaction was evicted.\n \n+            // throw all transactions though the signal-interface\n+            for (const PerBlockConnectTrace& trace : connectTrace.GetBlocksConnected()) {\n+                assert(trace.conflictedTxs);\n+                for (const auto& tx : *trace.conflictedTxs) {\n+                    GetMainSignals().SyncTransaction(*tx, NULL, CMainSignals::SYNC_TRANSACTION_NOT_IN_BLOCK);\n+                }\n+            }\n+\n             // Transactions in the connected block are notified\n-            for (const auto& pair : connectTrace.GetBlocksConnected()) {\n-                assert(pair.second);\n-                const CBlock& block = *(pair.second);\n+            for (const PerBlockConnectTrace& trace : connectTrace.GetBlocksConnected()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108768338",
      "id" : 108768338,
      "original_commit_id" : "98ed4e0c9c15c8d7317b9175f5ef1dac722f3a7f",
      "original_position" : 114,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29815725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108768338",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108822523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108822523"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-30T01:07:46Z",
      "diff_hunk" : "@@ -2206,19 +2173,46 @@ static int64_t nTimePostConnect = 0;\n /**\n  * Used to track blocks whose transactions were applied to the UTXO state as a\n  * part of a single ActivateBestChainStep call.\n+ *\n+ * This class also tracks transactions that are removed from the mempool as\n+ * conflicts and and can be used to pass all those transactions through",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108822523",
      "id" : 108822523,
      "original_commit_id" : "ff3d20571b35fa2f8856ea58935cd4775a00cd0c",
      "original_position" : 46,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29880820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108822523",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108822863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108822863"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-30T01:11:25Z",
      "diff_hunk" : "@@ -2502,12 +2515,20 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             // to abandon a transaction and then have it inadvertently cleared by\n             // the notification that the conflicted transaction was evicted.\n \n+            // throw all transactions though the signal-interface\n+            for (const PerBlockConnectTrace& trace : connectTrace.GetBlocksConnected()) {\n+                assert(trace.conflictedTxs);\n+                for (const auto& tx : *trace.conflictedTxs) {\n+                    GetMainSignals().SyncTransaction(*tx, NULL, CMainSignals::SYNC_TRANSACTION_NOT_IN_BLOCK);\n+                }\n+            }\n+\n             // Transactions in the connected block are notified\n-            for (const auto& pair : connectTrace.GetBlocksConnected()) {\n-                assert(pair.second);\n-                const CBlock& block = *(pair.second);\n+            for (const PerBlockConnectTrace& trace : connectTrace.GetBlocksConnected()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r108822863",
      "id" : 108822863,
      "original_commit_id" : "98ed4e0c9c15c8d7317b9175f5ef1dac722f3a7f",
      "original_position" : 114,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 29881175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108822863",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109005922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109005922"
         }
      },
      "body" : "Maybe worth explicitly differentiating the cause though -- back() being null could be caused for two reasons, and if you call twice with 0 blocksconnected it will cause UB on the second call. Also, that @sdaftuar found a double call so it's worth having this.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-30T18:43:50Z",
      "diff_hunk" : "@@ -2194,29 +2207,32 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        blocksConnected.emplace_back(pindex, std::move(pblock));\n-        conflictedTxs.emplace_back();\n-    }\n-\n-    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > >& GetBlocksConnected() {\n+        assert(!blocksConnected.back().pindex);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = std::move(pblock);\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We pop\n+        // the last entry here to make sure the list we return is sane.\n+        assert(!blocksConnected.back().pindex);\n+        assert(blocksConnected.back().conflictedTxs->empty());\n+        blocksConnected.pop_back();\n         return blocksConnected;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109005922",
      "id" : 109005922,
      "original_commit_id" : "b275002930b394828c9c0affdf1fecba79f4d063",
      "original_position" : 65,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 30079157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109005922",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109008267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109008267"
         }
      },
      "body" : "The CWalletTx constructor is:\r\n```c++\r\nCWalletTx(const CWallet* pwalletIn, CTransactionRef arg) : CMerkleTx(std::move(arg))\r\n```\r\n\r\nI was suggesting to add a constructor\r\n\r\n```c++\r\nCWalletTx(const CWallet* pwalletIn, CTransactionRef&& arg) : CMerkleTx(arg)\r\n```\r\n\r\nand then update L984 to\r\n\r\n```c++\r\n            CWalletTx wtx(this, std::move(ptx));\r\n```\r\n\r\nand update this line to\r\n\r\n```c++\r\nbool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef ptx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)\r\n```\r\n\r\nThere are two reasons:\r\n  - slightly more clear intent (AddToWalletIfInvolvingMe does get ownership)\r\n  - Eliminates an indirection",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-30T18:53:34Z",
      "diff_hunk" : "@@ -958,8 +958,9 @@ bool CWallet::LoadToWallet(const CWalletTx& wtxIn)\n  * Abandoned state should probably be more carefully tracked via different\n  * posInBlock signals or by checking mempool presence when necessary.\n  */\n-bool CWallet::AddToWalletIfInvolvingMe(const CTransaction& tx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)\n+bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109008267",
      "id" : 109008267,
      "original_commit_id" : "3f677fe53390b18a9a38b5308351a9cf867e6a07",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 30081710,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109008267",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109034578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109034578"
         }
      },
      "body" : "Ahh, OK, I missed your original point. Anyway, I would still prefer to leave it because it is a smaller diff to not change CWalletTx, and the way it is you dont end up with a variable lying around which has already been std::move()d prior to the end of the function, which I dont super like doing. Anyway, feel free to clean it up in a future PR (also maybe we need a general \"when to && vs const& vs copy-and-move style guide)",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-30T20:53:10Z",
      "diff_hunk" : "@@ -958,8 +958,9 @@ bool CWallet::LoadToWallet(const CWalletTx& wtxIn)\n  * Abandoned state should probably be more carefully tracked via different\n  * posInBlock signals or by checking mempool presence when necessary.\n  */\n-bool CWallet::AddToWalletIfInvolvingMe(const CTransaction& tx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)\n+bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109034578",
      "id" : 109034578,
      "original_commit_id" : "3f677fe53390b18a9a38b5308351a9cf867e6a07",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 30111008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109034578",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109035097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109035097"
         }
      },
      "body" : "Wait, where does it UB? I think it always asserts if you misuse it. Anyway, no need to make asserts overly complicated, the preconditions here are well-documented, the asserts are probably just as useful to remove completely as leave there.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-03-30T20:55:14Z",
      "diff_hunk" : "@@ -2194,29 +2207,32 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        blocksConnected.emplace_back(pindex, std::move(pblock));\n-        conflictedTxs.emplace_back();\n-    }\n-\n-    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > >& GetBlocksConnected() {\n+        assert(!blocksConnected.back().pindex);\n+        assert(pindex);\n+        assert(pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = std::move(pblock);\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n+        // We always keep one extra block at the end of our list because\n+        // blocks are added after all the conflicted transactions have\n+        // been filled in. Thus, the last entry should always be an empty\n+        // one waiting for the transactions from the next block. We pop\n+        // the last entry here to make sure the list we return is sane.\n+        assert(!blocksConnected.back().pindex);\n+        assert(blocksConnected.back().conflictedTxs->empty());\n+        blocksConnected.pop_back();\n         return blocksConnected;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r109035097",
      "id" : 109035097,
      "original_commit_id" : "b275002930b394828c9c0affdf1fecba79f4d063",
      "original_position" : 65,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 30111537,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-07T09:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109035097",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "utACK 312683b23752bd9bdae365d0695f1ed73d3c1f3b",
      "created_at" : "2017-04-03T01:39:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-291031421",
      "id" : 291031421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-04-03T01:39:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291031421",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/250224?v=3",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "body" : "Needs rebse.",
      "created_at" : "2017-04-06T08:19:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-292102794",
      "id" : 292102794,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-04-06T08:19:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/292102794",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased trivially.",
      "created_at" : "2017-04-07T09:54:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-292493737",
      "id" : 292493737,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-04-07T09:54:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/292493737",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r110599753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110599753"
         }
      },
      "body" : "From Cpp Core Guidelines (https://github.com/isocpp/CppCoreGuidelines/blob/master/CppCoreGuidelines.md#Res-nullptr)\r\n\r\nES.47: Use nullptr rather than 0 or NULL ()\r\n\r\nReadability. Minimize surprises: nullptr cannot be confused with an int. nullptr also has a well-specified (very restrictive) type, and thus works in more scenarios where type deduction might do the wrong thing on NULL or 0.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-04-10T08:36:02Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r110599753",
      "id" : 110599753,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 31782638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-10T08:36:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110599753",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4436398?v=3",
         "events_url" : "https://api.github.com/users/bulldozer00/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bulldozer00/followers",
         "following_url" : "https://api.github.com/users/bulldozer00/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bulldozer00/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bulldozer00",
         "id" : 4436398,
         "login" : "bulldozer00",
         "organizations_url" : "https://api.github.com/users/bulldozer00/orgs",
         "received_events_url" : "https://api.github.com/users/bulldozer00/received_events",
         "repos_url" : "https://api.github.com/users/bulldozer00/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bulldozer00/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bulldozer00/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bulldozer00"
      }
   },
   {
      "body" : "utack 461e49f",
      "created_at" : "2017-04-10T14:53:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-292974076",
      "id" : 292974076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-04-10T14:53:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/292974076",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "cautious utACK b1a6d4cd560fbdb66506841860db03c08ea4bbbc.",
      "created_at" : "2017-04-10T16:37:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-293006167",
      "id" : 293006167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-04-10T16:37:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/293006167",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r110757861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110757861"
         }
      },
      "body" : "Now that `AddToWalletIfInvolvingMe()` is called with `pindexBlockConnected` set to NULL when the transaction isn't in a block, can we remove the magic -1 value for `posInBlock` (and change the `if (posInBlock != -1)` into `if (pindexBlockConnected != NULL)`)?",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-04-10T20:39:24Z",
      "diff_hunk" : "@@ -966,8 +966,9 @@ bool CWallet::LoadToWallet(const CWalletTx& wtxIn)\n  * Abandoned state should probably be more carefully tracked via different\n  * posInBlock signals or by checking mempool presence when necessary.\n  */\n-bool CWallet::AddToWalletIfInvolvingMe(const CTransaction& tx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)\n+bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r110757861",
      "id" : 110757861,
      "original_commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 31933438,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-10T20:40:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110757861",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r110759607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110759607"
         }
      },
      "body" : "Sure, go for it. Still gonna have to pass in two parameters either way, sadly :/.",
      "commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "created_at" : "2017-04-10T20:48:02Z",
      "diff_hunk" : "@@ -966,8 +966,9 @@ bool CWallet::LoadToWallet(const CWalletTx& wtxIn)\n  * Abandoned state should probably be more carefully tracked via different\n  * posInBlock signals or by checking mempool presence when necessary.\n  */\n-bool CWallet::AddToWalletIfInvolvingMe(const CTransaction& tx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)\n+bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockIndex* pIndex, int posInBlock, bool fUpdate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r110759607",
      "id" : 110759607,
      "original_commit_id" : "b1a6d4cd560fbdb66506841860db03c08ea4bbbc",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 31955637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-04-10T20:48:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110759607",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Nice to learn about 'override'",
      "created_at" : "2017-04-12T23:40:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-293737192",
      "id" : 293737192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-04-12T23:40:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/293737192",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   }
]
