[
   {
      "body" : "This works great for me as is and is a good first step to fixing this.",
      "created_at" : "2011-05-27T05:11:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1247248",
      "id" : 1247248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-05-27T05:11:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1247248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48147?v=3",
         "events_url" : "https://api.github.com/users/jrmithdobbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jrmithdobbs/followers",
         "following_url" : "https://api.github.com/users/jrmithdobbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jrmithdobbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jrmithdobbs",
         "id" : 48147,
         "login" : "jrmithdobbs",
         "organizations_url" : "https://api.github.com/users/jrmithdobbs/orgs",
         "received_events_url" : "https://api.github.com/users/jrmithdobbs/received_events",
         "repos_url" : "https://api.github.com/users/jrmithdobbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jrmithdobbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jrmithdobbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jrmithdobbs"
      }
   },
   {
      "body" : "Can you rebase? This doesn't apply to current tree.",
      "created_at" : "2011-05-29T19:02:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1257837",
      "id" : 1257837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-05-29T19:02:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1257837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/714836?v=3",
         "events_url" : "https://api.github.com/users/shanew/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shanew/followers",
         "following_url" : "https://api.github.com/users/shanew/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shanew/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shanew",
         "id" : 714836,
         "login" : "shanew",
         "organizations_url" : "https://api.github.com/users/shanew/orgs",
         "received_events_url" : "https://api.github.com/users/shanew/received_events",
         "repos_url" : "https://api.github.com/users/shanew/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shanew/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shanew/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shanew"
      }
   },
   {
      "body" : "Rebased to current tree.",
      "created_at" : "2011-05-30T02:57:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1259583",
      "id" : 1259583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-05-30T02:57:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1259583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/43821?v=3",
         "events_url" : "https://api.github.com/users/jordanlewis/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jordanlewis/followers",
         "following_url" : "https://api.github.com/users/jordanlewis/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jordanlewis/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jordanlewis",
         "id" : 43821,
         "login" : "jordanlewis",
         "organizations_url" : "https://api.github.com/users/jordanlewis/orgs",
         "received_events_url" : "https://api.github.com/users/jordanlewis/received_events",
         "repos_url" : "https://api.github.com/users/jordanlewis/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jordanlewis/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jordanlewis/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jordanlewis"
      }
   },
   {
      "body" : "Using this patch on a heavily loaded bitcoind, I am getting quite a few:\r\nreservekeyfromkeypool(): read failed\r\nfrom send transactions.\r\n\r\nI backed out the patch and so far so good but time will tell. Are you aware of any wallet locking issues with this async code?",
      "created_at" : "2011-06-07T18:12:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1319552",
      "id" : 1319552,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-07T18:12:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1319552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/714836?v=3",
         "events_url" : "https://api.github.com/users/shanew/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shanew/followers",
         "following_url" : "https://api.github.com/users/shanew/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shanew/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shanew",
         "id" : 714836,
         "login" : "shanew",
         "organizations_url" : "https://api.github.com/users/shanew/orgs",
         "received_events_url" : "https://api.github.com/users/shanew/received_events",
         "repos_url" : "https://api.github.com/users/shanew/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shanew/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shanew/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shanew"
      }
   },
   {
      "body" : "Can you rebase with latest version?  With transaction fee 0.0005 ?\r\nWhy this important pull still not merged with upstream?",
      "created_at" : "2011-06-10T03:20:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1339522",
      "id" : 1339522,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-10T03:20:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1339522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/145080?v=3",
         "events_url" : "https://api.github.com/users/dlancer/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dlancer/followers",
         "following_url" : "https://api.github.com/users/dlancer/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dlancer/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dlancer",
         "id" : 145080,
         "login" : "dlancer",
         "organizations_url" : "https://api.github.com/users/dlancer/orgs",
         "received_events_url" : "https://api.github.com/users/dlancer/received_events",
         "repos_url" : "https://api.github.com/users/dlancer/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dlancer/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dlancer/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dlancer"
      }
   },
   {
      "body" : "Any updated test results, from heavily loaded bitcoind's?",
      "created_at" : "2011-06-14T09:10:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1364748",
      "id" : 1364748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-14T09:10:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1364748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "I'm running this patch on a loaded server. It works fine, but I've seen one problem. If I do \"bitcoind listtransactions\" I get a correct list of transactions. If I do \"bitcoind listtransactions \"\" 1000\" I get:\r\nerror: couldn't parse reply from server\r\n",
      "created_at" : "2011-06-17T04:28:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1385997",
      "id" : 1385997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-17T04:28:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1385997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16599?v=3",
         "events_url" : "https://api.github.com/users/doublec/events{/privacy}",
         "followers_url" : "https://api.github.com/users/doublec/followers",
         "following_url" : "https://api.github.com/users/doublec/following{/other_user}",
         "gists_url" : "https://api.github.com/users/doublec/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/doublec",
         "id" : 16599,
         "login" : "doublec",
         "organizations_url" : "https://api.github.com/users/doublec/orgs",
         "received_events_url" : "https://api.github.com/users/doublec/received_events",
         "repos_url" : "https://api.github.com/users/doublec/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/doublec/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/doublec/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/doublec"
      }
   },
   {
      "body" : "Any chance you can look at wireshark output, or some other way of dumping the network traffic, and see what's going on?  Sounds like output was truncated somewhere.",
      "created_at" : "2011-06-17T04:40:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1386030",
      "id" : 1386030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-17T04:40:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1386030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Yep, I'll do that in a day or so and report back.",
      "created_at" : "2011-06-17T04:45:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1386043",
      "id" : 1386043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-17T04:45:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1386043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16599?v=3",
         "events_url" : "https://api.github.com/users/doublec/events{/privacy}",
         "followers_url" : "https://api.github.com/users/doublec/followers",
         "following_url" : "https://api.github.com/users/doublec/following{/other_user}",
         "gists_url" : "https://api.github.com/users/doublec/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/doublec",
         "id" : 16599,
         "login" : "doublec",
         "organizations_url" : "https://api.github.com/users/doublec/orgs",
         "received_events_url" : "https://api.github.com/users/doublec/received_events",
         "repos_url" : "https://api.github.com/users/doublec/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/doublec/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/doublec/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/doublec"
      }
   },
   {
      "body" : "I don't have the dumps I made handy but I've seen this issue as well. It only seems to happen on large RPC calls like listtransactions. I actually ran across it testing out sipa's showwallet branch for privkey import/export and didn't make the correlation until seeing your comments.\r\n\r\nReverting this makes it stop happening. So there's definitely an issue here and this shouldn't be pulled until resolved.\r\n\r\nThe dumps I did showed it just cutting off in the middle sometimes or sometimes leaving out chunks of the response that made the json not validate.",
      "created_at" : "2011-06-17T12:58:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1387943",
      "id" : 1387943,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-17T12:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1387943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48147?v=3",
         "events_url" : "https://api.github.com/users/jrmithdobbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jrmithdobbs/followers",
         "following_url" : "https://api.github.com/users/jrmithdobbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jrmithdobbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jrmithdobbs",
         "id" : 48147,
         "login" : "jrmithdobbs",
         "organizations_url" : "https://api.github.com/users/jrmithdobbs/orgs",
         "received_events_url" : "https://api.github.com/users/jrmithdobbs/received_events",
         "repos_url" : "https://api.github.com/users/jrmithdobbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jrmithdobbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jrmithdobbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jrmithdobbs"
      }
   },
   {
      "body" : "Thanks for the testing guys. I'll look into this issue.",
      "created_at" : "2011-06-17T15:39:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1388936",
      "id" : 1388936,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-17T15:39:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1388936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/43821?v=3",
         "events_url" : "https://api.github.com/users/jordanlewis/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jordanlewis/followers",
         "following_url" : "https://api.github.com/users/jordanlewis/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jordanlewis/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jordanlewis",
         "id" : 43821,
         "login" : "jordanlewis",
         "organizations_url" : "https://api.github.com/users/jordanlewis/orgs",
         "received_events_url" : "https://api.github.com/users/jordanlewis/received_events",
         "repos_url" : "https://api.github.com/users/jordanlewis/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jordanlewis/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jordanlewis/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jordanlewis"
      }
   },
   {
      "body" : "Some more info. It also happens on RPC requests *receiving* a lot of data. Eg, sipa's importwallet. The \"alot\" seems to be around the 1k boundary or so from my very brief testing.",
      "created_at" : "2011-06-18T15:25:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1393618",
      "id" : 1393618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-18T15:25:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1393618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48147?v=3",
         "events_url" : "https://api.github.com/users/jrmithdobbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jrmithdobbs/followers",
         "following_url" : "https://api.github.com/users/jrmithdobbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jrmithdobbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jrmithdobbs",
         "id" : 48147,
         "login" : "jrmithdobbs",
         "organizations_url" : "https://api.github.com/users/jrmithdobbs/orgs",
         "received_events_url" : "https://api.github.com/users/jrmithdobbs/received_events",
         "repos_url" : "https://api.github.com/users/jrmithdobbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jrmithdobbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jrmithdobbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jrmithdobbs"
      }
   },
   {
      "body" : "I'm willing to pay to get this fixed and working in production use. \r\nAlso looking for a keep-alive solution which would reuse connections to bitcoind.",
      "created_at" : "2011-06-25T22:44:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1439471",
      "id" : 1439471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-25T22:44:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1439471",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/151606?v=3",
         "events_url" : "https://api.github.com/users/jine/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jine/followers",
         "following_url" : "https://api.github.com/users/jine/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jine/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jine",
         "id" : 151606,
         "login" : "jine",
         "organizations_url" : "https://api.github.com/users/jine/orgs",
         "received_events_url" : "https://api.github.com/users/jine/received_events",
         "repos_url" : "https://api.github.com/users/jine/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jine/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jine/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jine"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/214#discussion_r53752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/214"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/53752"
         }
      },
      "body" : "str goes out of scope when the method returns",
      "commit_id" : "bb04a7750c84a07dc2889155ce5a4895b8253297",
      "created_at" : "2011-06-28T18:56:44Z",
      "diff_hunk" : "@@ -1946,22 +1943,307 @@ void ThreadRPCServer2(void* parg)\n \n                 // Send reply\n                 string strReply = JSONRPCReply(result, Value::null, id);\n-                stream << HTTPReply(200, strReply) << std::flush;\n+                respond(HTTPReply(200, strReply));\n             }\n             catch (std::exception& e)\n             {\n-                ErrorReply(stream, JSONRPCError(-1, e.what()), id);\n+                respond(ErrorString(JSONRPCError(-1, e.what()), id));\n             }\n         }\n         catch (Object& objError)\n         {\n-            ErrorReply(stream, objError, id);\n+            respond(ErrorString(objError, id));\n         }\n         catch (std::exception& e)\n         {\n-            ErrorReply(stream, JSONRPCError(-32700, e.what()), id);\n+            respond(ErrorString(JSONRPCError(-32700, e.what()), id));\n         }\n+        delete[] pszBody;\n+    }\n+\n+    /* Called asynchronously during body read. Returns the number of bytes of\n+     * data that's still expected from the network. */\n+    size_t body_done_condition(const boost::system::error_code& err,\n+                               size_t nBytes)\n+    {\n+        if (nBytes < nBytesExpected)\n+            return nBytesExpected - nBytes;\n+        else\n+            return 0;\n+    }\n+\n+    /* Do any necessary handling once the response to the JSONRPC call is\n+     * dispatched to the client. */\n+    void handle_response(const boost::system::error_code& err, size_t nBytes)\n+    {}\n+\n+    ip::tcp::endpoint& getPeer()\n+    {\n+        return peer;\n+    }\n+protected:\n+    ip::tcp::endpoint peer;\n+    asio::streambuf streambuf;\n+    size_t nBytesExpected;\n+};\n+\n+#ifdef USE_SSL\n+/* An RPCConnection that uses SSL. */\n+class SSLRPCConnection :public boost::enable_shared_from_this<SSLRPCConnection>,\n+                        public RPCConnection\n+{\n+public:\n+    SSLRPCConnection(asio::io_service& io_service, ssl::context& context)\n+        : socket(io_service, context)\n+    {}\n+    void start()\n+    {\n+        if (! ClientAllowed(peer.address().to_string()))\n+            return;\n+        socket.async_handshake(ssl::stream_base::server,\n+            boost::bind(&SSLRPCConnection::handle_handshake, shared_from_this(),\n+                        asio::placeholders::error));\n+    }\n+    void handle_handshake(const boost::system::error_code& err)\n+    {\n+        if (err) return;\n+        do_read_status();\n+    }\n+    void do_read_status()\n+    {\n+        asio::async_read_until(socket, streambuf, \"\\r\\n\",\n+            boost::bind(&SSLRPCConnection::handle_read_status,\n+                        shared_from_this(), asio::placeholders::error,\n+                        asio::placeholders::bytes_transferred));\n+    }\n+    void do_read_header()\n+    {\n+        asio::async_read_until(socket, streambuf, \"\\r\\n\\r\\n\",\n+            boost::bind(&SSLRPCConnection::handle_read_header,\n+                        shared_from_this(), asio::placeholders::error,\n+                        asio::placeholders::bytes_transferred));\n+    }\n+    void do_read_body()\n+    {\n+        asio::async_read(socket, streambuf,\n+            boost::bind(&SSLRPCConnection::body_done_condition,\n+                        shared_from_this(), asio::placeholders::error,\n+                        asio::placeholders::bytes_transferred),\n+            boost::bind(&SSLRPCConnection::handle_read_body,\n+                        shared_from_this(), asio::placeholders::error,\n+                        asio::placeholders::bytes_transferred));\n+    }\n+    void respond(std::string str)\n+    {\n+        boost::asio::async_write(socket, boost::asio::buffer(str),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#discussion_r53752",
      "id" : 53752,
      "original_commit_id" : "bb04a7750c84a07dc2889155ce5a4895b8253297",
      "original_position" : 362,
      "path" : "src/rpc.cpp",
      "position" : 362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/214",
      "updated_at" : "2011-06-28T18:56:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/53752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/529626?v=3",
         "events_url" : "https://api.github.com/users/ius/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ius/followers",
         "following_url" : "https://api.github.com/users/ius/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ius/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ius",
         "id" : 529626,
         "login" : "ius",
         "organizations_url" : "https://api.github.com/users/ius/orgs",
         "received_events_url" : "https://api.github.com/users/ius/received_events",
         "repos_url" : "https://api.github.com/users/ius/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ius/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ius/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ius"
      }
   },
   {
      "body" : "See comment above. A possible fix: http://pastie.org/private/d04wwgdsk881yl70k1g\r\n\r\nI'm not familiar with boost though, so there might very well be a better solution.",
      "created_at" : "2011-06-28T18:59:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1458085",
      "id" : 1458085,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-06-28T19:10:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1458085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/529626?v=3",
         "events_url" : "https://api.github.com/users/ius/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ius/followers",
         "following_url" : "https://api.github.com/users/ius/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ius/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ius",
         "id" : 529626,
         "login" : "ius",
         "organizations_url" : "https://api.github.com/users/ius/orgs",
         "received_events_url" : "https://api.github.com/users/ius/received_events",
         "repos_url" : "https://api.github.com/users/ius/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ius/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ius/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ius"
      }
   },
   {
      "body" : "If your plan is to optimize the RPC code, you're kind of barking up the wrong tree. The socket I/O is only about 3% of the load coming from the RPC code. If you just want it to handle more than one connection at a time and keepalives, just dispatching the RPC to a thread (and fixing the protocol handler to close the socket when it's the right time) does it.\r\n\r\nThe breakdown is, roughly:\r\n30% Do the actual operation (various based on the operation, of course)\r\n20% Parse JSON request\r\n20% Generate JSON reply\r\n15% Parse HTTP\r\n 4% Check user/pass/IP\r\n 3% Socket I/O\r\n 2% Make JSON reply\r\n 1% Send HTTP reply\r\n\r\nThis is still the right thing to do. However, there are much simpler and less invasive ways to accomplish the same thing. Now, if you had done this for the net code, that would actually make a huge difference.\r\n",
      "created_at" : "2011-07-03T01:17:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1491109",
      "id" : 1491109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-07-03T01:17:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1491109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/877549?v=3",
         "events_url" : "https://api.github.com/users/JoelKatz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JoelKatz/followers",
         "following_url" : "https://api.github.com/users/JoelKatz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JoelKatz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JoelKatz",
         "id" : 877549,
         "login" : "JoelKatz",
         "organizations_url" : "https://api.github.com/users/JoelKatz/orgs",
         "received_events_url" : "https://api.github.com/users/JoelKatz/received_events",
         "repos_url" : "https://api.github.com/users/JoelKatz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JoelKatz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JoelKatz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JoelKatz"
      }
   },
   {
      "body" : "@JoelKatz:  you missed the point.  This is not an optimization, but a big step towards correcting a major design flaw.  The current RPC code executes HTTP requests in order, in a FIFO queue.\r\n\r\nYou can find examples of this logic in \"My First TCP Server\" style code examples, but never in any production server.  A synchronous, FIFO approach stalls all clients except the \"current\" one.  If the current client is, itself, stalled or slow or misbehaving, then all other clients suffer.\r\n\r\nAsynchronous I/O + HTTP/1.1 keep alives are desperately needed to solve obvious problems seen in the field by heavy RPC users.",
      "created_at" : "2011-07-03T01:32:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1491134",
      "id" : 1491134,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-07-03T01:32:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1491134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "As I said, that issue is more easily solved by simply dispatching the RPC to a thread and making the trivial fixes to the keepalive logic. There aren't enough RPC connections, and the operation order is always accept/read/write, so you don't get any benefit from asynchronous I/O. In contrast, in the 'net' code, you have many connections and unpredictable operation order. That code would significantly benefit from async I/O.\r\n",
      "created_at" : "2011-07-03T03:08:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1491258",
      "id" : 1491258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-07-03T03:08:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1491258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/877549?v=3",
         "events_url" : "https://api.github.com/users/JoelKatz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JoelKatz/followers",
         "following_url" : "https://api.github.com/users/JoelKatz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JoelKatz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JoelKatz",
         "id" : 877549,
         "login" : "JoelKatz",
         "organizations_url" : "https://api.github.com/users/JoelKatz/orgs",
         "received_events_url" : "https://api.github.com/users/JoelKatz/received_events",
         "repos_url" : "https://api.github.com/users/JoelKatz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JoelKatz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JoelKatz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JoelKatz"
      }
   },
   {
      "body" : "One thread per RPC connection is unscalable in many modern workloads.  That is also potentially DoS'able, if you're not careful.",
      "created_at" : "2011-07-03T03:10:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1491260",
      "id" : 1491260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-07-03T03:10:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1491260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "I don't think many people, if any, expose their bitcoin RPC connections to the world. So I don't think the DoS issue is particularly important. I guess you could argue that they don't because they can't, and if they could, they might. But I think most people run a bitcoin client on each machine that needs to issue RPC queries and should bind their RPC listening sockets to 'localhost' only.\r\n\r\nAs for RPC not being scalable in modern workloads, I would argue that modern workloads include proper support for keepalives and don't require large numbers of connections.\r\n\r\nIf there's a realistic case where asio for RPC provides any benefit over thread-per-connection with proper keepalive support, I don't know what it is. Again, I still think this patch is \"the right thing to do\", but I don't think there will be any actual benefit in any realistic use case. (Again, over dipatching the RPC calls to threads and fixing the broken HTTP keepalive implementation. You have to at least do that.)",
      "created_at" : "2011-07-03T03:35:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1491291",
      "id" : 1491291,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-07-03T03:35:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1491291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/877549?v=3",
         "events_url" : "https://api.github.com/users/JoelKatz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JoelKatz/followers",
         "following_url" : "https://api.github.com/users/JoelKatz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JoelKatz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JoelKatz",
         "id" : 877549,
         "login" : "JoelKatz",
         "organizations_url" : "https://api.github.com/users/JoelKatz/orgs",
         "received_events_url" : "https://api.github.com/users/JoelKatz/received_events",
         "repos_url" : "https://api.github.com/users/JoelKatz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JoelKatz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JoelKatz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JoelKatz"
      }
   },
   {
      "body" : "Any rebase / update for current tree?",
      "created_at" : "2011-07-15T03:46:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-1577433",
      "id" : 1577433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-07-15T03:46:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "The pull has become unmergeable (without conflicts), and will be closed in 15 days from this message if action is not taken.\r\n\r\nTo prevent closure, kindly rebase the pull to merge cleanly with the current codebase. If a time extension is needed, please respond to this comment or contact QA@BitcoinTesting.org.",
      "created_at" : "2011-09-30T08:06:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-2247130",
      "id" : 2247130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-09-30T08:06:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2247130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008330?v=3",
         "events_url" : "https://api.github.com/users/alexwaters/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexwaters/followers",
         "following_url" : "https://api.github.com/users/alexwaters/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexwaters/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexwaters",
         "id" : 1008330,
         "login" : "alexwaters",
         "organizations_url" : "https://api.github.com/users/alexwaters/orgs",
         "received_events_url" : "https://api.github.com/users/alexwaters/received_events",
         "repos_url" : "https://api.github.com/users/alexwaters/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexwaters/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexwaters/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexwaters"
      }
   },
   {
      "body" : "Sorry guys, I don't have the time to maintain this pull indefinitely. Anyone please feel free to rebase and maintain yourself. I think it's an important patch.",
      "created_at" : "2011-09-30T13:41:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-2249488",
      "id" : 2249488,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-09-30T13:41:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2249488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/43821?v=3",
         "events_url" : "https://api.github.com/users/jordanlewis/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jordanlewis/followers",
         "following_url" : "https://api.github.com/users/jordanlewis/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jordanlewis/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jordanlewis",
         "id" : 43821,
         "login" : "jordanlewis",
         "organizations_url" : "https://api.github.com/users/jordanlewis/orgs",
         "received_events_url" : "https://api.github.com/users/jordanlewis/received_events",
         "repos_url" : "https://api.github.com/users/jordanlewis/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jordanlewis/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jordanlewis/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jordanlewis"
      }
   },
   {
      "body" : "Closed pending rebase / additional commentary. The rebase label has been applied.",
      "created_at" : "2011-10-20T05:39:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/214#issuecomment-2464974",
      "id" : 2464974,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/214",
      "updated_at" : "2011-10-20T05:46:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2464974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008330?v=3",
         "events_url" : "https://api.github.com/users/alexwaters/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexwaters/followers",
         "following_url" : "https://api.github.com/users/alexwaters/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexwaters/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexwaters",
         "id" : 1008330,
         "login" : "alexwaters",
         "organizations_url" : "https://api.github.com/users/alexwaters/orgs",
         "received_events_url" : "https://api.github.com/users/alexwaters/received_events",
         "repos_url" : "https://api.github.com/users/alexwaters/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexwaters/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexwaters/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexwaters"
      }
   }
]
