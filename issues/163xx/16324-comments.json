[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16487](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16487.html) (validationinterface: add unused CChainState parameter by jamesob)\n* [#16443](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16443.html) (refactor: have CCoins* data managed under CChainState by jamesob)\n* [#16411](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16411.html) (Signet support by kallewoof)\n* [#16333](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16333.html) (test: Set BIP34Height = 2 for regtest by MarcoFalke)\n* [#16279](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16279.html) (Return the AcceptBlock CValidationState directly in ProcessNewBlock by TheBlueMatt)\n* [#16248](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16248.html) (Make whitebind/whitelist permissions more flexible by NicolasDorier)\n* [#16202](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16202.html) (Refactor network message deserialization by jonasschnelli)\n* [#15545](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15545.html) ([doc] explain why CheckBlock() is called before AcceptBlock by Sjors)\n* [#15206](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15206.html) (Immediately disconnect on invalid net message checksum by jonasschnelli)\n* [#14046](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14046.html) (net: Refactor message parsing (CNetMessage), adds flexibility by jonasschnelli)\n* [#9849](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/9849.html) (Qt: Network Watch tool by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-07-02T16:37:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16324#issuecomment-507754293",
      "id" : 507754293,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16324",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwNzc1NDI5Mw==",
      "updated_at" : "2019-07-30T19:35:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/507754293",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16324#discussion_r301985282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301985282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This `peerstate` shadows the `peerstate` in the outer context. Consider renaming :-)",
      "commit_id" : "47e762a6d9659fda8173daab886b579645a244fd",
      "created_at" : "2019-07-10T10:05:05Z",
      "diff_hunk" : "@@ -3236,9 +3314,46 @@ bool PeerLogicValidation::SendRejectsAndCheckIfBanned(CNode* pnode, bool enable_\n     return false;\n }\n \n+bool IsPendingBlockValidation(CNode* pfrom, CPeerState* peerstate) EXCLUSIVE_LOCKS_REQUIRED(cs_peerstate)\n+{\n+    if (peerstate->pending_block_processing.valid()) {\n+        if (peerstate->pending_block_processing.wait_for(std::chrono::duration<int>::zero()) == std::future_status::ready) {\n+            bool fNewBlock = peerstate->pending_block_processing.get();\n+            if (fNewBlock) {\n+                pfrom->nLastBlockTime = GetTime();\n+            } else {\n+                LOCK(cs_main);\n+                mapBlockSource.erase(peerstate->pending_block_hash);\n+            }\n+            peerstate->pending_block_processing = std::future<bool>();\n+            peerstate->pending_block_hash = uint256();\n+\n+            // We need to wait for BlockChecked to fire, so we don't re-enable\n+            // this peer until the current pending validationinterface callbacks\n+            // drain. This ensures bans and reject messages happen in order, as\n+            // expected by some of our functional tests.\n+            peerstate->pending_event_wait = true;\n+            NodeId node_id = pfrom->GetId();\n+            CallFunctionInValidationInterfaceQueue([node_id] {\n+                LOCK(cs_peerstate);\n+                CPeerState* peerstate = PeerState(node_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16324#discussion_r301985282",
      "id" : 301985282,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTk4NTI4Mg==",
      "original_commit_id" : "c2814df83692c5a1f8c4f893e8324cee3a263a22",
      "original_position" : 663,
      "path" : "src/net_processing.cpp",
      "position" : 915,
      "pull_request_review_id" : 259993443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16324",
      "updated_at" : "2019-07-30T18:05:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301985282",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16324#discussion_r301986225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301986225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could be const ref since only used as such?",
      "commit_id" : "47e762a6d9659fda8173daab886b579645a244fd",
      "created_at" : "2019-07-10T10:07:34Z",
      "diff_hunk" : "@@ -3430,15 +3462,96 @@ bool CChainState::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, CVali\n     return true;\n }\n \n-bool ProcessNewBlock(const CChainParams& chainparams, const std::shared_ptr<const CBlock> pblock, bool fForceProcessing, bool *fNewBlock)\n+void CChainState::ProcessBlockValidationQueue()\n+{\n+    while (true) {\n+        LimitValidationInterfaceQueue();\n+\n+        std::shared_ptr<const CBlock> pblock;\n+        bool fForceProcessing;\n+        std::promise<bool> result_promise;\n+        {\n+            std::unique_lock<CCriticalSection> lock(m_cs_block_validation_queue);\n+            if (m_block_validation_queue.empty()) {\n+                m_cv_block_validation_queue.wait_for(lock, std::chrono::seconds(1));\n+            }\n+            if (ShutdownRequested())\n+                break;\n+            boost::this_thread::interruption_point();\n+            if (m_block_validation_queue.empty()) {\n+                continue;\n+            }\n+\n+            std::tuple<std::shared_ptr<const CBlock>, bool, std::promise<bool>>& tuple = m_block_validation_queue.front();\n+            pblock = std::move(std::get<0>(tuple));\n+            fForceProcessing = std::get<1>(tuple);\n+            result_promise = std::move(std::get<2>(tuple));\n+            m_block_validation_queue.pop_front();\n+        }\n+\n+        CChainParams chainparams = Params();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16324#discussion_r301986225",
      "id" : 301986225,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTk4NjIyNQ==",
      "original_commit_id" : "c2814df83692c5a1f8c4f893e8324cee3a263a22",
      "original_position" : 137,
      "path" : "src/validation.cpp",
      "position" : 171,
      "pull_request_review_id" : 259993443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16324",
      "updated_at" : "2019-07-30T18:05:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301986225",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-07-16T17:17:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16324#issuecomment-511906999",
      "id" : 511906999,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16324",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMTkwNjk5OQ==",
      "updated_at" : "2019-07-16T17:17:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/511906999",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Working on a big structural cleanup, will reopen something new once I have a new PR series.",
      "created_at" : "2019-07-18T21:20:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16324#issuecomment-512992024",
      "id" : 512992024,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16324",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMjk5MjAyNA==",
      "updated_at" : "2019-07-18T21:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/512992024",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Actually I was somewhat confused by some existing bugs triggering on travis. I think this is good as-is, original description applies, modulo moving CheckBlock out of cs_main.",
      "created_at" : "2019-07-30T18:08:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16324#issuecomment-516530521",
      "id" : 516530521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16324",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNjUzMDUyMQ==",
      "updated_at" : "2019-07-30T18:08:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/516530521",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16324#discussion_r310240712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310240712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's not captured so does is it really shadows?",
      "commit_id" : "47e762a6d9659fda8173daab886b579645a244fd",
      "created_at" : "2019-08-02T18:05:51Z",
      "diff_hunk" : "@@ -3236,9 +3314,46 @@ bool PeerLogicValidation::SendRejectsAndCheckIfBanned(CNode* pnode, bool enable_\n     return false;\n }\n \n+bool IsPendingBlockValidation(CNode* pfrom, CPeerState* peerstate) EXCLUSIVE_LOCKS_REQUIRED(cs_peerstate)\n+{\n+    if (peerstate->pending_block_processing.valid()) {\n+        if (peerstate->pending_block_processing.wait_for(std::chrono::duration<int>::zero()) == std::future_status::ready) {\n+            bool fNewBlock = peerstate->pending_block_processing.get();\n+            if (fNewBlock) {\n+                pfrom->nLastBlockTime = GetTime();\n+            } else {\n+                LOCK(cs_main);\n+                mapBlockSource.erase(peerstate->pending_block_hash);\n+            }\n+            peerstate->pending_block_processing = std::future<bool>();\n+            peerstate->pending_block_hash = uint256();\n+\n+            // We need to wait for BlockChecked to fire, so we don't re-enable\n+            // this peer until the current pending validationinterface callbacks\n+            // drain. This ensures bans and reject messages happen in order, as\n+            // expected by some of our functional tests.\n+            peerstate->pending_event_wait = true;\n+            NodeId node_id = pfrom->GetId();\n+            CallFunctionInValidationInterfaceQueue([node_id] {\n+                LOCK(cs_peerstate);\n+                CPeerState* peerstate = PeerState(node_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16324#discussion_r310240712",
      "id" : 310240712,
      "in_reply_to_id" : 301985282,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMDI0MDcxMg==",
      "original_commit_id" : "c2814df83692c5a1f8c4f893e8324cee3a263a22",
      "original_position" : 663,
      "path" : "src/net_processing.cpp",
      "position" : 915,
      "pull_request_review_id" : 270320826,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16324",
      "updated_at" : "2019-08-02T18:05:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310240712",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
