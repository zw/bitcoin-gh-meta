[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2022-08-29T23:11:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1230961273",
      "id" : 1230961273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585JXvp5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1230961273/reactions"
      },
      "updated_at" : "2022-09-24T23:43:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1230961273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nLimiting the functionality to descriptor wallets is fine. We could add an argument to `loadwallet` that prevents a rescan, so a user can migrate (#19602) to a descriptor wallet and then rescan.\r\n\r\nIs there anything in @jamesob's #23549 you can reuse here?\r\n\r\nThe `rescanwallet` RPC help should mention that having `-blockfilterindex=1` dramatically speeds things up. It might also be good to have log message somewhere that it's using the block filter.\r\n\r\nI tried a rescan from genesis on a simple mainnet wallet. It was blazing fast (in comparison) and it found all transactions. It's  also slightly faster than the little helper script I wrote for [#23549](https://github.com/bitcoin/bitcoin/pull/23549#issuecomment-1149904391).\r\n\r\nBonus feature for a followup: fetch any matching pruned blocks.",
      "created_at" : "2022-08-31T12:12:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1232855764",
      "id" : 1232855764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Je-LU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232855764/reactions"
      },
      "updated_at" : "2022-08-31T12:38:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232855764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-09-01T21:15:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1234790738",
      "id" : 1234790738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585JmWlS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234790738/reactions"
      },
      "updated_at" : "2022-09-01T21:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234790738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on master, with a few changes and an extra commit (see below).\r\n\r\n@Sjors:\r\n\r\nThanks for your initial feedback, much appreciated!\r\n\r\n> Limiting the functionality to descriptor wallets is fine. We could add an argument to `loadwallet` that prevents a rescan, so a user can migrate (#19602) to a descriptor wallet and then rescan.\r\n\r\nAgree, I think this sounds like a useful follow-up idea.\r\n\r\n> Is there anything in @jamesob's #23549 you can reuse here?\r\n\r\nNot that I could see; on contrast to scanblocks, the filter set is created from wallet-internal source rather than external user input and also has to be updated continuously.\r\n\r\n> The `rescanwallet` RPC help should mention that having `-blockfilterindex=1` dramatically speeds things up. It might also be good to have log message somewhere that it's using the block filter.\r\n\r\nDone, added [an extra commit](https://github.com/bitcoin/bitcoin/pull/25957/commits/d0114e02cddd9bf1cc8760ebe95941f80609259b) that documents the speedup possibilty for all RPCs that work on descriptor wallet and (possibly) involve a rescan (`rescanblockchain`, `importdescriptors`, `restorewallet` and `loadwallet`; did I miss any?). Also extended the \"Rescan started from block...\" debug message, showing if the fast or slow variant is used.\r\n\r\n> \r\n> I tried a rescan from genesis on a simple mainnet wallet. It was blazing fast (in comparison) and it found all transactions. It's also slightly faster than the little helper script I wrote for [#23549](https://github.com/bitcoin/bitcoin/pull/23549#issuecomment-1149904391).\r\n\r\nð ð ð \r\n\r\n> \r\n> Bonus feature for a followup: fetch any matching pruned blocks.\r\n\r\nSounds like a charming idea ð \r\n\r\nNote that this PR is covered in the [PR review club for next wednesday](https://bitcoincore.reviews/25957), hosted by LarryRuane.",
      "created_at" : "2022-09-02T16:23:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1235691177",
      "id" : 1235691177,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Jpyap",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235691177/reactions"
      },
      "updated_at" : "2022-09-02T16:23:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235691177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962466047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962466047"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "d0114e02cddd9bf1cc8760ebe95941f80609259b nit\r\n```suggestion\r\n            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\r\n```",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T04:27:22Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962466047",
      "id" : 962466047,
      "line" : 275,
      "node_id" : "PRRC_kwDOABII5845XhD_",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 275,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 1095833132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962466047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T19:35:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962466047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962912290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962912290"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Some methods here are called `has...`, others `have...`. I'm not sure where the `have...` comes from, but it sounds weird. Could you change that to `hasBlockFilterIndex()` ?\r\n```suggestion\r\n    virtual bool hasBlockFilterIndex() = 0;\r\n```",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T13:31:48Z",
      "diff_hunk" : "@@ -143,6 +144,13 @@ class Chain\n     //! or one of its ancestors.\n     virtual std::optional<int> findLocatorFork(const CBlockLocator& locator) = 0;\n \n+    //! Returns whether a block filter index is available.\n+    virtual bool haveBlockFilterIndex() = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962912290",
      "id" : 962912290,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII5845ZOAi",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 148,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 13,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962912290/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962912290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962921746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962921746"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There's a bit of an interface inconsistency here (and in `blockFilterMatchesAny `) in that so far most of the blockfilter functions don't assume the type to be basic but rather expect them to be passed. Have you considered this? One alternative could be add \"basic\" in the function name, which can then be refactored later if/when we have more filtertypes, but at least then it'll be more explicit? At first glance, I _think_ I'd prefer just passing the `FilterType::BASIC` to stay consistent but no strong view (yet).",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T13:42:13Z",
      "diff_hunk" : "@@ -536,6 +537,20 @@ class ChainImpl : public Chain\n         }\n         return std::nullopt;\n     }\n+    bool haveBlockFilterIndex() override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962921746",
      "id" : 962921746,
      "line" : 540,
      "node_id" : "PRRC_kwDOABII5845ZQUS",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 540,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 12,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962921746/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962921746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962928271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962928271"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a lot of code duplication from `GetScriptPubKeys`. At first sight, I don't really see why this couldn't be an overloaded function or default parameter?",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-05T13:49:36Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962928271",
      "id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ZR6P",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962928271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T08:01:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962928271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962937400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962937400"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Maybe a brief docstring would be helpful here? The name is not immediately obvious imo.",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T13:59:24Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962937400",
      "id" : 962937400,
      "line" : 307,
      "node_id" : "PRRC_kwDOABII5845ZUI4",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 307,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 48,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962937400/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962937400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962939320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962939320"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Do we need `SPK` in the name here? `GetDescriptorRangeEnd` seems to describe it accurately?",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T14:01:25Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;\n+    GCSFilter::ElementSet m_filter_set;\n+\n+    static int32_t GetDescriptorSPKRangeEnd(const DescriptorScriptPubKeyMan& desc_spkm)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962939320",
      "id" : 962939320,
      "line" : 310,
      "node_id" : "PRRC_kwDOABII5845ZUm4",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 310,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 51,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962939320/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962939320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963091332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963091332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "d0114e02cddd9bf1cc8760ebe95941f80609259b nit, here we construct a `CBlock` that isn't used if `skip_block` is true (we can use the block filter). I wonder if it would be worth the performance improvement to avoid the construction.\r\n```suggestion\r\n        std::unique_ptr<CBlock> block;\r\n        if (!skip_block) {\r\n            block = std::make_unique<CBlock>();\r\n            chain().findBlock(block_hash, FoundBlock().data(*block));\r\n        }\r\n```\r\nYou would also have to change 3 occurrences of `block.` to `block->` since it now would be a pointer.",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T18:52:08Z",
      "diff_hunk" : "@@ -1775,9 +1833,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }\n+\n         // Read block data\n         CBlock block;\n-        chain().findBlock(block_hash, FoundBlock().data(block));\n+        if (!skip_block) chain().findBlock(block_hash, FoundBlock().data(block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963091332",
      "id" : 963091332,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5845Z5uE",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 1850,
      "original_position" : 93,
      "original_start_line" : 1849,
      "path" : "src/wallet/wallet.cpp",
      "position" : 93,
      "pull_request_review_id" : 1095833132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963091332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1849,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-05T19:35:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963091332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963094901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963094901"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "d0114e02cddd9bf1cc8760ebe95941f80609259b Because of the `index >= minimum_index` guard (just below, line 2662), could this reserve many more entries than needed? I would probably let `std::vector` increase the capacity as needed.",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T19:04:23Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963094901",
      "id" : 963094901,
      "line" : 2659,
      "node_id" : "PRRC_kwDOABII5845Z6l1",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2659,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 8,
      "pull_request_review_id" : 1095833132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963094901/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T19:35:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963094901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767587"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agree that naming the method `has...` reads more fluent, considering that \"chain\" is singular. Done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:17:16Z",
      "diff_hunk" : "@@ -143,6 +144,13 @@ class Chain\n     //! or one of its ancestors.\n     virtual std::optional<int> findLocatorFork(const CBlockLocator& locator) = 0;\n \n+    //! Returns whether a block filter index is available.\n+    virtual bool haveBlockFilterIndex() = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767587",
      "id" : 963767587,
      "in_reply_to_id" : 962912290,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ce0j",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 148,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 1097679270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point. To be frank I was just lazy and assumed that there won't be any other block-filter types than \"basic\" for a long time anyways ð Fully agree though that passing the filter type is more consistent. Done for both methods.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:17:28Z",
      "diff_hunk" : "@@ -536,6 +537,20 @@ class ChainImpl : public Chain\n         }\n         return std::nullopt;\n     }\n+    bool haveBlockFilterIndex() override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767824",
      "id" : 963767824,
      "in_reply_to_id" : 962921746,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ce4Q",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 540,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1097679686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:17:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963773560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963773560"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:22:13Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963773560",
      "id" : 963773560,
      "in_reply_to_id" : 962937400,
      "line" : 313,
      "node_id" : "PRRC_kwDOABII5845cgR4",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 313,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 54,
      "pull_request_review_id" : 1097688294,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963773560/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963773560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963774096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963774096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agree that having the \"SPK\" in there is not really needed. Done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:22:36Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;\n+    GCSFilter::ElementSet m_filter_set;\n+\n+    static int32_t GetDescriptorSPKRangeEnd(const DescriptorScriptPubKeyMan& desc_spkm)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963774096",
      "id" : 963774096,
      "in_reply_to_id" : 962939320,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845cgaQ",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 310,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1097689012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963774096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:22:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963774096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In an earlier version the method `GetScriptPubKeys` was indeed simply extended with a default parameter (`minimum_index = 0`). After the latest rebase however, this method is now part of the base class `ScriptPubKeyMan` interface:\r\nhttps://github.com/bitcoin/bitcoin/blob/5291933fedceb9df16eb9e4627b1d7386b53ba07/src/wallet/scriptpubkeyman.h#L246\r\nPassing a minimum index only makes sense for `DescriptorScriptPubKeyMan`s, that's why I refrained from imposing a new parameter; overloading the method _only_ for this class also seemed wrong to me, that's why I chose to use a more explicit naming. Happy to overload though if other's wish that too (maybe it's not as problematic as I think :)).",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:23:53Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775594",
      "id" : 963775594,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845cgxq",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1097691356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-06T14:23:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775855"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:24:08Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775855",
      "id" : 963775855,
      "in_reply_to_id" : 962466047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845cg1v",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 275,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1097691799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775855/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963779873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963779873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch! We actually know how large the resulting vector should be (`m_map_script_pub_keys.size()` minus the passed minimum index); changed that accordingly and clamped to a minimum of zero to avoid potential integer underflow issues (if e.g. the caller would pass a minimum index higher than the current ~~end range~~ count of scriptPubKeys).",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:27:18Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963779873",
      "id" : 963779873,
      "in_reply_to_id" : 963094901,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ch0h",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2659,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1097697686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963779873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:47:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963779873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963785994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963785994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "After some consideration, I decided to keep as it is for now to keep the code simpler, as I think default-ctoring a `CBlock` is neglectible here compared to other operations (didn't do any benchmarking or look deeper into it though). Happy to follow-up here though, will keep this conversation open. (Maybe also a topic to discuss for PR review club tomorrow, in case there is some time at the end?).",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:32:14Z",
      "diff_hunk" : "@@ -1775,9 +1833,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }\n+\n         // Read block data\n         CBlock block;\n-        chain().findBlock(block_hash, FoundBlock().data(block));\n+        if (!skip_block) chain().findBlock(block_hash, FoundBlock().data(block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963785994",
      "id" : 963785994,
      "in_reply_to_id" : 963091332,
      "line" : 1856,
      "node_id" : "PRRC_kwDOABII5845cjUK",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 1856,
      "original_position" : 93,
      "original_start_line" : 1849,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1097706767,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963785994/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1855,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-06T14:32:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963785994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed with most of the suggestions from @stickies-v and @LarryRuane. Thanks for your reviews, very good points!",
      "created_at" : "2022-09-06T14:35:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1238241095",
      "id" : 1238241095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Jzg9H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238241095/reactions"
      },
      "updated_at" : "2022-09-06T14:35:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238241095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Suggest renaming to \"turbo rescan\" for more review :-)",
      "created_at" : "2022-09-06T16:50:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1238408812",
      "id" : 1238408812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J0J5s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 2,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238408812/reactions"
      },
      "updated_at" : "2022-09-06T16:50:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238408812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Performance test report: With the master branch, and an empty wallet (which is the best case for this PR), on mainnet, the `rescanblockchain` time was 90 minutes. With this PR, it was 10 minutes. This ratio of 9x is pretty close to the last row in the table in the description. \r\n\r\nOn signet, the PR branch is actually slower; this is probably due to the fact that so many blocks are empty or nearly empty; the time needed to check the filter is greater than the time to check the block directly.\r\n\r\nBut of course, mainnet is what really matters.",
      "created_at" : "2022-09-06T19:01:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1238538441",
      "id" : 1238538441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J0pjJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238538441/reactions"
      },
      "updated_at" : "2022-09-06T19:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238538441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964549852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964549852"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't really see the issue with overloading a child class function, especially with an optional parameter? Definitely beats the code duplication in my view, but yeah would be nice to hear others' thoughts.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T08:34:05Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964549852",
      "id" : 964549852,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845fdzc",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098757006,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964549852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T08:34:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964549852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964582588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964582588"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If the method of the child class has a different number of parameters than the method of the base class, the override doesn't work. E.g., the following doesn't compile:\r\n```c++\r\nclass Base {\r\npublic:\r\n    virtual int get_foobar() const { return 1; }\r\n};\r\n\r\nclass Inherited : public Base {\r\n    int get_foobar(int param = 0) const override { return 2; }\r\n};\r\n```\r\n```\r\n$ clang++ -c /tmp/override.cpp\r\n/tmp/override.cpp:7:45: error: non-virtual member function marked 'override' hides virtual member function\r\n        int get_foobar(int param = 0) const override { return 2; }\r\n                                            ^\r\n/tmp/override.cpp:3:25: note: hidden overloaded virtual function 'Base::get_foobar' declared here: different number of parameters (0 vs 1)\r\n            virtual int get_foobar() const { return 1; }\r\n                        ^\r\n```\r\n\r\nThe only way to avoid code deduplication would be to also introduce the `minimum_index` parameter to the `GetScriptPubKeys` method of the base class interface, but that seemed excessive to me, considering that we would only evaluate that parameter in DescriptorScriptPubKeyMans.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T09:04:05Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964582588",
      "id" : 964582588,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845fly8",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098803994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964582588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T09:04:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964582588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964632557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964632557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There's no need to `override` it, I'm just talking about overloading it for `DescriptorScriptPubKeyMan`. For example, I think the below could work (not sure if the vector return type was required, just kept it to an unordered_set here for minimal diff):\r\n\r\n<details>\r\n\r\n```diff\r\ndiff --git a/src/wallet/scriptpubkeyman.cpp b/src/wallet/scriptpubkeyman.cpp\r\nindex f7d7f99b8..4c42ef8e0 100644\r\n--- a/src/wallet/scriptpubkeyman.cpp\r\n+++ b/src/wallet/scriptpubkeyman.cpp\r\n@@ -2642,24 +2642,17 @@ const WalletDescriptor DescriptorScriptPubKeyMan::GetWalletDescriptor() const\r\n \r\n const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\r\n {\r\n-    LOCK(cs_desc_man);\r\n-    std::unordered_set<CScript, SaltedSipHasher> script_pub_keys;\r\n-    script_pub_keys.reserve(m_map_script_pub_keys.size());\r\n-\r\n-    for (auto const& script_pub_key: m_map_script_pub_keys) {\r\n-        script_pub_keys.insert(script_pub_key.first);\r\n-    }\r\n-    return script_pub_keys;\r\n+    return GetScriptPubKeys(0);\r\n }\r\n \r\n-const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\r\n+const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const\r\n {\r\n     LOCK(cs_desc_man);\r\n-    std::vector<CScript> script_pub_keys;\r\n+    std::unordered_set<CScript, SaltedSipHasher> script_pub_keys;\r\n     script_pub_keys.reserve(std::max<size_t>(m_map_script_pub_keys.size() - minimum_index, 0));\r\n \r\n     for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\r\n-        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\r\n+        if (index >= minimum_index) script_pub_keys.insert(script_pub_key);\r\n     }\r\n     return script_pub_keys;\r\n }\r\ndiff --git a/src/wallet/scriptpubkeyman.h b/src/wallet/scriptpubkeyman.h\r\nindex ac44de0e4..4ff7fdb15 100644\r\n--- a/src/wallet/scriptpubkeyman.h\r\n+++ b/src/wallet/scriptpubkeyman.h\r\n@@ -643,7 +643,7 @@ public:\r\n \r\n     const WalletDescriptor GetWalletDescriptor() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\r\n     const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\r\n-    const std::vector<CScript> GetScriptPubKeysWithMinIndex(int32_t minimum_index) const;\r\n+    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index) const;\r\n \r\n     bool GetDescriptorString(std::string& out, const bool priv) const;\r\n \r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex d79d9e76f..d327ab021 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -289,7 +289,7 @@ public:\r\n         for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\r\n             int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\r\n             if (current_range_end > last_range_end) {\r\n-                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\r\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\r\n                     m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\r\n                 }\r\n                 m_last_range_ends.at(desc_spkm) = current_range_end;\r\n```\r\n\r\n</details>",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T09:51:10Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964632557",
      "id" : 964632557,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845fx_t",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098875073,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964632557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T09:51:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964632557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964649158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964649158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, now I fully understand what you mean, looks good at a first glance and should work. Somehow I missed the simple idea of just calling the overloaded method with from the one that is overrided (i.e. `GetScriptPubKeys(0)`) and was too focused on solving it with default parameter. Returning a `std::unordered_set` rather than `std::vector` should also be fine for our purposes. Will try that out in a bit ð ",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T10:07:46Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964649158",
      "id" : 964649158,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845f2DG",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098899253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964649158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T10:07:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964649158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed again with the following changes:\r\n* took @stickies-v's suggestion to overload `DescriptorScriptPubKeyMan::GetScriptPubKeys(...)` in order to deduplicate code (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964632557)\r\n* removed the adaption (earlier first commit) of `wallet_import_rescan.py`: as @LarryRuane found out, this test only works for legacy wallets (it uses RPCs like `importprivkey`, `importaddress` etc.) and hence is at this stage not useful for testing this PR\r\n* added a new test `wallet_fast_rescan.py` which tests the top-up detection by repeatedly creating txs sending to the address of each wallet descriptor's range end, and then comparing the found wallet txs after slow and fast rescan each",
      "created_at" : "2022-09-08T16:56:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1240976766",
      "id" : 1240976766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J981-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1240976766/reactions"
      },
      "updated_at" : "2022-09-08T16:56:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1240976766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure it makes sense to talk about rescans on `loadwallet`. It can happen, but hopefully shouldn't be very often.",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-09T01:51:01Z",
      "diff_hunk" : "@@ -198,7 +198,9 @@ static RPCHelpMan loadwallet()\n     return RPCHelpMan{\"loadwallet\",\n                 \"\\nLoads a wallet from a wallet file or directory.\"\n                 \"\\nNote that all wallet command-line options used when starting bitcoind will be\"\n-                \"\\napplied to the new wallet.\\n\",\n+                \"\\napplied to the new wallet.\"\n+                \"\\nThe rescan is significantly faster if a descriptor wallet is loaded\"\n+                \"\\nand block filters are available (bitcoind option \\\"-blockfilterindex=1\\\").\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553271",
      "id" : 966553271,
      "line" : 203,
      "node_id" : "PRRC_kwDOABII5845nG63",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 203,
      "original_position" : 7,
      "original_start_line" : 202,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : 7,
      "pull_request_review_id" : 1101601457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 202,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-09T01:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553892"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index = 0) const;\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-09T01:52:50Z",
      "diff_hunk" : "@@ -643,6 +643,7 @@ class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n \n     const WalletDescriptor GetWalletDescriptor() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\n     const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553892",
      "id" : 966553892,
      "line" : 646,
      "node_id" : "PRRC_kwDOABII5845nHEk",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 646,
      "original_position" : 4,
      "original_start_line" : 645,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 4,
      "pull_request_review_id" : 1101601457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 645,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-09T01:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966554589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966554589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-09T01:54:46Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966554589",
      "id" : 966554589,
      "line" : 1847,
      "node_id" : "PRRC_kwDOABII5845nHPd",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1847,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 89,
      "pull_request_review_id" : 1101601457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966554589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-09T01:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966554589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">We could add an argument to loadwallet that prevents a rescan, so a user can migrate (#19602) to a descriptor wallet and then rescan.\r\n\r\nFeels like a footgun. Would rather a param that migrates without \"loading\". But I suspect extending this to support legacy wallets (outside the scope of this PR) wouldn't be very hard either.",
      "created_at" : "2022-09-09T01:58:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1241412647",
      "id" : 1241412647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J_nQn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241412647/reactions"
      },
      "updated_at" : "2022-09-09T01:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241412647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968587412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968587412"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about using `desc_spkm->m_max_cached_index` directly in the caller side instead?",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T15:51:11Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    /** Map for keeping track of each active descriptor's last seen end range.\n+      * This information is used to detect whether new addresses were derived\n+      * (that is, if the current end range is larger than the saved end range)\n+      * after processing a block and hence a filter set update is needed to\n+      * take possible keypool top-ups into account.\n+      */\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;\n+    GCSFilter::ElementSet m_filter_set;\n+\n+    static int32_t GetDescriptorRangeEnd(const DescriptorScriptPubKeyMan& desc_spkm)\n+    {\n+        LOCK(desc_spkm.cs_desc_man);\n+        return desc_spkm.GetWalletDescriptor().range_end;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968587412",
      "id" : 968587412,
      "line" : 320,
      "node_id" : "PRRC_kwDOABII5845u3iU",
      "original_commit_id" : "1daead3b4adb5a54b8999bdd1cece9cccf152499",
      "original_line" : 320,
      "original_position" : 61,
      "original_start_line" : 316,
      "path" : "src/wallet/wallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 1104388445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968587412/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 316,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-12T16:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968587412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968631594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968631594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you also need to include blockfilter.h here.",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T16:33:40Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n #include <chainparams.h>\n #include <deploymentstatus.h>\n #include <external_signer.h>\n+#include <index/blockfilterindex.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968631594",
      "id" : 968631594,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII5845vCUq",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 11,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 4,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968631594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968631594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968875953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968875953"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think that pointers are a good design choice for map keys. Would rather use the spkm id:\r\n```suggestion\r\n    std::map<uint256, int32_t> m_last_range_ends;\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T19:54:20Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    /** Map for keeping track of each active descriptor's last seen end range.\n+      * This information is used to detect whether new addresses were derived\n+      * (that is, if the current end range is larger than the saved end range)\n+      * after processing a block and hence a filter set update is needed to\n+      * take possible keypool top-ups into account.\n+      */\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968875953",
      "id" : 968875953,
      "line" : 313,
      "node_id" : "PRRC_kwDOABII5845v9-x",
      "original_commit_id" : "1daead3b4adb5a54b8999bdd1cece9cccf152499",
      "original_line" : 313,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 54,
      "pull_request_review_id" : 1104755402,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968875953/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T19:54:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968875953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968930318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968930318"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: structure\r\n```suggestion\r\n            // save each active ScriptPubKeyMans's range end for possible future filter updates\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:05:10Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968930318",
      "id" : 968930318,
      "line" : 279,
      "node_id" : "PRRC_kwDOABII5845wLQO",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 279,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968930318/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968930318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968944391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968944391"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: {} list initialization (in a few other places too)\r\n```suggestion\r\n        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:22:54Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968944391",
      "id" : 968944391,
      "line" : 273,
      "node_id" : "PRRC_kwDOABII5845wOsH",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 273,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 14,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968944391/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968944391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968951824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968951824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You could put this into its own function, e.g. `FastWalletRescanFilter::AddScriptPubKeys(DescriptorScriptPubKeyMan* desc_spkm, int32_t last_range_end = 0)`, so you can avoid the duplication in `UpdateIfNeeded()`? I think it'd be a bit more readable too (not that it's bad now)",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:32:01Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968951824",
      "id" : 968951824,
      "line" : 278,
      "node_id" : "PRRC_kwDOABII5845wQgQ",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 278,
      "original_position" : 19,
      "original_start_line" : 276,
      "path" : "src/wallet/wallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968951824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 276,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968951824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968956532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968956532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not very familiar with the wallet rescanning process, but I wonder if we should also check if there are any new spkms? If so, and if you would then want to track `active_spkms` as an internal member, you could extend `FastWalletRescanFilter::AddScriptPubKeys` from my other comment and have it update `m_last_range_ends` too for more deduplication.",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:39:19Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968956532",
      "id" : 968956532,
      "line" : 289,
      "node_id" : "PRRC_kwDOABII5845wRp0",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 289,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 30,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968956532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968956532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968961724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968961724"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should include blockfilter.h",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:47:16Z",
      "diff_hunk" : "@@ -1748,7 +1808,11 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n     uint256 block_hash = start_block;\n     ScanResult result;\n \n-    WalletLogPrintf(\"Rescan started from block %s...\\n\", start_block.ToString());\n+    std::unique_ptr<FastWalletRescanFilter> fast_rescan_filter;\n+    if (!IsLegacy() && chain().hasBlockFilterIndex(BlockFilterType::BASIC)) fast_rescan_filter.reset(new FastWalletRescanFilter(*this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968961724",
      "id" : 968961724,
      "line" : 1812,
      "node_id" : "PRRC_kwDOABII5845wS68",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1812,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 73,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968961724/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968961724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968963378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968963378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n            if (match_result.value_or(false)) {\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:50:02Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968963378",
      "id" : 968963378,
      "line" : 1846,
      "node_id" : "PRRC_kwDOABII5845wTUy",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1846,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 88,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968963378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968963378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968964566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968964566"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm quite confused by this comment, so +1 on removing or clarifying. \"Block does not match filter, mark it as scanned so ...\"",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:52:12Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968964566",
      "id" : 968964566,
      "in_reply_to_id" : 966554589,
      "line" : 1847,
      "node_id" : "PRRC_kwDOABII5845wTnW",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1847,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 89,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968964566/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968964566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968972271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968972271"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you think about putting this in a separate function that returns `bool skip_block`? `CWallet::ScanForWalletTransactions()` is already quite bloated, I think we should try not to add to it?",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T22:03:41Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968972271",
      "id" : 968972271,
      "line" : 1852,
      "node_id" : "PRRC_kwDOABII5845wVfv",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1852,
      "original_position" : 94,
      "original_start_line" : 1842,
      "path" : "src/wallet/wallet.cpp",
      "position" : 94,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968972271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1842,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968972271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968977557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968977557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: PEP484\r\n```suggestion\r\n    def get_wallet_txids(self, node: TestNode, wallet_name: str) -> List[str]:\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T22:10:57Z",
      "diff_hunk" : "@@ -0,0 +1,73 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that fast rescan using block filters for descriptor wallets detects\n+   top-ups correctly and finds the same transactions than the slow variant.\"\"\"\n+import os\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+\n+\n+KEYPOOL_SIZE = 100   # smaller than default size to speed-up test\n+NUM_DESCRIPTORS = 8  # number of descriptors on a fresh wallet created by default\n+NUM_BLOCKS = 6       # number of blocks to mine\n+\n+\n+class WalletFastRescanTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[f'-keypool={KEYPOOL_SIZE}', '-blockfilterindex=1']]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+        self.skip_if_no_sqlite()\n+\n+    def get_wallet_txids(self, node, wallet_name):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968977557",
      "id" : 968977557,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII5845wWyV",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fast_rescan.py",
      "position" : 28,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968977557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968977557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969026772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969026772"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not needed. Every import command checks if a rescan is being performed prior execution (it's the `WalletRescanReserver` purpose).",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T00:03:14Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969026772",
      "id" : 969026772,
      "in_reply_to_id" : 968956532,
      "line" : 289,
      "node_id" : "PRRC_kwDOABII5845wizU",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 289,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 30,
      "pull_request_review_id" : 1104961889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969026772/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T00:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969026772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969462249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969462249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for clarifying. At first sight, that seems quite a fragile assumption since it's implicit and requires every user of FastWalletRescanFilter to do that check voluntarily. Some kind of assertion would be nice but would go at the cost of performance to call and cast all spkms after every block, so maybe not worth it.",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T10:46:19Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969462249",
      "id" : 969462249,
      "in_reply_to_id" : 968956532,
      "line" : 289,
      "node_id" : "PRRC_kwDOABII5845yNHp",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 289,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 30,
      "pull_request_review_id" : 1105560530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969462249/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T10:46:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969462249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969484725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969484725"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In that case, it would be also need to change `LegacyScriptPubKeyMan::GetScriptPubKeys` to `LegacyScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index)`",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T11:10:08Z",
      "diff_hunk" : "@@ -643,6 +643,7 @@ class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n \n     const WalletDescriptor GetWalletDescriptor() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\n     const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969484725",
      "id" : 969484725,
      "in_reply_to_id" : 966553892,
      "line" : 646,
      "node_id" : "PRRC_kwDOABII5845ySm1",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 646,
      "original_position" : 4,
      "original_start_line" : 645,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 4,
      "pull_request_review_id" : 1105590992,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969484725/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 645,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T11:10:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969484725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969540182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969540182"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`m_max_cached_index` is a private member and therefore not accessible from the outside. Not sure if it's worth it to extend the descriptor SPK-man interface and add a corresponding getter member function (e.g. `DescriptorScriptPubKeyMan::GetMaxCachedIndex()`) only for this use-case. ",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T12:08:51Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    /** Map for keeping track of each active descriptor's last seen end range.\n+      * This information is used to detect whether new addresses were derived\n+      * (that is, if the current end range is larger than the saved end range)\n+      * after processing a block and hence a filter set update is needed to\n+      * take possible keypool top-ups into account.\n+      */\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;\n+    GCSFilter::ElementSet m_filter_set;\n+\n+    static int32_t GetDescriptorRangeEnd(const DescriptorScriptPubKeyMan& desc_spkm)\n+    {\n+        LOCK(desc_spkm.cs_desc_man);\n+        return desc_spkm.GetWalletDescriptor().range_end;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969540182",
      "id" : 969540182,
      "in_reply_to_id" : 968587412,
      "line" : 320,
      "node_id" : "PRRC_kwDOABII5845ygJW",
      "original_commit_id" : "1daead3b4adb5a54b8999bdd1cece9cccf152499",
      "original_line" : 320,
      "original_position" : 61,
      "original_start_line" : 316,
      "path" : "src/wallet/wallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 1105670135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969540182/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 316,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T12:08:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969540182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969546305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969546305"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think that's logically equivalent. \r\n* \"we have a result, and the result is negative\" (PR), versus\r\n* \"we have a result, and the result is positive\" (your suggestion)\r\n\r\n(according to https://en.cppreference.com/w/cpp/utility/optional/value_or: \"Returns the **contained value** if *this has a value, otherwise returns default_value.\")",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T12:15:09Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969546305",
      "id" : 969546305,
      "in_reply_to_id" : 968963378,
      "line" : 1846,
      "node_id" : "PRRC_kwDOABII5845yhpB",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1846,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 88,
      "pull_request_review_id" : 1105679130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969546305/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T12:15:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969546305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969588599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969588599"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're right, I should have inversed it. This should be equivalent though:\r\n\r\n```suggestion\r\n            if (!match_result.value_or(true)) {\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T12:54:39Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969588599",
      "id" : 969588599,
      "in_reply_to_id" : 968963378,
      "line" : 1846,
      "node_id" : "PRRC_kwDOABII5845yr93",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1846,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 88,
      "pull_request_review_id" : 1105744404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969588599/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T12:54:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969588599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969594441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969594441"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No need to add `block_filter_index->BlockUntilSyncedToCurrentChain` ?\r\nCurrently it seems to assume the chain is already synced.\r\n\r\n```suggestion\r\n        if (!block_filter_index->BlockUntilSyncedToCurrentChain() || !block_filter_index->LookupFilter(index, filter)) return std::nullopt;\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T12:59:30Z",
      "diff_hunk" : "@@ -536,6 +537,20 @@ class ChainImpl : public Chain\n         }\n         return std::nullopt;\n     }\n+    bool hasBlockFilterIndex(BlockFilterType filter_type) override\n+    {\n+        return GetBlockFilterIndex(filter_type) != nullptr;\n+    }\n+    std::optional<bool> blockFilterMatchesAny(BlockFilterType filter_type, const uint256& block_hash, const GCSFilter::ElementSet& filter_set) override\n+    {\n+        const BlockFilterIndex* block_filter_index = GetBlockFilterIndex(filter_type);\n+        if (!block_filter_index) return std::nullopt;\n+\n+        BlockFilter filter;\n+        const CBlockIndex* index = WITH_LOCK(::cs_main, return chainman().m_blockman.LookupBlockIndex(block_hash));\n+        if (!block_filter_index->LookupFilter(index, filter)) return std::nullopt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969594441",
      "id" : 969594441,
      "line" : 551,
      "node_id" : "PRRC_kwDOABII5845ytZJ",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 551,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 23,
      "pull_request_review_id" : 1105753065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969594441/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T12:59:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969594441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969612249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969612249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't ` if (!skip_block) chain().findBlock(block_hash, FoundBlock().data(block));` guarantee that the block will be null if `skip_block` is true ?",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T13:14:38Z",
      "diff_hunk" : "@@ -1846,35 +1862,37 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n         uint256 next_block_hash;\n         chain().findBlock(block_hash, FoundBlock().inActiveChain(block_still_active).nextBlock(FoundBlock().inActiveChain(next_block).hash(next_block_hash)));\n \n-        if (!block.IsNull()) {\n-            LOCK(cs_wallet);\n-            if (!block_still_active) {\n-                // Abort scan if current block is no longer active, to prevent\n-                // marking transactions as coming from the wrong block.\n-                result.last_failed_block = block_hash;\n-                result.status = ScanResult::FAILURE;\n-                break;\n-            }\n-            for (size_t posInBlock = 0; posInBlock < block.vtx.size(); ++posInBlock) {\n-                SyncTransaction(block.vtx[posInBlock], TxStateConfirmed{block_hash, block_height, static_cast<int>(posInBlock)}, fUpdate, /*rescanning_old_block=*/true);\n-            }\n-            // scan succeeded, record block as most recent successfully scanned\n-            result.last_scanned_block = block_hash;\n-            result.last_scanned_height = block_height;\n+        if (!skip_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969612249",
      "id" : 969612249,
      "line" : 1865,
      "node_id" : "PRRC_kwDOABII5845yxvZ",
      "original_commit_id" : "df89e3c0c4007c73f241808674bc799ab6fec490",
      "original_line" : 1865,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 55,
      "pull_request_review_id" : 1105779173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969612249/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T13:14:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969612249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969677247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969677247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Valid point, I struggled with the key type choice a lot. In an earlier version (before the PR was opened) I even used IDs at keys, but the drawback of this is that it leads to more code, as we (artificially?) need to convert between SPKM-Id and DescriptorScriptPubKey* pointers again and again, i.e. needing to call `CWallet::GetScriptPubKeyMan(const uint256& id)` (+casting the result to `DescriptorScriptPubKeyMan*`) at every iteration of the map and call `DescriptorScriptPubKeyMan::GetID()` before every insertion into the map. Considering that the result is always the same, it seems a bit excessive to recalculate the ID (involving creation of a string and hashing it, see `DescriptorScriptPubKeyMan::GetID()`) again and again. As long as we are sure that the different pointers are constant and unique, using them as keys should be okay? (At least, I couldn't find anything stating that it should be avoided, as long as we know what we are doing; e.g. https://stackoverflow.com/questions/25122932/pointers-as-keys-in-map-c-stl).\r\n\r\nAny thoughts?",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T14:06:53Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    /** Map for keeping track of each active descriptor's last seen end range.\n+      * This information is used to detect whether new addresses were derived\n+      * (that is, if the current end range is larger than the saved end range)\n+      * after processing a block and hence a filter set update is needed to\n+      * take possible keypool top-ups into account.\n+      */\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969677247",
      "id" : 969677247,
      "in_reply_to_id" : 968875953,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zBm_",
      "original_commit_id" : "1daead3b4adb5a54b8999bdd1cece9cccf152499",
      "original_line" : 313,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1105875235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969677247/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T14:06:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969677247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969742529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969742529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, restored the original help text for `loadwallet` on the latest force-push.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T14:59:36Z",
      "diff_hunk" : "@@ -198,7 +198,9 @@ static RPCHelpMan loadwallet()\n     return RPCHelpMan{\"loadwallet\",\n                 \"\\nLoads a wallet from a wallet file or directory.\"\n                 \"\\nNote that all wallet command-line options used when starting bitcoind will be\"\n-                \"\\napplied to the new wallet.\\n\",\n+                \"\\napplied to the new wallet.\"\n+                \"\\nThe rescan is significantly faster if a descriptor wallet is loaded\"\n+                \"\\nand block filters are available (bitcoind option \\\"-blockfilterindex=1\\\").\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969742529",
      "id" : 969742529,
      "in_reply_to_id" : 966553271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zRjB",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 203,
      "original_position" : 7,
      "original_start_line" : 202,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1105972131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969742529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T14:59:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969742529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969744751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969744751"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> In that case, it would be also need to change `LegacyScriptPubKeyMan::GetScriptPubKeys` to `LegacyScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index)`\r\n\r\nYes, we would need to impose the parameter on the base class, which I think wouldn't make much sense (the `minimum_index` for this method is only useful for descriptor wallets). Also see the discussion here: https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964582588",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:01:24Z",
      "diff_hunk" : "@@ -643,6 +643,7 @@ class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n \n     const WalletDescriptor GetWalletDescriptor() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\n     const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969744751",
      "id" : 969744751,
      "in_reply_to_id" : 966553892,
      "line" : 646,
      "node_id" : "PRRC_kwDOABII5845zSFv",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 646,
      "original_position" : 4,
      "original_start_line" : 645,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 4,
      "pull_request_review_id" : 1105975371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969744751/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 645,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T15:01:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969744751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745183"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, removed it.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:01:46Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745183",
      "id" : 969745183,
      "in_reply_to_id" : 966554589,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zSMf",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1847,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1105976037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745183/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:01:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745394"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:01:58Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n #include <chainparams.h>\n #include <deploymentstatus.h>\n #include <external_signer.h>\n+#include <index/blockfilterindex.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745394",
      "id" : 969745394,
      "in_reply_to_id" : 968631594,
      "line" : 12,
      "node_id" : "PRRC_kwDOABII5845zSPy",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 12,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 9,
      "pull_request_review_id" : 1105976397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745394/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745528"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:02:05Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745528",
      "id" : 969745528,
      "in_reply_to_id" : 968930318,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zSR4",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 279,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1105976601,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745528/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:02:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745892"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed to list initialization in all commits (hope I didn't miss any instances).",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:02:24Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969745892",
      "id" : 969745892,
      "in_reply_to_id" : 968944391,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zSXk",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 273,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1105977184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:02:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969745892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969746610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969746610"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good idea, introduced a new private method `AddScriptPubKeys` as suggested.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:02:59Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969746610",
      "id" : 969746610,
      "in_reply_to_id" : 968951824,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zSiy",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 278,
      "original_position" : 19,
      "original_start_line" : 276,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1105978238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969746610/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T15:02:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969746610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969747034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969747034"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:03:20Z",
      "diff_hunk" : "@@ -1748,7 +1808,11 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n     uint256 block_hash = start_block;\n     ScanResult result;\n \n-    WalletLogPrintf(\"Rescan started from block %s...\\n\", start_block.ToString());\n+    std::unique_ptr<FastWalletRescanFilter> fast_rescan_filter;\n+    if (!IsLegacy() && chain().hasBlockFilterIndex(BlockFilterType::BASIC)) fast_rescan_filter.reset(new FastWalletRescanFilter(*this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969747034",
      "id" : 969747034,
      "in_reply_to_id" : 968961724,
      "line" : 1816,
      "node_id" : "PRRC_kwDOABII5845zSpa",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1816,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 84,
      "pull_request_review_id" : 1105978838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969747034/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:03:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969747034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969748698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969748698"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "While I agree that this is now logically equivalent, I doubt that it's more readable.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:04:46Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969748698",
      "id" : 969748698,
      "in_reply_to_id" : 968963378,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5845zTDa",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1105981245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969748698/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:04:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969748698",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969749083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969749083"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:05:05Z",
      "diff_hunk" : "@@ -0,0 +1,73 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that fast rescan using block filters for descriptor wallets detects\n+   top-ups correctly and finds the same transactions than the slow variant.\"\"\"\n+import os\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+\n+\n+KEYPOOL_SIZE = 100   # smaller than default size to speed-up test\n+NUM_DESCRIPTORS = 8  # number of descriptors on a fresh wallet created by default\n+NUM_BLOCKS = 6       # number of blocks to mine\n+\n+\n+class WalletFastRescanTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[f'-keypool={KEYPOOL_SIZE}', '-blockfilterindex=1']]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+        self.skip_if_no_sqlite()\n+\n+    def get_wallet_txids(self, node, wallet_name):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969749083",
      "id" : 969749083,
      "in_reply_to_id" : 968977557,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zTJb",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fast_rescan.py",
      "position" : null,
      "pull_request_review_id" : 1105981809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969749083/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:05:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969749083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969759874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969759874"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Decided to use SPKM-IDs, as I think it's indeed the clearer design choice -- the recalculation of the IDs only happens on repopulation of the filter (due to detected top-up), and shouldn't affect the performance at all. Leaving this conversation open for further discussion though, if anyone has objections.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:13:42Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    /** Map for keeping track of each active descriptor's last seen end range.\n+      * This information is used to detect whether new addresses were derived\n+      * (that is, if the current end range is larger than the saved end range)\n+      * after processing a block and hence a filter set update is needed to\n+      * take possible keypool top-ups into account.\n+      */\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969759874",
      "id" : 969759874,
      "in_reply_to_id" : 968875953,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zVyC",
      "original_commit_id" : "1daead3b4adb5a54b8999bdd1cece9cccf152499",
      "original_line" : 313,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1105996619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969759874/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969759874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969778740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969778740"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Have to look deeper into the details here, but I think if we are not fully synced yet, it's still better to use block filters for a (possibly small) subset of the chain rather to not use them at all?",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:28:16Z",
      "diff_hunk" : "@@ -536,6 +537,20 @@ class ChainImpl : public Chain\n         }\n         return std::nullopt;\n     }\n+    bool hasBlockFilterIndex(BlockFilterType filter_type) override\n+    {\n+        return GetBlockFilterIndex(filter_type) != nullptr;\n+    }\n+    std::optional<bool> blockFilterMatchesAny(BlockFilterType filter_type, const uint256& block_hash, const GCSFilter::ElementSet& filter_set) override\n+    {\n+        const BlockFilterIndex* block_filter_index = GetBlockFilterIndex(filter_type);\n+        if (!block_filter_index) return std::nullopt;\n+\n+        BlockFilter filter;\n+        const CBlockIndex* index = WITH_LOCK(::cs_main, return chainman().m_blockman.LookupBlockIndex(block_hash));\n+        if (!block_filter_index->LookupFilter(index, filter)) return std::nullopt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969778740",
      "id" : 969778740,
      "in_reply_to_id" : 969594441,
      "line" : 552,
      "node_id" : "PRRC_kwDOABII5845zaY0",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 552,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 28,
      "pull_request_review_id" : 1106022585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969778740/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T15:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969778740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969807967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969807967"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thought about that already and agree that bloat should be avoided, but couldn't come up with a satisfying function name yet (`CanBlockBeSkippedDueToFastRescanFilter`?) and was concerned that the \"fast rescan\" functionality in the wallet would become too scattered. One class and once place where to use this class seems to be more compact and self-contained than class + function (that passes the class instance) + another function where this is called.\r\n\r\nAny conrete suggestions there? Happy to follow-up. (Another possible variant would be to put the check directly into `FastWalletRescanFilter`, as a method? Not sure.)",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T15:53:45Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969807967",
      "id" : 969807967,
      "in_reply_to_id" : 968972271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zhhf",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1855,
      "original_position" : 94,
      "original_start_line" : 1842,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1106063575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969807967/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-13T15:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969807967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969820543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969820543"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that the `if (!block.IsNull()) { ... }` block has an else-condition below that we don't want to reach (it sets `ScanResult::FAILURE`) if we skipped the block due to the fast rescan filter. Reviewing with `--ignore-all-space` should show the diff a bit more clearly to see it. (Or did I interpret your comment wrongly and you meant something else?)",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T16:05:04Z",
      "diff_hunk" : "@@ -1846,35 +1862,37 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n         uint256 next_block_hash;\n         chain().findBlock(block_hash, FoundBlock().inActiveChain(block_still_active).nextBlock(FoundBlock().inActiveChain(next_block).hash(next_block_hash)));\n \n-        if (!block.IsNull()) {\n-            LOCK(cs_wallet);\n-            if (!block_still_active) {\n-                // Abort scan if current block is no longer active, to prevent\n-                // marking transactions as coming from the wrong block.\n-                result.last_failed_block = block_hash;\n-                result.status = ScanResult::FAILURE;\n-                break;\n-            }\n-            for (size_t posInBlock = 0; posInBlock < block.vtx.size(); ++posInBlock) {\n-                SyncTransaction(block.vtx[posInBlock], TxStateConfirmed{block_hash, block_height, static_cast<int>(posInBlock)}, fUpdate, /*rescanning_old_block=*/true);\n-            }\n-            // scan succeeded, record block as most recent successfully scanned\n-            result.last_scanned_block = block_hash;\n-            result.last_scanned_height = block_height;\n+        if (!skip_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969820543",
      "id" : 969820543,
      "in_reply_to_id" : 969612249,
      "line" : 1868,
      "node_id" : "PRRC_kwDOABII5845zkl_",
      "original_commit_id" : "df89e3c0c4007c73f241808674bc799ab6fec490",
      "original_line" : 1868,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 132,
      "pull_request_review_id" : 1106080989,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969820543/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T16:05:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969820543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed with most reviewer's suggestions taken into account (thanks a lot!). Most significantly, the std::map key type for storing the end ranges was changed from `DescriptorPubKeyMan` pointers to SPK-Man IDs. This leads to a little more code (and unnecessary re-computation of IDs after filter repopulation), but seems to be the more clean design choice; see also discussion https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968875953.",
      "created_at" : "2022-09-13T16:05:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1245625925",
      "id" : 1245625925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585KPr5F",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245625925/reactions"
      },
      "updated_at" : "2022-09-13T16:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245625925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969829282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969829282"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe it's me, but for some reason I'm often confused by `!` for negating in general, including in the second hand of the original version (as per my initial wrong suggestion, apparently). What about `match_result.value_or(true) == false)`? I think that's concise and clear. I'm just not a fan of \"re-implementing\" the `value_or()` when it's so common.\r\n\r\nDon't want to bikeshed over this obviously, so as you see fit - no further comment.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T16:11:43Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969829282",
      "id" : 969829282,
      "in_reply_to_id" : 968963378,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5845zmui",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1106090942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969829282/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T16:11:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969829282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969872030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969872030"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I like the idea of moving (part of the logic) to `FastWalletRescanFilter`, yeah. What do you think about the below diff? I didn't test it very carefully (tests pass though) but it seems equivalent and imo more readable?\r\n\r\n<details>\r\n\r\n```diff\r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex d3f1fb418..fdc5fdc7f 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -282,6 +282,14 @@ public:\r\n         }\r\n     }\r\n \r\n+    bool BlockNotInFilter(uint256 block_hash)\r\n+    {\r\n+        UpdateIfNeeded();\r\n+        auto block_in_filter{MatchesBlock(block_hash)};\r\n+        return block_in_filter.value_or(true) == false;\r\n+    }\r\n+\r\n+private:\r\n     void UpdateIfNeeded()\r\n     {\r\n         // repopulate filter with new scripts if top-up has happened since last iteration\r\n@@ -300,7 +308,6 @@ public:\r\n         return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\r\n     }\r\n \r\n-private:\r\n     const CWallet& m_wallet;\r\n     /** Map for keeping track of each active descriptor's last seen end range.\r\n       * This information is used to detect whether new addresses were derived\r\n@@ -1843,16 +1850,7 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\r\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\r\n         }\r\n \r\n-        bool skip_block{false};\r\n-        if (fast_rescan_filter) {\r\n-            fast_rescan_filter->UpdateIfNeeded();\r\n-            auto match_result{fast_rescan_filter->MatchesBlock(block_hash)};\r\n-            if (match_result.has_value() && !match_result.value()) {\r\n-                result.last_scanned_block = block_hash;\r\n-                result.last_scanned_height = block_height;\r\n-                skip_block = true;\r\n-            }\r\n-        }\r\n+        bool skip_block{fast_rescan_filter ? fast_rescan_filter->BlockNotInFilter(block_hash) : false};\r\n \r\n         // Read block data\r\n         CBlock block;\r\n@@ -1865,7 +1863,10 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\r\n         uint256 next_block_hash;\r\n         chain().findBlock(block_hash, FoundBlock().inActiveChain(block_still_active).nextBlock(FoundBlock().inActiveChain(next_block).hash(next_block_hash)));\r\n \r\n-        if (!skip_block) {\r\n+        if (skip_block) {\r\n+            result.last_scanned_block = block_hash;\r\n+            result.last_scanned_height = block_height;\r\n+        } else {\r\n             if (!block.IsNull()) {\r\n                 LOCK(cs_wallet);\r\n                 if (!block_still_active) {\r\n\r\n```\r\n\r\n</details>\r\n\r\nEdit: not blocking of course, can be a follow-up too.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-13T16:54:37Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969872030",
      "id" : 969872030,
      "in_reply_to_id" : 968972271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845zxKe",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1855,
      "original_position" : 94,
      "original_start_line" : 1842,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1106150569,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969872030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-14T10:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969872030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r970212322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970212322"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Got it. Originally if the block is null, this is a reason for failure. With `skip_block`, this can happen if the filter was applied.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-14T01:26:38Z",
      "diff_hunk" : "@@ -1846,35 +1862,37 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n         uint256 next_block_hash;\n         chain().findBlock(block_hash, FoundBlock().inActiveChain(block_still_active).nextBlock(FoundBlock().inActiveChain(next_block).hash(next_block_hash)));\n \n-        if (!block.IsNull()) {\n-            LOCK(cs_wallet);\n-            if (!block_still_active) {\n-                // Abort scan if current block is no longer active, to prevent\n-                // marking transactions as coming from the wrong block.\n-                result.last_failed_block = block_hash;\n-                result.status = ScanResult::FAILURE;\n-                break;\n-            }\n-            for (size_t posInBlock = 0; posInBlock < block.vtx.size(); ++posInBlock) {\n-                SyncTransaction(block.vtx[posInBlock], TxStateConfirmed{block_hash, block_height, static_cast<int>(posInBlock)}, fUpdate, /*rescanning_old_block=*/true);\n-            }\n-            // scan succeeded, record block as most recent successfully scanned\n-            result.last_scanned_block = block_hash;\n-            result.last_scanned_height = block_height;\n+        if (!skip_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r970212322",
      "id" : 970212322,
      "in_reply_to_id" : 969612249,
      "line" : 1868,
      "node_id" : "PRRC_kwDOABII58451EPi",
      "original_commit_id" : "df89e3c0c4007c73f241808674bc799ab6fec490",
      "original_line" : 1868,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 132,
      "pull_request_review_id" : 1106625970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970212322/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T01:26:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970212322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r970213784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970213784"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Reviewing the code again, it seems to me that if the index not fully synced, the wallet will normally scan the remaining blocks. In this case, this change is really not necessary.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-14T01:30:34Z",
      "diff_hunk" : "@@ -536,6 +537,20 @@ class ChainImpl : public Chain\n         }\n         return std::nullopt;\n     }\n+    bool hasBlockFilterIndex(BlockFilterType filter_type) override\n+    {\n+        return GetBlockFilterIndex(filter_type) != nullptr;\n+    }\n+    std::optional<bool> blockFilterMatchesAny(BlockFilterType filter_type, const uint256& block_hash, const GCSFilter::ElementSet& filter_set) override\n+    {\n+        const BlockFilterIndex* block_filter_index = GetBlockFilterIndex(filter_type);\n+        if (!block_filter_index) return std::nullopt;\n+\n+        BlockFilter filter;\n+        const CBlockIndex* index = WITH_LOCK(::cs_main, return chainman().m_blockman.LookupBlockIndex(block_hash));\n+        if (!block_filter_index->LookupFilter(index, filter)) return std::nullopt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r970213784",
      "id" : 970213784,
      "in_reply_to_id" : 969594441,
      "line" : 552,
      "node_id" : "PRRC_kwDOABII58451EmY",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 552,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 28,
      "pull_request_review_id" : 1106627907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970213784/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-14T01:30:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/970213784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r973054394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/973054394"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can remove the `active_spkms` lookup by using `desc_spkm->IsRange()`.\r\nE.g.\r\n```c++\r\nfor (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\r\n     auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(spkm)};\r\n     AddScriptPubKeys(desc_spkm);\r\n     // save each spkm range end for possible future filter updates\r\n     if (desc_spkm->IsRange()) {\r\n         m_last_range_ends.emplace(desc_spkm->GetID(), GetDescriptorRangeEnd(*desc_spkm));\r\n     }\r\n}\r\n```\r\n\r\nNote: `IsRange()` can be a simple:\r\n```c++\r\nbool DescriptorScriptPubKeyMan::IsRange()\r\n{\r\n   return WITH_LOCK(cs_desc_man, return GetWalletDescriptor().descriptor->IsRange());\r\n}\r\n```",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-16T13:56:41Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(spkm)};\n+            AddScriptPubKeys(desc_spkm);\n+            // save each active ScriptPubKeyMans's range end for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm->GetID(), GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r973054394",
      "id" : 973054394,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII5845_6G6",
      "original_commit_id" : "456097763d4bdf7ba35de2b3eb33d2160c8024c1",
      "original_line" : 282,
      "original_position" : 30,
      "original_start_line" : 274,
      "path" : "src/wallet/wallet.cpp",
      "position" : 30,
      "pull_request_review_id" : 1110730675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/973054394/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 274,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-16T14:03:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/973054394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978723539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978723539"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm still not convinced, as I think there is more mental effort needed for a reader to grasp exactly what the \"block skip condition\" is. \"the filter matching routine returned a result, _and_ that result is negative\" is expressed more closely with the PR variant IMHO. Will still leave the discussion open for a while in case anyone wants to chime in. Maybe it's more a matter of taste and I have a bad one ð ",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-23T14:16:42Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978723539",
      "id" : 978723539,
      "in_reply_to_id" : 968963378,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5846ViLT",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1118547156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978723539/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-23T14:16:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978723539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978725623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978725623"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would prefer that for a follow-up, could possibly even be a larger one that generally tries to divide up `CWallet::ScanForWalletTransactions()` into more functions to reduce bloat. Just one thing about naming, though I also unfortunately don't have a better idea: `BlockNotInFilter` suggests that this method only retrieves information and as such doesn't have any side-effects (but it does, due to the `UpdateIfNeeded` call).",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-23T14:18:34Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978725623",
      "id" : 978725623,
      "in_reply_to_id" : 968972271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846Vir3",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1855,
      "original_position" : 94,
      "original_start_line" : 1842,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1118551192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978725623/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-23T14:18:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978725623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978731097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978731097"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Similar to the rationale in https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969540182, I'd prefer to not extend the SPK-man interface with new methods unless absolutely needed, if I don't even know if it would be useful outside of this PR (which is \"only\" an optimization and doesn't add any functionality of its own). Only for saving one line of code in the ctor I don't think it's worth it.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-23T14:24:06Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(spkm)};\n+            AddScriptPubKeys(desc_spkm);\n+            // save each active ScriptPubKeyMans's range end for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm->GetID(), GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978731097",
      "id" : 978731097,
      "in_reply_to_id" : 973054394,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII5846VkBZ",
      "original_commit_id" : "456097763d4bdf7ba35de2b3eb33d2160c8024c1",
      "original_line" : 282,
      "original_position" : 30,
      "original_start_line" : 274,
      "path" : "src/wallet/wallet.cpp",
      "position" : 30,
      "pull_request_review_id" : 1118559639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978731097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 274,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-23T14:24:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978731097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978740716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978740716"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As we are not using the returned optional value (which, if nullopt denotes that we don't have the filter index for it) and we only want to know if the set matches the block filter, could change `MatchesBlock` to return a simple boolean instead.\r\n\r\nSomething like:\r\n```c++\r\nstd::optional<bool> MatchesBlock(const uint256& block_hash) const\r\n{\r\n    auto matches{m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set)};\r\n    return matches && *matches;\r\n}\r\n```\r\n\r\nAnd then this specific line would just be:\r\n```suggestion\r\n            if (match_result) {\r\n```",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-23T14:32:32Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978740716",
      "id" : 978740716,
      "in_reply_to_id" : 968963378,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5846VmXs",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1118575175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978740716/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-23T14:32:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978740716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978950432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978950432"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@furszy: Unfortunately that doesn't work. Remember that the condition for skipping a block if the filter does _not_ match  the block. If we just use `!match_result` as condition (I guess in your suggested change your just forgot the negation operator `!`), then we would also skip a block if the match function didn't return a result (e.g. because the block filter is not available), which is incorrect.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-23T18:10:15Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978950432",
      "id" : 978950432,
      "in_reply_to_id" : 968963378,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5846WZkg",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1118878931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978950432/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-23T18:10:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978950432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978987367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978987367"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I guess in your suggested change your just forgot the negation operator !\r\n\r\nit was a `!match_result`, yeah.\r\n\r\n> then we would also skip a block if the match function didn't return a result (e.g. because the block filter is not available), which is incorrect.\r\n\r\nThat is guarded by the `fast_rescan_filter` object existence (before create the object, you check if the filter index exist). If there isn't a filter index, then the object is never created, there by this line is never called.\r\n\r\nAs block filters are created with blocks (on the same connection signal), we shouldn't need to check for filter existence at this point of the code.\r\n\r\nStill.. there is still a tiny window of time for a race condition.. when a block gets stored and we are still creating the block filter..\r\nSo.. better to check the filter existence on every loop. And forget all what I just said :p",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-23T19:05:33Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r978987367",
      "id" : 978987367,
      "in_reply_to_id" : 968963378,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5846Wiln",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1118932995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978987367/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-23T19:05:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/978987367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979863337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979863337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "make sure `desc_spkm` is not `nullptr` before dereferencing",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-26T10:58:30Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(spkm)};\n+            AddScriptPubKeys(desc_spkm);\n+            // save each active ScriptPubKeyMans's range end for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm->GetID(), GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm_id, last_range_end] : m_last_range_ends) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(m_wallet.GetScriptPubKeyMan(desc_spkm_id))};\n+            int32_t current_range_end{GetDescriptorRangeEnd(*desc_spkm)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979863337",
      "id" : 979863337,
      "line" : 290,
      "node_id" : "PRRC_kwDOABII5846Z4cp",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 290,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 38,
      "pull_request_review_id" : 1120005419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979863337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-26T11:04:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979863337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979863823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979863823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        for (const auto& [desc_spkm_id, last_range_end] : m_last_range_ends) {\r\n```",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-26T10:59:07Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(spkm)};\n+            AddScriptPubKeys(desc_spkm);\n+            // save each active ScriptPubKeyMans's range end for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm->GetID(), GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm_id, last_range_end] : m_last_range_ends) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979863823",
      "id" : 979863823,
      "line" : 288,
      "node_id" : "PRRC_kwDOABII5846Z4kP",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 288,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 36,
      "pull_request_review_id" : 1120005419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979863823/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-26T11:04:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979863823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979865164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979865164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it is returned by value anyway\r\n```suggestion\r\nstd::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const\r\n```",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-26T11:00:44Z",
      "diff_hunk" : "@@ -2641,13 +2641,18 @@ const WalletDescriptor DescriptorScriptPubKeyMan::GetWalletDescriptor() const\n }\n \n const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n+{\n+    return GetScriptPubKeys(0);\n+}\n+\n+const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979865164",
      "id" : 979865164,
      "line" : 2648,
      "node_id" : "PRRC_kwDOABII5846Z45M",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 2648,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 8,
      "pull_request_review_id" : 1120005419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979865164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-26T11:04:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/979865164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982393105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982393105"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since you're subtracting from an unsigned, `minimum_index` gets cast to unsigned and the expression overflows if `minimum_index` > `m_map_script_pub_keys.size()`.\r\n\r\n```suggestion\r\n    script_pub_keys.reserve(std::max(static_cast<int32_t>(m_map_script_pub_keys.size()) - minimum_index, 0));\r\n```\r\n\r\n(Note: the `static_cast<int32_t>` may overflow too)",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-28T13:16:16Z",
      "diff_hunk" : "@@ -2641,13 +2641,18 @@ const WalletDescriptor DescriptorScriptPubKeyMan::GetWalletDescriptor() const\n }\n \n const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n+{\n+    return GetScriptPubKeys(0);\n+}\n+\n+const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const\n {\n     LOCK(cs_desc_man);\n     std::unordered_set<CScript, SaltedSipHasher> script_pub_keys;\n-    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+    script_pub_keys.reserve(std::max<size_t>(m_map_script_pub_keys.size() - minimum_index, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982393105",
      "id" : 982393105,
      "line" : 2652,
      "node_id" : "PRRC_kwDOABII5846jiER",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 2652,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 13,
      "pull_request_review_id" : 1123671424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982393105/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-28T21:51:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982393105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982871332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982871332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Initially I agreed with your view (and had the same consideration when proposing) about `BlockNotInFilter` having side-effects. However, in this case upon further thinking I'm not sure that's a problem:\r\n- both `BlockNotInFilter()` and `UpdateIfNeeded()` are idempotent, we don't need to be concerned about running it \"too often\". `UpdateIfNeeded()` only has internal side-effects.\r\n- `UpdateIfNeeded()` is a separate/manual function to improve performance, so we don't continuously need to monitor/update the filter when it's not needed. All it does, is ensure the filter works _as expected_. From that perspective, I don't think `BlockNotInFilter()` has the kind of side-effects we should normally be worried about.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-28T21:19:11Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982871332",
      "id" : 982871332,
      "in_reply_to_id" : 968972271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846lW0k",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1855,
      "original_position" : 94,
      "original_start_line" : 1842,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1123671424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982871332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-28T21:51:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982871332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982873205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982873205"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A less controversial idea to improve readability: I think if the name represents what true/false means, it becomes clearer: for example `matches_block` instead of `match_result`. Also in this case, I think dereferencing is clearer than using `.value()`\r\n\r\n<details>\r\n<summary>git diff</summary>\r\n\r\n```diff\r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex d3f1fb418..2c2f80cfa 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -1846,8 +1846,8 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\r\n         bool skip_block{false};\r\n         if (fast_rescan_filter) {\r\n             fast_rescan_filter->UpdateIfNeeded();\r\n-            auto match_result{fast_rescan_filter->MatchesBlock(block_hash)};\r\n-            if (match_result.has_value() && !match_result.value()) {\r\n+            auto matches_block{fast_rescan_filter->MatchesBlock(block_hash)};\r\n+            if (matches_block.has_value() && !*matches_block) {\r\n                 result.last_scanned_block = block_hash;\r\n                 result.last_scanned_height = block_height;\r\n                 skip_block = true;\r\n///\r\n\r\n</details>",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-28T21:21:55Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982873205",
      "id" : 982873205,
      "in_reply_to_id" : 968963378,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5846lXR1",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1123671424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982873205/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-28T21:51:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982873205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r983223295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983223295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f83bc26a5d2c93ff6d11e41b766e61cc8df7b45c @ryanofsky does `GCSFilter::ElementSet` present any problems for #10102?",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-29T08:20:47Z",
      "diff_hunk" : "@@ -143,6 +144,13 @@ class Chain\n     //! or one of its ancestors.\n     virtual std::optional<int> findLocatorFork(const CBlockLocator& locator) = 0;\n \n+    //! Returns whether a block filter index is available.\n+    virtual bool hasBlockFilterIndex(BlockFilterType filter_type) = 0;\n+\n+    //! Returns whether any of the elements match the block via a BIP 157 block filter\n+    //! or std::nullopt if the block filter for this block couldn't be found.\n+    virtual std::optional<bool> blockFilterMatchesAny(BlockFilterType filter_type, const uint256& block_hash, const GCSFilter::ElementSet& filter_set) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r983223295",
      "id" : 983223295,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII5846msv_",
      "original_commit_id" : "f83bc26a5d2c93ff6d11e41b766e61cc8df7b45c",
      "original_line" : 152,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 17,
      "pull_request_review_id" : 1124847220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983223295/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T09:18:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983223295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r983309189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983309189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Legacy wallets have similiar topup functionality, but only for the keypool. `LegacyScriptPubKeyMan::GetScriptPubKeys` on the other hands gets it keys from places like `KeyMap mapKeys` in `FillableSigningProvider`, which is an `std::map<CScriptID, CScript>`. There's no obvious way to get the first N keys for legacy without significant refactoring, afaik you'd have to look up the metadata for that which some ancient wallets don't have? \r\n\r\nSo I agree with having `GetScriptPubKeys(int32_t minimum_index)` for `DescriptorScriptPubKeyMan` only.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-29T09:36:11Z",
      "diff_hunk" : "@@ -643,6 +643,7 @@ class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n \n     const WalletDescriptor GetWalletDescriptor() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\n     const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r983309189",
      "id" : 983309189,
      "in_reply_to_id" : 966553892,
      "line" : 646,
      "node_id" : "PRRC_kwDOABII5846nBuF",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 646,
      "original_position" : 4,
      "original_start_line" : 645,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 4,
      "pull_request_review_id" : 1124847220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983309189/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 645,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-30T09:18:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983309189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r983315923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983315923"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or we could check `m_map_script_pub_keys.size() >= minimum_index` and return early if not. ",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-29T09:42:32Z",
      "diff_hunk" : "@@ -2641,13 +2641,18 @@ const WalletDescriptor DescriptorScriptPubKeyMan::GetWalletDescriptor() const\n }\n \n const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n+{\n+    return GetScriptPubKeys(0);\n+}\n+\n+const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const\n {\n     LOCK(cs_desc_man);\n     std::unordered_set<CScript, SaltedSipHasher> script_pub_keys;\n-    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+    script_pub_keys.reserve(std::max<size_t>(m_map_script_pub_keys.size() - minimum_index, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r983315923",
      "id" : 983315923,
      "in_reply_to_id" : 982393105,
      "line" : 2652,
      "node_id" : "PRRC_kwDOABII5846nDXT",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 2652,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 13,
      "pull_request_review_id" : 1124847220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983315923/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T09:18:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983315923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r984347822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984347822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "456097763d4bdf7ba35de2b3eb33d2160c8024c1: alternatively, maybe have the caller pass in a bunch of `DescriptorScriptPubKeyMan`s (separate argument for active and inactive / all)? Then you might not need the `assert` and `dynamic_cast`. In that case I'd rename it to `FastRescanFilterSPKM`. It would also make this class more reusable for a non-wallet descriptor rescan, like #23549.\r\n\r\nOn the other hand, it would just move a bunch of complexity into 1b6b09e399773c4bac56afead60e4d29e7fbb010.",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-30T08:31:30Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r984347822",
      "id" : 984347822,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII5846q_Su",
      "original_commit_id" : "456097763d4bdf7ba35de2b3eb33d2160c8024c1",
      "original_line" : 268,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 1124847220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984347822/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T09:18:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984347822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r984412126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984412126"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1b6b09e399773c4bac56afead60e4d29e7fbb010: it may be worth adding a new log category `scan` (in `src/logging.cpp`) that outputs which blocks are _not_ skipped. That way I can look up the block hash for missing transactions and see if the problem was the filter or some other step.\r\n\r\nIn addition, this should log when a block doesn't have a filter (but filters have been enabled).",
      "commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "created_at" : "2022-09-30T09:41:04Z",
      "diff_hunk" : "@@ -1839,9 +1843,20 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block{false};\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result{fast_rescan_filter->MatchesBlock(block_hash)};\n+            if (match_result.has_value() && !match_result.value()) {\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r984412126",
      "id" : 984412126,
      "line" : 1853,
      "node_id" : "PRRC_kwDOABII5846rO_e",
      "original_commit_id" : "1b6b09e399773c4bac56afead60e4d29e7fbb010",
      "original_line" : 1853,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 24,
      "pull_request_review_id" : 1126557919,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984412126/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T09:44:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984412126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the detailled reviews, much appreciated! Force-pushed with the following changes:\r\n- introduced a new commit which removes the unneeded \"const\" return value qualifier from the `ScriptPubKeyMan::GetScriptPubKeys()` interface and overruled methods (could also be done in the same commit extending the method for descriptor SPKs, but I think it's good practice to not mix refactor commits with ones introducing new functionality) (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979865164)\r\n- fixed potential overflow in `DescriptorScriptPubKeyMan::GetScriptPubKeys(...)` by casting `m_map_script_pub_keys.size()` result to int32_t (I'd argue that the overflow risk for this cast is neglectable, considering that we'd need > 2 billion entries for it to hit) (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982393105)\r\n- assert `desc_spkm` after dynamic casting to `DescriptorScriptPubKeyMan` (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979863337)\r\n- use `const auto&` in iteration loop of the last range ends (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r979863823)\r\n- rename `matches_result` to `matches_block` and using the dereference operator for value access (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982873205)\r\n- introduced a commit for showing a log message for each block that is _not_ skipped (can either be if our filter matches, or if the block filter is not found), if we use fast rescan (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r984412126)\r\n  \r\nThe following suggestions I think would be good candidates for follow-ups:\r\n- encapsulate the fast rescan block filter update and matching logic into an own method in `FastWalletRescanFilter` (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r982871332)\r\n- change the `FastWalletRescanFilter` interface by letting user pass in descriptor SPKs (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r984347822)\r\n- introduce new logging category like e.g. \"scan\" (this could be seen as controversial and probably needs more detailled work, e.g. \"do we really need an extra logging category for this?\" / \"what other messages have to be in this category?\")\r\n\r\n> However the top up doesn't seem to work for me, e.g. when I set keypool=20 it misses at least one address (with a receive and send on it) that had index 21. (getaddressinfo knows about it, so it's not an import mistake)\r\n\r\n@Sjors: interesting, could you share more details about the specific test-case (either here, or if preferred, in private via IRC)? Were any of the addresses on indices 0-20 used before in earlier blocks? (Do you think it's possible to easily reproduce this scenario by simply modifying the functional test in the last commit?)",
      "created_at" : "2022-10-01T10:58:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1264325950",
      "id" : 1264325950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585LXBU-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1264325950/reactions"
      },
      "updated_at" : "2022-10-01T10:58:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1264325950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085333"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done (in both loops).",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T10:58:32Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(spkm)};\n+            AddScriptPubKeys(desc_spkm);\n+            // save each active ScriptPubKeyMans's range end for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm->GetID(), GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm_id, last_range_end] : m_last_range_ends) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(m_wallet.GetScriptPubKeyMan(desc_spkm_id))};\n+            int32_t current_range_end{GetDescriptorRangeEnd(*desc_spkm)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085333",
      "id" : 985085333,
      "in_reply_to_id" : 979863337,
      "line" : 292,
      "node_id" : "PRRC_kwDOABII5846tzWV",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 292,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 40,
      "pull_request_review_id" : 1127516149,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085333/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-01T10:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085358"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T10:58:41Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm{dynamic_cast<DescriptorScriptPubKeyMan*>(spkm)};\n+            AddScriptPubKeys(desc_spkm);\n+            // save each active ScriptPubKeyMans's range end for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm->GetID(), GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm_id, last_range_end] : m_last_range_ends) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085358",
      "id" : 985085358,
      "in_reply_to_id" : 979863823,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846tzWu",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 288,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1127516166,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085358/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-01T10:58:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085438"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done with a preparatory extra refactoring commit which changes the `ScriptPubKeyMan::GetScriptPubKeys()` interface (which imposes this on us).",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T10:59:42Z",
      "diff_hunk" : "@@ -2641,13 +2641,18 @@ const WalletDescriptor DescriptorScriptPubKeyMan::GetWalletDescriptor() const\n }\n \n const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n+{\n+    return GetScriptPubKeys(0);\n+}\n+\n+const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085438",
      "id" : 985085438,
      "in_reply_to_id" : 979865164,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846tzX-",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 2648,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1127516250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085438/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-01T10:59:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Excellent find, thanks! Decided for the proposed solution of casting the `.size()` return value to int32_t.\r\n\r\n> Or we could check m_map_script_pub_keys.size() >= minimum_index and return early if not.\r\n\r\nThe comparison suffers from the same problem I think (i.e. signed value `minimum_index` could overflow in the course of getting casted to unsigned)?",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T11:02:33Z",
      "diff_hunk" : "@@ -2641,13 +2641,18 @@ const WalletDescriptor DescriptorScriptPubKeyMan::GetWalletDescriptor() const\n }\n \n const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n+{\n+    return GetScriptPubKeys(0);\n+}\n+\n+const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const\n {\n     LOCK(cs_desc_man);\n     std::unordered_set<CScript, SaltedSipHasher> script_pub_keys;\n-    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+    script_pub_keys.reserve(std::max<size_t>(m_map_script_pub_keys.size() - minimum_index, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985085683",
      "id" : 985085683,
      "in_reply_to_id" : 982393105,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846tzbz",
      "original_commit_id" : "0d611a80b43be1246047d60d93288e0648e8aeb8",
      "original_line" : 2652,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1127516492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085683/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-01T11:02:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985085683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985090623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985090623"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done. As for now, I didn't introduce a new log category, but print it unconditionally via `WalletLogPrintf`.",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T11:54:50Z",
      "diff_hunk" : "@@ -1839,9 +1843,20 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block{false};\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result{fast_rescan_filter->MatchesBlock(block_hash)};\n+            if (match_result.has_value() && !match_result.value()) {\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985090623",
      "id" : 985090623,
      "in_reply_to_id" : 984412126,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846t0o_",
      "original_commit_id" : "1b6b09e399773c4bac56afead60e4d29e7fbb010",
      "original_line" : 1853,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1127520870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985090623/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-01T11:54:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985090623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985092563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985092563"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done ð  I agree this is more readable than the previous version.",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T12:13:31Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985092563",
      "id" : 985092563,
      "in_reply_to_id" : 968963378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846t1HT",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1850,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1127522572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985092563/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-01T12:13:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985092563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985092996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985092996"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sounds like an interesting idea that is worth to be followed-up, primarily for the reusability argument. I think in the end we'd not get rid of the `assert` and `dynamic_cast` though, instead it's just shifted to the caller? (I don't see a way of avoiding the cast, since the wallet class methods `GetAllScriptPubKeyMans()` and `GetActiveScriptPubKeyMans()` only give us the SPKmans with the base class interface `ScriptPubKeyMan*`).",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T12:18:31Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985092996",
      "id" : 985092996,
      "in_reply_to_id" : 984347822,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII5846t1OE",
      "original_commit_id" : "456097763d4bdf7ba35de2b3eb33d2160c8024c1",
      "original_line" : 268,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 1127523002,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985092996/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-01T12:18:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985092996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985095244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985095244"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good valid points, I tend to agree that in this case the side-effect is acceptable and we shouldn't worry. With the current version of the PR that introduced logging messages on two cases of the tri-state result (block filter not found or wallet filter matches block), as suggested by Sjors, it get's maybe a bit more difficult to put all this logic into a single method though; the logging would also need to be part of the method, if we want to distinguish between the concrete reason of why we don't skip a block. That said, I'm of course still open though for a potential follow-up that reduces `ScanForWalletTransaction` bloat.",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-01T12:42:54Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985095244",
      "id" : 985095244,
      "in_reply_to_id" : 968972271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846t1xM",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1869,
      "original_position" : 94,
      "original_start_line" : 1842,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1127525006,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985095244/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-10-01T12:42:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985095244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm responsing to @furszy's review comments directly here as they were not given in code-review discussion threads:\r\n> Could make [1b6b09e](https://github.com/bitcoin/bitcoin/commit/1b6b09e399773c4bac56afead60e4d29e7fbb010) simpler by removing the second `if (!skip_block) {` and adding it only inside the else path (this works because the `block` is null).\r\n> \r\n> ```c++\r\n> } else if (!skip_block) {\r\n>     // could not scan block, keep scanning but record this block as the most recent failure\r\n>     result.last_failed_block = block_hash;\r\n>     result.status = ScanResult::FAILURE;\r\n> }\r\n> ```\r\n\r\nDid consider your suggestion, and I agree that it reduces the diff complexity (wouldn't need to alter indenation), but preferred the current version of as I think it's slightly more readable to surround the whole logic with the `!skip_block` condition (having the condition only at the else-branch could lead to confusion)\r\n\r\n> As the purpose of the `FastWalletRescanFilter` is track the descriptors to update the filter set structure, what about renaming the class to something like `FilterSetTracker`?\r\n\r\nI think that rename would fit along well with Sjor's idea of changing the class interface to be more generic (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r984347822), for a potential follow-up.",
      "created_at" : "2022-10-01T12:54:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1264355646",
      "id" : 1264355646,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585LXIk-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1264355646/reactions"
      },
      "updated_at" : "2022-10-01T12:54:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1264355646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Were any of the addresses on indices 0-20 used before in earlier blocks?\r\n\r\nYes, the number was ficitious, but the wallet received coins on index `keypoolsize - 1` and then many blocks later on `keypoolsize`. The latter did not get picked up, suggesting the topup didn't happen.\r\n\r\n(still the case as of c6c08603a334c1f2cd13023c878b9e42418f9b13)\r\n\r\nI'll see if I can reproduce with a test case or with a doxxable wallet.",
      "created_at" : "2022-10-03T09:19:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1265163696",
      "id" : 1265163696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585LaN2w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265163696/reactions"
      },
      "updated_at" : "2022-10-03T11:20:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265163696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985599495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985599495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While writing the suggestion, I implicitly assumed that a CWallet rescan function would call rescan on individual DescriptorScriptPubKeyMans, which would have removed the need for any casting. But scanning is done globally, which makes sense because otherwise you'd have to scan the blocks many times over.\r\n\r\nA larger refactor might add `MaybeMatch()` to the SPKM interface, which would return `true` for legacy and would use the filter for descriptors. But this would mean having N separate filters. Not sure how that impacts the overall false-positive rate.",
      "commit_id" : "c6c08603a334c1f2cd13023c878b9e42418f9b13",
      "created_at" : "2022-10-03T09:57:57Z",
      "diff_hunk" : "@@ -260,6 +261,69 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r985599495",
      "id" : 985599495,
      "in_reply_to_id" : 984347822,
      "line" : 268,
      "node_id" : "PRRC_kwDOABII5846vw4H",
      "original_commit_id" : "456097763d4bdf7ba35de2b3eb33d2160c8024c1",
      "original_line" : 268,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 1128107422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985599495/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-03T09:58:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/985599495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> introduce new logging category like e.g. \"scan\" (this could be seen as controversial and probably needs more detailled work, e.g. \"do we really need an extra logging category for this?\" / \"what other messages have to be in this category?\")\r\n\r\nAdding a log category is not that much overhead. They've been added on an ad hoc basis before. See [git blame](https://github.com/bitcoin/bitcoin/blame/7281fac2e0a41685adff024669b44c5d6586e941/src/logging.cpp#L152-L184), with not much drama. E.g. #23235 added four new categories with just the motivation that the main log was too noisy.\r\n\r\nI'm concept meh on 5eb58340b21f6f7814eaee626e2263f1f1e95564. It seems fine to keep it const, unless someone has a good reason to edit the filter set.\r\n\r\n\r\n> * fixed potential overflow in `DescriptorScriptPubKeyMan::GetScriptPubKeys(...)` by casting `m_map_script_pub_keys.size()` result to int32_t (I'd argue that the overflow risk for this cast is neglectable, considering that we'd need > 2 billion entries for it to hit)\r\n\r\nIt's probably not neglible for a determined fuzzer :-)\r\n\r\n[BIP32 allows](https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki#extended-keys ) 2^32 child keys, but because a descriptor can't be both hardened and unhardened, the maximum for a regular descriptor is 2^31. Combo descriptors return 4 `script_pub_keys`. This reveals two problems:\r\n\r\n1. `m_map_script_pub_keys` size should be treated as a 64 bit (with a max of 33 bit)\r\n2. We should not assume a 1 on 1 relation between the maximum _index_ and the size of `m_map_script_pub_keys`, only `m_map_script_pub_keys[script]` can be used to determine an index.",
      "created_at" : "2022-10-03T10:10:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1265224042",
      "id" : 1265224042,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Laclq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265224042/reactions"
      },
      "updated_at" : "2022-10-03T11:10:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265224042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In the test `KEYPOOL_SIZE` was larger than `NUM_BLOCKS` ~so it would not actually top up~ (actually it did topup). I ~also~ refactored the test to use the \"natural\" wallet topup mechanism through `getnewaddress`, which I find easier to follow.\r\n\r\nThis unfortunately doesn't reproduce the problem... https://github.com/bitcoin/bitcoin/commit/81324b9b5c617d01e64d25a37ec5b1345b6ae9d1",
      "created_at" : "2022-10-03T11:42:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1265318499",
      "id" : 1265318499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Lazpj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265318499/reactions"
      },
      "updated_at" : "2022-10-03T11:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265318499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Aaah, oops. This was an `inactive` descriptor. There's an open question* on how to deal with inactive descriptors when restoring a backup, but that's orthogonal to this PR.\r\n\r\n* = if it's a regular backup, then if the backup was made when the descriptor was active, it will topup and find new transactions. If the backup was made when it was inactive, the backup would have the right `range`. The only problem is when importing the descriptors directly. When _importing_ a descriptor that's inactive we should probably top up it anyway (perhaps unless the user explicitly sets a range for an inactive descriptor?)",
      "created_at" : "2022-10-03T12:08:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1265346460",
      "id" : 1265346460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585La6ec",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265346460/reactions"
      },
      "updated_at" : "2022-10-03T12:11:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265346460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : " > The only problem is when importing the descriptors directly. When _importing_ a descriptor that's inactive we should probably top up it anyway (perhaps unless the user explicitly sets a range for an inactive descriptor?)\r\n\r\n@Sjors, have you checked `CWallet::AddWalletDescriptor`?, imported descriptors are topped up right before adding them to the wallet there (before setting them as active or inactive). \r\n",
      "created_at" : "2022-10-03T13:40:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1265457828",
      "id" : 1265457828,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585LbVqk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265457828/reactions"
      },
      "updated_at" : "2022-10-03T13:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265457828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@furszy that's only once. The example inactive descriptor I imported would need ongoing topups.  But I think the slow rescan would have the same issue.",
      "created_at" : "2022-10-03T14:29:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1265532489",
      "id" : 1265532489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Lbn5J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265532489/reactions"
      },
      "updated_at" : "2022-10-03T14:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265532489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @furszy that's only once. The example inactive descriptor I imported would need ongoing topups. But I think the slow rescan would have the same issue.\r\n\r\nGuess that you are deriving keys externally, that are outside of the pre-generated keypool range?\r\n\r\nBecause otherwise the wallet should detect them, we don't differentiate active from inactive descriptors for the, per block, used keys top up.\r\n\r\nedit, just saw https://github.com/bitcoin/bitcoin/pull/25957#pullrequestreview-1124847220..",
      "created_at" : "2022-10-03T14:43:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1265564579",
      "id" : 1265564579,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Lbvuj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265564579/reactions"
      },
      "updated_at" : "2022-10-03T14:45:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265564579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
