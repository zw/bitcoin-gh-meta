{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "[BIP9](https://github.com/bitcoin/bips/blob/master/bip-0009.mediawiki) specifies\r\n\r\n> GetMedianTimePast in the code ... refers to the median nTime of a block and its 10 predecessors.\r\n\r\nHowever, in `src/chain.h`, `GetMedianTimePast` is defined as\r\n```cpp\r\n    int64_t GetMedianTimePast() const\r\n    {\r\n        int64_t pmedian[nMedianTimeSpan];\r\n        int64_t* pbegin = &pmedian[nMedianTimeSpan];\r\n        int64_t* pend = &pmedian[nMedianTimeSpan];\r\n\r\n        const CBlockIndex* pindex = this;\r\n        for (int i = 0; i < nMedianTimeSpan && pindex; i++, pindex = pindex->pprev)\r\n            *(--pbegin) = pindex->GetBlockTime();\r\n\r\n        std::sort(pbegin, pend);\r\n        return pbegin[(pend - pbegin)/2];\r\n    }\r\n```\r\n\r\nThis implementation omits the block itself (i.e. `this->GetBlockTime()`) from consideration, since we're decrementing `pbegin` before its first use. This leaves `pmedian[nMedianTimeSpan]` unassigned. This is almost never an issue because we end up selecting the median element from the range, but calling this method on the genesis block would produce undefined behavior AFAICT.\r\n\r\nThis omission may well be intentional, but I figured I'd verify that here. If it isn't intentional, I'll file a PR containing the following change along with some supporting unittests:\r\n\r\n```diff\r\ndiff --git a/src/chain.h b/src/chain.h\r\nindex c5304b7..fbe92b1 100644\r\n--- a/src/chain.h\r\n+++ b/src/chain.h\r\n@@ -313,6 +313,8 @@ public:\r\n         int64_t* pend = &pmedian[nMedianTimeSpan];\r\n \r\n         const CBlockIndex* pindex = this;\r\n+        *pbegin = pindex->GetBlockTime();\r\n+\r\n         for (int i = 0; i < nMedianTimeSpan && pindex; i++, pindex = pindex->pprev)\r\n             *(--pbegin) = pindex->GetBlockTime();\r\n```\r\n\r\n",
   "closed_at" : "2017-07-07T05:58:04Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
      "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jamesob/followers",
      "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jamesob",
      "id" : 73197,
      "login" : "jamesob",
      "node_id" : "MDQ6VXNlcjczMTk3",
      "organizations_url" : "https://api.github.com/users/jamesob/orgs",
      "received_events_url" : "https://api.github.com/users/jamesob/received_events",
      "repos_url" : "https://api.github.com/users/jamesob/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jamesob"
   },
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10755/comments",
   "created_at" : "2017-07-06T17:11:05Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10755/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/10755",
   "id" : 241025570,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10755/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUyNDEwMjU1NzA=",
   "number" : 10755,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "GetMedianTimePast doesn't incorporate its own block",
   "updated_at" : "2017-07-07T05:58:04Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10755",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
      "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jamesob/followers",
      "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jamesob",
      "id" : 73197,
      "login" : "jamesob",
      "node_id" : "MDQ6VXNlcjczMTk3",
      "organizations_url" : "https://api.github.com/users/jamesob/orgs",
      "received_events_url" : "https://api.github.com/users/jamesob/received_events",
      "repos_url" : "https://api.github.com/users/jamesob/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jamesob"
   }
}
