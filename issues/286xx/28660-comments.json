[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28660).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [maflcko](https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772361407) |\n| Concept ACK | [jonatack](https://github.com/bitcoin/bitcoin/pull/28660#pullrequestreview-1680966944), [theStack](https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772652197) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28116](https://github.com/bitcoin/bitcoin/pull/28116) (test: update tool_wallet coverage for unexpected writes to wallet by jonatack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-10-16T20:57:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1765264152",
      "id" : 1765264152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pN8sY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765264152/reactions"
      },
      "updated_at" : "2023-10-20T12:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765264152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361268939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361268939"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I assume you checked what this returns locally: `import platform; print(platform.system())`, but how did you check for both platforms?",
      "commit_id" : "3709e2863fd344b7387b1e2ced37adbca9ab9bf5",
      "created_at" : "2023-10-16T21:09:59Z",
      "diff_hunk" : "@@ -51,6 +52,20 @@ def reindex_readonly(self):\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n                     return\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361268939",
      "id" : 1361268939,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585RI1DL",
      "original_commit_id" : "3709e2863fd344b7387b1e2ced37adbca9ab9bf5",
      "original_line" : 55,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 12,
      "pull_request_review_id" : 1680966944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361268939/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T00:44:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361268939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361274045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361274045"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Verified on https://man.openbsd.org/chflags.1 that `uchg` and `nouchg` appear to be the correct values for \"set the user immutable flag (owner or superuser only)\" and \"clear the immutable bit\", respectively.",
      "commit_id" : "3709e2863fd344b7387b1e2ced37adbca9ab9bf5",
      "created_at" : "2023-10-16T21:16:24Z",
      "diff_hunk" : "@@ -59,6 +74,8 @@ def reindex_readonly(self):\n \n         if used_chattr:\n             subprocess.check_call(['chattr', '-i', filename])\n+        if used_chflags:\n+            subprocess.check_call(['chflags', 'nouchg', filename])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361274045",
      "id" : 1361274045,
      "line" : 78,
      "node_id" : "PRRC_kwDOABII585RI2S9",
      "original_commit_id" : "3709e2863fd344b7387b1e2ced37adbca9ab9bf5",
      "original_line" : 78,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 34,
      "pull_request_review_id" : 1680974940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361274045/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T21:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361274045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, will test on OpenBSD [7.4](https://www.openbsd.org/74.html) in a bit.",
      "created_at" : "2023-10-16T23:49:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1765440946",
      "id" : 1765440946,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pOn2y",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765440946/reactions"
      },
      "updated_at" : "2023-10-16T23:49:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765440946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361438741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361438741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I literally ran the command on both free and open bsd systems ;-) I already have an OpenBSD server for DNS and just spun up a FreeBSD on Google cloud for this task. ",
      "commit_id" : "3709e2863fd344b7387b1e2ced37adbca9ab9bf5",
      "created_at" : "2023-10-17T02:28:59Z",
      "diff_hunk" : "@@ -51,6 +52,20 @@ def reindex_readonly(self):\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n                     return\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361438741",
      "id" : 1361438741,
      "in_reply_to_id" : 1361268939,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585RJegV",
      "original_commit_id" : "3709e2863fd344b7387b1e2ced37adbca9ab9bf5",
      "original_line" : 55,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 12,
      "pull_request_review_id" : 1681239273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361438741/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T02:28:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361438741",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361898333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361898333"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: Could replace the two boolean with a single `undo_immutable`, which holds an optional lambda to run. (a no-op by default, and set to None if the test should terminate early, and the respective undo command if an util helper was used?)\r\n\r\nThis should reduce the number of symbols, and reduce the mix of `if-else` vs early-`return`. The diff below would look like:\r\n\r\n```diff\r\ndiff --git a/test/functional/feature_reindex_readonly.py b/test/functional/feature_reindex_readonly.py\r\nindex 26531f472b..77716b371e 100755\r\n--- a/test/functional/feature_reindex_readonly.py\r\n+++ b/test/functional/feature_reindex_readonly.py\r\n@@ -53,12 +53,11 @@ class BlockstoreReindexTest(BitcoinTestFramework):\r\n                     return\r\n \r\n         self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\r\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\r\n+        if undo_immutable:\r\n+          with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\r\n             self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\r\n                 expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\r\n-\r\n-        if used_chattr:\r\n-            subprocess.check_call(['chattr', '-i', filename])\r\n+          undo_immutable()\r\n \r\n         filename.chmod(0o777)\r\n \r\n",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T10:37:16Z",
      "diff_hunk" : "@@ -35,6 +35,7 @@ def reindex_readonly(self):\n         filename.chmod(stat.S_IREAD)\n \n         used_chattr = False\n+        used_chflags = False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1361898333",
      "id" : 1361898333,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RLOtd",
      "original_commit_id" : "3709e2863fd344b7387b1e2ced37adbca9ab9bf5",
      "original_line" : 38,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1681976469,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361898333/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T10:53:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361898333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362271524"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362271524"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I think you can now remove the early return, because it should be fine and clearer to run the next line unconditionally.",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T14:54:41Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362271524",
      "id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMp0k",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682597129,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362271524/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T14:54:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362271524",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362275167"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362275167"
         }
      },
      "author_association" : "MEMBER",
      "body" : "heh thanks. Having an issue on macos now...",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T14:56:45Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362275167",
      "id" : 1362275167,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMqtf",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682602980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362275167/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T14:56:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362275167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362279856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362279856"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> heh thanks. Having an issue on macos now...\r\n\r\nThe last push (57972250feb3ad61b91c8fbcb01eac1b4b57095f) seems to run fine on arm64 macOS for me.",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T14:59:37Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362279856",
      "id" : 1362279856,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMr2w",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682610274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362279856/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T14:59:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362279856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362280718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362280718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "macOS should be unaffected by this and execute `lambda: None`, no?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:00:12Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362280718",
      "id" : 1362280718,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMsEO",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682611620,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362280718/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:00:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362280718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362280854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362280854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jonatack as root?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:00:16Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362280854",
      "id" : 1362280854,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMsGW",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682611838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362280854/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:00:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362280854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362283184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362283184"
         }
      },
      "author_association" : "MEMBER",
      "body" : "OK I see even before this new commit macOS test would NOT work as root. Hm I thought we already went over that. I guess the macOS ci is not running as root?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:01:47Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362283184",
      "id" : 1362283184,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMsqw",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682615424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362283184/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:02:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362283184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362283516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362283516"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Are you saying that macOS under root can run this test on master, but not on this pull request?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:02:00Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362283516",
      "id" : 1362283516,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMsv8",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682615952,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362283516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:02:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362283516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362286035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362286035"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah. Yes, `sudo test/functional/feature_reindex_readonly.py` stalls.",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:03:46Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362286035",
      "id" : 1362286035,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMtXT",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682620139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362286035/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:03:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362286035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362286491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362286491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes, macos as root on master doesnt work. However, this will:\r\n\r\n`if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\" or platform.system() == \"Darwin\":`\r\n\r\nwhats the best style for a triple - or in python?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:04:03Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362286491",
      "id" : 1362286491,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMteb",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682620750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362286491/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362286491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362289186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362289186"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`if platform.system() in [\"FreeBSD\", \"OpenBSD\", \"Darwin\"]:` there we go ;-)",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:06:00Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362289186",
      "id" : 1362289186,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMuIi",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682625164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362289186/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:06:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362289186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362292097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362292097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is very confusing. The last commit should be a refactor. And the first commit shouldn't affect macOS. This is a bug on master already, right?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:08:11Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362292097",
      "id" : 1362292097,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMu2B",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682630063,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362292097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:08:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362292097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362292516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362292516"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Latest push e7db19f42bb50953c6aaaf5997f8ee78eed9dab4 works for me as root.",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:08:30Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362292516",
      "id" : 1362292516,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMu8k",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682630923,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362292516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:09:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362292516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362294614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362294614"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@maflcko the first commit does not affect macos. the second commit is a refactor that also fixes a macos/root bug on master. Want me to separate the macos out to commit 3?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:10:00Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362294614",
      "id" : 1362294614,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMvdW",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682634277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362294614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:10:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362294614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362295287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362295287"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@maflcko yes, running this test as root blocks for me on master as well.",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:10:29Z",
      "diff_hunk" : "@@ -50,15 +50,30 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() == \"FreeBSD\" or platform.system() == \"OpenBSD\":\n+            try:\n+                subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                self.log.info(\"Made file immutable with chflags\")\n+            except subprocess.CalledProcessError as e:\n+                self.log.warning(str(e))\n+                if e.stdout:\n+                    self.log.warning(f\"stdout: {e.stdout}\")\n+                if e.stderr:\n+                    self.log.warning(f\"stderr: {e.stderr}\")\n+                if os.getuid() == 0:\n+                    self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                    undo_immutable = False\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n+            with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n+                self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n+                    expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+            undo_immutable()\n+        else:\n+            return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362295287",
      "id" : 1362295287,
      "in_reply_to_id" : 1362271524,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMvn3",
      "original_commit_id" : "d72f863ae922a9462a4ffb85caf53ed7de2438d6",
      "original_line" : 76,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682635377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362295287/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:10:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362295287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362297036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362297036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What about netbsd? I think you can just run `if chflags --version` or similar here?",
      "commit_id" : "db03177f8aa22fd9f2ec3960b5829c446ad08577",
      "created_at" : "2023-10-17T15:11:41Z",
      "diff_hunk" : "@@ -50,15 +50,28 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        if platform.system() in [\"FreeBSD\", \"OpenBSD\", \"Darwin\"]:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1362297036",
      "id" : 1362297036,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMwDM",
      "original_commit_id" : "e7db19f42bb50953c6aaaf5997f8ee78eed9dab4",
      "original_line" : 54,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1682638026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362297036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:12:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362297036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "squashed and replaced all the `platform` queries with try/catch tests for the commands themselves.",
      "created_at" : "2023-10-17T15:24:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1766647573",
      "id" : 1766647573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pTOcV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1766647573/reactions"
      },
      "updated_at" : "2023-10-17T15:24:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1766647573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "lgtm code ACK cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T09:07:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772361407",
      "id" : 1772361407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585ppBa_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772361407/reactions"
      },
      "updated_at" : "2023-10-20T09:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772361407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there any good reason to abuse try/catch for regular logic control flow, in this case the OS detection (previously done with `platform.system()`, which makes much more sense IMHO)? For example, I'm running OpenBSD 7.4 with the package e2fsprogs installed, which has a binary `/usr/local/bin/chattr` installed, so the Linux branch is executed. That's a bit unexpected, though on the other hand one could argue it's fine, as the test still succeeds and serves its purpose. At least it works as long as we only need the binaries and there is no other OS-specific tests going on inside the branches.",
      "created_at" : "2023-10-20T11:39:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772580110",
      "id" : 1772580110,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pp20O",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772580110/reactions"
      },
      "updated_at" : "2023-10-20T11:39:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772580110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theStack the issue was hard-coding all the OSs. Every flavor of *BSD plus macOS has `chattr`, Linux has `chflags` and Windows, well... `chmod` seems to work against root on Windows. The test isn't trying to assert that certain behaviors are expected on certain OSes, we just want that file to be immutable \"by any means necessary\"",
      "created_at" : "2023-10-20T11:58:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772602244",
      "id" : 1772602244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pp8OE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772602244/reactions"
      },
      "updated_at" : "2023-10-20T11:58:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772602244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366881765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366881765"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, might be good not to mix data types (probably a leftover from an earlier version of the PR?) :\r\n```suggestion\r\n                    undo_immutable = lambda: None\r\n```\r\n(also in the macOS/BSD branch below)",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T12:02:56Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366881765",
      "id" : 1366881765,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585RePXl",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 54,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 35,
      "pull_request_review_id" : 1689883180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366881765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T12:29:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366881765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> previously done with `platform.system()`, which makes much more sense IMHO\r\n\r\nNot sure. This would force us to maintain a list of all operating systems in this test. FreeBSD, NetBSD, OpenBSD, macOS, ...\r\nSeems easier to just write code that only checks for the program the test needs?",
      "created_at" : "2023-10-20T12:03:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772608309",
      "id" : 1772608309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pp9s1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772608309/reactions"
      },
      "updated_at" : "2023-10-20T12:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772608309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366883032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366883032"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think it's fine to always show this line, so one can quickly see if the actual test is executed at all:\r\n```suggestion\r\n            self.log.info(\"Attempt to restart and reindex the node with the unwritable block file\")\r\n```\r\n",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T12:04:23Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        except Exception:\n+            # macOS, and *BSD\n+            try:\n+                subprocess.run(['chflags'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n+                try:\n+                    subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                    undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                    self.log.info(\"Made file immutable with chflags\")\n+                except subprocess.CalledProcessError as e:\n+                    self.log.warning(str(e))\n+                    if e.stdout:\n+                        self.log.warning(f\"stdout: {e.stdout}\")\n+                    if e.stderr:\n+                        self.log.warning(f\"stderr: {e.stderr}\")\n+                    if os.getuid() == 0:\n+                        self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                        undo_immutable = False\n+            except Exception:\n+                pass\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366883032",
      "id" : 1366883032,
      "line" : 76,
      "node_id" : "PRRC_kwDOABII585RePrY",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 76,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 59,
      "pull_request_review_id" : 1689883180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366883032/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T12:29:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366883032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'm running OpenBSD 7.4 with the package e2fsprogs installed, which has a binary `/usr/local/bin/chattr` installed, so the Linux branch is executed.\r\n\r\nIf this package can be installed on all BSD and macOS, I think we can also remove the BSD branch, and just require this package?",
      "created_at" : "2023-10-20T12:04:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772610030",
      "id" : 1772610030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pp-Hu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772610030/reactions"
      },
      "updated_at" : "2023-10-20T12:04:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772610030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366893829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366893829"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n                    undo_immutable = lambda: subprocess.check_call(['chflags', 'nouchg', filename])\r\n```\r\n(currently, the test is not executed on OpenBSD, as `undo_immutable` is assigned an integer of value zero, if the `chflags` call succeeds)",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T12:14:28Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        except Exception:\n+            # macOS, and *BSD\n+            try:\n+                subprocess.run(['chflags'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n+                try:\n+                    subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                    undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366893829",
      "id" : 1366893829,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII585ReSUF",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 61,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 42,
      "pull_request_review_id" : 1689883180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366893829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T12:29:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366893829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't think chattr is available for macOS",
      "created_at" : "2023-10-20T12:18:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772636633",
      "id" : 1772636633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pqEnZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772636633/reactions"
      },
      "updated_at" : "2023-10-20T12:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772636633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "But, we could make this a utility function that returns an \"undo\" lambda? And then get the weird code out of the test itself?",
      "created_at" : "2023-10-20T12:19:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772638466",
      "id" : 1772638466,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pqFEC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772638466/reactions"
      },
      "updated_at" : "2023-10-20T12:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772638466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @theStack the issue was hard-coding all the OSs. Every flavor of *BSD plus macOS has `chattr`, Linux has `chflags` and Windows, well... `chmod` seems to work against root on Windows. The test isn't trying to assert that certain behaviors are expected on certain OSes, we just want that file to be immutable \"by any means necessary\"\r\n\r\n\r\n\r\n> > previously done with `platform.system()`, which makes much more sense IMHO\r\n> \r\n> Not sure. This would force us to maintain a list of all operating systems in this test. FreeBSD, NetBSD, OpenBSD, macOS, ... Seems easier to just write code that only checks for the program the test needs?\r\n\r\nYeah, fair enough, I agree that maintaining this list is also not ideal, and just checking for the programs we need is fine. What I particularly don't like about catching the generic `Exception` as control flow instrument is that there are a whole lot of other reasons why exceptions could be thrown (when something _actually_ goes wrong, like out of disk space/memory, or whatever else), and then we wouldn't even notice it, as in the end everything is swallowed by the final `except Exception: pass` and the test just passes fine. That seems a bit fragile. But no strong opinion, I'm happy to ACK once it works on OpenBSD (see below).",
      "created_at" : "2023-10-20T12:29:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772652197",
      "id" : 1772652197,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pqIal",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772652197/reactions"
      },
      "updated_at" : "2023-10-20T12:29:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772652197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366936388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366936388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this works. This will break running the test in a Linux container without `--cap-add LINUX_IMMUTABLE`, no?\r\n\r\nSee also the log line immediately above this line.",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T12:54:06Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366936388",
      "id" : 1366936388,
      "in_reply_to_id" : 1366881765,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585RectE",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 54,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 35,
      "pull_request_review_id" : 1689973959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366936388/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T12:54:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366936388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366937585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366937585"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder when we'll be be able to write the tests in a type-safe language.",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T12:55:06Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        except Exception:\n+            # macOS, and *BSD\n+            try:\n+                subprocess.run(['chflags'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n+                try:\n+                    subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                    undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366937585",
      "id" : 1366937585,
      "in_reply_to_id" : 1366893829,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII585Rec_x",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 61,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 42,
      "pull_request_review_id" : 1689975713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366937585/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T12:55:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366937585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Here's some more practical example why catching the generic `Exception` is not a good idea. With the following patch, the test passes just fine, as we don't notice the error which would normally be thrown if we try to call a method that doesn't exist:\r\n```diff\r\ndiff --git a/test/functional/feature_reindex_readonly.py b/test/functional/feature_reindex_readonly.py\r\nindex b276be9c03..9f3b642338 100755\r\n--- a/test/functional/feature_reindex_readonly.py\r\n+++ b/test/functional/feature_reindex_readonly.py\r\n@@ -36,7 +36,7 @@ class BlockstoreReindexTest(BitcoinTestFramework):\r\n         undo_immutable = lambda: None\r\n         # Linux\r\n         try:\r\n-            subprocess.run(['chattr'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\r\n+            subprocess.run_thismethoddoesnotevenexist(['chattr'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\r\n             try:\r\n                 subprocess.run(['chattr', '+i', filename], capture_output=True, check=True)\r\n                 undo_immutable = lambda: subprocess.check_call(['chattr', '-i', filename])\r\n\r\n```\r\nThis should throw an `AttributeError: module 'subprocess' has no attribute 'run_thismethoddoesnotevenexist'`, and it indeed does, but we don't notice it, as we fall in the `except Exception` branch. But enough ranting about that topic from my side for now :)",
      "created_at" : "2023-10-20T12:57:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#issuecomment-1772693305",
      "id" : 1772693305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28660",
      "node_id" : "IC_kwDOABII585pqSc5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772693305/reactions"
      },
      "updated_at" : "2023-10-20T12:57:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772693305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366944711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366944711"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oops, indeed. In my mind `lambda: None` was falsy and thought the if condition below wouldn't be executed, my bad.",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T13:00:20Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366944711",
      "id" : 1366944711,
      "in_reply_to_id" : 1366881765,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585ReevH",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 54,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 35,
      "pull_request_review_id" : 1689989756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366944711/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T13:03:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366944711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366954370"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366954370"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It may be possible to type `lambda: pass`, which should be equal to `lambda: None`?",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T13:09:13Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1366954370",
      "id" : 1366954370,
      "in_reply_to_id" : 1366881765,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585RehGC",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 54,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 35,
      "pull_request_review_id" : 1690005902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366954370/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T13:09:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366954370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1367224753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367224753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> It may be possible to type `lambda: pass`, which should be equal to `lambda: None`?\r\n\r\nUnfortunately not:\r\n```\r\n$ python3\r\nPython 3.10.11 (main, Apr 13 2023, 01:52:20) [Clang 13.0.0 ] on openbsd7\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> x = lambda: pass\r\n  File \"<stdin>\", line 1\r\n    x = lambda: pass\r\n                ^^^^\r\nSyntaxError: invalid syntax\r\n```\r\n\r\nI wonder what type checkers like mypy would consider as the correct falsy value for a lambda. Maybe `None` would be slightly better than `False`? (or maybe both would be rejected, idk). Anyways, `False` seems to do its job.",
      "commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "created_at" : "2023-10-20T16:31:03Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1367224753",
      "id" : 1367224753,
      "in_reply_to_id" : 1366881765,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585RfjGx",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 54,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 35,
      "pull_request_review_id" : 1690472292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367224753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-20T16:31:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367224753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1368796441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368796441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "damn great catch thanks, fixing",
      "commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "created_at" : "2023-10-23T14:42:32Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        except Exception:\n+            # macOS, and *BSD\n+            try:\n+                subprocess.run(['chflags'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n+                try:\n+                    subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                    undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1368796441",
      "id" : 1368796441,
      "in_reply_to_id" : 1366893829,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rli0Z",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 61,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1692760187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368796441/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-23T14:42:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368796441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1368825134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368825134"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes thanks",
      "commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "created_at" : "2023-10-23T14:58:45Z",
      "diff_hunk" : "@@ -50,15 +51,33 @@ def reindex_readonly(self):\n                     self.log.warning(\"Return early on Linux under root, because chattr failed.\")\n                     self.log.warning(\"This should only happen due to missing capabilities in a container.\")\n                     self.log.warning(\"Make sure to --cap-add LINUX_IMMUTABLE if you want to run this test.\")\n-                    return\n-\n-        self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")\n-        with self.nodes[0].assert_debug_log(expected_msgs=['FlushStateToDisk', 'failed to open file'], unexpected_msgs=[]):\n-            self.nodes[0].assert_start_raises_init_error(extra_args=['-reindex', '-fastprune'],\n-                expected_msg=\"Error: A fatal internal error occurred, see debug.log for details\")\n+                    undo_immutable = False\n+        except Exception:\n+            # macOS, and *BSD\n+            try:\n+                subprocess.run(['chflags'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n+                try:\n+                    subprocess.run(['chflags', 'uchg', filename], capture_output=True, check=True)\n+                    undo_immutable = subprocess.check_call(['chflags', 'nouchg', filename])\n+                    self.log.info(\"Made file immutable with chflags\")\n+                except subprocess.CalledProcessError as e:\n+                    self.log.warning(str(e))\n+                    if e.stdout:\n+                        self.log.warning(f\"stdout: {e.stdout}\")\n+                    if e.stderr:\n+                        self.log.warning(f\"stderr: {e.stderr}\")\n+                    if os.getuid() == 0:\n+                        self.log.warning(\"Return early on BSD under root, because chflags failed.\")\n+                        undo_immutable = False\n+            except Exception:\n+                pass\n \n-        if used_chattr:\n-            subprocess.check_call(['chattr', '-i', filename])\n+        if undo_immutable:\n+            self.log.debug(\"Attempt to restart and reindex the node with the unwritable block file\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1368825134",
      "id" : 1368825134,
      "in_reply_to_id" : 1366883032,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rlp0u",
      "original_commit_id" : "cbd5bf07d251900b944056bebc7635a9ce9fee6b",
      "original_line" : 76,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : null,
      "pull_request_review_id" : 1692804650,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368825134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-23T14:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368825134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1369999711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369999711"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I guess the comment isn't applicable, given that chattr can be installed on FreeBSD",
      "commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "created_at" : "2023-10-24T11:19:54Z",
      "diff_hunk" : "@@ -34,11 +33,13 @@ def reindex_readonly(self):\n         filename = self.nodes[0].chain_path / \"blocks\" / \"blk00000.dat\"\n         filename.chmod(stat.S_IREAD)\n \n-        used_chattr = False\n-        if platform.system() == \"Linux\":\n+        undo_immutable = lambda: None\n+        # Linux",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1369999711",
      "id" : 1369999711,
      "line" : 37,
      "node_id" : "PRRC_kwDOABII585RqIlf",
      "original_commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "original_line" : 37,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 15,
      "pull_request_review_id" : 1694589559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369999711/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-25T19:44:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369999711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1372249189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1372249189"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "On Ubuntu 22.04.3 LTS, this line throws an exception for me\r\n```\r\n2023-10-25T19:35:49.783000Z TestFramework (DEBUG): Make the first block file read-only\r\n2023-10-25T19:35:49.785000Z TestFramework (WARNING): Command '['chattr', '+i', PosixPath('/tmp/bitcoin_func_test_i3g4dkjv/node0/regtest/blocks/blk00000.dat')]' returned non-zero exit status 1.\r\n2023-10-25T19:35:49.785000Z TestFramework (WARNING): stderr: b'chattr: Operation not permitted while setting flags on /tmp/bitcoin_func_test_i3g4dkjv/node0/regtest/blocks/blk00000.dat\\n'\r\n```\r\nIn spite of this, the file is still changed to readonly, so the test still works as intended (it just doesn't set `undo_immutable` in the next line because of the exception).",
      "commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "created_at" : "2023-10-25T19:42:02Z",
      "diff_hunk" : "@@ -34,11 +33,13 @@ def reindex_readonly(self):\n         filename = self.nodes[0].chain_path / \"blocks\" / \"blk00000.dat\"\n         filename.chmod(stat.S_IREAD)\n \n-        used_chattr = False\n-        if platform.system() == \"Linux\":\n+        undo_immutable = lambda: None\n+        # Linux\n+        try:\n+            subprocess.run(['chattr'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n             try:\n                 subprocess.run(['chattr', '+i', filename], capture_output=True, check=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1372249189",
      "id" : 1372249189,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII585Rytxl",
      "original_commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "original_line" : 41,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 19,
      "pull_request_review_id" : 1698130094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1372249189/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-25T19:42:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1372249189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1372251564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1372251564"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, but this seems unrelated to the changes here, and the warning can be ignored. I guess it should just be a `debug` or `info` level?",
      "commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "created_at" : "2023-10-25T19:44:49Z",
      "diff_hunk" : "@@ -34,11 +33,13 @@ def reindex_readonly(self):\n         filename = self.nodes[0].chain_path / \"blocks\" / \"blk00000.dat\"\n         filename.chmod(stat.S_IREAD)\n \n-        used_chattr = False\n-        if platform.system() == \"Linux\":\n+        undo_immutable = lambda: None\n+        # Linux\n+        try:\n+            subprocess.run(['chattr'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n             try:\n                 subprocess.run(['chattr', '+i', filename], capture_output=True, check=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28660#discussion_r1372251564",
      "id" : 1372251564,
      "in_reply_to_id" : 1372249189,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII585RyuWs",
      "original_commit_id" : "5a0688a20d88a9641c02436abbd7b49e227f1a37",
      "original_line" : 41,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex_readonly.py",
      "position" : 19,
      "pull_request_review_id" : 1694589559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28660",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1372251564/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-25T19:44:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1372251564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   }
]
