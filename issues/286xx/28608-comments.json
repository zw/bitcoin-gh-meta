[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28608).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1751642509), [Sjors](https://github.com/bitcoin/bitcoin/pull/28608#pullrequestreview-1664332227) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28616](https://github.com/bitcoin/bitcoin/pull/28616) (Show transactions as not fully confirmed during background validation by Sjors)\n* [#28569](https://github.com/bitcoin/bitcoin/pull/28569) (log: Don't log cache rebalancing in absense of a snapshot chainstate by fjahr)\n* [#28550](https://github.com/bitcoin/bitcoin/pull/28550) (Covenant tools softfork by jamesob)\n* [#28368](https://github.com/bitcoin/bitcoin/pull/28368) (Fee Estimator updates from Validation Interface/CScheduler thread by ismaelsadeeq)\n* [#28051](https://github.com/bitcoin/bitcoin/pull/28051) (Get rid of shutdown.cpp/shutdown.h, use SignalInterrupt directly by ryanofsky)\n* [#26762](https://github.com/bitcoin/bitcoin/pull/26762) (bugfix: Make `CCheckQueue` RAII-styled (attempt 2) by hebasto)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-10-06T22:01:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1751446981",
      "id" : 1751446981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585oZPXF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751446981/reactions"
      },
      "updated_at" : "2023-10-16T17:16:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751446981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, aside from the linked discussions, this would also resolve a few more review comments in #27596.",
      "created_at" : "2023-10-07T07:56:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1751642509",
      "id" : 1751642509,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585oZ_GN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751642509/reactions"
      },
      "updated_at" : "2023-10-07T07:56:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751642509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Drop from 26.0 milestone?",
      "created_at" : "2023-10-07T10:59:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1751681921",
      "id" : 1751681921,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585oaIuB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751681921/reactions"
      },
      "updated_at" : "2023-10-07T10:59:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751681921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Drop from 26.0 milestone?\n\nWhy?",
      "created_at" : "2023-10-07T12:32:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1751700385",
      "id" : 1751700385,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585oaNOh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751700385/reactions"
      },
      "updated_at" : "2023-10-07T12:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751700385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > Drop from 26.0 milestone?\r\n> \r\n> Why?\r\n\r\n~Because it is still drafted and conflicting a day before the feature freeze?~\r\n\r\nnm. I missed the context.",
      "created_at" : "2023-10-07T12:36:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1751701890",
      "id" : 1751701890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585oaNmC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751701890/reactions"
      },
      "updated_at" : "2023-10-07T12:38:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751701890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry about the noise.",
      "created_at" : "2023-10-07T12:38:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1751702379",
      "id" : 1751702379,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585oaNtr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751702379/reactions"
      },
      "updated_at" : "2023-10-07T12:38:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751702379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-08T17:25:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1752111159",
      "id" : 1752111159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585obxg3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1752111159/reactions"
      },
      "updated_at" : "2023-10-08T17:25:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1752111159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28608#discussion_r1350236225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350236225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If practical, it would be nice to have this change in a seperate commit from the (simpler) changes above.",
      "commit_id" : "12b3a6b205b6c20d2a8da2fa63de11b2b5cc8405",
      "created_at" : "2023-10-09T12:22:15Z",
      "diff_hunk" : "@@ -5937,12 +5937,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             // If a snapshot chainstate is in use, we want to find its next blocks\n             // before the background chainstate to prioritize getting to network tip.\n             FindNextBlocksToDownload(*peer, get_inflight_budget(), vToDownload, staller);\n-            if (m_chainman.BackgroundSyncInProgress() && !IsLimitedPeer(*peer)) {\n+            auto historical_blocks = m_chainman.GetHistoricalBlockRange();\n+            if (historical_blocks && !IsLimitedPeer(*peer)) {\n                 TryDownloadingHistoricalBlocks(\n                     *peer,\n                     get_inflight_budget(),\n-                    vToDownload, m_chainman.GetBackgroundSyncTip(),\n-                    Assert(m_chainman.GetSnapshotBaseBlock()));\n+                    vToDownload, historical_blocks->first, historical_blocks->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#discussion_r1350236225",
      "id" : 1350236225,
      "line" : 5945,
      "node_id" : "PRRC_kwDOABII585QevhB",
      "original_commit_id" : "12b3a6b205b6c20d2a8da2fa63de11b2b5cc8405",
      "original_line" : 5945,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 21,
      "pull_request_review_id" : 1664332227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350236225/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-09T12:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350236225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nA new circular dependency in the form of \"interfaces/chain.h -> kernel/chain -> interfaces/chain.h\" appears to have been introduced.",
      "created_at" : "2023-10-12T20:05:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1760295182",
      "id" : 1760295182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585o6_kO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1760295182/reactions"
      },
      "updated_at" : "2023-10-12T20:05:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1760295182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Update on this PR: The state cleanup part of this PR is implemented. I think it is a nice change which should make code easier to understand by making chainstate objects self contained and removing assumeutxo specific special cases in validation code. It also net removes 140 lines of code.\r\n\r\nThe locking changes (not yet pushed) are a mess, though. As mentioned in the PR description, I'm trying to delete the background chainstate after snapshot validation without waiting for bitcoind to be restarted. This requires a mutex to protect chainstates from being deleted while they are in use, so I added a simple `m_chainstates_mutex` to guard the `m_chainstates` vector, but this has snowballed into a much bigger change because of lock ordering conflicts. Some parts of the code like `Chainstate::ActivateBestChain` need to lock `m_chainstates_mutex` before `cs_main` so `cs_main` can be released to let notifications be processed. But most code wants to lock `cs_main` first, and only needs to access `ChainstateManager` object briefly to get a reference to the active chain, so it more naturally locks `cs_main` before `m_chainstates_mutex`. I was able to make cleanups in validation.cpp, moving things between `Chainstate` and `ChainstateManager` to acquire `m_chainstates_mutex` before `cs_main`, or relying on `Chainstate` members and avoiding the need to lock `m_chainstates_mutex` at all, and I think these changes are good, but after doing this (3b5c646790c55c01c318bce7d029a8d9e67147bc) it turns out the lock order inconsistency is much worse in net_processing than validation, and it would not be good for performance or code complexity to try lock `m_chainstates_mutex` before `cs_main` there.\r\n\r\nI'm thinking of taking a different approach of using a shared mutex instead of an exclusive mutex to protect access to `Chainstate` instances and prevent them from being deleted while in use. Then code could freely obtain shared locks to `m_chainstates_mutex` and exclusive locks to `cs_main` in either order. In order to prevent deadlocks, the small amount of code that creates and deletes chainstates and needs exclusive access to both locks would just need to be careful to acquire both locks atomically and never hold one exclusive lock while it is waiting for the other. This idea is conceptually pretty simple, and it could introduce support for shared locking that could be useful in other contexts. But I'm not exactly sure what approach to take with the implementation, and I'm worried it may run into problems with compiler thread safety analysis. I'm also wondering if it might make sense to pause working on locking and instead work on splitting up the current PR into commits to make it more reviewable.",
      "created_at" : "2023-10-18T16:00:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1768811641",
      "id" : 1768811641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585pbex5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1768811641/reactions"
      },
      "updated_at" : "2023-10-18T16:02:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1768811641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-20T13:48:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1772774867",
      "id" : 1772774867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585pqmXT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772774867/reactions"
      },
      "updated_at" : "2023-10-20T13:48:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1772774867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ryanofsky I think it would be great if you could split out the cleanup parts into a self-contained PR and take them out of draft status to attract more serious review. To me, it's clear they would be a nice improvement on their own and they are addressing several comments in #27596. While that is in review you will probably have time to go back to figuring out the locking approach.",
      "created_at" : "2023-10-24T09:15:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1776829909",
      "id" : 1776829909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585p6EXV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776829909/reactions"
      },
      "updated_at" : "2023-10-24T09:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776829909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--13523179cfe9479db18ec6c5d236f789-->\r\nâ There hasn't been much activity lately and the patch still needs rebase. What is the status here?\r\n\r\n* Is it still relevant? â¡ï¸ Please solve the conflicts to make it ready for review and to ensure the CI passes.\r\n* Is it no longer relevant? â¡ï¸ Please close.\r\n* Did the author lose interest or time to work on this? â¡ï¸ Please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\r\n",
      "created_at" : "2024-01-17T12:51:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1895749350",
      "id" : 1895749350,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII585w_tbm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1895749350/reactions"
      },
      "updated_at" : "2024-01-17T12:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1895749350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not sure what the status here is? It would be good to rebase, so that reviewers can take a look, or close, so that it can be grabbed up, if there is need.",
      "created_at" : "2024-02-22T17:55:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1959970631",
      "id" : 1959970631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII58500sdH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959970631/reactions"
      },
      "updated_at" : "2024-02-22T17:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1959970631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Not sure what the status here is? It would be good to rebase, so that reviewers can take a look, or close, so that it can be grabbed up, if there is need.\r\n\r\nI've just been working on other things but I want to rebase this and split it up, probably next week I think. Of course if anyone wants to work on this or some smaller part of it, I'd welcome that and be very happy to help. ",
      "created_at" : "2024-02-22T19:54:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1960165787",
      "id" : 1960165787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII58501cGb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1960165787/reactions"
      },
      "updated_at" : "2024-02-22T19:54:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1960165787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/21916654389</sub>",
      "created_at" : "2024-02-23T17:04:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28608#issuecomment-1961687434",
      "id" : 1961687434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28608",
      "node_id" : "IC_kwDOABII58507PmK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1961687434/reactions"
      },
      "updated_at" : "2024-02-23T17:04:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1961687434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
