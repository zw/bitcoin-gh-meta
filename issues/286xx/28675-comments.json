[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "After digging deeper here I found something rather unpleasant. The behaviour is caused by a sneaky bug (introduced in #12737 / commit 34ca75032012562d226b06ef9e86a2948d3a8d16) in the serialized UTXO set hash calculation (`ApplyHash`), which doesn't commit to the height and coinbase information of coins due to missing parantheses:\r\nhttps://github.com/bitcoin/bitcoin/blob/655dc716aa6043613171a1338e22928de89a7d3e/src/kernel/coinstats.cpp#L77\r\n(=> this expression is always resulting in `ss << VARINT(1)` for nHeight > 0)\r\n\r\nThis needs to be fixed for AssumeUTXO, as otherwise modified snapshots where coin's heights / coinbase flags have been altered would obviously still be imported without error.\r\n\r\nThe fix in the hash calculation function is trivial, but the question is how to cope with `gettxoutset`s `hash_serialized_2` result. I guess we need to introduce another hash result type (e.g. `hash_serialized_3`, the bugfixed version of `hash_serialized_2`) and use that for AssumeUTXO, but still want to keep `hash_serialized_2` around for a while to avoid confusing users? Otherwise, it would be odd if the result on the same UTXO set is different on pre-v26 and v26+ nodes.",
      "created_at" : "2023-10-19T09:10:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28675#issuecomment-1770389468",
      "id" : 1770389468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28675",
      "node_id" : "IC_kwDOABII585phf_c",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770389468/reactions"
      },
      "updated_at" : "2023-10-19T09:10:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770389468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> around for a while to avoid confusing users? Otherwise, it would be odd if the result on the same UTXO set is different on pre-v26 and v26+ nodes.\r\n\r\nIt's not odd if the result from the previous version was incorrect. If it doesn't work, it should be fixed, and any broken version removed, especially if it's usage going forward would result in invalid assumeutxo usage.",
      "created_at" : "2023-10-19T09:23:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28675#issuecomment-1770413481",
      "id" : 1770413481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28675",
      "node_id" : "IC_kwDOABII585phl2p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770413481/reactions"
      },
      "updated_at" : "2023-10-19T09:23:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770413481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> If it doesn't work, it should be fixed\r\n\r\nI agree, I don't think there is any critical usage of `hash_serialized_2` currently (other than the future use of assumeutxo) and I have spent quite some time looking into this when I introduced coinstatsindex.\r\n\r\n",
      "created_at" : "2023-10-19T09:27:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28675#issuecomment-1770420450",
      "id" : 1770420450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28675",
      "node_id" : "IC_kwDOABII585phnji",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770420450/reactions"
      },
      "updated_at" : "2023-10-19T11:41:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770420450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Wow, good find @fjahr et al. I wonder if there's any value in committing to a sha256sum of the snapshot file itself in the source code as a belt-and-suspenders remediation for issues like this.",
      "created_at" : "2023-10-19T13:15:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28675#issuecomment-1770968572",
      "id" : 1770968572,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28675",
      "node_id" : "IC_kwDOABII585pjtX8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770968572/reactions"
      },
      "updated_at" : "2023-10-19T13:15:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1770968572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I wonder if there's any value in committing to a sha256sum of the snapshot file itself in the source code as a belt-and-suspenders remediation for issues like this.\r\n\r\nDefinitely worth thinking about but seems not as urgent as the utxo set hash and its probably fine to release 26.0 without this since we don't support mainnet use yet.\r\n\r\nThis is also a pretty wide design space as shown by the discussion in IRC today: https://bitcoin-irc.chaincode.com/bitcoin-core-dev/2023-10-19#976439; (primarily posting this answer to save a link to this discussion)\r\n\r\nMy takeaway from tha discssion: It may be beneficial to wait and see what kind of hash commitment will be optimal for a potential future p2p distribution of the utxo set. And I guess we have at least time with this until we release 27.0 with mainnet chain params.\r\n\r\n@jamesob maybe we should have a brainstorming issue for p2p distribution of the utxo set for assumeutxo and move this conversation there?",
      "created_at" : "2023-10-19T19:29:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28675#issuecomment-1771586226",
      "id" : 1771586226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28675",
      "node_id" : "IC_kwDOABII585pmEKy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771586226/reactions"
      },
      "updated_at" : "2023-10-19T19:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771586226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Actually #27669 is already there for this.",
      "created_at" : "2023-10-19T19:31:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28675#issuecomment-1771588604",
      "id" : 1771588604,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28675",
      "node_id" : "IC_kwDOABII585pmEv8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771588604/reactions"
      },
      "updated_at" : "2023-10-19T19:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771588604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
