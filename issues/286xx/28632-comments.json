[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28632).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [pablomartin4btc](https://github.com/bitcoin/bitcoin/pull/28632#pullrequestreview-1677321536), [pinheadmz](https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1769150415), [BrandonOdiwuor](https://github.com/bitcoin/bitcoin/pull/28632#pullrequestreview-1687312484) |\n| Concept ACK | [brunoerg](https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1756116233), [sipa](https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1762165630) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24748](https://github.com/bitcoin/bitcoin/pull/24748) (test/BIP324: functional tests for v2 P2P encryption by stratospher)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-10-10T17:09:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1755891200",
      "id" : 1755891200,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585oqMYA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1755891200/reactions"
      },
      "updated_at" : "2023-10-19T10:34:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1755891200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-10-10T19:44:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1756116233",
      "id" : 1756116233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585orDUJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1756116233/reactions"
      },
      "updated_at" : "2023-10-10T19:44:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1756116233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> * verify that there are no `getaddr` messages sent to inbound nodes\r\n\r\nGood idea, I added to commit to add this check to `p2p_addr_relay.py` (it's basically just an added assert)\r\n\r\n> * verify that filtering out `getaddr` messages when come from outbound nodes works (eg [Ignore getaddr messages on Outbound connections.Â #5442](https://github.com/bitcoin/bitcoin/pull/5442))\r\n\r\nThat is already verified in the \"Check that we answer getaddr messages only from inbound peers\" section of `p2p_addr_relay.py`",
      "created_at" : "2023-10-11T18:49:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1758306691",
      "id" : 1758306691,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585ozaGD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1758306691/reactions"
      },
      "updated_at" : "2023-10-11T18:49:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1758306691",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > * verify that there are no `getaddr` messages sent to inbound nodes\r\n> \r\n> Good idea, I added to commit to add this check to `p2p_addr_relay.py` (it's basically just an added assert)\r\n\r\nGreat, thanks and I appreciate including me as a co-author of that change, many thanks.\r\n\r\n> > * verify that filtering out `getaddr` messages when come from outbound nodes works (eg [Ignore getaddr messages on Outbound connections.Â #5442](https://github.com/bitcoin/bitcoin/pull/5442))\r\n> \r\n> That is already verified in the \"Check that we answer getaddr messages only from inbound peers\" section of `p2p_addr_relay.py`\r\n\r\nYeah, perhaps I'm wrong but what I meant is since we are not sending the `getaddr` anymore (eg to inbound peers) we are not really filtering them out (from outbound peers), so maybe we need to force this situation (`assert_equal(full_outbound_peer.getaddr_received(), True)`) to validate that we don't reply to them. Perhaps this is already happening at another level and I'm totally missing it, ignore me if that's the case.\r\n",
      "created_at" : "2023-10-13T17:31:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1761900250",
      "id" : 1761900250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585pBHba",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1761900250/reactions"
      },
      "updated_at" : "2023-10-13T17:31:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1761900250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/110166421?v=4",
         "events_url" : "https://api.github.com/users/pablomartin4btc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pablomartin4btc/followers",
         "following_url" : "https://api.github.com/users/pablomartin4btc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pablomartin4btc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pablomartin4btc",
         "id" : 110166421,
         "login" : "pablomartin4btc",
         "node_id" : "U_kgDOBpEBlQ",
         "organizations_url" : "https://api.github.com/users/pablomartin4btc/orgs",
         "received_events_url" : "https://api.github.com/users/pablomartin4btc/received_events",
         "repos_url" : "https://api.github.com/users/pablomartin4btc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pablomartin4btc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pablomartin4btc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pablomartin4btc"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Yeah, perhaps I'm wrong but what I meant is since we are not sending the `getaddr` anymore (eg to inbound peers) we are not really filtering them out (from outbound peers), so maybe we need to force this situation (`assert_equal(full_outbound_peer.getaddr_received(), True)`) to validate that we don't reply to them. Perhaps this is already happening at another level and I'm totally missing it, ignore me if that's the case.\r\n\r\nSorry, I don't follow, who is \"we\"?\r\nAfter this PR, the python p2p doesn't send `getaddr` to `bitcoind` anymore automatically if `bitcoind` connects to it.\r\nIn the existing test that I referred to, we test whether `getaddr` are ignored or not by instead sending the msg manually from pyhton p2p [here](https://github.com/bitcoin/bitcoin/blob/78b7e955185ab92de4e1b8b866a46d3113a5fdf5/test/functional/p2p_addr_relay.py#L289-L291) and then check [here](https://github.com/bitcoin/bitcoin/blob/78b7e955185ab92de4e1b8b866a46d3113a5fdf5/test/functional/p2p_addr_relay.py#L298-L300) whether bitcoind responded or ignored it.\r\n\r\n> `(assert_equal(full_outbound_peer.getaddr_received(), True))` \r\n\r\nThat is the other direction (python p2p receives `getaddr`, `bitcoind` sends it or not) and is checked [here](https://github.com/bitcoin/bitcoin/blob/78b7e955185ab92de4e1b8b866a46d3113a5fdf5/test/functional/p2p_addr_relay.py#L271).",
      "created_at" : "2023-10-13T20:19:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1762150477",
      "id" : 1762150477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585pCEhN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762150477/reactions"
      },
      "updated_at" : "2023-10-13T20:19:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762150477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2023-10-13T20:35:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1762165630",
      "id" : 1762165630,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585pCIN-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762165630/reactions"
      },
      "updated_at" : "2023-10-13T20:35:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762165630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Sorry, I don't follow, who is \"we\"?\r\n\r\nI meant with the changes made by this PR.\r\n\r\n>After this PR, the python p2p doesn't send `getaddr` to `bitcoind` anymore automatically if `bitcoind` connects to it. In the existing test that I referred to, we test whether `getaddr` are ignored or not by instead sending the msg manually from pyhton p2p [here](https://github.com/bitcoin/bitcoin/blob/78b7e955185ab92de4e1b8b866a46d3113a5fdf5/test/functional/p2p_addr_relay.py#L289-L291) and then check [here](https://github.com/bitcoin/bitcoin/blob/78b7e955185ab92de4e1b8b866a46d3113a5fdf5/test/functional/p2p_addr_relay.py#L298-L300) whether bitcoind responded or ignored it.\r\n\r\nPerfect, thank you very much for the clarification, I missed that.\r\n \r\n> > `(assert_equal(full_outbound_peer.getaddr_received(), True))`\r\n> \r\n> That is the other direction (python p2p receives `getaddr`, `bitcoind` sends it or not) and is checked [here](https://github.com/bitcoin/bitcoin/blob/78b7e955185ab92de4e1b8b866a46d3113a5fdf5/test/functional/p2p_addr_relay.py#L271).\r\n\r\nThanks again for the links, I got it now.\r\n",
      "created_at" : "2023-10-13T20:40:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1762170760",
      "id" : 1762170760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585pCJeI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762170760/reactions"
      },
      "updated_at" : "2023-10-13T20:40:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1762170760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/110166421?v=4",
         "events_url" : "https://api.github.com/users/pablomartin4btc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pablomartin4btc/followers",
         "following_url" : "https://api.github.com/users/pablomartin4btc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pablomartin4btc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pablomartin4btc",
         "id" : 110166421,
         "login" : "pablomartin4btc",
         "node_id" : "U_kgDOBpEBlQ",
         "organizations_url" : "https://api.github.com/users/pablomartin4btc/orgs",
         "received_events_url" : "https://api.github.com/users/pablomartin4btc/received_events",
         "repos_url" : "https://api.github.com/users/pablomartin4btc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pablomartin4btc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pablomartin4btc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pablomartin4btc"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "concept ACK 9cfc1c9440\r\n\r\nConfirmed the [in/outbound asymmetry for sending and responding to `getaddr` messages](https://github.com/bitcoin/bitcoin/blob/655dc716aa6043613171a1338e22928de89a7d3e/src/net_processing.cpp#L3509-L3528)\r\n\r\nI wonder if it'd be cleaner to initialize `Class P2PConnection` with property `self.outbound = True` and then you only have to switch it to `False` in `TestNode.add_outbound_p2p_connection()` (which is outbound from bitcoin core but the P2PConnection perspective is inbound)",
      "created_at" : "2023-10-18T19:04:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28632#issuecomment-1769150415",
      "id" : 1769150415,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28632",
      "node_id" : "IC_kwDOABII585pcxfP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1769150415/reactions"
      },
      "updated_at" : "2023-10-18T19:04:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1769150415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   }
]
