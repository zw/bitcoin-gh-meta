[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28609).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/28609#pullrequestreview-1683337072), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/28609#pullrequestreview-1688333965) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28610](https://github.com/bitcoin/bitcoin/pull/28610) (wallet: Migrate entire address book entries to watchonly and solvables too by achow101)\n* [#28546](https://github.com/bitcoin/bitcoin/pull/28546) (bugfix: watchonly wallets created after migration have incorrect height values by ryanofsky)\n* [#28264](https://github.com/bitcoin/bitcoin/pull/28264) (test: refactor: support sending funds with outpoint result by theStack)\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n* [#26596](https://github.com/bitcoin/bitcoin/pull/26596) (wallet: Migrate legacy wallets to descriptor wallets without requiring BDB by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-10-06T22:37:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#issuecomment-1751471816",
      "id" : 1751471816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28609",
      "node_id" : "IC_kwDOABII585oZVbI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751471816/reactions"
      },
      "updated_at" : "2023-10-19T22:04:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751471816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350342749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350342749"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d73ecbd2d8:\r\n\r\nWhat is we use `LoadToWallet()` instead?. It will also set `m_it_wtxOrdered`, which is not set atm. And also update the state if needed.\r\nSomething like:\r\n```c++\r\n// Add to watchonly wallet\r\nconst uint256& hash = wtx->GetHash();\r\nconst CWalletTx& to_copy_wtx = *wtx;\r\nif (!data.watchonly_wallet->LoadToWallet(hash, [&](CWalletTx& ins_wtx, bool new_tx) EXCLUSIVE_LOCKS_REQUIRED(data.watchonly_wallet->cs_wallet) {\r\n    if (!new_tx) return false;\r\n    ins_wtx.SetTx(to_copy_wtx.tx);\r\n    ins_wtx.CloneFrom(to_copy_wtx);\r\n    ins_wtx.nOrderPos = data.watchonly_wallet->IncOrderPosNext(watchonly_batch.get());\r\n    return true;\r\n})) {\r\n    error = strprintf(_(\"Error: Could not add watchonly tx %s to watchonly wallet\"), wtx->GetHash().GetHex());\r\n    return false;\r\n}\r\nwatchonly_batch->WriteTx(data.watchonly_wallet->mapWallet.at(hash));\r\n// Mark as to remove from this wallet\r\ntxids_to_delete.push_back(hash);\r\ncontinue;\r\n```",
      "commit_id" : "1fe21d2bde12db18376eb31617b603a9f9043c46",
      "created_at" : "2023-10-09T13:54:05Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());\n+                    data.watchonly_wallet->AddToSpends(ins_wtx);\n+                    watchonly_batch->WriteTx(ins_wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350342749",
      "id" : 1350342749,
      "line" : 3933,
      "node_id" : "PRRC_kwDOABII585QfJhd",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3933,
      "original_position" : 26,
      "original_start_line" : 3923,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 1664508703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350342749/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3923,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-09T15:05:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350342749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350400835"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350400835"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d73ecbd2:\r\n\r\nBug here, `IncOrderPosNext()` is a wallet method. So, the main wallet order pos is being increased, instead of the watch-only wallet one. Need to be:\r\n```\r\ndata.watchonly_wallet->IncOrderPosNext(watchonly_batch.get())\r\n``` ",
      "commit_id" : "1fe21d2bde12db18376eb31617b603a9f9043c46",
      "created_at" : "2023-10-09T14:41:10Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350400835",
      "id" : 1350400835,
      "line" : 3931,
      "node_id" : "PRRC_kwDOABII585QfXtD",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3931,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 24,
      "pull_request_review_id" : 1664629851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350400835/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-09T14:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350400835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350415419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350415419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d73ecbd2d:\r\n\r\nnit: the 'tx' naming shadows the `CWalletTx::tx` member. Maybe call it `_tx`.",
      "commit_id" : "1fe21d2bde12db18376eb31617b603a9f9043c46",
      "created_at" : "2023-10-09T14:53:18Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& tx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350415419",
      "id" : 1350415419,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585QfbQ7",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.cpp",
      "position" : 5,
      "pull_request_review_id" : 1664667766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350415419/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-09T15:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350415419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350447031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350447031"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d550863e5:\r\n\r\nAs `LoadWallet()` can return a nullptr if loading fails. Would be good to cover this possibility too.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-09T15:18:51Z",
      "diff_hunk" : "@@ -4228,11 +4244,23 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     }\n \n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n+        if (res.watchonly_wallet) {\n+            assert(res.watchonly_wallet.use_count() == 1);\n+            std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+            res.watchonly_wallet.reset();\n+            res.watchonly_wallet = LoadWallet(context, watchonly_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }\n+        if (res.solvables_wallet) {\n+            assert(res.solvables_wallet.use_count() == 1);\n+            std::string solvables_wallet_name = res.solvables_wallet->GetName();\n+            res.solvables_wallet.reset();\n+            res.solvables_wallet = LoadWallet(context, solvables_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350447031",
      "id" : 1350447031,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qfi-3",
      "original_commit_id" : "d550863e5bbe097534d8cefb0f5afd63ad19a253",
      "original_line" : 4263,
      "original_position" : 66,
      "original_start_line" : 4252,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1664667766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350447031/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-09T22:50:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350447031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353164664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353164664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:52:48Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());\n+                    data.watchonly_wallet->AddToSpends(ins_wtx);\n+                    watchonly_batch->WriteTx(ins_wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353164664",
      "id" : 1353164664,
      "in_reply_to_id" : 1350342749,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6d4",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3933,
      "original_position" : 26,
      "original_start_line" : 3923,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1668642881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353164664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353164664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:52:53Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165036",
      "id" : 1353165036,
      "in_reply_to_id" : 1350400835,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6js",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3931,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1668643329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:52:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165362"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:52:57Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& tx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165362",
      "id" : 1353165362,
      "in_reply_to_id" : 1350415419,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6oy",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.cpp",
      "position" : null,
      "pull_request_review_id" : 1668643805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165362/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:52:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353166779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353166779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added handling to cleanup when reloading fails.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:53:16Z",
      "diff_hunk" : "@@ -4228,11 +4244,23 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     }\n \n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n+        if (res.watchonly_wallet) {\n+            assert(res.watchonly_wallet.use_count() == 1);\n+            std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+            res.watchonly_wallet.reset();\n+            res.watchonly_wallet = LoadWallet(context, watchonly_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }\n+        if (res.solvables_wallet) {\n+            assert(res.solvables_wallet.use_count() == 1);\n+            std::string solvables_wallet_name = res.solvables_wallet->GetName();\n+            res.solvables_wallet.reset();\n+            res.solvables_wallet = LoadWallet(context, solvables_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353166779",
      "id" : 1353166779,
      "in_reply_to_id" : 1350447031,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6-7",
      "original_commit_id" : "d550863e5bbe097534d8cefb0f5afd63ad19a253",
      "original_line" : 4263,
      "original_position" : 66,
      "original_start_line" : 4252,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1668645595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353166779/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:53:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353166779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-11T11:48:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#issuecomment-1757514952",
      "id" : 1757514952,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28609",
      "node_id" : "IC_kwDOABII585owYzI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1757514952/reactions"
      },
      "updated_at" : "2023-10-11T11:48:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1757514952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1355681399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355681399"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 4ccec8b371:\r\n\r\nDoesn't make much sense to copy `nOrderPos`. The field is strictly connected to the parent wallet. Depending on what the wallet is watching, the tx order position could be higher or lower.",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-11T19:39:45Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& _tx)\n+{\n+    mapValue = _tx.mapValue;\n+    vOrderForm = _tx.vOrderForm;\n+    fTimeReceivedIsTxTime = _tx.fTimeReceivedIsTxTime;\n+    nTimeReceived = _tx.nTimeReceived;\n+    nTimeSmart = _tx.nTimeSmart;\n+    fFromMe = _tx.fFromMe;\n+    nOrderPos = _tx.nOrderPos;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1355681399",
      "id" : 1355681399,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII585Qzg53",
      "original_commit_id" : "4ccec8b3710bf040dd890965adfcb5d0b9ee52ca",
      "original_line" : 36,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.cpp",
      "position" : 13,
      "pull_request_review_id" : 1672403679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355681399/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-11T20:02:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355681399",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1355698012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355698012"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In https://github.com/bitcoin/bitcoin/commit/6eb3df7c0bbbad0873f5600d3869ac33bad6ed5e:\r\n\r\nWhy this line?. Isn't the local wallet datadir added at line 4282?",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-11T19:54:03Z",
      "diff_hunk" : "@@ -4229,21 +4245,41 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n+        wallet_dirs.insert(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1355698012",
      "id" : 1355698012,
      "line" : 4253,
      "node_id" : "PRRC_kwDOABII585Qzk9c",
      "original_commit_id" : "6eb3df7c0bbbad0873f5600d3869ac33bad6ed5e",
      "original_line" : 4253,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 91,
      "pull_request_review_id" : 1672403679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355698012/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-11T20:02:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355698012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1355705822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355705822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In https://github.com/bitcoin/bitcoin/commit/6eb3df7c0bbbad0873f5600d3869ac33bad6ed5e:\r\n\r\nWhy this line?. The watch-only wallet datadir is added at line 4295.\r\nSame for the solvable one.",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-11T20:00:16Z",
      "diff_hunk" : "@@ -4229,21 +4245,41 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n+        wallet_dirs.insert(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n-    } else {\n+        success = res.wallet != nullptr;\n+    }\n+    if (success && res.watchonly_wallet) {\n+        assert(res.watchonly_wallet.use_count() == 1);\n+        std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+        wallet_dirs.insert(fs::PathFromString(res.watchonly_wallet->GetDatabase().Filename()).parent_path());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1355705822",
      "id" : 1355705822,
      "line" : 4262,
      "node_id" : "PRRC_kwDOABII585Qzm3e",
      "original_commit_id" : "6eb3df7c0bbbad0873f5600d3869ac33bad6ed5e",
      "original_line" : 4262,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 101,
      "pull_request_review_id" : 1672403679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355705822/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-11T20:02:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1355705822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361103892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361103892"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd prefer to keep this function generic so it should copy everything even if we will overwrite stuff in actual usage.",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-16T18:18:04Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& _tx)\n+{\n+    mapValue = _tx.mapValue;\n+    vOrderForm = _tx.vOrderForm;\n+    fTimeReceivedIsTxTime = _tx.fTimeReceivedIsTxTime;\n+    nTimeReceived = _tx.nTimeReceived;\n+    nTimeSmart = _tx.nTimeSmart;\n+    fFromMe = _tx.fFromMe;\n+    nOrderPos = _tx.nOrderPos;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361103892",
      "id" : 1361103892,
      "in_reply_to_id" : 1355681399,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII585RIMwU",
      "original_commit_id" : "4ccec8b3710bf040dd890965adfcb5d0b9ee52ca",
      "original_line" : 36,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.cpp",
      "position" : 13,
      "pull_request_review_id" : 1680699292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361103892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T18:18:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361103892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361172812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361172812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In case the wallet fails to reload, we can still cleanup at the end.",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-16T19:23:04Z",
      "diff_hunk" : "@@ -4229,21 +4245,41 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n+        wallet_dirs.insert(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361172812",
      "id" : 1361172812,
      "in_reply_to_id" : 1355698012,
      "line" : 4253,
      "node_id" : "PRRC_kwDOABII585RIdlM",
      "original_commit_id" : "6eb3df7c0bbbad0873f5600d3869ac33bad6ed5e",
      "original_line" : 4253,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 91,
      "pull_request_review_id" : 1680807877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361172812/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T19:23:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361172812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361173154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361173154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the wallet fails to reload, we can still know to clean it up.",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-16T19:23:25Z",
      "diff_hunk" : "@@ -4229,21 +4245,41 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n+        wallet_dirs.insert(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n-    } else {\n+        success = res.wallet != nullptr;\n+    }\n+    if (success && res.watchonly_wallet) {\n+        assert(res.watchonly_wallet.use_count() == 1);\n+        std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+        wallet_dirs.insert(fs::PathFromString(res.watchonly_wallet->GetDatabase().Filename()).parent_path());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361173154",
      "id" : 1361173154,
      "in_reply_to_id" : 1355705822,
      "line" : 4262,
      "node_id" : "PRRC_kwDOABII585RIdqi",
      "original_commit_id" : "6eb3df7c0bbbad0873f5600d3869ac33bad6ed5e",
      "original_line" : 4262,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 101,
      "pull_request_review_id" : 1680808415,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361173154/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T19:23:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361173154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361463467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361463467"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```diff\r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\n--- a/src/wallet/wallet.cpp\t(revision 014231c3fd7bc479784cb187560d417118000e61)\r\n+++ b/src/wallet/wallet.cpp\t(date 1697512277377)\r\n@@ -4249,28 +4249,27 @@\r\n     std::set<fs::path> wallet_dirs;\r\n     if (success) {\r\n         // Migration successful, unload all wallets locally, then reload them.\r\n-        assert(local_wallet.use_count() == 1);\r\n-        wallet_dirs.insert(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());\r\n-        local_wallet.reset();\r\n-        res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\r\n+        const auto& reload_wallet = [&](std::shared_ptr<CWallet>& to_reload) {\r\n+            assert(to_reload.use_count() == 1);\r\n+            std::string name = to_reload->GetName();\r\n+            wallet_dirs.insert(fs::PathFromString(to_reload->GetDatabase().Filename()).parent_path());\r\n+            to_reload.reset();\r\n+            to_reload = LoadWallet(context, name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\r\n+            return to_reload != nullptr;\r\n+        };\r\n+        \r\n+        // Reload main wallet\r\n+        success = reload_wallet(local_wallet);\r\n+        res.wallet = local_wallet;\r\n         res.wallet_name = wallet_name;\r\n-        success = res.wallet != nullptr;\r\n-    }\r\n-    if (success && res.watchonly_wallet) {\r\n-        assert(res.watchonly_wallet.use_count() == 1);\r\n-        std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\r\n-        wallet_dirs.insert(fs::PathFromString(res.watchonly_wallet->GetDatabase().Filename()).parent_path());\r\n-        res.watchonly_wallet.reset();\r\n-        res.watchonly_wallet = LoadWallet(context, watchonly_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\r\n-        success = res.watchonly_wallet != nullptr;\r\n-    }\r\n-    if (success && res.solvables_wallet) {\r\n-        assert(res.solvables_wallet.use_count() == 1);\r\n-        std::string solvables_wallet_name = res.solvables_wallet->GetName();\r\n-        wallet_dirs.insert(fs::PathFromString(res.solvables_wallet->GetDatabase().Filename()).parent_path());\r\n-        res.solvables_wallet.reset();\r\n-        res.solvables_wallet = LoadWallet(context, solvables_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\r\n-        success = res.solvables_wallet != nullptr;\r\n+        // Reload watch-only wallet\r\n+        if (success && res.watchonly_wallet) {\r\n+            success = reload_wallet(res.watchonly_wallet);\r\n+        }\r\n+        // Reload solvables wallet\r\n+        if (success && res.solvables_wallet) {\r\n+            success = reload_wallet(res.solvables_wallet);\r\n+        }\r\n     }\r\n     if (!success) {\r\n         // Migration failed, cleanup\r\n```",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-17T03:17:03Z",
      "diff_hunk" : "@@ -4229,47 +4245,68 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n+        wallet_dirs.insert(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n-    } else {\n+        success = res.wallet != nullptr;\n+    }\n+    if (success && res.watchonly_wallet) {\n+        assert(res.watchonly_wallet.use_count() == 1);\n+        std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+        wallet_dirs.insert(fs::PathFromString(res.watchonly_wallet->GetDatabase().Filename()).parent_path());\n+        res.watchonly_wallet.reset();\n+        res.watchonly_wallet = LoadWallet(context, watchonly_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        success = res.watchonly_wallet != nullptr;\n+    }\n+    if (success && res.solvables_wallet) {\n+        assert(res.solvables_wallet.use_count() == 1);\n+        std::string solvables_wallet_name = res.solvables_wallet->GetName();\n+        wallet_dirs.insert(fs::PathFromString(res.solvables_wallet->GetDatabase().Filename()).parent_path());\n+        res.solvables_wallet.reset();\n+        res.solvables_wallet = LoadWallet(context, solvables_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        success = res.solvables_wallet != nullptr;\n+    }\n+    if (!success) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1361463467",
      "id" : 1361463467,
      "line" : 4275,
      "node_id" : "PRRC_kwDOABII585RJkir",
      "original_commit_id" : "177902519a4ba9ddc545d3e7df6a5f516e45a775",
      "original_line" : 4275,
      "original_position" : 78,
      "original_start_line" : 4248,
      "path" : "src/wallet/wallet.cpp",
      "position" : 114,
      "pull_request_review_id" : 1681294991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361463467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4248,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T13:56:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361463467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\ntest/functional/wallet_migration.py:863:15: E275 missing whitespace after keyword\r\ntest/functional/wallet_migration.py:864:15: E275 missing whitespace after keyword\r\ntest/functional/wallet_migration.py:865:15: E275 missing whitespace after keyword\r\ntest/functional/wallet_migration.py:867:15: E275 missing whitespace after keyword\r\ntest/functional/wallet_migration.py:869:15: E275 missing whitespace after keyword",
      "created_at" : "2023-10-17T07:48:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#issuecomment-1765859341",
      "id" : 1765859341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28609",
      "node_id" : "IC_kwDOABII585pQOAN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765859341/reactions"
      },
      "updated_at" : "2023-10-17T07:48:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765859341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1362140599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362140599"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In bdc828cfa0c:\r\n\r\nnit:\r\nI'm assuming this checks if the database is still bdb. Which, if that's the case, a comment indicating it wouldn't hurt.\r\nHowever, isn't the checksum validation performed earlier already covering this scenario?",
      "commit_id" : "014231c3fd7bc479784cb187560d417118000e61",
      "created_at" : "2023-10-17T13:42:58Z",
      "diff_hunk" : "@@ -827,6 +831,42 @@ def test_hybrid_pubkey(self):\n \n         wallet.unloadwallet()\n \n+    def test_failed_migration_cleanup(self):\n+        self.log.info(\"Test that a failed migration is cleaned up\")\n+        wallet = self.create_legacy_wallet(\"failed\")\n+\n+        # Make a copy of the wallet with the solvables wallet name so that we are unable\n+        # to create the solvables wallet when migrating, thus failing to migrate\n+        wallet.unloadwallet()\n+        solvables_path = self.nodes[0].wallets_path / \"failed_solvables\"\n+        shutil.copytree(self.nodes[0].wallets_path / \"failed\", solvables_path)\n+        original_shasum = sha256sum_file(solvables_path / \"wallet.dat\")\n+\n+        self.nodes[0].loadwallet(\"failed\")\n+\n+        # Add a multisig so that a solvables wallet is created\n+        wallet.addmultisigaddress(2, [wallet.getnewaddress(), get_generate_key().pubkey])\n+        wallet.importaddress(get_generate_key().p2pkh_addr)\n+\n+        assert_raises_rpc_error(-4, \"Failed to create new watchonly wallet\", wallet.migratewallet)\n+\n+        assert(\"failed\" in self.nodes[0].listwallets())\n+        assert(\"failed_watchonly\" not in self.nodes[0].listwallets())\n+        assert(\"failed_solvables\" not in self.nodes[0].listwallets())\n+\n+        assert(not (self.nodes[0].wallets_path / \"failed_watchonly\").exists())\n+        # Since the file in failed_solvables is one that we put there, migration shouldn't touch it\n+        assert(solvables_path.exists())\n+        new_shasum = sha256sum_file(solvables_path / \"wallet.dat\")\n+        assert_equal(original_shasum, new_shasum)\n+\n+        wallet.unloadwallet()\n+        with open(self.nodes[0].wallets_path / \"failed\" / \"wallet.dat\", \"rb\") as f:\n+            data = f.read(16)\n+            _, _, magic = struct.unpack(\"QII\", data)\n+            assert_equal(magic, BTREE_MAGIC)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1362140599",
      "id" : 1362140599,
      "line" : 877,
      "node_id" : "PRRC_kwDOABII585RMJ23",
      "original_commit_id" : "bdc828cfa0cabf3ed714fbef2ff0010785f8b4cc",
      "original_line" : 867,
      "original_position" : 60,
      "original_start_line" : 864,
      "path" : "test/functional/wallet_migration.py",
      "position" : 94,
      "pull_request_review_id" : 1681294991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362140599/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 874,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T13:56:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362140599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1362518958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362518958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "13dd5e5dab62cb4c2e412d4f0e68a8e1b6c0d8e5",
      "created_at" : "2023-10-17T17:32:13Z",
      "diff_hunk" : "@@ -4229,47 +4245,68 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n+        wallet_dirs.insert(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n-    } else {\n+        success = res.wallet != nullptr;\n+    }\n+    if (success && res.watchonly_wallet) {\n+        assert(res.watchonly_wallet.use_count() == 1);\n+        std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+        wallet_dirs.insert(fs::PathFromString(res.watchonly_wallet->GetDatabase().Filename()).parent_path());\n+        res.watchonly_wallet.reset();\n+        res.watchonly_wallet = LoadWallet(context, watchonly_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        success = res.watchonly_wallet != nullptr;\n+    }\n+    if (success && res.solvables_wallet) {\n+        assert(res.solvables_wallet.use_count() == 1);\n+        std::string solvables_wallet_name = res.solvables_wallet->GetName();\n+        wallet_dirs.insert(fs::PathFromString(res.solvables_wallet->GetDatabase().Filename()).parent_path());\n+        res.solvables_wallet.reset();\n+        res.solvables_wallet = LoadWallet(context, solvables_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        success = res.solvables_wallet != nullptr;\n+    }\n+    if (!success) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1362518958",
      "id" : 1362518958,
      "in_reply_to_id" : 1361463467,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RNmOu",
      "original_commit_id" : "177902519a4ba9ddc545d3e7df6a5f516e45a775",
      "original_line" : 4273,
      "original_position" : 78,
      "original_start_line" : 4248,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1682978771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362518958/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T17:32:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362518958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1362519485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362519485"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment. This is a check for the original wallet, not the solvables wallet which the checksum covers.",
      "commit_id" : "13dd5e5dab62cb4c2e412d4f0e68a8e1b6c0d8e5",
      "created_at" : "2023-10-17T17:32:46Z",
      "diff_hunk" : "@@ -827,6 +831,42 @@ def test_hybrid_pubkey(self):\n \n         wallet.unloadwallet()\n \n+    def test_failed_migration_cleanup(self):\n+        self.log.info(\"Test that a failed migration is cleaned up\")\n+        wallet = self.create_legacy_wallet(\"failed\")\n+\n+        # Make a copy of the wallet with the solvables wallet name so that we are unable\n+        # to create the solvables wallet when migrating, thus failing to migrate\n+        wallet.unloadwallet()\n+        solvables_path = self.nodes[0].wallets_path / \"failed_solvables\"\n+        shutil.copytree(self.nodes[0].wallets_path / \"failed\", solvables_path)\n+        original_shasum = sha256sum_file(solvables_path / \"wallet.dat\")\n+\n+        self.nodes[0].loadwallet(\"failed\")\n+\n+        # Add a multisig so that a solvables wallet is created\n+        wallet.addmultisigaddress(2, [wallet.getnewaddress(), get_generate_key().pubkey])\n+        wallet.importaddress(get_generate_key().p2pkh_addr)\n+\n+        assert_raises_rpc_error(-4, \"Failed to create new watchonly wallet\", wallet.migratewallet)\n+\n+        assert(\"failed\" in self.nodes[0].listwallets())\n+        assert(\"failed_watchonly\" not in self.nodes[0].listwallets())\n+        assert(\"failed_solvables\" not in self.nodes[0].listwallets())\n+\n+        assert(not (self.nodes[0].wallets_path / \"failed_watchonly\").exists())\n+        # Since the file in failed_solvables is one that we put there, migration shouldn't touch it\n+        assert(solvables_path.exists())\n+        new_shasum = sha256sum_file(solvables_path / \"wallet.dat\")\n+        assert_equal(original_shasum, new_shasum)\n+\n+        wallet.unloadwallet()\n+        with open(self.nodes[0].wallets_path / \"failed\" / \"wallet.dat\", \"rb\") as f:\n+            data = f.read(16)\n+            _, _, magic = struct.unpack(\"QII\", data)\n+            assert_equal(magic, BTREE_MAGIC)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1362519485",
      "id" : 1362519485,
      "in_reply_to_id" : 1362140599,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585RNmW9",
      "original_commit_id" : "bdc828cfa0cabf3ed714fbef2ff0010785f8b4cc",
      "original_line" : 878,
      "original_position" : 60,
      "original_start_line" : 864,
      "path" : "test/functional/wallet_migration.py",
      "position" : 95,
      "pull_request_review_id" : 1682979622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362519485/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 875,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T17:32:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362519485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1365913915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365913915"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: Copy all tx metadata to watchonly wallet\" (cc4fa13bcfa0102ab6366f67a275f583baa0e6ff)\r\n\r\nI don't think this needs to manually copy each class member. It should just possible to make the copy constructor private instead of deleted, and have the public `CloneFrom` function just do `*this = tx`.\r\n\r\nWould also suggest renaming CloneFrom to CopyFrom. AFAIK clone is rust term for what c++ calls copying.\r\n\r\n(This also is a potential use-case for a DISABLE_IMPLICIT_COPIES macro suggested https://github.com/bitcoin/bitcoin/pull/24641#issuecomment-1075490057 which would automatically generate Copy and CopyFrom methods)",
      "commit_id" : "e2dfe76220fba0c8090605946187701a4397a758",
      "created_at" : "2023-10-19T17:50:24Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& _tx)\n+{\n+    mapValue = _tx.mapValue;\n+    vOrderForm = _tx.vOrderForm;\n+    fTimeReceivedIsTxTime = _tx.fTimeReceivedIsTxTime;\n+    nTimeReceived = _tx.nTimeReceived;\n+    nTimeSmart = _tx.nTimeSmart;\n+    fFromMe = _tx.fFromMe;\n+    nOrderPos = _tx.nOrderPos;\n+    m_state = _tx.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1365913915",
      "id" : 1365913915,
      "line" : 37,
      "node_id" : "PRRC_kwDOABII585RajE7",
      "original_commit_id" : "cc4fa13bcfa0102ab6366f67a275f583baa0e6ff",
      "original_line" : 37,
      "original_position" : 14,
      "original_start_line" : 28,
      "path" : "src/wallet/transaction.cpp",
      "position" : 14,
      "pull_request_review_id" : 1688333965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365913915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 28,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-19T21:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365913915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1365926217"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365926217"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: Copy all tx metadata to watchonly wallet\" (cc4fa13bcfa0102ab6366f67a275f583baa0e6ff)\r\n\r\nCan you add a comment explaining this line? Is it just done just to avoid gaps in numbers? Is it necessary?\r\n\r\nAlso, it seems like writing the updating the ORDERPOSTNEXT field each time a transaction is copied is potentially slow, and it might be better just to copy the existing ORDERPOSTNEXT value directly from the old wallet to the new wallet once.",
      "commit_id" : "e2dfe76220fba0c8090605946187701a4397a758",
      "created_at" : "2023-10-19T18:02:16Z",
      "diff_hunk" : "@@ -3916,12 +3920,21 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n-                        error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n+                    const uint256& hash = wtx->GetHash();\n+                    const CWalletTx& to_copy_wtx = *wtx;\n+                    if (!data.watchonly_wallet->LoadToWallet(hash, [&](CWalletTx& ins_wtx, bool new_tx) EXCLUSIVE_LOCKS_REQUIRED(data.watchonly_wallet->cs_wallet) {\n+                        if (!new_tx) return false;\n+                        ins_wtx.SetTx(to_copy_wtx.tx);\n+                        ins_wtx.CloneFrom(to_copy_wtx);\n+                        ins_wtx.nOrderPos = data.watchonly_wallet->IncOrderPosNext(watchonly_batch.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1365926217",
      "id" : 1365926217,
      "line" : 3929,
      "node_id" : "PRRC_kwDOABII585RamFJ",
      "original_commit_id" : "cc4fa13bcfa0102ab6366f67a275f583baa0e6ff",
      "original_line" : 3929,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 23,
      "pull_request_review_id" : 1688333965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365926217/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T21:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365926217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1365929404"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365929404"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: Copy all tx metadata to watchonly wallet\" (cc4fa13bcfa0102ab6366f67a275f583baa0e6ff)\r\n\r\nMay be helpful to have a code comment saying that LoadToWallet is called instead of AddToWallet in order to preserve CWalletTx metadata. \r\n\r\nThe code looked simpler with AddToWallet so you wonder why it is jumping though all these hoops.",
      "commit_id" : "e2dfe76220fba0c8090605946187701a4397a758",
      "created_at" : "2023-10-19T18:05:41Z",
      "diff_hunk" : "@@ -3916,12 +3920,21 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n-                        error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n+                    const uint256& hash = wtx->GetHash();\n+                    const CWalletTx& to_copy_wtx = *wtx;\n+                    if (!data.watchonly_wallet->LoadToWallet(hash, [&](CWalletTx& ins_wtx, bool new_tx) EXCLUSIVE_LOCKS_REQUIRED(data.watchonly_wallet->cs_wallet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1365929404",
      "id" : 1365929404,
      "line" : 3925,
      "node_id" : "PRRC_kwDOABII585Ram28",
      "original_commit_id" : "cc4fa13bcfa0102ab6366f67a275f583baa0e6ff",
      "original_line" : 3925,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 1688333965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365929404/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T21:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1365929404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366058051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366058051"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: Reload watchonly and solvables wallets after migration\" (b57218e4f4543619822c16d54881104ae15a9190)\r\n\r\nJust a thought, not for this PR, but maybe it would be good to load the new wallet on startup if the previous wallet loaded on startup.\r\n\r\nAlso it would be good to improve error reporting here. It seems like errors/warnings just get discarded which might make problems hard to debug. Though I guess we don't expect failure loading a newly creating wallet.",
      "commit_id" : "e2dfe76220fba0c8090605946187701a4397a758",
      "created_at" : "2023-10-19T20:14:54Z",
      "diff_hunk" : "@@ -4229,47 +4245,66 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n-        assert(local_wallet.use_count() == 1);\n-        local_wallet.reset();\n-        res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        // Migration successful, unload all wallets locally, then reload them.\n+        const auto& reload_wallet = [&](std::shared_ptr<CWallet>& to_reload) {\n+            assert(to_reload.use_count() == 1);\n+            std::string name = to_reload->GetName();\n+            wallet_dirs.insert(fs::PathFromString(to_reload->GetDatabase().Filename()).parent_path());\n+            to_reload.reset();\n+            to_reload = LoadWallet(context, name, /*load_on_start=*/std::nullopt, options, status, error, warnings);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366058051",
      "id" : 1366058051,
      "line" : 4257,
      "node_id" : "PRRC_kwDOABII585RbGRD",
      "original_commit_id" : "b57218e4f4543619822c16d54881104ae15a9190",
      "original_line" : 4257,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 98,
      "pull_request_review_id" : 1688333965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366058051/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T21:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366058051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366071084"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366071084"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: Reload watchonly and solvables wallets after migration\" (b57218e4f4543619822c16d54881104ae15a9190)\r\n\r\nNot clear on why the vector is changing to a set here. Is it because duplicate directories might be added so using a set is needed to prevent the same directories from being deleted twice? It seems fine to use a set, but if there's a reason a set needs to be used it would be helpful if that could be mentioned / explained in a comment.\r\n\r\nEDIT: Would suggest \"// Set is used instead of a vector because it is populated with the same wallets twice, both before and after reloading. This ensures the set is complete even if one of the wallets fails to reload.\"",
      "commit_id" : "e2dfe76220fba0c8090605946187701a4397a758",
      "created_at" : "2023-10-19T20:21:38Z",
      "diff_hunk" : "@@ -4229,47 +4245,66 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366071084",
      "id" : 1366071084,
      "line" : 4249,
      "node_id" : "PRRC_kwDOABII585RbJcs",
      "original_commit_id" : "b57218e4f4543619822c16d54881104ae15a9190",
      "original_line" : 4249,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 86,
      "pull_request_review_id" : 1688333965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366071084/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T21:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366071084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366093574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366093574"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: Reload watchonly and solvables wallets after migration\" (b57218e4f4543619822c16d54881104ae15a9190)\r\n\r\nNot directly related to this PR, but this remove_all seems not great because if there were any non-wallet files in the wallet directory they will be recursively removed. I think it would be preferable to only delete files that we know about and leave files that we do not recognize alone.\r\n\r\nThis would also avoid the need to copy the backup file from the wallet directory to the wallet parent directory, and then copy it back in again when the wallet directory is recreated.\r\n\r\nA lot of this logic seems pretty fragile and possible to simplify (Maybe furszy already has a PR to do it?)",
      "commit_id" : "e2dfe76220fba0c8090605946187701a4397a758",
      "created_at" : "2023-10-19T20:46:49Z",
      "diff_hunk" : "@@ -4229,47 +4245,66 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n-        assert(local_wallet.use_count() == 1);\n-        local_wallet.reset();\n-        res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        // Migration successful, unload all wallets locally, then reload them.\n+        const auto& reload_wallet = [&](std::shared_ptr<CWallet>& to_reload) {\n+            assert(to_reload.use_count() == 1);\n+            std::string name = to_reload->GetName();\n+            wallet_dirs.insert(fs::PathFromString(to_reload->GetDatabase().Filename()).parent_path());\n+            to_reload.reset();\n+            to_reload = LoadWallet(context, name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+            return to_reload != nullptr;\n+        };\n+        // Reload the main wallet\n+        success = reload_wallet(local_wallet);\n+        res.wallet = local_wallet;\n         res.wallet_name = wallet_name;\n-    } else {\n+        if (success && res.watchonly_wallet) {\n+            // Reload watchonly\n+            success = reload_wallet(res.watchonly_wallet);\n+        }\n+        if (success && res.solvables_wallet) {\n+            // Reload solvables\n+            success = reload_wallet(res.solvables_wallet);\n+        }\n+    }\n+    if (!success) {\n         // Migration failed, cleanup\n         // Copy the backup to the actual wallet dir\n         fs::path temp_backup_location = fsbridge::AbsPathJoin(GetWalletDir(), backup_filename);\n         fs::copy_file(backup_path, temp_backup_location, fs::copy_options::none);\n \n-        // Remember this wallet's walletdir to remove after unloading\n-        std::vector<fs::path> wallet_dirs;\n-        wallet_dirs.emplace_back(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());\n-\n-        // Unload the wallet locally\n-        assert(local_wallet.use_count() == 1);\n-        local_wallet.reset();\n-\n         // Make list of wallets to cleanup\n         std::vector<std::shared_ptr<CWallet>> created_wallets;\n+        if (local_wallet) created_wallets.push_back(std::move(local_wallet));\n         if (res.watchonly_wallet) created_wallets.push_back(std::move(res.watchonly_wallet));\n         if (res.solvables_wallet) created_wallets.push_back(std::move(res.solvables_wallet));\n \n         // Get the directories to remove after unloading\n         for (std::shared_ptr<CWallet>& w : created_wallets) {\n-            wallet_dirs.emplace_back(fs::PathFromString(w->GetDatabase().Filename()).parent_path());\n+            wallet_dirs.emplace(fs::PathFromString(w->GetDatabase().Filename()).parent_path());\n         }\n \n         // Unload the wallets\n         for (std::shared_ptr<CWallet>& w : created_wallets) {\n-            if (!RemoveWallet(context, w, /*load_on_start=*/false)) {\n-                error += _(\"\\nUnable to cleanup failed migration\");\n-                return util::Error{error};\n+            if (w->HaveChain()) {\n+                // Unloading for wallets that were loaded for normal use\n+                if (!RemoveWallet(context, w, /*load_on_start=*/false)) {\n+                    error += _(\"\\nUnable to cleanup failed migration\");\n+                    return util::Error{error};\n+                }\n+                UnloadWallet(std::move(w));\n+            } else {\n+                // Unloading for wallets in local context\n+                assert(w.use_count() == 1);\n+                w.reset();\n             }\n-            UnloadWallet(std::move(w));\n         }\n \n         // Delete the wallet directories\n-        for (fs::path& dir : wallet_dirs) {\n+        for (const fs::path& dir : wallet_dirs) {\n             fs::remove_all(dir);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366093574",
      "id" : 1366093574,
      "line" : 4308,
      "node_id" : "PRRC_kwDOABII585RbO8G",
      "original_commit_id" : "b57218e4f4543619822c16d54881104ae15a9190",
      "original_line" : 4308,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 164,
      "pull_request_review_id" : 1688333965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366093574/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T21:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366093574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366185322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366185322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "4814e4063e674ad9b0a5c7e56059cd6a2bf9b764",
      "created_at" : "2023-10-19T22:04:27Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& _tx)\n+{\n+    mapValue = _tx.mapValue;\n+    vOrderForm = _tx.vOrderForm;\n+    fTimeReceivedIsTxTime = _tx.fTimeReceivedIsTxTime;\n+    nTimeReceived = _tx.nTimeReceived;\n+    nTimeSmart = _tx.nTimeSmart;\n+    fFromMe = _tx.fFromMe;\n+    nOrderPos = _tx.nOrderPos;\n+    m_state = _tx.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366185322",
      "id" : 1366185322,
      "in_reply_to_id" : 1365913915,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RblVq",
      "original_commit_id" : "cc4fa13bcfa0102ab6366f67a275f583baa0e6ff",
      "original_line" : 37,
      "original_position" : 14,
      "original_start_line" : 28,
      "path" : "src/wallet/transaction.cpp",
      "position" : null,
      "pull_request_review_id" : 1688756419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366185322/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-19T22:04:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366185322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366186793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366186793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point. I've changed it to set and write nOrderPosNext before copying the txs.",
      "commit_id" : "4814e4063e674ad9b0a5c7e56059cd6a2bf9b764",
      "created_at" : "2023-10-19T22:07:02Z",
      "diff_hunk" : "@@ -3916,12 +3920,21 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n-                        error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n+                    const uint256& hash = wtx->GetHash();\n+                    const CWalletTx& to_copy_wtx = *wtx;\n+                    if (!data.watchonly_wallet->LoadToWallet(hash, [&](CWalletTx& ins_wtx, bool new_tx) EXCLUSIVE_LOCKS_REQUIRED(data.watchonly_wallet->cs_wallet) {\n+                        if (!new_tx) return false;\n+                        ins_wtx.SetTx(to_copy_wtx.tx);\n+                        ins_wtx.CloneFrom(to_copy_wtx);\n+                        ins_wtx.nOrderPos = data.watchonly_wallet->IncOrderPosNext(watchonly_batch.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366186793",
      "id" : 1366186793,
      "in_reply_to_id" : 1365926217,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rblsp",
      "original_commit_id" : "cc4fa13bcfa0102ab6366f67a275f583baa0e6ff",
      "original_line" : 3929,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1688758695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366186793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T22:07:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366186793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366186914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366186914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "4814e4063e674ad9b0a5c7e56059cd6a2bf9b764",
      "created_at" : "2023-10-19T22:07:15Z",
      "diff_hunk" : "@@ -3916,12 +3920,21 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n-                        error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n+                    const uint256& hash = wtx->GetHash();\n+                    const CWalletTx& to_copy_wtx = *wtx;\n+                    if (!data.watchonly_wallet->LoadToWallet(hash, [&](CWalletTx& ins_wtx, bool new_tx) EXCLUSIVE_LOCKS_REQUIRED(data.watchonly_wallet->cs_wallet) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366186914",
      "id" : 1366186914,
      "in_reply_to_id" : 1365929404,
      "line" : 3929,
      "node_id" : "PRRC_kwDOABII585Rblui",
      "original_commit_id" : "cc4fa13bcfa0102ab6366f67a275f583baa0e6ff",
      "original_line" : 3929,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 23,
      "pull_request_review_id" : 1688758875,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366186914/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T22:07:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366186914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366187129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366187129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment as suggested.",
      "commit_id" : "4814e4063e674ad9b0a5c7e56059cd6a2bf9b764",
      "created_at" : "2023-10-19T22:07:34Z",
      "diff_hunk" : "@@ -4229,47 +4245,66 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1366187129",
      "id" : 1366187129,
      "in_reply_to_id" : 1366071084,
      "line" : 4256,
      "node_id" : "PRRC_kwDOABII585Rblx5",
      "original_commit_id" : "b57218e4f4543619822c16d54881104ae15a9190",
      "original_line" : 4256,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 100,
      "pull_request_review_id" : 1688759196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366187129/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-19T22:07:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1366187129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This really seems like 3 unrelated changes smashed into one PR\r\n\r\nTwo of the changes are actually required for the third.\r\n\r\nThe primary change here is to create the watchonly and solvables wallets without a chain context. This necessitates the second change of reloading at the end of migration. This also required changes to the cleanup, which prompted me to write a test for that.\r\n\r\nIt then turned out that `AddToWallet` requires a chain, and without one it segfaults. So this required changing the copying to use `LoadToWallet`. This has the side effect of copying the metadata, and when I realized that, I also wrote a test for it.",
      "created_at" : "2023-10-19T22:14:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#issuecomment-1771777352",
      "id" : 1771777352,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28609",
      "node_id" : "IC_kwDOABII585pmy1I",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771777352/reactions"
      },
      "updated_at" : "2023-10-19T22:14:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771777352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1367537397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367537397"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't a blocking comment, just something that we should be aware of.\r\n\r\nEach `CWalletTx` object contains a `const_interator` pointing to the parent wallet `wtxOrdered` map.. the field is called `m_it_wtxOrdered`.\r\nSo, by copying the entire wtx object, we should be careful to update the iterator when the transaction is added to another wallet.\r\n\r\nIn this case, this isn't a problem because the copied wtx is added to the wallet calling `LoadToWallet()` which updates the iterator. But this doesn't make the code less fragile for any future usages.\r\n\r\nI think we can remove this const iterator and also enforce order positioning uniqueness and sequentiality in a follow-up (already started here https://github.com/furszy/bitcoin-core/commits/2023_wallet_txs_order).",
      "commit_id" : "4814e4063e674ad9b0a5c7e56059cd6a2bf9b764",
      "created_at" : "2023-10-20T22:56:16Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& _tx)\n+{\n+    mapValue = _tx.mapValue;\n+    vOrderForm = _tx.vOrderForm;\n+    fTimeReceivedIsTxTime = _tx.fTimeReceivedIsTxTime;\n+    nTimeReceived = _tx.nTimeReceived;\n+    nTimeSmart = _tx.nTimeSmart;\n+    fFromMe = _tx.fFromMe;\n+    nOrderPos = _tx.nOrderPos;\n+    m_state = _tx.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1367537397",
      "id" : 1367537397,
      "in_reply_to_id" : 1365913915,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rgvb1",
      "original_commit_id" : "cc4fa13bcfa0102ab6366f67a275f583baa0e6ff",
      "original_line" : 37,
      "original_position" : 14,
      "original_start_line" : 28,
      "path" : "src/wallet/transaction.cpp",
      "position" : null,
      "pull_request_review_id" : 1690963216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367537397/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-21T14:36:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367537397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1367739048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367739048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not in a PR, but I do have something related in progress. Still, we should move forward with your suggestion; it is much more scoped than what I'm doing.\r\n\r\nI'm rewriting the process, so the bdb->sqlite migration, the removal of \"no longer ours\" database records, and the backup creation steps are not needed.\r\nThe goal is to leave the legacy wallet untouched for the entire migration process. Then, only if migration succeeds, execute the path rename. So, in case the user faces a crash or abortion during the process, the legacy wallet will open as if nothing has happened. Which is what the process lacks today; If it crashes right now, the user has to manually do the cleanup and previous wallet recovery.\r\n\r\nThis would indirectly solve the issue you mentioned because, in case of a failure, the process would only need to delete the newly created wallet directories and nothing else.",
      "commit_id" : "4814e4063e674ad9b0a5c7e56059cd6a2bf9b764",
      "created_at" : "2023-10-21T14:34:03Z",
      "diff_hunk" : "@@ -4229,47 +4245,66 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n         success = DoMigration(*local_wallet, context, error, res);\n     }\n \n+    // In case of reloading failure, we need to remember the wallet dirs to remove\n+    std::set<fs::path> wallet_dirs;\n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n-        assert(local_wallet.use_count() == 1);\n-        local_wallet.reset();\n-        res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        // Migration successful, unload all wallets locally, then reload them.\n+        const auto& reload_wallet = [&](std::shared_ptr<CWallet>& to_reload) {\n+            assert(to_reload.use_count() == 1);\n+            std::string name = to_reload->GetName();\n+            wallet_dirs.insert(fs::PathFromString(to_reload->GetDatabase().Filename()).parent_path());\n+            to_reload.reset();\n+            to_reload = LoadWallet(context, name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+            return to_reload != nullptr;\n+        };\n+        // Reload the main wallet\n+        success = reload_wallet(local_wallet);\n+        res.wallet = local_wallet;\n         res.wallet_name = wallet_name;\n-    } else {\n+        if (success && res.watchonly_wallet) {\n+            // Reload watchonly\n+            success = reload_wallet(res.watchonly_wallet);\n+        }\n+        if (success && res.solvables_wallet) {\n+            // Reload solvables\n+            success = reload_wallet(res.solvables_wallet);\n+        }\n+    }\n+    if (!success) {\n         // Migration failed, cleanup\n         // Copy the backup to the actual wallet dir\n         fs::path temp_backup_location = fsbridge::AbsPathJoin(GetWalletDir(), backup_filename);\n         fs::copy_file(backup_path, temp_backup_location, fs::copy_options::none);\n \n-        // Remember this wallet's walletdir to remove after unloading\n-        std::vector<fs::path> wallet_dirs;\n-        wallet_dirs.emplace_back(fs::PathFromString(local_wallet->GetDatabase().Filename()).parent_path());\n-\n-        // Unload the wallet locally\n-        assert(local_wallet.use_count() == 1);\n-        local_wallet.reset();\n-\n         // Make list of wallets to cleanup\n         std::vector<std::shared_ptr<CWallet>> created_wallets;\n+        if (local_wallet) created_wallets.push_back(std::move(local_wallet));\n         if (res.watchonly_wallet) created_wallets.push_back(std::move(res.watchonly_wallet));\n         if (res.solvables_wallet) created_wallets.push_back(std::move(res.solvables_wallet));\n \n         // Get the directories to remove after unloading\n         for (std::shared_ptr<CWallet>& w : created_wallets) {\n-            wallet_dirs.emplace_back(fs::PathFromString(w->GetDatabase().Filename()).parent_path());\n+            wallet_dirs.emplace(fs::PathFromString(w->GetDatabase().Filename()).parent_path());\n         }\n \n         // Unload the wallets\n         for (std::shared_ptr<CWallet>& w : created_wallets) {\n-            if (!RemoveWallet(context, w, /*load_on_start=*/false)) {\n-                error += _(\"\\nUnable to cleanup failed migration\");\n-                return util::Error{error};\n+            if (w->HaveChain()) {\n+                // Unloading for wallets that were loaded for normal use\n+                if (!RemoveWallet(context, w, /*load_on_start=*/false)) {\n+                    error += _(\"\\nUnable to cleanup failed migration\");\n+                    return util::Error{error};\n+                }\n+                UnloadWallet(std::move(w));\n+            } else {\n+                // Unloading for wallets in local context\n+                assert(w.use_count() == 1);\n+                w.reset();\n             }\n-            UnloadWallet(std::move(w));\n         }\n \n         // Delete the wallet directories\n-        for (fs::path& dir : wallet_dirs) {\n+        for (const fs::path& dir : wallet_dirs) {\n             fs::remove_all(dir);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1367739048",
      "id" : 1367739048,
      "in_reply_to_id" : 1366093574,
      "line" : 4315,
      "node_id" : "PRRC_kwDOABII585Rhgqo",
      "original_commit_id" : "b57218e4f4543619822c16d54881104ae15a9190",
      "original_line" : 4315,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 178,
      "pull_request_review_id" : 1690963216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367739048/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-21T14:36:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1367739048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1368283439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368283439"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should the comment above be updated?",
      "commit_id" : "4814e4063e674ad9b0a5c7e56059cd6a2bf9b764",
      "created_at" : "2023-10-23T08:09:43Z",
      "diff_hunk" : "@@ -323,11 +323,15 @@ class CWalletTx\n     const uint256& GetWitnessHash() const { return tx->GetWitnessHash(); }\n     bool IsCoinBase() const { return tx->IsCoinBase(); }\n \n+private:\n     // Disable copying of CWalletTx objects to prevent bugs where instances get\n     // copied in and out of the mapWallet map, and fields are updated in the\n     // wrong copy.\n-    CWalletTx(CWalletTx const &) = delete;\n-    void operator=(CWalletTx const &x) = delete;\n+    CWalletTx(const CWalletTx&) = default;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1368283439",
      "id" : 1368283439,
      "line" : 330,
      "node_id" : "PRRC_kwDOABII585Rjlkv",
      "original_commit_id" : "118f2d7d70b584eee7b89e58b5cd2d61c59a9bbf",
      "original_line" : 330,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.h",
      "position" : 10,
      "pull_request_review_id" : 1691946218,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368283439/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-23T08:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1368283439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
