[
   {
      "body" : "One way to test the latency is just to use the ping rpc (then getpeerinfo to see the results) and have a node with this patch and a peer with the patch. The effect should be visible (at least, it's very visible if you simply reset adjust the sleep!).",
      "created_at" : "2014-05-25T08:33:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44125582",
      "id" : 44125582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-25T08:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44125582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "**Test Results**\r\n\r\nTwo nodes were running, peered with each other via localhost, both running the same code.  For each test, 100 pings were generated.\r\n\r\n*TEST 1*: Unpatched master branch\r\nAverage ping time: 101ms\r\nMedian: 101ms\r\nStd Dev: 1.19ms\r\n\r\n*TEST 2*: Patched with no_sleep branch\r\nAverage ping time: 12.6ms\r\nMedian: 10.9ms\r\nStd Dev: 6.4ms\r\n\r\nImplementing the semaphore shows a clear drop in latency although there is added variance.\r\n\r\nI'm surprised to see that the first test consistently had 100ms pings.  I would have thought there would be more variance based on the timing of the sleep.\r\n\r\nI took a look at the Jenkins build log.  I'm not sure why the test is failing.  It looks like it timed out generating the test blockchain.",
      "created_at" : "2014-05-25T11:05:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44128384",
      "id" : 44128384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-25T11:05:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44128384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "If it doesn't seem related to your own code, the error in pulltester could be an intermittent one.",
      "created_at" : "2014-05-25T14:02:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44133889",
      "id" : 44133889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-25T14:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44133889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Pushed an amended commit trigger the test again",
      "created_at" : "2014-05-25T14:33:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44134549",
      "id" : 44134549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-25T14:33:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44134549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "The test has failed twice now.  There must be a bug in this patch.  I did notice when doing my ping test that the nPingTime value would only update about 30% of the time.  But without the patch, it updated every time.  At the time, I thought this must have been some race condition in the ping code, which gets more pronounced with the lower ping time.  But now I'm thinking that perhaps it's dropping messages, or not draining the send queue fast enough.  I'll do some further investigation.",
      "created_at" : "2014-05-26T02:47:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44153555",
      "id" : 44153555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-26T02:47:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44153555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "The end of the log says:\r\n\r\n+ /mnt/bitcoin/qa/rpc-tests/wallet.sh /mnt/bitcoin/linux-build/src\r\nGenerating test blockchain...\r\nTimeout: aborting command ``/mnt/bitcoin/qa/pull-tester/pull-tester.sh'' with signal 9\r\n\r\nSo you could try running that test script and see if it has issues.",
      "created_at" : "2014-05-26T16:38:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44203272",
      "id" : 44203272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-26T16:38:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44203272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "This seems like a scary change to make since it means that the messenger could stall if a post is forgotten.\r\nAs a means of easing into this, how about teaching CSemaphore something like timed_wait(), which would timeout at 100msec as before, or immediately wake when signaled?",
      "created_at" : "2014-05-26T19:33:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44213182",
      "id" : 44213182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-26T19:33:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44213182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@theuni - I agree with you there.  However first I would like to get the timerless version working perfectly without any known bugs, and then add the 100msec timeout as pure safety net.  If it relies on the timer for normal function, then the patch hasn't really achieved its purpose.",
      "created_at" : "2014-05-27T01:01:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44226801",
      "id" : 44226801,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-27T01:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44226801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "@ashleyholman Agreed, good plan.",
      "created_at" : "2014-05-27T15:13:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44289688",
      "id" : 44289688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-27T15:13:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44289688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "I think you want a condition variable here, not a semaphore. Calling post() twice means wait() will return twice on a semaphore, which we don't want.\r\n\r\nNote that CSemaphore is implemented on top of boost condition variables.",
      "created_at" : "2014-05-31T11:58:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44746404",
      "id" : 44746404,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-31T11:58:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44746404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Ah, that is exactly the problem I've been wanting to solve. I basically need the semaphore's counter to reset to 0 when wait() returns. Should I be adding a new class to sync.h for that just does this?",
      "created_at" : "2014-05-31T12:51:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44747493",
      "id" : 44747493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-31T12:51:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44747493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "@ashleyholman What you really need is a condition-variable protected timestamp of the last addition to the receive queue or send state.\r\n\r\nBasically:\r\n```\r\nboost::mutex cs_condMessageHandler;\r\nboost::condition_variable condMessageHandler;\r\nint64_t nMessageHandlerLastUpdate;\r\nint64_t nMessageHandlerLastCheck;\r\n\r\nvoid MessageHandlerWaiter() {\r\n    boost::unique_lock<boost::mutex> lock(cs_condMessageHandler);\r\n    while (nMessageHandlerLastUpdate <= nMessageHandlerLastCheck) {\r\n        condMessageHandler.wait(lock);\r\n    }\r\n    nMessageHandlerLastCheck = GetTimeMicros();\r\n}\r\n\r\nvoid MessageHandlerUpdate() {\r\n    boost::unique_lock<boost::mutex> lock(cs_condMessageHandler);\r\n    nMessageHandlerLastUpdate = GetTimeMicros();\r\n    condMessageHandler.notify_one();\r\n}\r\n```\r\n\r\nAlso, for SendMessages, I think you need indeed more, and just a waiting condition isn't enough. Some of the messages sent there are periodic, and necessary even if nothing was received in a while (for example sending pings). So you'll need something like:\r\n```\r\nif (!condMessageHandler.timed_wait(lock, boost::posix_time::milliseconds(5000)))\r\n  break;\r\n```\r\ninstead (which never blocks for more than 5 seconds).",
      "created_at" : "2014-05-31T13:39:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44748561",
      "id" : 44748561,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-31T13:40:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44748561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Ugh, instead of the two timestamps you could just have a single boolean too, set to true when updating, and set to false after returning from wait.\r\n",
      "created_at" : "2014-05-31T13:50:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44748811",
      "id" : 44748811,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-31T13:50:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44748811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "To deal better with the ping latency variance, we could add a timestamp to CNetMessage, filled in when it is received. It's probably also useful for auto-disconnect logic of slow peers (currently, it's possible the trigger it if we're just too slow to react to an incoming message too).",
      "created_at" : "2014-05-31T17:46:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44754719",
      "id" : 44754719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-05-31T17:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44754719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa do you think there should be a new class added to sync.h with a simple interface for this?  or just implement it all in the thread message handler?\r\n\r\nCould be something like\r\n\r\nvoid CCondition::wait()\r\nvoid CCondition::timed_wait(int milliseconds)\r\nvoid CCondition::post()\r\n\r\nSomething else that would be nice to have is a global message queue for new messages that need to be processed.  So rather than having to loop over every node and check its vRecvMsg, there could be one queue that combines messages from all nodes.  That might be more of a stage 2 thing though.",
      "created_at" : "2014-06-01T04:14:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44767186",
      "id" : 44767186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-06-01T04:14:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44767186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "On Jun 1, 2014 6:14 AM, \"Ashley Holman\" <notifications@github.com> wrote:\n>\n> @sipa do you think there should be a new class added to sync.h with a\nsimple interface for this? or just implement it all in the thread message\nhandler?\n>\n> Could be something like\n>\n> void CCondition::wait()\n> void CCondition::timed_wait(int milliseconds)\n> void CCondition::post()\n\nPerhaps, but you have to encapsulate the state as well, as it needs to be\nmutex protected (and the condition variable wait needs to be able to\ntemporarily release it), so either the timestamps or the boolean must be\ninside that class. I guess CCondition is a bit too general as a name.\nCTimeoutCondition maybe?\n\nAlso, the code that I gave above may not work if the waiting is regularly\nwoken up spuriously (which the spec says can happen). The timed wait would\nneed to decrement the timeout based on how much time passed in previous\nloops.\n\n> Something else that would be nice to have is a global message queue for\nnew messages that need to be processed. So rather than having to loop over\nevery node and check its vRecvMsg, there could be one queue that combines\nmessages from all nodes. That might be more of a stage 2 thing though.\n\nThat may be possible, but we need to take the different parts of state\nbeing locked into account, and make sure that we can skip a busy node's\nnessages, without violating ordering (you need to process messages received\nby a single node in order). Also, we need per-node resource tracking (how\nmuch of the receive buffer is one peer using?).",
      "created_at" : "2014-06-01T06:44:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44769051",
      "id" : 44769051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-06-01T06:44:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44769051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa how is this?  uses a class to encapsulate the mutex + boolean flag + timeout.",
      "created_at" : "2014-06-01T10:02:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44773333",
      "id" : 44773333,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-06-01T10:02:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44773333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "This segfaults for me during tests, because condMessageHandler is not necessarily initialized in those.\r\n\r\nHow about not making it a pointer, so it's initialized together with other global variables at startup?",
      "created_at" : "2014-06-01T10:55:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44774756",
      "id" : 44774756,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-06-01T10:55:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44774756",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Done.",
      "created_at" : "2014-06-01T11:17:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-44775178",
      "id" : 44775178,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-06-01T11:17:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/44775178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I've reliased that changing the frequency of ThreadMessageHandler's loop has implications on the \"trickle\" activity.  The trickling is designed around sending messages to 1 trickle node every 100 ms.  To make the message handling real-time without effecting the trickling, should these be split into 2 separate threads?",
      "created_at" : "2014-06-04T15:54:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-45109372",
      "id" : 45109372,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-06-04T15:54:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/45109372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Or, it could just track the last time it trickled, and use this to determine whether to assign a trickle node or not for that iteration.  This, combined with a 100ms sleep timeout, should keep the behaviour the same.",
      "created_at" : "2014-06-04T16:00:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-45110190",
      "id" : 45110190,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-06-04T16:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/45110190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Looks good to me, going to test this.",
      "created_at" : "2014-07-08T07:51:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48282008",
      "id" : 48282008,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-08T07:51:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48282008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj good to hear :).  I'm also looking for thoughts on handling the trickle behaviour as per my comments above.  I think in its current state, the patch will not trickle at the same rate.  The two options I could think of were either having a separate thread for trickling, or tracking a \"last trickle\" timestamp in ThreadMessageHandler and using that to calculate how long to do the timed_wait() for so that it wakes up at least once every 100ms.",
      "created_at" : "2014-07-08T08:42:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48286183",
      "id" : 48286183,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-08T08:42:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48286183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "To me, splitting it into two different threads sounds like the cleanest and least brittle solution here. A trickle thread that does its operations exactly every 100ms, and a message handler that wakes up only when necessary. After all, these are different concerns.\r\n\r\nAt some point we could switch to an async framework with deadline timers and such for the P2P code so that it can all be handled in one thread, but trying to do that by hand sounds somewhat error prone and hard to maintain.\r\n",
      "created_at" : "2014-07-08T09:52:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48292633",
      "id" : 48292633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-08T09:53:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48292633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I marked this as a milestone for 0.10. Reducing propagation latency is very essential imho, and just shaving off ~40ms on average for every hop is huge.\r\n\r\nRegarding trickling: I think we don't nearly need 100ms intervals for that. How about once every 5s?\r\n\r\nI'm not sure about every other processing happening in SendMessages, but a few seconds doesn't sound too bad. ",
      "created_at" : "2014-07-08T18:07:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48377434",
      "id" : 48377434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-08T18:07:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48377434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Just had a look at how frequently addr messages are effectively trickled out on bitcoin.sipa.be... turns out to be one every few seconds.",
      "created_at" : "2014-07-08T18:15:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48378520",
      "id" : 48378520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-08T18:15:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48378520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "There is some analysis of the trickling code in this paper: http://arxiv.org/pdf/1405.7418.pdf in the \"Address propagation\" and \"Transaction propagation\" sections.  Based on this paper and also reading the code, I think there might be a potential to impact transaction propagation times if the trickle interval were increased.",
      "created_at" : "2014-07-08T20:48:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48397577",
      "id" : 48397577,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-08T20:48:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48397577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "More specifically, when a transaction is received, it has a 25% chance of being relayed to all peers immediately upon first call to SendMessages().  The other 75% of transactions will be delayed and pushed into the vInvWait queue which will only be sent to each peer when they are randomly chosen as the trickle node.  So as a transaction propagates through the network, there might be some unlucky nodes who don't get any peers instantly relaying it to them, so they have to wait for 1 or more trickle hops before they see it.  There might even be nodes who have to wait 2 or more trickle hops to see it.  So I believe having a low trickle interval should ensure fast worst-case propagation.  Fast propagation of unconfirmed transactions should be important for responsiveness when making a payment (eg. PoS or online checkout).",
      "created_at" : "2014-07-09T00:52:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48417855",
      "id" : 48417855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-09T00:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48417855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Just pushed a new patch which splits the trickle activity into its own thread.\r\n\r\nI've kept the 100ms MilliSleep in this thread, but can change that if required.\r\n\r\nNote that the ThreadMessageHandler code currently causes a potential deadlock warning (Not introduced by this pull, but already there in master - reported in #4493).  Since this patch makes ThreadMessageHandler() fire more often, it could increase the risk of that deadlock.  But as per my notes on the issue, I think it might be a harmless warning with no actual deadlock potential.",
      "created_at" : "2014-07-09T11:33:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48458611",
      "id" : 48458611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-09T11:33:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48458611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I'm not totally convinced that this trickle behaviour is worth it. Performance is super critical for happy users and the trickle seems to be intended to make it harder to track the flow of transactions across the network. But:\r\n\r\n* It's quite feasible to just connect to all publicly reachable nodes and watch propagation this way\r\n* Government level adversaries would be unlikely to be impacted by timing randomisation anyway\r\n\r\nShould we just remove it?",
      "created_at" : "2014-07-09T12:01:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48460880",
      "id" : 48460880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-09T12:01:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48460880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "NACK on removing it. It is a sensible precaution. With the payment protocol, which is the way forward, the payer gives the merchant the transaction through a direct channel so propagation time through the network is not important for user experience.\r\n\r\nGoing to test this new version of the pull.",
      "created_at" : "2014-07-09T12:33:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48463601",
      "id" : 48463601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-09T12:36:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48463601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Simplicity is better than complexity-- I vote remove it.\r\n\r\nThe trickle code was implemented before we supported running over Tor; Tor is a much better (but still not foolproof) way to get more private transactions.\r\n",
      "created_at" : "2014-07-09T13:00:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48466193",
      "id" : 48466193,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-09T13:00:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48466193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "I have done an audit to find events that should require SendMessages() to run:\r\n\r\n- CNode::fPingQueued set (ping())\r\n- CNode::vAddrToSend pushed (CNode::PushAddress())\r\n- CNodeState::fShouldBan set (Misbehaving())\r\n- CNodeState::rejects pushed (InvalidBlockFound())\r\n- CNode::fStartSync set (StartSync())\r\n- CNode::vInventoryToSend pushed (CNode::PushInventory())\r\n- CNodeState::nBlocksInFlight decreased (MarkBlockAsReceived())\r\n- CNode::mapAskFor pushed (CNode::AskFor())\r\n\r\nSo I will patch those to wake up ThreadMessageHandler().\r\n\r\nHowever, there is a problem in that SendMessages() is not guaranteed to do all the work required of it.  If it fails its TRY_LOCK on cs_main, it only sends pings, and postpones sending of all other message types until its next invocation when cs_main can \"hopefully\" be obtained.  So there is already going to be the possibility of messages being delayed for arbitrary lengths of time - not good.\r\n\r\nGiven that SendMessages() doesn't guarantee sending, it is not going to be enough to just fire it once per relevant event and sleep inbetween.  SendMessages() needs to be called regularly so that it can re-try on cs_main and send any pending messages that were previously postponed.  Furthermore, SendMessages() is responsible for stalled peer detection which is not really event-based, so that also requires SendMessages() to be called at least somewhat regularly.\r\n\r\nGiven this need to run regularly, the timed_wait() in ThreadMessageHandler going to be strictly required rather than acting as a safety net, and the sleep time should probably be kept low.\r\n\r\nIn order to have a better guarantee on propagation times, I think SendMessages() should always send all outgoing messages every time it is invoked, ideally without requiring cs_main at all.  It currently needs cs_main to call IsInitialBlockDownload() and obtain the CNodeState information.  As discussed in #4493, IsInitialBlockDownload could be modified to not require the lock.  But, cs_main would still be needed for sending rejection messages, banning peers, and requesting blocks.  Delaying the banning/rejection messages is probably not too bad, but it would be good if requests for blocks were not delayable.",
      "created_at" : "2014-07-09T23:49:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48549858",
      "id" : 48549858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-09T23:49:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48549858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Pros of removing trickling:\r\n- Faster transaction propagation (All peers blast the tx 100% of the time)\r\n- Simpler to understand code\r\n\r\nCons of removing trickling:\r\n- Reduced privacy for non-tor users\r\n- Increased burst of inv messages across the network may consume more bandwidth\r\n- Increased risk from changing protocol behaviour\r\n\r\nThis paper is worth a read for anyone who hasn't read it: http://arxiv.org/pdf/1405.7418.pdf.  Their deanonymisation attack involves forcing people off of tor by getting the exit nodes banned.\r\n\r\nI might try contacting those researchers, because I would be curious to get their opinion on this given they have obviously studied the topic in depth and implemented an attack.",
      "created_at" : "2014-07-10T00:40:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48553076",
      "id" : 48553076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T00:40:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48553076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "@ashleyholman Thanks for the work on analyzing the network code! Maybe an intermediate solution, as long as cs_main is still needed for some actions, would be to do a timed wait only when it failed to acquire the lock, and a non-timed wait otherwise?\r\n\r\nLet's move the discussion about moving or not removing trickle to the mailing list. Don't combine major behaviour changes with refactoring. Having a separate trickle thread is fine for now. It can be easily disabled, even as an option.\r\n",
      "created_at" : "2014-07-10T06:23:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48569329",
      "id" : 48569329,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T06:24:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48569329",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r14752023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14752023"
         }
      },
      "body" : "I'd like to avoid introducing this include-file dependency if possible",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-07-10T07:10:04Z",
      "diff_hunk" : "@@ -6,6 +6,8 @@\n #ifndef BITCOIN_SYNC_H\n #define BITCOIN_SYNC_H\n \n+#include \"util.h\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r14752023",
      "id" : 14752023,
      "original_commit_id" : "3df57a19afbe066ce02ba9e797ab9ff20e70d537",
      "original_position" : 4,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/14752023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "> Maybe an intermediate solution, as long as cs_main is still needed for some actions, would be to do a timed wait only when it failed to acquire the lock, and a non-timed wait otherwise?\r\n\r\n@laanwj That sounds good.  It could at least do a shorter timed wait when the lock failed, and a longer one when it succeeds.  The longer one is needed so that it can still do stalled peer detection.  However, there is an added complexity: each time ThreadMessageHandler wakes up, it does many calls to SendMessages() - once for each individual peer.  So what should it do if, say, the lock failed for only 1 out of the N peers?",
      "created_at" : "2014-07-10T08:12:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48576439",
      "id" : 48576439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T08:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48576439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I think if it failed to acquire the lock for at least one peer, it needs a timed re-try.\r\n\r\nIn principle it is really inefficient that it has to acquire the lock many times, but that's harder to solve.",
      "created_at" : "2014-07-10T09:43:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48584487",
      "id" : 48584487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T09:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48584487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "It could perhaps acquire the lock once before the SendMessages loop.  That way, all the SendMessages calls will succeed on the locks.  I don't think the message handler currently spends much time without the lock anyway.\r\n\r\nThe only difference is that there wouldn't be a gap inbetween calls for other threads to obtain cs_main.  If that's a problem, it could perhaps acquire the lock, then do SendMessages for the first 10 peers, then free the lock, then reacquire, do the next 10 peers, etc.\r\n\r\nWhat do you think about that?  The good thing about doing it that way is that messages won't have any chance of being \"delayed\".\r\n\r\nFrom my work on the peers GUI, I recall that cs_main was actually often in use.  I was doing TRY_LOCK on it every second, and it would fail maybe 20% of the time, even when my node wasn't very busy.  In the case of having to run through 120 peers, I bet at least one of them would fail most of the time.",
      "created_at" : "2014-07-10T11:15:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48591992",
      "id" : 48591992,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T11:15:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48591992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Coincidentally, that would fix the potential deadlock issue as well.",
      "created_at" : "2014-07-10T11:19:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48592310",
      "id" : 48592310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T11:19:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48592310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "My latest patch implements some more trigger points to wake up ThreadMessageHandler.  This covers off on all cases I can identify where messages need to be sent.\r\n\r\nI've also removed the dependence on util.h.",
      "created_at" : "2014-07-10T12:22:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48597286",
      "id" : 48597286,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T12:22:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48597286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "@ashleyholman Indeed - the intent behind releasing the main lock once in a while is to give other threads a chance. For example the GUI can appear to hang on some actions if the main lock is held for too long. I'm not sure if the network thread will hold the lock for long, though. The longest main-lock holders have always been wallet rescanning and some block processing.\r\n",
      "created_at" : "2014-07-10T12:26:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48597550",
      "id" : 48597550,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T12:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48597550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I think we should pushing cs_main down, not up.\n\nThe whole reason for worrying about it is because the validation logic\nlocks cs_main for very long times, so we need workarounds for dealing with\nit.\n\nAlso, this code should not cause a deadlock:\n* thread 1: lock(a) ... lock(b)\n* thread 2: lock(b) ... try_lock(a)\n\nThe typical deadlock scenario would be 1 acquiring a, 2 acquiring b,\nfollowed by 2 trying to get b, and 1 trying to get a, causing both to wait\nfor eachother. As the second step in thread 2 is a try, it will eventually\nrelease b without acquiring a, causing thread 1 to continue.",
      "created_at" : "2014-07-10T12:28:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48597773",
      "id" : 48597773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T12:28:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48597773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa I concur.  It does produce a \"potential deadlock\" warning though, because I guess the deadlock detection doesn't know that the 2nd lock is conditional on try_lock().\r\n\r\nWhat I mean about ThreadMessageHandler is that I think it already spends most of its *waking* time with cs_main, but agreed that its not much time overall.  So if it acquired cs_main upon wakeup and freed it before sleeping, this would allow all pending messages to be sent every time rather than randomly failing for some peers, causing arbitrary message delays.\r\n\r\nSo what about either, acquiring once, processing all SendMessages, then releasing.  Or, acquiring and releasing in batches, doing X peers at a time?",
      "created_at" : "2014-07-10T12:34:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48598257",
      "id" : 48598257,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T12:34:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48598257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "To be clear about the change I'm describing:\r\n- Make cs_main a precondition for calling SendMessages()\r\n- Remove the TRY_LOCK / early return logic from SendMessages.  It now does all work required of it, guaranteed.\r\n- Acquire cs_main in ThreadMessageHandler, prior to calling SendMessages().\r\n- The above acquisition of cs_main can be batched to hold cs_main for many invocations of SendMessages() (because it has to call SendMessages for each peer).",
      "created_at" : "2014-07-10T12:47:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48599457",
      "id" : 48599457,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T12:47:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48599457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Just got another idea.. what about splitting SendMessages into two separate functions.  One that requires cs_main and one that doens't.  Most work can go into the non-lock one, eg. ping, inv, and addr messages.  The cs_main function will be responsible for the other parts that need the lock, the most important of these being getdata messages which impact block propagation time.\r\n\r\nI'm still suggesting cs_main be mandatory, but at least it would be over a smaller section of code.",
      "created_at" : "2014-07-10T13:32:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48604211",
      "id" : 48604211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T13:32:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48604211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "We think that removing trickling will definitely make Bitcoin less anonymous for non-Tor users. The attack has three (independent) parts:\r\n1) Linking a user's IP address to his entry nodes (his 8 outgoing connections). Possible only if Tor is not used.\r\n2) Correlating transactions to entry nodes.\r\n3) Linking together transactions of the same user  during one session.\r\n\r\nThe trickling delay for 75% of transactions considerably decreases the rate of linkability for the transactions, i.e. parts 2) and 3).  Without trickling the success rate of these parts would significantly increase (probably would become close to perfect). Thus linking different transactions of the same user during the session would be much easier. Moreover for parts 2) and 3) the attacker would need to make only 1 connection to each peer, instead of 20-50 in the current attack. This is much less noticeable. Also Tor is easy to ban in the current protocol.\r\n\r\nAs possible countermeasures we are considering now would be to\r\n1) increase the percentage of trickled transactions (from 75% to 90%, this is of course not in the spirit of this pull request, and will increase tx propagation delays);\r\n2) decrease the number of outgoing connections from 8 to 3    (this has an implication that the network becomes less connected).\r\n\r\nMinor thought: Not having privacy issues in mind and completely relying on an external tool (Tor) might cause that anonymity is not achieved at all (https://blog.torproject.org/blog/bittorrent-over-tor-isnt-good-idea https://www.torproject.org/docs/faq.html.en#TBBFlash)\r\n\r\nAlex, Ivan\r\nhttps://www.cryptolux.org\r\n",
      "created_at" : "2014-07-10T16:36:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48629839",
      "id" : 48629839,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-10T16:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48629839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8126617?v=3",
         "events_url" : "https://api.github.com/users/ivanpustogarov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ivanpustogarov/followers",
         "following_url" : "https://api.github.com/users/ivanpustogarov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ivanpustogarov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ivanpustogarov",
         "id" : 8126617,
         "login" : "ivanpustogarov",
         "organizations_url" : "https://api.github.com/users/ivanpustogarov/orgs",
         "received_events_url" : "https://api.github.com/users/ivanpustogarov/received_events",
         "repos_url" : "https://api.github.com/users/ivanpustogarov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ivanpustogarov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ivanpustogarov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ivanpustogarov"
      }
   },
   {
      "body" : "@ivanpustogarov I agree, but as said please move the trickling discussion to the mailing list, removing trickling is off the table in this pull.",
      "created_at" : "2014-07-11T13:02:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48727210",
      "id" : 48727210,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-11T13:03:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48727210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@sipa @laanwj Please take a look at my latest commit if you get a chance.  It's doing what I described above - splitting SendMessages() into two functions and requiring the lock for one of them.\r\n\r\nThere is the potential to move the sending of non-block getdata messages into the lockless function, but that would cause 2 getdata messages to be sent (1 getdata for blocks, another getdata for non-blocks) when the old code would combine them into one.  So I've left all getdata messages in the locked function to keep the protocol behaviour unchanged.\r\n\r\nIf you don't like this approach, I can revert it and look at some of the alternatives discussed earlier.\r\n\r\nPS: I've observed that when this patch is applied, ThreadTrickle() ends up running only a few times per second during times when cs_main is busy (eg. when validating a new block), instead of the target 10 times per second.  This is nothing new though, because the existing code is already effected in the same way: it would run 10 times per second, but 8 of those times its TRY_LOCK on cs_main would fail so no messages would be trickled.",
      "created_at" : "2014-07-12T05:28:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48802954",
      "id" : 48802954,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-12T05:28:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48802954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Adding a SendMessagesCSMain seems wrong from a design point. Main is a *client* of net, registering some handlers to be called when certain events occur. If there are some parts of SendMessages logic that do not rely on cs_main, that means that code shouldn't have been in main in the first place. And net certainly shouldn't know about or use cs_main itself.\r\n\r\nHow about moving the non-cs_main-dependent part of SendMessages to net.cpp (sort of as a base message handler, independent of the validation engine), and register it as a second SendMessages handler?",
      "created_at" : "2014-07-12T16:00:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48816062",
      "id" : 48816062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-12T16:00:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48816062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Thanks for checking it out.  It felt like a kludgy hack as I was doing it, but I wanted to get the concept into code.  That sounds like a much better way to do it.  As for having two handlers on SendMessages, I don't know how I would be able to batch up the cs_main-dependent work to run under one acquisition of the lock.  I'd have to acquire cs_main inside the main.ccp SendMessages handler, once for each peer.  I figured it would be better to get the lock once and do all the work at once.  Do you think it's going to add any/much overhead to be acquiring and releasing it up to 125 times every time the handler fires?",
      "created_at" : "2014-07-12T19:39:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48821888",
      "id" : 48821888,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-12T19:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48821888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I think we should just get the lock once per peer, and if necessary, move the acquiring of the sender or receiver node lock inside sendmessages too, if the ordering of locks requires that.",
      "created_at" : "2014-07-12T20:09:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48822675",
      "id" : 48822675,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-12T20:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48822675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I've reverted my previous two commits and pushed a new patch with the cleaner design.  cs_main is now acquired inside SendMessages() for each peer.  Note that SendMessages() now waits to acquire cs_main instead of returning when TRY_LOCK fails.  I think this will result in lower latency since it doesn't delay messages till the next ThreadMessageHandler iteration.\r\n\r\nedit: moving the send receive locks will be necessary to prevent deadlock now that there's no TRY_LOCK on cs_main.. fixed in next patch.",
      "created_at" : "2014-07-13T00:34:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48828027",
      "id" : 48828027,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-13T01:11:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48828027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I think this pull is ready for a closer review now, so I've pushed a fresh rebase and squashed everything into a single patch.\r\n\r\nThanks.",
      "created_at" : "2014-07-13T03:42:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48830853",
      "id" : 48830853,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-13T03:42:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48830853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Testing.\r\n\r\nNeeds a rebase, though.",
      "created_at" : "2014-07-14T20:13:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48953279",
      "id" : 48953279,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-14T20:13:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48953279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2014-07-14T21:56:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48965491",
      "id" : 48965491,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-14T21:56:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48965491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "We may need a separate per-node lock now for the fields used by the non-main message handler thread code, as otherwise for example the ping variables may be accessed by both the trickle and normal handler thread?",
      "created_at" : "2014-07-16T15:21:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-49181296",
      "id" : 49181296,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-16T15:21:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49181296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "SendMessagesNet locks pto->cs_vSend (node-specific lock) before it checks the ping flag and inventory list.  So I think that should exclude the two threads from racing?",
      "created_at" : "2014-07-16T21:45:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-49231937",
      "id" : 49231937,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-16T21:45:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49231937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "But ProcessMessage (which also accesses those variables) does not lock cs_vSend. The regular message handler can be running ProcessMessage, while the trickle thread is running SendMessages.",
      "created_at" : "2014-07-16T21:52:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-49232712",
      "id" : 49232712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-16T21:53:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49232712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "ProcessMessages() is only called by ThreadMessageHandler, and it locks the node's cs_vRecvMsg before calling it.  In ThreadTrickle it's only doing sending because that's the only part that uses the trickle flag.",
      "created_at" : "2014-07-16T21:57:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-49233315",
      "id" : 49233315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-16T21:57:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49233315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "So? What prevents ThreadMessageHandler -> ProcessMessages -> ProcessMessage -> \"pong\" from running simultaneously with ThreadTrickle -> SendMessages -> \"ping\" ?\r\n",
      "created_at" : "2014-07-16T22:00:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-49233655",
      "id" : 49233655,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-16T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49233655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Ahh yes, I get it now.  Sorry.  Any suggestions on naming this new lock?",
      "created_at" : "2014-07-16T22:03:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-49233985",
      "id" : 49233985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-07-16T22:03:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49233985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I have added a new lock, CNode::cs_ping, to protect the race condition in the ping/pong processing.",
      "created_at" : "2014-08-10T08:27:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-51709229",
      "id" : 51709229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-10T08:27:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51709229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Untested ACK (and testing right now). I would abstract all the condMessageHandler.notify_one() calls behind a function in net, though.",
      "created_at" : "2014-08-10T09:47:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-51710514",
      "id" : 51710514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-10T09:47:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51710514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Replaced all message handler notifications with WakeMessageHandler().",
      "created_at" : "2014-08-10T12:02:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-51712924",
      "id" : 51712924,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-10T12:02:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51712924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Does anyone need anything further from me on this?  I need another ack on it.  How about @laanwj since you have had some involvement?\r\n\r\nI'll need to do one final squash/sign before the merge.",
      "created_at" : "2014-08-24T08:32:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53183913",
      "id" : 53183913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-24T08:32:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53183913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Tested ACK.",
      "created_at" : "2014-08-24T19:55:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53204863",
      "id" : 53204863,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-24T19:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53204863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16644924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16644924"
         }
      },
      "body" : "Due to using relative durations there's a slight window for a race condition here:\r\n- `boost::posix_time::microsec_clock::universal_time()` called the first time in the while() clause and returns a value `< alarm`\r\n- `boost::posix_time::microsec_clock::universal_time()` called the second time in the subtraction returns a value `> alarm`\r\nIn this case either a negative value would be passed to timed_wait, or an integer overflow would happen resulting in a very long wait.\r\n\r\nBTW: there is also a time_wait that takes an [absolute system time](http://www.boost.org/doc/libs/1_56_0/doc/html/thread/synchronization.html#thread.synchronization.condvar_ref.condition_variable.timed_wait), would that be useful here?",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-08-25T07:39:14Z",
      "diff_hunk" : "@@ -103,6 +103,39 @@ void static inline AssertLockHeldInternal(const char* pszName, const char* pszFi\n void PrintLockContention(const char* pszName, const char* pszFile, int nLine);\n #endif\n \n+class CTimeoutCondition\n+{\n+private:\n+    boost::condition_variable condition;\n+    boost::mutex mutex;\n+    bool fHasWork;\n+    boost::posix_time::ptime alarm;\n+\n+public:\n+    void wait() {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        while (!fHasWork) {\n+            condition.wait(lock);\n+        }\n+        fHasWork = false;\n+    }\n+\n+    void timed_wait(int milliseconds) {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        alarm = boost::posix_time::microsec_clock::universal_time() + boost::posix_time::milliseconds(milliseconds);\n+        while (!fHasWork && boost::posix_time::microsec_clock::universal_time() < alarm) {\n+            condition.timed_wait(lock, alarm - boost::posix_time::microsec_clock::universal_time());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16644924",
      "id" : 16644924,
      "original_commit_id" : "c4879b1bc398a18cce3f0410f0b04aaf4b52ae93",
      "original_position" : 25,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16644924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16650952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16650952"
         }
      },
      "body" : "I just pushed a patch which changes it to use the absolute version.  I tested and it is still waking up after 1 second as expected.",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-08-25T11:30:01Z",
      "diff_hunk" : "@@ -103,6 +103,39 @@ void static inline AssertLockHeldInternal(const char* pszName, const char* pszFi\n void PrintLockContention(const char* pszName, const char* pszFile, int nLine);\n #endif\n \n+class CTimeoutCondition\n+{\n+private:\n+    boost::condition_variable condition;\n+    boost::mutex mutex;\n+    bool fHasWork;\n+    boost::posix_time::ptime alarm;\n+\n+public:\n+    void wait() {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        while (!fHasWork) {\n+            condition.wait(lock);\n+        }\n+        fHasWork = false;\n+    }\n+\n+    void timed_wait(int milliseconds) {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        alarm = boost::posix_time::microsec_clock::universal_time() + boost::posix_time::milliseconds(milliseconds);\n+        while (!fHasWork && boost::posix_time::microsec_clock::universal_time() < alarm) {\n+            condition.timed_wait(lock, alarm - boost::posix_time::microsec_clock::universal_time());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16650952",
      "id" : 16650952,
      "original_commit_id" : "c4879b1bc398a18cce3f0410f0b04aaf4b52ae93",
      "original_position" : 25,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16650952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4230_5eef5a482ce8be3c4d34605bf2dc1e57c5b4bb55/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-08-25T11:40:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53253739",
      "id" : 53253739,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-25T11:40:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53253739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16715585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16715585"
         }
      },
      "body" : "An alternative:\r\n```\r\nauto now = boost::posix_time::microsec_clock::universal_time();\r\nalarm = now + boost::posix_time::milliseconds(milliseconds);\r\nwhile (!fHasWork && now < alarm) {\r\n    condition.timed_wait(lock, alarm);\r\n    now = boost::posix_time::microsec_clock::universal_time();\r\n}\r\nfHasWork = false;\r\n",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-08-26T14:17:53Z",
      "diff_hunk" : "@@ -103,6 +103,39 @@ void static inline AssertLockHeldInternal(const char* pszName, const char* pszFi\n void PrintLockContention(const char* pszName, const char* pszFile, int nLine);\n #endif\n \n+class CTimeoutCondition\n+{\n+private:\n+    boost::condition_variable condition;\n+    boost::mutex mutex;\n+    bool fHasWork;\n+    boost::posix_time::ptime alarm;\n+\n+public:\n+    void wait() {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        while (!fHasWork) {\n+            condition.wait(lock);\n+        }\n+        fHasWork = false;\n+    }\n+\n+    void timed_wait(int milliseconds) {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        alarm = boost::posix_time::microsec_clock::universal_time() + boost::posix_time::milliseconds(milliseconds);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16715585",
      "id" : 16715585,
      "original_commit_id" : "5eef5a482ce8be3c4d34605bf2dc1e57c5b4bb55",
      "original_position" : 23,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16715585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2014-08-27T20:00:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53631614",
      "id" : 53631614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-27T20:00:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53631614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16830203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16830203"
         }
      },
      "body" : "I suppose that will mean one less call to boost::posix_time::microsec_clock::universal_time(), so I will use that.",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-08-28T09:54:47Z",
      "diff_hunk" : "@@ -103,6 +103,39 @@ void static inline AssertLockHeldInternal(const char* pszName, const char* pszFi\n void PrintLockContention(const char* pszName, const char* pszFile, int nLine);\n #endif\n \n+class CTimeoutCondition\n+{\n+private:\n+    boost::condition_variable condition;\n+    boost::mutex mutex;\n+    bool fHasWork;\n+    boost::posix_time::ptime alarm;\n+\n+public:\n+    void wait() {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        while (!fHasWork) {\n+            condition.wait(lock);\n+        }\n+        fHasWork = false;\n+    }\n+\n+    void timed_wait(int milliseconds) {\n+        boost::unique_lock<boost::mutex> lock(mutex);\n+        alarm = boost::posix_time::microsec_clock::universal_time() + boost::posix_time::milliseconds(milliseconds);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16830203",
      "id" : 16830203,
      "original_commit_id" : "5eef5a482ce8be3c4d34605bf2dc1e57c5b4bb55",
      "original_position" : 23,
      "path" : "src/sync.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16830203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Automatic sanity-testing: FAILED MERGE, see http://jenkins.bluematt.me/pull-tester/p4230_eebbb0be605d37e9a4dd5079695ab59258886f67/ for test log.\n\nThis pull does not merge cleanly onto current master\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-08-28T10:20:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53701833",
      "id" : 53701833,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-28T10:20:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53701833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "Rebased and squashed.  Let me know if you need anything else!",
      "created_at" : "2014-08-28T11:24:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53707162",
      "id" : 53707162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-28T11:24:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53707162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4230_fe5491a91d7e500df90ef1d69bdc3d5dbabc6dc9/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-08-28T11:26:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53707313",
      "id" : 53707313,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-28T11:26:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53707313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4230_81da9c77b5e9a93fe2687061f68c29e0b94f36eb/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-08-28T12:08:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53710947",
      "id" : 53710947,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-28T12:08:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53710947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16870198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16870198"
         }
      },
      "body" : "Nit: As this is a function, can you start with ``{`` in the next line?",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-08-28T21:50:37Z",
      "diff_hunk" : "@@ -1594,14 +1596,138 @@ void ThreadMessageHandler()\n         }\n \n         if (fSleep)\n-            MilliSleep(100);\n+            condMessageHandler.timed_wait(1000);\n     }\n }\n \n+void ThreadTrickle () {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16870198",
      "id" : 16870198,
      "original_commit_id" : "81da9c77b5e9a93fe2687061f68c29e0b94f36eb",
      "original_position" : 114,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16870198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16933897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16933897"
         }
      },
      "body" : "Pushed a new patch with the brace moved.",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-08-31T09:58:56Z",
      "diff_hunk" : "@@ -1594,14 +1596,138 @@ void ThreadMessageHandler()\n         }\n \n         if (fSleep)\n-            MilliSleep(100);\n+            condMessageHandler.timed_wait(1000);\n     }\n }\n \n+void ThreadTrickle () {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16933897",
      "id" : 16933897,
      "original_commit_id" : "81da9c77b5e9a93fe2687061f68c29e0b94f36eb",
      "original_position" : 114,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16933897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4230_c75bae764b936fde9d691bbe39115286d486ad61/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-08-31T10:21:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-53983705",
      "id" : 53983705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-08-31T10:21:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53983705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16972194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16972194"
         }
      },
      "body" : "Why not push this conditional to the end with the other one?",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-09-02T06:44:54Z",
      "diff_hunk" : "@@ -662,6 +663,10 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes)\n         if (handled < 0)\n                 return false;\n \n+        if (msg.complete())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16972194",
      "id" : 16972194,
      "original_commit_id" : "c75bae764b936fde9d691bbe39115286d486ad61",
      "original_position" : 12,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16972194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16978428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16978428"
         }
      },
      "body" : "Done",
      "commit_id" : "28a7464bb7e851800c4924162ecd9d1ec5961288",
      "created_at" : "2014-09-02T09:47:30Z",
      "diff_hunk" : "@@ -662,6 +663,10 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes)\n         if (handled < 0)\n                 return false;\n \n+        if (msg.complete())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#discussion_r16978428",
      "id" : 16978428,
      "original_commit_id" : "c75bae764b936fde9d691bbe39115286d486ad61",
      "original_position" : 12,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4230",
      "updated_at" : "2014-09-02T09:47:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16978428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4230_28a7464bb7e851800c4924162ecd9d1ec5961288/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-09-02T10:00:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54131314",
      "id" : 54131314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-02T10:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54131314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "@laanwj @gmaxwell @jgarzik Care to review/test this?",
      "created_at" : "2014-09-05T21:19:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54682909",
      "id" : 54682909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-05T21:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54682909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I'm on it now. Thanks for the heads up this fell off my radar after the initial issues. Thanks for your patience @ashleyholman.",
      "created_at" : "2014-09-05T21:22:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54683188",
      "id" : 54683188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-05T21:22:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54683188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I've been testing this for quite a while time already, no problems. ACK.",
      "created_at" : "2014-09-06T02:44:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54700220",
      "id" : 54700220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-06T02:44:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54700220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Just did a (almost) full resync from this + #4834 as (one of the servers), with #4468 + #4834 as client. No problems, and the client reports low (~30ms) ping latencies during sync for that server.",
      "created_at" : "2014-09-08T17:24:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54855111",
      "id" : 54855111,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-08T17:25:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54855111",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I've had this running in valgrind for few days and run it through some paces, e.g. bouncing connections, flooding it with inbound connections and messages... Seems to be holding up well. Hurray.\r\n\r\nI'm somewhat concerned with peppering the code with wakeups. It's not always clear where they're needed and why, and I worry that if a future patch adds code that needs a wake that it will be missed. Is there some clean rule about where they're needed that I've missed?\r\n\r\nCan you help me understand why the wakes outside of RecieveMsg are actually required?\r\n\r\n(In theory, if the timout was reduced to 100ms we could merging back in the trickle thread, with just a check to prevent it from running too often... but I think it actually makes long term design sense to have a thread for periodic events; so I'm not opposed to that even though it does mean another couple megabytes of memory usage...)",
      "created_at" : "2014-09-08T22:27:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54896946",
      "id" : 54896946,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-08T22:27:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54896946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "The wakeups were placed according to an audit I did, [detailed in this comment](https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48549858).  I was looking for places in the code that changed any state that would cause new messages to send next time SendMessages() runs.  But upon thinking about this further, most of the times when that state is changed, it's happening during ProcessMessage(), which is always followed by SendMessages() anyway, so it looks like most of those can be removed.  In the other cases, it might not be so important, like when an RPC 'ping' command is issued, maybe it's fine to wait until the next ThreadMessageHandler run (max 1 second) to send the pings.\r\n\r\nHowever there is one event that I think is important to wake up on, which is PushInventory().  This gets called from ActivateBestChain() when we have a new block.  To speed up propagation time, it should wake the message handler immediately so that it can send the INVs out to all peers right away.\r\n\r\nRe: the separate trickle thread, both options were considered and I ended up [taking advice from @laanwj](https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-48292633) to have a new thread.",
      "created_at" : "2014-09-09T08:43:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54940551",
      "id" : 54940551,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-09T08:43:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54940551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I would leave the trickle as a separate thread (it's some extra memory, but it's a simple to understand model), and moving part of the protocol handling out of main is also nice.\r\n\r\nIf every processmessage call is followed by a sendmessage call, I would suggest removing the Wake calls in the processmessage path (note that ActivateBestChain is also only called from within ProcessMessage...). Are there any wakes left that are 1) outside of this path and for which 2) sub-second latency matters?",
      "created_at" : "2014-09-09T15:00:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-54982253",
      "id" : 54982253,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-09T15:00:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54982253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Undo ACK.\r\n\r\nI missed something. The trickle thread will call SendMessages with fSendTrickle, but all non-trickle behaviour therein will also run. This means many more data structures that are potentially accessed from multiple threads (just saw a use-after-reallocate in valgrind).\r\n\r\nIf we need the trickle thread, I would suggest creating a new entry in CNodeSignals for the trickling, and for handlers that need it, they can independently register that. This means that the current (in this PR) code from main.cpp's SendMessages will be split up over two functions, which potentially run in parallel (so all data structures shared between them need locking).",
      "created_at" : "2014-09-09T18:58:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-55016474",
      "id" : 55016474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-09T18:59:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55016474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "For some reason I thought ActivateBestChain() would have been called from another thread that does block validation.  But still, I'm still thinking it requires the wakeup because it needs to send a messages to *all* peers.  We can only guarantee that SendMessages is going to run for the *current* peer who sent the block, plus any other peers that come after it in the vNodes list.",
      "created_at" : "2014-09-09T19:41:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-55022122",
      "id" : 55022122,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-09T19:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55022122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "@sipa:  SendMessages in main is locking pto->cs_vSend, so shouldn't that prevent two threads from running it concurrently for the same CNode?  SendMessagesNet does the same with pto->cs_vSend.\r\n\r\nThe only potential concurrency I can see from code outside of those functions is with access to CNode::vAddrToSend.  There are a few places that are either accessing vAddrToSend directly, or using PushAddress.  If I add a lock for all vAddrToSend operations, would that fix it?",
      "created_at" : "2014-09-15T10:50:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-55575435",
      "id" : 55575435,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-09-15T10:50:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55575435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "I'm ready to give this some attention again.  It feels like it is close, so it would be good to try to get it over the line and integrated.  The only issue I am aware of is the race condition identified by @sipa.  If there needs to be significant refactoring to deal with this then let me know.  Otherwise if there's some simpler way to fix it then that would be good, considering all the testing that has already been done.",
      "created_at" : "2014-10-13T20:08:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-58947365",
      "id" : 58947365,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-10-13T20:08:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58947365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Independently, I would really prefer to see a separate Trickle handler, where the trickle behavior and nothing else runs, from the trickle thread. It's hard enough to reason about the correctness already.",
      "created_at" : "2014-10-13T21:00:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-58954035",
      "id" : 58954035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-10-13T21:00:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58954035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I'd really like to see this get in soon, but I'm still uncomfortable with the manual wakeups, which I think we'll never manage to keep updated correctly.",
      "created_at" : "2014-10-13T21:03:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-58954463",
      "id" : 58954463,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-10-13T21:03:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58954463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Moved the milestone to 0.11 -  I agree this should get in, but this is not ready yet, and a high-impact network code change like this needs some time to be tested in master after being merged.",
      "created_at" : "2014-10-18T09:13:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-59604360",
      "id" : 59604360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-10-18T09:13:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/59604360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj   I think we were thinking that its possible to achieve this with a much smaller and simpler diff (e.g. one that wakes immediately on recieved but still polls so that we're sure it's safe with no sprinkled wakeups).\r\n\r\nI think this delay is currently the biggest latency source for block propagation on the network.",
      "created_at" : "2014-10-20T18:58:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4230#issuecomment-59820927",
      "id" : 59820927,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4230",
      "updated_at" : "2014-10-20T18:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/59820927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
