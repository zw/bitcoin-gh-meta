[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26295](https://github.com/bitcoin/bitcoin/pull/26295) (Replace global g_cs_orphans lock with local by ajtowns)\n* [#26247](https://github.com/bitcoin/bitcoin/pull/26247) (refactor: Make m_mempool optional in PeerManager by MarcoFalke)\n* [#25880](https://github.com/bitcoin/bitcoin/pull/25880) (p2p: Make stalling timeout adaptive during IBD by mzumsande)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-09-21T23:31:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1254335067",
      "id" : 1254335067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585Kw6Jb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254335067/reactions"
      },
      "updated_at" : "2022-10-19T00:59:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254335067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Originally suggested in https://github.com/bitcoin/bitcoin/pull/19988#discussion_r497882360",
      "created_at" : "2022-09-22T08:12:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1254679797",
      "id" : 1254679797,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585KyOT1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254679797/reactions"
      },
      "updated_at" : "2022-09-22T08:12:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1254679797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977353232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977353232"
         }
      },
      "author_association" : "MEMBER",
      "body" : "linter is sad about tabs being used here",
      "commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "created_at" : "2022-09-22T08:27:22Z",
      "diff_hunk" : "@@ -534,8 +538,10 @@ class TxRequestTracker::Impl {\n     Impl(const Impl&) = delete;\n     Impl& operator=(const Impl&) = delete;\n \n-    void DisconnectedPeer(NodeId peer)\n+    void DisconnectedPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_txrequest_mutex)\n     {\n+\t\tLOCK(m_txrequest_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977353232",
      "id" : 977353232,
      "line" : 543,
      "node_id" : "PRRC_kwDOABII5846QToQ",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 543,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 101,
      "pull_request_review_id" : 1116604511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977353232/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T08:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977353232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977393667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977393667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Comment is no longer correct; it's now needed for `CNodeState* state = State(nodeid)` but not `m_txrequest`, I think.",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-22T09:01:42Z",
      "diff_hunk" : "@@ -1399,6 +1399,7 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n void PeerManagerImpl::AddTxAnnouncement(const CNode& node, const GenTxid& gtxid, std::chrono::microseconds current_time)\n {\n     AssertLockHeld(::cs_main); // For m_txrequest\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977393667",
      "id" : 977393667,
      "line" : 1402,
      "node_id" : "PRRC_kwDOABII5846QdgD",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 1402,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 1116661944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977393667/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T10:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977393667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977396520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977396520"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Enclosing `{ .. }` are no longer needed.\r\n\r\nThis change gives decreases the length of time `cs_main` is held.",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-22T09:04:20Z",
      "diff_hunk" : "@@ -1817,7 +1818,6 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n         }\n     }\n     {\n-        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977396520",
      "id" : 977396520,
      "line" : 1820,
      "node_id" : "PRRC_kwDOABII5846QeMo",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 1820,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 1116661944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977396520/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T10:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977396520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977401382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977401382"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not this PR's fault, but `{` should be on a new line, and maybe add `private:` to make it clear these are private members?",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-22T09:08:59Z",
      "diff_hunk" : "@@ -307,6 +307,8 @@ GenTxid ToGenTxid(const Announcement& ann)\n \n /** Actual implementation for TxRequestTracker's data structure. */\n class TxRequestTracker::Impl {\n+    mutable Mutex m_txrequest_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977401382",
      "id" : 977401382,
      "line" : 312,
      "node_id" : "PRRC_kwDOABII5846QfYm",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 312,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 8,
      "pull_request_review_id" : 1116661944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977401382/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T10:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977401382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977401873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977401873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're adding a `Mutex`, I think all these members should also be `GUARDED_BY` that mutex.",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-22T09:09:28Z",
      "diff_hunk" : "@@ -307,6 +307,8 @@ GenTxid ToGenTxid(const Announcement& ann)\n \n /** Actual implementation for TxRequestTracker's data structure. */\n class TxRequestTracker::Impl {\n+    mutable Mutex m_txrequest_mutex;\n+\n     //! The current sequence number. Increases for every announcement. This is used to sort txhashes returned by\n     //! GetRequestable in announcement order.\n     SequenceNumber m_current_sequence{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977401873",
      "id" : 977401873,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5846QfgR",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 314,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : null,
      "pull_request_review_id" : 1116661944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977401873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T10:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977401873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @jnewbery for linking the previous discussion! I was looking through the old PRs yesterday and didn't come across that comment.\r\n\r\n> If there's to be a separate lock, I'm not convinced it makes sense to push the lock all the way into the Impl class -- having m_impl GUARDED_BY(m_impl_mutex) in TxRequestTracker, or having m_txrequest GUARDED_BY(m_txrequest_mutex) seem more sensible to me, and the latter allows you to take the lock outside of the various for loops, rather than repeatedly taking it and dropping it on each iteration.\r\n\r\n@ajtowns I'm not sure if I am on the same page about this but I am willing to be convinced. I used `AddrMan` (and the dev notes) as a reference for choosing the current design (i.e. putting the lock inside the `Impl` class).\r\n* Would you be in favor of refactoring our existing modules to externalize their locks? (e.g. `AddrManImpl::cs`)\r\n* Should our developer docs be updated? (I think our lock conventions are a bit all over the place, similar to general coding style, so maybe it helps to clarify our preferences?)\r\n\r\n> I think the arguments from the original PR still apply though -- this doesn't meaningfully allow any more parallelism / reduce blocking as far as I can see.\r\n\r\nI have been looking at reducing `cs_main` usage within net processing because I don't think that our networking code should be locking `cs_main` (our main validation lock) as much as it currently does. Reducing the scope of `cs_main` to validation seems like a good direction to be heading in (especially w.r.t. the kernel project). This PR seemed like an easy small step in that direction (similar to #26140) as it does remove two `LOCK(cs_main)` call sites.",
      "created_at" : "2022-09-22T15:01:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1255156521",
      "id" : 1255156521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585K0Csp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1255156521/reactions"
      },
      "updated_at" : "2022-09-22T15:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1255156521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977805535"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805535"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed the comment",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-22T15:32:51Z",
      "diff_hunk" : "@@ -1399,6 +1399,7 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n void PeerManagerImpl::AddTxAnnouncement(const CNode& node, const GenTxid& gtxid, std::chrono::microseconds current_time)\n {\n     AssertLockHeld(::cs_main); // For m_txrequest\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977805535",
      "id" : 977805535,
      "in_reply_to_id" : 977393667,
      "line" : 1402,
      "node_id" : "PRRC_kwDOABII5846SCDf",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 1402,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 1117275417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805535/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T15:34:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977805579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805579"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-22T15:32:53Z",
      "diff_hunk" : "@@ -1817,7 +1818,6 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n         }\n     }\n     {\n-        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977805579",
      "id" : 977805579,
      "in_reply_to_id" : 977396520,
      "line" : 1820,
      "node_id" : "PRRC_kwDOABII5846SCEL",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 1820,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 1117275417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805579/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T15:34:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977805824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805824"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-22T15:33:02Z",
      "diff_hunk" : "@@ -307,6 +307,8 @@ GenTxid ToGenTxid(const Announcement& ann)\n \n /** Actual implementation for TxRequestTracker's data structure. */\n class TxRequestTracker::Impl {\n+    mutable Mutex m_txrequest_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r977805824",
      "id" : 977805824,
      "in_reply_to_id" : 977401382,
      "line" : 312,
      "node_id" : "PRRC_kwDOABII5846SCIA",
      "original_commit_id" : "7f9a893687067893f2de6c9a406c6366d07a89cc",
      "original_line" : 312,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 8,
      "pull_request_review_id" : 1117275417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-22T15:34:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/977805824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @ajtowns I'm not sure if I am on the same page about this but I am willing to be convinced. I used `AddrMan` (and the dev notes) as a reference for choosing the current design (i.e. putting the lock inside the `Impl` class).\r\n> \r\n>     * Would you be in favor of refactoring our existing modules to externalize their locks? (e.g. `AddrManImpl::cs`)\r\n\r\nIn general, I think it's better to leave things alone if we're not making things substantially more reliable/simple/efficient.\r\n\r\nFor locking, I think the best approach on all of those axes is \"having a reference to an object means you can manipulate it; if you can't manipulate it, you don't have a reference to in the first place\"; but that's often hard to achieve.\r\n\r\nMaybe compare with what @vasild's proposing in #25390 -- with that you'd just say `Synced<TxRequestTracker> m_txrequest` and write either `m_txrequest->Foo();` to do a single operation that takes then releases the lock, or `{ auto proxy = *m_txrequest; proxy->Foo(); proxy->Bar(); }` to do multiple operations while the lock's held. Meanwhile, if you're not doing threading (like in the unit/fuzz tests) you just allocate a `TxRequestTracker` directly, and don't worry about locks at all. (Unfortunately, I don't think the implementation there quite works right/clang isn't clever enough to properly understand it, and I haven't been able to come up with a better one. Err, except, maybe...)\r\n\r\n> I have been looking at reducing `cs_main` usage within net processing because I don't think that our networking code should be locking `cs_main` (our main validation lock) as much as it currently does. Reducing the scope of `cs_main` to validation seems like a good direction to be heading in (especially w.r.t. the kernel project). This PR seemed like an easy small step in that direction (similar to #26140) as it does remove two `LOCK(cs_main)` call sites.\r\n\r\nYeah... Kind of feel like it's probably better spending coding/review time on the hard steps though? For `cs_main`, having dedicated, non-global, locks for blockstorage, block indexes, and coin states, so that you don't need `cs_main` there, seems like the priority. For net, getting rid of `CNodeState` entirely and passing around `Peer&` objects seems worthwhile, and I think maybe adding an opaque `PeerRef` to `CNode` would allow avoiding the extra `map` and ensure the `Peer` object doesn't get deallocated before the `CNode` object does... We could also perhaps have more things under \"only accessed by the message processing thread\" by having that thread make read-only copies of the data available to other threads in advance, which would then reduce contention...",
      "created_at" : "2022-09-23T04:34:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1255791919",
      "id" : 1255791919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585K2d0v",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1255791919/reactions"
      },
      "updated_at" : "2022-09-23T04:34:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1255791919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2022-09-23T10:27:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1256043221",
      "id" : 1256043221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585K3bLV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1256043221/reactions"
      },
      "updated_at" : "2022-09-23T10:27:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1256043221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Maybe compare with what @vasild's proposing in #25390 -- with that you'd just say `Synced<TxRequestTracker> m_txrequest` and write either `m_txrequest->Foo();` to do a single operation that takes then releases the lock, or `{ auto proxy = *m_txrequest; proxy->Foo(); proxy->Bar(); }` to do multiple operations while the lock's held.\r\n\r\nIt makes me think that such an issue should be resolved at `TxRequestTracker` class's API level. An object which self maintains its state in multi-threading environment is preferable (less error prone, easy to reason about etc).",
      "created_at" : "2022-09-23T10:43:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1256056443",
      "id" : 1256056443,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585K3eZ7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1256056443/reactions"
      },
      "updated_at" : "2022-09-23T10:43:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1256056443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r982362560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982362560"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: \"txrequest\" is already in the name of the class and looks redundant to have it also in the name of the variable. I think `m_mutex` is ok too.",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-28T12:49:27Z",
      "diff_hunk" : "@@ -306,23 +306,28 @@ GenTxid ToGenTxid(const Announcement& ann)\n }  // namespace\n \n /** Actual implementation for TxRequestTracker's data structure. */\n-class TxRequestTracker::Impl {\n+class TxRequestTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txrequest_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r982362560",
      "id" : 982362560,
      "line" : 312,
      "node_id" : "PRRC_kwDOABII5846janA",
      "original_commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "original_line" : 312,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 8,
      "pull_request_review_id" : 1123626545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982362560/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-28T13:24:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982362560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r983957529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983957529"
         }
      },
      "author_association" : "NONE",
      "body" : "I know this question is not in the scope of this PR but appreciate the answer. Why there is a separation between `TxRequestTracker` and it's implementation? The comments says: ` Avoid littering this header file with implementation details.`\r\nIs the clarity and readability of code, the whole point of this separation? If yes, is this a common design pattern?",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-29T19:44:06Z",
      "diff_hunk" : "@@ -306,23 +306,28 @@ GenTxid ToGenTxid(const Announcement& ann)\n }  // namespace\n \n /** Actual implementation for TxRequestTracker's data structure. */\n-class TxRequestTracker::Impl {\n+class TxRequestTracker::Impl",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r983957529",
      "id" : 983957529,
      "line" : 309,
      "node_id" : "PRRC_kwDOABII5846pgAZ",
      "original_commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "original_line" : 309,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 5,
      "pull_request_review_id" : 1125902374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983957529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-29T19:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/983957529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/54557628?v=4",
         "events_url" : "https://api.github.com/users/Riahiamirreza/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Riahiamirreza/followers",
         "following_url" : "https://api.github.com/users/Riahiamirreza/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Riahiamirreza/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Riahiamirreza",
         "id" : 54557628,
         "login" : "Riahiamirreza",
         "node_id" : "MDQ6VXNlcjU0NTU3NjI4",
         "organizations_url" : "https://api.github.com/users/Riahiamirreza/orgs",
         "received_events_url" : "https://api.github.com/users/Riahiamirreza/received_events",
         "repos_url" : "https://api.github.com/users/Riahiamirreza/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Riahiamirreza/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Riahiamirreza/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Riahiamirreza"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r984107339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984107339"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That's exactly the point. It's called the \"pimpl pattern\" (pointer to impl class) -- https://cpppatterns.com/patterns/pimpl.html",
      "commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "created_at" : "2022-09-30T00:03:59Z",
      "diff_hunk" : "@@ -306,23 +306,28 @@ GenTxid ToGenTxid(const Announcement& ann)\n }  // namespace\n \n /** Actual implementation for TxRequestTracker's data structure. */\n-class TxRequestTracker::Impl {\n+class TxRequestTracker::Impl",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r984107339",
      "id" : 984107339,
      "in_reply_to_id" : 983957529,
      "line" : 309,
      "node_id" : "PRRC_kwDOABII5846qElL",
      "original_commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "original_line" : 309,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 5,
      "pull_request_review_id" : 1126114802,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984107339/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T00:04:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984107339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r984368415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984368415"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We also had a review club on this a while ago, if you are interested: https://bitcoincore.reviews/22950",
      "commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "created_at" : "2022-09-30T08:52:05Z",
      "diff_hunk" : "@@ -306,23 +306,28 @@ GenTxid ToGenTxid(const Announcement& ann)\n }  // namespace\n \n /** Actual implementation for TxRequestTracker's data structure. */\n-class TxRequestTracker::Impl {\n+class TxRequestTracker::Impl",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r984368415",
      "id" : 984368415,
      "in_reply_to_id" : 983957529,
      "line" : 309,
      "node_id" : "PRRC_kwDOABII5846rEUf",
      "original_commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "original_line" : 309,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 5,
      "pull_request_review_id" : 1126492377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984368415/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T08:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984368415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r984376327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984376327"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, also here: https://en.cppreference.com/w/cpp/language/pimpl \"This technique is used to construct C++ library interfaces with stable ABI and to reduce compile-time dependencies.\"\r\n\r\nWhat it does for us in practice is to reduce _re_-compilation times - if everything is compiled and some private member is changed then only the `cpp` file will be recompiled instead of all files that include the `h` file.\r\n\r\nImproving clarity and readability is not mentioned anywhere in any of the pimpl articles I checked.",
      "commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "created_at" : "2022-09-30T09:00:30Z",
      "diff_hunk" : "@@ -306,23 +306,28 @@ GenTxid ToGenTxid(const Announcement& ann)\n }  // namespace\n \n /** Actual implementation for TxRequestTracker's data structure. */\n-class TxRequestTracker::Impl {\n+class TxRequestTracker::Impl",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r984376327",
      "id" : 984376327,
      "in_reply_to_id" : 983957529,
      "line" : 309,
      "node_id" : "PRRC_kwDOABII5846rGQH",
      "original_commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "original_line" : 309,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : 5,
      "pull_request_review_id" : 1126504803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984376327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-30T09:00:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/984376327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Could also move it out of the cs_main scope in `FinalizeNode`?",
      "created_at" : "2022-10-04T11:10:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1266785493",
      "id" : 1266785493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585LgZzV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1266785493/reactions"
      },
      "updated_at" : "2022-10-04T11:10:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1266785493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-10-17T17:45:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1281233536",
      "id" : 1281233536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585MXhKA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1281233536/reactions"
      },
      "updated_at" : "2022-10-17T17:45:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1281233536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r998482143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998482143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Renamed.\r\n\r\nI have seen nits on other PRs suggesting the exact reverse, which is why i named it this way in the first place, hoping to avoid the nit  But i actually kind of agree that its redundant, so i shouldn't have preemptively tried to avoid the nit.",
      "commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "created_at" : "2022-10-18T16:48:03Z",
      "diff_hunk" : "@@ -306,23 +306,28 @@ GenTxid ToGenTxid(const Announcement& ann)\n }  // namespace\n \n /** Actual implementation for TxRequestTracker's data structure. */\n-class TxRequestTracker::Impl {\n+class TxRequestTracker::Impl\n+{\n+private:\n+    mutable Mutex m_txrequest_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r998482143",
      "id" : 998482143,
      "in_reply_to_id" : 982362560,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847g6Df",
      "original_commit_id" : "2ac77c4b5ef095846924be3c91e02967e8177abf",
      "original_line" : 312,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txrequest.cpp",
      "position" : null,
      "pull_request_review_id" : 1146185865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998482143/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T16:48:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998482143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased, added a method to remove multiple transactions from the tracker at once (to avoid locking the internal lock over and over again), and renamed `m_txrequest_mutex` -> `m_mutex`. ",
      "created_at" : "2022-10-18T16:50:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1282699665",
      "id" : 1282699665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585MdHGR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1282699665/reactions"
      },
      "updated_at" : "2022-10-18T16:50:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1282699665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1001715924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1001715924"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n\r\n```suggestion\r\n    m_txrequest.ForgetTxs(pblock->vtx);\r\n```",
      "commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "created_at" : "2022-10-21T12:12:35Z",
      "diff_hunk" : "@@ -1819,13 +1820,8 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             }\n         }\n     }\n-    {\n-        LOCK(cs_main);\n-        for (const auto& ptx : pblock->vtx) {\n-            m_txrequest.ForgetTxHash(ptx->GetHash());\n-            m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n-        }\n-    }\n+\n+    m_txrequest.ForgetTxs(Span{pblock->vtx});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1001715924",
      "id" : 1001715924,
      "line" : 1824,
      "node_id" : "PRRC_kwDOABII5847tPjU",
      "original_commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "original_line" : 1824,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 1150851664,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1001715924/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-21T12:12:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1001715924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Could also move it out of the cs_main scope in `FinalizeNode`?\r\n\r\nI am not sure about it. In `PeerManagerImpl::FinalizeNode()`:\r\n\r\n```cpp\r\nLOCK(cs_main);\r\n...\r\nm_txrequest.DisconnectedPeer(nodeid);\r\n...\r\nassert(m_txrequest.Size() == 0);\r\n```\r\n\r\nhmm, wait! is that a bug in this PR? If somebody modifies (adds to) `m_txrequest` after `DisconnectedPeer()` and before the `assert()` then the `assert()` will be triggered. And the point of this PR is to be able to access (add to) `m_txrequest` without `cs_main` from anywhere :bomb: :fire:\r\n\r\nMaybe return the size from `DisconnectedPeer()` after the deletion and later assert that the returned size was `0` in `FinalizeNode()`?",
      "created_at" : "2022-10-21T12:29:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1286897751",
      "id" : 1286897751,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585MtIBX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1286897751/reactions"
      },
      "updated_at" : "2022-10-21T12:29:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1286897751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> hmm, wait! is that a bug in this PR? If somebody modifies (adds to) m_txrequest after DisconnectedPeer() and before the assert() then the assert() will be triggered. And the point of this PR is to be able to access (add to) m_txrequest without cs_main from anywhere\r\n\r\nI don't think it is currently but it almost is! The `assert(m_txrequest.Size() == 0);` is gated by `if (m_node_state.empty())` so no other peer can modify (add txs) `m_txrequest`.\r\n\r\nI will still change this as that seems a little brittle wrt future changes.\r\n\r\n",
      "created_at" : "2022-10-21T12:59:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1286929566",
      "id" : 1286929566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585MtPye",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1286929566/reactions"
      },
      "updated_at" : "2022-10-21T12:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1286929566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "How? It seems that the assumption in `FinalizeNode()` is that `m_node_state` is modified together/atomically with `m_txrequest`.\r\n\r\nYes, the current code is fine, but then it is fine even without this PR. The aim is to make it future proof.\r\n\r\nReturning the size from `DisconnectedPeer()` like I suggested above seems to have its own (theoretical) flaw - it could return `1`, afterwards `m_node_state` could become empty by another thread, we would enter the `if` and the assert would fail because 1 != 0.\r\n\r\nMaybe just delete the assert? Or expose the mutex of `m_txrequest`, lock it before `DisconnectedPeer()` and unlock it after the assert :question: ",
      "created_at" : "2022-10-22T07:55:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1287668864",
      "id" : 1287668864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26151",
      "node_id" : "IC_kwDOABII585MwESA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1287668864/reactions"
      },
      "updated_at" : "2022-10-22T07:55:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1287668864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1003216463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003216463"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if this is correct. While `m_txrequest` has an internal mutex to guard against UB, the internal mutex does nothing to guard the processing logic. A mutex different from the internal one is still needed here to guard against several threads calling into this function at the same time.",
      "commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "created_at" : "2022-10-24T11:43:30Z",
      "diff_hunk" : "@@ -1395,7 +1395,8 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n \n void PeerManagerImpl::AddTxAnnouncement(const CNode& node, const GenTxid& gtxid, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main); // For m_txrequest\n+    AssertLockHeld(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1003216463",
      "id" : 1003216463,
      "line" : 1398,
      "node_id" : "PRRC_kwDOABII5847y95P",
      "original_commit_id" : "5a031f27ff330db73cfd32672239591a88e49cfd",
      "original_line" : 1398,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1153002494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003216463/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-24T11:43:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003216463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1003329238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003329238"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hm I think you're right. Also seems similar to what Vasil [mentioned](https://github.com/bitcoin/bitcoin/pull/26151#issuecomment-1286897751), when we call methods on `m_txrequest` but expect the internal state between those calls not to change, then the internal mutex won't help us. afaict the changes here don't break anything because `cs_main` is still held in these places but I am trying to seperate `m_txrequest` from `cs_main` so `cs_main` should not be needed for any of this after the PR. Will mark as draft until I figure out how to address this. (Seems like the only way to address this is to change the `TxRequestTracker` interface)",
      "commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "created_at" : "2022-10-24T13:41:25Z",
      "diff_hunk" : "@@ -1395,7 +1395,8 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n \n void PeerManagerImpl::AddTxAnnouncement(const CNode& node, const GenTxid& gtxid, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main); // For m_txrequest\n+    AssertLockHeld(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1003329238",
      "id" : 1003329238,
      "in_reply_to_id" : 1003216463,
      "line" : 1398,
      "node_id" : "PRRC_kwDOABII5847zZbW",
      "original_commit_id" : "5a031f27ff330db73cfd32672239591a88e49cfd",
      "original_line" : 1398,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1153163734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003329238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-24T13:41:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003329238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1003344982"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003344982"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, an alternative would be to replace cs_main with g_msgproc_mutex?",
      "commit_id" : "1d72d4206df579483f8297acd163611fc294378e",
      "created_at" : "2022-10-24T13:54:52Z",
      "diff_hunk" : "@@ -1395,7 +1395,8 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, const Peer& peer)\n \n void PeerManagerImpl::AddTxAnnouncement(const CNode& node, const GenTxid& gtxid, std::chrono::microseconds current_time)\n {\n-    AssertLockHeld(::cs_main); // For m_txrequest\n+    AssertLockHeld(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26151#discussion_r1003344982",
      "id" : 1003344982,
      "in_reply_to_id" : 1003216463,
      "line" : 1398,
      "node_id" : "PRRC_kwDOABII5847zdRW",
      "original_commit_id" : "5a031f27ff330db73cfd32672239591a88e49cfd",
      "original_line" : 1398,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1153186019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26151",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003344982/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-24T13:54:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003344982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
