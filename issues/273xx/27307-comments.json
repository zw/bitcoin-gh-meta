[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28546](https://github.com/bitcoin/bitcoin/pull/28546) (bugfix: watchonly wallets created after migration have incorrect height values by ryanofsky)\n* [#28544](https://github.com/bitcoin/bitcoin/pull/28544) (wallet: Add TxStateString function for debugging and logging by ryanofsky)\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n* [#27782](https://github.com/bitcoin/bitcoin/pull/27782) (wallet: clarify replace fields in help output by torkelrogstad)\n* [#27286](https://github.com/bitcoin/bitcoin/pull/27286) (wallet: Keep track of the wallet's own transaction outputs in memory by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-03-22T21:30:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#issuecomment-1480287022",
      "id" : 1480287022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27307",
      "node_id" : "IC_kwDOABII585YO2Mu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1480287022/reactions"
      },
      "updated_at" : "2023-10-17T00:15:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1480287022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-27T19:04:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#issuecomment-1565654555",
      "id" : 1565654555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27307",
      "node_id" : "IC_kwDOABII585dUf4b",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565654555/reactions"
      },
      "updated_at" : "2023-05-27T19:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565654555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1244653007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244653007"
         }
      },
      "author_association" : "NONE",
      "body" : "What do you think of renaming the `TxStateConflicted` struct to `TxStateBlockConflicted`, since that one is used for block conflicts and there is now a difference here between block and mempool conflicts?",
      "commit_id" : "0538ad7d4cfddb5a377f879cbf221b2b028c264a",
      "created_at" : "2023-06-28T04:26:28Z",
      "diff_hunk" : "@@ -315,7 +321,9 @@ class CWalletTx\n     template<typename T> T* state() { return std::get_if<T>(&m_state); }\n \n     bool isAbandoned() const { return state<TxStateInactive>() && state<TxStateInactive>()->abandoned; }\n-    bool isConflicted() const { return state<TxStateConflicted>(); }\n+    bool isConflicted() const { return state<TxStateConflicted>() || state<TxStateMempoolConflicted>(); }\n+    bool isMempoolConflicted() const { return state<TxStateMempoolConflicted>(); }\n+    bool isBlockConflicted() const { return state<TxStateConflicted>(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1244653007",
      "id" : 1244653007,
      "line" : 326,
      "node_id" : "PRRC_kwDOABII585KL-XP",
      "original_commit_id" : "0538ad7d4cfddb5a377f879cbf221b2b028c264a",
      "original_line" : 326,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.h",
      "position" : 43,
      "pull_request_review_id" : 1502236845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244653007/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-28T04:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244653007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11140095?v=4",
         "events_url" : "https://api.github.com/users/evansmj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/evansmj/followers",
         "following_url" : "https://api.github.com/users/evansmj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/evansmj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/evansmj",
         "id" : 11140095,
         "login" : "evansmj",
         "node_id" : "MDQ6VXNlcjExMTQwMDk1",
         "organizations_url" : "https://api.github.com/users/evansmj/orgs",
         "received_events_url" : "https://api.github.com/users/evansmj/received_events",
         "repos_url" : "https://api.github.com/users/evansmj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/evansmj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/evansmj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/evansmj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1245286239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245286239"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That makes sense, I'll do that using a [scripted diff.](https://github.com/bitcoin/bitcoin/blob/d6ee03507f39223889a5f039c4db7204ddfb91d5/doc/developer-notes.md#scripted-diffs)",
      "commit_id" : "0538ad7d4cfddb5a377f879cbf221b2b028c264a",
      "created_at" : "2023-06-28T14:15:18Z",
      "diff_hunk" : "@@ -315,7 +321,9 @@ class CWalletTx\n     template<typename T> T* state() { return std::get_if<T>(&m_state); }\n \n     bool isAbandoned() const { return state<TxStateInactive>() && state<TxStateInactive>()->abandoned; }\n-    bool isConflicted() const { return state<TxStateConflicted>(); }\n+    bool isConflicted() const { return state<TxStateConflicted>() || state<TxStateMempoolConflicted>(); }\n+    bool isMempoolConflicted() const { return state<TxStateMempoolConflicted>(); }\n+    bool isBlockConflicted() const { return state<TxStateConflicted>(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1245286239",
      "id" : 1245286239,
      "in_reply_to_id" : 1244653007,
      "line" : 326,
      "node_id" : "PRRC_kwDOABII585KOY9f",
      "original_commit_id" : "0538ad7d4cfddb5a377f879cbf221b2b028c264a",
      "original_line" : 326,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.h",
      "position" : 43,
      "pull_request_review_id" : 1503214745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245286239/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-28T14:15:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245286239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1270411973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270411973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://cirrus-ci.com/task/6496120092753920?logs=ci#L3132\r\n\r\n```\r\n test  2023-07-17T05:13:02.641000Z TestFramework (ERROR): Assertion failed \r\n                                   Traceback (most recent call last):\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 131, in main\r\n                                       self.run_test()\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/wallet_conflicts.py\", line 34, in run_test\r\n                                       self.test_mempool_and_block_conflicts()\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/wallet_conflicts.py\", line 219, in test_mempool_and_block_conflicts\r\n                                       assert_equal(len(alice.getrawmempool()), 0)\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/util.py\", line 57, in assert_equal\r\n                                       raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\n                                   AssertionError: not(1 == 0)",
      "commit_id" : "20d58f2554ba5cad1e6385a0f2d87b3750581442",
      "created_at" : "2023-07-21T08:46:08Z",
      "diff_hunk" : "@@ -123,5 +129,148 @@ def run_test(self):\n         assert_equal(former_conflicted[\"confirmations\"], 1)\n         assert_equal(former_conflicted[\"blockheight\"], 217)\n \n+    def test_mempool_conflict(self):\n+        self.nodes[0].createwallet(\"alice\")\n+        alice = self.nodes[0].get_wallet_rpc(\"alice\")\n+\n+        self.nodes[1].createwallet(\"bob\")\n+        bob = self.nodes[1].get_wallet_rpc(\"bob\")\n+\n+        self.generatetoaddress(self.nodes[0], COINBASE_MATURITY + 3, alice.getnewaddress())\n+\n+        self.log.info(\"Test a scenario where a transaction has a mempool conflict\")\n+\n+        unspents = [{\"txid\" : element[\"txid\"], \"vout\" : element[\"vout\"]} for element in alice.listunspent()]\n+        assert_equal(len(unspents), 3)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[0], unspents[1]], outputs=[{bob.getnewaddress() : 49.9999}])\n+        tx1 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[1], unspents[2]], outputs=[{bob.getnewaddress() : 49.99}])\n+        tx2 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[2]], outputs=[{bob.getnewaddress() : 24.9899}])\n+        tx3 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        tx1 = alice.sendrawtransaction(tx1)\n+\n+        assert_equal(alice.listunspent()[0][\"txid\"], unspents[2][\"txid\"])\n+        assert_equal(alice.getbalance(), 25)\n+\n+        tx2 = alice.sendrawtransaction(tx2)\n+\n+        # Check that the 0th unspent is now available because the transaction spending it has been replaced in the mempool\n+        assert_equal(alice.listunspent()[0][\"txid\"], unspents[0][\"txid\"])\n+        assert_equal(alice.getbalance(), 25)\n+\n+        assert_equal(alice.gettransaction(tx1)[\"mempoolconflicts\"], [tx2])\n+\n+        self.log.info(\"Test scenario where a mempool conflict is removed\")\n+\n+        tx3 = alice.sendrawtransaction(tx3)\n+\n+        assert_equal(alice.gettransaction(tx1)[\"mempoolconflicts\"], [])\n+\n+        # now all of alice's outputs should be considered spent\n+        assert_equal(alice.listunspent(), [])\n+        assert_equal(alice.getbalance(), 0)\n+\n+        alice.sendrawtransaction(alice.gettransaction(tx1)['hex'])\n+        self.generate(self.nodes[0], 3)\n+        assert_equal(alice.getbalance(), 75)\n+\n+    def test_mempool_and_block_conflicts(self):\n+        alice = self.nodes[0].get_wallet_rpc(\"alice\")\n+        bob = self.nodes[1].get_wallet_rpc(\"bob\")\n+\n+        self.log.info(\"Test a scenario where a transaction has both a block conflict and a mempool conflict\")\n+        unspents = [{\"txid\" : element[\"txid\"], \"vout\" : element[\"vout\"]} for element in alice.listunspent()]\n+\n+        assert_equal(bob.getbalances()[\"mine\"][\"untrusted_pending\"], 0)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[0]], outputs=[{bob.getnewaddress() : 24.99999}])\n+        raw_tx1 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+        tx1 = bob.sendrawtransaction(raw_tx1)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[0], unspents[2]], outputs=[{alice.getnewaddress() : 49.999}])\n+        tx1_conflict = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[2]], outputs=[{alice.getnewaddress() : 24.99}])\n+        tx1_conflict_conflict = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[1]], outputs=[{bob.getnewaddress() : 24.9999}])\n+        raw_tx2 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+        tx2 = bob.sendrawtransaction(raw_tx2)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[1]], outputs=[{alice.getnewaddress() : 24.9999}])\n+        tx2_conflict = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        bob_unspents = [{\"txid\" : element, \"vout\" : 0} for element in [tx1, tx2]]\n+\n+        assert_equal(bob.getbalances()[\"mine\"][\"untrusted_pending\"], Decimal(\"49.99989000\"))\n+\n+        raw_tx = bob.createrawtransaction(inputs=[bob_unspents[0], bob_unspents[1]], outputs=[{bob.getnewaddress() : 49.999}])\n+        raw_tx3 = bob.signrawtransactionwithwallet(raw_tx)['hex']\n+        tx3 = bob.sendrawtransaction(raw_tx3)\n+\n+        self.disconnect_nodes(0, 1)\n+\n+        # alice has all 0 txs, bob has 3\n+        assert_equal(len(alice.getrawmempool()), 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1270411973",
      "id" : 1270411973,
      "line" : 219,
      "node_id" : "PRRC_kwDOABII585LuPLF",
      "original_commit_id" : "42412c592e01960e77972321f1f6999342cb0c6c",
      "original_line" : 219,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : 111,
      "pull_request_review_id" : 1540742589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270411973/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-21T08:46:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270411973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1271448113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1271448113"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "20d58f2554ba5cad1e6385a0f2d87b3750581442",
      "created_at" : "2023-07-23T13:24:51Z",
      "diff_hunk" : "@@ -123,5 +129,148 @@ def run_test(self):\n         assert_equal(former_conflicted[\"confirmations\"], 1)\n         assert_equal(former_conflicted[\"blockheight\"], 217)\n \n+    def test_mempool_conflict(self):\n+        self.nodes[0].createwallet(\"alice\")\n+        alice = self.nodes[0].get_wallet_rpc(\"alice\")\n+\n+        self.nodes[1].createwallet(\"bob\")\n+        bob = self.nodes[1].get_wallet_rpc(\"bob\")\n+\n+        self.generatetoaddress(self.nodes[0], COINBASE_MATURITY + 3, alice.getnewaddress())\n+\n+        self.log.info(\"Test a scenario where a transaction has a mempool conflict\")\n+\n+        unspents = [{\"txid\" : element[\"txid\"], \"vout\" : element[\"vout\"]} for element in alice.listunspent()]\n+        assert_equal(len(unspents), 3)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[0], unspents[1]], outputs=[{bob.getnewaddress() : 49.9999}])\n+        tx1 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[1], unspents[2]], outputs=[{bob.getnewaddress() : 49.99}])\n+        tx2 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[2]], outputs=[{bob.getnewaddress() : 24.9899}])\n+        tx3 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        tx1 = alice.sendrawtransaction(tx1)\n+\n+        assert_equal(alice.listunspent()[0][\"txid\"], unspents[2][\"txid\"])\n+        assert_equal(alice.getbalance(), 25)\n+\n+        tx2 = alice.sendrawtransaction(tx2)\n+\n+        # Check that the 0th unspent is now available because the transaction spending it has been replaced in the mempool\n+        assert_equal(alice.listunspent()[0][\"txid\"], unspents[0][\"txid\"])\n+        assert_equal(alice.getbalance(), 25)\n+\n+        assert_equal(alice.gettransaction(tx1)[\"mempoolconflicts\"], [tx2])\n+\n+        self.log.info(\"Test scenario where a mempool conflict is removed\")\n+\n+        tx3 = alice.sendrawtransaction(tx3)\n+\n+        assert_equal(alice.gettransaction(tx1)[\"mempoolconflicts\"], [])\n+\n+        # now all of alice's outputs should be considered spent\n+        assert_equal(alice.listunspent(), [])\n+        assert_equal(alice.getbalance(), 0)\n+\n+        alice.sendrawtransaction(alice.gettransaction(tx1)['hex'])\n+        self.generate(self.nodes[0], 3)\n+        assert_equal(alice.getbalance(), 75)\n+\n+    def test_mempool_and_block_conflicts(self):\n+        alice = self.nodes[0].get_wallet_rpc(\"alice\")\n+        bob = self.nodes[1].get_wallet_rpc(\"bob\")\n+\n+        self.log.info(\"Test a scenario where a transaction has both a block conflict and a mempool conflict\")\n+        unspents = [{\"txid\" : element[\"txid\"], \"vout\" : element[\"vout\"]} for element in alice.listunspent()]\n+\n+        assert_equal(bob.getbalances()[\"mine\"][\"untrusted_pending\"], 0)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[0]], outputs=[{bob.getnewaddress() : 24.99999}])\n+        raw_tx1 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+        tx1 = bob.sendrawtransaction(raw_tx1)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[0], unspents[2]], outputs=[{alice.getnewaddress() : 49.999}])\n+        tx1_conflict = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[2]], outputs=[{alice.getnewaddress() : 24.99}])\n+        tx1_conflict_conflict = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[1]], outputs=[{bob.getnewaddress() : 24.9999}])\n+        raw_tx2 = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+        tx2 = bob.sendrawtransaction(raw_tx2)\n+\n+        raw_tx = alice.createrawtransaction(inputs=[unspents[1]], outputs=[{alice.getnewaddress() : 24.9999}])\n+        tx2_conflict = alice.signrawtransactionwithwallet(raw_tx)['hex']\n+\n+        bob_unspents = [{\"txid\" : element, \"vout\" : 0} for element in [tx1, tx2]]\n+\n+        assert_equal(bob.getbalances()[\"mine\"][\"untrusted_pending\"], Decimal(\"49.99989000\"))\n+\n+        raw_tx = bob.createrawtransaction(inputs=[bob_unspents[0], bob_unspents[1]], outputs=[{bob.getnewaddress() : 49.999}])\n+        raw_tx3 = bob.signrawtransactionwithwallet(raw_tx)['hex']\n+        tx3 = bob.sendrawtransaction(raw_tx3)\n+\n+        self.disconnect_nodes(0, 1)\n+\n+        # alice has all 0 txs, bob has 3\n+        assert_equal(len(alice.getrawmempool()), 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1271448113",
      "id" : 1271448113,
      "in_reply_to_id" : 1270411973,
      "line" : 219,
      "node_id" : "PRRC_kwDOABII585LyMIx",
      "original_commit_id" : "42412c592e01960e77972321f1f6999342cb0c6c",
      "original_line" : 219,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "test/functional/wallet_conflicts.py",
      "position" : 111,
      "pull_request_review_id" : 1542251974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1271448113/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-23T13:24:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1271448113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-17T19:42:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#issuecomment-1767055383",
      "id" : 1767055383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27307",
      "node_id" : "IC_kwDOABII585pUyAX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1767055383/reactions"
      },
      "updated_at" : "2023-10-17T19:42:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1767055383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1382141691"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1382141691"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 770a73c66a48434fa48f594709dbbf5831dc1d5d \"wallet: track mempool conflicts\"\r\n\r\nnit: `snake_case` for member variables.\r\n\r\nAdditionally, this is tracking these conflicts at the `CWallet` level. However I wonder if it might be better to track it on a transaction level, i.e. have `CWalletTx` have the set of txids.",
      "commit_id" : "a29849740becd62175a450b9c227bd7bfafe8a86",
      "created_at" : "2023-11-03T19:52:41Z",
      "diff_hunk" : "@@ -337,6 +337,9 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     void AddToSpends(const COutPoint& outpoint, const uint256& wtxid, WalletBatch* batch = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n     void AddToSpends(const CWalletTx& wtx, WalletBatch* batch = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n \n+    // Map of wtx hash to a set of mempool conflict hashes\n+    std::map<uint256, std::set<uint256>> MempoolConflicts GUARDED_BY(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1382141691",
      "id" : 1382141691,
      "line" : 341,
      "node_id" : "PRRC_kwDOABII585SYc77",
      "original_commit_id" : "770a73c66a48434fa48f594709dbbf5831dc1d5d",
      "original_line" : 341,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 5,
      "pull_request_review_id" : 1713437792,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1382141691/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-03T20:11:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1382141691",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1382482637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1382482637"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree it is better to track conflicts on a transaction level. I've implemented it this way now and it looks much better. ",
      "commit_id" : "003efbbe45079c4416810a025b2bc372559dff15",
      "created_at" : "2023-11-04T23:48:44Z",
      "diff_hunk" : "@@ -337,6 +337,9 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     void AddToSpends(const COutPoint& outpoint, const uint256& wtxid, WalletBatch* batch = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n     void AddToSpends(const CWalletTx& wtx, WalletBatch* batch = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n \n+    // Map of wtx hash to a set of mempool conflict hashes\n+    std::map<uint256, std::set<uint256>> MempoolConflicts GUARDED_BY(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27307#discussion_r1382482637",
      "id" : 1382482637,
      "in_reply_to_id" : 1382141691,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585SZwLN",
      "original_commit_id" : "770a73c66a48434fa48f594709dbbf5831dc1d5d",
      "original_line" : 341,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 1713887444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27307",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1382482637/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-04T23:48:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1382482637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   }
]
