[
   {
      "author_association" : "MEMBER",
      "body" : "See https://github.com/bitcoin/bitcoin/issues/16444#issuecomment-514801708 for additional background.",
      "created_at" : "2019-09-10T18:30:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16849#issuecomment-530063558",
      "id" : 530063558,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMDA2MzU1OA==",
      "updated_at" : "2019-09-10T18:30:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/530063558",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16849#discussion_r322902722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16849"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322902722"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Won't this potentially omit `candidate`s with equal work as `pindex->pprev` (depending on nSequenceId/pointer address)? ",
      "commit_id" : "2a4e60b48261d3f0ec3d85f97af998ef989134e0",
      "created_at" : "2019-09-10T18:41:50Z",
      "diff_hunk" : "@@ -2778,6 +2778,38 @@ bool CChainState::InvalidateBlock(CValidationState& state, const CChainParams& c\n     bool pindex_was_in_chain = false;\n     int disconnected = 0;\n \n+    // We do not allow ActivateBestChain() to run while InvalidateBlock() is\n+    // running, as that could cause the tip to change while we disconnect\n+    // blocks.\n+    LOCK(m_cs_chainstate);\n+\n+    // We'll be acquiring and releasing cs_main below, to allow the validation\n+    // callbacks to run. However, we should keep the block index in a\n+    // consistent state as we disconnect blocks -- in particular we need to\n+    // add equal-work blocks to setBlockIndexCandidates as we disconnect.\n+    // To avoid walking the block index repeatedly in search of candidates,\n+    // build a map once so that we can look up candidate blocks by chain\n+    // work as we go.\n+    std::multimap<const arith_uint256, CBlockIndex *> candidate_blocks_by_work;\n+\n+    {\n+        LOCK(cs_main);\n+        for (const auto& entry : m_blockman.m_block_index) {\n+            CBlockIndex *candidate = entry.second;\n+            // We don't need to put anything in our active chain into the\n+            // multimap, because those candidates will be found and considered\n+            // as we disconnect.\n+            // Instead, consider only non-active-chain blocks that have at\n+            // least as much work as where we expect the new tip to end up.\n+            if (!m_chain.Contains(candidate) &&\n+                    !CBlockIndexWorkComparator()(candidate, pindex->pprev) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16849#discussion_r322902722",
      "id" : 322902722,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMjkwMjcyMg==",
      "original_commit_id" : "bfd4fde79d57f6c8b651bb5eac1537afcdd8abb7",
      "original_position" : 28,
      "path" : "src/validation.cpp",
      "position" : 28,
      "pull_request_review_id" : 286357784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16849",
      "updated_at" : "2019-09-10T18:55:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322902722",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The only remaining case I've thought of that is unaddressed is if a new block were to arrive while InvalidateBlock() is running that (a) builds off a chain tip that is not being invalidated and (b) has less work than the current tip at the time the block is received, then we might still end up in a state that is temporarily inconsistent.  I left in the old code that cleans up before returning as a belt-and-suspenders to ensure that this case is handled the same as before.  \r\n\r\nAs this is an essentially unobservable bug (outside of travis) to begin with, I'm not sure it would be worth fixing this any further beyond documenting the situation.",
      "created_at" : "2019-09-10T18:56:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16849#issuecomment-530073757",
      "id" : 530073757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzMDA3Mzc1Nw==",
      "updated_at" : "2019-09-10T18:56:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/530073757",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16849#discussion_r322910475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16849"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322910475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this exactly matches the test in `CheckBlockIndex()`: https://github.com/bitcoin/bitcoin/blob/1985c4efda56b48f6f9c04f39d69268ee8f0b40a/src/validation.cpp#L4604",
      "commit_id" : "2a4e60b48261d3f0ec3d85f97af998ef989134e0",
      "created_at" : "2019-09-10T19:00:15Z",
      "diff_hunk" : "@@ -2778,6 +2778,38 @@ bool CChainState::InvalidateBlock(CValidationState& state, const CChainParams& c\n     bool pindex_was_in_chain = false;\n     int disconnected = 0;\n \n+    // We do not allow ActivateBestChain() to run while InvalidateBlock() is\n+    // running, as that could cause the tip to change while we disconnect\n+    // blocks.\n+    LOCK(m_cs_chainstate);\n+\n+    // We'll be acquiring and releasing cs_main below, to allow the validation\n+    // callbacks to run. However, we should keep the block index in a\n+    // consistent state as we disconnect blocks -- in particular we need to\n+    // add equal-work blocks to setBlockIndexCandidates as we disconnect.\n+    // To avoid walking the block index repeatedly in search of candidates,\n+    // build a map once so that we can look up candidate blocks by chain\n+    // work as we go.\n+    std::multimap<const arith_uint256, CBlockIndex *> candidate_blocks_by_work;\n+\n+    {\n+        LOCK(cs_main);\n+        for (const auto& entry : m_blockman.m_block_index) {\n+            CBlockIndex *candidate = entry.second;\n+            // We don't need to put anything in our active chain into the\n+            // multimap, because those candidates will be found and considered\n+            // as we disconnect.\n+            // Instead, consider only non-active-chain blocks that have at\n+            // least as much work as where we expect the new tip to end up.\n+            if (!m_chain.Contains(candidate) &&\n+                    !CBlockIndexWorkComparator()(candidate, pindex->pprev) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16849#discussion_r322910475",
      "id" : 322910475,
      "in_reply_to_id" : 322902722,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMjkxMDQ3NQ==",
      "original_commit_id" : "bfd4fde79d57f6c8b651bb5eac1537afcdd8abb7",
      "original_position" : 28,
      "path" : "src/validation.cpp",
      "position" : 28,
      "pull_request_review_id" : 286368070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16849",
      "updated_at" : "2019-09-10T19:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/322910475",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
