[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19316 ([net] Cleanup logic around connection types by amitiuttarwar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-08T23:32:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-655810542",
      "id" : 655810542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTgxMDU0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-23T07:02:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655810542",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452101343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452101343"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nnet_processing.cpp:3574:9: error: acquiring mutex 'cs_main' that is already held [-Werror,-Wthread-safety-analysis]\r\n\r\n        LOCK(cs_main);\r\n\r\n        ^",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T09:53:10Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452101343",
      "id" : 452101343,
      "line" : 3569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEwMTM0Mw==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3569,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 445463146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452101343",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452102686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452102686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You might have to use clang++ to reproduce locally",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T09:55:34Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452102686",
      "id" : 452102686,
      "in_reply_to_id" : 452101343,
      "line" : 3569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEwMjY4Ng==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3569,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 445464953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452102686",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452125782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452125782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah. I didn't remove the lock annotation from the function declaration. Fixed.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T10:38:50Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452125782",
      "id" : 452125782,
      "in_reply_to_id" : 452101343,
      "line" : 3569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNTc4Mg==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3569,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 445496753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452125782",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452147247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452147247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "edd1a8a5c76a15174985fe0a1a876eba9e7ee33c\r\n\r\nDo you have an idea why this wasn't in the top?",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T11:23:44Z",
      "diff_hunk" : "@@ -3881,8 +3883,6 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n     {\n         LOCK(cs_main);\n \n-        if (MaybeDiscourageAndDisconnect(*pto)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452147247",
      "id" : 452147247,
      "line" : 3882,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0NzI0Nw==",
      "original_commit_id" : "edd1a8a5c76a15174985fe0a1a876eba9e7ee33c",
      "original_line" : 3882,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 133,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452147247",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452149662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452149662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "37e7265796102df35ec83b53fe9114e07d214910\r\n\r\nMaybe drop these `else` since you early return on each block.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T11:28:28Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    } else if (pnode.m_manual_connection) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452149662",
      "id" : 452149662,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0OTY2Mg==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3588,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452149662",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452150787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452150787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "37e7265796102df35ec83b53fe9114e07d214910\r\n\r\nnit, I only find this comment useful when the block is big enough.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T11:30:50Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452150787",
      "id" : 452150787,
      "line" : 3577,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MDc4Nw==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3577,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452150787",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452151279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452151279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "37e7265796102df35ec83b53fe9114e07d214910\r\n\r\nNo test for this right?",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T11:31:54Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452151279",
      "id" : 452151279,
      "line" : 3582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MTI3OQ==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3582,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 45,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452151279",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452166851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452166851"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Saw this warning as well @ 5722b338d. Now building at 37e726579.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T12:03:47Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452166851",
      "id" : 452166851,
      "in_reply_to_id" : 452101343,
      "line" : 3569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE2Njg1MQ==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3569,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 445550030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452166851",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452238852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452238852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because it used to be `SendRejectsAndCheckIfBanned()`, and before that it was just sending rejects. Those required cs_main, which is taken after the ping processing at the top.\r\n\r\nI've added that explanation to the commit log.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T13:59:25Z",
      "diff_hunk" : "@@ -3881,8 +3883,6 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n     {\n         LOCK(cs_main);\n \n-        if (MaybeDiscourageAndDisconnect(*pto)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452238852",
      "id" : 452238852,
      "in_reply_to_id" : 452147247,
      "line" : 3882,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIzODg1Mg==",
      "original_commit_id" : "edd1a8a5c76a15174985fe0a1a876eba9e7ee33c",
      "original_line" : 3882,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 133,
      "pull_request_review_id" : 445643932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452238852",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. That's much clearer.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T14:26:18Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    } else if (pnode.m_manual_connection) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258091",
      "id" : 452258091,
      "in_reply_to_id" : 452149662,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1ODA5MQ==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3588,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445669667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258091",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's fair, but I don't think it does any harm.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T14:26:32Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258263",
      "id" : 452258263,
      "in_reply_to_id" : 452150787,
      "line" : 3577,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1ODI2Mw==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3577,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 445669902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258263",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452259600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452259600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems that feature_maxuploadtarget.py tests the `-noban` permission (by verifying that a peer stays connected after exceeding the banscore.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T14:28:28Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452259600",
      "id" : 452259600,
      "in_reply_to_id" : 452151279,
      "line" : 3582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1OTYwMA==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3582,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 45,
      "pull_request_review_id" : 445671743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452259600",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @promag . I've addressed your comments.",
      "created_at" : "2020-07-09T14:28:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-656161599",
      "id" : 656161599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjE2MTU5OQ==",
      "updated_at" : "2020-07-09T14:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656161599",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452343368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452343368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The whitespace linter needs appeasing, looks like extra whitespace in lines 3589 and 3595.\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\n\r\n@@ -3573,16 +3582,18 @@ bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\r\n\r\n+\r\n\r\n+\r\n\r\n^---- failure generated from test/lint/lint-whitespace.sh\r\n```\r\n(which won't prevent me from reviewing tomorrow am, so no rush)",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T16:29:56Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+    \n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+    ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452343368",
      "id" : 452343368,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM0MzM2OA==",
      "original_commit_id" : "c3dde2b52a641a8351a969c058d438f59edfeff0",
      "original_line" : 3595,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445781296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452343368",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452458981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452458981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about something along the lines of \"True if the peer was marked for disconnection in this function\"?",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T20:03:25Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452458981",
      "id" : 452458981,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ1ODk4MQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3569,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445929332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452458981",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452467029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452467029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure. Happy to make that change if I need to retouch this PR.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-09T20:20:02Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452467029",
      "id" : 452467029,
      "in_reply_to_id" : 452458981,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2NzAyOQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3569,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445939726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452467029",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452778563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452778563"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f54af5e nit suggestion while refactoring this function\r\n\r\n```diff\r\n@@ -3581,27 +3581,29 @@ bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\r\n         state.m_should_discourage = false;\r\n     } // cs_main\r\n \r\n+    std::string peer{pnode.addr.ToString()};\r\n\r\n-        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\r\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", peer);\r\n \r\n-        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\r\n+        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", peer);\r\n \r\nlocal address\r\n-        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\r\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", peer);\r\n \r\n-    LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\r\n+    LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", peer);\r\n```\r\n",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T11:08:57Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n+        pnode.fDisconnect = true;\n         return true;\n     }\n-    return false;\n+\n+    // Normal case: Disconnect the peer and discourage all nodes sharing the address\n+    LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452778563",
      "id" : 452778563,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc3ODU2Mw==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3604,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446317419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452778563",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452779171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452779171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f54af5e58649d527d53990259f77892ad07f7ffa maybe log \"NOBAN|noban permission (flag)\"\r\n```suggestion\r\n        LogPrintf(\"Warning: not punishing peer with NOBAN permission %s!\\n\", pnode.addr.ToString());\r\n```",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T11:10:22Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452779171",
      "id" : 452779171,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc3OTE3MQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3586,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446317419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452779171",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452783772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452783772"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f54af5e58649d527d nit while touching this code, perhaps fix up the logging output: s/manually-connected/manually connected/",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T11:21:42Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452783772",
      "id" : 452783772,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4Mzc3Mg==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3592,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446317419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452783772",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452786397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452786397"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree with @dongcarl. Maybe \"True if the peer is marked for disconnection in this function.\"",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T11:28:09Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452786397",
      "id" : 452786397,
      "in_reply_to_id" : 452458981,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4NjM5Nw==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3569,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446317419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452786397",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452793191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452793191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "38c96ef in this commit that removes `MaybeDiscourageAndDisconnect()` from `ProcessMessages()`, future reviewers may appreciate a comment here in the remaining call to make the order dependency explicit.\r\n\r\ne.g. that `MaybeDiscourageAndDisconnect()` here depends on all misbehavior calls (currently `Misbehaving`) occurring in ProcessMessages which needs to remain called before SendMessages in `CConnman::ThreadMessageHandler`... if I am not confused.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T11:45:13Z",
      "diff_hunk" : "@@ -3844,48 +3857,47 @@ class CompareInvMempoolOrder\n bool PeerLogicValidation::SendMessages(CNode* pto)\n {\n     const Consensus::Params& consensusParams = Params().GetConsensus();\n-    {\n-        // Don't send anything until the version handshake is complete\n-        if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-            return true;\n \n-        // If we get here, the outgoing message serialization version is set and can't change.\n-        const CNetMsgMaker msgMaker(pto->GetSendVersion());\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452793191",
      "id" : 452793191,
      "line" : 3858,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc5MzE5MQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3858,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 93,
      "pull_request_review_id" : 446317419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452793191",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452811594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452811594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (but called the variable `peer_name` since a future commit adds a `Peer` object to this function.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T12:28:09Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n+        pnode.fDisconnect = true;\n         return true;\n     }\n-    return false;\n+\n+    // Normal case: Disconnect the peer and discourage all nodes sharing the address\n+    LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452811594",
      "id" : 452811594,
      "in_reply_to_id" : 452778563,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMTU5NA==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3604,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446360055,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452811594",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452811745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452811745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I expect this PR will need to be rebased on #19474, so I've copied the log text from there.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T12:28:29Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452811745",
      "id" : 452811745,
      "in_reply_to_id" : 452779171,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMTc0NQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3586,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446360261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452811745",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452811981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452811981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T12:29:08Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452811981",
      "id" : 452811981,
      "in_reply_to_id" : 452783772,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMTk4MQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3592,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446360620,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452811981",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452812137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452812137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T12:29:27Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452812137",
      "id" : 452812137,
      "in_reply_to_id" : 452458981,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMjEzNw==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3569,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446360809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452812137",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452819554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452819554"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`nMisbehavior` is a tally in `CNodeState` that can be incremented from anywhere. That almost always happens inside a `ProcessMessages()` call (because we increment the misbehavior score when receiving a bad messages from a peer), but not always. See, for example, the call to `MaybePunishNodeForBlock()` inside `BlockChecked()`, which is an asynchronous callback from the validation interface, executed on the scheduler thread.\r\n\r\nAs long as `MaybeDiscourageAndDisconnect()` is called regularly for the node, then the misbehavior score exceeding the 100 threshold will eventually result in the peer being punished. It doesn't really matter where that `MaybeDiscourageAndDisconnect()` happens, but it makes most sense in `SendMessages()` which is where we do general peer housekeeping/maintenance.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T12:44:53Z",
      "diff_hunk" : "@@ -3844,48 +3857,47 @@ class CompareInvMempoolOrder\n bool PeerLogicValidation::SendMessages(CNode* pto)\n {\n     const Consensus::Params& consensusParams = Params().GetConsensus();\n-    {\n-        // Don't send anything until the version handshake is complete\n-        if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-            return true;\n \n-        // If we get here, the outgoing message serialization version is set and can't change.\n-        const CNetMsgMaker msgMaker(pto->GetSendVersion());\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452819554",
      "id" : 452819554,
      "in_reply_to_id" : 452793191,
      "line" : 3858,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxOTU1NA==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3858,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 93,
      "pull_request_review_id" : 446370369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452819554",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jonatack. I've addressed your inline comments. For your commit log comments:\r\n\r\n> Commit message in f54af5e: If we don't disconnect a peer in MaybeDiscourageAndDisconnect because it has NOBAN permissions or it's a manual connection, continue SendMessages processing rather than exiting early -> Was this a bit of a bug?\r\n\r\nNot a bug, but inefficient and confusing. I've updated the commit log to include that.\r\n\r\n> Commit message 38c96ef Misbehaving()... is only called in ProcessMessages() -> as it's called from MaybePunishNodeForBlock, MaybePunishNodeForTx, SendBlockTransactions, ProcessHeadersMessage, perhaps write \"Misbehaving() calls originate from callers in ProcessMessages()...\"\r\n\r\nI've now realized that this commit log was incorrect (see https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452819554). I've updated the log to be more accurate. Let me know what you think",
      "created_at" : "2020-07-10T12:50:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-656659501",
      "id" : 656659501,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjY1OTUwMQ==",
      "updated_at" : "2020-07-10T12:50:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656659501",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-10T15:35:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-656738906",
      "id" : 656738906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjczODkwNg==",
      "updated_at" : "2020-07-10T15:35:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656738906",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-07-10T16:30:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-656766880",
      "id" : 656766880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Njc2Njg4MA==",
      "updated_at" : "2020-07-10T16:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656766880",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453060447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453060447"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I know this is unrelated, but is there any reason to not log the peer id? All other peer-related messages log the id, so logging the address+port makes it harder to relate this log to all other logs.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T20:22:47Z",
      "diff_hunk" : "@@ -3563,32 +3563,50 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    std::string peer_name{pnode.addr.ToString()};  // for logging\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing noban peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually connected peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", peer_name);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453060447",
      "id" : 453060447,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA2MDQ0Nw==",
      "original_commit_id" : "e874c6dd10e39a3d32a684e24d0400a2e5f5891a",
      "original_line" : 3594,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446679764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453060447",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453081460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453081460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, isn't the general policy that we should try to avoid logging IP addresses (at least when the user is not opting in to detailed `-debug=net` logging)?\r\n\r\nFWIW: IP addresses are considered personal data in some jurisdictions (EU via GDPR?) IIRC.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-10T21:18:00Z",
      "diff_hunk" : "@@ -3563,32 +3563,50 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    std::string peer_name{pnode.addr.ToString()};  // for logging\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing noban peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually connected peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", peer_name);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453081460",
      "id" : 453081460,
      "in_reply_to_id" : 453060447,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA4MTQ2MA==",
      "original_commit_id" : "e874c6dd10e39a3d32a684e24d0400a2e5f5891a",
      "original_line" : 3594,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446706121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453081460",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453161595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453161595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We've been logging the peer address for node misbehavior since banning was introduced: https://github.com/bitcoin/bitcoin/commit/15f3ad4dbdf0d245b936e68c51a7ecb9f472d2cd#diff-9a82240fe7dfe86564178691cc57f2f1R757 , and these logs have probably just persisted all that time.\r\n\r\nI've changed this to log the peer id instead of the address.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-11T06:09:55Z",
      "diff_hunk" : "@@ -3563,32 +3563,50 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    std::string peer_name{pnode.addr.ToString()};  // for logging\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing noban peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually connected peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", peer_name);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453161595",
      "id" : 453161595,
      "in_reply_to_id" : 453060447,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2MTU5NQ==",
      "original_commit_id" : "e874c6dd10e39a3d32a684e24d0400a2e5f5891a",
      "original_line" : 3594,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446781786,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453161595",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK a37331f per `git range-diff 505b4ed f54af5e a37331f`",
      "created_at" : "2020-07-11T06:10:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-656998334",
      "id" : 656998334,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Njk5ODMzNA==",
      "updated_at" : "2020-07-11T06:10:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656998334",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453162915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453162915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, @jnewbery, makes sense.\r\n\r\nThe previous behavior before this PR had me wondering if there were particular optimisation reasons for it, but I don't see any.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-11T06:28:13Z",
      "diff_hunk" : "@@ -3844,48 +3857,47 @@ class CompareInvMempoolOrder\n bool PeerLogicValidation::SendMessages(CNode* pto)\n {\n     const Consensus::Params& consensusParams = Params().GetConsensus();\n-    {\n-        // Don't send anything until the version handshake is complete\n-        if (!pto->fSuccessfullyConnected || pto->fDisconnect)\n-            return true;\n \n-        // If we get here, the outgoing message serialization version is set and can't change.\n-        const CNetMsgMaker msgMaker(pto->GetSendVersion());\n+    if (MaybeDiscourageAndDisconnect(*pto)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453162915",
      "id" : 453162915,
      "in_reply_to_id" : 452793191,
      "line" : 3858,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2MjkxNQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3858,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 93,
      "pull_request_review_id" : 446782619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:28:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453162915",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 655b195 per `git range-diff 505b4ed f54af5e 655b195`, code/commit messages review, a bit of code history, and debug build.\r\n\r\nMaybe (only if you have to retouch again):\r\n```diff\r\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\r\n {\r\n-    NodeId peer_id{pnode.GetId()};\r\n+    const NodeId peer_id{pnode.GetId()};\r\n```\r\n",
      "created_at" : "2020-07-11T06:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-657003084",
      "id" : 657003084,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NzAwMzA4NA==",
      "updated_at" : "2020-07-11T06:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/657003084",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453164461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453164461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wow! -- banscore goes way back, TIL",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-11T06:49:13Z",
      "diff_hunk" : "@@ -3563,32 +3563,50 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    std::string peer_name{pnode.addr.ToString()};  // for logging\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing noban peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually connected peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", peer_name);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453164461",
      "id" : 453164461,
      "in_reply_to_id" : 453060447,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDQ2MQ==",
      "original_commit_id" : "e874c6dd10e39a3d32a684e24d0400a2e5f5891a",
      "original_line" : 3594,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446783552,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T06:49:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453164461",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453172039"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453172039"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for fixing!",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-11T08:29:17Z",
      "diff_hunk" : "@@ -3563,32 +3563,50 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    std::string peer_name{pnode.addr.ToString()};  // for logging\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing noban peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually connected peer %s!\\n\", peer_name);\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address\n+        LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", peer_name);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453172039",
      "id" : 453172039,
      "in_reply_to_id" : 453060447,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3MjAzOQ==",
      "original_commit_id" : "e874c6dd10e39a3d32a684e24d0400a2e5f5891a",
      "original_line" : 3594,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 446788238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T08:29:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453172039",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453174970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453174970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit in commit 655b195747:\r\n\r\nI don't like comments that repeat the source code like `pnode.addr.IsLocal() // Peer is on a local address`. Ideally source code should be self-documenting and in this case simply reading the condition and the logged format string should be sufficient to understand *what* is being done.\r\n\r\nHowever, a comment could make sense to explain *why* something is done. I presume local addresses are not discouraged because all tor-proxy nodes run on the same local address?\r\n\r\n(Same for other comments in this function)\r\n\r\nI know that this comment has been there before, but since you refactor this function, the comments could be fixed as well.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-11T09:08:25Z",
      "diff_hunk" : "@@ -3557,32 +3557,49 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    NodeId peer_id{pnode.GetId()};\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(peer_id);\n \n-    if (state.m_should_discourage) {\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n+\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing noban peer %d!\\n\", peer_id);\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually connected peer %d!\\n\", peer_id);\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453174970",
      "id" : 453174970,
      "line" : 3592,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NDk3MA==",
      "original_commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "original_line" : 3592,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 446790170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T09:18:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453174970",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453175093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453175093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "clang-format style-nit in commit 655b1957470c39bcab64917747c9f467444bd809\r\n\r\n```suggestion\r\n        CNodeState& state = *State(peer_id);\r\n```",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-11T09:10:12Z",
      "diff_hunk" : "@@ -3557,32 +3557,49 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    NodeId peer_id{pnode.GetId()};\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453175093",
      "id" : 453175093,
      "line" : 3570,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTA5Mw==",
      "original_commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "original_line" : 3570,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 446790170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T09:18:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453175093",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453175610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453175610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Style-nit in commit body of c581cc16bb5e490c0960ccf440de2d1e5f23c417:\r\n\r\nInstead of a GitHub-branded `#1117`, which either needs online-access to GitHub or two local commands to show the referenced commit (`git log --grep='#1117 ' --merges`), what about simply saying `commit c581cc16bb`.\r\n\r\nSame for the other one, but since it has two commits, maybe the merge commit can be mentioned `commit 82274c0`",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-11T09:16:16Z",
      "diff_hunk" : "@@ -3838,7 +3838,7 @@ class CompareInvMempoolOrder\n bool PeerLogicValidation::SendMessages(CNode* pto)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r453175610",
      "id" : 453175610,
      "line" : 3852,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE3NTYxMA==",
      "original_commit_id" : "1a1c23f8d40116741f0e26cdf22688fd91c923fc",
      "original_line" : 3838,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 81,
      "pull_request_review_id" : 446790170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-11T09:18:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453175610",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @MarcoFalke . Rather than invalidate the three ACKs on this branch, I've added a commit to the next branch that addresses your comments: https://github.com/jnewbery/bitcoin/tree/2020-07-tidy-misbehavior.\r\n\r\nI think this PR may be ready for merge soon.",
      "created_at" : "2020-07-24T07:16:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-663381734",
      "id" : 663381734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzM4MTczNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-24T07:17:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663381734",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r459888669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459888669"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in a follow-up: https://github.com/jnewbery/bitcoin/commits/2020-07-tidy-misbehavior",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-24T07:17:33Z",
      "diff_hunk" : "@@ -3557,32 +3557,49 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    NodeId peer_id{pnode.GetId()};\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(peer_id);\n \n-    if (state.m_should_discourage) {\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n+\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing noban peer %d!\\n\", peer_id);\n+        return false;\n+    }\n+\n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually connected peer %d!\\n\", peer_id);\n+        return false;\n+    }\n+\n+    if (pnode.addr.IsLocal()) {\n+        // Peer is on a local address. Disconnect this peer, but don't discourage the local address",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r459888669",
      "id" : 459888669,
      "in_reply_to_id" : 453174970,
      "line" : 3592,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4ODY2OQ==",
      "original_commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "original_line" : 3592,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 454677082,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T07:20:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459888669",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r459888731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459888731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in a follow-up: https://github.com/jnewbery/bitcoin/commits/2020-07-tidy-misbehavior",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-24T07:17:43Z",
      "diff_hunk" : "@@ -3557,32 +3557,49 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode     The node to check.\n+ * @return                True if the peer was marked for disconnection in this function\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    NodeId peer_id{pnode.GetId()};\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r459888731",
      "id" : 459888731,
      "in_reply_to_id" : 453175093,
      "line" : 3570,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4ODczMQ==",
      "original_commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "original_line" : 3570,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 454677149,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T07:20:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459888731",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r459888862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459888862"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. Will refer directly to commit hashes in future.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-24T07:18:01Z",
      "diff_hunk" : "@@ -3838,7 +3838,7 @@ class CompareInvMempoolOrder\n bool PeerLogicValidation::SendMessages(CNode* pto)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r459888862",
      "id" : 459888862,
      "in_reply_to_id" : 453175610,
      "line" : 3852,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4ODg2Mg==",
      "original_commit_id" : "1a1c23f8d40116741f0e26cdf22688fd91c923fc",
      "original_line" : 3838,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 81,
      "pull_request_review_id" : 454677308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T07:18:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459888862",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jonatack \r\n\r\n> Maybe (only if you have to retouch again):\r\n> \r\n> bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\r\n> ...\r\n\r\nDone in follow-up: https://github.com/jnewbery/bitcoin/commits/2020-07-tidy-misbehavior",
      "created_at" : "2020-07-24T07:21:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-663383199",
      "id" : 663383199,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzM4MzE5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-24T07:21:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663383199",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r460092944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460092944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For future work, do we still need `cs_sendProcessing` ? It only guards `m_next_addr_send/m_next_local_addr_send`, both of them only RW in `SendMessages`, inside `ThreadMessageHandler`. \r\n\r\nIs this a relic from the past or do you see another reason ?",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-24T14:36:08Z",
      "diff_hunk" : "@@ -3838,7 +3838,7 @@ class CompareInvMempoolOrder\n bool PeerLogicValidation::SendMessages(CNode* pto)\n {\n     const Consensus::Params& consensusParams = Params().GetConsensus();\n-    {\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r460092944",
      "id" : 460092944,
      "line" : 3855,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5Mjk0NA==",
      "original_commit_id" : "1a1c23f8d40116741f0e26cdf22688fd91c923fc",
      "original_line" : 3841,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 454939498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T14:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460092944",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r460103462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460103462"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've removed it from `m_next_addr_send` and `m_next_local_addr_send` in https://github.com/jnewbery/bitcoin/commits/2020-06-cs-main-split. It could theoretically also be removed from guarding `SendMessages()` since we only ever call that from the message handler thread.",
      "commit_id" : "655b1957470c39bcab64917747c9f467444bd809",
      "created_at" : "2020-07-24T14:53:00Z",
      "diff_hunk" : "@@ -3838,7 +3838,7 @@ class CompareInvMempoolOrder\n bool PeerLogicValidation::SendMessages(CNode* pto)\n {\n     const Consensus::Params& consensusParams = Params().GetConsensus();\n-    {\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r460103462",
      "id" : 460103462,
      "in_reply_to_id" : 460092944,
      "line" : 3855,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwMzQ2Mg==",
      "original_commit_id" : "1a1c23f8d40116741f0e26cdf22688fd91c923fc",
      "original_line" : 3841,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 454953218,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T14:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460103462",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for review everyone. The next PR is #19583 (including the suggested fixups by @jonatack and @MarcoFalke)",
      "created_at" : "2020-07-24T15:48:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-663604540",
      "id" : 663604540,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzYwNDU0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-24T15:48:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663604540",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm worried that we may end up spending a more significant amount of time in SendMessages now, whereas before it was opportunistic. Do you have any idea what the TRY_LOCK hit/miss ratio looked like for a busy node over a few days?\r\n\r\nI'd also be curious to know what the cpu usage/profile of a busy node looks like before/after this change.",
      "created_at" : "2020-07-24T18:10:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-663666625",
      "id" : 663666625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzY2NjYyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-24T18:10:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663666625",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for looking at this @theuni!\r\n\r\n> Do you have any idea what the TRY_LOCK hit/miss ratio looked like for a busy node over a few days?\r\n\r\nI don't know exactly but I'd expect it to be very high (ie we almost always take the lock). What other threads are you expecting to be holding cs_main on a regular basis?",
      "created_at" : "2020-07-24T18:44:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-663680030",
      "id" : 663680030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzY4MDAzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-24T18:44:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663680030",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I guess this depends on the use case and what other modules are used that might aggressively poll cs_main. (GUI, wallet, indices, RPC, ...)",
      "created_at" : "2020-07-25T07:44:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-663824176",
      "id" : 663824176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzgyNDE3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-25T07:44:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663824176",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
