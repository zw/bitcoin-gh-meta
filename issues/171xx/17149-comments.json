[
   {
      "author_association" : "MEMBER",
      "body" : "cc @achow101.",
      "created_at" : "2019-10-15T13:16:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-542206114",
      "id" : 542206114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MjIwNjExNA==",
      "updated_at" : "2019-10-15T13:16:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/542206114",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would be nice to provide the seeds or a unit test, maybe even a fix?",
      "created_at" : "2019-10-15T16:09:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-542289341",
      "id" : 542289341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MjI4OTM0MQ==",
      "updated_at" : "2019-10-15T16:09:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/542289341",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke Tentative fix for the two first issues was submitted in the linked PR https://github.com/bitcoin/bitcoin/pull/17136#issuecomment-542119819  before opening this issue.\r\n\r\nThe only seed necessary to quickly reach these code paths is found in the PSBT unit test:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/eb292af309aa57f3d7998b01307dd4cb91702908/src/wallet/test/psbt_wallet_tests.cpp#L65-L69",
      "created_at" : "2019-10-15T23:14:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-542443020",
      "id" : 542443020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MjQ0MzAyMA==",
      "updated_at" : "2019-10-15T23:15:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/542443020",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It should be noted that these code paths are reachable from the RPC code AFAICT which means that an RPC user could deliberately trigger these conditions. Would be nice to get the fix merged :)",
      "created_at" : "2019-11-04T09:23:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-549273422",
      "id" : 549273422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0OTI3MzQyMg==",
      "updated_at" : "2019-11-04T09:23:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549273422",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I found another PSBT issue that probably needs addressing.\r\n\r\nAn assertion failure is reachable if a carefully constructed transaction is passed to `AnalyzePSBT`. I haven't verified but this should be reachable via RPC.\r\n\r\n```\r\npsbt: consensus/tx_verify.cpp:130: unsigned int GetP2SHSigOpCount(const CTransaction &, \r\n  const CCoinsViewCache &): Assertion `!coin.IsSpent()' failed.\r\nâ¦\r\n    #9 0x5647d7830746 in GetP2SHSigOpCount(CTransaction const&, CCoinsViewCache const&) src/consensus/tx_verify.cpp:130:9\r\n    #10 0x5647d783087b in GetTransactionSigOpCost(CTransaction const&, CCoinsViewCache const&, int) src/consensus/tx_verify.cpp:146:20\r\n    #11 0x5647d6e719e1 in AnalyzePSBT(PartiallySignedTransaction) src/node/psbt.cpp:125:58\r\n```\r\n\r\nThe line numbers can be off slightly due to local modifications.\r\n\r\nLet me know if a minimised test case is needed and I'll create that.\r\n\r\nFriendly ping @achow101 :)",
      "created_at" : "2019-11-08T14:45:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-551854892",
      "id" : 551854892,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MTg1NDg5Mg==",
      "updated_at" : "2019-11-08T14:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/551854892",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't think that assertion is reachable. The coins are not fetched from the actual UTXO set. Rather they are created from the PSBT itself. At no point are the marked as spent.",
      "created_at" : "2019-11-08T16:03:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-551885540",
      "id" : 551885540,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MTg4NTU0MA==",
      "updated_at" : "2019-11-08T16:03:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/551885540",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@achow101 Yes, but you're forgetting that `coinEmpty.IsSpent() == true` :)\r\n\r\nNote that the attacker controlled `PartiallySignedTransaction psbtx` can be created with `psbtx.tx` such that `inputs.AccessCoin(tx.vin[i].prevout)` returns the `coinEmpty` in `CCoinsViewCache::AccessCoin `. Note that `coinEmpty.IsSpent()` holds true which means that the assertion fails :)\r\n\r\nProof of concept:\r\n\r\n```\r\n$ bitcoind &\r\n$ bitcoin-cli analyzepsbt \"cHNidP8BAJoCAAAAAljoeiG1ba8MI76OcHBFbDNvfLqlyHV5JPVFiHuyq911AAAAAAD/////g40EJ9DsZQpoqka7CwmK6kQiwHGyyng1Kgd5WdB86h0BAAAAAP////8CcKrwCAAAAAAWAEHYXCtx0AYLCcmIauuBXlCZHdoSTQDh9QUAAAAAFv8/wADXYP/7//////8JxOh0LR2HAI8AAAAAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHEAABAACAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHENkMak8AAAAA\"\r\nbitcoind: consensus/tx_verify.cpp:130: unsigned int \r\n    GetP2SHSigOpCount(const CTransaction &, const CCoinsViewCache &): \r\n    Assertion `!coin.IsSpent()' failed.\r\n```\r\n\r\nCode:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/73b26e38d7a174d5409dda8aa1fe9804e7779a1f/src/rpc/rawtransaction.cpp#L1683-L1690\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/3c40bc6726b6dc639c4ca2c00c720bccd4cd4dc7/src/consensus/tx_verify.cpp#L129-L130\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/848f245d04b604abcae84dcb9f0f6078325d418d/src/coins.cpp#L116-L125\r\n\r\n\r\n\r\n\r\n",
      "created_at" : "2019-11-10T15:01:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-552202472",
      "id" : 552202472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjIwMjQ3Mg==",
      "updated_at" : "2019-11-10T15:01:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552202472",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@achow101 Can you confirm the last issue reported? :)",
      "created_at" : "2019-11-19T10:14:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-555433907",
      "id" : 555433907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTQzMzkwNw==",
      "updated_at" : "2019-11-19T10:14:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555433907",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I managed to reproduce that last issue.",
      "created_at" : "2019-11-19T10:45:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-555448244",
      "id" : 555448244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTQ0ODI0NA==",
      "updated_at" : "2019-11-19T10:45:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555448244",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@practicalswift #17524 fixes it.",
      "created_at" : "2019-11-19T20:20:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/17149#issuecomment-555694384",
      "id" : 555694384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17149",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NTY5NDM4NA==",
      "updated_at" : "2019-11-19T20:20:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555694384",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
