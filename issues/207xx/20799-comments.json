[
   {
      "author_association" : "MEMBER",
      "body" : "> Segwit was activated in August 2017, and providing non-witness blocks to peers is no longer useful\r\n\r\nI think there may be some edge-case scenarios where a peer skips the download of witnesses because they are never read (due to an assumevalid setting), but that has nothing to do with compact blocks. So:\r\n\r\nConcept ACK on removing code that doesn't serve any use case in practice.",
      "created_at" : "2020-12-29T15:16:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752116855",
      "id" : 752116855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjExNjg1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T15:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752116855",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on removing non-witness cmpctblock support. IIRC its only purpose is serving Bitcoin Core v0.13.0 nodes (0.12.x didn't have compact blocks; 0.13.1 added segwit activation parameters).\r\n\r\nThe first commit here seems to mix removal of functionality with some refactoring. Is it possible to separate those more cleanly into separate commits?",
      "created_at" : "2020-12-29T18:35:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752197637",
      "id" : 752197637,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjE5NzYzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T18:35:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752197637",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The first commit here seems to mix removal of functionality with some refactoring. Is it possible to separate those more cleanly into separate commits?\r\n\r\nYes, I'll see what I can do to split it up a bit more.",
      "created_at" : "2020-12-29T19:06:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752208058",
      "id" : 752208058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjIwODA1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T19:06:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752208058",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21009 (Remove RewindBlockIndex logic by dhruv)\n* #20942 ([refactor] Move some net_processing globals into PeerManagerImpl by ajtowns)\n* #20158 (tree-wide: De-globalize ChainstateManager by dongcarl)\n* #19438 (Introduce deploymentstatus by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-12-29T20:17:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752227632",
      "id" : 752227632,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjIyNzYzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-02T20:38:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752227632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-12-29T20:39:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752233903",
      "id" : 752233903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjIzMzkwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T20:39:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752233903",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r549893599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549893599"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe a static const int CMPCTBLOCK_VERSION? It sounds non-ambiguous, after this PR we only support one version.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2020-12-30T00:11:56Z",
      "diff_hunk" : "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r549893599",
      "id" : 549893599,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5MzU5OQ==",
      "original_commit_id" : "58083b6dd0263d92811f10c5d79e3384efccf34e",
      "original_line" : 546,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 559744334,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549893599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550212340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550212340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea! I'll add.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2020-12-30T14:26:41Z",
      "diff_hunk" : "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550212340",
      "id" : 550212340,
      "in_reply_to_id" : 549893599,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxMjM0MA==",
      "original_commit_id" : "58083b6dd0263d92811f10c5d79e3384efccf34e",
      "original_line" : 546,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 560068745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550212340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, looks like a good simplification. Worth reviewing the diffs with `-w` in some parts.",
      "created_at" : "2021-01-02T11:01:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-753459870",
      "id" : 753459870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzQ1OTg3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-02T11:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753459870",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550895939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550895939"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-02T16:14:38Z",
      "diff_hunk" : "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550895939",
      "id" : 550895939,
      "in_reply_to_id" : 549893599,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg5NTkzOQ==",
      "original_commit_id" : "58083b6dd0263d92811f10c5d79e3384efccf34e",
      "original_line" : 546,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 560643137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550895939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and broken up the first commit.\r\n\r\nI've also dropped the last two commits (_Clean up PeerManager::BlockChecked()_ and _Clean up MaybeSetPeerAsAnnouncingHeaderAndIDs()_). There's already enough happening in this PR.\r\n",
      "created_at" : "2021-01-02T16:15:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-753492261",
      "id" : 753492261,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzQ5MjI2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-02T16:15:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753492261",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552274108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552274108"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: typo in 5ca83df9ac1f9f1454ebe7fd93c3b79012df104c (should be fProvidesHeade**rA**ndIDs) here and in two other spots. It is fixed in the next commit but this intermediate one won't compile.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-06T00:08:38Z",
      "diff_hunk" : "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552274108",
      "id" : 552274108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3NDEwOA==",
      "original_commit_id" : "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
      "original_line" : 531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 562228454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552274108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552799786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552799786"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":flushed: Thanks!",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-06T16:49:49Z",
      "diff_hunk" : "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552799786",
      "id" : 552799786,
      "in_reply_to_id" : 552274108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjc5OTc4Ng==",
      "original_commit_id" : "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
      "original_line" : 531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 562871514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552799786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552897452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552897452"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-06T18:45:15Z",
      "diff_hunk" : "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552897452",
      "id" : 552897452,
      "in_reply_to_id" : 552274108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg5NzQ1Mg==",
      "original_commit_id" : "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
      "original_line" : 531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 562955246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552897452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-01-23T14:40:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-766089490",
      "id" : 766089490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NjA4OTQ5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-23T14:40:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/766089490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563790168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563790168"
         }
      },
      "author_association" : "MEMBER",
      "body" : "652c6f8 in line 136 just above, `preferred_version` no longer exists in this test after this commit; perhaps update that line",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-25T15:01:38Z",
      "diff_hunk" : "@@ -141,21 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563790168",
      "id" : 563790168,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzc5MDE2OA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 144,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 43,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563790168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563801319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563801319"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0f352eb `uint8_t` (range 0-255) would suffice for now?\r\n\r\n```text\r\nBIP152\r\n====sendcmpct====\r\n# The sendcmpct message is defined as a message containing a 1-byte integer followed by a 8-byte integer where pchCommand == \"sendcmpct\".\r\n# The first integer SHALL be interpreted as a boolean (and MUST have a value of either 1 or 0)\r\n# The second integer SHALL be interpreted as a little-endian version number. Nodes sending a sendcmpct message MUST currently set this value to 1.\r\n```\r\n\r\n```diff\r\n@@ -147,7 +147,7 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\r\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\r\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\r\n /** The compactblocks version we support. See BIP 152. */\r\n-static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;\r\n+static constexpr uint8_t CMPCTBLOCKS_VERSION = 2;\r\n \r\n struct COrphanTx {\r\n     // When modifying, adapt the copy of this definition in tests/DoS_tests.\r\n@@ -2494,7 +2494,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n \r\n     if (msg_type == NetMsgType::SENDCMPCT) {\r\n         bool sendcmpct_hb{false};\r\n-        uint64_t sendcmpct_version{0};\r\n+        uint8_t sendcmpct_version{0};\r\n         vRecv >> sendcmpct_hb >> sendcmpct_version;\r\n```\r\n",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-25T15:15:32Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563801319",
      "id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgwMTMxOQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563801319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563811150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563811150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0f352eb can we avoid locking the mutex (and order dependance on `fHaveWitness` being set) with\r\n```diff\r\n- if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\r\n-     WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\r\n+ if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION && (pfrom.nServices & NODE_WITNESS)) {\r\n```\r\nor\r\n```diff\r\n- if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\r\n-     WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\r\n+ if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION && (pfrom.GetLocalServices() & NODE_WITNESS)) {\r\n```\r\n?",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-25T15:27:37Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563811150",
      "id" : 563811150,
      "line" : 2477,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxMTE1MA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2477,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 223,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563811150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563818143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563818143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0f352e if you go with `/* high_bandwidth= */` here, maybe update the remaining 2 lines that use `fAnnounceUsingCMPCTBLOCK`\r\n\r\n```diff\r\n@@ -718,14 +718,14 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\r\n             // As per BIP152, we only get 3 of our peers to announce\r\n             // blocks using compact encodings.\r\n             connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\r\n-                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, CMPCTBLOCKS_VERSION));\r\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */false, CMPCTBLOCKS_VERSION));\r\n                 // save BIP152 bandwidth state: we select peer to be low-bandwidth\r\n                 pnodeStop->m_bip152_highbandwidth_to = false;\r\n                 return true;\r\n             });\r\n             lNodesAnnouncingHeaderAndIDs.pop_front();\r\n         }\r\n-        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, CMPCTBLOCKS_VERSION));\r\n+        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */true, CMPCTBLOCKS_VERSION));\r\n         // save BIP152 bandwidth state: we select peer to be high-bandwidth\r\n```\r\n\r\n",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-25T15:36:14Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n-            bool fAnnounceUsingCMPCTBLOCK = false;\n-            uint64_t nCMPCTBLOCKVersion = 2;\n-            if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-            nCMPCTBLOCKVersion = 1;\n-            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563818143",
      "id" : 563818143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxODE0Mw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2484,
      "original_position" : 235,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563818143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565513529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565513529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Constify test value same as `net_processing`, CMPCTBLOCKS_VERSION ?",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-27T17:52:19Z",
      "diff_hunk" : "@@ -141,19 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1\n-    # and verify that it receives block announcements via compact block.\n-    def test_sendcmpct(self, test_node, old_node=None):\n-        preferred_version = test_node.cmpct_version\n+    def test_sendcmpct(self, test_node):\n         node = self.nodes[0]\n \n         # Make sure we get a SENDCMPCT message from our peer\n         def received_sendcmpct():\n             return (len(test_node.last_sendcmpct) > 0)\n         test_node.wait_until(received_sendcmpct, timeout=30)\n         with p2p_lock:\n-            # Check that the first version received is the preferred one\n-            assert_equal(test_node.last_sendcmpct[0].version, preferred_version)\n+            # Check that the first version received is version 2\n+            assert_equal(test_node.last_sendcmpct[0].version, 2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565513529",
      "id" : 565513529,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTUxMzUyOQ==",
      "original_commit_id" : "652c6f838809a5b277665704f816b527c7874cb6",
      "original_line" : 150,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 60,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565513529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565647594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565647594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe we can rename SHORT_IDS_BLOCK_VERSION to SENDCMPCT_VERSION ? A block of short-txn-ids is better known as a compact block or do we have ambiguity here ?",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-27T21:30:23Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565647594",
      "id" : 565647594,
      "in_reply_to_id" : 563811150,
      "line" : 2477,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY0NzU5NA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2477,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 223,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565647594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565653239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565653239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "AFAIU this comment tries to hint the double opt-in for CB to be bidirectional, maybe it can be clearer. \"However, we request new block announcements using CMPCTBLOCK only after receiving a SENDCMPCT from peer.\"",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-27T21:40:17Z",
      "diff_hunk" : "@@ -2496,18 +2498,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565653239",
      "id" : 565653239,
      "line" : 2479,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY1MzIzOQ==",
      "original_commit_id" : "d0f352eb21acaec1f8e470133cec5dc393328ed7",
      "original_line" : 2479,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 225,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565653239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565664781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565664781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we should keep to verify NODE_WITNESS existence among peer services, that's a different network namespace than SENDCMPCT, they might diverge. \r\n\r\nI believe that's an oversight compared to \"Specification for version 2\" but at least should avoid to promote a buggy peer as a CB one ?\r\n\r\nEdit: reestablished at 06ab570, you should modify 55c9231 message to warn reviewers",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-27T21:56:45Z",
      "diff_hunk" : "@@ -2521,25 +2521,27 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-                else\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 1);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565664781",
      "id" : 565664781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY2NDc4MQ==",
      "original_commit_id" : "55c9231dc31f454d10d04994ec1ca7ea6b23f349",
      "original_line" : 2526,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565664781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565693959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565693959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Current usage of `fProvidersHeaderAndIDs` is confusing to me. \r\n\r\nWe latched it to `true` at SENCMPCT reception, following this comment, it does mean this peer has signaled its availability to serve CMPCTBLOCKS.\r\n\r\nBut per-BIP152 , \"Upon receipt of a \"sendcmpct\" message with the first and second integers set to 1, the node SHOULD announce new blocks by sending a cmpctblock message.\", so a SENDCMPCT reception should only modify our behavior and doesn't constitute a commitment of the peer to send us CMPCTBLOCKS ?\r\n\r\n",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-27T22:53:34Z",
      "diff_hunk" : "@@ -321,18 +321,12 @@ struct CNodeState {\n     bool fPreferHeaderAndIDs;\n     /**\n       * Whether this peer will send us cmpctblocks if we request them.\n-      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n-      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n       */\n     bool fProvidesHeaderAndIDs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565693959",
      "id" : 565693959,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5Mzk1OQ==",
      "original_commit_id" : "7b9c9eef61177a77c54341e5264580a3d6161fe4",
      "original_line" : 325,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565693959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565696618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565696618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this variable should be better named `m_bip152_bandwidth_mode`, right now when it sets to false it means low-bandwidth, which is counter-intuitive given variable name and comment (`src/net.h`, L533).",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-27T22:58:58Z",
      "diff_hunk" : "@@ -2507,25 +2507,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n     }\n \n     if (msg_type == NetMsgType::SENDCMPCT) {\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 0;\n-        vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n+        bool sendcmpct_hb{false};\n+        uint64_t sendcmpct_version{0};\n+        vRecv >> sendcmpct_hb >> sendcmpct_version;\n \n         // Only support compact block relay with witness peers\n         if (WITH_LOCK(cs_main, {return !State(pfrom.GetId())->fHaveWitness;})) return;\n         // Only support compact block relay with witnesses\n-        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n+        if (sendcmpct_version != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n-        if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-            State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-        }\n-        if (State(pfrom.GetId())->fProvidesHeaderAndIDs == true) { // ignore later version announces\n-            State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            // save whether peer selects us as BIP152 high-bandwidth peer\n-            // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-            pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-        }\n+        CNodeState* nodestate = State(pfrom.GetId());\n+        nodestate->fProvidesHeaderAndIDs = true;\n+        nodestate->fPreferHeaderAndIDs = sendcmpct_hb;\n+        // save whether peer selects us as BIP152 high-bandwidth peer\n+        // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n+        pfrom.m_bip152_highbandwidth_from = sendcmpct_hb;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565696618",
      "id" : 565696618,
      "line" : 2511,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5NjYxOA==",
      "original_commit_id" : "019db79d7cd3679f44bd1c4dd375cb5e0690f5ff",
      "original_line" : 2511,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 281,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565696618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565698050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565698050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IMO `m_prefercmcpt`  better, otherwise name collusion is too close.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-01-27T23:02:11Z",
      "diff_hunk" : "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565698050",
      "id" : 565698050,
      "line" : 321,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5ODA1MA==",
      "original_commit_id" : "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
      "original_line" : 321,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565698050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569244269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569244269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch. Fixed!",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:09:31Z",
      "diff_hunk" : "@@ -141,21 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569244269",
      "id" : 569244269,
      "in_reply_to_id" : 563790168,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0NDI2OQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 144,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 43,
      "pull_request_review_id" : 582143471,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569244269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569246726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569246726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The version field needs to be 8 bytes (uint64_t). If we change this const to a uint8_t, then the message serialized here:\r\n\r\n```\r\n            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));\r\n```\r\n\r\nwould have a payload size of 2 (1 byte for high_bandwidth, and 1 byte for version). That would fail to be parsed by other clients.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:13:07Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569246726",
      "id" : 569246726,
      "in_reply_to_id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0NjcyNg==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 582146893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569246726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569249275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569249275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's a bit brittle in any case. Perhaps put `uint64_t{CMPCTBLOCKS_VERSION}` there instead?",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:16:53Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569249275",
      "id" : 569249275,
      "in_reply_to_id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0OTI3NQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 582150246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569249275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569254177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569254177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"followed by a 8-byte integer\" -> I misread, thanks",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:24:10Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569254177",
      "id" : 569254177,
      "in_reply_to_id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI1NDE3Nw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 582156776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569254177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569255983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569255983"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> can we avoid locking the mutex\r\n\r\nVery nice observation, although I think this is ok for now. We take cs_main when processing almost all messages in net_processing (although I agree with you that it'd be slightly nicer if we didn't have to). In the new code, we're only sending `sendcmpct` if the peer has told us that they support witness serialization. That's indicated by fHaveWitness or pfrom.nServices (pfrom.GetLocalServices() is something different - it's the services we offered to the peer).\r\n\r\nfHaveWitness will move into Peer very soon as part of #19398, at which point it'll no longer be guarded by cs_main.\r\n\r\n> (and order dependance on fHaveWitness being set)\r\n\r\n`fHaveWitness` can only be set once in version handling, and this code in verack handling can only be hit after that.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:26:41Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569255983",
      "id" : 569255983,
      "in_reply_to_id" : 563811150,
      "line" : 2477,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI1NTk4Mw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2477,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 223,
      "pull_request_review_id" : 582159141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569255983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569262771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569262771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "or perhaps:\r\n\r\n```\r\n            static_assert(sizeof(CMPCTBLOCKS_VERSION) == sizeof(uint64_t), \"sendcmpct version field must be 8 bytes\");\r\n            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));\r\n```\r\n\r\n(why check at runtime what you can test at compile time?)",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:36:11Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569262771",
      "id" : 569262771,
      "in_reply_to_id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI2Mjc3MQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 582167957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569262771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569268859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569268859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Maybe we can rename SHORT_IDS_BLOCK_VERSION to SENDCMPCT_VERSION\r\n\r\nI do have a branch somewhere that does that, but it's out of scope for this PR.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:44:40Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569268859",
      "id" : 569268859,
      "in_reply_to_id" : 563811150,
      "line" : 2477,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI2ODg1OQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2477,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 223,
      "pull_request_review_id" : 582176019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569268859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569271895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569271895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good suggestion. Done.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:48:39Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n-            bool fAnnounceUsingCMPCTBLOCK = false;\n-            uint64_t nCMPCTBLOCKVersion = 2;\n-            if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-            nCMPCTBLOCKVersion = 1;\n-            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569271895",
      "id" : 569271895,
      "in_reply_to_id" : 563818143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3MTg5NQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2484,
      "original_position" : 235,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582179720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569271895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569272914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569272914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`uint64_t{CMPCTBLOCKS_VERSION}` is a compile time check ;)",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:50:07Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569272914",
      "id" : 569272914,
      "in_reply_to_id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3MjkxNA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 582181001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569272914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I do have a branch somewhere that does that, but it's out of scope for this PR.\r\n\r\nHere you go: https://github.com/jnewbery/bitcoin/commit/82372335cc3cf8fa238678629dda6a2f465e6005. Feel free to PR that commit if you think it's worth it.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:51:37Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274044",
      "id" : 569274044,
      "in_reply_to_id" : 563811150,
      "line" : 2477,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NDA0NA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2477,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 223,
      "pull_request_review_id" : 582182369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274427"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added the static_assert.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:52:15Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274427",
      "id" : 569274427,
      "in_reply_to_id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NDQyNw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 582182924,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569275855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569275855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure if that adds to the readability here. Leaving for now.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:54:09Z",
      "diff_hunk" : "@@ -141,19 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1\n-    # and verify that it receives block announcements via compact block.\n-    def test_sendcmpct(self, test_node, old_node=None):\n-        preferred_version = test_node.cmpct_version\n+    def test_sendcmpct(self, test_node):\n         node = self.nodes[0]\n \n         # Make sure we get a SENDCMPCT message from our peer\n         def received_sendcmpct():\n             return (len(test_node.last_sendcmpct) > 0)\n         test_node.wait_until(received_sendcmpct, timeout=30)\n         with p2p_lock:\n-            # Check that the first version received is the preferred one\n-            assert_equal(test_node.last_sendcmpct[0].version, preferred_version)\n+            # Check that the first version received is version 2\n+            assert_equal(test_node.last_sendcmpct[0].version, 2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569275855",
      "id" : 569275855,
      "in_reply_to_id" : 565513529,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NTg1NQ==",
      "original_commit_id" : "652c6f838809a5b277665704f816b527c7874cb6",
      "original_line" : 150,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 60,
      "pull_request_review_id" : 582184722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569275855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569279145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569279145"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment is saying that we don't request hb mode from the peer. We only add the peer to one of our three hb peers once it provides us with a block.\r\n\r\nIn any case, this comment is unchanged by this PR, so I'm going to leave it.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T09:58:23Z",
      "diff_hunk" : "@@ -2496,18 +2498,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569279145",
      "id" : 569279145,
      "in_reply_to_id" : 565653239,
      "line" : 2479,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3OTE0NQ==",
      "original_commit_id" : "d0f352eb21acaec1f8e470133cec5dc393328ed7",
      "original_line" : 2479,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 225,
      "pull_request_review_id" : 582188794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569279145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569281077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569281077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`(pfrom.GetLocalServices() & NODE_WITNESS)` is always true (unless running on regtest with `-segwitheight=-1`). Perhaps this will be clearer after #21009 is merged.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T10:01:06Z",
      "diff_hunk" : "@@ -2521,25 +2521,27 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-                else\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 1);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569281077",
      "id" : 569281077,
      "in_reply_to_id" : 565664781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4MTA3Nw==",
      "original_commit_id" : "55c9231dc31f454d10d04994ec1ca7ea6b23f349",
      "original_line" : 2526,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582191308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569281077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283130"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, these parameters are currently confusing (hence this PR to clean them up!)\r\n\r\n`fProvidersHeaderAndIDs` is currently used to make sure that the compact blocks version doesn't change after negotiation. If a peer sends `sendcmpct(version=2)`, then any future `sendcmpct` messages where version!=2 have no effect. The peer can change hb mode by sending `sendcmpct(version=2, hb_mode={true|false})`.\r\n\r\nThis is going away with this PR because the software will only recognize version 2 sendcmpct messages from now on.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T10:04:13Z",
      "diff_hunk" : "@@ -321,18 +321,12 @@ struct CNodeState {\n     bool fPreferHeaderAndIDs;\n     /**\n       * Whether this peer will send us cmpctblocks if we request them.\n-      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n-      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n       */\n     bool fProvidesHeaderAndIDs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283130",
      "id" : 569283130,
      "in_reply_to_id" : 565693959,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4MzEzMA==",
      "original_commit_id" : "7b9c9eef61177a77c54341e5264580a3d6161fe4",
      "original_line" : 325,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582194179,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is unchanged by this PR. Eventually both of these fields should be moved to the `Peer` structure.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T10:05:21Z",
      "diff_hunk" : "@@ -2507,25 +2507,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n     }\n \n     if (msg_type == NetMsgType::SENDCMPCT) {\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 0;\n-        vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n+        bool sendcmpct_hb{false};\n+        uint64_t sendcmpct_version{0};\n+        vRecv >> sendcmpct_hb >> sendcmpct_version;\n \n         // Only support compact block relay with witness peers\n         if (WITH_LOCK(cs_main, {return !State(pfrom.GetId())->fHaveWitness;})) return;\n         // Only support compact block relay with witnesses\n-        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n+        if (sendcmpct_version != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n-        if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-            State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-        }\n-        if (State(pfrom.GetId())->fProvidesHeaderAndIDs == true) { // ignore later version announces\n-            State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            // save whether peer selects us as BIP152 high-bandwidth peer\n-            // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-            pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-        }\n+        CNodeState* nodestate = State(pfrom.GetId());\n+        nodestate->fProvidesHeaderAndIDs = true;\n+        nodestate->fPreferHeaderAndIDs = sendcmpct_hb;\n+        // save whether peer selects us as BIP152 high-bandwidth peer\n+        // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n+        pfrom.m_bip152_highbandwidth_from = sendcmpct_hb;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283877",
      "id" : 569283877,
      "in_reply_to_id" : 565696618,
      "line" : 2511,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4Mzg3Nw==",
      "original_commit_id" : "019db79d7cd3679f44bd1c4dd375cb5e0690f5ff",
      "original_line" : 2511,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 281,
      "pull_request_review_id" : 582195234,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569285463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569285463"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_prefercmpct` is not as precise. The peer might 'prefer' to fetch blocks using getdata(CMPCT), which is not what this means. `m_sendcmpct_hb` unambiguously means \"send blocks to this peer using BIP 152 high bandwidth mode\".",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T10:07:33Z",
      "diff_hunk" : "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569285463",
      "id" : 569285463,
      "in_reply_to_id" : 565698050,
      "line" : 321,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4NTQ2Mw==",
      "original_commit_id" : "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
      "original_line" : 321,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 582197243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569285463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569288431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569288431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> uint64_t{CMPCTBLOCKS_VERSION} is a compile time check ;)\r\n\r\n`uint64_t{CMPCTBLOCKS_VERSION}` initializes a new `uint64_t` from `CMPCTBLOCKS_VERSION` at runtime, no? But I guess the compiler will optimize that away?\r\n\r\nIn any case, I've removed the static assert and replaced with `uint64_t{CMPCTBLOCKS_VERSION}`.",
      "commit_id" : "77cd1a850d0c013d00d99216d82f8f0ff6304317",
      "created_at" : "2021-02-03T10:11:48Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569288431",
      "id" : 569288431,
      "in_reply_to_id" : 563801319,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4ODQzMQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 582201017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-03T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569288431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jonatack @ariard @sipa @MarcoFalke . I think I've addresses all review comments now.\r\n\r\nThis PR is probably easier to review if rebased after #21009 is merged. That PR always sets `NODE_WITNESS` in local services, and so removes all the `pfrom->GetLocalServices() & NODE_WITNESS` calls in net_processing.",
      "created_at" : "2021-02-03T10:14:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-772394673",
      "id" : 772394673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MjM5NDY3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T10:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772394673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
