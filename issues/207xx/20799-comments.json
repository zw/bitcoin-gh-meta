[
   {
      "author_association" : "MEMBER",
      "body" : "> Segwit was activated in August 2017, and providing non-witness blocks to peers is no longer useful\r\n\r\nI think there may be some edge-case scenarios where a peer skips the download of witnesses because they are never read (due to an assumevalid setting), but that has nothing to do with compact blocks. So:\r\n\r\nConcept ACK on removing code that doesn't serve any use case in practice.",
      "created_at" : "2020-12-29T15:16:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752116855",
      "id" : 752116855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjExNjg1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T15:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752116855",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on removing non-witness cmpctblock support. IIRC its only purpose is serving Bitcoin Core v0.13.0 nodes (0.12.x didn't have compact blocks; 0.13.1 added segwit activation parameters).\r\n\r\nThe first commit here seems to mix removal of functionality with some refactoring. Is it possible to separate those more cleanly into separate commits?",
      "created_at" : "2020-12-29T18:35:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752197637",
      "id" : 752197637,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjE5NzYzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T18:35:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752197637",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The first commit here seems to mix removal of functionality with some refactoring. Is it possible to separate those more cleanly into separate commits?\r\n\r\nYes, I'll see what I can do to split it up a bit more.",
      "created_at" : "2020-12-29T19:06:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752208058",
      "id" : 752208058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjIwODA1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T19:06:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752208058",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24970](https://github.com/bitcoin/bitcoin/pull/24970) (net processing: Move cleanSubVer, fPreferredDownload and nLocalHostNonce to Peer by jnewbery)\n* [#24595](https://github.com/bitcoin/bitcoin/pull/24595) (deploymentstatus: move g_versionbitscache global to ChainstateManager by ajtowns)\n* [#24062](https://github.com/bitcoin/bitcoin/pull/24062) (refactor: replace RecursiveMutex `m_most_recent_block_mutex` with Mutex by theStack)\n* [#23127](https://github.com/bitcoin/bitcoin/pull/23127) (tests: Use test framework utils where possible by vincenzopalazzo)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-12-29T20:17:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752227632",
      "id" : 752227632,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjIyNzYzMg==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752227632/reactions"
      },
      "updated_at" : "2022-05-11T23:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752227632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-12-29T20:39:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752233903",
      "id" : 752233903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MjIzMzkwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-29T20:39:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752233903",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r549893599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549893599"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe a static const int CMPCTBLOCK_VERSION? It sounds non-ambiguous, after this PR we only support one version.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2020-12-30T00:11:56Z",
      "diff_hunk" : "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r549893599",
      "id" : 549893599,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5MzU5OQ==",
      "original_commit_id" : "58083b6dd0263d92811f10c5d79e3384efccf34e",
      "original_line" : 546,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 559744334,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549893599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550212340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550212340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea! I'll add.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2020-12-30T14:26:41Z",
      "diff_hunk" : "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550212340",
      "id" : 550212340,
      "in_reply_to_id" : 549893599,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxMjM0MA==",
      "original_commit_id" : "58083b6dd0263d92811f10c5d79e3384efccf34e",
      "original_line" : 546,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 560068745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550212340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, looks like a good simplification. Worth reviewing the diffs with `-w` in some parts.",
      "created_at" : "2021-01-02T11:01:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-753459870",
      "id" : 753459870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzQ1OTg3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-02T11:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753459870",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550895939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550895939"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-02T16:14:38Z",
      "diff_hunk" : "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550895939",
      "id" : 550895939,
      "in_reply_to_id" : 549893599,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg5NTkzOQ==",
      "original_commit_id" : "58083b6dd0263d92811f10c5d79e3384efccf34e",
      "original_line" : 546,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 560643137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550895939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and broken up the first commit.\r\n\r\nI've also dropped the last two commits (_Clean up PeerManager::BlockChecked()_ and _Clean up MaybeSetPeerAsAnnouncingHeaderAndIDs()_). There's already enough happening in this PR.\r\n",
      "created_at" : "2021-01-02T16:15:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-753492261",
      "id" : 753492261,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzQ5MjI2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-02T16:15:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753492261",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552274108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552274108"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: typo in 5ca83df9ac1f9f1454ebe7fd93c3b79012df104c (should be fProvidesHeade**rA**ndIDs) here and in two other spots. It is fixed in the next commit but this intermediate one won't compile.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-06T00:08:38Z",
      "diff_hunk" : "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552274108",
      "id" : 552274108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3NDEwOA==",
      "original_commit_id" : "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
      "original_line" : 531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 562228454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552274108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552799786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552799786"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":flushed: Thanks!",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-06T16:49:49Z",
      "diff_hunk" : "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552799786",
      "id" : 552799786,
      "in_reply_to_id" : 552274108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjc5OTc4Ng==",
      "original_commit_id" : "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
      "original_line" : 531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 562871514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552799786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552897452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552897452"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-06T18:45:15Z",
      "diff_hunk" : "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552897452",
      "id" : 552897452,
      "in_reply_to_id" : 552274108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg5NzQ1Mg==",
      "original_commit_id" : "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
      "original_line" : 531,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 562955246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552897452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-01-23T14:40:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-766089490",
      "id" : 766089490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NjA4OTQ5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-23T14:40:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/766089490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563790168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563790168"
         }
      },
      "author_association" : "MEMBER",
      "body" : "652c6f8 in line 136 just above, `preferred_version` no longer exists in this test after this commit; perhaps update that line",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-25T15:01:38Z",
      "diff_hunk" : "@@ -141,21 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563790168",
      "id" : 563790168,
      "line" : 194,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzc5MDE2OA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 194,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 46,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563790168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563801319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563801319"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0f352eb `uint8_t` (range 0-255) would suffice for now?\r\n\r\n```text\r\nBIP152\r\n====sendcmpct====\r\n# The sendcmpct message is defined as a message containing a 1-byte integer followed by a 8-byte integer where pchCommand == \"sendcmpct\".\r\n# The first integer SHALL be interpreted as a boolean (and MUST have a value of either 1 or 0)\r\n# The second integer SHALL be interpreted as a little-endian version number. Nodes sending a sendcmpct message MUST currently set this value to 1.\r\n```\r\n\r\n```diff\r\n@@ -147,7 +147,7 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\r\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\r\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\r\n /** The compactblocks version we support. See BIP 152. */\r\n-static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;\r\n+static constexpr uint8_t CMPCTBLOCKS_VERSION = 2;\r\n \r\n struct COrphanTx {\r\n     // When modifying, adapt the copy of this definition in tests/DoS_tests.\r\n@@ -2494,7 +2494,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n \r\n     if (msg_type == NetMsgType::SENDCMPCT) {\r\n         bool sendcmpct_hb{false};\r\n-        uint64_t sendcmpct_version{0};\r\n+        uint8_t sendcmpct_version{0};\r\n         vRecv >> sendcmpct_hb >> sendcmpct_version;\r\n```\r\n",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-25T15:15:32Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563801319",
      "id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgwMTMxOQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563801319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563811150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563811150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0f352eb can we avoid locking the mutex (and order dependance on `fHaveWitness` being set) with\r\n```diff\r\n- if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\r\n-     WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\r\n+ if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION && (pfrom.nServices & NODE_WITNESS)) {\r\n```\r\nor\r\n```diff\r\n- if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\r\n-     WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\r\n+ if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION && (pfrom.GetLocalServices() & NODE_WITNESS)) {\r\n```\r\n?",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-25T15:27:37Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563811150",
      "id" : 563811150,
      "line" : 2666,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxMTE1MA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2666,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 237,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563811150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563818143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563818143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0f352e if you go with `/* high_bandwidth= */` here, maybe update the remaining 2 lines that use `fAnnounceUsingCMPCTBLOCK`\r\n\r\n```diff\r\n@@ -718,14 +718,14 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\r\n             // As per BIP152, we only get 3 of our peers to announce\r\n             // blocks using compact encodings.\r\n             connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\r\n-                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, CMPCTBLOCKS_VERSION));\r\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */false, CMPCTBLOCKS_VERSION));\r\n                 // save BIP152 bandwidth state: we select peer to be low-bandwidth\r\n                 pnodeStop->m_bip152_highbandwidth_to = false;\r\n                 return true;\r\n             });\r\n             lNodesAnnouncingHeaderAndIDs.pop_front();\r\n         }\r\n-        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, CMPCTBLOCKS_VERSION));\r\n+        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */true, CMPCTBLOCKS_VERSION));\r\n         // save BIP152 bandwidth state: we select peer to be high-bandwidth\r\n```\r\n\r\n",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-25T15:36:14Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n-            bool fAnnounceUsingCMPCTBLOCK = false;\n-            uint64_t nCMPCTBLOCKVersion = 2;\n-            if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-            nCMPCTBLOCKVersion = 1;\n-            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563818143",
      "id" : 563818143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxODE0Mw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2484,
      "original_position" : 235,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 575483137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563818143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565513529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565513529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Constify test value same as `net_processing`, CMPCTBLOCKS_VERSION ?",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-27T17:52:19Z",
      "diff_hunk" : "@@ -141,19 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1\n-    # and verify that it receives block announcements via compact block.\n-    def test_sendcmpct(self, test_node, old_node=None):\n-        preferred_version = test_node.cmpct_version\n+    def test_sendcmpct(self, test_node):\n         node = self.nodes[0]\n \n         # Make sure we get a SENDCMPCT message from our peer\n         def received_sendcmpct():\n             return (len(test_node.last_sendcmpct) > 0)\n         test_node.wait_until(received_sendcmpct, timeout=30)\n         with p2p_lock:\n-            # Check that the first version received is the preferred one\n-            assert_equal(test_node.last_sendcmpct[0].version, preferred_version)\n+            # Check that the first version received is version 2\n+            assert_equal(test_node.last_sendcmpct[0].version, 2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565513529",
      "id" : 565513529,
      "line" : 199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTUxMzUyOQ==",
      "original_commit_id" : "652c6f838809a5b277665704f816b527c7874cb6",
      "original_line" : 199,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 63,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565513529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565647594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565647594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe we can rename SHORT_IDS_BLOCK_VERSION to SENDCMPCT_VERSION ? A block of short-txn-ids is better known as a compact block or do we have ambiguity here ?",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-27T21:30:23Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565647594",
      "id" : 565647594,
      "in_reply_to_id" : 563811150,
      "line" : 2666,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY0NzU5NA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2666,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 237,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565647594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565653239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565653239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "AFAIU this comment tries to hint the double opt-in for CB to be bidirectional, maybe it can be clearer. \"However, we request new block announcements using CMPCTBLOCK only after receiving a SENDCMPCT from peer.\"",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-27T21:40:17Z",
      "diff_hunk" : "@@ -2496,18 +2498,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565653239",
      "id" : 565653239,
      "line" : 2668,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY1MzIzOQ==",
      "original_commit_id" : "d0f352eb21acaec1f8e470133cec5dc393328ed7",
      "original_line" : 2668,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 239,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565653239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565664781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565664781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we should keep to verify NODE_WITNESS existence among peer services, that's a different network namespace than SENDCMPCT, they might diverge. \r\n\r\nI believe that's an oversight compared to \"Specification for version 2\" but at least should avoid to promote a buggy peer as a CB one ?\r\n\r\nEdit: reestablished at 06ab570, you should modify 55c9231 message to warn reviewers",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-27T21:56:45Z",
      "diff_hunk" : "@@ -2521,25 +2521,27 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-                else\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 1);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565664781",
      "id" : 565664781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY2NDc4MQ==",
      "original_commit_id" : "55c9231dc31f454d10d04994ec1ca7ea6b23f349",
      "original_line" : 2526,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565664781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565693959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565693959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Current usage of `fProvidersHeaderAndIDs` is confusing to me. \r\n\r\nWe latched it to `true` at SENCMPCT reception, following this comment, it does mean this peer has signaled its availability to serve CMPCTBLOCKS.\r\n\r\nBut per-BIP152 , \"Upon receipt of a \"sendcmpct\" message with the first and second integers set to 1, the node SHOULD announce new blocks by sending a cmpctblock message.\", so a SENDCMPCT reception should only modify our behavior and doesn't constitute a commitment of the peer to send us CMPCTBLOCKS ?\r\n\r\n",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-27T22:53:34Z",
      "diff_hunk" : "@@ -321,18 +321,12 @@ struct CNodeState {\n     bool fPreferHeaderAndIDs;\n     /**\n       * Whether this peer will send us cmpctblocks if we request them.\n-      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n-      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n       */\n     bool fProvidesHeaderAndIDs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565693959",
      "id" : 565693959,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5Mzk1OQ==",
      "original_commit_id" : "7b9c9eef61177a77c54341e5264580a3d6161fe4",
      "original_line" : 325,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565693959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565696618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565696618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this variable should be better named `m_bip152_bandwidth_mode`, right now when it sets to false it means low-bandwidth, which is counter-intuitive given variable name and comment (`src/net.h`, L533).",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-27T22:58:58Z",
      "diff_hunk" : "@@ -2507,25 +2507,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n     }\n \n     if (msg_type == NetMsgType::SENDCMPCT) {\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 0;\n-        vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n+        bool sendcmpct_hb{false};\n+        uint64_t sendcmpct_version{0};\n+        vRecv >> sendcmpct_hb >> sendcmpct_version;\n \n         // Only support compact block relay with witness peers\n         if (WITH_LOCK(cs_main, {return !State(pfrom.GetId())->fHaveWitness;})) return;\n         // Only support compact block relay with witnesses\n-        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n+        if (sendcmpct_version != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n-        if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-            State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-        }\n-        if (State(pfrom.GetId())->fProvidesHeaderAndIDs == true) { // ignore later version announces\n-            State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            // save whether peer selects us as BIP152 high-bandwidth peer\n-            // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-            pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-        }\n+        CNodeState* nodestate = State(pfrom.GetId());\n+        nodestate->fProvidesHeaderAndIDs = true;\n+        nodestate->fPreferHeaderAndIDs = sendcmpct_hb;\n+        // save whether peer selects us as BIP152 high-bandwidth peer\n+        // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n+        pfrom.m_bip152_highbandwidth_from = sendcmpct_hb;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565696618",
      "id" : 565696618,
      "line" : 2701,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5NjYxOA==",
      "original_commit_id" : "019db79d7cd3679f44bd1c4dd375cb5e0690f5ff",
      "original_line" : 2701,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 292,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565696618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565698050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565698050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IMO `m_prefercmcpt`  better, otherwise name collusion is too close.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-01-27T23:02:11Z",
      "diff_hunk" : "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565698050",
      "id" : 565698050,
      "line" : 658,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5ODA1MA==",
      "original_commit_id" : "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
      "original_line" : 658,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 577606090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565698050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569244269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569244269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch. Fixed!",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:09:31Z",
      "diff_hunk" : "@@ -141,21 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569244269",
      "id" : 569244269,
      "in_reply_to_id" : 563790168,
      "line" : 194,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0NDI2OQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 194,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 46,
      "pull_request_review_id" : 582143471,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569244269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569246726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569246726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The version field needs to be 8 bytes (uint64_t). If we change this const to a uint8_t, then the message serialized here:\r\n\r\n```\r\n            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));\r\n```\r\n\r\nwould have a payload size of 2 (1 byte for high_bandwidth, and 1 byte for version). That would fail to be parsed by other clients.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:13:07Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569246726",
      "id" : 569246726,
      "in_reply_to_id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0NjcyNg==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582146893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569246726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569249275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569249275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's a bit brittle in any case. Perhaps put `uint64_t{CMPCTBLOCKS_VERSION}` there instead?",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:16:53Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569249275",
      "id" : 569249275,
      "in_reply_to_id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0OTI3NQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582150246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569249275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569254177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569254177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"followed by a 8-byte integer\" -> I misread, thanks",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:24:10Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569254177",
      "id" : 569254177,
      "in_reply_to_id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI1NDE3Nw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582156776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569254177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569255983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569255983"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> can we avoid locking the mutex\r\n\r\nVery nice observation, although I think this is ok for now. We take cs_main when processing almost all messages in net_processing (although I agree with you that it'd be slightly nicer if we didn't have to). In the new code, we're only sending `sendcmpct` if the peer has told us that they support witness serialization. That's indicated by fHaveWitness or pfrom.nServices (pfrom.GetLocalServices() is something different - it's the services we offered to the peer).\r\n\r\nfHaveWitness will move into Peer very soon as part of #19398, at which point it'll no longer be guarded by cs_main.\r\n\r\n> (and order dependance on fHaveWitness being set)\r\n\r\n`fHaveWitness` can only be set once in version handling, and this code in verack handling can only be hit after that.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:26:41Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569255983",
      "id" : 569255983,
      "in_reply_to_id" : 563811150,
      "line" : 2666,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI1NTk4Mw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2666,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 237,
      "pull_request_review_id" : 582159141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569255983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569262771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569262771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "or perhaps:\r\n\r\n```\r\n            static_assert(sizeof(CMPCTBLOCKS_VERSION) == sizeof(uint64_t), \"sendcmpct version field must be 8 bytes\");\r\n            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));\r\n```\r\n\r\n(why check at runtime what you can test at compile time?)",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:36:11Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569262771",
      "id" : 569262771,
      "in_reply_to_id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI2Mjc3MQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582167957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569262771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569268859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569268859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Maybe we can rename SHORT_IDS_BLOCK_VERSION to SENDCMPCT_VERSION\r\n\r\nI do have a branch somewhere that does that, but it's out of scope for this PR.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:44:40Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569268859",
      "id" : 569268859,
      "in_reply_to_id" : 563811150,
      "line" : 2666,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI2ODg1OQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2666,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 237,
      "pull_request_review_id" : 582176019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569268859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569271895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569271895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good suggestion. Done.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:48:39Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n-            bool fAnnounceUsingCMPCTBLOCK = false;\n-            uint64_t nCMPCTBLOCKVersion = 2;\n-            if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-            nCMPCTBLOCKVersion = 1;\n-            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569271895",
      "id" : 569271895,
      "in_reply_to_id" : 563818143,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3MTg5NQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2484,
      "original_position" : 235,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582179720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569271895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569272914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569272914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`uint64_t{CMPCTBLOCKS_VERSION}` is a compile time check ;)",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:50:07Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569272914",
      "id" : 569272914,
      "in_reply_to_id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3MjkxNA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582181001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569272914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I do have a branch somewhere that does that, but it's out of scope for this PR.\r\n\r\nHere you go: https://github.com/jnewbery/bitcoin/commit/82372335cc3cf8fa238678629dda6a2f465e6005. Feel free to PR that commit if you think it's worth it.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:51:37Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274044",
      "id" : 569274044,
      "in_reply_to_id" : 563811150,
      "line" : 2666,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NDA0NA==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2666,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 237,
      "pull_request_review_id" : 582182369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274427"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added the static_assert.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:52:15Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274427",
      "id" : 569274427,
      "in_reply_to_id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NDQyNw==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582182924,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569275855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569275855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure if that adds to the readability here. Leaving for now.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:54:09Z",
      "diff_hunk" : "@@ -141,19 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1\n-    # and verify that it receives block announcements via compact block.\n-    def test_sendcmpct(self, test_node, old_node=None):\n-        preferred_version = test_node.cmpct_version\n+    def test_sendcmpct(self, test_node):\n         node = self.nodes[0]\n \n         # Make sure we get a SENDCMPCT message from our peer\n         def received_sendcmpct():\n             return (len(test_node.last_sendcmpct) > 0)\n         test_node.wait_until(received_sendcmpct, timeout=30)\n         with p2p_lock:\n-            # Check that the first version received is the preferred one\n-            assert_equal(test_node.last_sendcmpct[0].version, preferred_version)\n+            # Check that the first version received is version 2\n+            assert_equal(test_node.last_sendcmpct[0].version, 2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569275855",
      "id" : 569275855,
      "in_reply_to_id" : 565513529,
      "line" : 199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NTg1NQ==",
      "original_commit_id" : "652c6f838809a5b277665704f816b527c7874cb6",
      "original_line" : 199,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 63,
      "pull_request_review_id" : 582184722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569275855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569279145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569279145"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment is saying that we don't request hb mode from the peer. We only add the peer to one of our three hb peers once it provides us with a block.\r\n\r\nIn any case, this comment is unchanged by this PR, so I'm going to leave it.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T09:58:23Z",
      "diff_hunk" : "@@ -2496,18 +2498,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569279145",
      "id" : 569279145,
      "in_reply_to_id" : 565653239,
      "line" : 2668,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3OTE0NQ==",
      "original_commit_id" : "d0f352eb21acaec1f8e470133cec5dc393328ed7",
      "original_line" : 2668,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 239,
      "pull_request_review_id" : 582188794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569279145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569281077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569281077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`(pfrom.GetLocalServices() & NODE_WITNESS)` is always true (unless running on regtest with `-segwitheight=-1`). Perhaps this will be clearer after #21009 is merged.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T10:01:06Z",
      "diff_hunk" : "@@ -2521,25 +2521,27 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-                else\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 1);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569281077",
      "id" : 569281077,
      "in_reply_to_id" : 565664781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4MTA3Nw==",
      "original_commit_id" : "55c9231dc31f454d10d04994ec1ca7ea6b23f349",
      "original_line" : 2526,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582191308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569281077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283130"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, these parameters are currently confusing (hence this PR to clean them up!)\r\n\r\n`fProvidersHeaderAndIDs` is currently used to make sure that the compact blocks version doesn't change after negotiation. If a peer sends `sendcmpct(version=2)`, then any future `sendcmpct` messages where version!=2 have no effect. The peer can change hb mode by sending `sendcmpct(version=2, hb_mode={true|false})`.\r\n\r\nThis is going away with this PR because the software will only recognize version 2 sendcmpct messages from now on.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T10:04:13Z",
      "diff_hunk" : "@@ -321,18 +321,12 @@ struct CNodeState {\n     bool fPreferHeaderAndIDs;\n     /**\n       * Whether this peer will send us cmpctblocks if we request them.\n-      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n-      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n       */\n     bool fProvidesHeaderAndIDs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283130",
      "id" : 569283130,
      "in_reply_to_id" : 565693959,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4MzEzMA==",
      "original_commit_id" : "7b9c9eef61177a77c54341e5264580a3d6161fe4",
      "original_line" : 325,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582194179,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is unchanged by this PR. Eventually both of these fields should be moved to the `Peer` structure.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T10:05:21Z",
      "diff_hunk" : "@@ -2507,25 +2507,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n     }\n \n     if (msg_type == NetMsgType::SENDCMPCT) {\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 0;\n-        vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n+        bool sendcmpct_hb{false};\n+        uint64_t sendcmpct_version{0};\n+        vRecv >> sendcmpct_hb >> sendcmpct_version;\n \n         // Only support compact block relay with witness peers\n         if (WITH_LOCK(cs_main, {return !State(pfrom.GetId())->fHaveWitness;})) return;\n         // Only support compact block relay with witnesses\n-        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n+        if (sendcmpct_version != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n-        if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-            State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-        }\n-        if (State(pfrom.GetId())->fProvidesHeaderAndIDs == true) { // ignore later version announces\n-            State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            // save whether peer selects us as BIP152 high-bandwidth peer\n-            // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-            pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-        }\n+        CNodeState* nodestate = State(pfrom.GetId());\n+        nodestate->fProvidesHeaderAndIDs = true;\n+        nodestate->fPreferHeaderAndIDs = sendcmpct_hb;\n+        // save whether peer selects us as BIP152 high-bandwidth peer\n+        // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n+        pfrom.m_bip152_highbandwidth_from = sendcmpct_hb;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283877",
      "id" : 569283877,
      "in_reply_to_id" : 565696618,
      "line" : 2701,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4Mzg3Nw==",
      "original_commit_id" : "019db79d7cd3679f44bd1c4dd375cb5e0690f5ff",
      "original_line" : 2701,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 292,
      "pull_request_review_id" : 582195234,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569285463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569285463"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_prefercmpct` is not as precise. The peer might 'prefer' to fetch blocks using getdata(CMPCT), which is not what this means. `m_sendcmpct_hb` unambiguously means \"send blocks to this peer using BIP 152 high bandwidth mode\".",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T10:07:33Z",
      "diff_hunk" : "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569285463",
      "id" : 569285463,
      "in_reply_to_id" : 565698050,
      "line" : 658,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4NTQ2Mw==",
      "original_commit_id" : "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
      "original_line" : 658,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 582197243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569285463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569288431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569288431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> uint64_t{CMPCTBLOCKS_VERSION} is a compile time check ;)\r\n\r\n`uint64_t{CMPCTBLOCKS_VERSION}` initializes a new `uint64_t` from `CMPCTBLOCKS_VERSION` at runtime, no? But I guess the compiler will optimize that away?\r\n\r\nIn any case, I've removed the static assert and replaced with `uint64_t{CMPCTBLOCKS_VERSION}`.",
      "commit_id" : "ef698b6eb3a684f52cbd2414ffc07893bbf69bbd",
      "created_at" : "2021-02-03T10:11:48Z",
      "diff_hunk" : "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569288431",
      "id" : 569288431,
      "in_reply_to_id" : 563801319,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4ODQzMQ==",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 155,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 582201017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T11:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569288431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jonatack @ariard @sipa @MarcoFalke . I think I've addresses all review comments now.\r\n\r\nThis PR is probably easier to review if rebased after #21009 is merged. That PR always sets `NODE_WITNESS` in local services, and so removes all the `pfrom->GetLocalServices() & NODE_WITNESS` calls in net_processing.",
      "created_at" : "2021-02-03T10:14:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-772394673",
      "id" : 772394673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MjM5NDY3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T10:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772394673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "#21009 was split into #21009 and #21090. #21090 now sets `NODE_WITNESS` in local services, and so removes all the `pfrom->GetLocalServices() & NODE_WITNESS` calls in net_processing.",
      "created_at" : "2021-02-05T20:49:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-774280869",
      "id" : 774280869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NDI4MDg2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-05T20:49:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/774280869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Marking this as draft. It's a smaller and cleaner change once #21090 is merged, so let's wait for that to land first.",
      "created_at" : "2021-02-15T12:01:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-779176581",
      "id" : 779176581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTE3NjU4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T12:01:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779176581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've rebased this on top of #21090. I'll still leave it as draft since we need that PR to be merged first, but this is ready for review if people are interested.",
      "created_at" : "2021-04-27T11:05:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-827522553",
      "id" : 827522553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNzUyMjU1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-27T11:05:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/827522553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Reviewers interested in this PR, might also be interested in #21090 which is now ready for review.",
      "created_at" : "2021-04-29T18:18:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-829483684",
      "id" : 829483684,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyOTQ4MzY4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-29T18:18:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/829483684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "#21090 has been merged, so I've rebased this on master. This is now ready for review.",
      "created_at" : "2021-07-22T17:18:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-885080007",
      "id" : 885080007,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII5840wT_H",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-22T17:18:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/885080007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK ef698b6eb3a684f52cbd2414ffc07893bbf69bbd\r\n\r\nThe PR seems ready to get rid of pre-segwit compact blocks, which makes sense now that segwit is used.",
      "created_at" : "2021-09-28T08:54:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-928991600",
      "id" : 928991600,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII5843X0lw",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-28T08:54:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928991600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-10-01T06:57:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-931960457",
      "id" : 931960457,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII5843jJaJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931960457/reactions"
      },
      "updated_at" : "2021-10-01T06:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931960457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased on master",
      "created_at" : "2021-10-07T13:12:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-937779377",
      "id" : 937779377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII58435WCx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937779377/reactions"
      },
      "updated_at" : "2021-10-07T13:12:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937779377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "fixed silent merge conflict in p2p_compactblocks_blocksonly.py",
      "created_at" : "2021-10-07T14:18:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-937839641",
      "id" : 937839641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII58435kwZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937839641/reactions"
      },
      "updated_at" : "2021-10-07T14:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937839641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742205681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742205681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If I'm reading correctly, I think we want to keep this test but reverse the expected outcome? That way we test that v1 doesn't work anymore as opposed to assuming it doesn't.\r\n\r\nDisregard if I'm missing something else that exercises this.",
      "commit_id" : "2ee21c8a4bc5f4103e3de94c4f06d6a02d41158f",
      "created_at" : "2021-11-03T18:04:24Z",
      "diff_hunk" : "@@ -258,22 +251,14 @@ def check_announcement_of_new_block(node, peer, predicate):\n         test_node.send_and_ping(msg_sendheaders())\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n-        # Try one more time, after sending a version-1, announce=false message.\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version-1))\n+        # Try one more time, after sending a version=1, announce=false message.\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=1))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n         # Now turn off announcements\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version))\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" not in p.last_message and \"headers\" in p.last_message)\n \n-        if old_node is not None:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742205681",
      "id" : 742205681,
      "line" : 269,
      "node_id" : "PRRC_kwDOABII584sPSjx",
      "original_commit_id" : "10ad4150379d3d43fd63e3b9b928ba653fadf5fb",
      "original_line" : 269,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 107,
      "pull_request_review_id" : 796924418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742205681/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-03T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742205681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742213653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742213653"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree with @jonatack about taking from `(pfrom.nServices & NODE_WITNESS)` rather than `State(pfrom.GetId())->fHaveWitness;})` just because it's easier to not have to worry about where the latter comes from.\r\n\r\nUnderstood that it's moot as it's changing soon anyway, so not a big deal.",
      "commit_id" : "2ee21c8a4bc5f4103e3de94c4f06d6a02d41158f",
      "created_at" : "2021-11-03T18:15:21Z",
      "diff_hunk" : "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742213653",
      "id" : 742213653,
      "in_reply_to_id" : 563811150,
      "line" : 2714,
      "node_id" : "PRRC_kwDOABII584sPUgV",
      "original_commit_id" : "befb06801eca94986a196c49e84c291ab7a4d87b",
      "original_line" : 2714,
      "original_position" : 223,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 237,
      "pull_request_review_id" : 796924418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742213653/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-03T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742213653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742216163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742216163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, is this a behavioral change? It's not clear to me why the `fHaveWitness` check was added here.\r\nEdit: Rather, why _wasn't_ it there before?\r\nEdit2: Ok, so witness data is required now, but this still looks like a new enforcement for v2.",
      "commit_id" : "2ee21c8a4bc5f4103e3de94c4f06d6a02d41158f",
      "created_at" : "2021-11-03T18:18:43Z",
      "diff_hunk" : "@@ -2728,17 +2730,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742216163",
      "id" : 742216163,
      "line" : 2714,
      "node_id" : "PRRC_kwDOABII584sPVHj",
      "original_commit_id" : "8511a0841c267c7df0bc510c843a69c3d81adbbc",
      "original_line" : 2734,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 237,
      "pull_request_review_id" : 796924418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742216163/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-03T18:49:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742216163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742222937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742222937"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Comment no longer makes sense here.",
      "commit_id" : "2ee21c8a4bc5f4103e3de94c4f06d6a02d41158f",
      "created_at" : "2021-11-03T18:27:48Z",
      "diff_hunk" : "@@ -2761,17 +2761,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) { // ignore later version announces",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742222937",
      "id" : 742222937,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sPWxZ",
      "original_commit_id" : "aa78fbbab28db5cb9b4cd87033bc9fa1ce860e55",
      "original_line" : 2766,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 796924418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742222937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-03T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742222937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742235143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742235143"
         }
      },
      "author_association" : "MEMBER",
      "body" : "According to BIP144, `NODE_WITNESS` means \r\n\r\n> A node will signal that it can provide witnesses using the following service bit\r\n\r\nSo I'm not sure this is strictly necessary. As a general theme though, I'm not sure bundling this logic with the value of NODE_WITNESS is necessary/correct.",
      "commit_id" : "2ee21c8a4bc5f4103e3de94c4f06d6a02d41158f",
      "created_at" : "2021-11-03T18:44:25Z",
      "diff_hunk" : "@@ -2758,6 +2757,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n+        // Only support compact block relay with witness peers\n+        if (!State(pfrom.GetId())->fHaveWitness) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742235143",
      "id" : 742235143,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sPZwH",
      "original_commit_id" : "d2e90fae0f694b24844cbee243dbe0f98d1f3dcb",
      "original_line" : 2761,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 796924418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742235143/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-03T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742235143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @theuni. I believe I've addressed all of your review comments.\r\n\r\n> I'm a little hazy on now NODE_WITNESS factors into these changes other than \"one kinda seems to imply the other\".\r\n\r\nYou're right. I've removed those changes.\r\n\r\nAlso rebased on master.",
      "created_at" : "2021-11-04T14:44:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-961086143",
      "id" : 961086143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII5845SQK_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961086143/reactions"
      },
      "updated_at" : "2021-11-04T14:44:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961086143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906463"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. I've now removed it.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T14:44:38Z",
      "diff_hunk" : "@@ -2758,6 +2757,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n+        // Only support compact block relay with witness peers\n+        if (!State(pfrom.GetId())->fHaveWitness) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906463",
      "id" : 742906463,
      "in_reply_to_id" : 742235143,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sR9pf",
      "original_commit_id" : "d2e90fae0f694b24844cbee243dbe0f98d1f3dcb",
      "original_line" : 2761,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 797838866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906463/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T14:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906485"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed!",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T14:44:39Z",
      "diff_hunk" : "@@ -2761,17 +2761,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) { // ignore later version announces",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906485",
      "id" : 742906485,
      "in_reply_to_id" : 742222937,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sR9p1",
      "original_commit_id" : "aa78fbbab28db5cb9b4cd87033bc9fa1ce860e55",
      "original_line" : 2766,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 797838895,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906485/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T14:44:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've removed the new check since it's not necessary.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T14:44:41Z",
      "diff_hunk" : "@@ -2728,17 +2730,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906519",
      "id" : 742906519,
      "in_reply_to_id" : 742216163,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sR9qX",
      "original_commit_id" : "8511a0841c267c7df0bc510c843a69c3d81adbbc",
      "original_line" : 2734,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 797838929,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906519/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T14:44:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906656"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, that's a good point. I've added the test in commit _[net processing] Only accept SENDCMPCT with version = 2_",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T14:44:48Z",
      "diff_hunk" : "@@ -258,22 +251,14 @@ def check_announcement_of_new_block(node, peer, predicate):\n         test_node.send_and_ping(msg_sendheaders())\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n-        # Try one more time, after sending a version-1, announce=false message.\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version-1))\n+        # Try one more time, after sending a version=1, announce=false message.\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=1))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n         # Now turn off announcements\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version))\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" not in p.last_message and \"headers\" in p.last_message)\n \n-        if old_node is not None:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906656",
      "id" : 742906656,
      "in_reply_to_id" : 742205681,
      "line" : 269,
      "node_id" : "PRRC_kwDOABII584sR9sg",
      "original_commit_id" : "10ad4150379d3d43fd63e3b9b928ba653fadf5fb",
      "original_line" : 269,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 118,
      "pull_request_review_id" : 797839090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906656/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T14:44:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > I'm a little hazy on now NODE_WITNESS factors into these changes other than \"one kinda seems to imply the other\".\r\n> \r\n> You're right. I've removed those changes.\r\n\r\nThanks. To be clear though, these are seemingly reasonable changes worth evaluating separately. Just not necessary here for dropping v1 support.",
      "created_at" : "2021-11-04T14:58:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-961115511",
      "id" : 961115511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII5845SXV3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961115511/reactions"
      },
      "updated_at" : "2021-11-04T14:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961115511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743024991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743024991"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Was there a reason for switching this to an early return, or is that now an artifact of old changes and rebases?\r\n\r\nJust for readability, it's more clear imo wrapped in a `if` for the version check. I missed the early return when re-reviewing and was confused about why this change is safe.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T16:48:03Z",
      "diff_hunk" : "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743024991",
      "id" : 743024991,
      "line" : 2758,
      "node_id" : "PRRC_kwDOABII584sSalf",
      "original_commit_id" : "255c528a0fabae8aac4d93e75867ab4a172cedb5",
      "original_line" : 2755,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 257,
      "pull_request_review_id" : 798007564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743024991/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T16:48:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743024991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743034501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743034501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is just personal taste. I _much_ prefer early returns where they're possible, especially compared with some of the very deeply nested if statements that we have in the code.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T16:58:21Z",
      "diff_hunk" : "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743034501",
      "id" : 743034501,
      "in_reply_to_id" : 743024991,
      "line" : 2758,
      "node_id" : "PRRC_kwDOABII584sSc6F",
      "original_commit_id" : "255c528a0fabae8aac4d93e75867ab4a172cedb5",
      "original_line" : 2755,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 257,
      "pull_request_review_id" : 798020174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743034501/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T16:58:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743034501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743037859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743037859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We could've previously fallen into this if `fWantsCmpctWitness == false && nCMPCTBLOCKVersion != 2`, but we won't now. I'm not sure what the consequence of that is.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T17:02:16Z",
      "diff_hunk" : "@@ -2760,17 +2760,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743037859",
      "id" : 743037859,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sSduj",
      "original_commit_id" : "fe4a59efa77bf6da2694688a35c904699c6b03a7",
      "original_line" : 2765,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 798024926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743037859/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T17:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743037859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743052831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743052831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this is a behavioral change in a pathological case:\r\n```\r\nSENDCMPCT true 2\r\nSENDCMPCT false 1\r\n```\r\nBefore this would have turned off announcements, but now it looks like it won't.\r\nAgain, I'm unsure of the consequence.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-04T17:21:02Z",
      "diff_hunk" : "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743052831",
      "id" : 743052831,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sShYf",
      "original_commit_id" : "255c528a0fabae8aac4d93e75867ab4a172cedb5",
      "original_line" : 2757,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 798045776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743052831/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-04T17:21:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743052831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744939428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744939428"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This if block is handling subsequent `sendcmpct` messages from the peer. The idea is that we'll ignore any subsequent `sendcmpct` message where the version doesn't match the version in the first received `sendcmpct` message, i.e. if we receive:\r\n\r\n```\r\nsendcmpct false 2\r\nsendcmpct true 2\r\n```\r\n\r\nThen the first `sendcmpct` announces support for compact blocks and the second `sendcmpct` enables high-bandwidth mode. However, if we receive:\r\n\r\n```\r\nsendcmpct false 2\r\nsendcmpct true 1\r\n```\r\n\r\nthe second `sendcmpct` is ignored and we don't enable high-bandwidth mode.\r\n\r\nThis PR is removing all support for `sendcmcpt <true|false> 1`, so this specialized logic is no longer required.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-08T17:23:38Z",
      "diff_hunk" : "@@ -2760,17 +2760,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744939428",
      "id" : 744939428,
      "in_reply_to_id" : 743037859,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sZt-k",
      "original_commit_id" : "fe4a59efa77bf6da2694688a35c904699c6b03a7",
      "original_line" : 2765,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 800407576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744939428/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-08T17:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744939428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744940956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744940956"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Before this would have turned off announcements, but now it looks like it won't.\r\n\r\nI don't think this is true for the reason in https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744939428. The second `sendcmpct` would not turn off announcements, since the if statement here:\r\n\r\n```\r\n            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\r\n```\r\n\r\nwould not be true, so the logic to turn off hb announcements here:\r\n\r\n```\r\n                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\r\n```\r\n\r\nwould not be hit.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-08T17:25:27Z",
      "diff_hunk" : "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744940956",
      "id" : 744940956,
      "in_reply_to_id" : 743052831,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584sZuWc",
      "original_commit_id" : "255c528a0fabae8aac4d93e75867ab4a172cedb5",
      "original_line" : 2757,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 800409494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744940956/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-08T17:25:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744940956",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the re-review Cory. I've responded to your review comments.",
      "created_at" : "2021-11-08T17:25:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-963389577",
      "id" : 963389577,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII5845bCiJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/963389577/reactions"
      },
      "updated_at" : "2021-11-08T17:25:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/963389577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749520836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749520836"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is nitty and not related to the code change, but I disagree with this. Deeply nested code, ugly as it may be, demonstrates the complexity of the logic in-place. Early returns don't simplify the logic, they just add sneaky trap-doors that aren't visible in diffs (In this case I misread the intent of the code because github didn't show enough context)",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-15T17:04:34Z",
      "diff_hunk" : "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749520836",
      "id" : 749520836,
      "in_reply_to_id" : 743024991,
      "line" : 2758,
      "node_id" : "PRRC_kwDOABII584srMfE",
      "original_commit_id" : "255c528a0fabae8aac4d93e75867ab4a172cedb5",
      "original_line" : 2755,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 257,
      "pull_request_review_id" : 806333234,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749520836/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T17:04:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749520836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749548849"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749548849"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with this now, thanks for explaining!",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-15T17:41:55Z",
      "diff_hunk" : "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749548849",
      "id" : 749548849,
      "in_reply_to_id" : 743052831,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srTUx",
      "original_commit_id" : "255c528a0fabae8aac4d93e75867ab4a172cedb5",
      "original_line" : 2757,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 806371752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749548849/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T17:41:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749548849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749559852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749559852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I see now. Thanks.",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-15T17:57:38Z",
      "diff_hunk" : "@@ -2760,17 +2760,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749559852",
      "id" : 749559852,
      "in_reply_to_id" : 743037859,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srWAs",
      "original_commit_id" : "fe4a59efa77bf6da2694688a35c904699c6b03a7",
      "original_line" : 2765,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 806386404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749559852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T17:57:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749559852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749573420"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573420"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could you add the \"high bandwidth\" part of that to the comment so the _hb makes more sense?",
      "commit_id" : "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
      "created_at" : "2021-11-15T18:17:35Z",
      "diff_hunk" : "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749573420",
      "id" : 749573420,
      "in_reply_to_id" : 565698050,
      "line" : 701,
      "node_id" : "PRRC_kwDOABII584srZUs",
      "original_commit_id" : "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
      "original_line" : 701,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 806404469,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573420/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T18:17:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573420",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749590232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749590232"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could you help me get confident that none of the side-effects below are still necessary?\r\nNamely:\r\n- `most_recent_* = bar`\r\n- `ForEachNode(ProcessBlockAvailability())`\r\n\r\nSome justification in the commit message would be helpful.",
      "commit_id" : "246b6c5cd8ab01cdab8573ac7f82b82e8f9c433d",
      "created_at" : "2021-11-15T18:43:36Z",
      "diff_hunk" : "@@ -1515,18 +1514,18 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         return;\n     nHighestFastAnnounce = pindex->nHeight;\n \n-    bool fWitnessEnabled = DeploymentActiveAt(*pindex, m_chainparams.GetConsensus(), Consensus::DEPLOYMENT_SEGWIT);\n+    if (!DeploymentActiveAt(*pindex, m_chainparams.GetConsensus(), Consensus::DEPLOYMENT_SEGWIT)) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749590232",
      "id" : 749590232,
      "line" : 1629,
      "node_id" : "PRRC_kwDOABII584srdbY",
      "original_commit_id" : "1e814a9e5048718e1b1ff0794197994a9ff63835",
      "original_line" : 1629,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 146,
      "pull_request_review_id" : 806427287,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749590232/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T19:06:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749590232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749598237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749598237"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could you explain what `(!fWitnessEnabled || state.m_sendcmpct)` represented before? I'm having trouble understanding how it used to work before even unpacking whether the change is safe :)",
      "commit_id" : "246b6c5cd8ab01cdab8573ac7f82b82e8f9c433d",
      "created_at" : "2021-11-15T18:55:39Z",
      "diff_hunk" : "@@ -1536,8 +1535,7 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         CNodeState &state = *State(pnode->GetId());\n         // If the peer has, or we announced to them the previous block already,\n         // but we don't think they have this one, go ahead and announce it\n-        if (state.m_sendcmpct_hb && (!fWitnessEnabled || state.m_sendcmpct) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749598237",
      "id" : 749598237,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584srfYd",
      "original_commit_id" : "1e814a9e5048718e1b1ff0794197994a9ff63835",
      "original_line" : 1539,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 806427287,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749598237/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-15T19:06:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749598237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-21T09:56:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1073701412",
      "id" : 1073701412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII584__2Ik",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073701412/reactions"
      },
      "updated_at" : "2022-03-21T09:56:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073701412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r835452631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835452631"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've updated the commit message for the _[net processing] Only relay blocks by cmpctblock and cache for fast relay if segwit is enabled_. Is the explanation in there sufficient?",
      "commit_id" : "246b6c5cd8ab01cdab8573ac7f82b82e8f9c433d",
      "created_at" : "2022-03-25T16:56:34Z",
      "diff_hunk" : "@@ -1515,18 +1514,18 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         return;\n     nHighestFastAnnounce = pindex->nHeight;\n \n-    bool fWitnessEnabled = DeploymentActiveAt(*pindex, m_chainparams.GetConsensus(), Consensus::DEPLOYMENT_SEGWIT);\n+    if (!DeploymentActiveAt(*pindex, m_chainparams.GetConsensus(), Consensus::DEPLOYMENT_SEGWIT)) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r835452631",
      "id" : 835452631,
      "in_reply_to_id" : 749590232,
      "line" : 1629,
      "node_id" : "PRRC_kwDOABII584xy_7X",
      "original_commit_id" : "1e814a9e5048718e1b1ff0794197994a9ff63835",
      "original_line" : 1629,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 146,
      "pull_request_review_id" : 921913173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835452631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T16:56:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835452631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r835459306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835459306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "On master, this line is:\r\n\r\n```\r\n        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\r\n```\r\n\r\ni.e. if:\r\n - the peer requested that we relay hb compact blocks _and_\r\n   - (the peer wants segwit-encoded (v2) compact blocks and this is a segwit block) _or_\r\n   - (the peer wants non-segwit-encoded (v1) compact blocks and this block is from before segwit activation)\r\n\r\nIn early commits, we remove support for v1 compact blocks, so `fWantsCmpctWitness` is always true if `fPreferHeaderAndIDs` is true.\r\n\r\nI've moved the changes around in the commits a bit, so hopefully this is a bit clearer now!",
      "commit_id" : "246b6c5cd8ab01cdab8573ac7f82b82e8f9c433d",
      "created_at" : "2022-03-25T17:04:54Z",
      "diff_hunk" : "@@ -1536,8 +1535,7 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         CNodeState &state = *State(pnode->GetId());\n         // If the peer has, or we announced to them the previous block already,\n         // but we don't think they have this one, go ahead and announce it\n-        if (state.m_sendcmpct_hb && (!fWitnessEnabled || state.m_sendcmpct) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r835459306",
      "id" : 835459306,
      "in_reply_to_id" : 749598237,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xzBjq",
      "original_commit_id" : "1e814a9e5048718e1b1ff0794197994a9ff63835",
      "original_line" : 1539,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 921923097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835459306/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T17:04:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835459306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and addressed @theuni's review comments.",
      "created_at" : "2022-03-25T17:05:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1079225091",
      "id" : 1079225091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585AU6sD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1079225091/reactions"
      },
      "updated_at" : "2022-03-25T17:05:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1079225091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-30T11:02:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1113968486",
      "id" : 1113968486,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585CZc9m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113968486/reactions"
      },
      "updated_at" : "2022-04-30T11:02:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113968486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2022-04-30T13:49:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1113992344",
      "id" : 1113992344,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585CZiyY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113992344/reactions"
      },
      "updated_at" : "2022-04-30T13:49:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113992344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @dergoegge!\r\n\r\n> I think we could also remove the bool fUseWTXID param from the [CBlockHeaderAndShortTxIDs constructor](https://github.com/bitcoin/bitcoin/blob/7cc1860b12a51d6ff180da945d63d6aa03e3a4ca/src/blockencodings.h#L107) as it is now always set to true. What do you think?\r\n\r\nI agree. I left it out of this PR since there are already lots of commits. I agree it should be done in a follow-up.",
      "created_at" : "2022-05-05T18:06:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1118893598",
      "id" : 1118893598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585CsPYe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1118893598/reactions"
      },
      "updated_at" : "2022-05-05T18:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1118893598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867782119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867782119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Unrelated in c83fbd3a71f549a9faf1e3cd4d1c9bc99e844d36: The segwit flag is pretty nonsense. All generated blocks only have the coinbase transaction, which doesn't have witness, so the commitment is optional, so it seems confusing to either  include it or omit it without reason. If this is relevant at all, it would be better to actually test with non-coinbase transactions in the future.",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-09T08:52:43Z",
      "diff_hunk" : "@@ -395,16 +370,12 @@ def check_compactblock_construction_from_block(self, version, header_and_shortid\n     # Test that bitcoind requests compact blocks when we announce new blocks\n     # via header or inv, and that responding to getblocktxn causes the block\n     # to be successfully reconstructed.\n-    # Post-segwit: upgraded nodes would only make this request of cb-version-2,\n-    # NODE_WITNESS peers.  Unupgraded nodes would still make this request of\n-    # any cb-version-1-supporting peer.\n-    def test_compactblock_requests(self, test_node, segwit=True):\n-        version = test_node.cmpct_version\n+    def test_compactblock_requests(self, test_node):\n         node = self.nodes[0]\n         # Try announcing a block with an inv or header, expect a compactblock\n         # request\n         for announce in [\"inv\", \"header\"]:\n-            block = self.build_block_on_tip(node, segwit=segwit)\n+            block = self.build_block_on_tip(node, segwit=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867782119",
      "id" : 867782119,
      "line" : 384,
      "node_id" : "PRRC_kwDOABII584zuU3n",
      "original_commit_id" : "c83fbd3a71f549a9faf1e3cd4d1c9bc99e844d36",
      "original_line" : 378,
      "original_position" : 198,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 198,
      "pull_request_review_id" : 965805207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867782119/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-09T09:40:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867782119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867791710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867791710"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I don't see why 3223906fb7a50d089308c49c9f63e88982c515c2 is split up. In the line before you are ensuring that the version is only 2, but you leave this line untouched, which makes it confusing to review the previous commit.\r\n\r\nMight be best to squash.",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-09T09:03:36Z",
      "diff_hunk" : "@@ -2892,17 +2892,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867791710",
      "id" : 867791710,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zuXNe",
      "original_commit_id" : "3223906fb7a50d089308c49c9f63e88982c515c2",
      "original_line" : 2895,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 965805207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867791710/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-09T09:40:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867791710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867809872"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867809872"
         }
      },
      "author_association" : "MEMBER",
      "body" : "744011062864d2d6dd03a5c8c381807d41063ac5: Any reason this isn't done as a scripted diff? The only other change seems to be the comment change, which I believe will be touched again anyway when this is moved to Peer.",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-09T09:22:41Z",
      "diff_hunk" : "@@ -367,12 +367,10 @@ struct CNodeState {\n     bool fPreferredDownload{false};\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders{false};\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs{false};\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs{false};\n+    /** Whether this peer wants invs or cmpctblocks (when possible) for block announcements. */\n+    bool m_requested_hb_cmpctblocks{false};\n+    /** Whether this peer will send us cmpctblocks if we request them. */\n+    bool m_provides_cmpctblocks{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867809872",
      "id" : 867809872,
      "line" : 373,
      "node_id" : "PRRC_kwDOABII584zubpQ",
      "original_commit_id" : "744011062864d2d6dd03a5c8c381807d41063ac5",
      "original_line" : 373,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 965805207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867809872/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-09T09:40:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867809872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867811574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867811574"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1aa6a5642327ee028d18b34e2c9b2be74c81454c commit message: s/is only to/is only used to/\r\n\r\n?",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-09T09:24:28Z",
      "diff_hunk" : "@@ -678,7 +678,6 @@ class PeerManagerImpl final : public PeerManager\n     std::shared_ptr<const CBlock> m_most_recent_block GUARDED_BY(m_most_recent_block_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867811574",
      "id" : 867811574,
      "line" : 678,
      "node_id" : "PRRC_kwDOABII584zucD2",
      "original_commit_id" : "1aa6a5642327ee028d18b34e2c9b2be74c81454c",
      "original_line" : 678,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 1,
      "pull_request_review_id" : 965805207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867811574/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-09T09:40:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867811574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867826468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867826468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in 1aa6a5642327ee028d18b34e2c9b2be74c81454c:\r\n\r\nCInv inv{...};",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-09T09:39:45Z",
      "diff_hunk" : "@@ -3231,9 +3225,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // expensive disk reads, because it will require the peer to\n         // actually receive all the data read from disk over the network.\n         LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-        CInv inv;\n-        WITH_LOCK(cs_main, inv.type = State(pfrom.GetId())->m_provides_cmpctblocks ? MSG_WITNESS_BLOCK : MSG_BLOCK);\n-        inv.hash = req.blockhash;\n+        CInv inv(MSG_WITNESS_BLOCK, req.blockhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r867826468",
      "id" : 867826468,
      "line" : 3227,
      "node_id" : "PRRC_kwDOABII584zufsk",
      "original_commit_id" : "1aa6a5642327ee028d18b34e2c9b2be74c81454c",
      "original_line" : 3228,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 86,
      "pull_request_review_id" : 965805207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867826468/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-09T09:40:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867826468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-13T07:40:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1125751272",
      "id" : 1125751272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585DGZno",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125751272/reactions"
      },
      "updated_at" : "2022-05-13T07:40:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125751272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873216602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216602"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That sounds like it could be done in a follow-up. This PR is already doing a lot.\r\n\r\nI'm happy to review if you make this change.",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-15T19:49:40Z",
      "diff_hunk" : "@@ -395,16 +370,12 @@ def check_compactblock_construction_from_block(self, version, header_and_shortid\n     # Test that bitcoind requests compact blocks when we announce new blocks\n     # via header or inv, and that responding to getblocktxn causes the block\n     # to be successfully reconstructed.\n-    # Post-segwit: upgraded nodes would only make this request of cb-version-2,\n-    # NODE_WITNESS peers.  Unupgraded nodes would still make this request of\n-    # any cb-version-1-supporting peer.\n-    def test_compactblock_requests(self, test_node, segwit=True):\n-        version = test_node.cmpct_version\n+    def test_compactblock_requests(self, test_node):\n         node = self.nodes[0]\n         # Try announcing a block with an inv or header, expect a compactblock\n         # request\n         for announce in [\"inv\", \"header\"]:\n-            block = self.build_block_on_tip(node, segwit=segwit)\n+            block = self.build_block_on_tip(node, segwit=True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873216602",
      "id" : 873216602,
      "in_reply_to_id" : 867782119,
      "line" : 384,
      "node_id" : "PRRC_kwDOABII5840DDpa",
      "original_commit_id" : "c83fbd3a71f549a9faf1e3cd4d1c9bc99e844d36",
      "original_line" : 378,
      "original_position" : 198,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 198,
      "pull_request_review_id" : 973218474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216602/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-15T19:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873216722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216722"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I did this as a regular commit because I also wanted to update the comments to be formatted in the same way as the surrounding comments.\r\n\r\nI agree that this could also be done as a scripted diff, and the comments changed in a different commit. I don't think it matters which way this is done.",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-15T19:50:51Z",
      "diff_hunk" : "@@ -367,12 +367,10 @@ struct CNodeState {\n     bool fPreferredDownload{false};\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders{false};\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs{false};\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs{false};\n+    /** Whether this peer wants invs or cmpctblocks (when possible) for block announcements. */\n+    bool m_requested_hb_cmpctblocks{false};\n+    /** Whether this peer will send us cmpctblocks if we request them. */\n+    bool m_provides_cmpctblocks{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873216722",
      "id" : 873216722,
      "in_reply_to_id" : 867809872,
      "line" : 373,
      "node_id" : "PRRC_kwDOABII5840DDrS",
      "original_commit_id" : "744011062864d2d6dd03a5c8c381807d41063ac5",
      "original_line" : 373,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 973218867,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216722/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-15T19:52:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873216765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216765"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried to split this PR into small commits after this comment: https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752197637. I'm not sure if there's a way to structure these changes that is going to satisfy everyone, so I'd prefer to leave this as is.",
      "commit_id" : "4c6d983708c94af10676048d1c1379be225b8f33",
      "created_at" : "2022-05-15T19:51:01Z",
      "diff_hunk" : "@@ -2892,17 +2892,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873216765",
      "id" : 873216765,
      "in_reply_to_id" : 867791710,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840DDr9",
      "original_commit_id" : "3223906fb7a50d089308c49c9f63e88982c515c2",
      "original_line" : 2895,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 973218894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-15T19:51:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873216765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873220930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873220930"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated commit text: s/that function is only to update/that function only updates/",
      "commit_id" : "a50e34c367608fcec9697893981bfa294a7c08d1",
      "created_at" : "2022-05-15T20:19:30Z",
      "diff_hunk" : "@@ -678,7 +678,6 @@ class PeerManagerImpl final : public PeerManager\n     std::shared_ptr<const CBlock> m_most_recent_block GUARDED_BY(m_most_recent_block_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873220930",
      "id" : 873220930,
      "in_reply_to_id" : 867811574,
      "line" : 678,
      "node_id" : "PRRC_kwDOABII5840DEtC",
      "original_commit_id" : "1aa6a5642327ee028d18b34e2c9b2be74c81454c",
      "original_line" : 678,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 38,
      "pull_request_review_id" : 973226799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873220930/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-15T20:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873220930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873221367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873221367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "a50e34c367608fcec9697893981bfa294a7c08d1",
      "created_at" : "2022-05-15T20:23:13Z",
      "diff_hunk" : "@@ -3231,9 +3225,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // expensive disk reads, because it will require the peer to\n         // actually receive all the data read from disk over the network.\n         LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-        CInv inv;\n-        WITH_LOCK(cs_main, inv.type = State(pfrom.GetId())->m_provides_cmpctblocks ? MSG_WITNESS_BLOCK : MSG_BLOCK);\n-        inv.hash = req.blockhash;\n+        CInv inv(MSG_WITNESS_BLOCK, req.blockhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r873221367",
      "id" : 873221367,
      "in_reply_to_id" : 867826468,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840DEz3",
      "original_commit_id" : "1aa6a5642327ee028d18b34e2c9b2be74c81454c",
      "original_line" : 3228,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 973227761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873221367/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-15T20:23:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873221367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the reviews @dergoegge and @MarcoFalke. I've addressed all review comments and rebased on latest master.",
      "created_at" : "2022-05-15T20:24:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1127020646",
      "id" : 1127020646,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585DLPhm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127020646/reactions"
      },
      "updated_at" : "2022-05-15T20:24:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127020646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK a50e34c367608fcec9697893981bfa294a7c08d1 - Only changes since my last review were a rebase and some nits.\r\n\r\nReviewed using `git range-diff 5d53cf38784df9ad9ed10306bf3fba3002fd9244..4c6d983708c94af10676048d1c1379be225b8f33 b74a6dde8cf50703a8814d402333580e4cdfea59..a50e34c367608fcec9697893981bfa294a7c08d1`",
      "created_at" : "2022-05-16T10:51:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1127518410",
      "id" : 1127518410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585DNJDK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127518410/reactions"
      },
      "updated_at" : "2022-05-16T10:51:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127518410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Review suggestions implemented in #25147",
      "created_at" : "2022-05-16T17:54:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-1127966875",
      "id" : 1127966875,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
      "node_id" : "IC_kwDOABII585DO2ib",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127966875/reactions"
      },
      "updated_at" : "2022-05-16T17:54:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127966875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
