[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28248).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [vasild](https://github.com/bitcoin/bitcoin/pull/28248#pullrequestreview-1695032063) |\n| Concept ACK | [brunoerg](https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1777344970) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28155](https://github.com/bitcoin/bitcoin/pull/28155) (net: improves addnode / m_added_nodes logic by sr-gi)\n* [#27114](https://github.com/bitcoin/bitcoin/pull/27114) (p2p: Allow whitelisting outgoing connections by brunoerg)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#25832](https://github.com/bitcoin/bitcoin/pull/25832) (tracing: network connection tracepoints by 0xB10C)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-08-09T20:46:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1672125136",
      "id" : 1672125136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585jqprQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1672125136/reactions"
      },
      "updated_at" : "2023-10-24T14:31:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1672125136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The title \"p2p: outbound network diversity improvements\" makes it sound like you are improving on the logic for making outbound connections but really you are refactoring and adding additional logging. Would you mind making the title more accurate?\r\n\r\n> Please see the commit messages for details.\r\n\r\nThe PR description is added to the merge commit, so in my opinion it makes sense to have at least a summary of what the PR does in the description.\r\n\r\nFrom our [docs](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#creating-the-pull-request):\r\n```\r\nThe body of the pull request should contain sufficient description of what the patch does, and even more importantly, why, with \r\njustification and reasoning. You should include references to any discussions (for example, other issues or mailing list\r\ndiscussions).\r\n```",
      "created_at" : "2023-08-10T10:03:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1672930044",
      "id" : 1672930044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585jtuL8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1672930044/reactions"
      },
      "updated_at" : "2023-08-10T10:03:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1672930044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@dergoegge updated",
      "created_at" : "2023-08-10T21:52:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1673966621",
      "id" : 1673966621,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585jxrQd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1673966621/reactions"
      },
      "updated_at" : "2023-08-10T21:52:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1673966621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This mostly seems like pointless refactoring (changing a `switch` to an `||` of two functions that themselves have switches). Doesn't seem worth the review effort to me.",
      "created_at" : "2023-08-11T05:51:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1674241624",
      "id" : 1674241624,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585jyuZY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1674241624/reactions"
      },
      "updated_at" : "2023-08-11T05:51:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1674241624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated to propose fixes for the issues observed with the improved logging.",
      "created_at" : "2023-08-14T04:12:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1676644423",
      "id" : 1676644423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585j75BH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1676644423/reactions"
      },
      "updated_at" : "2023-08-14T04:12:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1676644423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1293481061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293481061"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch with this deficiency!\r\n\r\nIf `m_added_nodes` is changed to `std::unordered_set`, then this can be a simple `m_added_nodes.count() > 0` and `CConnman::AddNode()` and `CConnman::RemoveAddedNode()` could be simplified (and made faster since they are now `O(number of added nodes)` and will become `O(1)`, I guess performance is irrelevant in practice because of the small number of elements).\r\n\r\nMaybe this is worth a separate PR since it is distinct from other commits (one commit to change it to `std::unordered_set` and one to add this check).",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-14T13:46:05Z",
      "diff_hunk" : "@@ -1928,6 +1921,25 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 continue;\n             }\n \n+            // Do not make automatic outbound connections to addnode peers, to\n+            // avoid using our limited outbound slots for them and to ensure\n+            // addnode connections benefit from their intended protections.\n+            {\n+                const auto str_addr{addr.ToStringAddr()};\n+                const auto str_addr_port{addr.ToStringAddrPort()};\n+\n+                LOCK(m_added_nodes_mutex);\n+                if (m_added_nodes.size() < 16 // bound the query to a reasonable limit\n+                    && std::any_of(m_added_nodes.cbegin(), m_added_nodes.cend(), [&](const auto& a) { return a == str_addr || a == str_addr_port; })) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1293481061",
      "id" : 1293481061,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NGPRl",
      "original_commit_id" : "4b9774dd49359cc0a807f1dc57b96d182330a4a1",
      "original_line" : 1933,
      "original_position" : 121,
      "original_start_line" : 1924,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1576881142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293481061/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-14T13:58:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293481061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1294891951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294891951"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good idea, simpler and faster. Done (thanks!)",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-15T17:13:01Z",
      "diff_hunk" : "@@ -1928,6 +1921,25 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 continue;\n             }\n \n+            // Do not make automatic outbound connections to addnode peers, to\n+            // avoid using our limited outbound slots for them and to ensure\n+            // addnode connections benefit from their intended protections.\n+            {\n+                const auto str_addr{addr.ToStringAddr()};\n+                const auto str_addr_port{addr.ToStringAddrPort()};\n+\n+                LOCK(m_added_nodes_mutex);\n+                if (m_added_nodes.size() < 16 // bound the query to a reasonable limit\n+                    && std::any_of(m_added_nodes.cbegin(), m_added_nodes.cend(), [&](const auto& a) { return a == str_addr || a == str_addr_port; })) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1294891951",
      "id" : 1294891951,
      "in_reply_to_id" : 1293481061,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NLnuv",
      "original_commit_id" : "4b9774dd49359cc0a807f1dc57b96d182330a4a1",
      "original_line" : 1933,
      "original_position" : 121,
      "original_start_line" : 1924,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1579039581,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294891951/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-15T17:13:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294891951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated for @vasild's review feedback to change `m_added_nodes` from a vector to an unordered set (https://github.com/bitcoin/bitcoin/pull/28248/commits/3f4a1f0bc98159f86d910227fd57d05d10bb8889), which simplifies and speeds up the `AddNode()` and `RemoveAddedNode()` methods along with the commit that follows it, `p2p: do not make automatic outbound connections to addnode peers` (048e1af).",
      "created_at" : "2023-08-15T20:16:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1679547504",
      "id" : 1679547504,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585kG9xw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1679547504/reactions"
      },
      "updated_at" : "2023-08-15T20:16:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1679547504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296069949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296069949"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Before this it would compare just the address and after this change it would compare the address and the port. I think that is undesirable because for inbound connections we see the peer as e.g. `1.2.3.4:somerandomport` and when we try to connect to `1.2.3.4:8333` we should assume we are already connected to that peer.",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-16T15:15:07Z",
      "diff_hunk" : "@@ -408,7 +397,8 @@ CNode* CConnman::FindNode(const CService& addr)\n \n bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    return FindNode(service) || FindNode(service.ToStringAddrPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296069949",
      "id" : 1296069949,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NQHU9",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 401,
      "original_position" : 33,
      "original_start_line" : 398,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1580868907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296069949/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-16T15:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296069949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296074743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296074743"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The existent code in `master` seems to be comparing the ports. Is there another bug that an inbound connection from `1.2.3.4` would not be considered as \"we are connected to `1.2.3.4:8333`\"?",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-16T15:18:50Z",
      "diff_hunk" : "@@ -1995,7 +2004,7 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n     }\n \n     for (const std::string& strAddNode : lAddresses) {\n-        CService service(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)));\n+        CService service{MaybeFlipIPv6toCJDNS(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296074743",
      "id" : 1296074743,
      "line" : 2794,
      "node_id" : "PRRC_kwDOABII585NQIf3",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 2794,
      "original_position" : 158,
      "original_start_line" : 1998,
      "path" : "src/net.cpp",
      "position" : 231,
      "pull_request_review_id" : 1580868907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296074743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2753,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-08-16T15:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296074743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296106505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296106505"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Or this:\r\n\r\n```cpp\r\nreturn m_added_nodes.insert(strNode).second;\r\n```",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-16T15:43:05Z",
      "diff_hunk" : "@@ -2621,24 +2630,15 @@ std::vector<CAddress> CConnman::GetAddresses(CNode& requestor, size_t max_addres\n bool CConnman::AddNode(const std::string& strNode)\n {\n     LOCK(m_added_nodes_mutex);\n-    for (const std::string& it : m_added_nodes) {\n-        if (strNode == it) return false;\n-    }\n-\n-    m_added_nodes.push_back(strNode);\n+    if (m_added_nodes.count(strNode)) return false;\n+    m_added_nodes.insert(strNode);\n     return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296106505",
      "id" : 1296106505,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NQQQJ",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 2635,
      "original_position" : 173,
      "original_start_line" : 2633,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1580868907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296106505/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-16T15:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296106505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296121513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296121513"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why not use `LogPrintLevel(BCLog::NET, BCLog::Level::Debug`?",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-16T15:55:15Z",
      "diff_hunk" : "@@ -437,6 +427,14 @@ static CAddress GetBindAddress(const Sock& sock)\n     return addr_bind;\n }\n \n+static void LogAlreadyConnected(CNode* pnode, ConnectionType conn_type)\n+{\n+    LogPrintfCategory(BCLog::NET, \"Failed to open new %s connection, already connected to peer=%d, net=%s%s (%s)\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296121513",
      "id" : 1296121513,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NQT6p",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 432,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1580868907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296121513/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T15:58:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296121513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296393528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296393528"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you, done.",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-16T20:28:46Z",
      "diff_hunk" : "@@ -2621,24 +2630,15 @@ std::vector<CAddress> CConnman::GetAddresses(CNode& requestor, size_t max_addres\n bool CConnman::AddNode(const std::string& strNode)\n {\n     LOCK(m_added_nodes_mutex);\n-    for (const std::string& it : m_added_nodes) {\n-        if (strNode == it) return false;\n-    }\n-\n-    m_added_nodes.push_back(strNode);\n+    if (m_added_nodes.count(strNode)) return false;\n+    m_added_nodes.insert(strNode);\n     return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296393528",
      "id" : 1296393528,
      "in_reply_to_id" : 1296106505,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NRWU4",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 2635,
      "original_position" : 173,
      "original_start_line" : 2633,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1581366261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296393528/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296393528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296405960"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296405960"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I didn't change the level from the current `LogPrintf` since 236618061a445d2cb11e722cfac5fdae5be26abb in 2017. Since this shouldn't normally occur, unconditionally logging seems helpful (the `net` category is currently much too busy to leave on and see this happen unless you proactively grep for it -- finishing the logging severity level upgrade should solve that. I personally test this branch with the added logging changed to unconditional).",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-16T20:41:00Z",
      "diff_hunk" : "@@ -437,6 +427,14 @@ static CAddress GetBindAddress(const Sock& sock)\n     return addr_bind;\n }\n \n+static void LogAlreadyConnected(CNode* pnode, ConnectionType conn_type)\n+{\n+    LogPrintfCategory(BCLog::NET, \"Failed to open new %s connection, already connected to peer=%d, net=%s%s (%s)\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296405960",
      "id" : 1296405960,
      "in_reply_to_id" : 1296121513,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NRZXI",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 432,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1581383931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296405960/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:48:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296405960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296427115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296427115"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I think that is currently an issue as well.\r\n",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-16T21:03:15Z",
      "diff_hunk" : "@@ -1995,7 +2004,7 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n     }\n \n     for (const std::string& strAddNode : lAddresses) {\n-        CService service(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)));\n+        CService service{MaybeFlipIPv6toCJDNS(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296427115",
      "id" : 1296427115,
      "in_reply_to_id" : 1296074743,
      "line" : 2794,
      "node_id" : "PRRC_kwDOABII585NRehr",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 2794,
      "original_position" : 158,
      "original_start_line" : 1998,
      "path" : "src/net.cpp",
      "position" : 231,
      "pull_request_review_id" : 1581416432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296427115/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2753,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-09-01T22:04:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296427115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296810743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296810743"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I mean, if we already have an inbound connection from `1.2.3.4` (ie we are connected to `1.2.3.4:somerandomport`) and this code checks whether we are connected to `1.2.3.4:8333` it would wrongly assume that we are not and would open an outbound connection to that address.",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-08-17T07:43:27Z",
      "diff_hunk" : "@@ -1995,7 +2004,7 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n     }\n \n     for (const std::string& strAddNode : lAddresses) {\n-        CService service(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)));\n+        CService service{MaybeFlipIPv6toCJDNS(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1296810743",
      "id" : 1296810743,
      "in_reply_to_id" : 1296074743,
      "line" : 2794,
      "node_id" : "PRRC_kwDOABII585NS8L3",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 2794,
      "original_position" : 158,
      "original_start_line" : 1998,
      "path" : "src/net.cpp",
      "position" : 231,
      "pull_request_review_id" : 1581989659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296810743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2753,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-08-17T07:43:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296810743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase if still relevant",
      "created_at" : "2023-08-28T13:48:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1695734301",
      "id" : 1695734301,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585lEtod",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1695734301/reactions"
      },
      "updated_at" : "2023-08-28T13:48:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1695734301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1313569401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569401"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good call. I've reproduced that bug and am looking at a fix.",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-09-01T21:57:12Z",
      "diff_hunk" : "@@ -1995,7 +2004,7 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n     }\n \n     for (const std::string& strAddNode : lAddresses) {\n-        CService service(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)));\n+        CService service{MaybeFlipIPv6toCJDNS(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1313569401",
      "id" : 1313569401,
      "in_reply_to_id" : 1296074743,
      "line" : 2794,
      "node_id" : "PRRC_kwDOABII585OS3p5",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 2794,
      "original_position" : 158,
      "original_start_line" : 1998,
      "path" : "src/net.cpp",
      "position" : 231,
      "pull_request_review_id" : 1607704196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569401/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2753,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-09-01T21:57:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1313569449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed `FindNode(service)` to `FindNode(static_cast<CNetAddr>(service))`.",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-09-01T21:57:15Z",
      "diff_hunk" : "@@ -408,7 +397,8 @@ CNode* CConnman::FindNode(const CService& addr)\n \n bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    return FindNode(service) || FindNode(service.ToStringAddrPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1313569449",
      "id" : 1313569449,
      "in_reply_to_id" : 1296069949,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OS3qp",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 401,
      "original_position" : 33,
      "original_start_line" : 398,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1607704224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-09-01T21:57:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1313569577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569577"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "On second thought, taking your suggestion as the goal is to migrate to severity level logging. Thanks!",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-09-01T21:57:25Z",
      "diff_hunk" : "@@ -437,6 +427,14 @@ static CAddress GetBindAddress(const Sock& sock)\n     return addr_bind;\n }\n \n+static void LogAlreadyConnected(CNode* pnode, ConnectionType conn_type)\n+{\n+    LogPrintfCategory(BCLog::NET, \"Failed to open new %s connection, already connected to peer=%d, net=%s%s (%s)\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1313569577",
      "id" : 1313569577,
      "in_reply_to_id" : 1296121513,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585OS3sp",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 432,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1607704324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:27:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1313569577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1316687977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1316687977"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated with a fix, along with several additional issues found and possibly fixed now while looking into this (thanks!)",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-09-06T03:56:40Z",
      "diff_hunk" : "@@ -1995,7 +2004,7 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n     }\n \n     for (const std::string& strAddNode : lAddresses) {\n-        CService service(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)));\n+        CService service{MaybeFlipIPv6toCJDNS(LookupNumeric(strAddNode, Params().GetDefaultPort(strAddNode)))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1316687977",
      "id" : 1316687977,
      "in_reply_to_id" : 1296074743,
      "line" : 2794,
      "node_id" : "PRRC_kwDOABII585OexBp",
      "original_commit_id" : "a411cb5a170098c99e7c64f508153613f5e377da",
      "original_line" : 2794,
      "original_position" : 158,
      "original_start_line" : 1998,
      "path" : "src/net.cpp",
      "position" : 231,
      "pull_request_review_id" : 1612367872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1316687977/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2753,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-09-06T03:56:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1316687977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, updated with improved logging, and fixes for additional issues (71828e0c, f126d041, a1b1a24) observed with the logging or suggested by @vasild (thanks!)",
      "created_at" : "2023-09-06T18:51:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1708918026",
      "id" : 1708918026,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585l3AUK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1708918026/reactions"
      },
      "updated_at" : "2023-09-06T18:51:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1708918026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated with further logging improvements. The p2p peer connection bugfixes here are unchanged from the previous push. It may be a good idea to tag this for v26?",
      "created_at" : "2023-09-12T20:43:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1716403390",
      "id" : 1716403390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585mTjy-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716403390/reactions"
      },
      "updated_at" : "2023-09-12T20:43:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716403390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1323598562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323598562"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could this lead to disambiguities? Say if you want to addnode different localhost peers with different ports (but the same IP 127.0.0.1), would `getaddednode()` now say you are connected to all of them, even when you are only connected to 1 in reality? ",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-09-12T21:28:33Z",
      "diff_hunk" : "@@ -2734,13 +2734,13 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n \n \n     // Build a map of all already connected addresses (by IP:port and by name) to inbound/outbound and resolved CService\n-    std::map<CService, bool> mapConnected;\n+    std::map<CNetAddr, bool> mapConnected;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1323598562",
      "id" : 1323598562,
      "line" : 2778,
      "node_id" : "PRRC_kwDOABII585O5ILi",
      "original_commit_id" : "54804cba858b614462b21e20dac088b2e7740e11",
      "original_line" : 2737,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 215,
      "pull_request_review_id" : 1623186191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323598562/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T22:13:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323598562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1323646824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323646824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Similar question here: Could this make some local network setups no longer viable? Probably no one should mainnet for those if it's just for testing, but possibly some setups with multiple nodes sharing the same IP exist?",
      "commit_id" : "a4887e4d7db8d247d118155360d435c34cb0adb9",
      "created_at" : "2023-09-12T22:05:39Z",
      "diff_hunk" : "@@ -1814,6 +1814,16 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Don't accept inbound connections from peers already connected to us.\n+    // Skip this check for Tor, as their inbound/outbound addresses differ.\n+    if (!inbound_onion) {\n+        if (auto pnode = AlreadyConnectedToAddress(addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1323646824",
      "id" : 1323646824,
      "line" : 1824,
      "node_id" : "PRRC_kwDOABII585O5T9o",
      "original_commit_id" : "b97cfd18da8ad4e29319b8e3c84c3388cd75ff60",
      "original_line" : 1821,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 106,
      "pull_request_review_id" : 1623186191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323646824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-12T22:22:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1323646824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-14T10:38:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1719204472",
      "id" : 1719204472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585mePp4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719204472/reactions"
      },
      "updated_at" : "2023-09-14T10:38:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719204472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If you're fixing bugs, it would be very beneficial to also add tests at the same time.",
      "created_at" : "2023-09-14T10:50:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1719220940",
      "id" : 1719220940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585meTrM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719220940/reactions"
      },
      "updated_at" : "2023-09-14T10:50:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719220940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356400497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356400497"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right. Comparing ports for incoming connections is problematic also. I think the right approach for determining if we are connected to `addr:port`, _for the purposes of making an outbound connection_:\r\n\r\n* For incoming connections, compare just `addr` and ignore `port`\r\n* For outgoing connections, compare both `addr` and `port`.\r\n\r\nThis can't be done with a single map of either `CService` or `CNetAddr`. I guess two containers are needed, as this:\r\n\r\n<details>\r\n<summary>[patch] compare differently inbound and outbound addresses</summary>\r\n\r\n```diff\r\ndiff --git i/src/net.cpp w/src/net.cpp\r\nindex 91282d927d..0eb0023112 100644\r\n--- i/src/net.cpp\r\n+++ w/src/net.cpp\r\n@@ -2809,41 +2809,49 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\r\n         LOCK(m_added_nodes_mutex);\r\n         ret.reserve(m_added_node_params.size());\r\n         std::copy(m_added_node_params.cbegin(), m_added_node_params.cend(), std::back_inserter(lAddresses));\r\n     }\r\n \r\n \r\n-    // Build a map of all already connected addresses (by IP:port and by name) to inbound/outbound and resolved CService\r\n-    std::map<CNetAddr, bool> mapConnected;\r\n+    // Collect all addresses to which we are already connected.\r\n+    std::unordered_set<CNetAddr, CNetAddrHash> connected_to_inbound;\r\n+    std::unordered_set<CService, CServiceHash> connected_to_outbound;\r\n     std::map<std::string, std::pair<bool, CService>> mapConnectedByName;\r\n     {\r\n         LOCK(m_nodes_mutex);\r\n         for (const CNode* pnode : m_nodes) {\r\n             if (pnode->addr.IsValid()) {\r\n-                mapConnected[static_cast<CNetAddr>(pnode->addr)] = pnode->IsInboundConn();\r\n+                if (pnode->IsInboundConn()) {\r\n+                    connected_to_inbound.insert(pnode->addr);\r\n+                } else {\r\n+                    connected_to_outbound.insert(pnode->addr);\r\n+                }\r\n             }\r\n             std::string addrName{pnode->m_addr_name};\r\n             if (!addrName.empty()) {\r\n                 mapConnectedByName[std::move(addrName)] = std::make_pair(pnode->IsInboundConn(), static_cast<const CService&>(pnode->addr));\r\n             }\r\n         }\r\n     }\r\n \r\n     for (const auto& addr : lAddresses) {\r\n         CService service(LookupNumeric(addr.m_added_node, GetDefaultPort(addr.m_added_node)));\r\n         AddedNodeInfo addedNode{addr, CService(), false, false};\r\n         if (service.IsValid()) {\r\n-            // strAddNode is an IP:port\r\n-            auto it = mapConnected.find(static_cast<CNetAddr>(service));\r\n-            if (it != mapConnected.end()) {\r\n+            // addr.m_added_node is an addr:port\r\n+            if (connected_to_outbound.count(service) > 0) {\r\n+                addedNode.resolvedAddress = service;\r\n+                addedNode.fConnected = true;\r\n+                addedNode.fInbound = false;\r\n+            } else if (connected_to_inbound.count(service) > 0) {\r\n                 addedNode.resolvedAddress = service;\r\n                 addedNode.fConnected = true;\r\n-                addedNode.fInbound = it->second;\r\n+                addedNode.fInbound = true;\r\n             }\r\n         } else {\r\n-            // strAddNode is a name\r\n+            // addr.m_added_node is a name\r\n             auto it = mapConnectedByName.find(addr.m_added_node);\r\n             if (it != mapConnectedByName.end()) {\r\n                 addedNode.resolvedAddress = it->second.second;\r\n                 addedNode.fConnected = true;\r\n                 addedNode.fInbound = it->second.first;\r\n             }\r\ndiff --git i/src/netaddress.h w/src/netaddress.h\r\nindex ad09f16799..99a3b0fc22 100644\r\n--- i/src/netaddress.h\r\n+++ w/src/netaddress.h\r\n@@ -254,12 +254,13 @@ public:\r\n             UnserializeV2Stream(s);\r\n         } else {\r\n             UnserializeV1Stream(s);\r\n         }\r\n     }\r\n \r\n+    friend class CNetAddrHash;\r\n     friend class CSubNet;\r\n \r\n private:\r\n     /**\r\n      * Parse a Tor address and set this object to it.\r\n      * @param[in] addr Address to parse, must be a valid C string, for example\r\n@@ -473,12 +474,36 @@ private:\r\n         // will not be gossiped, but continue reading next addresses from the stream.\r\n         m_net = NET_IPV6;\r\n         m_addr.assign(ADDR_IPV6_SIZE, 0x0);\r\n     }\r\n };\r\n \r\n+class CNetAddrHash\r\n+{\r\n+public:\r\n+    CNetAddrHash()\r\n+        : m_salt_k0{GetRand<uint64_t>()},\r\n+          m_salt_k1{GetRand<uint64_t>()}\r\n+    {\r\n+    }\r\n+\r\n+    CNetAddrHash(uint64_t salt_k0, uint64_t salt_k1) : m_salt_k0{salt_k0}, m_salt_k1{salt_k1} {}\r\n+\r\n+    size_t operator()(const CNetAddr& a) const noexcept\r\n+    {\r\n+        CSipHasher hasher(m_salt_k0, m_salt_k1);\r\n+        hasher.Write(a.m_net);\r\n+        hasher.Write(a.m_addr);\r\n+        return static_cast<size_t>(hasher.Finalize());\r\n+    }\r\n+\r\n+private:\r\n+    const uint64_t m_salt_k0;\r\n+    const uint64_t m_salt_k1;\r\n+};\r\n+\r\n class CSubNet\r\n {\r\n protected:\r\n     /// Network (base) address\r\n     CNetAddr network;\r\n     /// Netmask, in network byte order\r\n```\r\n</details>",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T07:39:25Z",
      "diff_hunk" : "@@ -2734,13 +2734,13 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n \n \n     // Build a map of all already connected addresses (by IP:port and by name) to inbound/outbound and resolved CService\n-    std::map<CService, bool> mapConnected;\n+    std::map<CNetAddr, bool> mapConnected;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356400497",
      "id" : 1356400497,
      "in_reply_to_id" : 1323598562,
      "line" : 2858,
      "node_id" : "PRRC_kwDOABII585Q2Qdx",
      "original_commit_id" : "54804cba858b614462b21e20dac088b2e7740e11",
      "original_line" : 2858,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 218,
      "pull_request_review_id" : 1673481614,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356400497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T10:05:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356400497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356484191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356484191"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Two concerns about this interface change:\r\n\r\n1. The pointer could become stale as soon as this method returns. It is good that this method is private which somewhat limits the danger that somebody will dereference a stale pointer, but does not eliminate it. `FindNode()` already has such an unsafe interface where it locks `m_nodes_mutex`, fetches a pointer to an element inside `m_nodes`, releases the mutex and returns the (possibly stale) pointer. In `master`, all places where `FindNode()` is called either only check if the returned pointer is null without dereferencing it (ok), or lock the mutex, call `FindNode()` (requiring the mutex to be recursive), dereference the pointer, unlock the mutex. But this PR in commit cb3f5a805caa2d42fdab57b42e6aee820ccd347d `p2p, bugfix: correctly detect already connected peers in ConnectNode()` adds calls where the pointer is dereferenced after releasing the mutex. I would rather have less such unsafe interfaces than more. Maybe log the message from inside `AlreadyConnectedToAddress()` or have it return the message as a string, to be optionally logged by the caller?\r\n\r\n2. (minor) `optional` from a pointer is redundant - if the pointer will never be null, then it can be reference. If the pointer can be null, then the `optional` can be dropped and null pointer to mean \"not connected\".",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T08:37:47Z",
      "diff_hunk" : "@@ -408,9 +408,13 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+std::optional<CNode*> CConnman::AlreadyConnectedToAddress(const CAddress& addr)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356484191",
      "id" : 1356484191,
      "line" : 411,
      "node_id" : "PRRC_kwDOABII585Q2k5f",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 411,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 14,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356484191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356484191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356558158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356558158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "cb3f5a805caa2d42fdab57b42e6aee820ccd347d `p2p, bugfix: correctly detect already connected peers in ConnectNode()`\r\n\r\n>    - Remove an AlreadyConnectedToAddress() check in CConnman::OpenNetworkConnection,\r\n      as it is now redundant to the checks added in this commit, and it is\r\n      preferable to log if it occurs.\r\n\r\nIt might happen that `CConnman::ConnectNode()` skips the call to `AlreadyConnectedToAddress()` and connects - if `pszDest` is null and `Lookup(pszDest` returns empty result. Then it will go here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/4a5aae9330780c3740e27cc511f7cba1fab745b9/src/net.cpp#L549-L558\r\n\r\nSo maybe keep the call to `AlreadyConnectedToAddress()` from `CConnman::OpenNetworkConnection()`.",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T09:34:26Z",
      "diff_hunk" : "@@ -2902,7 +2944,7 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n     }\n     if (!pszDest) {\n         bool banned_or_discouraged = m_banman && (m_banman->IsDiscouraged(addrConnect) || m_banman->IsBanned(addrConnect));\n-        if (IsLocal(addrConnect) || banned_or_discouraged || AlreadyConnectedToAddress(addrConnect)) {\n+        if (IsLocal(addrConnect) || banned_or_discouraged) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356558158",
      "id" : 1356558158,
      "line" : 2947,
      "node_id" : "PRRC_kwDOABII585Q229O",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 2947,
      "original_position" : 248,
      "original_start_line" : 2905,
      "path" : "src/net.cpp",
      "position" : 248,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356558158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2905,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356558158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356561796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356561796"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    // Skip this check for inbound Tor connections because all of them seem to come from the IP address of the Tor router (usually 127.0.0.1).\r\n```",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T09:37:33Z",
      "diff_hunk" : "@@ -1847,6 +1861,16 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Don't accept inbound connections from peers already connected to us.\n+    // Skip this check for inbound Tor connections, as each IP will differ.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356561796",
      "id" : 1356561796,
      "line" : 1866,
      "node_id" : "PRRC_kwDOABII585Q232E",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 1866,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 106,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356561796/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356561796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356590348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356590348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This needs to know whether to ignore the port or not in order to do the check properly:\r\n\r\n* if we are about to make an outbound connection and wonder whether we are already connected to the peer we intend to connect to\r\n  * for all existent outbound connections, compare the prospect's address and port and if both match, then we are already connected\r\n  * for all existent inbound connections, compare only the address and ignore the port, if a match is found, then we are already connected\r\n  * otherwise we are not connected\r\n* if we are accepting in inbound connection, for all existent inbound and outbound connections, compare only the address and if a match is found then we are already connected, otherwise we are not connected.",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T10:02:13Z",
      "diff_hunk" : "@@ -408,9 +408,13 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+std::optional<CNode*> CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return std::nullopt; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    if (auto pnode = FindNode(static_cast<CNetAddr>(service))) return pnode;\n+    if (auto pnode = FindNode(service.ToStringAddrPort())) return pnode;\n+    return std::nullopt;\n }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356590348",
      "id" : 1356590348,
      "line" : 418,
      "node_id" : "PRRC_kwDOABII585Q2-0M",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 418,
      "original_position" : 22,
      "original_start_line" : 411,
      "path" : "src/net.cpp",
      "position" : 22,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356590348/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 411,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356590348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356598798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356598798"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, feel free to ignore: for consistency with `CServiceHash` this better end in `Hash`. Given that it operates on `AddedNodeParams` better use that name verbatim instead of shortening it to `AddedNode`. I.e. consider renaming this to `AddedNodeParamsHash`.",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T10:10:07Z",
      "diff_hunk" : "@@ -101,6 +101,17 @@ typedef int64_t NodeId;\n struct AddedNodeParams {\n     std::string m_added_node;\n     bool m_use_v2transport;\n+    bool operator==(const AddedNodeParams& p) const\n+    {\n+        return m_added_node == p.m_added_node && m_use_v2transport == p.m_use_v2transport;\n+    }\n+};\n+\n+struct AddedNodeHasher {\n+    size_t operator()(const AddedNodeParams& p) const noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356598798",
      "id" : 1356598798,
      "line" : 111,
      "node_id" : "PRRC_kwDOABII585Q3A4O",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 111,
      "original_position" : 11,
      "original_start_line" : 110,
      "path" : "src/net.h",
      "position" : 11,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356598798/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 110,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356598798",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356610866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356610866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why `<< 1`?",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T10:22:08Z",
      "diff_hunk" : "@@ -101,6 +101,17 @@ typedef int64_t NodeId;\n struct AddedNodeParams {\n     std::string m_added_node;\n     bool m_use_v2transport;\n+    bool operator==(const AddedNodeParams& p) const\n+    {\n+        return m_added_node == p.m_added_node && m_use_v2transport == p.m_use_v2transport;\n+    }\n+};\n+\n+struct AddedNodeHasher {\n+    size_t operator()(const AddedNodeParams& p) const noexcept\n+    {\n+        return std::hash<std::string>()(p.m_added_node) ^ (std::hash<bool>()(p.m_use_v2transport) << 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356610866",
      "id" : 1356610866,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII585Q3D0y",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 113,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 13,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356610866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356610866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356628687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356628687"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If we have the address for manual connections (given to `addnode`) here we should ignore whether v1 or v2 is going to be used. It is the same peer after all, regardless of p2p encryption. I guess this better be something like:\r\n\r\n```cpp\r\nbool in_added_nodes;\r\n{\r\n    const std::string addr_str{addr.ToStringAddr()};\r\n    const std::string addr_port_str{addr.ToStringAddrPort()};\r\n    LOCK(m_added_nodes_mutex);\r\n    in_added_nodes =\r\n        m_added_node_params.count({addr_str, /*m_use_v2transport=*/true}) > 0 ||\r\n        m_added_node_params.count({addr_str, /*m_use_v2transport=*/false}) > 0 ||\r\n        m_added_node_params.count({addr_port_str, /*m_use_v2transport=*/true}) > 0 ||\r\n        m_added_node_params.count({addr_port_str, /*m_use_v2transport=*/false}) > 0;\r\n}\r\nif (in_added_nodes) {",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T10:39:03Z",
      "diff_hunk" : "@@ -2760,6 +2787,19 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 continue;\n             }\n \n+            // Do not make automatic outbound connections to addnode peers,\n+            // to allocate our limited outbound slots correctly and to ensure\n+            // addnode connections benefit from their intended protections.\n+            // Expect BIP324 transport when both us and them have NODE_V2_P2P set.\n+            const bool v2_p2p(addr.nServices & GetLocalServices() & NODE_P2P_V2);\n+            if (WITH_LOCK(m_added_nodes_mutex, return m_added_node_params.count({addr.ToStringAddr(), v2_p2p}) || m_added_node_params.count({addr.ToStringAddrPort(), v2_p2p}))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356628687",
      "id" : 1356628687,
      "line" : 2795,
      "node_id" : "PRRC_kwDOABII585Q3ILP",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 2795,
      "original_position" : 187,
      "original_start_line" : 2794,
      "path" : "src/net.cpp",
      "position" : 187,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356628687/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2794,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356628687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356657006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356657006"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"Trying v%i %s connection to net=%s%s, lastseen=%.1fh ago\\n\",\r\n```",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T11:05:27Z",
      "diff_hunk" : "@@ -474,15 +483,18 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n             }\n             // It is possible that we already have a connection to the IP/port pszDest resolved to.\n             // In that case, drop the connection that was just created.\n-            LOCK(m_nodes_mutex);\n-            CNode* pnode = FindNode(static_cast<CService>(addrConnect));\n-            if (pnode) {\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            if (auto pnode = AlreadyConnectedToAddress(addrConnect)) {\n+                LogPrintLevel(BCLog::NET, BCLog::Level::Info, \"%s\\n\", AlreadyConnected(pnode.value(), addrConnect, conn_type));\n                 return nullptr;\n             }\n         }\n     }\n \n+    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"Trying v%i %s connection to net=%s%s, lastseen=%.1fhrs\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356657006",
      "id" : 1356657006,
      "line" : 493,
      "node_id" : "PRRC_kwDOABII585Q3PFu",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 493,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 81,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356657006/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356657006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356660922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356660922"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I find \"...connection accepted from peer=5\"  a bit confusing. Maybe:\r\n```suggestion\r\n    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"New %s connection accepted, peer=%d, net=%s%s\\n\",\r\n```",
      "commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "created_at" : "2023-10-12T11:09:23Z",
      "diff_hunk" : "@@ -1869,7 +1893,9 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     pnode->AddRef();\n     m_msgproc->InitializeNode(*pnode, nodeServices);\n \n-    LogPrint(BCLog::NET, \"connection from %s accepted\\n\", addr.ToStringAddrPort());\n+    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"New %s connection accepted from peer=%d, net=%s%s\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356660922",
      "id" : 1356660922,
      "line" : 1896,
      "node_id" : "PRRC_kwDOABII585Q3QC6",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 1896,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 1673614690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356660922/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-12T11:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1356660922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361236879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361236879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-16T20:34:38Z",
      "diff_hunk" : "@@ -474,15 +483,18 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n             }\n             // It is possible that we already have a connection to the IP/port pszDest resolved to.\n             // In that case, drop the connection that was just created.\n-            LOCK(m_nodes_mutex);\n-            CNode* pnode = FindNode(static_cast<CService>(addrConnect));\n-            if (pnode) {\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            if (auto pnode = AlreadyConnectedToAddress(addrConnect)) {\n+                LogPrintLevel(BCLog::NET, BCLog::Level::Info, \"%s\\n\", AlreadyConnected(pnode.value(), addrConnect, conn_type));\n                 return nullptr;\n             }\n         }\n     }\n \n+    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"Trying v%i %s connection to net=%s%s, lastseen=%.1fhrs\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361236879",
      "id" : 1361236879,
      "in_reply_to_id" : 1356657006,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RItOP",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 493,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1680913596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361236879/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T20:34:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361236879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361236968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361236968"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-16T20:34:43Z",
      "diff_hunk" : "@@ -1869,7 +1893,9 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     pnode->AddRef();\n     m_msgproc->InitializeNode(*pnode, nodeServices);\n \n-    LogPrint(BCLog::NET, \"connection from %s accepted\\n\", addr.ToStringAddrPort());\n+    LogPrintLevel(BCLog::NET, BCLog::Level::Debug, \"New %s connection accepted from peer=%d, net=%s%s\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361236968",
      "id" : 1361236968,
      "in_reply_to_id" : 1356660922,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RItPo",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 1896,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1680913719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361236968/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T20:34:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361236968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361237154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361237154"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-16T20:34:56Z",
      "diff_hunk" : "@@ -101,6 +101,17 @@ typedef int64_t NodeId;\n struct AddedNodeParams {\n     std::string m_added_node;\n     bool m_use_v2transport;\n+    bool operator==(const AddedNodeParams& p) const\n+    {\n+        return m_added_node == p.m_added_node && m_use_v2transport == p.m_use_v2transport;\n+    }\n+};\n+\n+struct AddedNodeHasher {\n+    size_t operator()(const AddedNodeParams& p) const noexcept",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361237154",
      "id" : 1361237154,
      "in_reply_to_id" : 1356598798,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RItSi",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 111,
      "original_position" : 11,
      "original_start_line" : 110,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1680913997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361237154/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-16T20:34:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361237154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361237294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361237294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-16T20:35:04Z",
      "diff_hunk" : "@@ -1847,6 +1861,16 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Don't accept inbound connections from peers already connected to us.\n+    // Skip this check for inbound Tor connections, as each IP will differ.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361237294",
      "id" : 1361237294,
      "in_reply_to_id" : 1356561796,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RItUu",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 1866,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1680914186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361237294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T20:35:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361237294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361245328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361245328"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks. I hesitated on this point. Done.",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-16T20:45:14Z",
      "diff_hunk" : "@@ -2760,6 +2787,19 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 continue;\n             }\n \n+            // Do not make automatic outbound connections to addnode peers,\n+            // to allocate our limited outbound slots correctly and to ensure\n+            // addnode connections benefit from their intended protections.\n+            // Expect BIP324 transport when both us and them have NODE_V2_P2P set.\n+            const bool v2_p2p(addr.nServices & GetLocalServices() & NODE_P2P_V2);\n+            if (WITH_LOCK(m_added_nodes_mutex, return m_added_node_params.count({addr.ToStringAddr(), v2_p2p}) || m_added_node_params.count({addr.ToStringAddrPort(), v2_p2p}))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361245328",
      "id" : 1361245328,
      "in_reply_to_id" : 1356628687,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RIvSQ",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 2795,
      "original_position" : 187,
      "original_start_line" : 2794,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1680928309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361245328/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-16T20:45:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361245328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361303135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361303135"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@vasild Thanks! I agree with your bimodal approach and replaced 71528aeaba2fbb3141693b000f2ec7799074bfdf with your suggestion above credited to you.",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-16T21:52:43Z",
      "diff_hunk" : "@@ -2734,13 +2734,13 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n \n \n     // Build a map of all already connected addresses (by IP:port and by name) to inbound/outbound and resolved CService\n-    std::map<CService, bool> mapConnected;\n+    std::map<CNetAddr, bool> mapConnected;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361303135",
      "id" : 1361303135,
      "in_reply_to_id" : 1323598562,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RI9Zf",
      "original_commit_id" : "54804cba858b614462b21e20dac088b2e7740e11",
      "original_line" : 2858,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1681020942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361303135/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-16T21:52:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361303135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361380390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361380390"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that makes sense. Done -- thanks!",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T00:20:34Z",
      "diff_hunk" : "@@ -408,9 +408,13 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+std::optional<CNode*> CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return std::nullopt; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    if (auto pnode = FindNode(static_cast<CNetAddr>(service))) return pnode;\n+    if (auto pnode = FindNode(service.ToStringAddrPort())) return pnode;\n+    return std::nullopt;\n }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361380390",
      "id" : 1361380390,
      "in_reply_to_id" : 1356590348,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJQQm",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 438,
      "original_position" : 22,
      "original_start_line" : 411,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1681130735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361380390/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T00:20:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361380390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361468438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361468438"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good points. Changed `AlreadyConnectedToAddress()` back to return a `bool` and log the message from inside it.",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T03:29:09Z",
      "diff_hunk" : "@@ -408,9 +408,13 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+std::optional<CNode*> CConnman::AlreadyConnectedToAddress(const CAddress& addr)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361468438",
      "id" : 1361468438,
      "in_reply_to_id" : 1356484191,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJlwW",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 411,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1681302157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361468438/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T03:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361468438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361473409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361473409"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Keeping the call (thanks).",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T03:41:05Z",
      "diff_hunk" : "@@ -2902,7 +2944,7 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n     }\n     if (!pszDest) {\n         bool banned_or_discouraged = m_banman && (m_banman->IsDiscouraged(addrConnect) || m_banman->IsBanned(addrConnect));\n-        if (IsLocal(addrConnect) || banned_or_discouraged || AlreadyConnectedToAddress(addrConnect)) {\n+        if (IsLocal(addrConnect) || banned_or_discouraged) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361473409",
      "id" : 1361473409,
      "in_reply_to_id" : 1356558158,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJm-B",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 2947,
      "original_position" : 248,
      "original_start_line" : 2905,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1681309253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361473409/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T03:41:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361473409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361490253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361490253"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's adapted from the `struct MyHash` code example in https://en.cppreference.com/w/cpp/utility/hash, and I've updated it in the latest push to be more like that example.  I'd be very happy for advice on how to improve that hashing function or use our time-tested existing ones.\r\n\r\n```cpp\r\nstruct MyHash\r\n{\r\n    std::size_t operator()(const S& s) const noexcept\r\n    {\r\n        std::size_t h1 = std::hash<std::string>{}(s.first_name);\r\n        std::size_t h2 = std::hash<std::string>{}(s.last_name);\r\n        return h1 ^ (h2 << 1);\r\n    }\r\n};\r\n```\r\n",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T04:19:16Z",
      "diff_hunk" : "@@ -101,6 +101,17 @@ typedef int64_t NodeId;\n struct AddedNodeParams {\n     std::string m_added_node;\n     bool m_use_v2transport;\n+    bool operator==(const AddedNodeParams& p) const\n+    {\n+        return m_added_node == p.m_added_node && m_use_v2transport == p.m_use_v2transport;\n+    }\n+};\n+\n+struct AddedNodeHasher {\n+    size_t operator()(const AddedNodeParams& p) const noexcept\n+    {\n+        return std::hash<std::string>()(p.m_added_node) ^ (std::hash<bool>()(p.m_use_v2transport) << 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361490253",
      "id" : 1361490253,
      "in_reply_to_id" : 1356610866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJrFN",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 113,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1681333894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361490253/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T04:19:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361490253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you, @vasild! I've pushed a WIP checkpoint update covering all your suggestions. Will return to it tomorrow and happy to take any further suggestions you may have.",
      "created_at" : "2023-10-17T05:07:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1765675944",
      "id" : 1765675944,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585pPhOo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765675944/reactions"
      },
      "updated_at" : "2023-10-17T05:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1765675944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361515079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361515079"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good question.  I've rewritten `AlreadyConnectedToAddress()` with the suggestions in https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1356590348. Do you think that resolves the possible issue you describe?",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T05:09:29Z",
      "diff_hunk" : "@@ -1814,6 +1814,16 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Don't accept inbound connections from peers already connected to us.\n+    // Skip this check for Tor, as their inbound/outbound addresses differ.\n+    if (!inbound_onion) {\n+        if (auto pnode = AlreadyConnectedToAddress(addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1361515079",
      "id" : 1361515079,
      "in_reply_to_id" : 1323646824,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RJxJH",
      "original_commit_id" : "b97cfd18da8ad4e29319b8e3c84c3388cd75ff60",
      "original_line" : 1868,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1681374558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361515079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T05:09:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1361515079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362002965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362002965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am not sure why they used `<< 1`. It seems to be useless and also it drops one bit from `h2`. Maybe to avoid returning `0` if first name and last name happen to be equal?\r\n\r\nI think for the purposes of hashing `m_added_node_params` this suffices:\r\n```cpp\r\n    size_t operator()(const AddedNodeParams& p) const noexcept\r\n    {\r\n        return std::hash<std::string>()(p.m_added_node) ^ p.m_use_v2transport;\r\n    }\r\n```\r\n\r\nHowever `std::hash` is not used anywhere in the code (modulo in some tests and benchmarks). `CServiceHash` uses `CSipHasher`, but there are security concerns with an outsider being able to fiddle with the hashing, maybe this is an overkill for `AddedNodeParams`. If that is to be used here, then it would look like:\r\n\r\n```cpp\r\n        CSipHasher hasher(m_salt_k0, m_salt_k1);\r\n        hasher.Write(MakeUCharSpan(p.m_added_node));\r\n        hasher.Write(p.m_use_v2transport);\r\n        return static_cast<size_t>(hasher.Finalize());\r\n```\r\n\r\nOr use some of the stateless `Hash*` functions from `src/hash.h`.\r\n\r\nI guess @sipa can give us an advice?",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T12:01:57Z",
      "diff_hunk" : "@@ -101,6 +101,17 @@ typedef int64_t NodeId;\n struct AddedNodeParams {\n     std::string m_added_node;\n     bool m_use_v2transport;\n+    bool operator==(const AddedNodeParams& p) const\n+    {\n+        return m_added_node == p.m_added_node && m_use_v2transport == p.m_use_v2transport;\n+    }\n+};\n+\n+struct AddedNodeHasher {\n+    size_t operator()(const AddedNodeParams& p) const noexcept\n+    {\n+        return std::hash<std::string>()(p.m_added_node) ^ (std::hash<bool>()(p.m_use_v2transport) << 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362002965",
      "id" : 1362002965,
      "in_reply_to_id" : 1356610866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RLoQV",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 113,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1682140589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362002965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T12:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362002965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362086687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362086687"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can use `CConnman::FindNode(const CService& addr)` here?\r\n```suggestion\r\n        pnode = FindNode(service, /*inbound=*/false);\r\n```\r\n\r\nbut then we will not be comparing against `CNode::m_addr_name`. I wonder if we should compare against both `CNode::addr` and `CNode::m_addr_name`?",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T13:08:52Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362086687",
      "id" : 1362086687,
      "line" : 424,
      "node_id" : "PRRC_kwDOABII585RL8sf",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 424,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 1682305820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362086687/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T13:40:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362086687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362096272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362096272"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Dereferencing `pnode` after `FindNode()` has released `m_nodes_mutex` is not safe. I don't like adding recursive mutex calls, but without altering `FindNode()` we have to do that - this code has to acquire the mutex before any call to `FindNode()`, dereference the returned pointer and then release the mutex:\r\n\r\n```diff\r\n bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\r\n {\r\n     if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\r\n     const CService service{MaybeFlipIPv6toCJDNS(addr)};\r\n     const bool inbound{conn_type == ConnectionType::INBOUND};\r\n     CNode* pnode{nullptr};\r\n+    LOCK(m_nodes_mutex);\r\n     if (inbound) {\r\n         // For accepting an inbound connection, check all existing connections by addr only.\r\n         pnode = FindNode(static_cast<CNetAddr>(service));\r\n     } else {\r\n         // For making an outbound connection, check the existing outbound connections\r\n         // by addr and port, and if none, then inbound connections by addr only.\r\n         pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);\r\n         if (!pnode) pnode = FindNode(static_cast<CNetAddr>(service), /*inbound=*/true);\r\n     }\r\n     if (pnode && log) {\r\n         LogPrintLevel(BCLog::NET, inbound ? BCLog::Level::Debug : BCLog::Level::Info,\r\n                       \"Not %s new %s connection%s, already connected to %s %s %s peer=%d%s, version=%d, subver=%s\\n\",\r\n                       inbound ? \"accepting\" : \"opening\", ConnectionTypeAsString(conn_type),\r\n                       fLogIPs ? strprintf(\" %s %s\", inbound ? \"from\" : \"to\", addr.ToStringAddrPort()) : \"\",\r\n                       TransportTypeAsString(pnode->m_transport->GetInfo().transport_type),\r\n                       pnode->ConnectionTypeAsString(), GetNetworkName(pnode->ConnectedThroughNetwork()),\r\n                       pnode->GetId(), fLogIPs ? strprintf(\", peeraddr=%s\", pnode->addr.ToStringAddrPort()) : \"\",\r\n                       pnode->nVersion.load(), WITH_LOCK(pnode->m_subver_mutex, return pnode->cleanSubVer));\r\n     }\r\n-    return pnode;\r\n+    return pnode != nullptr;\r\n }\r\n```",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T13:15:55Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);\n+        if (!pnode) pnode = FindNode(static_cast<CNetAddr>(service), /*inbound=*/true);\n+    }\n+    if (pnode && log) {\n+        LogPrintLevel(BCLog::NET, inbound ? BCLog::Level::Debug : BCLog::Level::Info,\n+                      \"Not %s new %s connection%s, already connected to %s %s %s peer=%d%s, version=%d, subver=%s\\n\",\n+                      inbound ? \"accepting\" : \"opening\", ConnectionTypeAsString(conn_type),\n+                      fLogIPs ? strprintf(\" %s %s\", inbound ? \"from\" : \"to\", addr.ToStringAddrPort()) : \"\",\n+                      TransportTypeAsString(pnode->m_transport->GetInfo().transport_type),\n+                      pnode->ConnectionTypeAsString(), GetNetworkName(pnode->ConnectedThroughNetwork()),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362096272",
      "id" : 1362096272,
      "line" : 433,
      "node_id" : "PRRC_kwDOABII585RL_CQ",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 433,
      "original_position" : 63,
      "original_start_line" : 425,
      "path" : "src/net.cpp",
      "position" : 63,
      "pull_request_review_id" : 1682305820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362096272/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 425,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T13:40:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362096272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362126888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362126888"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Here and in the other `FindNode()` using `std::optional<bool>` as a boolean is a bit unclear whether we are checking if the optional has a value or whether the value is true. I find this more clear:\r\n\r\n```suggestion\r\n        if (static_cast<CNetAddr>(pnode->addr) == ip && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\r\n```",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T13:35:36Z",
      "diff_hunk" : "@@ -364,11 +365,11 @@ bool IsLocal(const CService& addr)\n     return mapLocalHost.count(addr) > 0;\n }\n \n-CNode* CConnman::FindNode(const CNetAddr& ip)\n+CNode* CConnman::FindNode(const CNetAddr& ip, std::optional<bool> inbound)\n {\n     LOCK(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-      if (static_cast<CNetAddr>(pnode->addr) == ip) {\n+        if (static_cast<CNetAddr>(pnode->addr) == ip && (!inbound || pnode->IsInboundConn() == inbound)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362126888",
      "id" : 1362126888,
      "line" : 372,
      "node_id" : "PRRC_kwDOABII585RMGgo",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 1682305820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362126888/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T13:40:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362126888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362144275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362144275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "<strike>Added new `FindNode` methods with 2 params rather than modifying the existing ones.</strike>\r\n\r\nDone.",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T13:44:54Z",
      "diff_hunk" : "@@ -364,11 +365,11 @@ bool IsLocal(const CService& addr)\n     return mapLocalHost.count(addr) > 0;\n }\n \n-CNode* CConnman::FindNode(const CNetAddr& ip)\n+CNode* CConnman::FindNode(const CNetAddr& ip, std::optional<bool> inbound)\n {\n     LOCK(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-      if (static_cast<CNetAddr>(pnode->addr) == ip) {\n+        if (static_cast<CNetAddr>(pnode->addr) == ip && (!inbound || pnode->IsInboundConn() == inbound)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362144275",
      "id" : 1362144275,
      "in_reply_to_id" : 1362126888,
      "line" : 372,
      "node_id" : "PRRC_kwDOABII585RMKwT",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 372,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 1682415998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362144275/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T03:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362144275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362147437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362147437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point. (Several times I've been tempted to move the locking inside the `FindNode` methods to their callers.)",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T13:46:39Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);\n+        if (!pnode) pnode = FindNode(static_cast<CNetAddr>(service), /*inbound=*/true);\n+    }\n+    if (pnode && log) {\n+        LogPrintLevel(BCLog::NET, inbound ? BCLog::Level::Debug : BCLog::Level::Info,\n+                      \"Not %s new %s connection%s, already connected to %s %s %s peer=%d%s, version=%d, subver=%s\\n\",\n+                      inbound ? \"accepting\" : \"opening\", ConnectionTypeAsString(conn_type),\n+                      fLogIPs ? strprintf(\" %s %s\", inbound ? \"from\" : \"to\", addr.ToStringAddrPort()) : \"\",\n+                      TransportTypeAsString(pnode->m_transport->GetInfo().transport_type),\n+                      pnode->ConnectionTypeAsString(), GetNetworkName(pnode->ConnectedThroughNetwork()),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362147437",
      "id" : 1362147437,
      "in_reply_to_id" : 1362096272,
      "line" : 433,
      "node_id" : "PRRC_kwDOABII585RMLht",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 433,
      "original_position" : 63,
      "original_start_line" : 425,
      "path" : "src/net.cpp",
      "position" : 63,
      "pull_request_review_id" : 1682420261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362147437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 425,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T13:46:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362147437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362154109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362154109"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Maybe to avoid returning `0` if first name and last name happen to be equal?\r\n\r\nIndeed, makes sense.\r\n\r\n> I think for the purposes of hashing `m_added_node_params` this suffices:\r\n> \r\n> ```c++\r\n>         return std::hash<std::string>()(p.m_added_node) ^ p.m_use_v2transport;\r\n> ```\r\n\r\nð \r\n\r\n> However `std::hash` is not used anywhere in the code (modulo in some tests and benchmarks). `CServiceHash` uses `CSipHasher`. If that is to be used here, then it would look like:\r\n> \r\n> ```c++\r\n>         CSipHasher hasher(m_salt_k0, m_salt_k1);\r\n>         hasher.Write(MakeUCharSpan(p.m_added_node));\r\n>         hasher.Write(p.m_use_v2transport);\r\n>         return static_cast<size_t>(hasher.Finalize());\r\n> ```\r\n> \r\n> Or use some of the stateless `Hash*` functions from `src/hash.h`.\r\n\r\nð \r\n",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T13:50:12Z",
      "diff_hunk" : "@@ -101,6 +101,17 @@ typedef int64_t NodeId;\n struct AddedNodeParams {\n     std::string m_added_node;\n     bool m_use_v2transport;\n+    bool operator==(const AddedNodeParams& p) const\n+    {\n+        return m_added_node == p.m_added_node && m_use_v2transport == p.m_use_v2transport;\n+    }\n+};\n+\n+struct AddedNodeHasher {\n+    size_t operator()(const AddedNodeParams& p) const noexcept\n+    {\n+        return std::hash<std::string>()(p.m_added_node) ^ (std::hash<bool>()(p.m_use_v2transport) << 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362154109",
      "id" : 1362154109,
      "in_reply_to_id" : 1356610866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMNJ9",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 113,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1682429054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362154109/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-17T13:50:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362154109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362269096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362269096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "<strike>Updated with the `CSipHasher` version (thanks!)</strike>\r\n\r\nEdit: the addnode test in `test/functional/rpc_net.py` failed with the `CSipHasher` version suggestion (implemented like `CServiceHash` or `CNetAddrHash`).\r\n\r\nUsing `return std::hash<std::string>()(p.m_added_node) ^ p.m_use_v2transport;` in the latest push.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-17T14:53:54Z",
      "diff_hunk" : "@@ -101,6 +101,17 @@ typedef int64_t NodeId;\n struct AddedNodeParams {\n     std::string m_added_node;\n     bool m_use_v2transport;\n+    bool operator==(const AddedNodeParams& p) const\n+    {\n+        return m_added_node == p.m_added_node && m_use_v2transport == p.m_use_v2transport;\n+    }\n+};\n+\n+struct AddedNodeHasher {\n+    size_t operator()(const AddedNodeParams& p) const noexcept\n+    {\n+        return std::hash<std::string>()(p.m_added_node) ^ (std::hash<bool>()(p.m_use_v2transport) << 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362269096",
      "id" : 1362269096,
      "in_reply_to_id" : 1356610866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RMpOo",
      "original_commit_id" : "2a9db3a16a93d497bfe496b7c35edac975ee81d2",
      "original_line" : 113,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1682593573,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362269096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T02:19:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362269096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362301544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362301544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-17T15:14:56Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);\n+        if (!pnode) pnode = FindNode(static_cast<CNetAddr>(service), /*inbound=*/true);\n+    }\n+    if (pnode && log) {\n+        LogPrintLevel(BCLog::NET, inbound ? BCLog::Level::Debug : BCLog::Level::Info,\n+                      \"Not %s new %s connection%s, already connected to %s %s %s peer=%d%s, version=%d, subver=%s\\n\",\n+                      inbound ? \"accepting\" : \"opening\", ConnectionTypeAsString(conn_type),\n+                      fLogIPs ? strprintf(\" %s %s\", inbound ? \"from\" : \"to\", addr.ToStringAddrPort()) : \"\",\n+                      TransportTypeAsString(pnode->m_transport->GetInfo().transport_type),\n+                      pnode->ConnectionTypeAsString(), GetNetworkName(pnode->ConnectedThroughNetwork()),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1362301544",
      "id" : 1362301544,
      "in_reply_to_id" : 1362096272,
      "line" : 433,
      "node_id" : "PRRC_kwDOABII585RMxJo",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 433,
      "original_position" : 63,
      "original_start_line" : 425,
      "path" : "src/net.cpp",
      "position" : 63,
      "pull_request_review_id" : 1682645329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362301544/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 425,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-17T15:14:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1362301544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1363082393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363082393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Proposed an implementation:\r\n\r\n```cpp\r\npnode = FindNode(service, /*inbound=*/false);\r\nif (!pnode || !pnode->addr.IsValid()) pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);\r\nif (!pnode || !pnode->addr.IsValid()) pnode = FindNode(static_cast<CNetAddr>(service), /*inbound=*/true);\r\n```",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-18T03:15:37Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1363082393",
      "id" : 1363082393,
      "in_reply_to_id" : 1362086687,
      "line" : 424,
      "node_id" : "PRRC_kwDOABII585RPvyZ",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 424,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 1683867144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363082393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T03:15:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363082393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1363491489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363491489"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks good. Can `CNode::addr` ever be invalid?",
      "commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "created_at" : "2023-10-18T08:41:50Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1363491489",
      "id" : 1363491489,
      "in_reply_to_id" : 1362086687,
      "line" : 424,
      "node_id" : "PRRC_kwDOABII585RRTqh",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 424,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 1684470261,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363491489/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-18T08:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1363491489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-19T18:26:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1771503614",
      "id" : 1771503614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585plv_-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771503614/reactions"
      },
      "updated_at" : "2023-10-19T18:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1771503614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1369594937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369594937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure, so keeping as belt and suspenders.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T03:45:13Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1369594937",
      "id" : 1369594937,
      "in_reply_to_id" : 1362086687,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rolw5",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 424,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1693979860,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369594937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T03:45:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369594937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1369597289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369597289"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Dereferencing `pnode` after `FindNode()` has released `m_nodes_mutex` is not safe. I don't like adding recursive mutex calls, but without altering `FindNode()` we have to do that.\r\n\r\nDone, and moved the locking from the FindNode* methods to their callers.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T03:46:50Z",
      "diff_hunk" : "@@ -408,9 +409,32 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\n+    const CService service{MaybeFlipIPv6toCJDNS(addr)};\n+    const bool inbound{conn_type == ConnectionType::INBOUND};\n+    CNode* pnode{nullptr};\n+    if (inbound) {\n+        // For accepting an inbound connection, check all existing connections by addr only.\n+        pnode = FindNode(static_cast<CNetAddr>(service));\n+    } else {\n+        // For making an outbound connection, check the existing outbound connections\n+        // by addr and port, and if none, then inbound connections by addr only.\n+        pnode = FindNode(service.ToStringAddrPort(), /*inbound=*/false);\n+        if (!pnode) pnode = FindNode(static_cast<CNetAddr>(service), /*inbound=*/true);\n+    }\n+    if (pnode && log) {\n+        LogPrintLevel(BCLog::NET, inbound ? BCLog::Level::Debug : BCLog::Level::Info,\n+                      \"Not %s new %s connection%s, already connected to %s %s %s peer=%d%s, version=%d, subver=%s\\n\",\n+                      inbound ? \"accepting\" : \"opening\", ConnectionTypeAsString(conn_type),\n+                      fLogIPs ? strprintf(\" %s %s\", inbound ? \"from\" : \"to\", addr.ToStringAddrPort()) : \"\",\n+                      TransportTypeAsString(pnode->m_transport->GetInfo().transport_type),\n+                      pnode->ConnectionTypeAsString(), GetNetworkName(pnode->ConnectedThroughNetwork()),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1369597289",
      "id" : 1369597289,
      "in_reply_to_id" : 1362096272,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585RomVp",
      "original_commit_id" : "44ceac2ef9992c799dce22477a5884bd82ba9860",
      "original_line" : 388,
      "original_position" : 63,
      "original_start_line" : 425,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1693983561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369597289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-24T03:46:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1369597289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and updated to take the latest feedback from @vasild.",
      "created_at" : "2023-10-24T04:01:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1776503589",
      "id" : 1776503589,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585p40sl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776503589/reactions"
      },
      "updated_at" : "2023-10-24T13:34:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776503589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Re-rebased with no code changes for the CI fuzzer timeout (then saw that it's not fixed yet, sorry).",
      "created_at" : "2023-10-24T13:41:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1777230469",
      "id" : 1777230469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585p7mKF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1777230469/reactions"
      },
      "updated_at" : "2023-10-24T13:41:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1777230469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370281097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370281097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just because the connections come from the same IP does no mean it is the same peer, e.g. multiple peers could be connecting to you through the same Tor exit relay.\r\n\r\nThis does not seem like a bug fix and more like a behavior change. Our inbound eviction logic should handle stuff like this and it probably already does.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:25:53Z",
      "diff_hunk" : "@@ -1819,6 +1819,14 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Do not accept inbound connections from peers already connected to us.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370281097",
      "id" : 1370281097,
      "line" : 1826,
      "node_id" : "PRRC_kwDOABII585RrNSJ",
      "original_commit_id" : "2ec971326d3de33455a626b8189e0375fc88061f",
      "original_line" : 1823,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 146,
      "pull_request_review_id" : 1695037517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370281097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:25:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370281097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370290642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370290642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```cpp\r\n    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains\r\n```\r\n\r\nThis seems very out of place to me, and would also prevent writing certain types of tests?",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:30:42Z",
      "diff_hunk" : "@@ -328,42 +329,67 @@ bool IsLocal(const CService& addr)\n     return mapLocalHost.count(addr) > 0;\n }\n \n-CNode* CConnman::FindNode(const CNetAddr& ip)\n+CNode* CConnman::FindNode(const CNetAddr& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-      if (static_cast<CNetAddr>(pnode->addr) == ip) {\n+        if (static_cast<CNetAddr>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const std::string& addrName)\n+CNode* CConnman::FindNode(const std::string& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (pnode->m_addr_name == addrName) {\n+        if (pnode->m_addr_name == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const CService& addr)\n+CNode* CConnman::FindNode(const CService& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (static_cast<CService>(pnode->addr) == addr) {\n+        if (static_cast<CService>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370290642",
      "id" : 1370290642,
      "line" : 367,
      "node_id" : "PRRC_kwDOABII585RrPnS",
      "original_commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "original_line" : 367,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 58,
      "pull_request_review_id" : 1695050402,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370290642/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:30:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370290642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\ntests for the bug fixes would be helpful",
      "created_at" : "2023-10-24T14:31:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1777344970",
      "id" : 1777344970,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28248",
      "node_id" : "IC_kwDOABII585p8CHK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1777344970/reactions"
      },
      "updated_at" : "2023-10-24T14:32:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1777344970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370295096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370295096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Inbound tor peers are exempted from this check.  I do see many such redundant connection attempts logged when running this branch. In the case of I2P peers, needlessly accepting to build these tunnels can be expensive. As mentioned in the commit message, the other fixes in this PR may mitigate this behavior by our peers, but not for nodes running earlier versions of Bitcoin Core.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:32:46Z",
      "diff_hunk" : "@@ -1819,6 +1819,14 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Do not accept inbound connections from peers already connected to us.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370295096",
      "id" : 1370295096,
      "in_reply_to_id" : 1370281097,
      "line" : 1826,
      "node_id" : "PRRC_kwDOABII585RrQs4",
      "original_commit_id" : "2ec971326d3de33455a626b8189e0375fc88061f",
      "original_line" : 1823,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 146,
      "pull_request_review_id" : 1695055890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370295096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370295096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370296681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370296681"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is required currently for several of our p2p functional tests. They would need to be updated not to make bilateral connections.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:33:33Z",
      "diff_hunk" : "@@ -328,42 +329,67 @@ bool IsLocal(const CService& addr)\n     return mapLocalHost.count(addr) > 0;\n }\n \n-CNode* CConnman::FindNode(const CNetAddr& ip)\n+CNode* CConnman::FindNode(const CNetAddr& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-      if (static_cast<CNetAddr>(pnode->addr) == ip) {\n+        if (static_cast<CNetAddr>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const std::string& addrName)\n+CNode* CConnman::FindNode(const std::string& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (pnode->m_addr_name == addrName) {\n+        if (pnode->m_addr_name == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const CService& addr)\n+CNode* CConnman::FindNode(const CService& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (static_cast<CService>(pnode->addr) == addr) {\n+        if (static_cast<CService>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370296681",
      "id" : 1370296681,
      "in_reply_to_id" : 1370290642,
      "line" : 367,
      "node_id" : "PRRC_kwDOABII585RrRFp",
      "original_commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "original_line" : 367,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 58,
      "pull_request_review_id" : 1695058000,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370296681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:34:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370296681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370301459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370301459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Which tests?",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:35:21Z",
      "diff_hunk" : "@@ -328,42 +329,67 @@ bool IsLocal(const CService& addr)\n     return mapLocalHost.count(addr) > 0;\n }\n \n-CNode* CConnman::FindNode(const CNetAddr& ip)\n+CNode* CConnman::FindNode(const CNetAddr& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-      if (static_cast<CNetAddr>(pnode->addr) == ip) {\n+        if (static_cast<CNetAddr>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const std::string& addrName)\n+CNode* CConnman::FindNode(const std::string& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (pnode->m_addr_name == addrName) {\n+        if (pnode->m_addr_name == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const CService& addr)\n+CNode* CConnman::FindNode(const CService& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (static_cast<CService>(pnode->addr) == addr) {\n+        if (static_cast<CService>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370301459",
      "id" : 1370301459,
      "in_reply_to_id" : 1370290642,
      "line" : 367,
      "node_id" : "PRRC_kwDOABII585RrSQT",
      "original_commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "original_line" : 367,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 58,
      "pull_request_review_id" : 1695064681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370301459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370301459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370307319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370307319"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Inbound tor peers are exempted from this check.\r\n\r\nWe don't have logic for detecting if someone is using Tor as a proxy to connect to the IPv4 network. Our \"inbound Tor\" classification simply refers to someone connecting to our hidden service.\r\n\r\nAnother example would be multiple peers connecting to us through the same VPN provider.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:38:13Z",
      "diff_hunk" : "@@ -1819,6 +1819,14 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Do not accept inbound connections from peers already connected to us.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370307319",
      "id" : 1370307319,
      "in_reply_to_id" : 1370281097,
      "line" : 1826,
      "node_id" : "PRRC_kwDOABII585RrTr3",
      "original_commit_id" : "2ec971326d3de33455a626b8189e0375fc88061f",
      "original_line" : 1823,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 146,
      "pull_request_review_id" : 1695073724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370307319/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:40:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370307319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370312562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370312562"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> They would need to be updated not to make bilateral connections.\r\n\r\nI would suggest updating the tests to account for the behaviour you've changed (it may also help to make the bug fixes clearer for reviewers); rather than introducing per-chain, networking functionality. This seems generally dangerous, and mostly unintuitive.",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:39:44Z",
      "diff_hunk" : "@@ -328,42 +329,67 @@ bool IsLocal(const CService& addr)\n     return mapLocalHost.count(addr) > 0;\n }\n \n-CNode* CConnman::FindNode(const CNetAddr& ip)\n+CNode* CConnman::FindNode(const CNetAddr& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-      if (static_cast<CNetAddr>(pnode->addr) == ip) {\n+        if (static_cast<CNetAddr>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const std::string& addrName)\n+CNode* CConnman::FindNode(const std::string& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (pnode->m_addr_name == addrName) {\n+        if (pnode->m_addr_name == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const CService& addr)\n+CNode* CConnman::FindNode(const CService& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (static_cast<CService>(pnode->addr) == addr) {\n+        if (static_cast<CService>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370312562",
      "id" : 1370312562,
      "in_reply_to_id" : 1370290642,
      "line" : 367,
      "node_id" : "PRRC_kwDOABII585RrU9y",
      "original_commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "original_line" : 367,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 58,
      "pull_request_review_id" : 1695079464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370312562/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:39:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370312562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370338677"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370338677"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, this could be dropped and deferred until later, to see if the other fixes resolve the behavior seen from peers (I think it's likely).",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T14:47:53Z",
      "diff_hunk" : "@@ -1819,6 +1819,14 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Do not accept inbound connections from peers already connected to us.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370338677",
      "id" : 1370338677,
      "in_reply_to_id" : 1370281097,
      "line" : 1826,
      "node_id" : "PRRC_kwDOABII585RrbV1",
      "original_commit_id" : "2ec971326d3de33455a626b8189e0375fc88061f",
      "original_line" : 1823,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 146,
      "pull_request_review_id" : 1695117966,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370338677/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T14:47:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370338677",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370365935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370365935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> MaybeFlipIPv6toCJDNS\r\n\r\nIs there any way to better encapsulate this `MaybeFlipIPv6toCJDNS()` usage? This seems to be a frequent pattern (a number of additional calls were added in #27071), and it seems like something that would be better handled at a lower level, rather than having to continually remember to wrap various networking-related calls.\r\n\r\nI guess this is also able to remain broken is various ways because we don't have any specific tests for this functionality?",
      "commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "created_at" : "2023-10-24T15:04:19Z",
      "diff_hunk" : "@@ -2783,18 +2833,21 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n     }\n \n     for (const auto& addr : lAddresses) {\n-        CService service(LookupNumeric(addr.m_added_node, GetDefaultPort(addr.m_added_node)));\n+        CService service{MaybeFlipIPv6toCJDNS(LookupNumeric(addr.m_added_node, GetDefaultPort(addr.m_added_node)))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370365935",
      "id" : 1370365935,
      "line" : 2836,
      "node_id" : "PRRC_kwDOABII585Rrh_v",
      "original_commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "original_line" : 2836,
      "original_position" : 288,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 288,
      "pull_request_review_id" : 1695165495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370365935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T15:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370365935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370710929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370710929"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good points. Tests like `rpc_net.py`, `p2p_blockfilters.py`, `wallet_groups` and others, are making bilateral connections using `connect_nodes()`. For instance, from `rpc_net.py`:\r\n\r\n```\r\n        # By default, the test framework sets up an addnode connection from\r\n        # node 1 --> node0. By connecting node0 --> node 1, we're left with\r\n        # the two nodes being connected both ways.\r\n        # Topology will look like: node0 <--> node1\r\n```\r\n\r\nBehind the scenes, the test framework is calling RPC `addnode \"onetry\"` for the `connect_nodes` calls.  Our peer detection looked like it was intended to find already connected inbound peers, but in practice it did not in some cases, and one is when we make addnode connections in our testing.  Perhaps it is an expected use case.\r\n\r\nFor now, I updated `AlreadyConnectedToAddress()` to explicitly allow bilateral connections for manual peers, pending feedback, and dropped the `IsTestChain()` check.",
      "commit_id" : "4238b6f0a7553ebc5cee6f7c77d3813193f7a322",
      "created_at" : "2023-10-24T19:19:08Z",
      "diff_hunk" : "@@ -328,42 +329,67 @@ bool IsLocal(const CService& addr)\n     return mapLocalHost.count(addr) > 0;\n }\n \n-CNode* CConnman::FindNode(const CNetAddr& ip)\n+CNode* CConnman::FindNode(const CNetAddr& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-      if (static_cast<CNetAddr>(pnode->addr) == ip) {\n+        if (static_cast<CNetAddr>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const std::string& addrName)\n+CNode* CConnman::FindNode(const std::string& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (pnode->m_addr_name == addrName) {\n+        if (pnode->m_addr_name == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-CNode* CConnman::FindNode(const CService& addr)\n+CNode* CConnman::FindNode(const CService& addr, std::optional<bool> inbound)\n {\n-    LOCK(m_nodes_mutex);\n+    AssertLockHeld(m_nodes_mutex);\n     for (CNode* pnode : m_nodes) {\n-        if (static_cast<CService>(pnode->addr) == addr) {\n+        if (static_cast<CService>(pnode->addr) == addr && (!inbound.has_value() || pnode->IsInboundConn() == inbound.value())) {\n             return pnode;\n         }\n     }\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)\n {\n-    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringAddrPort());\n+    if (Params().IsTestChain()) return false; // allow bilateral connections on test chains",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370710929",
      "id" : 1370710929,
      "in_reply_to_id" : 1370290642,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rs2OR",
      "original_commit_id" : "f196b096f55f909e2bb63d5ff43bc3418c0ebbab",
      "original_line" : 367,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1695714255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370710929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T19:19:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370710929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370713054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370713054"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated to only apply this check to inbound I2P peers we're already connected to, due to the resource cost of creating new tunnels.",
      "commit_id" : "4238b6f0a7553ebc5cee6f7c77d3813193f7a322",
      "created_at" : "2023-10-24T19:21:19Z",
      "diff_hunk" : "@@ -1819,6 +1819,14 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Do not accept inbound connections from peers already connected to us.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370713054",
      "id" : 1370713054,
      "in_reply_to_id" : 1370281097,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rs2ve",
      "original_commit_id" : "2ec971326d3de33455a626b8189e0375fc88061f",
      "original_line" : 1823,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1695717544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370713054/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T19:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370713054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370713902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370713902"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated to only apply this check to inbound I2P peers we're already connected to, due to the resource cost of creating new tunnels.",
      "commit_id" : "4238b6f0a7553ebc5cee6f7c77d3813193f7a322",
      "created_at" : "2023-10-24T19:22:19Z",
      "diff_hunk" : "@@ -1814,6 +1814,16 @@ void CConnman::CreateNodeFromAcceptedSocket(std::unique_ptr<Sock>&& sock,\n     }\n \n     const bool inbound_onion = std::find(m_onion_binds.begin(), m_onion_binds.end(), addr_bind) != m_onion_binds.end();\n+\n+    // Don't accept inbound connections from peers already connected to us.\n+    // Skip this check for Tor, as their inbound/outbound addresses differ.\n+    if (!inbound_onion) {\n+        if (auto pnode = AlreadyConnectedToAddress(addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370713902",
      "id" : 1370713902,
      "in_reply_to_id" : 1323646824,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Rs28u",
      "original_commit_id" : "b97cfd18da8ad4e29319b8e3c84c3388cd75ff60",
      "original_line" : 1868,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1695718958,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370713902/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T19:22:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370713902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370747413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370747413"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit d746231809814f52695a376bd77f4d06622289a4 (`p2p, bugfix: detect all inbound connections in GetAddedNodeInfo()`):\r\n\r\nI'm not sure if this fixes a bug - comparing on the level of `CNetAddr` seems rather strict to me.\r\nFor example, I think that in the current form, we will not attempt to make a manual connection to an `addnode` localhost peer `127.0.0.1:XXXX` if we have any inbound tor peer. \r\nOr we wouldn't be able to be part of a larger local network built from manual connections that has both incoming and outgoing connections to different local peers.\r\n\r\nMore generally speaking, I think that it is very hard (impossible?) to ensure that there are no bidirectional connections without restricting legitimate use cases - and maybe not really necessary after all?\r\n ",
      "commit_id" : "4238b6f0a7553ebc5cee6f7c77d3813193f7a322",
      "created_at" : "2023-10-24T19:56:43Z",
      "diff_hunk" : "@@ -2765,15 +2765,19 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo() const\n         std::copy(m_added_node_params.cbegin(), m_added_node_params.cend(), std::back_inserter(lAddresses));\n     }\n \n-\n-    // Build a map of all already connected addresses (by IP:port and by name) to inbound/outbound and resolved CService\n-    std::map<CService, bool> mapConnected;\n+    // Collect all addresses to which we are already connected.\n+    std::unordered_set<CNetAddr, CNetAddrHash> connected_to_inbound;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370747413",
      "id" : 1370747413,
      "line" : 2818,
      "node_id" : "PRRC_kwDOABII585Rs_IV",
      "original_commit_id" : "d746231809814f52695a376bd77f4d06622289a4",
      "original_line" : 2769,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 270,
      "pull_request_review_id" : 1695774761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370747413/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T20:53:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370747413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370787972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370787972"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit: `p2p, bugfix: correctly detect connected peers in AlreadyConnectedToAddress()`\r\nCould you list some examples of scenarios that are not working correctly currently and are improved by this? I'm trying to understand the impact of this commit better.",
      "commit_id" : "4238b6f0a7553ebc5cee6f7c77d3813193f7a322",
      "created_at" : "2023-10-24T20:41:09Z",
      "diff_hunk" : "@@ -361,11 +361,38 @@ CNode* CConnman::FindNode(const CService& addr, std::optional<bool> inbound)\n     return nullptr;\n }\n \n-bool CConnman::AlreadyConnectedToAddress(const CAddress& addr)\n+bool CConnman::AlreadyConnectedToAddress(const CAddress& addr, ConnectionType conn_type, bool log)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28248#discussion_r1370787972",
      "id" : 1370787972,
      "line" : 365,
      "node_id" : "PRRC_kwDOABII585RtJCE",
      "original_commit_id" : "cb82a9285ccb58a1f8fef41c4ce664c5fe46fc94",
      "original_line" : 364,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 1695774761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28248",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370787972/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-24T20:53:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1370787972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
