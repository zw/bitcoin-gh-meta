[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28236).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26606](https://github.com/bitcoin/bitcoin/pull/26606) (wallet: Implement independent BDB parser by achow101)\n* [#26596](https://github.com/bitcoin/bitcoin/pull/26596) (wallet: Migrate legacy wallets to descriptor wallets without requiring BDB by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-08-07T21:25:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1668596559",
      "id" : 1668596559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585jdMNP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668596559/reactions"
      },
      "updated_at" : "2024-04-09T11:45:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668596559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1286425941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286425941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that `CreateSyncedWallet` will call `SetupDescriptorScriptPubKeyMans()` which internally will make a seed.\r\n```cpp\r\nvoid CWallet::SetupDescriptorScriptPubKeyMans()\r\n{\r\n    AssertLockHeld(cs_wallet);\r\n\r\n    if (!IsWalletFlagSet(WALLET_FLAG_EXTERNAL_SIGNER)) {\r\n        // Make a seed\r\n        CKey seed_key;\r\n        seed_key.MakeNewKey(true);\r\n        CPubKey seed = seed_key.GetPubKey();\r\n        assert(seed_key.VerifyPubKey(seed));\r\n\r\n        // Get the extended key\r\n        CExtKey master_key;\r\n        master_key.SetSeed(seed_key);\r\n\r\n        SetupDescriptorScriptPubKeyMans(master_key);\r\n    }\r\n```\r\n\r\nNot sure, but wouldn't it be non-deterministic? A solution would be to have a fuzz version of `CreateSyncedWallet` which calls `SetupDescriptorScriptPubKeyMans` passing a key that we created using buf.",
      "commit_id" : "b8121896a05f8e894f250b4ce6f28c79df34a3d1",
      "created_at" : "2023-08-07T22:17:29Z",
      "diff_hunk" : "@@ -0,0 +1,254 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet { \r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one \r\n+ * instance of CWallet is created and reused as required. \r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes \r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton {\r\n+public:\r\n+    static WalletSingleton& GetInstance() {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet() {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return *wallet;\r\n+    }\r\n+    CoinsResult& GetCoins() {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return available_coins;\r\n+    }\r\n+\r\n+private:\r\n+    WalletSingleton() {\r\n+        InitializeWallet();\r\n+    }\r\n+\r\n+    ~WalletSingleton() {\r\n+        wallet.reset();\r\n+        available_coins.coins.clear();\r\n+    }\r\n+\r\n+    WalletSingleton(const WalletSingleton&) = delete;\r\n+    WalletSingleton& operator=(const WalletSingleton&) = delete;\r\n+\r\n+    void InitializeWallet() {\r\n+        auto& node{g_setup->m_node};\r\n+        wallet = CreateSyncedWallet(*node.chain, WITH_LOCK(Assert(node.chainman)->GetMutex(), return node.chainman->ActiveChain()), g_setup->coinbaseKey);\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1286425941",
      "id" : 1286425941,
      "line" : 65,
      "node_id" : "PRRC_kwDOABII585MrU1V",
      "original_commit_id" : "b8121896a05f8e894f250b4ce6f28c79df34a3d1",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 65,
      "pull_request_review_id" : 1566215643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286425941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-07T22:17:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286425941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1286426350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286426350"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "s/chose/choose",
      "commit_id" : "b8121896a05f8e894f250b4ce6f28c79df34a3d1",
      "created_at" : "2023-08-07T22:18:17Z",
      "diff_hunk" : "@@ -0,0 +1,254 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet { \r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one \r\n+ * instance of CWallet is created and reused as required. \r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes \r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton {\r\n+public:\r\n+    static WalletSingleton& GetInstance() {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet() {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return *wallet;\r\n+    }\r\n+    CoinsResult& GetCoins() {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return available_coins;\r\n+    }\r\n+\r\n+private:\r\n+    WalletSingleton() {\r\n+        InitializeWallet();\r\n+    }\r\n+\r\n+    ~WalletSingleton() {\r\n+        wallet.reset();\r\n+        available_coins.coins.clear();\r\n+    }\r\n+\r\n+    WalletSingleton(const WalletSingleton&) = delete;\r\n+    WalletSingleton& operator=(const WalletSingleton&) = delete;\r\n+\r\n+    void InitializeWallet() {\r\n+        auto& node{g_setup->m_node};\r\n+        wallet = CreateSyncedWallet(*node.chain, WITH_LOCK(Assert(node.chainman)->GetMutex(), return node.chainman->ActiveChain()), g_setup->coinbaseKey);\r\n+\r\n+        // This is placed here because Available Coins will never be updated while fuzzing.\r\n+        LOCK(wallet->cs_wallet);\r\n+        available_coins = AvailableCoins(*wallet);\r\n+    }\r\n+\r\n+    std::unique_ptr<CWallet> wallet;\r\n+    CoinsResult available_coins;\r\n+};\r\n+\r\n+CCoinControl GetNewCoinControl(FuzzedDataProvider& fuzzed_data_provider, CWallet& wallet, std::vector<COutput>& coins) \r\n+{\r\n+    CCoinControl new_coin_control;\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        const CTxDestination tx_destination{ConsumeTxDestination(fuzzed_data_provider)};\r\n+        new_coin_control.destChange = tx_destination;\r\n+    }\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_change_type = fuzzed_data_provider.PickValueInArray(OUTPUT_TYPES);\r\n+    }\r\n+    new_coin_control.m_include_unsafe_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_allow_other_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_feerate = CFeeRate{ConsumeMoney(fuzzed_data_provider, /*max=*/COIN)};\r\n+    }\r\n+    new_coin_control.m_signal_bip125_rbf = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_avoid_partial_spends = fuzzed_data_provider.ConsumeBool();\r\n+    \r\n+    // Taking a random sub-sequence from available coins.\r\n+    for (const COutput& coin : coins) {\r\n+        if(fuzzed_data_provider.ConsumeBool()) {\r\n+            new_coin_control.Select(coin.outpoint);\r\n+        }\r\n+    }\r\n+\r\n+    // Occasionally, some random `CCoutPoint` are also selected.\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        for(int i = 0; i < 10; ++i) {\r\n+            std::optional<COutPoint> optional_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\r\n+            if (!optional_out_point) {\r\n+                continue;\r\n+            }\r\n+            new_coin_control.Select(*optional_out_point);\r\n+        }\r\n+    }\r\n+    return new_coin_control;\r\n+}\r\n+\r\n+void initialize_spend()\r\n+{\r\n+    static auto testing_setup = MakeNoLogFileContext<TestChain100Setup>();\r\n+    g_setup = testing_setup.get();\r\n+\r\n+    // Add 50 spendable UTXO, 50 BTC each, to the wallet (total balance 5000 BTC)\r\n+    // Because none of the UTXO will ever be used (marked as spent), mining this many should be sufficient. \r\n+    for (int i = 0; i < 50; ++i) {\r\n+        g_setup->CreateAndProcessBlock({}, GetScriptForRawPubKey(g_setup->coinbaseKey.GetPubKey()));\r\n+    }\r\n+}\r\n+\r\n+FUZZ_TARGET(spend, .init = initialize_spend)\r\n+{\r\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\r\n+    CWallet& wallet = WalletSingleton::GetInstance().GetWallet();\r\n+    CoinsResult& available_coins = WalletSingleton::GetInstance().GetCoins();\r\n+\r\n+    // Asserting if the `wallet` has no funds.\r\n+    std::vector<COutput> coins = available_coins.All();\r\n+    assert(!coins.empty());\r\n+\r\n+    CCoinControl coin_control;\r\n+    CMutableTransaction mtx;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 505)\r\n+    {\r\n+        CallOneOf(\r\n+            fuzzed_data_provider,\r\n+            [&] {\r\n+                // Creates a new `CoinControl`.\r\n+                coin_control = GetNewCoinControl(fuzzed_data_provider, wallet, coins);\r\n+            },\r\n+            [&] {\r\n+                // Creates a new Transaction using `CreateTransaction`.\r\n+                std::vector<CRecipient> recipients;\r\n+                unsigned int recipients_size = fuzzed_data_provider.ConsumeIntegralInRange<unsigned int>(0, 100);\r\n+                for (unsigned int i = 0; i < recipients_size; ++i) {\r\n+                    recipients.push_back({/*scriptPubKey=*/ConsumeScript(fuzzed_data_provider),\r\n+                                        /*nAmount=*/ConsumeMoney(fuzzed_data_provider), \r\n+                                        /*fSubtractFeeFromAmount=*/fuzzed_data_provider.ConsumeBool()});\r\n+                }\r\n+                // Equally likely to chose one of the three values.\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1286426350",
      "id" : 1286426350,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII585MrU7u",
      "original_commit_id" : "b8121896a05f8e894f250b4ce6f28c79df34a3d1",
      "original_line" : 156,
      "original_position" : 156,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 156,
      "pull_request_review_id" : 1566216191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286426350/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-07T22:18:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286426350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1286427767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427767"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you could keep same pattern as you had previously:\r\n```cpp\r\nstd::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, recipients_size), fuzzed_data_provider.ConsumeIntegral<int>()};\r\nint change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n```\r\n\r\ninstead of \r\n```cpp\r\nint random_positions[3] = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, mtx.vout.size()), fuzzed_data_provider.ConsumeIntegral<int>()};\r\nint change_pos = fuzzed_data_provider.PickValueInArray(random_positions);\r\n```",
      "commit_id" : "b8121896a05f8e894f250b4ce6f28c79df34a3d1",
      "created_at" : "2023-08-07T22:20:56Z",
      "diff_hunk" : "@@ -0,0 +1,254 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet { \r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one \r\n+ * instance of CWallet is created and reused as required. \r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes \r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton {\r\n+public:\r\n+    static WalletSingleton& GetInstance() {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet() {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return *wallet;\r\n+    }\r\n+    CoinsResult& GetCoins() {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return available_coins;\r\n+    }\r\n+\r\n+private:\r\n+    WalletSingleton() {\r\n+        InitializeWallet();\r\n+    }\r\n+\r\n+    ~WalletSingleton() {\r\n+        wallet.reset();\r\n+        available_coins.coins.clear();\r\n+    }\r\n+\r\n+    WalletSingleton(const WalletSingleton&) = delete;\r\n+    WalletSingleton& operator=(const WalletSingleton&) = delete;\r\n+\r\n+    void InitializeWallet() {\r\n+        auto& node{g_setup->m_node};\r\n+        wallet = CreateSyncedWallet(*node.chain, WITH_LOCK(Assert(node.chainman)->GetMutex(), return node.chainman->ActiveChain()), g_setup->coinbaseKey);\r\n+\r\n+        // This is placed here because Available Coins will never be updated while fuzzing.\r\n+        LOCK(wallet->cs_wallet);\r\n+        available_coins = AvailableCoins(*wallet);\r\n+    }\r\n+\r\n+    std::unique_ptr<CWallet> wallet;\r\n+    CoinsResult available_coins;\r\n+};\r\n+\r\n+CCoinControl GetNewCoinControl(FuzzedDataProvider& fuzzed_data_provider, CWallet& wallet, std::vector<COutput>& coins) \r\n+{\r\n+    CCoinControl new_coin_control;\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        const CTxDestination tx_destination{ConsumeTxDestination(fuzzed_data_provider)};\r\n+        new_coin_control.destChange = tx_destination;\r\n+    }\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_change_type = fuzzed_data_provider.PickValueInArray(OUTPUT_TYPES);\r\n+    }\r\n+    new_coin_control.m_include_unsafe_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_allow_other_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_feerate = CFeeRate{ConsumeMoney(fuzzed_data_provider, /*max=*/COIN)};\r\n+    }\r\n+    new_coin_control.m_signal_bip125_rbf = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_avoid_partial_spends = fuzzed_data_provider.ConsumeBool();\r\n+    \r\n+    // Taking a random sub-sequence from available coins.\r\n+    for (const COutput& coin : coins) {\r\n+        if(fuzzed_data_provider.ConsumeBool()) {\r\n+            new_coin_control.Select(coin.outpoint);\r\n+        }\r\n+    }\r\n+\r\n+    // Occasionally, some random `CCoutPoint` are also selected.\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        for(int i = 0; i < 10; ++i) {\r\n+            std::optional<COutPoint> optional_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\r\n+            if (!optional_out_point) {\r\n+                continue;\r\n+            }\r\n+            new_coin_control.Select(*optional_out_point);\r\n+        }\r\n+    }\r\n+    return new_coin_control;\r\n+}\r\n+\r\n+void initialize_spend()\r\n+{\r\n+    static auto testing_setup = MakeNoLogFileContext<TestChain100Setup>();\r\n+    g_setup = testing_setup.get();\r\n+\r\n+    // Add 50 spendable UTXO, 50 BTC each, to the wallet (total balance 5000 BTC)\r\n+    // Because none of the UTXO will ever be used (marked as spent), mining this many should be sufficient. \r\n+    for (int i = 0; i < 50; ++i) {\r\n+        g_setup->CreateAndProcessBlock({}, GetScriptForRawPubKey(g_setup->coinbaseKey.GetPubKey()));\r\n+    }\r\n+}\r\n+\r\n+FUZZ_TARGET(spend, .init = initialize_spend)\r\n+{\r\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\r\n+    CWallet& wallet = WalletSingleton::GetInstance().GetWallet();\r\n+    CoinsResult& available_coins = WalletSingleton::GetInstance().GetCoins();\r\n+\r\n+    // Asserting if the `wallet` has no funds.\r\n+    std::vector<COutput> coins = available_coins.All();\r\n+    assert(!coins.empty());\r\n+\r\n+    CCoinControl coin_control;\r\n+    CMutableTransaction mtx;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 505)\r\n+    {\r\n+        CallOneOf(\r\n+            fuzzed_data_provider,\r\n+            [&] {\r\n+                // Creates a new `CoinControl`.\r\n+                coin_control = GetNewCoinControl(fuzzed_data_provider, wallet, coins);\r\n+            },\r\n+            [&] {\r\n+                // Creates a new Transaction using `CreateTransaction`.\r\n+                std::vector<CRecipient> recipients;\r\n+                unsigned int recipients_size = fuzzed_data_provider.ConsumeIntegralInRange<unsigned int>(0, 100);\r\n+                for (unsigned int i = 0; i < recipients_size; ++i) {\r\n+                    recipients.push_back({/*scriptPubKey=*/ConsumeScript(fuzzed_data_provider),\r\n+                                        /*nAmount=*/ConsumeMoney(fuzzed_data_provider), \r\n+                                        /*fSubtractFeeFromAmount=*/fuzzed_data_provider.ConsumeBool()});\r\n+                }\r\n+                // Equally likely to chose one of the three values.\r\n+                std::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, recipients_size), fuzzed_data_provider.ConsumeIntegral<int>()};\r\n+                int change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n+\r\n+                auto res = CreateTransaction(wallet, recipients, change_pos, coin_control, /*sign=*/fuzzed_data_provider.ConsumeBool());\r\n+                if (!res) return;\r\n+                mtx = CMutableTransaction(*(res->tx));\r\n+            },\r\n+            [&] {\r\n+                // Occasionally, creating a random Transaction for Fuzzing.\r\n+                auto new_mtx = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\r\n+                if (!new_mtx) return;\r\n+                mtx = *new_mtx;\r\n+            },\r\n+            [&] {\r\n+                LOCK(wallet.cs_wallet);\r\n+                if (fuzzed_data_provider.ConsumeBool()) {\r\n+                    (void)CalculateMaximumSignedTxSize(CTransaction(mtx), &wallet);\r\n+                } else {\r\n+                    (void)CalculateMaximumSignedTxSize(CTransaction(mtx), &wallet, &coin_control);\r\n+                }\r\n+            },\r\n+            [&] {\r\n+                const CTxOut tx_out{ConsumeMoney(fuzzed_data_provider), ConsumeScript(fuzzed_data_provider)}; \r\n+                CalculateMaximumSignedInputSize(tx_out, &wallet, &coin_control);\r\n+            },\r\n+            [&] {\r\n+                CAmount fee;\r\n+                int random_positions[3] = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, mtx.vout.size()), fuzzed_data_provider.ConsumeIntegral<int>()};\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1286427767",
      "id" : 1286427767,
      "line" : 184,
      "node_id" : "PRRC_kwDOABII585MrVR3",
      "original_commit_id" : "b8121896a05f8e894f250b4ce6f28c79df34a3d1",
      "original_line" : 184,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 184,
      "pull_request_review_id" : 1566218244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427767/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-07T22:20:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "From lint:\r\n```diff\r\n+ test/lint/all-lint.py\r\nThis diff appears to have added new lines with trailing whitespace.\r\nThe following changes were suspected:\r\n\r\ndiff --git a/src/wallet/test/fuzz/spend.cpp b/src/wallet/test/fuzz/spend.cpp\r\n@@ -0,0 +1,254 @@\r\n+namespace wallet { \r\n+ * Singleton wallet class ensures that only one \r\n+ * instance of CWallet is created and reused as required. \r\n+ * of creating a new `Descriptor Wallet` each time and deletes \r\n+CCoinControl GetNewCoinControl(FuzzedDataProvider& fuzzed_data_provider, CWallet& wallet, std::vector<COutput>& coins) \r\n+    \r\n+    // Because none of the UTXO will ever be used (marked as spent), mining this many should be sufficient. \r\n+                                        /*nAmount=*/ConsumeMoney(fuzzed_data_provider), \r\n+                const CTxOut tx_out{ConsumeMoney(fuzzed_data_provider), ConsumeScript(fuzzed_data_provider)}; \r\n+    \r\n+                // Taking a random sub-sequence from available coins \r\n+}   \r\nSuccess: no issues found in 269 source files\r\n^---- failure generated from lint-whitespace.py\r\n```",
      "created_at" : "2023-08-08T00:48:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1668752812",
      "id" : 1668752812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585jdyWs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668752812/reactions"
      },
      "updated_at" : "2023-08-08T00:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668752812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, @brunoerg for your reviews! In the recent push, I've addressed most of your reviews.\r\n\r\n- `clang-format` to fix the lint's issue.\r\n- Changed `PickValueFromArray` to the `PickValue` approach.\r\n- Fixed one grammar mistake.\r\n\r\nThis [comment](https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1286425941) is really interesting, but I'm not sure whether the `non-determinism` in this case might pose a significant issue or not.\r\nSo, I'll wait for more people to give their thoughts on this and we can write a new `CreateSyncedWallet` specific for Fuzzing purposes if felt necessary.\r\n",
      "created_at" : "2023-08-10T20:15:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1673851694",
      "id" : 1673851694,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585jxPMu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1673851694/reactions"
      },
      "updated_at" : "2023-08-10T23:30:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1673851694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The `fuzzer` logs are unclear, I'm not sure why it failed suddenly. Maybe some issue with the Fuzzer again?",
      "created_at" : "2023-11-02T18:52:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1791356580",
      "id" : 1791356580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585qxe6k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1791356580/reactions"
      },
      "updated_at" : "2023-11-02T18:52:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1791356580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "You'll need to rebase on current master in any case",
      "created_at" : "2023-11-02T19:02:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1791381061",
      "id" : 1791381061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585qxk5F",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1791381061/reactions"
      },
      "updated_at" : "2023-11-02T19:02:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1791381061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "- Force-pushed rebasing on the current master branch.\r\n\r\nPS - There is one change in `CRecipient` that I didn't know about. Will update this PR against that change soon!",
      "created_at" : "2023-11-04T17:13:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1793499068",
      "id" : 1793499068,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585q5p-8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1793499068/reactions"
      },
      "updated_at" : "2023-11-04T17:23:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1793499068",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "- Force-pushed updating the `CRecipient` wrt [28246](https://github.com/bitcoin/bitcoin/pull/28246).\r\n\r\nAll CI checks passed now ðª",
      "created_at" : "2023-11-04T19:03:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1793526872",
      "id" : 1793526872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585q5wxY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1793526872/reactions"
      },
      "updated_at" : "2023-11-04T19:03:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1793526872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1390888668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390888668"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const CWallet& GetWallet()\r\n\r\n```\r\n\r\nIt's otherwise hard to tell if the global wallet instance is mutated. Same for `GetCoins()`.\r\n\r\nIf the global instance is mutated, the target is likely to be non-deterministic which hurts fuzzer efficiency. The target should behave exactly the same when given the same input, but that might not be the case if global state is used and modified.\r\n\r\n(The suggested change might not compile if `wallet` or `available_coins` are used as non-const/mutated)",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-11-13T10:05:13Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1390888668",
      "id" : 1390888668,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585S50bc",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 39,
      "pull_request_review_id" : 1726964487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390888668/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T10:13:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390888668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1391438669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391438669"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, this should make it more deterministic. As you said, it's causing some compilation errorsÂ with other code. I'll force-push once I've fixed them.",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-11-13T17:20:19Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1391438669",
      "id" : 1391438669,
      "in_reply_to_id" : 1390888668,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585S76tN",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 39,
      "pull_request_review_id" : 1727830192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391438669/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T17:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391438669",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1392492963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1392492963"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The `CreateTransaction()` and `FundTransaction()` want the `CWallet` parameter to be non-const. I'm struggling to find a work around but I'm trying.\r\n\r\nJust wanted to clear this, I think the `CWallet` instance inside these functions doesn't seem to be directly mutated or changed anytime. So, do we really want to make it to const. Am I understanding this correct?",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-11-14T12:10:31Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1392492963",
      "id" : 1392492963,
      "in_reply_to_id" : 1390888668,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585S_8Gj",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 39,
      "pull_request_review_id" : 1729595017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1392492963/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-14T12:10:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1392492963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1392514354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1392514354"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If  `CreateTransaction()` and  `FundTransaction()` do not mutate the wallet, then they should probably take a const reference instead. But glancing at `FundTransaction`, it calls `CWallet::LockCoin` which is not a const method and could probably lead to non-determinism since it appears to be modifying internal state of a wallet.\r\nhttps://github.com/bitcoin/bitcoin/blob/fb85bb277670aad28fef51b7313d4a96cdaa760f/src/wallet/spend.cpp#L1388\r\n\r\n> Just wanted to clear this, I think the CWallet instance inside these functions doesn't seem to be directly mutated or changed anytime. So, do we really want to make it to const.\r\n\r\nMarking things that should not be mutated as `const` will make this a compile time check, giving us more confidence that the test is working properly.\r\n\r\nYou could try to refactor `CreateTransaction` and/or  `FundTransaction` to take a `const CWallet&` and see what happens when you compile. The `LockCoin` issue mentioned above should be one of the things the compiler complains about.",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-11-14T12:27:37Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1392514354",
      "id" : 1392514354,
      "in_reply_to_id" : 1390888668,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585TABUy",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 39,
      "pull_request_review_id" : 1729622663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1392514354/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-14T12:27:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1392514354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1409425962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409425962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "missing ser-params? See compile failure due to silent merge conflict.\r\n\r\nNeeds rebase",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-11-29T15:08:00Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return *wallet;\r\n+    }\r\n+    CoinsResult& GetCoins()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return available_coins;\r\n+    }\r\n+\r\n+private:\r\n+    WalletSingleton()\r\n+    {\r\n+        InitializeWallet();\r\n+    }\r\n+\r\n+    ~WalletSingleton()\r\n+    {\r\n+        wallet.reset();\r\n+        available_coins.coins.clear();\r\n+    }\r\n+\r\n+    WalletSingleton(const WalletSingleton&) = delete;\r\n+    WalletSingleton& operator=(const WalletSingleton&) = delete;\r\n+\r\n+    void InitializeWallet()\r\n+    {\r\n+        auto& node{g_setup->m_node};\r\n+        wallet = CreateSyncedWallet(*node.chain, WITH_LOCK(Assert(node.chainman)->GetMutex(), return node.chainman->ActiveChain()), g_setup->coinbaseKey);\r\n+\r\n+        // This is placed here because Available Coins will never be updated while fuzzing.\r\n+        LOCK(wallet->cs_wallet);\r\n+        available_coins = AvailableCoins(*wallet);\r\n+    }\r\n+\r\n+    std::unique_ptr<CWallet> wallet;\r\n+    CoinsResult available_coins;\r\n+};\r\n+\r\n+CCoinControl GetNewCoinControl(FuzzedDataProvider& fuzzed_data_provider, CWallet& wallet, std::vector<COutput>& coins)\r\n+{\r\n+    CCoinControl new_coin_control;\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        const CTxDestination tx_destination{ConsumeTxDestination(fuzzed_data_provider)};\r\n+        new_coin_control.destChange = tx_destination;\r\n+    }\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_change_type = fuzzed_data_provider.PickValueInArray(OUTPUT_TYPES);\r\n+    }\r\n+    new_coin_control.m_include_unsafe_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_allow_other_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_feerate = CFeeRate{ConsumeMoney(fuzzed_data_provider, /*max=*/COIN)};\r\n+    }\r\n+    new_coin_control.m_signal_bip125_rbf = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_avoid_partial_spends = fuzzed_data_provider.ConsumeBool();\r\n+\r\n+    // Taking a random sub-sequence from available coins.\r\n+    for (const COutput& coin : coins) {\r\n+        if (fuzzed_data_provider.ConsumeBool()) {\r\n+            new_coin_control.Select(coin.outpoint);\r\n+        }\r\n+    }\r\n+\r\n+    // Occasionally, some random `CCoutPoint` are also selected.\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        for (int i = 0; i < 10; ++i) {\r\n+            std::optional<COutPoint> optional_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\r\n+            if (!optional_out_point) {\r\n+                continue;\r\n+            }\r\n+            new_coin_control.Select(*optional_out_point);\r\n+        }\r\n+    }\r\n+    return new_coin_control;\r\n+}\r\n+\r\n+void initialize_spend()\r\n+{\r\n+    static auto testing_setup = MakeNoLogFileContext<TestChain100Setup>();\r\n+    g_setup = testing_setup.get();\r\n+\r\n+    // Add 50 spendable UTXO, 50 BTC each, to the wallet (total balance 5000 BTC)\r\n+    // Because none of the UTXO will ever be used (marked as spent), mining this many should be sufficient.\r\n+    for (int i = 0; i < 50; ++i) {\r\n+        g_setup->CreateAndProcessBlock({}, GetScriptForRawPubKey(g_setup->coinbaseKey.GetPubKey()));\r\n+    }\r\n+}\r\n+\r\n+FUZZ_TARGET(spend, .init = initialize_spend)\r\n+{\r\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\r\n+    CWallet& wallet = WalletSingleton::GetInstance().GetWallet();\r\n+    CoinsResult& available_coins = WalletSingleton::GetInstance().GetCoins();\r\n+\r\n+    // Asserting if the `wallet` has no funds.\r\n+    std::vector<COutput> coins = available_coins.All();\r\n+    assert(!coins.empty());\r\n+\r\n+    CCoinControl coin_control;\r\n+    CMutableTransaction mtx;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 505)\r\n+    {\r\n+        CallOneOf(\r\n+            fuzzed_data_provider,\r\n+            [&] {\r\n+                // Creates a new `CoinControl`.\r\n+                coin_control = GetNewCoinControl(fuzzed_data_provider, wallet, coins);\r\n+            },\r\n+            [&] {\r\n+                // Creates a new Transaction using `CreateTransaction`.\r\n+                std::vector<CRecipient> recipients;\r\n+                unsigned int recipients_size = fuzzed_data_provider.ConsumeIntegralInRange<unsigned int>(0, 100);\r\n+                for (unsigned int i = 0; i < recipients_size; ++i) {\r\n+                    recipients.push_back({/*dest=*/ConsumeTxDestination(fuzzed_data_provider),\r\n+                                          /*nAmount=*/ConsumeMoney(fuzzed_data_provider),\r\n+                                          /*fSubtractFeeFromAmount=*/fuzzed_data_provider.ConsumeBool()});\r\n+                }\r\n+                // Equally likely to choose one of the three values.\r\n+                std::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, recipients_size), fuzzed_data_provider.ConsumeIntegral<int>()};\r\n+                int change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n+\r\n+                auto res = CreateTransaction(wallet, recipients, change_pos, coin_control, /*sign=*/fuzzed_data_provider.ConsumeBool());\r\n+                if (!res) return;\r\n+                mtx = CMutableTransaction(*(res->tx));\r\n+            },\r\n+            [&] {\r\n+                // Occasionally, creating a random Transaction for Fuzzing.\r\n+                auto new_mtx = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1409425962",
      "id" : 1409425962,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585UAiIq",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 173,
      "original_position" : 173,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 173,
      "pull_request_review_id" : 1755504090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409425962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:08:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409425962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1414077590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414077590"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I believe the `LockCoin` function does mutate the global `wallet`. I'll need to figure out how to make this deterministic then.\r\n\r\nI apologize for the delayed response, I was/am occupied with something else. But, I'm looking forward to brainstorming this and finding a solution as soon as possible.",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-12-04T15:30:37Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1414077590",
      "id" : 1414077590,
      "in_reply_to_id" : 1390888668,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585USRyW",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 39,
      "pull_request_review_id" : 1762734732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414077590/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:30:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414077590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1414079147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414079147"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you! I'll rebase in the next force push.",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-12-04T15:31:45Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return *wallet;\r\n+    }\r\n+    CoinsResult& GetCoins()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return available_coins;\r\n+    }\r\n+\r\n+private:\r\n+    WalletSingleton()\r\n+    {\r\n+        InitializeWallet();\r\n+    }\r\n+\r\n+    ~WalletSingleton()\r\n+    {\r\n+        wallet.reset();\r\n+        available_coins.coins.clear();\r\n+    }\r\n+\r\n+    WalletSingleton(const WalletSingleton&) = delete;\r\n+    WalletSingleton& operator=(const WalletSingleton&) = delete;\r\n+\r\n+    void InitializeWallet()\r\n+    {\r\n+        auto& node{g_setup->m_node};\r\n+        wallet = CreateSyncedWallet(*node.chain, WITH_LOCK(Assert(node.chainman)->GetMutex(), return node.chainman->ActiveChain()), g_setup->coinbaseKey);\r\n+\r\n+        // This is placed here because Available Coins will never be updated while fuzzing.\r\n+        LOCK(wallet->cs_wallet);\r\n+        available_coins = AvailableCoins(*wallet);\r\n+    }\r\n+\r\n+    std::unique_ptr<CWallet> wallet;\r\n+    CoinsResult available_coins;\r\n+};\r\n+\r\n+CCoinControl GetNewCoinControl(FuzzedDataProvider& fuzzed_data_provider, CWallet& wallet, std::vector<COutput>& coins)\r\n+{\r\n+    CCoinControl new_coin_control;\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        const CTxDestination tx_destination{ConsumeTxDestination(fuzzed_data_provider)};\r\n+        new_coin_control.destChange = tx_destination;\r\n+    }\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_change_type = fuzzed_data_provider.PickValueInArray(OUTPUT_TYPES);\r\n+    }\r\n+    new_coin_control.m_include_unsafe_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_allow_other_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_feerate = CFeeRate{ConsumeMoney(fuzzed_data_provider, /*max=*/COIN)};\r\n+    }\r\n+    new_coin_control.m_signal_bip125_rbf = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_avoid_partial_spends = fuzzed_data_provider.ConsumeBool();\r\n+\r\n+    // Taking a random sub-sequence from available coins.\r\n+    for (const COutput& coin : coins) {\r\n+        if (fuzzed_data_provider.ConsumeBool()) {\r\n+            new_coin_control.Select(coin.outpoint);\r\n+        }\r\n+    }\r\n+\r\n+    // Occasionally, some random `CCoutPoint` are also selected.\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        for (int i = 0; i < 10; ++i) {\r\n+            std::optional<COutPoint> optional_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\r\n+            if (!optional_out_point) {\r\n+                continue;\r\n+            }\r\n+            new_coin_control.Select(*optional_out_point);\r\n+        }\r\n+    }\r\n+    return new_coin_control;\r\n+}\r\n+\r\n+void initialize_spend()\r\n+{\r\n+    static auto testing_setup = MakeNoLogFileContext<TestChain100Setup>();\r\n+    g_setup = testing_setup.get();\r\n+\r\n+    // Add 50 spendable UTXO, 50 BTC each, to the wallet (total balance 5000 BTC)\r\n+    // Because none of the UTXO will ever be used (marked as spent), mining this many should be sufficient.\r\n+    for (int i = 0; i < 50; ++i) {\r\n+        g_setup->CreateAndProcessBlock({}, GetScriptForRawPubKey(g_setup->coinbaseKey.GetPubKey()));\r\n+    }\r\n+}\r\n+\r\n+FUZZ_TARGET(spend, .init = initialize_spend)\r\n+{\r\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\r\n+    CWallet& wallet = WalletSingleton::GetInstance().GetWallet();\r\n+    CoinsResult& available_coins = WalletSingleton::GetInstance().GetCoins();\r\n+\r\n+    // Asserting if the `wallet` has no funds.\r\n+    std::vector<COutput> coins = available_coins.All();\r\n+    assert(!coins.empty());\r\n+\r\n+    CCoinControl coin_control;\r\n+    CMutableTransaction mtx;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 505)\r\n+    {\r\n+        CallOneOf(\r\n+            fuzzed_data_provider,\r\n+            [&] {\r\n+                // Creates a new `CoinControl`.\r\n+                coin_control = GetNewCoinControl(fuzzed_data_provider, wallet, coins);\r\n+            },\r\n+            [&] {\r\n+                // Creates a new Transaction using `CreateTransaction`.\r\n+                std::vector<CRecipient> recipients;\r\n+                unsigned int recipients_size = fuzzed_data_provider.ConsumeIntegralInRange<unsigned int>(0, 100);\r\n+                for (unsigned int i = 0; i < recipients_size; ++i) {\r\n+                    recipients.push_back({/*dest=*/ConsumeTxDestination(fuzzed_data_provider),\r\n+                                          /*nAmount=*/ConsumeMoney(fuzzed_data_provider),\r\n+                                          /*fSubtractFeeFromAmount=*/fuzzed_data_provider.ConsumeBool()});\r\n+                }\r\n+                // Equally likely to choose one of the three values.\r\n+                std::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, recipients_size), fuzzed_data_provider.ConsumeIntegral<int>()};\r\n+                int change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n+\r\n+                auto res = CreateTransaction(wallet, recipients, change_pos, coin_control, /*sign=*/fuzzed_data_provider.ConsumeBool());\r\n+                if (!res) return;\r\n+                mtx = CMutableTransaction(*(res->tx));\r\n+            },\r\n+            [&] {\r\n+                // Occasionally, creating a random Transaction for Fuzzing.\r\n+                auto new_mtx = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1414079147",
      "id" : 1414079147,
      "in_reply_to_id" : 1409425962,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII585USSKr",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 173,
      "original_position" : 173,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 173,
      "pull_request_review_id" : 1762737316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414079147/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414079147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1417093434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417093434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems like this should be a separate fuzz target?",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-12-06T10:50:27Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return *wallet;\r\n+    }\r\n+    CoinsResult& GetCoins()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return available_coins;\r\n+    }\r\n+\r\n+private:\r\n+    WalletSingleton()\r\n+    {\r\n+        InitializeWallet();\r\n+    }\r\n+\r\n+    ~WalletSingleton()\r\n+    {\r\n+        wallet.reset();\r\n+        available_coins.coins.clear();\r\n+    }\r\n+\r\n+    WalletSingleton(const WalletSingleton&) = delete;\r\n+    WalletSingleton& operator=(const WalletSingleton&) = delete;\r\n+\r\n+    void InitializeWallet()\r\n+    {\r\n+        auto& node{g_setup->m_node};\r\n+        wallet = CreateSyncedWallet(*node.chain, WITH_LOCK(Assert(node.chainman)->GetMutex(), return node.chainman->ActiveChain()), g_setup->coinbaseKey);\r\n+\r\n+        // This is placed here because Available Coins will never be updated while fuzzing.\r\n+        LOCK(wallet->cs_wallet);\r\n+        available_coins = AvailableCoins(*wallet);\r\n+    }\r\n+\r\n+    std::unique_ptr<CWallet> wallet;\r\n+    CoinsResult available_coins;\r\n+};\r\n+\r\n+CCoinControl GetNewCoinControl(FuzzedDataProvider& fuzzed_data_provider, CWallet& wallet, std::vector<COutput>& coins)\r\n+{\r\n+    CCoinControl new_coin_control;\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        const CTxDestination tx_destination{ConsumeTxDestination(fuzzed_data_provider)};\r\n+        new_coin_control.destChange = tx_destination;\r\n+    }\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_change_type = fuzzed_data_provider.PickValueInArray(OUTPUT_TYPES);\r\n+    }\r\n+    new_coin_control.m_include_unsafe_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_allow_other_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_feerate = CFeeRate{ConsumeMoney(fuzzed_data_provider, /*max=*/COIN)};\r\n+    }\r\n+    new_coin_control.m_signal_bip125_rbf = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_avoid_partial_spends = fuzzed_data_provider.ConsumeBool();\r\n+\r\n+    // Taking a random sub-sequence from available coins.\r\n+    for (const COutput& coin : coins) {\r\n+        if (fuzzed_data_provider.ConsumeBool()) {\r\n+            new_coin_control.Select(coin.outpoint);\r\n+        }\r\n+    }\r\n+\r\n+    // Occasionally, some random `CCoutPoint` are also selected.\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        for (int i = 0; i < 10; ++i) {\r\n+            std::optional<COutPoint> optional_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\r\n+            if (!optional_out_point) {\r\n+                continue;\r\n+            }\r\n+            new_coin_control.Select(*optional_out_point);\r\n+        }\r\n+    }\r\n+    return new_coin_control;\r\n+}\r\n+\r\n+void initialize_spend()\r\n+{\r\n+    static auto testing_setup = MakeNoLogFileContext<TestChain100Setup>();\r\n+    g_setup = testing_setup.get();\r\n+\r\n+    // Add 50 spendable UTXO, 50 BTC each, to the wallet (total balance 5000 BTC)\r\n+    // Because none of the UTXO will ever be used (marked as spent), mining this many should be sufficient.\r\n+    for (int i = 0; i < 50; ++i) {\r\n+        g_setup->CreateAndProcessBlock({}, GetScriptForRawPubKey(g_setup->coinbaseKey.GetPubKey()));\r\n+    }\r\n+}\r\n+\r\n+FUZZ_TARGET(spend, .init = initialize_spend)\r\n+{\r\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\r\n+    CWallet& wallet = WalletSingleton::GetInstance().GetWallet();\r\n+    CoinsResult& available_coins = WalletSingleton::GetInstance().GetCoins();\r\n+\r\n+    // Asserting if the `wallet` has no funds.\r\n+    std::vector<COutput> coins = available_coins.All();\r\n+    assert(!coins.empty());\r\n+\r\n+    CCoinControl coin_control;\r\n+    CMutableTransaction mtx;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 505)\r\n+    {\r\n+        CallOneOf(\r\n+            fuzzed_data_provider,\r\n+            [&] {\r\n+                // Creates a new `CoinControl`.\r\n+                coin_control = GetNewCoinControl(fuzzed_data_provider, wallet, coins);\r\n+            },\r\n+            [&] {\r\n+                // Creates a new Transaction using `CreateTransaction`.\r\n+                std::vector<CRecipient> recipients;\r\n+                unsigned int recipients_size = fuzzed_data_provider.ConsumeIntegralInRange<unsigned int>(0, 100);\r\n+                for (unsigned int i = 0; i < recipients_size; ++i) {\r\n+                    recipients.push_back({/*dest=*/ConsumeTxDestination(fuzzed_data_provider),\r\n+                                          /*nAmount=*/ConsumeMoney(fuzzed_data_provider),\r\n+                                          /*fSubtractFeeFromAmount=*/fuzzed_data_provider.ConsumeBool()});\r\n+                }\r\n+                // Equally likely to choose one of the three values.\r\n+                std::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, recipients_size), fuzzed_data_provider.ConsumeIntegral<int>()};\r\n+                int change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n+\r\n+                auto res = CreateTransaction(wallet, recipients, change_pos, coin_control, /*sign=*/fuzzed_data_provider.ConsumeBool());\r\n+                if (!res) return;\r\n+                mtx = CMutableTransaction(*(res->tx));\r\n+            },\r\n+            [&] {\r\n+                // Occasionally, creating a random Transaction for Fuzzing.\r\n+                auto new_mtx = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\r\n+                if (!new_mtx) return;\r\n+                mtx = *new_mtx;\r\n+            },\r\n+            [&] {\r\n+                LOCK(wallet.cs_wallet);\r\n+                if (fuzzed_data_provider.ConsumeBool()) {\r\n+                    (void)CalculateMaximumSignedTxSize(CTransaction(mtx), &wallet);\r\n+                } else {\r\n+                    (void)CalculateMaximumSignedTxSize(CTransaction(mtx), &wallet, &coin_control);\r\n+                }\r\n+            },\r\n+            [&] {\r\n+                const CTxOut tx_out{ConsumeMoney(fuzzed_data_provider), ConsumeScript(fuzzed_data_provider)};\r\n+                CalculateMaximumSignedInputSize(tx_out, &wallet, &coin_control);\r\n+            },\r\n+            [&] {\r\n+                CAmount fee;\r\n+                std::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, mtx.vout.size()), fuzzed_data_provider.ConsumeIntegral<int>()};\r\n+                int change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n+                bilingual_str error;\r\n+                std::set<int> setSubtractFeeFromOutputs;\r\n+                for (size_t i = 0; i < mtx.vout.size(); ++i) {\r\n+                    if (fuzzed_data_provider.ConsumeBool()) {\r\n+                        setSubtractFeeFromOutputs.insert(i);\r\n+                    }\r\n+                }\r\n+                FundTransaction(wallet, mtx, fee, change_pos, error, false, setSubtractFeeFromOutputs, coin_control);\r\n+            });\r\n+    }\r\n+\r\n+    // Plays with the `CoinsResult`\r\n+    CoinsResult wallet_coins;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 50)\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1417093434",
      "id" : 1417093434,
      "line" : 207,
      "node_id" : "PRRC_kwDOABII585UdyE6",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 207,
      "original_position" : 207,
      "original_start_line" : 205,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 207,
      "pull_request_review_id" : 1767252938,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417093434/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 205,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-06T10:51:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1417093434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1427877760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427877760"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I can create a separate PR for this immediately. Once it's ready, we can get it merged, and I can continue working on this. Thanks!",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2023-12-15T11:37:57Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return *wallet;\r\n+    }\r\n+    CoinsResult& GetCoins()\r\n+    {\r\n+        if (!wallet) {\r\n+            InitializeWallet();\r\n+        }\r\n+        return available_coins;\r\n+    }\r\n+\r\n+private:\r\n+    WalletSingleton()\r\n+    {\r\n+        InitializeWallet();\r\n+    }\r\n+\r\n+    ~WalletSingleton()\r\n+    {\r\n+        wallet.reset();\r\n+        available_coins.coins.clear();\r\n+    }\r\n+\r\n+    WalletSingleton(const WalletSingleton&) = delete;\r\n+    WalletSingleton& operator=(const WalletSingleton&) = delete;\r\n+\r\n+    void InitializeWallet()\r\n+    {\r\n+        auto& node{g_setup->m_node};\r\n+        wallet = CreateSyncedWallet(*node.chain, WITH_LOCK(Assert(node.chainman)->GetMutex(), return node.chainman->ActiveChain()), g_setup->coinbaseKey);\r\n+\r\n+        // This is placed here because Available Coins will never be updated while fuzzing.\r\n+        LOCK(wallet->cs_wallet);\r\n+        available_coins = AvailableCoins(*wallet);\r\n+    }\r\n+\r\n+    std::unique_ptr<CWallet> wallet;\r\n+    CoinsResult available_coins;\r\n+};\r\n+\r\n+CCoinControl GetNewCoinControl(FuzzedDataProvider& fuzzed_data_provider, CWallet& wallet, std::vector<COutput>& coins)\r\n+{\r\n+    CCoinControl new_coin_control;\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        const CTxDestination tx_destination{ConsumeTxDestination(fuzzed_data_provider)};\r\n+        new_coin_control.destChange = tx_destination;\r\n+    }\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_change_type = fuzzed_data_provider.PickValueInArray(OUTPUT_TYPES);\r\n+    }\r\n+    new_coin_control.m_include_unsafe_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_allow_other_inputs = fuzzed_data_provider.ConsumeBool();\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        new_coin_control.m_feerate = CFeeRate{ConsumeMoney(fuzzed_data_provider, /*max=*/COIN)};\r\n+    }\r\n+    new_coin_control.m_signal_bip125_rbf = fuzzed_data_provider.ConsumeBool();\r\n+    new_coin_control.m_avoid_partial_spends = fuzzed_data_provider.ConsumeBool();\r\n+\r\n+    // Taking a random sub-sequence from available coins.\r\n+    for (const COutput& coin : coins) {\r\n+        if (fuzzed_data_provider.ConsumeBool()) {\r\n+            new_coin_control.Select(coin.outpoint);\r\n+        }\r\n+    }\r\n+\r\n+    // Occasionally, some random `CCoutPoint` are also selected.\r\n+    if (fuzzed_data_provider.ConsumeBool()) {\r\n+        for (int i = 0; i < 10; ++i) {\r\n+            std::optional<COutPoint> optional_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\r\n+            if (!optional_out_point) {\r\n+                continue;\r\n+            }\r\n+            new_coin_control.Select(*optional_out_point);\r\n+        }\r\n+    }\r\n+    return new_coin_control;\r\n+}\r\n+\r\n+void initialize_spend()\r\n+{\r\n+    static auto testing_setup = MakeNoLogFileContext<TestChain100Setup>();\r\n+    g_setup = testing_setup.get();\r\n+\r\n+    // Add 50 spendable UTXO, 50 BTC each, to the wallet (total balance 5000 BTC)\r\n+    // Because none of the UTXO will ever be used (marked as spent), mining this many should be sufficient.\r\n+    for (int i = 0; i < 50; ++i) {\r\n+        g_setup->CreateAndProcessBlock({}, GetScriptForRawPubKey(g_setup->coinbaseKey.GetPubKey()));\r\n+    }\r\n+}\r\n+\r\n+FUZZ_TARGET(spend, .init = initialize_spend)\r\n+{\r\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\r\n+    CWallet& wallet = WalletSingleton::GetInstance().GetWallet();\r\n+    CoinsResult& available_coins = WalletSingleton::GetInstance().GetCoins();\r\n+\r\n+    // Asserting if the `wallet` has no funds.\r\n+    std::vector<COutput> coins = available_coins.All();\r\n+    assert(!coins.empty());\r\n+\r\n+    CCoinControl coin_control;\r\n+    CMutableTransaction mtx;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 505)\r\n+    {\r\n+        CallOneOf(\r\n+            fuzzed_data_provider,\r\n+            [&] {\r\n+                // Creates a new `CoinControl`.\r\n+                coin_control = GetNewCoinControl(fuzzed_data_provider, wallet, coins);\r\n+            },\r\n+            [&] {\r\n+                // Creates a new Transaction using `CreateTransaction`.\r\n+                std::vector<CRecipient> recipients;\r\n+                unsigned int recipients_size = fuzzed_data_provider.ConsumeIntegralInRange<unsigned int>(0, 100);\r\n+                for (unsigned int i = 0; i < recipients_size; ++i) {\r\n+                    recipients.push_back({/*dest=*/ConsumeTxDestination(fuzzed_data_provider),\r\n+                                          /*nAmount=*/ConsumeMoney(fuzzed_data_provider),\r\n+                                          /*fSubtractFeeFromAmount=*/fuzzed_data_provider.ConsumeBool()});\r\n+                }\r\n+                // Equally likely to choose one of the three values.\r\n+                std::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, recipients_size), fuzzed_data_provider.ConsumeIntegral<int>()};\r\n+                int change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n+\r\n+                auto res = CreateTransaction(wallet, recipients, change_pos, coin_control, /*sign=*/fuzzed_data_provider.ConsumeBool());\r\n+                if (!res) return;\r\n+                mtx = CMutableTransaction(*(res->tx));\r\n+            },\r\n+            [&] {\r\n+                // Occasionally, creating a random Transaction for Fuzzing.\r\n+                auto new_mtx = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\r\n+                if (!new_mtx) return;\r\n+                mtx = *new_mtx;\r\n+            },\r\n+            [&] {\r\n+                LOCK(wallet.cs_wallet);\r\n+                if (fuzzed_data_provider.ConsumeBool()) {\r\n+                    (void)CalculateMaximumSignedTxSize(CTransaction(mtx), &wallet);\r\n+                } else {\r\n+                    (void)CalculateMaximumSignedTxSize(CTransaction(mtx), &wallet, &coin_control);\r\n+                }\r\n+            },\r\n+            [&] {\r\n+                const CTxOut tx_out{ConsumeMoney(fuzzed_data_provider), ConsumeScript(fuzzed_data_provider)};\r\n+                CalculateMaximumSignedInputSize(tx_out, &wallet, &coin_control);\r\n+            },\r\n+            [&] {\r\n+                CAmount fee;\r\n+                std::vector<int> random_positions = {-1, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, mtx.vout.size()), fuzzed_data_provider.ConsumeIntegral<int>()};\r\n+                int change_pos = PickValue(fuzzed_data_provider, random_positions);\r\n+                bilingual_str error;\r\n+                std::set<int> setSubtractFeeFromOutputs;\r\n+                for (size_t i = 0; i < mtx.vout.size(); ++i) {\r\n+                    if (fuzzed_data_provider.ConsumeBool()) {\r\n+                        setSubtractFeeFromOutputs.insert(i);\r\n+                    }\r\n+                }\r\n+                FundTransaction(wallet, mtx, fee, change_pos, error, false, setSubtractFeeFromOutputs, coin_control);\r\n+            });\r\n+    }\r\n+\r\n+    // Plays with the `CoinsResult`\r\n+    CoinsResult wallet_coins;\r\n+\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 50)\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1427877760",
      "id" : 1427877760,
      "in_reply_to_id" : 1417093434,
      "line" : 207,
      "node_id" : "PRRC_kwDOABII585VG6-A",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 207,
      "original_position" : 207,
      "original_start_line" : 205,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 207,
      "pull_request_review_id" : 1783688791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427877760/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 205,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-15T11:38:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1427877760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1446205449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446205449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've thought about it, and I think a global Singleton might not be the smartest way to save resources. The `wallet` object definitely mutates during execution. I think I've to remove the Singleton pattern, but doing so will make the file very slow, as creating the `Descriptor Wallet` is really time-consuming.",
      "commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "created_at" : "2024-01-09T15:02:18Z",
      "diff_hunk" : "@@ -0,0 +1,259 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <key_io.h>\r\n+#include <outputtype.h>\r\n+#include <script/script.h>\r\n+#include <test/fuzz/FuzzedDataProvider.h>\r\n+#include <test/fuzz/fuzz.h>\r\n+#include <test/fuzz/util.h>\r\n+#include <test/util/setup_common.h>\r\n+#include <validation.h>\r\n+#include <wallet/coincontrol.h>\r\n+#include <wallet/spend.h>\r\n+#include <wallet/test/util.h>\r\n+#include <wallet/wallet.h>\r\n+\r\n+namespace wallet {\r\n+namespace {\r\n+\r\n+TestChain100Setup* g_setup;\r\n+\r\n+/**\r\n+ * Singleton wallet class ensures that only one\r\n+ * instance of CWallet is created and reused as required.\r\n+ * This increases Fuzzing efficiency by reducing the expense\r\n+ * of creating a new `Descriptor Wallet`Â each time and deletes\r\n+ * the pointer safely using the destructor.\r\n+ */\r\n+class WalletSingleton\r\n+{\r\n+public:\r\n+    static WalletSingleton& GetInstance()\r\n+    {\r\n+        static WalletSingleton instance;\r\n+        return instance;\r\n+    }\r\n+\r\n+    CWallet& GetWallet()\r",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#discussion_r1446205449",
      "id" : 1446205449,
      "in_reply_to_id" : 1390888668,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585WM1gJ",
      "original_commit_id" : "17a59053efb7ab2ec55ceb3aaa2288ecef016eb9",
      "original_line" : 39,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/wallet/test/fuzz/spend.cpp",
      "position" : 39,
      "pull_request_review_id" : 1811345295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28236",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446205449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-09T15:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446205449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Spend.cpp coverage is not too bad already: https://maflcko.github.io/b-c-cov/fuzz.coverage/src/wallet/spend.cpp.gcov.html\r\n> \r\n> It may be good to clarify the new coverage a bit.\r\n\r\nI didn't understand. Are you suggesting that I reconsider what I want to increase coverage of in this file?\r\n\r\nAlso, I have a question about the blue lines in the coverage reports. Do they represent the line coverage of the code during fuzzing? For instance, if these functions are encountered in the process of running any fuzz file, the fuzz coverage will display them in blue. If I'm understanding this correctly, wouldn't it still make sense to have a separate fuzz file for `Creating Transaction` so that we can explore more test cases and code flows? These might not be tested if the coverage is coming from another fuzz file designed for a different purpose or codebase.\r\n\r\n https://maflcko.github.io/b-c-cov/fuzz.coverage/src/wallet/spend.cpp.gcov.html",
      "created_at" : "2024-01-09T15:16:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-1883240915",
      "id" : 1883240915,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585wP_nT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1883240915/reactions"
      },
      "updated_at" : "2024-01-09T15:16:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1883240915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Are you still working on this?",
      "created_at" : "2024-04-17T18:20:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-2061935258",
      "id" : 2061935258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII58565qKa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2061935258/reactions"
      },
      "updated_at" : "2024-04-17T18:20:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2061935258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Are you still working on this?\r\n\r\nSorry I got a little occupied with some other things and would want to continue working on this. I've the approach in mind and will force push the update by the end of this month.\r\n\r\n- Will create a new file for `CoinsResult ` and remove global Singleton from the `Spend` file.",
      "created_at" : "2024-04-18T05:26:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28236#issuecomment-2063026719",
      "id" : 2063026719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28236",
      "node_id" : "IC_kwDOABII585690of",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2063026719/reactions"
      },
      "updated_at" : "2024-04-18T05:34:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2063026719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76209654?v=4",
         "events_url" : "https://api.github.com/users/Ayush170-Future/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ayush170-Future/followers",
         "following_url" : "https://api.github.com/users/Ayush170-Future/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ayush170-Future/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ayush170-Future",
         "id" : 76209654,
         "login" : "Ayush170-Future",
         "node_id" : "MDQ6VXNlcjc2MjA5NjU0",
         "organizations_url" : "https://api.github.com/users/Ayush170-Future/orgs",
         "received_events_url" : "https://api.github.com/users/Ayush170-Future/received_events",
         "repos_url" : "https://api.github.com/users/Ayush170-Future/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ayush170-Future/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ayush170-Future/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ayush170-Future"
      }
   }
]
