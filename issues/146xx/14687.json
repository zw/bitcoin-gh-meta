{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This addresses https://github.com/bitcoin/bitcoin/issues/12754.\r\n\r\nThese changes enable node operators to address the silent dropping (by network middle boxes) of long-lived low-activity ZMQ TCP connections via further operating system level TCP keepalive configuration. For example, ZMQ sockets that publish block hashes can be affected in this way due to the length of time it sometimes takes between finding blocks (e.g.- sometimes more than an hour).\r\n\r\nPrior to this patch, operating system level TCP keepalive configurations would not take effect since the SO_KEEPALIVE option was not enabled on the underlying socket.\r\n\r\nThere are additional ZMQ socket options related to TCP keepalive that can be set. However, I decided not to implement those options in this changeset because doing so would require adding additional bitcoin node configuration options, and would not yield a better outcome. I preferred a small, easily reviewable patch that doesn't add a bunch of new config options, with the tradeoff that the fine tuning would have to be done via well-documented operating system specific configurations.\r\n\r\nI tested this patch by running a node with:\r\n`./src/qt/bitcoin-qt -regtest -txindex -datadir=/tmp/node -zmqpubhashblock=tcp://127.0.0.1:28332 &`\r\nand connecting to it with:\r\n`python3 ./contrib/zmq/zmq_sub.py`\r\n\r\nWithout these changes, `ss -panto | grep 28332 | grep ESTAB | grep bitcoin` will report no keepalive timer information. With these changes, the output from the prior command will show keepalive timer information consistent with the configuration at the time of connection establishment, e.g.-: `timer:(keepalive,119min,0)`.\r\n\r\nI also tested with a non-TCP transport and did not witness any adverse effects:\r\n`./src/qt/bitcoin-qt -regtest -txindex -datadir=/tmp/node -zmqpubhashblock=ipc:///tmp/bitcoin.block &`\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14687/comments",
   "created_at" : "2018-11-08T12:05:02Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14687/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/14687",
   "id" : 378702386,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14687/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MjI5MzQyMjc4",
   "number" : 14687,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/14687.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14687",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/14687.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14687"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "zmq: enable tcp keepalive",
   "updated_at" : "2018-12-20T05:19:18Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14687",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/6440430?v=4",
      "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
      "followers_url" : "https://api.github.com/users/mruddy/followers",
      "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
      "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/mruddy",
      "id" : 6440430,
      "login" : "mruddy",
      "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
      "organizations_url" : "https://api.github.com/users/mruddy/orgs",
      "received_events_url" : "https://api.github.com/users/mruddy/received_events",
      "repos_url" : "https://api.github.com/users/mruddy/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/mruddy"
   }
}
