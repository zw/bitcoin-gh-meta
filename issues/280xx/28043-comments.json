[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28043).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [darosior](https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1819363878) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26812](https://github.com/bitcoin/bitcoin/pull/26812) (test: add end-to-end tests for CConnman and PeerManager by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-07-07T12:05:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1625314105",
      "id" : 1625314105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585g4FM5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625314105/reactions"
      },
      "updated_at" : "2023-12-01T21:16:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625314105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Draft until #27499 is in.",
      "created_at" : "2023-07-07T12:06:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1625315268",
      "id" : 1625315268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585g4FfE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625315268/reactions"
      },
      "updated_at" : "2023-07-07T12:06:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625315268",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1257196740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1257196740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks like this is the only option that is required by the fuzz target, so maybe remove the others for now to hopefully reduce the number of conflicting pulls and remove the dependency on the other pull?",
      "commit_id" : "4407469bd697d50beb9afe4bb946d55952c1893d",
      "created_at" : "2023-07-08T09:38:11Z",
      "diff_hunk" : "@@ -43,9 +46,19 @@ struct CNodeStateStats {\n class PeerManager : public CValidationInterface, public NetEventsInterface\n {\n public:\n+    struct Options {\n+        BanMan* banman{nullptr};\n+        bool ignore_incoming_txs{false};\n+        bool reconcile_txs{false};\n+        uint32_t max_orphan_txs{DEFAULT_MAX_ORPHAN_TRANSACTIONS};\n+        size_t max_extra_txs{DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN};\n+        bool capture_messages{false};\n+        uint32_t max_headers_result{MAX_HEADERS_RESULTS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1257196740",
      "id" : 1257196740,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII585K70zE",
      "original_commit_id" : "4407469bd697d50beb9afe4bb946d55952c1893d",
      "original_line" : 56,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 21,
      "pull_request_review_id" : 1520679325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1257196740/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-08T09:38:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1257196740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1258057941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1258057941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3 of the PRs are mine (I don't care about rebasing) and the package relay stuff is gonna conflict either way, so I'd prefer keeping it as is.",
      "commit_id" : "4407469bd697d50beb9afe4bb946d55952c1893d",
      "created_at" : "2023-07-10T10:37:59Z",
      "diff_hunk" : "@@ -43,9 +46,19 @@ struct CNodeStateStats {\n class PeerManager : public CValidationInterface, public NetEventsInterface\n {\n public:\n+    struct Options {\n+        BanMan* banman{nullptr};\n+        bool ignore_incoming_txs{false};\n+        bool reconcile_txs{false};\n+        uint32_t max_orphan_txs{DEFAULT_MAX_ORPHAN_TRANSACTIONS};\n+        size_t max_extra_txs{DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN};\n+        bool capture_messages{false};\n+        uint32_t max_headers_result{MAX_HEADERS_RESULTS};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1258057941",
      "id" : 1258057941,
      "in_reply_to_id" : 1257196740,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII585K_HDV",
      "original_commit_id" : "4407469bd697d50beb9afe4bb946d55952c1893d",
      "original_line" : 56,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 21,
      "pull_request_review_id" : 1521779648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1258057941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-10T10:38:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1258057941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1272659160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272659160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not disabling it completely instead of mocking it?",
      "commit_id" : "4407469bd697d50beb9afe4bb946d55952c1893d",
      "created_at" : "2023-07-24T19:21:25Z",
      "diff_hunk" : "@@ -0,0 +1,198 @@\n+#include <blockencodings.h>\n+#include <net.h>\n+#include <net_processing.h>\n+#include <netmessagemaker.h>\n+#include <node/peerman_args.h>\n+#include <pow.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/net.h>\n+#include <test/util/script.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+namespace {\n+constexpr uint32_t FUZZ_MAX_HEADERS_RESULTS{16};\n+\n+class HeadersSyncSetup : public TestingSetup\n+{\n+    std::vector<CNode*> m_connections;\n+\n+public:\n+    HeadersSyncSetup(const ChainType chain_type = ChainType::MAIN,\n+                     const std::vector<const char*>& extra_args = {})\n+        : TestingSetup(chain_type, extra_args)\n+    {\n+        PeerManager::Options peerman_opts;\n+        peerman_opts.banman = m_node.banman.get();\n+        node::ApplyArgsManOptions(*m_node.args, peerman_opts);\n+        peerman_opts.max_headers_result = FUZZ_MAX_HEADERS_RESULTS;\n+        m_node.peerman = PeerManager::make(*m_node.connman, *m_node.addrman,\n+                                           *m_node.chainman, *m_node.mempool,\n+                                           peerman_opts);\n+\n+        CConnman::Options options;\n+        options.m_msgproc = m_node.peerman.get();\n+        m_node.connman->Init(options);\n+    }\n+\n+    void ResetAndInitialize() EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+    void SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+        EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+};\n+\n+void HeadersSyncSetup::ResetAndInitialize()\n+{\n+    m_connections.clear();\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    connman.StopNodes();\n+\n+    NodeId id{0};\n+    std::vector<ConnectionType> conn_types = {};\n+    conn_types.resize(1, ConnectionType::OUTBOUND_FULL_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::BLOCK_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::INBOUND);\n+\n+    for (auto conn_type : conn_types) {\n+        CAddress addr{};\n+        m_connections.push_back(new CNode(id++, nullptr, addr, 0, 0, addr, \"\", conn_type, false));\n+        CNode& p2p_node = *m_connections.back();\n+\n+        connman.Handshake(\n+            /*node=*/p2p_node,\n+            /*successfully_connected=*/true,\n+            /*remote_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*local_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*version=*/PROTOCOL_VERSION,\n+            /*relay_txs=*/true);\n+\n+        connman.AddTestNode(p2p_node);\n+    }\n+}\n+\n+void HeadersSyncSetup::SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+{\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    CNode& connection = *PickValue(fuzzed_data_provider, m_connections);\n+\n+    (void)connman.ReceiveMsgFrom(connection, msg);\n+    connection.fPauseSend = false;\n+    try {\n+        connman.ProcessMessagesOnce(connection);\n+    } catch (const std::ios_base::failure&) {\n+    }\n+    m_node.peerman->SendMessages(&connection);\n+}\n+\n+CBlockHeader ConsumeHeader(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    CBlockHeader header;\n+    header.nNonce = 0;\n+    // Either use the previous difficulty or let the fuzzer choose\n+    header.nBits = fuzzed_data_provider.ConsumeBool() ?\n+                       prev_nbits :\n+                       fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(0x17058EBE, 0x1D00FFFF);\n+    header.nTime = fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n+    header.hashPrevBlock = prev_hash;\n+    return header;\n+}\n+\n+CBlock ConsumeBlock(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    auto header = ConsumeHeader(fuzzed_data_provider, prev_hash, prev_nbits);\n+    // Doesn't need to be a valid block but it needs to have one transaction\n+    // for compact block construction.\n+    CBlock block{header};\n+    block.vtx.push_back(MakeTransactionRef(CMutableTransaction{}));\n+    return block;\n+}\n+\n+void FinalizeHeader(CBlockHeader& header)\n+{\n+    while (!CheckProofOfWork(header.GetHash(), header.nBits, Params().GetConsensus())) {\n+        ++(header.nNonce);\n+    }\n+}\n+\n+// Global setup works for this test as state modification (specifically in the\n+// block index) would indicate a bug.\n+HeadersSyncSetup* g_testing_setup;\n+\n+void initialize()\n+{\n+    // Reduce proof-of-work check to one bit.\n+    g_check_pow_mock = [](uint256 hash, unsigned int, const Consensus::Params&) {\n+        return (hash.data()[31] & 0x80) == 0;\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1272659160",
      "id" : 1272659160,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII585L2zzY",
      "original_commit_id" : "4407469bd697d50beb9afe4bb946d55952c1893d",
      "original_line" : 127,
      "original_position" : 127,
      "original_start_line" : 124,
      "path" : "src/test/fuzz/p2p_headers_sync.cpp",
      "position" : 127,
      "pull_request_review_id" : 1544111927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272659160/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 124,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-24T19:21:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272659160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-25T10:54:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1649607797",
      "id" : 1649607797,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585iUwR1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649607797/reactions"
      },
      "updated_at" : "2023-07-25T10:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649607797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and un-drafted, ready for review!",
      "created_at" : "2023-07-25T12:20:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1649733407",
      "id" : 1649733407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585iVO8f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649733407/reactions"
      },
      "updated_at" : "2023-07-25T12:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649733407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1273450317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273450317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My thinking was that this should result in more coverage because we'll also cover paths for invalid PoW.",
      "commit_id" : "8a7feb65732742b2bd88263e751e9f9cdc21fdce",
      "created_at" : "2023-07-25T12:23:12Z",
      "diff_hunk" : "@@ -0,0 +1,198 @@\n+#include <blockencodings.h>\n+#include <net.h>\n+#include <net_processing.h>\n+#include <netmessagemaker.h>\n+#include <node/peerman_args.h>\n+#include <pow.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/net.h>\n+#include <test/util/script.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+namespace {\n+constexpr uint32_t FUZZ_MAX_HEADERS_RESULTS{16};\n+\n+class HeadersSyncSetup : public TestingSetup\n+{\n+    std::vector<CNode*> m_connections;\n+\n+public:\n+    HeadersSyncSetup(const ChainType chain_type = ChainType::MAIN,\n+                     const std::vector<const char*>& extra_args = {})\n+        : TestingSetup(chain_type, extra_args)\n+    {\n+        PeerManager::Options peerman_opts;\n+        peerman_opts.banman = m_node.banman.get();\n+        node::ApplyArgsManOptions(*m_node.args, peerman_opts);\n+        peerman_opts.max_headers_result = FUZZ_MAX_HEADERS_RESULTS;\n+        m_node.peerman = PeerManager::make(*m_node.connman, *m_node.addrman,\n+                                           *m_node.chainman, *m_node.mempool,\n+                                           peerman_opts);\n+\n+        CConnman::Options options;\n+        options.m_msgproc = m_node.peerman.get();\n+        m_node.connman->Init(options);\n+    }\n+\n+    void ResetAndInitialize() EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+    void SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+        EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+};\n+\n+void HeadersSyncSetup::ResetAndInitialize()\n+{\n+    m_connections.clear();\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    connman.StopNodes();\n+\n+    NodeId id{0};\n+    std::vector<ConnectionType> conn_types = {};\n+    conn_types.resize(1, ConnectionType::OUTBOUND_FULL_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::BLOCK_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::INBOUND);\n+\n+    for (auto conn_type : conn_types) {\n+        CAddress addr{};\n+        m_connections.push_back(new CNode(id++, nullptr, addr, 0, 0, addr, \"\", conn_type, false));\n+        CNode& p2p_node = *m_connections.back();\n+\n+        connman.Handshake(\n+            /*node=*/p2p_node,\n+            /*successfully_connected=*/true,\n+            /*remote_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*local_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*version=*/PROTOCOL_VERSION,\n+            /*relay_txs=*/true);\n+\n+        connman.AddTestNode(p2p_node);\n+    }\n+}\n+\n+void HeadersSyncSetup::SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+{\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    CNode& connection = *PickValue(fuzzed_data_provider, m_connections);\n+\n+    (void)connman.ReceiveMsgFrom(connection, msg);\n+    connection.fPauseSend = false;\n+    try {\n+        connman.ProcessMessagesOnce(connection);\n+    } catch (const std::ios_base::failure&) {\n+    }\n+    m_node.peerman->SendMessages(&connection);\n+}\n+\n+CBlockHeader ConsumeHeader(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    CBlockHeader header;\n+    header.nNonce = 0;\n+    // Either use the previous difficulty or let the fuzzer choose\n+    header.nBits = fuzzed_data_provider.ConsumeBool() ?\n+                       prev_nbits :\n+                       fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(0x17058EBE, 0x1D00FFFF);\n+    header.nTime = fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n+    header.hashPrevBlock = prev_hash;\n+    return header;\n+}\n+\n+CBlock ConsumeBlock(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    auto header = ConsumeHeader(fuzzed_data_provider, prev_hash, prev_nbits);\n+    // Doesn't need to be a valid block but it needs to have one transaction\n+    // for compact block construction.\n+    CBlock block{header};\n+    block.vtx.push_back(MakeTransactionRef(CMutableTransaction{}));\n+    return block;\n+}\n+\n+void FinalizeHeader(CBlockHeader& header)\n+{\n+    while (!CheckProofOfWork(header.GetHash(), header.nBits, Params().GetConsensus())) {\n+        ++(header.nNonce);\n+    }\n+}\n+\n+// Global setup works for this test as state modification (specifically in the\n+// block index) would indicate a bug.\n+HeadersSyncSetup* g_testing_setup;\n+\n+void initialize()\n+{\n+    // Reduce proof-of-work check to one bit.\n+    g_check_pow_mock = [](uint256 hash, unsigned int, const Consensus::Params&) {\n+        return (hash.data()[31] & 0x80) == 0;\n+    };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1273450317",
      "id" : 1273450317,
      "in_reply_to_id" : 1272659160,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII585L509N",
      "original_commit_id" : "4407469bd697d50beb9afe4bb946d55952c1893d",
      "original_line" : 126,
      "original_position" : 127,
      "original_start_line" : 124,
      "path" : "src/test/fuzz/p2p_headers_sync.cpp",
      "position" : 126,
      "pull_request_review_id" : 1545327630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273450317/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 123,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-25T12:23:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273450317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1273466446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273466446"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How is this different from CallOneOf?",
      "commit_id" : "8a7feb65732742b2bd88263e751e9f9cdc21fdce",
      "created_at" : "2023-07-25T12:35:21Z",
      "diff_hunk" : "@@ -0,0 +1,197 @@\n+#include <blockencodings.h>\n+#include <net.h>\n+#include <net_processing.h>\n+#include <netmessagemaker.h>\n+#include <node/peerman_args.h>\n+#include <pow.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/net.h>\n+#include <test/util/script.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+namespace {\n+constexpr uint32_t FUZZ_MAX_HEADERS_RESULTS{16};\n+\n+class HeadersSyncSetup : public TestingSetup\n+{\n+    std::vector<CNode*> m_connections;\n+\n+public:\n+    HeadersSyncSetup(const ChainType chain_type = ChainType::MAIN,\n+                     const std::vector<const char*>& extra_args = {})\n+        : TestingSetup(chain_type, extra_args)\n+    {\n+        PeerManager::Options peerman_opts;\n+        node::ApplyArgsManOptions(*m_node.args, peerman_opts);\n+        peerman_opts.max_headers_result = FUZZ_MAX_HEADERS_RESULTS;\n+        m_node.peerman = PeerManager::make(*m_node.connman, *m_node.addrman,\n+                                           m_node.banman.get(), *m_node.chainman,\n+                                           *m_node.mempool, peerman_opts);\n+\n+        CConnman::Options options;\n+        options.m_msgproc = m_node.peerman.get();\n+        m_node.connman->Init(options);\n+    }\n+\n+    void ResetAndInitialize() EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+    void SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+        EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+};\n+\n+void HeadersSyncSetup::ResetAndInitialize()\n+{\n+    m_connections.clear();\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    connman.StopNodes();\n+\n+    NodeId id{0};\n+    std::vector<ConnectionType> conn_types = {};\n+    conn_types.resize(1, ConnectionType::OUTBOUND_FULL_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::BLOCK_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::INBOUND);\n+\n+    for (auto conn_type : conn_types) {\n+        CAddress addr{};\n+        m_connections.push_back(new CNode(id++, nullptr, addr, 0, 0, addr, \"\", conn_type, false));\n+        CNode& p2p_node = *m_connections.back();\n+\n+        connman.Handshake(\n+            /*node=*/p2p_node,\n+            /*successfully_connected=*/true,\n+            /*remote_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*local_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*version=*/PROTOCOL_VERSION,\n+            /*relay_txs=*/true);\n+\n+        connman.AddTestNode(p2p_node);\n+    }\n+}\n+\n+void HeadersSyncSetup::SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+{\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    CNode& connection = *PickValue(fuzzed_data_provider, m_connections);\n+\n+    (void)connman.ReceiveMsgFrom(connection, msg);\n+    connection.fPauseSend = false;\n+    try {\n+        connman.ProcessMessagesOnce(connection);\n+    } catch (const std::ios_base::failure&) {\n+    }\n+    m_node.peerman->SendMessages(&connection);\n+}\n+\n+CBlockHeader ConsumeHeader(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    CBlockHeader header;\n+    header.nNonce = 0;\n+    // Either use the previous difficulty or let the fuzzer choose\n+    header.nBits = fuzzed_data_provider.ConsumeBool() ?\n+                       prev_nbits :\n+                       fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(0x17058EBE, 0x1D00FFFF);\n+    header.nTime = fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n+    header.hashPrevBlock = prev_hash;\n+    return header;\n+}\n+\n+CBlock ConsumeBlock(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    auto header = ConsumeHeader(fuzzed_data_provider, prev_hash, prev_nbits);\n+    // Doesn't need to be a valid block but it needs to have one transaction\n+    // for compact block construction.\n+    CBlock block{header};\n+    block.vtx.push_back(MakeTransactionRef(CMutableTransaction{}));\n+    return block;\n+}\n+\n+void FinalizeHeader(CBlockHeader& header)\n+{\n+    while (!CheckProofOfWork(header.GetHash(), header.nBits, Params().GetConsensus())) {\n+        ++(header.nNonce);\n+    }\n+}\n+\n+// Global setup works for this test as state modification (specifically in the\n+// block index) would indicate a bug.\n+HeadersSyncSetup* g_testing_setup;\n+\n+void initialize()\n+{\n+    // Reduce proof-of-work check to one bit.\n+    g_check_pow_mock = [](uint256 hash, unsigned int, const Consensus::Params&) {\n+        return (hash.data()[31] & 0x80) == 0;\n+    };\n+\n+    static auto setup = MakeNoLogFileContext<HeadersSyncSetup>(ChainType::MAIN, {\"-checkpoints=0\"});\n+    g_testing_setup = setup.get();\n+}\n+} // namespace\n+\n+FUZZ_TARGET(p2p_headers_sync, .init = initialize)\n+{\n+    ChainstateManager& chainman = *g_testing_setup->m_node.chainman;\n+\n+    LOCK(NetEventsInterface::g_msgproc_mutex);\n+\n+    g_testing_setup->ResetAndInitialize();\n+\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+\n+    CBlockHeader base{Params().GenesisBlock()};\n+    SetMockTime(Params().GenesisBlock().nTime);\n+\n+    size_t original_index_size{WITH_LOCK(cs_main, return chainman.m_blockman.m_block_index.size())};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.remaining_bytes(), 100)\n+    {\n+        auto finalized_block = [&]() {\n+            auto prev = WITH_LOCK(cs_main,\n+                                  return PickValue(fuzzed_data_provider, chainman.m_blockman.m_block_index))\n+                            .second.GetBlockHeader();\n+            CBlock block = ConsumeBlock(fuzzed_data_provider, prev.GetHash(), prev.nBits);\n+            FinalizeHeader(block);\n+            return block;\n+        };\n+\n+        std::vector<std::function<void()>> actions = {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1273466446",
      "id" : 1273466446,
      "line" : 159,
      "node_id" : "PRRC_kwDOABII585L545O",
      "original_commit_id" : "8a7feb65732742b2bd88263e751e9f9cdc21fdce",
      "original_line" : 159,
      "original_position" : 159,
      "original_start_line" : null,
      "path" : "src/test/fuzz/p2p_headers_sync.cpp",
      "position" : 159,
      "pull_request_review_id" : 1545352861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273466446/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-28T09:48:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273466446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1278551101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278551101"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it's not, iirc I had some trouble with thread safety annotations but I'll give `CallOneOf` another try",
      "commit_id" : "8a7feb65732742b2bd88263e751e9f9cdc21fdce",
      "created_at" : "2023-07-30T11:12:47Z",
      "diff_hunk" : "@@ -0,0 +1,197 @@\n+#include <blockencodings.h>\n+#include <net.h>\n+#include <net_processing.h>\n+#include <netmessagemaker.h>\n+#include <node/peerman_args.h>\n+#include <pow.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/net.h>\n+#include <test/util/script.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+namespace {\n+constexpr uint32_t FUZZ_MAX_HEADERS_RESULTS{16};\n+\n+class HeadersSyncSetup : public TestingSetup\n+{\n+    std::vector<CNode*> m_connections;\n+\n+public:\n+    HeadersSyncSetup(const ChainType chain_type = ChainType::MAIN,\n+                     const std::vector<const char*>& extra_args = {})\n+        : TestingSetup(chain_type, extra_args)\n+    {\n+        PeerManager::Options peerman_opts;\n+        node::ApplyArgsManOptions(*m_node.args, peerman_opts);\n+        peerman_opts.max_headers_result = FUZZ_MAX_HEADERS_RESULTS;\n+        m_node.peerman = PeerManager::make(*m_node.connman, *m_node.addrman,\n+                                           m_node.banman.get(), *m_node.chainman,\n+                                           *m_node.mempool, peerman_opts);\n+\n+        CConnman::Options options;\n+        options.m_msgproc = m_node.peerman.get();\n+        m_node.connman->Init(options);\n+    }\n+\n+    void ResetAndInitialize() EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+    void SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+        EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+};\n+\n+void HeadersSyncSetup::ResetAndInitialize()\n+{\n+    m_connections.clear();\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    connman.StopNodes();\n+\n+    NodeId id{0};\n+    std::vector<ConnectionType> conn_types = {};\n+    conn_types.resize(1, ConnectionType::OUTBOUND_FULL_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::BLOCK_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::INBOUND);\n+\n+    for (auto conn_type : conn_types) {\n+        CAddress addr{};\n+        m_connections.push_back(new CNode(id++, nullptr, addr, 0, 0, addr, \"\", conn_type, false));\n+        CNode& p2p_node = *m_connections.back();\n+\n+        connman.Handshake(\n+            /*node=*/p2p_node,\n+            /*successfully_connected=*/true,\n+            /*remote_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*local_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*version=*/PROTOCOL_VERSION,\n+            /*relay_txs=*/true);\n+\n+        connman.AddTestNode(p2p_node);\n+    }\n+}\n+\n+void HeadersSyncSetup::SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+{\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    CNode& connection = *PickValue(fuzzed_data_provider, m_connections);\n+\n+    (void)connman.ReceiveMsgFrom(connection, msg);\n+    connection.fPauseSend = false;\n+    try {\n+        connman.ProcessMessagesOnce(connection);\n+    } catch (const std::ios_base::failure&) {\n+    }\n+    m_node.peerman->SendMessages(&connection);\n+}\n+\n+CBlockHeader ConsumeHeader(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    CBlockHeader header;\n+    header.nNonce = 0;\n+    // Either use the previous difficulty or let the fuzzer choose\n+    header.nBits = fuzzed_data_provider.ConsumeBool() ?\n+                       prev_nbits :\n+                       fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(0x17058EBE, 0x1D00FFFF);\n+    header.nTime = fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n+    header.hashPrevBlock = prev_hash;\n+    return header;\n+}\n+\n+CBlock ConsumeBlock(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    auto header = ConsumeHeader(fuzzed_data_provider, prev_hash, prev_nbits);\n+    // Doesn't need to be a valid block but it needs to have one transaction\n+    // for compact block construction.\n+    CBlock block{header};\n+    block.vtx.push_back(MakeTransactionRef(CMutableTransaction{}));\n+    return block;\n+}\n+\n+void FinalizeHeader(CBlockHeader& header)\n+{\n+    while (!CheckProofOfWork(header.GetHash(), header.nBits, Params().GetConsensus())) {\n+        ++(header.nNonce);\n+    }\n+}\n+\n+// Global setup works for this test as state modification (specifically in the\n+// block index) would indicate a bug.\n+HeadersSyncSetup* g_testing_setup;\n+\n+void initialize()\n+{\n+    // Reduce proof-of-work check to one bit.\n+    g_check_pow_mock = [](uint256 hash, unsigned int, const Consensus::Params&) {\n+        return (hash.data()[31] & 0x80) == 0;\n+    };\n+\n+    static auto setup = MakeNoLogFileContext<HeadersSyncSetup>(ChainType::MAIN, {\"-checkpoints=0\"});\n+    g_testing_setup = setup.get();\n+}\n+} // namespace\n+\n+FUZZ_TARGET(p2p_headers_sync, .init = initialize)\n+{\n+    ChainstateManager& chainman = *g_testing_setup->m_node.chainman;\n+\n+    LOCK(NetEventsInterface::g_msgproc_mutex);\n+\n+    g_testing_setup->ResetAndInitialize();\n+\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+\n+    CBlockHeader base{Params().GenesisBlock()};\n+    SetMockTime(Params().GenesisBlock().nTime);\n+\n+    size_t original_index_size{WITH_LOCK(cs_main, return chainman.m_blockman.m_block_index.size())};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.remaining_bytes(), 100)\n+    {\n+        auto finalized_block = [&]() {\n+            auto prev = WITH_LOCK(cs_main,\n+                                  return PickValue(fuzzed_data_provider, chainman.m_blockman.m_block_index))\n+                            .second.GetBlockHeader();\n+            CBlock block = ConsumeBlock(fuzzed_data_provider, prev.GetHash(), prev.nBits);\n+            FinalizeHeader(block);\n+            return block;\n+        };\n+\n+        std::vector<std::function<void()>> actions = {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1278551101",
      "id" : 1278551101,
      "in_reply_to_id" : 1273466446,
      "line" : 159,
      "node_id" : "PRRC_kwDOABII585MNSQ9",
      "original_commit_id" : "8a7feb65732742b2bd88263e751e9f9cdc21fdce",
      "original_line" : 159,
      "original_position" : 159,
      "original_start_line" : null,
      "path" : "src/test/fuzz/p2p_headers_sync.cpp",
      "position" : 159,
      "pull_request_review_id" : 1553624235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278551101/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-30T11:12:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278551101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1278891247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278891247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think you can use annotations one way or the other. As soon as you assign to `std::function<void()>`, the annotations are dropped, so you might as well not have them in the first place.\r\n\r\nIf you want them, and use `CallOneOf`, you can use the same trick to wrap each annotated lambda into a `std::function<void()>{lambda_bla}` temporary to achieve the same result of dropping any annotations.",
      "commit_id" : "f718a2cdf8fdaccfdc6281155246a878c6800a58",
      "created_at" : "2023-07-31T07:29:25Z",
      "diff_hunk" : "@@ -0,0 +1,197 @@\n+#include <blockencodings.h>\n+#include <net.h>\n+#include <net_processing.h>\n+#include <netmessagemaker.h>\n+#include <node/peerman_args.h>\n+#include <pow.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/net.h>\n+#include <test/util/script.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+namespace {\n+constexpr uint32_t FUZZ_MAX_HEADERS_RESULTS{16};\n+\n+class HeadersSyncSetup : public TestingSetup\n+{\n+    std::vector<CNode*> m_connections;\n+\n+public:\n+    HeadersSyncSetup(const ChainType chain_type = ChainType::MAIN,\n+                     const std::vector<const char*>& extra_args = {})\n+        : TestingSetup(chain_type, extra_args)\n+    {\n+        PeerManager::Options peerman_opts;\n+        node::ApplyArgsManOptions(*m_node.args, peerman_opts);\n+        peerman_opts.max_headers_result = FUZZ_MAX_HEADERS_RESULTS;\n+        m_node.peerman = PeerManager::make(*m_node.connman, *m_node.addrman,\n+                                           m_node.banman.get(), *m_node.chainman,\n+                                           *m_node.mempool, peerman_opts);\n+\n+        CConnman::Options options;\n+        options.m_msgproc = m_node.peerman.get();\n+        m_node.connman->Init(options);\n+    }\n+\n+    void ResetAndInitialize() EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+    void SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+        EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+};\n+\n+void HeadersSyncSetup::ResetAndInitialize()\n+{\n+    m_connections.clear();\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    connman.StopNodes();\n+\n+    NodeId id{0};\n+    std::vector<ConnectionType> conn_types = {};\n+    conn_types.resize(1, ConnectionType::OUTBOUND_FULL_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::BLOCK_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::INBOUND);\n+\n+    for (auto conn_type : conn_types) {\n+        CAddress addr{};\n+        m_connections.push_back(new CNode(id++, nullptr, addr, 0, 0, addr, \"\", conn_type, false));\n+        CNode& p2p_node = *m_connections.back();\n+\n+        connman.Handshake(\n+            /*node=*/p2p_node,\n+            /*successfully_connected=*/true,\n+            /*remote_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*local_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*version=*/PROTOCOL_VERSION,\n+            /*relay_txs=*/true);\n+\n+        connman.AddTestNode(p2p_node);\n+    }\n+}\n+\n+void HeadersSyncSetup::SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+{\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    CNode& connection = *PickValue(fuzzed_data_provider, m_connections);\n+\n+    (void)connman.ReceiveMsgFrom(connection, msg);\n+    connection.fPauseSend = false;\n+    try {\n+        connman.ProcessMessagesOnce(connection);\n+    } catch (const std::ios_base::failure&) {\n+    }\n+    m_node.peerman->SendMessages(&connection);\n+}\n+\n+CBlockHeader ConsumeHeader(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    CBlockHeader header;\n+    header.nNonce = 0;\n+    // Either use the previous difficulty or let the fuzzer choose\n+    header.nBits = fuzzed_data_provider.ConsumeBool() ?\n+                       prev_nbits :\n+                       fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(0x17058EBE, 0x1D00FFFF);\n+    header.nTime = fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n+    header.hashPrevBlock = prev_hash;\n+    return header;\n+}\n+\n+CBlock ConsumeBlock(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    auto header = ConsumeHeader(fuzzed_data_provider, prev_hash, prev_nbits);\n+    // Doesn't need to be a valid block but it needs to have one transaction\n+    // for compact block construction.\n+    CBlock block{header};\n+    block.vtx.push_back(MakeTransactionRef(CMutableTransaction{}));\n+    return block;\n+}\n+\n+void FinalizeHeader(CBlockHeader& header)\n+{\n+    while (!CheckProofOfWork(header.GetHash(), header.nBits, Params().GetConsensus())) {\n+        ++(header.nNonce);\n+    }\n+}\n+\n+// Global setup works for this test as state modification (specifically in the\n+// block index) would indicate a bug.\n+HeadersSyncSetup* g_testing_setup;\n+\n+void initialize()\n+{\n+    // Reduce proof-of-work check to one bit.\n+    g_check_pow_mock = [](uint256 hash, unsigned int, const Consensus::Params&) {\n+        return (hash.data()[31] & 0x80) == 0;\n+    };\n+\n+    static auto setup = MakeNoLogFileContext<HeadersSyncSetup>(ChainType::MAIN, {\"-checkpoints=0\"});\n+    g_testing_setup = setup.get();\n+}\n+} // namespace\n+\n+FUZZ_TARGET(p2p_headers_sync, .init = initialize)\n+{\n+    ChainstateManager& chainman = *g_testing_setup->m_node.chainman;\n+\n+    LOCK(NetEventsInterface::g_msgproc_mutex);\n+\n+    g_testing_setup->ResetAndInitialize();\n+\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+\n+    CBlockHeader base{Params().GenesisBlock()};\n+    SetMockTime(Params().GenesisBlock().nTime);\n+\n+    size_t original_index_size{WITH_LOCK(cs_main, return chainman.m_blockman.m_block_index.size())};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.remaining_bytes(), 100)\n+    {\n+        auto finalized_block = [&]() {\n+            auto prev = WITH_LOCK(cs_main,\n+                                  return PickValue(fuzzed_data_provider, chainman.m_blockman.m_block_index))\n+                            .second.GetBlockHeader();\n+            CBlock block = ConsumeBlock(fuzzed_data_provider, prev.GetHash(), prev.nBits);\n+            FinalizeHeader(block);\n+            return block;\n+        };\n+\n+        std::vector<std::function<void()>> actions = {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1278891247",
      "id" : 1278891247,
      "in_reply_to_id" : 1273466446,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MOlTv",
      "original_commit_id" : "8a7feb65732742b2bd88263e751e9f9cdc21fdce",
      "original_line" : 159,
      "original_position" : 159,
      "original_start_line" : null,
      "path" : "src/test/fuzz/p2p_headers_sync.cpp",
      "position" : null,
      "pull_request_review_id" : 1554119998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278891247/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-31T07:29:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278891247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1278954263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278954263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "switched to `CallOneOf` and used `NO_THREAD_SAFETY_ANALYSIS`.",
      "commit_id" : "f718a2cdf8fdaccfdc6281155246a878c6800a58",
      "created_at" : "2023-07-31T08:27:46Z",
      "diff_hunk" : "@@ -0,0 +1,197 @@\n+#include <blockencodings.h>\n+#include <net.h>\n+#include <net_processing.h>\n+#include <netmessagemaker.h>\n+#include <node/peerman_args.h>\n+#include <pow.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/net.h>\n+#include <test/util/script.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+namespace {\n+constexpr uint32_t FUZZ_MAX_HEADERS_RESULTS{16};\n+\n+class HeadersSyncSetup : public TestingSetup\n+{\n+    std::vector<CNode*> m_connections;\n+\n+public:\n+    HeadersSyncSetup(const ChainType chain_type = ChainType::MAIN,\n+                     const std::vector<const char*>& extra_args = {})\n+        : TestingSetup(chain_type, extra_args)\n+    {\n+        PeerManager::Options peerman_opts;\n+        node::ApplyArgsManOptions(*m_node.args, peerman_opts);\n+        peerman_opts.max_headers_result = FUZZ_MAX_HEADERS_RESULTS;\n+        m_node.peerman = PeerManager::make(*m_node.connman, *m_node.addrman,\n+                                           m_node.banman.get(), *m_node.chainman,\n+                                           *m_node.mempool, peerman_opts);\n+\n+        CConnman::Options options;\n+        options.m_msgproc = m_node.peerman.get();\n+        m_node.connman->Init(options);\n+    }\n+\n+    void ResetAndInitialize() EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+    void SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+        EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n+};\n+\n+void HeadersSyncSetup::ResetAndInitialize()\n+{\n+    m_connections.clear();\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    connman.StopNodes();\n+\n+    NodeId id{0};\n+    std::vector<ConnectionType> conn_types = {};\n+    conn_types.resize(1, ConnectionType::OUTBOUND_FULL_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::BLOCK_RELAY);\n+    conn_types.resize(conn_types.size() + 1, ConnectionType::INBOUND);\n+\n+    for (auto conn_type : conn_types) {\n+        CAddress addr{};\n+        m_connections.push_back(new CNode(id++, nullptr, addr, 0, 0, addr, \"\", conn_type, false));\n+        CNode& p2p_node = *m_connections.back();\n+\n+        connman.Handshake(\n+            /*node=*/p2p_node,\n+            /*successfully_connected=*/true,\n+            /*remote_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*local_services=*/ServiceFlags(NODE_NETWORK | NODE_WITNESS),\n+            /*version=*/PROTOCOL_VERSION,\n+            /*relay_txs=*/true);\n+\n+        connman.AddTestNode(p2p_node);\n+    }\n+}\n+\n+void HeadersSyncSetup::SendMessage(FuzzedDataProvider& fuzzed_data_provider, CSerializedNetMsg&& msg)\n+{\n+    auto& connman = static_cast<ConnmanTestMsg&>(*m_node.connman);\n+    CNode& connection = *PickValue(fuzzed_data_provider, m_connections);\n+\n+    (void)connman.ReceiveMsgFrom(connection, msg);\n+    connection.fPauseSend = false;\n+    try {\n+        connman.ProcessMessagesOnce(connection);\n+    } catch (const std::ios_base::failure&) {\n+    }\n+    m_node.peerman->SendMessages(&connection);\n+}\n+\n+CBlockHeader ConsumeHeader(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    CBlockHeader header;\n+    header.nNonce = 0;\n+    // Either use the previous difficulty or let the fuzzer choose\n+    header.nBits = fuzzed_data_provider.ConsumeBool() ?\n+                       prev_nbits :\n+                       fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(0x17058EBE, 0x1D00FFFF);\n+    header.nTime = fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n+    header.hashPrevBlock = prev_hash;\n+    return header;\n+}\n+\n+CBlock ConsumeBlock(FuzzedDataProvider& fuzzed_data_provider, const uint256& prev_hash, uint32_t prev_nbits)\n+{\n+    auto header = ConsumeHeader(fuzzed_data_provider, prev_hash, prev_nbits);\n+    // Doesn't need to be a valid block but it needs to have one transaction\n+    // for compact block construction.\n+    CBlock block{header};\n+    block.vtx.push_back(MakeTransactionRef(CMutableTransaction{}));\n+    return block;\n+}\n+\n+void FinalizeHeader(CBlockHeader& header)\n+{\n+    while (!CheckProofOfWork(header.GetHash(), header.nBits, Params().GetConsensus())) {\n+        ++(header.nNonce);\n+    }\n+}\n+\n+// Global setup works for this test as state modification (specifically in the\n+// block index) would indicate a bug.\n+HeadersSyncSetup* g_testing_setup;\n+\n+void initialize()\n+{\n+    // Reduce proof-of-work check to one bit.\n+    g_check_pow_mock = [](uint256 hash, unsigned int, const Consensus::Params&) {\n+        return (hash.data()[31] & 0x80) == 0;\n+    };\n+\n+    static auto setup = MakeNoLogFileContext<HeadersSyncSetup>(ChainType::MAIN, {\"-checkpoints=0\"});\n+    g_testing_setup = setup.get();\n+}\n+} // namespace\n+\n+FUZZ_TARGET(p2p_headers_sync, .init = initialize)\n+{\n+    ChainstateManager& chainman = *g_testing_setup->m_node.chainman;\n+\n+    LOCK(NetEventsInterface::g_msgproc_mutex);\n+\n+    g_testing_setup->ResetAndInitialize();\n+\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+\n+    CBlockHeader base{Params().GenesisBlock()};\n+    SetMockTime(Params().GenesisBlock().nTime);\n+\n+    size_t original_index_size{WITH_LOCK(cs_main, return chainman.m_blockman.m_block_index.size())};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.remaining_bytes(), 100)\n+    {\n+        auto finalized_block = [&]() {\n+            auto prev = WITH_LOCK(cs_main,\n+                                  return PickValue(fuzzed_data_provider, chainman.m_blockman.m_block_index))\n+                            .second.GetBlockHeader();\n+            CBlock block = ConsumeBlock(fuzzed_data_provider, prev.GetHash(), prev.nBits);\n+            FinalizeHeader(block);\n+            return block;\n+        };\n+\n+        std::vector<std::function<void()>> actions = {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1278954263",
      "id" : 1278954263,
      "in_reply_to_id" : 1273466446,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MO0sX",
      "original_commit_id" : "8a7feb65732742b2bd88263e751e9f9cdc21fdce",
      "original_line" : 159,
      "original_position" : 159,
      "original_start_line" : null,
      "path" : "src/test/fuzz/p2p_headers_sync.cpp",
      "position" : null,
      "pull_request_review_id" : 1554221712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278954263/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-31T08:27:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278954263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-05T14:27:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1749021412",
      "id" : 1749021412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585oP_Lk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1749021412/reactions"
      },
      "updated_at" : "2023-10-05T14:27:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1749021412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\ntest/fuzz/p2p_headers_sync.cpp:187:96:   required from here\r\n./primitives/transaction.h:327:42: error: âclass CVectorWriterâ has no member named âGetParamsâ\r\n  327 |         SerializeTransaction(*this, s, s.GetParams());\r\n      |                                        ~~^~~~~~~~~\r\nmake[2]: *** [Makefile:17531: test/fuzz/fuzz-p2p_headers_sync.o] Error 1\r\nmake[2]: Leaving directory '/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src'\r\nmake[1]: *** [Makefile:20246: install-recursive] Error 1\r\nmake[1]: Leaving directory '/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src'\r\nmake: *** [Makefile:811: install-recursive] Error 1\r\n\r\nExit status: 2ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½",
      "created_at" : "2023-11-17T10:34:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1816123363",
      "id" : 1816123363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585sP9fj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1816123363/reactions"
      },
      "updated_at" : "2023-11-17T10:34:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1816123363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks! rebased.",
      "created_at" : "2023-11-20T16:09:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1819360700",
      "id" : 1819360700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585scT28",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1819360700/reactions"
      },
      "updated_at" : "2023-11-20T16:09:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1819360700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Planning on reviewing soon.",
      "created_at" : "2023-11-20T16:11:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1819363878",
      "id" : 1819363878,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585scUom",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1819363878/reactions"
      },
      "updated_at" : "2023-11-20T16:11:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1819363878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Needs rebase (silent merge conflict).",
      "created_at" : "2023-12-01T21:20:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1836792663",
      "id" : 1836792663,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585teztX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1836792663/reactions"
      },
      "updated_at" : "2023-12-01T21:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1836792663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Needs rebase (silent merge conflict).\r\n\r\nThanks, rebased",
      "created_at" : "2023-12-06T15:01:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#issuecomment-1843065442",
      "id" : 1843065442,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28043",
      "node_id" : "IC_kwDOABII585t2vJi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1843065442/reactions"
      },
      "updated_at" : "2023-12-06T15:01:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1843065442",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1446512814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446512814"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should probably have some belt-and-suspenders check that we're 100% not running on mainnet, maybe based on the contents of `params` and whatever applicable global.",
      "commit_id" : "a95524240b0441d15eb0df53c5be293da309bba7",
      "created_at" : "2024-01-09T19:29:25Z",
      "diff_hunk" : "@@ -122,8 +122,14 @@ bool PermittedDifficultyTransition(const Consensus::Params& params, int64_t heig\n     return true;\n }\n \n+std::function<bool(uint256, unsigned int, const Consensus::Params&)> g_check_pow_mock = nullptr;\n+\n bool CheckProofOfWork(uint256 hash, unsigned int nBits, const Consensus::Params& params)\n {\n+    if (g_check_pow_mock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28043#discussion_r1446512814",
      "id" : 1446512814,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII585WOAiu",
      "original_commit_id" : "a95524240b0441d15eb0df53c5be293da309bba7",
      "original_line" : 129,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/pow.cpp",
      "position" : 8,
      "pull_request_review_id" : 1811847461,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28043",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446512814/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-01-09T19:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1446512814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
