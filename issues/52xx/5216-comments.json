[
   {
      "body" : "@gavinandresen @mikehearn Gavin, Mike, can you help me out with BIP70, I need to understand for some code I want to use, if even for insecure payment-requests (``pki_type() == \"none\"``) the payment-request has to reside on a webserver secured by SSL, so that for Bitcoin Core it's safe to assume the connection is always SSL (port 443) secured.\r\n\r\nI only found this ``PaymentDetails.payment_url should be secure against man-in-the-middle attacks that might alter Payment.refund_to (if using HTTP, it must be TLS-protected).``, does this lead to \"you HAVE to use https\" if you want to be a BIP70 compatible merchant server?",
      "created_at" : "2014-11-07T07:03:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-62106414",
      "id" : 62106414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-07T07:07:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62106414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "I don't think most implementations enforce it, but serving any kind of payment request for any kind of payment network without SSL, not just bitcoin, would seem very dangerous and ill advised.\r\n\r\nWhen the payment request is itself signed, then using SSL only adds some privacy but not security. It's still a good idea though.",
      "created_at" : "2014-11-07T12:40:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-62136872",
      "id" : 62136872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-07T12:40:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62136872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "@mikehearn Thanks for your info. I found what I needed :).\r\n@laanwj Any time for this?\r\n@fanquake Ping :)",
      "created_at" : "2014-11-13T14:31:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-62897747",
      "id" : 62897747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-13T14:31:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/62897747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@Diapolo I'll take a look.",
      "created_at" : "2014-11-18T23:03:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-63562570",
      "id" : 63562570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-18T23:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/63562570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=3",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "body" : "This now could need some initial review as the pull gets to big otheriwse...",
      "created_at" : "2014-11-19T12:02:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-63630077",
      "id" : 63630077,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-19T12:02:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/63630077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r20571214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20571214"
         }
      },
      "body" : "@laanwj I was thinkig about how I could supply our debug.log without a translated string as that could improve debugging or web searches for that strings. Have you got a nice and clean idea without duplicating the whole string?",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-11-19T12:10:43Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r20571214",
      "id" : 20571214,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20571214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r20571871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20571871"
         }
      },
      "body" : "I can't think of anything that would be cleaner than just duplicating the message, or logging a different message",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-11-19T12:29:09Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r20571871",
      "id" : 20571871,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/20571871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Code review ACK.\r\n\r\nCan you add a unit test to src/qt/test/paymentservertests.cpp to test the new DoS-protection code?\r\n",
      "created_at" : "2014-11-24T15:41:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-64211957",
      "id" : 64211957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-24T15:41:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/64211957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen Thanks for your review, I'm taking a look at your suggestion about adding a test now.",
      "created_at" : "2014-11-25T16:02:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-64422667",
      "id" : 64422667,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-25T16:02:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/64422667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@gavinandresen Not sure how to test the new code, as the DoS rules are in ``PaymentServer::readPaymentRequestFromFile()`` and ``PaymentServer::netRequestFinished()``, which are currently not used in the paymentservertests. Also the NEW code in ``PaymentServer::netRequestFinished()`` isn't triggerable currently either, as we deal with local payment-request-data supplied by ``paymentrequestdata.h``.\r\n\r\nI could perhaps add a dummy file with garbage data > BIP70_MAX_PAYMENTREQUEST_SIZE and then use ``PaymentServer::readPaymentRequestFromFile()`` with that. Is that what you are thinking about?",
      "created_at" : "2014-11-28T12:20:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-64888355",
      "id" : 64888355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-11-28T12:20:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/64888355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@gavinandresen Test added, can you review!?\r\n@laanwj Any chance to get this in for 0.10?",
      "created_at" : "2014-12-05T08:42:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-65761488",
      "id" : 65761488,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-12-05T08:42:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/65761488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Sure, though it'll first have to pass travis:\r\n```\r\nqt/test/paymentservertests.cpp: In member function Ã¢ÂÂvoid PaymentServerTests::paymentServerTests()Ã¢ÂÂ:\r\n\r\nqt/test/paymentservertests.cpp:121:5: error: Ã¢ÂÂreadPaymentRequestFromFileÃ¢ÂÂ was not declared in this scope\r\n\r\nmake[2]: *** [qt/test/qt_test_test_bitcoin_qt-paymentservertests.o] Error 1\r\n\r\nmake[2]: Leaving directory `/home/travis/build/bitcoin/bitcoin/bitcoin-i686-pc-linux-gnu/src'\r\n```",
      "created_at" : "2014-12-05T10:01:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-65769121",
      "id" : 65769121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-12-05T10:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/65769121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj I guess the code was missing ``PaymentServer::`` in front of the function ;).",
      "created_at" : "2014-12-05T10:26:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-65771705",
      "id" : 65771705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-12-05T10:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/65771705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Now passes Travis!",
      "created_at" : "2014-12-06T14:29:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-65898664",
      "id" : 65898664,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-12-06T14:29:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/65898664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21448829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21448829"
         }
      },
      "body" : "I wonder if there is a way to tell Qt to download only a maximum size of request. The problem with handling it in Finished() is that part of the DoS already has been done: we downloaded all the data into memory.\r\n",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T12:13:22Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21448829",
      "id" : 21448829,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21448829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21449002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21449002"
         }
      },
      "body" : "Never mind: this is before readAll, so supposedly we *haven't* read all the data yet.",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T12:19:06Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21449002",
      "id" : 21449002,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21449002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21449258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21449258"
         }
      },
      "body" : "**However**, as the network is a 'sequential device' it is possible for `readAll()` to return more bytes than `size()`, for example in the case that no ContentLength header was passed. `size()` is effectively useless in this case and just returns how many bytes are in the buffer now.\r\nA more robust way would be to do `read(BIP70_MAX_PAYMENTREQUEST_SIZE + 1)`, and then check for `>=BIP70_MAX_PAYMENTREQUEST_SIZE` received bytes.\r\n\r\nEdit: OK I'm completely confused here. Other sources suggest Qt has downloaded the entire file by the time `finished()` is called and `bytesAvailable()` will tell you how much `readAll()` will return. Which means the above will work, but it doesn't avoid the problem ...\r\n\r\nEdit2: QNetworkReply has a setReadBufferSize which *may* actually limit the read buffer. It defaults to unlimited. But I'm not sure finished() will even be called in that case or it will wait for someone to consume the buffer.\r\n\r\n",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T12:26:03Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21449258",
      "id" : 21449258,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21449258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21450375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21450375"
         }
      },
      "body" : "Wow, so now I'm also confused ^^... what can I do to fix/improve what I did here?\r\nCan we use ``QNetworkRequest::ContentLengthHeader`` -> Corresponds to the HTTP Content-Length header and contains the length in bytes of the data transmitted?",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T12:54:35Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21450375",
      "id" : 21450375,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21450375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21451118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21451118"
         }
      },
      "body" : "@laanwj I found that code:\r\n<pre>\r\nvoid MainWindow::on_download_button_clicked(){\r\n    QUrl url(\"http://someurl\");\r\n    QNetworkAccessManager * manager = new QNetworkAccessManager(this);\r\n    connect(manager, SIGNAL(finished(QNetworkReply*)), this, SLOT(getHeaders(QNetworkReply*)));\r\n    manager->head(QNetworkRequest(url));\r\n}\r\n\r\nvoid MainWindow::getHeaders(QNetworkReply * reply){\r\n    if (reply->operation() == QNetworkAccessManager::HeadOperation){\r\n        int content_length = reply->header(QNetworkRequest::ContentLengthHeader).toInt();\r\n    }\r\n}\r\n</pre>\r\n\r\nPerhaps we can just start by querying the headers, check the content length and abort if it's > BIP70_MAX_PAYMENTREQUEST_SIZE?",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T13:12:26Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21451118",
      "id" : 21451118,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21451118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Ok did some testing with regard to Qt5's http client. Created a simple http server that serves an arbitrary number of bytes with the correct Content-Type, in this case 50MB:\r\n```python\r\n#!/usr/bin/python3\r\n'''\r\nbitcoin:?r=http://127.0.0.1:8000/test\r\n'''\r\nfrom http.server import HTTPServer, BaseHTTPRequestHandler\r\n\r\nclass Handler(BaseHTTPRequestHandler):\r\n    def do_GET(self):\r\n        self.send_response(200)\r\n        self.send_header(\"Content-type\", \"application/bitcoin-payment\")\r\n        self.end_headers()\r\n        count = 0\r\n        while count < 50000:\r\n            self.wfile.write(b' ' * 1000)\r\n            count += 1\r\n\r\nserver_class=HTTPServer\r\nhandler_class=Handler\r\nserver_address = ('', 8000)\r\nhttpd = server_class(server_address, handler_class)\r\nhttpd.serve_forever()\r\n```\r\nExtended netRequestFinished with logging:\r\n```patch\r\ndiff --git a/src/qt/paymentserver.cpp b/src/qt/paymentserver.cpp\r\nindex 707de55..ead6675 100644\r\n--- a/src/qt/paymentserver.cpp\r\n+++ b/src/qt/paymentserver.cpp\r\n@@ -657,7 +657,10 @@ void PaymentServer::netRequestFinished(QNetworkReply* reply)\r\n         return;\r\n     }\r\n \r\n+    qWarning() << __func__ << \": size() is \" << reply->size() << \" bytesAvailable() is \" << reply->bytesAvailable();\r\n+\r\n     QByteArray data = reply->readAll();\r\n+    qWarning() << __func__ << \": data.size() is \" << data.size();\r\n \r\n     QString requestType = reply->request().attribute(QNetworkRequest::User).toString();\r\n     if (requestType == \"PaymentRequest\")\r\n```\r\nThen made qt fetch the `payment request`:\r\n```\r\n2014-12-08 14:25:19 GUI: netRequestFinished : size() is  50000000  bytesAvailable() is  50000000 \r\n2014-12-08 14:25:19 GUI: netRequestFinished : data.size() is  50000000 \r\n```\r\nConclusion\r\n\r\n1) qt will happily consume however many bytes are served, and reads everything into memory, even if this means to crash. This happens before the `finished` signal is even raised.\r\n2) `.size()`,  `.bytesAvailable()` (before `readAll`) and `data.size()` (after `readAll`) return the same number\r\n\r\nThe DoS protection code in this pull at most protects against parsing a huge protocol buffer. Which is a good start, although it would be nice to stop reading at some point when the server keeps sending data. OTOH I suppose this is an unlikely attack over the internet as the adversary has to actually send the data.\r\n",
      "created_at" : "2014-12-08T14:35:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-66123379",
      "id" : 66123379,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-12-08T14:43:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/66123379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21456223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21456223"
         }
      },
      "body" : "The server doesn't *have* to send a `Content-Length` header. \r\n\r\nAnd it certainly shouldn't do an extra HEAD-request. This causes double the number of requests and the server may just lie on a HEAD request.\r\n\r\nIf it's possible to look at the headers *before* starting the download one could, for example, reject requests without Content-Length header or with too large content.\r\n\r\nHowever, the only robust solution would be to limit the receive buffer, and bail out when it is full.",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T14:48:57Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21456223",
      "id" : 21456223,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21456223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@diapolo you don't have to solve that issue in this pull, ACK on these changes, they don't make matters worse,",
      "created_at" : "2014-12-08T14:56:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-66126531",
      "id" : 66126531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-12-08T14:56:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/66126531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21456896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21456896"
         }
      },
      "body" : "s/us/use/",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T14:58:18Z",
      "diff_hunk" : "@@ -85,6 +88,9 @@ class PaymentServer : public QObject\n     // OptionsModel is used for getting proxy settings and display unit\n     void setOptionsModel(OptionsModel *optionsModel);\n \n+    // This is now public, because we us it in paymentservertests.cpp\n+    static bool readPaymentRequestFromFile(const QString& filename, PaymentRequestPlus& request);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21456896",
      "id" : 21456896,
      "original_commit_id" : "b964ebd4fb26bbd646a15ba2fea6ca3de3488e02",
      "original_position" : 40,
      "path" : "src/qt/paymentserver.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21456896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21457781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21457781"
         }
      },
      "body" : "Thanks, changed to ``use`` ;).",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-08T15:10:29Z",
      "diff_hunk" : "@@ -85,6 +88,9 @@ class PaymentServer : public QObject\n     // OptionsModel is used for getting proxy settings and display unit\n     void setOptionsModel(OptionsModel *optionsModel);\n \n+    // This is now public, because we us it in paymentservertests.cpp\n+    static bool readPaymentRequestFromFile(const QString& filename, PaymentRequestPlus& request);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21457781",
      "id" : 21457781,
      "original_commit_id" : "b964ebd4fb26bbd646a15ba2fea6ca3de3488e02",
      "original_position" : 40,
      "path" : "src/qt/paymentserver.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-08T15:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21457781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@laanwj Is it okay to say this request is done!? As I said I have some more changes I'd like to add for payment requests. If you agree I would base new ones on this (or even better this gets merged soon).",
      "created_at" : "2014-12-09T07:11:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#issuecomment-66243302",
      "id" : 66243302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5216",
      "updated_at" : "2014-12-09T07:11:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/66243302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21931398"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21931398"
         }
      },
      "body" : "Have you take any measure to prevent the whole file to be downloaded or this is pending?",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-16T20:58:42Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21931398",
      "id" : 21931398,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-16T20:58:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21931398",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21958409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21958409"
         }
      },
      "body" : "There were no addidional changes made after the above discussion with @laanwj. If you come up with something to improve I'm going to pick it up ;).",
      "commit_id" : "5ec654b8ceb4c5f9aafda2b62a0aa6639d738654",
      "created_at" : "2014-12-17T08:38:30Z",
      "diff_hunk" : "@@ -646,13 +664,26 @@ void PaymentServer::fetchPaymentACK(CWallet* wallet, SendCoinsRecipient recipien\n void PaymentServer::netRequestFinished(QNetworkReply* reply)\n {\n     reply->deleteLater();\n-    if (reply->error() != QNetworkReply::NoError)\n-    {\n+\n+    // BIP70 DoS protection\n+    if (reply->size() > BIP70_MAX_PAYMENTREQUEST_SIZE) {\n+        QString msg = tr(\"Payment request %2 is too large (%3 bytes, allowed %4 bytes).\")\n+            .arg(__func__)\n+            .arg(reply->request().url().toString())\n+            .arg(reply->size())\n+            .arg(BIP70_MAX_PAYMENTREQUEST_SIZE);\n+\n+        qWarning() << QString(\"PaymentServer::%1:\").arg(__func__) << msg;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5216#discussion_r21958409",
      "id" : 21958409,
      "original_commit_id" : "1e0b5b4f349bf91adba0a5afe723d62bb4f9636c",
      "original_position" : 171,
      "path" : "src/qt/paymentserver.cpp",
      "position" : 201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5216",
      "updated_at" : "2014-12-17T08:38:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/21958409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   }
]
