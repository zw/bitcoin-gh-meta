[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28895).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1815306349), [vasild](https://github.com/bitcoin/bitcoin/pull/28895#pullrequestreview-1737007109), [guggero](https://github.com/bitcoin/bitcoin/pull/28895#pullrequestreview-1737192944), [brunoerg](https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1816739193) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-11-16T16:44:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1814827953",
      "id" : 1814827953,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sLBOx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814827953/reactions"
      },
      "updated_at" : "2023-11-17T16:37:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814827953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Reported in https://github.com/bitcoin/bitcoin/pull/27213/files#r1291926369 and extracted from an earlier version of https://github.com/bitcoin/bitcoin/pull/28248.\r\n\r\nThe first commit ought to be feasible to backport, if desired. The second test commit would require #28155.",
      "created_at" : "2023-11-16T16:49:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1814836299",
      "id" : 1814836299,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sLDRL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814836299/reactions"
      },
      "updated_at" : "2023-11-16T16:49:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814836299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thank you for isolating this change and making it more clear what you were going for.\r\n\r\nFrom what I understand the \"regression\" is not that we might make automatic connections to addnode peers but rather that if that happens these connections might stick around as automatic connections for longer (due to the new eviction logic), while not being labeled as manual.\r\n\r\nSo in the end a user might end up with less outbound connections than expected for longer than is currently possible, with some of their manual connections incorrectly labeled as automatic.\r\n\r\nIf the above is correct, then I am not sure if this is worthy of a backport at this stage in the release cycle because: 1) This should be rare and 2) the manual connections are still being made and persisted (just labeled incorrectly).",
      "created_at" : "2023-11-16T17:17:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1814890913",
      "id" : 1814890913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sLQmh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814890913/reactions"
      },
      "updated_at" : "2023-11-16T17:17:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814890913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Empirically, the regression is that we're actively adding addnode peers as outbound ones, and keeping them there. Since a couple of years I run a node with all three of our privacy networks and addnode entries for each, along with clearnet, and I didn't see my addnode peers being connected to as non-manual outbounds. This is new behavior for my node, it's frequent, it removes the intended privileges that addnode entries benefit from, and it impacts precisely the nodes running multiple networks including ones with fewer peers that used addnode entries to ensure connection to them.",
      "created_at" : "2023-11-16T17:23:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1814902180",
      "id" : 1814902180,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sLTWk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814902180/reactions"
      },
      "updated_at" : "2023-11-16T17:23:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814902180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Empirically, the regression is that we're actively adding addnode peers as outbound ones, and keeping them there.\r\n\r\nSure but logically, the regression is that the duration of these connections increased not that they are being made in the first place.\r\n\r\nI'm wondering why you only now noticed this, since the duration of these mislabeled connections prior to the new eviction logic (i assume) depended on regular outbound eviction behavior, which could also result in longer living connections.\r\n",
      "created_at" : "2023-11-16T18:05:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1814977689",
      "id" : 1814977689,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sLlyZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814977689/reactions"
      },
      "updated_at" : "2023-11-16T18:05:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1814977689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> From what I understand the \"regression\" is not that we might make automatic connections to addnode peers but rather that if that happens these connections might stick around as automatic connections for longer (due to the new eviction logic), while not being labeled as manual.\r\n\r\nThis stems from a change in this release where it was observed and reported. We did not previously automatically add outbound connections to addnode entries in sparse networks to the degree and regularity that we do now.\r\n\r\n> So in the end a user might end up with less outbound connections than expected for longer than is currently possible, with some of their manual connections incorrectly labeled as automatic.\r\n\r\n> Sure but logically, the regression is that the duration of these connections increased not that they are being made in the first place.\r\n\r\n> 1) This should be rare and 2) the manual connections are still being made and persisted (just labeled incorrectly).\r\n\r\nNo longer rare, and not only about mislabeled connections. The new change is also misallocating rare outbound connection slots, and attributing incorrect peer privileges as addnode peers benefit from non-eviction, are not disconnected or discouraged for bad behavior, etc.\r\n\r\n> I'm wondering why you only now noticed this, since the duration of these mislabeled connections prior to the new eviction logic (i assume) depended on regular outbound eviction behavior, which could also result in longer living connections.\r\n\r\nObserved and [reported](https://github.com/bitcoin/bitcoin/pull/27213/files#r1291926369) in August on the pull that made the change (there was no reaction). While it looks like it could occur somewhat rarely before, with the change it is now frequent, and more noticeable as the connections are protected.",
      "created_at" : "2023-11-16T18:30:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1815011799",
      "id" : 1815011799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sLuHX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1815011799/reactions"
      },
      "updated_at" : "2023-11-16T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1815011799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested ACK 5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1\r\n\r\nI tested this by running on cjdns and ipv4, and then manually disconnecting an addnode cjdns peer and observing the log - both on v26.0rc2 and this branch.\r\n\r\n> Sure but logically, the regression is that the duration of these connections increased not that they are being made in the first place.\r\n\r\nI think I disagree with that. They might now be protected from eviction due to network-specific extra peers, but that eviction is also new: Before #27213, we only had the stale-tip eviction, and I think that it would only extremely rarely evict such a peer because of the way it works (see [this post](https://github.com/bitcoin/bitcoin/pull/28248#issuecomment-1812702510) for why I think so), so once an automatic connections was made, it was probably never evicted unless there were other causes like we got offline or they disconnected us.\r\n\r\nI think that the mechanism mentioned in the OP (race after getting disconnected) is probably what makes this most noticeable, because `ThreadOpenAddedConnections()` has a long sleep (60s) which it wouldn't interrupt, and even though `EXTRA_NETWORK_PEER_INTERVAL = 5min` is larger, it would immediately kick in after the only peer from a network disconnected us (and then the next time ~5 minutes later), so `ThreadOpenConnection` would usually be quicker than `ThreadOpenAddedConnections()`.\r\n\r\nA completely unrelated problem is that this problem exists because cjdns has so few peers <10? on mainnet, which is a shame considering how much engineering effort went into it, but I'm not sure what to do about that.",
      "created_at" : "2023-11-16T21:01:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1815306349",
      "id" : 1815306349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sM2Bt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1815306349/reactions"
      },
      "updated_at" : "2023-11-16T21:02:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1815306349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> cjdns has so few peers <10? on mainnet, which is a shame considering how much engineering effort went into it, but I'm not sure what to do about that.\r\n\r\nI also saw the network-specific issue with i2p peers, and when adding a new network, though cjdns is indeed a good way to test it. As to what we can do to further cjdns adoption, when one-click I2P support was added to Raspiblitz and Umbrel in December 2022 after [this workshop and blog post](https://jonatack.github.io/articles/using-alternative-p2p-networks-with-bitcoin-core), the number of recent peers returned by -addrinfo for me went from a couple hundred to quickly more than a thousand, and now a couple thousand.  Cjdns being a friend-of-a-friend topology requires the additional step of finding a friend to connect to the network with, but we have a couple of stable ones in the hardcoded DNS seeds, and maybe I can encourage and work with the node-in-a-box packages to get support for it in (and do more related workshops).",
      "created_at" : "2023-11-16T21:16:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1815327046",
      "id" : 1815327046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sM7FG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1815327046/reactions"
      },
      "updated_at" : "2023-11-17T16:25:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1815327046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28895#discussion_r1396364317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28895"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1396364317"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note to self when retouching here or in follow-ups (i.e. #28248)\r\n\r\n```suggestion\r\n    for (const auto& node : connman->TestNodes()) {\r\n```",
      "commit_id" : "5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1",
      "created_at" : "2023-11-16T21:30:16Z",
      "diff_hunk" : "@@ -122,6 +122,13 @@ BOOST_AUTO_TEST_CASE(test_addnode_getaddednodeinfo_and_connection_detection)\n     BOOST_CHECK_EQUAL(connman->GetAddedNodeInfo(/*include_connected=*/true).size(), nodes.size());\n     BOOST_CHECK(connman->GetAddedNodeInfo(/*include_connected=*/false).empty());\n \n+    // Test AddedNodesContain()\n+    for (auto node : connman->TestNodes()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#discussion_r1396364317",
      "id" : 1396364317,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII585TOtQd",
      "original_commit_id" : "5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1",
      "original_line" : 126,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/net_peer_connection_tests.cpp",
      "position" : 5,
      "pull_request_review_id" : 1735562605,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28895",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1396364317/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-16T21:30:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1396364317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28895#discussion_r1397327937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28895"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397327937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(hit \"submit\" too early)\r\n\r\nnit, non-blocker: I do not think that this `< 24` cap is needed. What is the max number of added nodes expected?\r\n\r\nI think it is not worth doing that, but in theory, if this is to be optimized - then we can observe that `addr_port_str` begins with `addr_str`. For example `aaa:8333` and `aaa` and if we are checking if string `aaaa` is equal to either one, the way this is done now is that it would traverse the entire `aaaa` twice whereas it can be done with a single traverse. But please ignore this :)",
      "commit_id" : "5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1",
      "created_at" : "2023-11-17T13:40:06Z",
      "diff_hunk" : "@@ -3454,6 +3465,17 @@ bool CConnman::RemoveAddedNode(const std::string& strNode)\n     return false;\n }\n \n+bool CConnman::AddedNodesContain(const CAddress& addr) const\n+{\n+    AssertLockNotHeld(m_added_nodes_mutex);\n+    const std::string addr_str{addr.ToStringAddr()};\n+    const std::string addr_port_str{addr.ToStringAddrPort()};\n+    LOCK(m_added_nodes_mutex);\n+    return (m_added_node_params.size() < 24 // bound the query to a reasonable limit\n+            && std::any_of(m_added_node_params.cbegin(), m_added_node_params.cend(),\n+                           [&](const auto& p) { return p.m_added_node == addr_str || p.m_added_node == addr_port_str; }));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#discussion_r1397327937",
      "id" : 1397327937,
      "line" : 3476,
      "node_id" : "PRRC_kwDOABII585TSYhB",
      "original_commit_id" : "5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1",
      "original_line" : 3476,
      "original_position" : 30,
      "original_start_line" : 3474,
      "path" : "src/net.cpp",
      "position" : 30,
      "pull_request_review_id" : 1737017170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28895",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397327937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3474,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-17T13:40:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397327937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28895#discussion_r1397339786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28895"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397339786"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the number of added nodes is up to the user without a limit, though 8 at a time is the addnode connection limit.  We can change `m_added_node_params` to an unordered set later on as you suggested in #28248 to make the query constant-time on average and drop the size check.  Kept it simple here.",
      "commit_id" : "5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1",
      "created_at" : "2023-11-17T13:47:36Z",
      "diff_hunk" : "@@ -3454,6 +3465,17 @@ bool CConnman::RemoveAddedNode(const std::string& strNode)\n     return false;\n }\n \n+bool CConnman::AddedNodesContain(const CAddress& addr) const\n+{\n+    AssertLockNotHeld(m_added_nodes_mutex);\n+    const std::string addr_str{addr.ToStringAddr()};\n+    const std::string addr_port_str{addr.ToStringAddrPort()};\n+    LOCK(m_added_nodes_mutex);\n+    return (m_added_node_params.size() < 24 // bound the query to a reasonable limit\n+            && std::any_of(m_added_node_params.cbegin(), m_added_node_params.cend(),\n+                           [&](const auto& p) { return p.m_added_node == addr_str || p.m_added_node == addr_port_str; }));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#discussion_r1397339786",
      "id" : 1397339786,
      "in_reply_to_id" : 1397327937,
      "line" : 3476,
      "node_id" : "PRRC_kwDOABII585TSbaK",
      "original_commit_id" : "5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1",
      "original_line" : 3476,
      "original_position" : 30,
      "original_start_line" : 3474,
      "path" : "src/net.cpp",
      "position" : 30,
      "pull_request_review_id" : 1737035418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28895",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397339786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3474,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-17T14:13:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1397339786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 5e7cc4144bb09cfde48ba5bc055a2da3ca4252d1\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at" : "2023-11-17T16:36:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1816739193",
      "id" : 1816739193,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sST15",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1816739193/reactions"
      },
      "updated_at" : "2023-11-17T16:37:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1816739193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added the fix to #28872 for backporting.",
      "created_at" : "2023-11-22T11:57:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28895#issuecomment-1822635615",
      "id" : 1822635615,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28895",
      "node_id" : "IC_kwDOABII585sozZf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1822635615/reactions"
      },
      "updated_at" : "2023-11-22T11:57:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1822635615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
