[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28848).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/28848#pullrequestreview-1755747136) |\n| Stale ACK | [Sjors](https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1829871990), [darosior](https://github.com/bitcoin/bitcoin/pull/28848#pullrequestreview-1755470155) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27591](https://github.com/bitcoin/bitcoin/pull/27591) (rpc: distinguish between vsize and sigop-adjusted mempool vsize by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-11-10T21:10:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1806438844",
      "id" : 1806438844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585rrBG8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1806438844/reactions"
      },
      "updated_at" : "2023-11-29T16:39:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1806438844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1390186647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390186647"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe add an \"success\" field for the full package, for convenience? Otherwise the user has to iterate through all the results to find out whether everything got submitted (which is likely the most common result in practice?)",
      "commit_id" : "e77b702e3bba30032fc6c34fe251b8145fadf48b",
      "created_at" : "2023-11-11T09:25:34Z",
      "diff_hunk" : "@@ -841,14 +841,15 @@ static RPCHelpMan submitpackage()\n                     {RPCResult::Type::OBJ, \"wtxid\", \"transaction wtxid\", {\n                         {RPCResult::Type::STR_HEX, \"txid\", \"The transaction hash in hex\"},\n                         {RPCResult::Type::STR_HEX, \"other-wtxid\", /*optional=*/true, \"The wtxid of a different transaction with the same txid but different witness found in the mempool. This means the submitted transaction was ignored.\"},\n-                        {RPCResult::Type::NUM, \"vsize\", \"Virtual transaction size as defined in BIP 141.\"},\n-                        {RPCResult::Type::OBJ, \"fees\", \"Transaction fees\", {\n+                        {RPCResult::Type::NUM, \"vsize\", /*optional=*/true, \"Virtual transaction size as defined in BIP 141.\"},\n+                        {RPCResult::Type::OBJ, \"fees\", /*optional=*/true, \"Transaction fees\", {\n                             {RPCResult::Type::STR_AMOUNT, \"base\", \"transaction fee in \" + CURRENCY_UNIT},\n                             {RPCResult::Type::STR_AMOUNT, \"effective-feerate\", /*optional=*/true, \"if the transaction was not already in the mempool, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},\n                             {RPCResult::Type::ARR, \"effective-includes\", /*optional=*/true, \"if effective-feerate is provided, the wtxids of the transactions whose fees and vsizes are included in effective-feerate.\",\n                                 {{RPCResult::Type::STR_HEX, \"\", \"transaction wtxid in hex\"},\n                             }},\n                         }},\n+                        {RPCResult::Type::STR, \"error\", /*optional=*/true, \"The transaction error string, if it was rejected by the mempool\"},\n                     }}\n                 }},\n                 {RPCResult::Type::ARR, \"replaced-transactions\", /*optional=*/true, \"List of txids of replaced transactions\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1390186647",
      "id" : 1390186647,
      "line" : 855,
      "node_id" : "PRRC_kwDOABII585S3JCX",
      "original_commit_id" : "e77b702e3bba30032fc6c34fe251b8145fadf48b",
      "original_line" : 855,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 26,
      "pull_request_review_id" : 1726021692,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390186647/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-11T09:25:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1390186647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391258045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391258045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added a top-level \"package-msg\" response which is \"success\" when everything goes through.\r\n\r\nI also changed the logic to allow `PCKG_POLICY` to continue if there are transaction results, because this can happen if single transactions make it in, then a subsequent subpackage hits chain limits and is rejected.",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T15:17:40Z",
      "diff_hunk" : "@@ -841,14 +841,15 @@ static RPCHelpMan submitpackage()\n                     {RPCResult::Type::OBJ, \"wtxid\", \"transaction wtxid\", {\n                         {RPCResult::Type::STR_HEX, \"txid\", \"The transaction hash in hex\"},\n                         {RPCResult::Type::STR_HEX, \"other-wtxid\", /*optional=*/true, \"The wtxid of a different transaction with the same txid but different witness found in the mempool. This means the submitted transaction was ignored.\"},\n-                        {RPCResult::Type::NUM, \"vsize\", \"Virtual transaction size as defined in BIP 141.\"},\n-                        {RPCResult::Type::OBJ, \"fees\", \"Transaction fees\", {\n+                        {RPCResult::Type::NUM, \"vsize\", /*optional=*/true, \"Virtual transaction size as defined in BIP 141.\"},\n+                        {RPCResult::Type::OBJ, \"fees\", /*optional=*/true, \"Transaction fees\", {\n                             {RPCResult::Type::STR_AMOUNT, \"base\", \"transaction fee in \" + CURRENCY_UNIT},\n                             {RPCResult::Type::STR_AMOUNT, \"effective-feerate\", /*optional=*/true, \"if the transaction was not already in the mempool, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},\n                             {RPCResult::Type::ARR, \"effective-includes\", /*optional=*/true, \"if effective-feerate is provided, the wtxids of the transactions whose fees and vsizes are included in effective-feerate.\",\n                                 {{RPCResult::Type::STR_HEX, \"\", \"transaction wtxid in hex\"},\n                             }},\n                         }},\n+                        {RPCResult::Type::STR, \"error\", /*optional=*/true, \"The transaction error string, if it was rejected by the mempool\"},\n                     }}\n                 }},\n                 {RPCResult::Type::ARR, \"replaced-transactions\", /*optional=*/true, \"List of txids of replaced transactions\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391258045",
      "id" : 1391258045,
      "in_reply_to_id" : 1390186647,
      "line" : 856,
      "node_id" : "PRRC_kwDOABII585S7Om9",
      "original_commit_id" : "e77b702e3bba30032fc6c34fe251b8145fadf48b",
      "original_line" : 855,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 32,
      "pull_request_review_id" : 1727549452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391258045/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T15:17:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391258045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391258432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391258432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I will squash if/when we decide this is a good direction",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T15:17:57Z",
      "diff_hunk" : "@@ -841,14 +841,15 @@ static RPCHelpMan submitpackage()\n                     {RPCResult::Type::OBJ, \"wtxid\", \"transaction wtxid\", {\n                         {RPCResult::Type::STR_HEX, \"txid\", \"The transaction hash in hex\"},\n                         {RPCResult::Type::STR_HEX, \"other-wtxid\", /*optional=*/true, \"The wtxid of a different transaction with the same txid but different witness found in the mempool. This means the submitted transaction was ignored.\"},\n-                        {RPCResult::Type::NUM, \"vsize\", \"Virtual transaction size as defined in BIP 141.\"},\n-                        {RPCResult::Type::OBJ, \"fees\", \"Transaction fees\", {\n+                        {RPCResult::Type::NUM, \"vsize\", /*optional=*/true, \"Virtual transaction size as defined in BIP 141.\"},\n+                        {RPCResult::Type::OBJ, \"fees\", /*optional=*/true, \"Transaction fees\", {\n                             {RPCResult::Type::STR_AMOUNT, \"base\", \"transaction fee in \" + CURRENCY_UNIT},\n                             {RPCResult::Type::STR_AMOUNT, \"effective-feerate\", /*optional=*/true, \"if the transaction was not already in the mempool, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},\n                             {RPCResult::Type::ARR, \"effective-includes\", /*optional=*/true, \"if effective-feerate is provided, the wtxids of the transactions whose fees and vsizes are included in effective-feerate.\",\n                                 {{RPCResult::Type::STR_HEX, \"\", \"transaction wtxid in hex\"},\n                             }},\n                         }},\n+                        {RPCResult::Type::STR, \"error\", /*optional=*/true, \"The transaction error string, if it was rejected by the mempool\"},\n                     }}\n                 }},\n                 {RPCResult::Type::ARR, \"replaced-transactions\", /*optional=*/true, \"List of txids of replaced transactions\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391258432",
      "id" : 1391258432,
      "in_reply_to_id" : 1390186647,
      "line" : 856,
      "node_id" : "PRRC_kwDOABII585S7OtA",
      "original_commit_id" : "e77b702e3bba30032fc6c34fe251b8145fadf48b",
      "original_line" : 855,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 32,
      "pull_request_review_id" : 1727550117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391258432/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T15:17:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391258432",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391301747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391301747"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Makes sense to me. I'm in favor of returning all the information that we can to the user",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T15:49:44Z",
      "diff_hunk" : "@@ -841,14 +841,15 @@ static RPCHelpMan submitpackage()\n                     {RPCResult::Type::OBJ, \"wtxid\", \"transaction wtxid\", {\n                         {RPCResult::Type::STR_HEX, \"txid\", \"The transaction hash in hex\"},\n                         {RPCResult::Type::STR_HEX, \"other-wtxid\", /*optional=*/true, \"The wtxid of a different transaction with the same txid but different witness found in the mempool. This means the submitted transaction was ignored.\"},\n-                        {RPCResult::Type::NUM, \"vsize\", \"Virtual transaction size as defined in BIP 141.\"},\n-                        {RPCResult::Type::OBJ, \"fees\", \"Transaction fees\", {\n+                        {RPCResult::Type::NUM, \"vsize\", /*optional=*/true, \"Virtual transaction size as defined in BIP 141.\"},\n+                        {RPCResult::Type::OBJ, \"fees\", /*optional=*/true, \"Transaction fees\", {\n                             {RPCResult::Type::STR_AMOUNT, \"base\", \"transaction fee in \" + CURRENCY_UNIT},\n                             {RPCResult::Type::STR_AMOUNT, \"effective-feerate\", /*optional=*/true, \"if the transaction was not already in the mempool, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},\n                             {RPCResult::Type::ARR, \"effective-includes\", /*optional=*/true, \"if effective-feerate is provided, the wtxids of the transactions whose fees and vsizes are included in effective-feerate.\",\n                                 {{RPCResult::Type::STR_HEX, \"\", \"transaction wtxid in hex\"},\n                             }},\n                         }},\n+                        {RPCResult::Type::STR, \"error\", /*optional=*/true, \"The transaction error string, if it was rejected by the mempool\"},\n                     }}\n                 }},\n                 {RPCResult::Type::ARR, \"replaced-transactions\", /*optional=*/true, \"List of txids of replaced transactions\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391301747",
      "id" : 1391301747,
      "in_reply_to_id" : 1390186647,
      "line" : 856,
      "node_id" : "PRRC_kwDOABII585S7ZRz",
      "original_commit_id" : "e77b702e3bba30032fc6c34fe251b8145fadf48b",
      "original_line" : 855,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 32,
      "pull_request_review_id" : 1727618346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391301747/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T15:49:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391301747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391348626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391348626"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Comment says \"Everything in the package should be submitted\" but you're only checking that the results exist in `m_tx_results`. Do you want to check that `mempool.exists(wtxid)` as well?",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T16:23:10Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391348626",
      "id" : 1391348626,
      "line" : 900,
      "node_id" : "PRRC_kwDOABII585S7kuS",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 900,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 49,
      "pull_request_review_id" : 1727694604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391348626/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T16:39:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391348626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391354199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391354199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is using txid intentional here?\r\nIf you use txid, `BroadcastTransaction` will rebroadcast the mempool tx if the result was `DIFFERENT_WITNESS`.\r\nIf you use wtxid, we skip it.",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T16:27:25Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();\n+\n                     for (const auto& tx : txns) {\n                         auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n+                        if (it != package_result.m_tx_results.end()) {\n+                            if (it->second.m_state.IsInvalid()) {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), it->second.m_state.ToString()});\n+                            } else {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                            }\n+                        } else {\n+                            // No result returned; report this helpfully\n+                            wtixd_to_error_strings.insert({tx->GetWitnessHash(), \"unevaluated\"});\n                         }\n                     }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    break;\n                 }\n             }\n+\n             size_t num_broadcast{0};\n             for (const auto& tx : txns) {\n+                // We don't want to re-submit the txn for validation in BroadcastTransaction\n+                if (!mempool.exists(GenTxid::Txid(tx->GetHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391354199",
      "id" : 1391354199,
      "line" : 939,
      "node_id" : "PRRC_kwDOABII585S7mFX",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 939,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 93,
      "pull_request_review_id" : 1727694604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391354199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T16:39:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391354199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391359467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391359467"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"all transactions were submitted\" is not necessarily true anymore, no?",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T16:31:34Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();\n+\n                     for (const auto& tx : txns) {\n                         auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n+                        if (it != package_result.m_tx_results.end()) {\n+                            if (it->second.m_state.IsInvalid()) {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), it->second.m_state.ToString()});\n+                            } else {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                            }\n+                        } else {\n+                            // No result returned; report this helpfully\n+                            wtixd_to_error_strings.insert({tx->GetWitnessHash(), \"unevaluated\"});\n                         }\n                     }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    break;\n                 }\n             }\n+\n             size_t num_broadcast{0};\n             for (const auto& tx : txns) {\n+                // We don't want to re-submit the txn for validation in BroadcastTransaction\n+                if (!mempool.exists(GenTxid::Txid(tx->GetHash()))) {\n+                    continue;\n+                }\n+\n+                // We do not expect an error here; we are only broadcasting things already/still in mempool",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391359467",
      "id" : 1391359467,
      "line" : 943,
      "node_id" : "PRRC_kwDOABII585S7nXr",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 943,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 97,
      "pull_request_review_id" : 1727694604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391359467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T16:39:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391359467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391367243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391367243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "wtxid\r\n```suggestion\r\n            std::map<Wtxid, std::optional<std::string>> wtxid_to_error_strings;\r\n```",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T16:38:07Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391367243",
      "id" : 1391367243,
      "line" : 893,
      "node_id" : "PRRC_kwDOABII585S7pRL",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 893,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 38,
      "pull_request_review_id" : 1727694604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391367243/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T16:39:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391367243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391368212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391368212"
         }
      },
      "author_association" : "MEMBER",
      "body" : "also, why have this intermediate map? can't you do this in the loop at the end that populates `rpc_result`?",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T16:38:57Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391368212",
      "id" : 1391368212,
      "in_reply_to_id" : 1391367243,
      "line" : 893,
      "node_id" : "PRRC_kwDOABII585S7pgU",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 893,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 38,
      "pull_request_review_id" : 1727694604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391368212/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T16:39:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391368212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391386220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391386220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer using underscores https://github.com/bitcoin/bitcoin/pull/27501#discussion_r1184510850",
      "commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "created_at" : "2023-11-13T16:49:09Z",
      "diff_hunk" : "@@ -836,19 +836,21 @@ static RPCHelpMan submitpackage()\n         RPCResult{\n             RPCResult::Type::OBJ, \"\", \"\",\n             {\n+                {RPCResult::Type::STR, \"package-msg\", \"The transaction package result message. \\\"success\\\" indicates all transactions were accepted into or are already in the mempool.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391386220",
      "id" : 1391386220,
      "line" : 839,
      "node_id" : "PRRC_kwDOABII585S7t5s",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 839,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 13,
      "pull_request_review_id" : 1727753117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391386220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T16:49:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391386220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493778"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the check would be for `Txid` since different witness isn't considered a failure? added",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-13T18:11:29Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493778",
      "id" : 1391493778,
      "in_reply_to_id" : 1391348626,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585S8IKS",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 900,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1727929124,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493778/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T18:11:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "From my understanding: The current behavior in master is to re-broadcast anything in our mempool provided the txid matches something in the proposed package. If something in our mempool matches the `txid`, we (re)`BroadcastTransaction`. If it's not in our mempool, it means it was rejected, and we don't want to re-validate one by one.\r\n\r\nI think this is the behavior we want.",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-13T18:11:33Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();\n+\n                     for (const auto& tx : txns) {\n                         auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n+                        if (it != package_result.m_tx_results.end()) {\n+                            if (it->second.m_state.IsInvalid()) {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), it->second.m_state.ToString()});\n+                            } else {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                            }\n+                        } else {\n+                            // No result returned; report this helpfully\n+                            wtixd_to_error_strings.insert({tx->GetWitnessHash(), \"unevaluated\"});\n                         }\n                     }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    break;\n                 }\n             }\n+\n             size_t num_broadcast{0};\n             for (const auto& tx : txns) {\n+                // We don't want to re-submit the txn for validation in BroadcastTransaction\n+                if (!mempool.exists(GenTxid::Txid(tx->GetHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493855",
      "id" : 1391493855,
      "in_reply_to_id" : 1391354199,
      "line" : 924,
      "node_id" : "PRRC_kwDOABII585S8ILf",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 924,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 82,
      "pull_request_review_id" : 1727929209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493855/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T18:11:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493917"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-13T18:11:36Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();\n+\n                     for (const auto& tx : txns) {\n                         auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n+                        if (it != package_result.m_tx_results.end()) {\n+                            if (it->second.m_state.IsInvalid()) {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), it->second.m_state.ToString()});\n+                            } else {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                            }\n+                        } else {\n+                            // No result returned; report this helpfully\n+                            wtixd_to_error_strings.insert({tx->GetWitnessHash(), \"unevaluated\"});\n                         }\n                     }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    break;\n                 }\n             }\n+\n             size_t num_broadcast{0};\n             for (const auto& tx : txns) {\n+                // We don't want to re-submit the txn for validation in BroadcastTransaction\n+                if (!mempool.exists(GenTxid::Txid(tx->GetHash()))) {\n+                    continue;\n+                }\n+\n+                // We do not expect an error here; we are only broadcasting things already/still in mempool",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493917",
      "id" : 1391493917,
      "in_reply_to_id" : 1391359467,
      "line" : 928,
      "node_id" : "PRRC_kwDOABII585S8IMd",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 928,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 86,
      "pull_request_review_id" : 1727929303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493917/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T18:11:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed the cruft",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-13T18:11:42Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391493972",
      "id" : 1391493972,
      "in_reply_to_id" : 1391367243,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585S8INU",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 893,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1727929425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493972/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T18:11:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391493972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391494055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391494055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-13T18:11:48Z",
      "diff_hunk" : "@@ -836,19 +836,21 @@ static RPCHelpMan submitpackage()\n         RPCResult{\n             RPCResult::Type::OBJ, \"\", \"\",\n             {\n+                {RPCResult::Type::STR, \"package-msg\", \"The transaction package result message. \\\"success\\\" indicates all transactions were accepted into or are already in the mempool.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391494055",
      "id" : 1391494055,
      "in_reply_to_id" : 1391386220,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585S8IOn",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 839,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1727929580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391494055/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T18:11:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391494055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391519236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391519236"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah makes sense",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-13T18:34:47Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1391519236",
      "id" : 1391519236,
      "in_reply_to_id" : 1391348626,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585S8OYE",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 900,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1727969241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391519236/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-13T18:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1391519236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403265805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a -> any ?",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-23T11:42:54Z",
      "diff_hunk" : "@@ -822,7 +822,7 @@ static RPCHelpMan submitpackage()\n     return RPCHelpMan{\"submitpackage\",\n         \"Submit a package of raw transactions (serialized, hex-encoded) to local node.\\n\"\n         \"The package must consist of a child with its parents, and none of the parents may depend on one another.\\n\"\n-        \"The package will be validated according to consensus and mempool policy rules. If all transactions pass, they will be accepted to mempool.\\n\"\n+        \"The package will be validated according to consensus and mempool policy rules. If a transaction passes, it will be accepted to mempool.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403265805",
      "id" : 1403265805,
      "line" : 825,
      "node_id" : "PRRC_kwDOABII585TpCMN",
      "original_commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "original_line" : 825,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 5,
      "pull_request_review_id" : 1746269146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265805/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T12:26:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403265805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403273829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403273829"
         }
      },
      "author_association" : "MEMBER",
      "body" : "consist of parents followed by exactly one child,",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-23T11:49:59Z",
      "diff_hunk" : "@@ -822,7 +822,7 @@ static RPCHelpMan submitpackage()\n     return RPCHelpMan{\"submitpackage\",\n         \"Submit a package of raw transactions (serialized, hex-encoded) to local node.\\n\"\n         \"The package must consist of a child with its parents, and none of the parents may depend on one another.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403273829",
      "id" : 1403273829,
      "line" : 824,
      "node_id" : "PRRC_kwDOABII585TpEJl",
      "original_commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "original_line" : 824,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 3,
      "pull_request_review_id" : 1746269146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403273829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T12:26:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403273829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403281170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403281170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe add: \"A transaction that's already in the mempool is [ignored, rebroadcast?].\"",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-23T11:52:15Z",
      "diff_hunk" : "@@ -822,7 +822,7 @@ static RPCHelpMan submitpackage()\n     return RPCHelpMan{\"submitpackage\",\n         \"Submit a package of raw transactions (serialized, hex-encoded) to local node.\\n\"\n         \"The package must consist of a child with its parents, and none of the parents may depend on one another.\\n\"\n-        \"The package will be validated according to consensus and mempool policy rules. If all transactions pass, they will be accepted to mempool.\\n\"\n+        \"The package will be validated according to consensus and mempool policy rules. If a transaction passes, it will be accepted to mempool.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403281170",
      "id" : 1403281170,
      "in_reply_to_id" : 1403265805,
      "line" : 825,
      "node_id" : "PRRC_kwDOABII585TpF8S",
      "original_commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "original_line" : 825,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 5,
      "pull_request_review_id" : 1746269146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403281170/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T12:26:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403281170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors I think you can set `-minrelaytxfee=0` to work around it?",
      "created_at" : "2023-11-23T14:19:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1824515731",
      "id" : 1824515731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585sv-aT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1824515731/reactions"
      },
      "updated_at" : "2023-11-23T14:19:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1824515731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @Sjors I think you can set `-minrelaytxfee=0` to work around it?\r\n\r\nThat doesn't simulate a full mempool though.\r\n\r\nI wrote a commit that lets my example go through: https://github.com/Sjors/bitcoin/commit/03baacd7643daf3d1c8efbc1a723719d8cc72dce\r\n\r\nHowever, not sure if it's worth the extra complexity.",
      "created_at" : "2023-11-23T14:56:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1824570747",
      "id" : 1824570747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585swL17",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1824570747/reactions"
      },
      "updated_at" : "2023-11-23T14:56:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1824570747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403506481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403506481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you still want to check \"mempool full\" like below?",
      "commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "created_at" : "2023-11-23T15:10:51Z",
      "diff_hunk" : "@@ -205,7 +206,7 @@ def test_mid_package_eviction(self):\n \n         # Package should be submitted, temporarily exceeding maxmempool, and then evicted.\n         with node.assert_debug_log(expected_msgs=[\"rolling minimum fee bumped\"]):\n-            assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, package_hex)\n+            node.submitpackage(package_hex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1403506481",
      "id" : 1403506481,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585Tp88x",
      "original_commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 17,
      "pull_request_review_id" : 1746652527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403506481/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-23T15:21:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1403506481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406419723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406419723"
         }
      },
      "author_association" : "MEMBER",
      "body" : "the check itself is a little weird, so I just double-checked that the package failed. The later checks should check invariants.",
      "commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "created_at" : "2023-11-27T16:21:19Z",
      "diff_hunk" : "@@ -205,7 +206,7 @@ def test_mid_package_eviction(self):\n \n         # Package should be submitted, temporarily exceeding maxmempool, and then evicted.\n         with node.assert_debug_log(expected_msgs=[\"rolling minimum fee bumped\"]):\n-            assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, package_hex)\n+            node.submitpackage(package_hex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406419723",
      "id" : 1406419723,
      "in_reply_to_id" : 1403506481,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T1EML",
      "original_commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 1750846633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406419723/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-27T16:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406419723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406419792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406419792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "leaving un-touched, I think current text is correct",
      "commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "created_at" : "2023-11-27T16:21:22Z",
      "diff_hunk" : "@@ -822,7 +822,7 @@ static RPCHelpMan submitpackage()\n     return RPCHelpMan{\"submitpackage\",\n         \"Submit a package of raw transactions (serialized, hex-encoded) to local node.\\n\"\n         \"The package must consist of a child with its parents, and none of the parents may depend on one another.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406419792",
      "id" : 1406419792,
      "in_reply_to_id" : 1403273829,
      "line" : 824,
      "node_id" : "PRRC_kwDOABII585T1ENQ",
      "original_commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "original_line" : 824,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 3,
      "pull_request_review_id" : 1750846734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406419792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-27T16:21:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406419792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406420001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406420001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> a -> any ?\r\n\r\ntaken\r\n\r\n> Maybe add: \"A transaction that's already in the mempool is [ignored, rebroadcast?].\"\r\n\r\nDo we want to promise that? I'm ambivalent for now.",
      "commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "created_at" : "2023-11-27T16:21:31Z",
      "diff_hunk" : "@@ -822,7 +822,7 @@ static RPCHelpMan submitpackage()\n     return RPCHelpMan{\"submitpackage\",\n         \"Submit a package of raw transactions (serialized, hex-encoded) to local node.\\n\"\n         \"The package must consist of a child with its parents, and none of the parents may depend on one another.\\n\"\n-        \"The package will be validated according to consensus and mempool policy rules. If all transactions pass, they will be accepted to mempool.\\n\"\n+        \"The package will be validated according to consensus and mempool policy rules. If a transaction passes, it will be accepted to mempool.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406420001",
      "id" : 1406420001,
      "in_reply_to_id" : 1403265805,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T1EQh",
      "original_commit_id" : "d72aab3dbd8847e851f8b724b195181e30e7bf02",
      "original_line" : 825,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1750847040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406420001/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-27T16:21:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406420001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Also why is tx-results not an array like the input? (also to make it easier to sanity check that I didn't submit them the wrong way around)\r\n\r\nIf they're submitted \"backwards\" they'll be rejected.\r\n\r\n> (I can see how, for a script that submits transaction packages, this dictionary makes it easier to get feedback for specific transactions. For manual submission and debugging it's easier to keep the same ordering, but this may not be a common use case.)\r\n\r\nRight, I think this is 99%+ of the use-cases. \"typical\" usage of manual transaction creation should generate transactions with sufficient fees for an attempt at inclusion in a block.\r\n\r\n",
      "created_at" : "2023-11-27T16:21:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1828167337",
      "id" : 1828167337,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585s956p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1828167337/reactions"
      },
      "updated_at" : "2023-11-27T16:21:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1828167337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406474920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406474920"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah true, agree",
      "commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "created_at" : "2023-11-27T17:01:04Z",
      "diff_hunk" : "@@ -888,34 +890,57 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::map<Wtxid, std::optional<std::string>> wtixd_to_error_strings;\n+            std::string package_msg = \"success\";\n+\n+            // First catch any errors and capture useful error strings.\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Everything in the package should be submitted\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();\n+\n                     for (const auto& tx : txns) {\n                         auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n+                        if (it != package_result.m_tx_results.end()) {\n+                            if (it->second.m_state.IsInvalid()) {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), it->second.m_state.ToString()});\n+                            } else {\n+                                wtixd_to_error_strings.insert({tx->GetWitnessHash(), std::nullopt});\n+                            }\n+                        } else {\n+                            // No result returned; report this helpfully\n+                            wtixd_to_error_strings.insert({tx->GetWitnessHash(), \"unevaluated\"});\n                         }\n                     }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    break;\n                 }\n             }\n+\n             size_t num_broadcast{0};\n             for (const auto& tx : txns) {\n+                // We don't want to re-submit the txn for validation in BroadcastTransaction\n+                if (!mempool.exists(GenTxid::Txid(tx->GetHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1406474920",
      "id" : 1406474920,
      "in_reply_to_id" : 1391354199,
      "line" : 924,
      "node_id" : "PRRC_kwDOABII585T1Rqo",
      "original_commit_id" : "ddd9224f09fc136544713701a4552f217b1c53c6",
      "original_line" : 924,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 82,
      "pull_request_review_id" : 1750934108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406474920/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-27T17:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1406474920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "all feedback is resolved",
      "created_at" : "2023-11-27T17:09:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1828269809",
      "id" : 1828269809,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585s-S7x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1828269809/reactions"
      },
      "updated_at" : "2023-11-27T17:09:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1828269809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "created_at" : "2023-11-28T13:42:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1829871990",
      "id" : 1829871990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585tEaF2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1829871990/reactions"
      },
      "updated_at" : "2023-11-28T13:42:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1829871990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1408916906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408916906"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Side note: should it be a chain of 3 transactions?",
      "commit_id" : "24c345f89ecad54223e42f8cf084ef3c5ed5f0c0",
      "created_at" : "2023-11-29T08:26:10Z",
      "diff_hunk" : "@@ -334,8 +335,10 @@ def test_submitpackage(self):\n \n         self.log.info(\"Submitpackage only allows packages of 1 child with its parents\")\n         # Chain of 3 transactions has too many generations\n+        legacy_pool = node.getrawmempool()\n         chain_hex = [t[\"hex\"] for t in self.wallet.create_self_transfer_chain(chain_length=25)]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1408916906",
      "id" : 1408916906,
      "line" : 339,
      "node_id" : "PRRC_kwDOABII585T-l2q",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 339,
      "original_position" : 13,
      "original_start_line" : 337,
      "path" : "test/functional/rpc_packages.py",
      "position" : 13,
      "pull_request_review_id" : 1754689444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408916906/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 337,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1408916906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 4fb3340a1ac678165e6821645e6aa1e06f34921a\r\n\r\nI considered suggesting to backport this at first, in light of https://github.com/bitcoin/bitcoin/pull/27609. But i don't think the fix for relaying the parent transaction if the child fails validation matters much for this usecase (mining pool calling `submitpackage`). At least, not enough to warrant a backport this late i'd say.",
      "created_at" : "2023-11-29T12:28:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1831803835",
      "id" : 1831803835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585tLxu7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1831803835/reactions"
      },
      "updated_at" : "2023-11-29T12:28:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1831803835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@darosior thanks, took the test with minor modifications to not do hex-surgery :)",
      "created_at" : "2023-11-29T14:51:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1832044241",
      "id" : 1832044241,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585tMsbR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832044241/reactions"
      },
      "updated_at" : "2023-11-29T14:51:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832044241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409403335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409403335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it means \"at least 3\", but you're right this is probably too permissive a check. Not touching for now but can if people want me to.",
      "commit_id" : "24c345f89ecad54223e42f8cf084ef3c5ed5f0c0",
      "created_at" : "2023-11-29T14:52:55Z",
      "diff_hunk" : "@@ -334,8 +335,10 @@ def test_submitpackage(self):\n \n         self.log.info(\"Submitpackage only allows packages of 1 child with its parents\")\n         # Chain of 3 transactions has too many generations\n+        legacy_pool = node.getrawmempool()\n         chain_hex = [t[\"hex\"] for t in self.wallet.create_self_transfer_chain(chain_length=25)]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409403335",
      "id" : 1409403335,
      "in_reply_to_id" : 1408916906,
      "line" : 339,
      "node_id" : "PRRC_kwDOABII585UAcnH",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 339,
      "original_position" : 13,
      "original_start_line" : 337,
      "path" : "test/functional/rpc_packages.py",
      "position" : 13,
      "pull_request_review_id" : 1755467396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409403335/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 337,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-29T14:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409403335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409411317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409411317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not changed here but I think the doc should actually say sigop-adjusted virtual size, no?",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T14:58:04Z",
      "diff_hunk" : "@@ -836,19 +836,21 @@ static RPCHelpMan submitpackage()\n         RPCResult{\n             RPCResult::Type::OBJ, \"\", \"\",\n             {\n+                {RPCResult::Type::STR, \"package_msg\", \"The transaction package result message. \\\"success\\\" indicates all transactions were accepted into or are already in the mempool.\"},\n                 {RPCResult::Type::OBJ_DYN, \"tx-results\", \"transaction results keyed by wtxid\",\n                 {\n                     {RPCResult::Type::OBJ, \"wtxid\", \"transaction wtxid\", {\n                         {RPCResult::Type::STR_HEX, \"txid\", \"The transaction hash in hex\"},\n                         {RPCResult::Type::STR_HEX, \"other-wtxid\", /*optional=*/true, \"The wtxid of a different transaction with the same txid but different witness found in the mempool. This means the submitted transaction was ignored.\"},\n-                        {RPCResult::Type::NUM, \"vsize\", \"Virtual transaction size as defined in BIP 141.\"},\n-                        {RPCResult::Type::OBJ, \"fees\", \"Transaction fees\", {\n+                        {RPCResult::Type::NUM, \"vsize\", /*optional=*/true, \"Virtual transaction size as defined in BIP 141.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409411317",
      "id" : 1409411317,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UAej1",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 845,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1755479871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409411317/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409411317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409418202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409418202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit/followup: This could instead be a compile-time check if the if/else blocks are converted to a switch statement on result type",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T15:02:41Z",
      "diff_hunk" : "@@ -959,6 +977,8 @@ static RPCHelpMan submitpackage()\n                             replaced_txids.insert(ptx->GetHash());\n                         }\n                     }\n+                } else {\n+                    NONFATAL_UNREACHABLE();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409418202",
      "id" : 1409418202,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UAgPa",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 981,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1755479871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409418202/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409418202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409423479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409423479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Are we trying to assert that this is true? Pretty sure this just keeps going if the expression is False\r\n```suggestion\r\n            assert_equal(res[\"tx-results\"][wtxid][\"error\"], \"mempool full\")\r\n```",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T15:06:16Z",
      "diff_hunk" : "@@ -366,7 +370,9 @@ def run_test(self):\n         assert_greater_than(worst_feerate_btcvb, (parent_fee + child_fee) / (tx_parent_just_below[\"tx\"].get_vsize() + tx_child_just_above[\"tx\"].get_vsize()))\n         assert_greater_than(mempoolmin_feerate, (parent_fee) / (tx_parent_just_below[\"tx\"].get_vsize()))\n         assert_greater_than((parent_fee + child_fee) / (tx_parent_just_below[\"tx\"].get_vsize() + tx_child_just_above[\"tx\"].get_vsize()), mempoolmin_feerate / 1000)\n-        assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, [tx_parent_just_below[\"hex\"], tx_child_just_above[\"hex\"]])\n+        res = node.submitpackage([tx_parent_just_below[\"hex\"], tx_child_just_above[\"hex\"]])\n+        for wtxid in [tx_parent_just_below[\"wtxid\"], tx_child_just_above[\"wtxid\"]]:\n+            res[\"tx-results\"][wtxid][\"error\"] == \"mempool full\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409423479",
      "id" : 1409423479,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UAhh3",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 375,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 1755479871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409423479/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409423479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409433097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409433097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: can also `CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());` here",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T15:12:46Z",
      "diff_hunk" : "@@ -888,56 +890,72 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::string package_msg = \"success\";\n+\n+            // First catch package-wide errors, continue if we can\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Belt-and-suspenders check; everything should be successful here\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        CHECK_NONFATAL(mempool.exists(GenTxid::Txid(tx->GetHash())));\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n-                    for (const auto& tx : txns) {\n-                        auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n-                        }\n-                    }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409433097",
      "id" : 1409433097,
      "line" : 916,
      "node_id" : "PRRC_kwDOABII585UAj4J",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 916,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 74,
      "pull_request_review_id" : 1755479871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409433097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409433097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409441852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409441852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can't you just do `sec_wtxid = bad_child.getwtxid()`?",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T15:18:37Z",
      "diff_hunk" : "@@ -340,6 +340,21 @@ def test_submitpackage(self):\n         assert_raises_rpc_error(-25, \"package topology disallowed\", node.submitpackage, chain_hex)\n         assert_equal(legacy_pool, node.getrawmempool())\n \n+        # Create a transaction chain such as only the parent gets accepted (by making the child's\n+        # version non-standard). Make sure the parent does get broadcast.\n+        self.log.info(\"If a package is partially submitted, transactions included in mempool get broadcast\")\n+        peer = node.add_p2p_connection(P2PTxInvStore())\n+        txs = self.wallet.create_self_transfer_chain(chain_length=2)\n+        bad_child = tx_from_hex(txs[1][\"hex\"])\n+        bad_child.nVersion = -1\n+        hex_partial_acceptance = [txs[0][\"hex\"], bad_child.serialize().hex()]\n+        res = node.submitpackage(hex_partial_acceptance)\n+        assert_equal(res[\"package_msg\"], \"transaction failed\")\n+        first_wtxid = txs[0][\"tx\"].getwtxid()\n+        assert \"error\" not in res[\"tx-results\"][first_wtxid]\n+        sec_wtxid = next(wtxid for wtxid in res[\"tx-results\"] if wtxid != first_wtxid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409441852",
      "id" : 1409441852,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UAmA8",
      "original_commit_id" : "24c345f89ecad54223e42f8cf084ef3c5ed5f0c0",
      "original_line" : 355,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 1755479871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409441852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409441852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409446795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409446795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This check is useless? It exits if untrue right before",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T15:21:57Z",
      "diff_hunk" : "@@ -888,56 +890,72 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::string package_msg = \"success\";\n+\n+            // First catch package-wide errors, continue if we can\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Belt-and-suspenders check; everything should be successful here\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        CHECK_NONFATAL(mempool.exists(GenTxid::Txid(tx->GetHash())));\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n-                    for (const auto& tx : txns) {\n-                        auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n-                        }\n-                    }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();\n+                    break;\n                 }\n             }\n+\n             size_t num_broadcast{0};\n             for (const auto& tx : txns) {\n+                // We don't want to re-submit the txn for validation in BroadcastTransaction\n+                if (!mempool.exists(GenTxid::Txid(tx->GetHash()))) {\n+                    continue;\n+                }\n+\n+                // We do not expect an error here; we are only broadcasting things already/still in mempool\n                 std::string err_string;\n                 const auto err = BroadcastTransaction(node, tx, err_string, /*max_tx_fee=*/0, /*relay=*/true, /*wait_callback=*/true);\n                 if (err != TransactionError::OK) {\n                     throw JSONRPCTransactionError(err,\n-                        strprintf(\"transaction broadcast failed: %s (all transactions were submitted, %d transactions were broadcast successfully)\",\n+                        strprintf(\"transaction broadcast failed: %s (%d transactions were broadcast successfully)\",\n                             err_string, num_broadcast));\n                 }\n                 num_broadcast++;\n             }\n+\n             UniValue rpc_result{UniValue::VOBJ};\n+            rpc_result.pushKV(\"package_msg\", package_msg);\n             UniValue tx_result_map{UniValue::VOBJ};\n             std::set<uint256> replaced_txids;\n             for (const auto& tx : txns) {\n-                auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                CHECK_NONFATAL(it != package_result.m_tx_results.end());\n                 UniValue result_inner{UniValue::VOBJ};\n                 result_inner.pushKV(\"txid\", tx->GetHash().GetHex());\n+                auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n+                if (it == package_result.m_tx_results.end()) {\n+                    // No results, report error and continue\n+                    result_inner.pushKV(\"error\", \"unevaluated\");\n+                    continue;\n+                }\n+                CHECK_NONFATAL(it != package_result.m_tx_results.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409446795",
      "id" : 1409446795,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UAnOL",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 952,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1755479871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409446795/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409446795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409447663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409447663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "would be nice to fix, maybe in a followup",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T15:22:34Z",
      "diff_hunk" : "@@ -334,8 +335,10 @@ def test_submitpackage(self):\n \n         self.log.info(\"Submitpackage only allows packages of 1 child with its parents\")\n         # Chain of 3 transactions has too many generations\n+        legacy_pool = node.getrawmempool()\n         chain_hex = [t[\"hex\"] for t in self.wallet.create_self_transfer_chain(chain_length=25)]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409447663",
      "id" : 1409447663,
      "in_reply_to_id" : 1408916906,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UAnbv",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 339,
      "original_position" : 13,
      "original_start_line" : 337,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 1755479871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409447663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-11-29T15:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409447663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T16:32:03Z",
      "diff_hunk" : "@@ -888,56 +890,72 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::string package_msg = \"success\";\n+\n+            // First catch package-wide errors, continue if we can\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Belt-and-suspenders check; everything should be successful here\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        CHECK_NONFATAL(mempool.exists(GenTxid::Txid(tx->GetHash())));\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n-                    for (const auto& tx : txns) {\n-                        auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n-                        }\n-                    }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();\n+                    break;\n                 }\n             }\n+\n             size_t num_broadcast{0};\n             for (const auto& tx : txns) {\n+                // We don't want to re-submit the txn for validation in BroadcastTransaction\n+                if (!mempool.exists(GenTxid::Txid(tx->GetHash()))) {\n+                    continue;\n+                }\n+\n+                // We do not expect an error here; we are only broadcasting things already/still in mempool\n                 std::string err_string;\n                 const auto err = BroadcastTransaction(node, tx, err_string, /*max_tx_fee=*/0, /*relay=*/true, /*wait_callback=*/true);\n                 if (err != TransactionError::OK) {\n                     throw JSONRPCTransactionError(err,\n-                        strprintf(\"transaction broadcast failed: %s (all transactions were submitted, %d transactions were broadcast successfully)\",\n+                        strprintf(\"transaction broadcast failed: %s (%d transactions were broadcast successfully)\",\n                             err_string, num_broadcast));\n                 }\n                 num_broadcast++;\n             }\n+\n             UniValue rpc_result{UniValue::VOBJ};\n+            rpc_result.pushKV(\"package_msg\", package_msg);\n             UniValue tx_result_map{UniValue::VOBJ};\n             std::set<uint256> replaced_txids;\n             for (const auto& tx : txns) {\n-                auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                CHECK_NONFATAL(it != package_result.m_tx_results.end());\n                 UniValue result_inner{UniValue::VOBJ};\n                 result_inner.pushKV(\"txid\", tx->GetHash().GetHex());\n+                auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n+                if (it == package_result.m_tx_results.end()) {\n+                    // No results, report error and continue\n+                    result_inner.pushKV(\"error\", \"unevaluated\");\n+                    continue;\n+                }\n+                CHECK_NONFATAL(it != package_result.m_tx_results.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562473",
      "id" : 1409562473,
      "in_reply_to_id" : 1409446795,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UBDdp",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 952,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1755724040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562473/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T16:32:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562542"
         }
      },
      "author_association" : "MEMBER",
      "body" : "taken",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T16:32:06Z",
      "diff_hunk" : "@@ -340,6 +340,21 @@ def test_submitpackage(self):\n         assert_raises_rpc_error(-25, \"package topology disallowed\", node.submitpackage, chain_hex)\n         assert_equal(legacy_pool, node.getrawmempool())\n \n+        # Create a transaction chain such as only the parent gets accepted (by making the child's\n+        # version non-standard). Make sure the parent does get broadcast.\n+        self.log.info(\"If a package is partially submitted, transactions included in mempool get broadcast\")\n+        peer = node.add_p2p_connection(P2PTxInvStore())\n+        txs = self.wallet.create_self_transfer_chain(chain_length=2)\n+        bad_child = tx_from_hex(txs[1][\"hex\"])\n+        bad_child.nVersion = -1\n+        hex_partial_acceptance = [txs[0][\"hex\"], bad_child.serialize().hex()]\n+        res = node.submitpackage(hex_partial_acceptance)\n+        assert_equal(res[\"package_msg\"], \"transaction failed\")\n+        first_wtxid = txs[0][\"tx\"].getwtxid()\n+        assert \"error\" not in res[\"tx-results\"][first_wtxid]\n+        sec_wtxid = next(wtxid for wtxid in res[\"tx-results\"] if wtxid != first_wtxid)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562542",
      "id" : 1409562542,
      "in_reply_to_id" : 1409441852,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UBDeu",
      "original_commit_id" : "24c345f89ecad54223e42f8cf084ef3c5ed5f0c0",
      "original_line" : 355,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 1755724121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562542/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T16:32:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562596"
         }
      },
      "author_association" : "MEMBER",
      "body" : "taken",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T16:32:09Z",
      "diff_hunk" : "@@ -888,56 +890,72 @@ static RPCHelpMan submitpackage()\n             Chainstate& chainstate = EnsureChainman(node).ActiveChainstate();\n             const auto package_result = WITH_LOCK(::cs_main, return ProcessNewPackage(chainstate, mempool, txns, /*test_accept=*/ false));\n \n-            // First catch any errors.\n+            std::string package_msg = \"success\";\n+\n+            // First catch package-wide errors, continue if we can\n             switch(package_result.m_state.GetResult()) {\n-                case PackageValidationResult::PCKG_RESULT_UNSET: break;\n-                case PackageValidationResult::PCKG_POLICY:\n+                case PackageValidationResult::PCKG_RESULT_UNSET:\n                 {\n-                    throw JSONRPCTransactionError(TransactionError::INVALID_PACKAGE,\n-                        package_result.m_state.GetRejectReason());\n+                    // Belt-and-suspenders check; everything should be successful here\n+                    CHECK_NONFATAL(package_result.m_tx_results.size() == txns.size());\n+                    for (const auto& tx : txns) {\n+                        CHECK_NONFATAL(mempool.exists(GenTxid::Txid(tx->GetHash())));\n+                    }\n+                    break;\n                 }\n                 case PackageValidationResult::PCKG_MEMPOOL_ERROR:\n                 {\n+                    // This only happens with internal bug; user should stop and report\n                     throw JSONRPCTransactionError(TransactionError::MEMPOOL_ERROR,\n                         package_result.m_state.GetRejectReason());\n                 }\n+                case PackageValidationResult::PCKG_POLICY:\n                 case PackageValidationResult::PCKG_TX:\n                 {\n-                    for (const auto& tx : txns) {\n-                        auto it = package_result.m_tx_results.find(tx->GetWitnessHash());\n-                        if (it != package_result.m_tx_results.end() && it->second.m_state.IsInvalid()) {\n-                            throw JSONRPCTransactionError(TransactionError::MEMPOOL_REJECTED,\n-                                strprintf(\"%s failed: %s\", tx->GetHash().ToString(), it->second.m_state.GetRejectReason()));\n-                        }\n-                    }\n-                    // If a PCKG_TX error was returned, there must have been an invalid transaction.\n-                    NONFATAL_UNREACHABLE();\n+                    // Package-wide error we want to return, but we also want to return individual responses\n+                    package_msg = package_result.m_state.GetRejectReason();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562596",
      "id" : 1409562596,
      "in_reply_to_id" : 1409433097,
      "line" : 916,
      "node_id" : "PRRC_kwDOABII585UBDfk",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 916,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 74,
      "pull_request_review_id" : 1755724224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562596/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T16:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops, taken",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T16:32:11Z",
      "diff_hunk" : "@@ -366,7 +370,9 @@ def run_test(self):\n         assert_greater_than(worst_feerate_btcvb, (parent_fee + child_fee) / (tx_parent_just_below[\"tx\"].get_vsize() + tx_child_just_above[\"tx\"].get_vsize()))\n         assert_greater_than(mempoolmin_feerate, (parent_fee) / (tx_parent_just_below[\"tx\"].get_vsize()))\n         assert_greater_than((parent_fee + child_fee) / (tx_parent_just_below[\"tx\"].get_vsize() + tx_child_just_above[\"tx\"].get_vsize()), mempoolmin_feerate / 1000)\n-        assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, [tx_parent_just_below[\"hex\"], tx_child_just_above[\"hex\"]])\n+        res = node.submitpackage([tx_parent_just_below[\"hex\"], tx_child_just_above[\"hex\"]])\n+        for wtxid in [tx_parent_just_below[\"wtxid\"], tx_child_just_above[\"wtxid\"]]:\n+            res[\"tx-results\"][wtxid][\"error\"] == \"mempool full\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562654",
      "id" : 1409562654,
      "in_reply_to_id" : 1409423479,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UBDge",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 375,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : null,
      "pull_request_review_id" : 1755724312,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T16:32:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562763"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T16:32:15Z",
      "diff_hunk" : "@@ -959,6 +977,8 @@ static RPCHelpMan submitpackage()\n                             replaced_txids.insert(ptx->GetHash());\n                         }\n                     }\n+                } else {\n+                    NONFATAL_UNREACHABLE();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562763",
      "id" : 1409562763,
      "in_reply_to_id" : 1409418202,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UBDiL",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 981,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1755724467,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562763/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T16:32:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562825"
         }
      },
      "author_association" : "MEMBER",
      "body" : "pushed a fixup commit on top",
      "commit_id" : "24953124a6ca70322c56f40ac090af174a3f4553",
      "created_at" : "2023-11-29T16:32:18Z",
      "diff_hunk" : "@@ -836,19 +836,21 @@ static RPCHelpMan submitpackage()\n         RPCResult{\n             RPCResult::Type::OBJ, \"\", \"\",\n             {\n+                {RPCResult::Type::STR, \"package_msg\", \"The transaction package result message. \\\"success\\\" indicates all transactions were accepted into or are already in the mempool.\"},\n                 {RPCResult::Type::OBJ_DYN, \"tx-results\", \"transaction results keyed by wtxid\",\n                 {\n                     {RPCResult::Type::OBJ, \"wtxid\", \"transaction wtxid\", {\n                         {RPCResult::Type::STR_HEX, \"txid\", \"The transaction hash in hex\"},\n                         {RPCResult::Type::STR_HEX, \"other-wtxid\", /*optional=*/true, \"The wtxid of a different transaction with the same txid but different witness found in the mempool. This means the submitted transaction was ignored.\"},\n-                        {RPCResult::Type::NUM, \"vsize\", \"Virtual transaction size as defined in BIP 141.\"},\n-                        {RPCResult::Type::OBJ, \"fees\", \"Transaction fees\", {\n+                        {RPCResult::Type::NUM, \"vsize\", /*optional=*/true, \"Virtual transaction size as defined in BIP 141.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#discussion_r1409562825",
      "id" : 1409562825,
      "in_reply_to_id" : 1409411317,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UBDjJ",
      "original_commit_id" : "4fb3340a1ac678165e6821645e6aa1e06f34921a",
      "original_line" : 845,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : null,
      "pull_request_review_id" : 1755724558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28848",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562825/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T16:32:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409562825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> would be nice to fix, maybe in a followup\r\n\r\ntook the liberty of doing now @glozow ",
      "created_at" : "2023-11-29T16:32:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28848#issuecomment-1832283142",
      "id" : 1832283142,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28848",
      "node_id" : "IC_kwDOABII585tNmwG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832283142/reactions"
      },
      "updated_at" : "2023-11-29T16:32:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832283142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
