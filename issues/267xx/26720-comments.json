[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Stale ACK | [Xekyo](https://github.com/bitcoin/bitcoin/pull/26720#pullrequestreview-1296272642) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26715](https://github.com/bitcoin/bitcoin/pull/26715) (Introduce `MockableDatabase` for wallet unit tests by achow101)\n* [#25982](https://github.com/bitcoin/bitcoin/pull/25982) (wallet: Guard against undefined behaviour by yancyribbens)\n* [#25806](https://github.com/bitcoin/bitcoin/pull/25806) (wallet: group outputs only once, decouple it from Coin Selection by furszy)\n* [#23475](https://github.com/bitcoin/bitcoin/pull/23475) (wallet: add config to prioritize a solution that doesn't create change in coin selection by brunoerg)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-12-18T14:02:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#issuecomment-1356805855",
      "id" : 1356805855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26720",
      "node_id" : "IC_kwDOABII585Q3zbf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1356805855/reactions"
      },
      "updated_at" : "2023-02-20T20:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1356805855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-01-04T00:26:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#issuecomment-1370359536",
      "id" : 1370359536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26720",
      "node_id" : "IC_kwDOABII585Rrgbw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1370359536/reactions"
      },
      "updated_at" : "2023-01-04T00:26:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1370359536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067478225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067478225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure I get how that else branch is reached. Is `util::Error()` falsy?",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-11T21:34:01Z",
      "diff_hunk" : "@@ -544,27 +544,36 @@ util::Result<SelectionResult> ChooseSelectionResult(const CWallet& wallet, const\n {\n     // Vector of results. We will choose the best one based on waste.\n     std::vector<SelectionResult> results;\n+    std::vector<util::Result<SelectionResult>> errors;\n+    auto append_error = [&] (const util::Result<SelectionResult>& result) {\n+        // If any specific error message appears here, then something different from a simple \"no selection found\" happened.\n+        // Let's save it, so it can be retrieved to the user if no other selection algorithm succeeded.\n+        if (HasErrorMsg(result)) {\n+            errors.emplace_back(result);\n+        }\n+    };\n \n     std::vector<OutputGroup> positive_groups = GroupOutputs(wallet, available_coins, coin_selection_params, eligibility_filter, /*positive_only=*/true);\n     if (auto bnb_result{SelectCoinsBnB(positive_groups, nTargetValue, coin_selection_params.m_cost_of_change)}) {\n         results.push_back(*bnb_result);\n-    }\n+    } else append_error(bnb_result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067478225",
      "id" : 1067478225,
      "line" : 562,
      "node_id" : "PRRC_kwDOABII584_oGzR",
      "original_commit_id" : "56f0c212d245c3a65e57891cf8f4a2c26aa05ef0",
      "original_line" : 559,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 17,
      "pull_request_review_id" : 1244644716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067478225/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T22:10:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067478225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067487616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067487616"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this introduces a low chance failure of the test. The feerate is 0 which means that input sets with multiple inputs have a better waste score than one with only one input. It seems to me that all coin selection algorithms are being run, so if SRD finds a solution with 675 or fewer inputs, it should get preferred. While I agree that SRD should be improved in that we should curb excessive input sets like this, I think the test was correct previously and is incorrect now.",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-11T21:45:32Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067487616",
      "id" : 1067487616,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584_oJGA",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1244644716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067487616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-11T22:10:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067487616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067491914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067491914"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A better way to improve SRD would perhaps be to keep all the selected inputs in a min-effective-value heap, and to kick out the least valuable inputs while the selected weight exceeds max_weight during selection.",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-11T21:51:31Z",
      "diff_hunk" : "@@ -188,9 +189,16 @@ util::Result<SelectionResult> SelectCoinsSRD(const std::vector<OutputGroup>& utx\n     Shuffle(indexes.begin(), indexes.end(), rng);\n \n     CAmount selected_eff_value = 0;\n+    int weight = 0;\n     for (const size_t i : indexes) {\n         const OutputGroup& group = utxo_pool.at(i);\n         Assume(group.GetSelectionAmount() > 0);\n+\n+        // If the selection weight exceeds the maximum allowed size, the random selection failed.\n+        weight += group.m_weight;\n+        if (weight > max_weight) return ErrorMaxWeightExceeded();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067491914",
      "id" : 1067491914,
      "line" : 210,
      "node_id" : "PRRC_kwDOABII584_oKJK",
      "original_commit_id" : "d1f67afc60962c59ff1873a2e3915d4f00b46e61",
      "original_line" : 199,
      "original_position" : 21,
      "original_start_line" : 198,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 21,
      "pull_request_review_id" : 1244644716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067491914/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 209,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-11T22:10:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067491914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067501918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067501918"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We should not continue searching a subtree when the selection already exceeds the `max_weight`. Instead of only checking it when we have selected sufficient funds, I would add `curr_selection_weight > max_weight` as a backtrack reason before `else if (curr_value >= selection_target)`:\r\n\r\n        if (curr_value + curr_available_value < selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.\r\n            curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\r\n            (curr_waste > best_waste && is_feerate_high)) { // Don't select things which we know will be more wasteful if the waste is increasing\r\n            backtrack = true;\r\n        } else if (curr_selection_weight > max_weight) { // Exceeding weight for standard tx, cannot find more solutions by adding more inputs\r\n            max_tx_size_exceeded = true; // at least one selection attempt exceeded the max weight\r\n            backtrack = true;\r\n        } else if (curr_value >= selection_target) {       // Selected value is within range\r\n",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-11T22:05:23Z",
      "diff_hunk" : "@@ -105,8 +115,14 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n             // value. Adding any more UTXOs will be just burning the UTXO; it will go entirely to fees. Thus we aren't going to\n             // explore any more UTXOs to avoid burning money like that.\n             if (curr_waste <= best_waste) {\n-                best_selection = curr_selection;\n-                best_waste = curr_waste;\n+                // Don't add the selection if the max weight was exceeded\n+                if (curr_selection_weight > max_weight) {\n+                    max_tx_size_exceeded = true; // at least one result exceeds the max weight\n+                } else {\n+                    // Set best selection\n+                    best_selection = curr_selection;\n+                    best_waste = curr_waste;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067501918",
      "id" : 1067501918,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII584_oMle",
      "original_commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "original_line" : 125,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 59,
      "pull_request_review_id" : 1244644716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067501918/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T22:10:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067501918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067557383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067557383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah. Internally the result class contains a variant and the bool operator returns true/false depending on what the variant is holding.\r\n\r\nsmall extra note: this will look much better after #25806.",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-11T23:22:06Z",
      "diff_hunk" : "@@ -544,27 +544,36 @@ util::Result<SelectionResult> ChooseSelectionResult(const CWallet& wallet, const\n {\n     // Vector of results. We will choose the best one based on waste.\n     std::vector<SelectionResult> results;\n+    std::vector<util::Result<SelectionResult>> errors;\n+    auto append_error = [&] (const util::Result<SelectionResult>& result) {\n+        // If any specific error message appears here, then something different from a simple \"no selection found\" happened.\n+        // Let's save it, so it can be retrieved to the user if no other selection algorithm succeeded.\n+        if (HasErrorMsg(result)) {\n+            errors.emplace_back(result);\n+        }\n+    };\n \n     std::vector<OutputGroup> positive_groups = GroupOutputs(wallet, available_coins, coin_selection_params, eligibility_filter, /*positive_only=*/true);\n     if (auto bnb_result{SelectCoinsBnB(positive_groups, nTargetValue, coin_selection_params.m_cost_of_change)}) {\n         results.push_back(*bnb_result);\n-    }\n+    } else append_error(bnb_result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067557383",
      "id" : 1067557383,
      "in_reply_to_id" : 1067478225,
      "line" : 562,
      "node_id" : "PRRC_kwDOABII584_oaIH",
      "original_commit_id" : "56f0c212d245c3a65e57891cf8f4a2c26aa05ef0",
      "original_line" : 559,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 17,
      "pull_request_review_id" : 1244760755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067557383/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T23:23:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067557383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067634860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067634860"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah cool, thanks for explaining",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T02:09:36Z",
      "diff_hunk" : "@@ -544,27 +544,36 @@ util::Result<SelectionResult> ChooseSelectionResult(const CWallet& wallet, const\n {\n     // Vector of results. We will choose the best one based on waste.\n     std::vector<SelectionResult> results;\n+    std::vector<util::Result<SelectionResult>> errors;\n+    auto append_error = [&] (const util::Result<SelectionResult>& result) {\n+        // If any specific error message appears here, then something different from a simple \"no selection found\" happened.\n+        // Let's save it, so it can be retrieved to the user if no other selection algorithm succeeded.\n+        if (HasErrorMsg(result)) {\n+            errors.emplace_back(result);\n+        }\n+    };\n \n     std::vector<OutputGroup> positive_groups = GroupOutputs(wallet, available_coins, coin_selection_params, eligibility_filter, /*positive_only=*/true);\n     if (auto bnb_result{SelectCoinsBnB(positive_groups, nTargetValue, coin_selection_params.m_cost_of_change)}) {\n         results.push_back(*bnb_result);\n-    }\n+    } else append_error(bnb_result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1067634860",
      "id" : 1067634860,
      "in_reply_to_id" : 1067478225,
      "line" : 562,
      "node_id" : "PRRC_kwDOABII584_otCs",
      "original_commit_id" : "56f0c212d245c3a65e57891cf8f4a2c26aa05ef0",
      "original_line" : 559,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 17,
      "pull_request_review_id" : 1244865844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067634860/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-12T02:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1067634860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068141350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068141350"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hmm that doesn't sound right.\r\n\r\nAs we set all feerates to 0, the change cost will be 0. So the waste calculation is simply a `waste = inputs total amount - target`.\r\nSo we actually will never select the SRD result, because SRD is forced to select the 50 btc UTXO to succeed (otherwise it surpasses the max allowed weight).\r\n\r\nIn other words, Knapsacks result always return a waste of 0.5 btc, while SRD will return a waste of 0.5 btc + every extra added input that appears on the shuffled vector prior reaching the 50 btc UTXO.\r\nSo, knapsacks_waste <= srd_waste.",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T13:47:45Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068141350",
      "id" : 1068141350,
      "in_reply_to_id" : 1067487616,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584_qosm",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1245631990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068141350/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-12T13:48:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068141350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068149810"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068149810"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah better ðð¼ , thanks",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T13:55:19Z",
      "diff_hunk" : "@@ -105,8 +115,14 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n             // value. Adding any more UTXOs will be just burning the UTXO; it will go entirely to fees. Thus we aren't going to\n             // explore any more UTXOs to avoid burning money like that.\n             if (curr_waste <= best_waste) {\n-                best_selection = curr_selection;\n-                best_waste = curr_waste;\n+                // Don't add the selection if the max weight was exceeded\n+                if (curr_selection_weight > max_weight) {\n+                    max_tx_size_exceeded = true; // at least one result exceeds the max weight\n+                } else {\n+                    // Set best selection\n+                    best_selection = curr_selection;\n+                    best_waste = curr_waste;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068149810",
      "id" : 1068149810,
      "in_reply_to_id" : 1067501918,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII584_qqwy",
      "original_commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "original_line" : 125,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 59,
      "pull_request_review_id" : 1245645503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068149810/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-12T13:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068149810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068168923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068168923"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, the [waste](https://murch.one/posts/waste-metric/) is calculated via `wasteâ¯=â¯weight_of_inputsâ¯Ãâ¯(feerateâ¯-â¯long_term_feerate_estimate)` where the LTFRE is 10â¯á¹©/vB. This means that at a feerate of 0â¯á¹©/vB, an input set with greater weight results in a lower (âmore negativeâ) waste. I.e. if the SRD solution happens to roll an input set with 500â¯small inputs plus the 50â¯â¿ input it would fit in the standard transaction weight and have a better score than the input set with only the 50â¯â¿ input.",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T14:10:30Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068168923",
      "id" : 1068168923,
      "in_reply_to_id" : 1067487616,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584_qvbb",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1245676778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068168923/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-12T14:10:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068168923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068213896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068213896"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> the [waste](https://murch.one/posts/waste-metric/) is calculated via wasteâ¯=â¯weight_of_inputsâ¯Ãâ¯(feerateâ¯-â¯long_term_feerate_estimate) where the LTFRE is 10â¯á¹©/vB.\r\n\r\nWhere is the LTFRE set to 10á¹©/vB?\r\n\r\nI'm seeing that it's set to 0:\r\nhttps://github.com/bitcoin/bitcoin/blob/edc3d1b296e34838d649dc21b8483a52e214932a/src/wallet/test/coinselector_tests.cpp#L971-L972\r\n\r\nSo inside `GetSelectionWaste` the loop over all the inputs should be returning waste = 0 (`wasteâ¯=â¯weight_of_inputsâ¯Ãâ¯(feerateâ¯- long_term_feerate_estimate)` --> `waste = â¯weight_of_inputs * 0`). \r\n\r\nThen below, as `change_cost` is 0 too, we get into:\r\nhttps://github.com/bitcoin/bitcoin/blob/edc3d1b296e34838d649dc21b8483a52e214932a/src/wallet/coinselection.cpp#L396-L400",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T14:47:54Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068213896",
      "id" : 1068213896,
      "in_reply_to_id" : 1067487616,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584_q6aI",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1245746093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068213896/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-12T14:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068213896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068271600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068271600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "loved it, awesome idea :D",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T15:32:51Z",
      "diff_hunk" : "@@ -188,9 +189,16 @@ util::Result<SelectionResult> SelectCoinsSRD(const std::vector<OutputGroup>& utx\n     Shuffle(indexes.begin(), indexes.end(), rng);\n \n     CAmount selected_eff_value = 0;\n+    int weight = 0;\n     for (const size_t i : indexes) {\n         const OutputGroup& group = utxo_pool.at(i);\n         Assume(group.GetSelectionAmount() > 0);\n+\n+        // If the selection weight exceeds the maximum allowed size, the random selection failed.\n+        weight += group.m_weight;\n+        if (weight > max_weight) return ErrorMaxWeightExceeded();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068271600",
      "id" : 1068271600,
      "in_reply_to_id" : 1067491914,
      "line" : 210,
      "node_id" : "PRRC_kwDOABII584_rIfw",
      "original_commit_id" : "d1f67afc60962c59ff1873a2e3915d4f00b46e61",
      "original_line" : 199,
      "original_position" : 21,
      "original_start_line" : 198,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 21,
      "pull_request_review_id" : 1245841488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068271600/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 209,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-12T15:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068271600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068361521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068361521"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, my bad. I did not expect anyone to change LTFRE in tests. :face_with_spiral_eyes:\r\nIn that case, the weight of the inputs is irrelevant for the waste score (because `weightâ¯Ã (0â¯- 0) = 0`), and it will prefer an input set with change over one without change (unless excess is also 0). So very likely, the outcome of this test depends on either SRD being unsuccessful and/or that the order in which results are evaluated in `ChooseSelectionResult(â¦)` prefers the Knapsack result. I don't think that's is a good idea.\r\n\r\nSince we are explicitly testing the behavior of Knapsack, this should be a test that just runs Knapsack and checks that the Knapsack behavior is expected.\r\n\r\nAlso pondering whether it's necessary that the LTFRE setting is amended for this testâI totally did not expect that, and it may also change the expected outcome of other tests. Thanks for pointing that out.",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T16:48:41Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068361521",
      "id" : 1068361521,
      "in_reply_to_id" : 1067487616,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584_recx",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1246008553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068361521/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-12T16:52:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068361521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068463836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068463836"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Having thought some more about this, setting LTFRE and cost_of_change to 0 basically turns off BnB. It will then only generate solutions that match the target to the satoshi. Definitely feels off that behavior of coin selection algorithms is so fundamentally changed in `coinselector_tests.cpp`. :thinking: ",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T18:14:35Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068463836",
      "id" : 1068463836,
      "in_reply_to_id" : 1067487616,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584_r3bc",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1246209757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068463836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-12T18:14:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068463836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068562529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068562529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> In that case, the weight of the inputs is irrelevant for the waste score (because weightâ¯Ã (0â¯- 0) = 0), and it will prefer an input set with change over one without change (unless excess is also 0). So very likely, the outcome of this test depends on either SRD being unsuccessful and/or that the order in which results are evaluated in ChooseSelectionResult(â¦) prefers the Knapsack result.\r\n\r\nActually, the result does not depend on the order in which the algorithms are executed. SRD always success and has a higher waste than snapsack (only could fail if after shuffling the vector, the big UTXO is located at last, so fail is due an exceeded max weight):\r\n\r\nThe feerates are 0, same as the change cost, so the waste calculation is just a simple: \r\n```c++\r\nwaste = selected_effective_value - target;\r\n```\r\n\r\nSo, Snapsack result only contains the 50 BTC UTXO (waste = 0,5 btc).\r\nAnd, SRD result has the 50 BTC UTXO + all the other small UTXOs that appear in the shuffled vector prior to the big UTXO (waste = 0,5 btc + all smaller UTXOs).\r\n\r\nEssentially, the best selection that SRD could make is when the big UTXO appears first after shuffling the coins vector, which is equal to the only solution that snapsack returns. All the other solutions that SRD could return have a higher waste than snapsack.\r\n\r\n> Since we are explicitly testing the behavior of Knapsack, this should be a test that just runs Knapsack and checks that the Knapsack behavior is expected.\r\n\r\nMake a specific test for this sounds good too. But I still think that would be nice to make tests that use the entire coin selection process and check that the expected result is returned (not only checking that any valid result is retrieved): check the inputs size, the value of them, the algorithm used etc.\r\n\r\n> Having thought some more about this, setting LTFRE and cost_of_change to 0 basically turns off BnB. It will then only generate solutions that match the target to the satoshi. Definitely feels off that behavior of coin selection algorithms is so fundamentally changed in coinselector_tests.cpp. ð¤\r\n\r\nSo we have a new working path hehe (probably more suited for a follow-up PR): validate BnB further by reviewing all the test running the entire coin selection process with the feerates and change_cost in 0.\r\nPlus, would be nice to code new tests running coin selection and expecting the best result to be retrieved by BnB.",
      "commit_id" : "4c249f83f436dac93a78e61495bc523e6ba3685e",
      "created_at" : "2023-01-12T19:40:07Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068562529",
      "id" : 1068562529,
      "in_reply_to_id" : 1067487616,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584_sPhh",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 23,
      "pull_request_review_id" : 1246369117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068562529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-12T20:13:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068562529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068644215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068644215"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you may be referring to the description before BnB, which only describes the case for changeless input sets.\r\n\r\nIf you check `GetSelectionWaste(â¦)`, you'll see that the formula is `wasteâ¯=â¯input_weightâ¯Ãâ¯(feerateâ¯-â¯LTFRE) +â¯excessâ¯+ cost_of_change`. `excess` is the amount of sats dropped to the fees because we overshot the selection target but do not have enough for a change output. It can only be non-zero in changeless solutions. `cost_of_change` is set to zero in changeless solutions, since we do not create change. So, the score will only ever include a non-zero value for one of `excess` or `cost_of_change`. Since both SRD and Knapsack create change, both add `cost_of_change` which is zero here. Since `LTFRE == feerate`, the input weight also gets multiplied with 0. So any input set for both these algorithms will always have a waste score of 0.\r\n\r\nWhich is to say, if either of these coin selection results under the above circumstances reports a waste score that is non-zero, I would suspect you have found a bug.",
      "commit_id" : "962b7d800a3da461be450551ef96b53d870ac925",
      "created_at" : "2023-01-12T20:54:31Z",
      "diff_hunk" : "@@ -997,7 +1005,10 @@ BOOST_AUTO_TEST_CASE(check_max_weight)\n             chain, m_args);\n \n         BOOST_CHECK(result);\n-        BOOST_CHECK(has_coin(result->GetInputSet(), CAmount(50 * COIN)));\n+        // Verify that only the 50 BTC UTXO was selected\n+        const auto& selection_res = result->GetInputSet();\n+        BOOST_CHECK(selection_res.size() == 1);\n+        BOOST_CHECK(selection_res.begin()->GetEffectiveValue() == 50 * COIN);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1068644215",
      "id" : 1068644215,
      "in_reply_to_id" : 1067487616,
      "line" : 1111,
      "node_id" : "PRRC_kwDOABII584_sjd3",
      "original_commit_id" : "595cbc02f4b95502d46dacc0258fa31f033fb09b",
      "original_line" : 1011,
      "original_position" : 23,
      "original_start_line" : 1000,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 130,
      "pull_request_review_id" : 1246461886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068644215/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1000,
      "start_side" : "LEFT",
      "updated_at" : "2023-01-12T21:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1068644215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1069823539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1069823539"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Cool, thanks for putting the heap in already. I think it'll be simpler if you first add the new group to the heap and then use the heap to decide whether the new or old group should be popped to get below weight:\r\n\r\n```suggestion\r\n          \r\n        // Add group to selection\r\n        heap.push(group);\r\n        selected_eff_value += group.GetSelectionAmount();\r\n        weight += group.m_weight;\r\n        \r\n        // If the selection weight exceeds the maximum allowed size, remove the least valuable inputs until we\r\n        // are below max weight.\r\n        if (weight > max_weight) { \r\n            max_tx_size_exceeded = true; // mark it in case we don't find any useful result.\r\n\r\n            do {\r\n                const OutputGroup& to_remove_group = heap.top();\r\n                selected_eff_value -= to_remove_group.GetSelectionAmount();\r\n                weight -= to_remove_group.m_weight;\r\n                heap.pop();\r\n            } while (!heap.empty() && weight > max_weight);\r\n        }\r\n```\r\n\r\n",
      "commit_id" : "962b7d800a3da461be450551ef96b53d870ac925",
      "created_at" : "2023-01-13T18:25:36Z",
      "diff_hunk" : "@@ -188,16 +200,51 @@ util::Result<SelectionResult> SelectCoinsSRD(const std::vector<OutputGroup>& utx\n     Shuffle(indexes.begin(), indexes.end(), rng);\n \n     CAmount selected_eff_value = 0;\n+    int weight = 0;\n+    bool max_tx_size_exceeded = false;\n     for (const size_t i : indexes) {\n         const OutputGroup& group = utxo_pool.at(i);\n         Assume(group.GetSelectionAmount() > 0);\n+\n+        // If the selection weight exceeds the maximum allowed size, remove the least valuable inputs until we\n+        // can insert the new group (while the sum of them are less than the new group amount).\n+        weight += group.m_weight;\n+        if (weight > max_weight) {\n+            max_tx_size_exceeded = true; // mark it in case we don't find any useful result.\n+\n+            // if the least valuable input is greater, discard the new group.\n+            CAmount new_group_amount = group.GetSelectionAmount();\n+            if (new_group_amount <= heap.top().GetSelectionAmount()) {\n+                weight -= group.m_weight;\n+                continue;\n+            }\n+\n+            // Keep popping up inputs while we exceed the max weight and the\n+            // arriving 'group' amount is less than the removed inputs.\n+            CAmount least_valuable_amounts = 0;\n+            do {\n+                const OutputGroup& to_remove_group = heap.top();\n+                CAmount min_group_amount = to_remove_group.GetSelectionAmount();\n+                least_valuable_amounts += min_group_amount;\n+                selected_eff_value -= min_group_amount;\n+                weight -= to_remove_group.m_weight;\n+                heap.pop();\n+            } while (!heap.empty() && least_valuable_amounts < new_group_amount && weight > max_weight);\n+        }\n+\n+        // Add group to selection\n         selected_eff_value += group.GetSelectionAmount();\n-        result.AddInput(group);\n+        heap.push(group);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1069823539",
      "id" : 1069823539,
      "line" : 245,
      "node_id" : "PRRC_kwDOABII584_xDYz",
      "original_commit_id" : "42afb84687cded411de725587a08f4d4dc471f0e",
      "original_line" : 237,
      "original_position" : 69,
      "original_start_line" : 208,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 69,
      "pull_request_review_id" : 1248239807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1069823539/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 216,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-13T18:42:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1069823539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1070092884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1070092884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice ðð¼, applied changes and added your co-authorship. Thanks :).",
      "commit_id" : "f0add1d0a7507e5601d7da54f62fe9ab272b3281",
      "created_at" : "2023-01-13T21:38:38Z",
      "diff_hunk" : "@@ -188,16 +200,51 @@ util::Result<SelectionResult> SelectCoinsSRD(const std::vector<OutputGroup>& utx\n     Shuffle(indexes.begin(), indexes.end(), rng);\n \n     CAmount selected_eff_value = 0;\n+    int weight = 0;\n+    bool max_tx_size_exceeded = false;\n     for (const size_t i : indexes) {\n         const OutputGroup& group = utxo_pool.at(i);\n         Assume(group.GetSelectionAmount() > 0);\n+\n+        // If the selection weight exceeds the maximum allowed size, remove the least valuable inputs until we\n+        // can insert the new group (while the sum of them are less than the new group amount).\n+        weight += group.m_weight;\n+        if (weight > max_weight) {\n+            max_tx_size_exceeded = true; // mark it in case we don't find any useful result.\n+\n+            // if the least valuable input is greater, discard the new group.\n+            CAmount new_group_amount = group.GetSelectionAmount();\n+            if (new_group_amount <= heap.top().GetSelectionAmount()) {\n+                weight -= group.m_weight;\n+                continue;\n+            }\n+\n+            // Keep popping up inputs while we exceed the max weight and the\n+            // arriving 'group' amount is less than the removed inputs.\n+            CAmount least_valuable_amounts = 0;\n+            do {\n+                const OutputGroup& to_remove_group = heap.top();\n+                CAmount min_group_amount = to_remove_group.GetSelectionAmount();\n+                least_valuable_amounts += min_group_amount;\n+                selected_eff_value -= min_group_amount;\n+                weight -= to_remove_group.m_weight;\n+                heap.pop();\n+            } while (!heap.empty() && least_valuable_amounts < new_group_amount && weight > max_weight);\n+        }\n+\n+        // Add group to selection\n         selected_eff_value += group.GetSelectionAmount();\n-        result.AddInput(group);\n+        heap.push(group);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1070092884",
      "id" : 1070092884,
      "in_reply_to_id" : 1069823539,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_yFJU",
      "original_commit_id" : "42afb84687cded411de725587a08f4d4dc471f0e",
      "original_line" : 237,
      "original_position" : 69,
      "original_start_line" : 208,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1248564358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1070092884/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-13T21:38:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1070092884",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated with two points:\r\n\r\n1) Added coverage for bnb max weight exceeded https://github.com/bitcoin/bitcoin/pull/26720/commits/41fb2c4dd8a15dc0c59ca4d5d0befab707ca8954.\r\n\r\n2) Cleaned further the coin selection test f0add1d (noticed by @aureleoules inside [#25806](https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1081460601))",
      "created_at" : "2023-01-20T01:58:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#issuecomment-1397832543",
      "id" : 1397832543,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26720",
      "node_id" : "IC_kwDOABII585TUTtf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1397832543/reactions"
      },
      "updated_at" : "2023-01-20T01:58:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1397832543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103268851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103268851"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: whitespace",
      "commit_id" : "f0add1d0a7507e5601d7da54f62fe9ab272b3281",
      "created_at" : "2023-02-10T21:31:11Z",
      "diff_hunk" : "@@ -384,9 +384,12 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n  *\n  * @param[in]  utxo_pool    The positive effective value OutputGroups eligible for selection\n  * @param[in]  target_value The target value to select for\n+ * @param[in]  rng The randomness source to shuffle coins\n+ * @param[in] max_weight The maximum allowed weight for a selection result to be valid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103268851",
      "id" : 1103268851,
      "line" : 389,
      "node_id" : "PRRC_kwDOABII585Bwovz",
      "original_commit_id" : "c723827ac21e265c9bdbb3e4aa2f8ba79ac48a97",
      "original_line" : 388,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : 5,
      "pull_request_review_id" : 1294015946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103268851/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-10T22:15:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103268851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103289270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103289270"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        CAmount target = 25.33L * COIN;\r\n        int max_weight = 10000; // WU\r\n        const auto& res = SelectCoinsSRD(target, cs_params, m_node.chain.get(), m_args, max_weight, [&](CWallet& wallet) {\r\n            CoinsResult available_coins;\r\n            for (int j = 0; j < 60; ++j) { // 60 UTXO --> 19,8 BTC total --> 60 Ã 272â¯WU = 16320 WU\r\n                add_coin(available_coins, wallet, CAmount(0.33 * COIN), CFeeRate(0), 144, false, 0, true);\r\n            }\r\n            for (int i = 0; i < 10; i++) { // 10 UTXO --> 20 BTC total --> 10 Ã 272 WU = 2720 WU\r\n                add_coin(available_coins, wallet, CAmount(2 * COIN), CFeeRate(0), 144, false, 0, true);\r\n            }\r\n```\r\n\r\nI was reconstructing what sort of input set this test will find. From what I gather, we can have up to 36 inputs, and weâll need 9 of the 2â¯â¿ UTXOs to hit the target amount. However, I was confused that the limit is 10'000â¯and labeled âweightâ, while the inputs are appraised at â272â¯kvbâ. It would work out, though if the `max_weight` were interpreted as 10'000â¯WU, and the inputs are 272â¯WU each (i.e. 68â¯vB). Are we looking at P2WPKH inputs here?",
      "commit_id" : "f0add1d0a7507e5601d7da54f62fe9ab272b3281",
      "created_at" : "2023-02-10T21:50:12Z",
      "diff_hunk" : "@@ -940,6 +940,100 @@ BOOST_AUTO_TEST_CASE(effective_value_test)\n     BOOST_CHECK_EQUAL(output5.GetEffectiveValue(), nValue); // The effective value should be equal to the absolute value if input_bytes is -1\n }\n \n+\n+static util::Result<SelectionResult> SelectCoinsSRD(const CAmount& target,\n+                                                    const CoinSelectionParams& cs_params,\n+                                                    interfaces::Chain* chain, const ArgsManager& args,\n+                                                    int max_weight,\n+                                                    std::function<CoinsResult(CWallet&)> coin_setup)\n+{\n+    std::unique_ptr<CWallet> wallet = std::make_unique<CWallet>(chain, \"\", args, CreateMockWalletDatabase());\n+    wallet->LoadWallet();\n+    LOCK(wallet->cs_wallet);\n+    wallet->SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+    wallet->SetupDescriptorScriptPubKeyMans();\n+\n+    CoinEligibilityFilter filter(0, 0, 0);\n+    const std::vector<OutputGroup>& group = GroupOutputs(*wallet, coin_setup(*wallet).All(), cs_params, filter, true);\n+    return SelectCoinsSRD(group, target, cs_params.rng_fast, max_weight);\n+}\n+\n+BOOST_AUTO_TEST_CASE(srd_tests)\n+{\n+    // Test SRD:\n+    // 1) Insufficient funds, select all provided coins and fail.\n+    // 2) Exceeded max weight, coin selection always surpasses the max allowed weight.\n+    // 3) Select coins without surpassing the max weight (some coins surpasses the max allowed weight, some others not)\n+\n+    FastRandomContext rand;\n+    CoinSelectionParams cs_params{\n+            rand,\n+            /*change_output_size=*/34,\n+            /*change_spend_size=*/68,\n+            /*min_change_target=*/CENT,\n+            /*effective_feerate=*/CFeeRate(0),\n+            /*long_term_feerate=*/CFeeRate(0),\n+            /*discard_feerate=*/CFeeRate(0),\n+            /*tx_noinputs_size=*/10 + 34, // static header size + output size\n+            /*avoid_partial=*/false,\n+    };\n+\n+    {\n+        // #########################################################\n+        // 1) Insufficient funds, select all provided coins and fail\n+        // #########################################################\n+        CAmount target = 49.5L * COIN;\n+        int max_weight = 10000; // high enough to not fail for this reason.\n+        const auto& res = SelectCoinsSRD(target, cs_params, m_node.chain.get(), m_args, max_weight, [&](CWallet& wallet) {\n+            CoinsResult available_coins;\n+            for (int j = 0; j < 10; ++j) {\n+                add_coin(available_coins, wallet, CAmount(1 * COIN));\n+                add_coin(available_coins, wallet, CAmount(2 * COIN));\n+            }\n+            return available_coins;\n+        });\n+        BOOST_CHECK(!res);\n+        BOOST_CHECK(util::ErrorString(res).empty()); // empty means \"insufficient funds\"\n+    }\n+\n+    {\n+        // ###########################\n+        // 2) Test max weight exceeded\n+        // ###########################\n+        CAmount target = 49.5L * COIN;\n+        int max_weight = 3000;\n+        const auto& res = SelectCoinsSRD(target, cs_params, m_node.chain.get(), m_args, max_weight, [&](CWallet& wallet) {\n+            CoinsResult available_coins;\n+            for (int j = 0; j < 10; ++j) {\n+                add_coin(available_coins, wallet, CAmount(1 * COIN), CFeeRate(0), 144, false, 0, true);\n+                add_coin(available_coins, wallet, CAmount(2 * COIN), CFeeRate(0), 144, false, 0, true);\n+            }\n+            return available_coins;\n+        });\n+        BOOST_CHECK(!res);\n+        BOOST_CHECK(util::ErrorString(res).original.find(\"The inputs size exceeds the maximum weight\") != std::string::npos);\n+    }\n+\n+    {\n+        // ################################################################################################################\n+        // 3) Test selection when some coins surpass the max allowed weight while others not. --> must find a good solution\n+        // ################################################################################################################\n+        CAmount target = 25.33L * COIN;\n+        int max_weight = 10000;\n+        const auto& res = SelectCoinsSRD(target, cs_params, m_node.chain.get(), m_args, max_weight, [&](CWallet& wallet) {\n+            CoinsResult available_coins;\n+            for (int j = 0; j < 60; ++j) { // 60 UTXO --> 19,8 BTC total --> weight 272 * 60 = 16320 kvb\n+                add_coin(available_coins, wallet, CAmount(0.33 * COIN), CFeeRate(0), 144, false, 0, true);\n+            }\n+            for (int i = 0; i < 10; i++) { // 10 UTXO --> 20 BTC total --> weight 272 * 10 = 2720 kvb\n+                add_coin(available_coins, wallet, CAmount(2 * COIN), CFeeRate(0), 144, false, 0, true);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103289270",
      "id" : 1103289270,
      "line" : 1053,
      "node_id" : "PRRC_kwDOABII585Bwtu2",
      "original_commit_id" : "bcb6f22130bdca73b2a084963a574960ac163bce",
      "original_line" : 1030,
      "original_position" : 91,
      "original_start_line" : 1021,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 91,
      "pull_request_review_id" : 1294015946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103289270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-02-10T22:15:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103289270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103290900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103290900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: [weight != size](https://bitcoin.stackexchange.com/a/84006/5406)\r\n\r\n```suggestion\r\n    bool max_tx_weight_exceeded = false;\r\n```",
      "commit_id" : "f0add1d0a7507e5601d7da54f62fe9ab272b3281",
      "created_at" : "2023-02-10T21:52:43Z",
      "diff_hunk" : "@@ -97,6 +99,7 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n     CAmount best_waste = MAX_MONEY;\n \n     bool is_feerate_high = utxo_pool.at(0).fee > utxo_pool.at(0).long_term_fee;\n+    bool max_tx_size_exceeded = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103290900",
      "id" : 1103290900,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII585BwuIU",
      "original_commit_id" : "2c9b9507c9b15e47c22d7255763d71d21a91bae7",
      "original_line" : 102,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 19,
      "pull_request_review_id" : 1294015946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103290900/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-10T22:15:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103290900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103291613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103291613"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n            max_tx_weight_exceeded = true; // at least one selection attempt exceeded the max weight\r\n```",
      "commit_id" : "f0add1d0a7507e5601d7da54f62fe9ab272b3281",
      "created_at" : "2023-02-10T21:53:56Z",
      "diff_hunk" : "@@ -106,6 +109,9 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n             (curr_waste > best_waste && is_feerate_high)) { // Don't select things which we know will be more wasteful if the waste is increasing\n             backtrack = true;\n+        } else if (curr_selection_weight > max_weight) { // Exceeding weight for standard tx, cannot find more solutions by adding more inputs\n+            max_tx_size_exceeded = true; // at least one selection attempt exceeded the max weight",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103291613",
      "id" : 1103291613,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII585BwuTd",
      "original_commit_id" : "2c9b9507c9b15e47c22d7255763d71d21a91bae7",
      "original_line" : 113,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 28,
      "pull_request_review_id" : 1294015946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103291613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-10T22:15:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103291613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103292025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103292025"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        return max_tx_weight_exceeded ? ErrorMaxWeightExceeded() : util::Error();\r\n```",
      "commit_id" : "f0add1d0a7507e5601d7da54f62fe9ab272b3281",
      "created_at" : "2023-02-10T21:54:34Z",
      "diff_hunk" : "@@ -154,13 +161,14 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n                 curr_selection.push_back(utxo_pool_index);\n                 curr_value += utxo.GetSelectionAmount();\n                 curr_waste += utxo.fee - utxo.long_term_fee;\n+                curr_selection_weight += utxo.m_weight;\n             }\n         }\n     }\n \n     // Check for solution\n     if (best_selection.empty()) {\n-        return util::Error();\n+        return max_tx_size_exceeded ? ErrorMaxWeightExceeded() : util::Error();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103292025",
      "id" : 1103292025,
      "line" : 171,
      "node_id" : "PRRC_kwDOABII585BwuZ5",
      "original_commit_id" : "2c9b9507c9b15e47c22d7255763d71d21a91bae7",
      "original_line" : 171,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 53,
      "pull_request_review_id" : 1294015946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103292025/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-10T22:15:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103292025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103622002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103622002"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah yeah, good catch. All the numbers are expressed in weight units. And yes, inputs are all P2WPKH (all of them in every `coinselector_tests.cpp` test case).",
      "commit_id" : "f0add1d0a7507e5601d7da54f62fe9ab272b3281",
      "created_at" : "2023-02-11T12:52:10Z",
      "diff_hunk" : "@@ -940,6 +940,100 @@ BOOST_AUTO_TEST_CASE(effective_value_test)\n     BOOST_CHECK_EQUAL(output5.GetEffectiveValue(), nValue); // The effective value should be equal to the absolute value if input_bytes is -1\n }\n \n+\n+static util::Result<SelectionResult> SelectCoinsSRD(const CAmount& target,\n+                                                    const CoinSelectionParams& cs_params,\n+                                                    interfaces::Chain* chain, const ArgsManager& args,\n+                                                    int max_weight,\n+                                                    std::function<CoinsResult(CWallet&)> coin_setup)\n+{\n+    std::unique_ptr<CWallet> wallet = std::make_unique<CWallet>(chain, \"\", args, CreateMockWalletDatabase());\n+    wallet->LoadWallet();\n+    LOCK(wallet->cs_wallet);\n+    wallet->SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+    wallet->SetupDescriptorScriptPubKeyMans();\n+\n+    CoinEligibilityFilter filter(0, 0, 0);\n+    const std::vector<OutputGroup>& group = GroupOutputs(*wallet, coin_setup(*wallet).All(), cs_params, filter, true);\n+    return SelectCoinsSRD(group, target, cs_params.rng_fast, max_weight);\n+}\n+\n+BOOST_AUTO_TEST_CASE(srd_tests)\n+{\n+    // Test SRD:\n+    // 1) Insufficient funds, select all provided coins and fail.\n+    // 2) Exceeded max weight, coin selection always surpasses the max allowed weight.\n+    // 3) Select coins without surpassing the max weight (some coins surpasses the max allowed weight, some others not)\n+\n+    FastRandomContext rand;\n+    CoinSelectionParams cs_params{\n+            rand,\n+            /*change_output_size=*/34,\n+            /*change_spend_size=*/68,\n+            /*min_change_target=*/CENT,\n+            /*effective_feerate=*/CFeeRate(0),\n+            /*long_term_feerate=*/CFeeRate(0),\n+            /*discard_feerate=*/CFeeRate(0),\n+            /*tx_noinputs_size=*/10 + 34, // static header size + output size\n+            /*avoid_partial=*/false,\n+    };\n+\n+    {\n+        // #########################################################\n+        // 1) Insufficient funds, select all provided coins and fail\n+        // #########################################################\n+        CAmount target = 49.5L * COIN;\n+        int max_weight = 10000; // high enough to not fail for this reason.\n+        const auto& res = SelectCoinsSRD(target, cs_params, m_node.chain.get(), m_args, max_weight, [&](CWallet& wallet) {\n+            CoinsResult available_coins;\n+            for (int j = 0; j < 10; ++j) {\n+                add_coin(available_coins, wallet, CAmount(1 * COIN));\n+                add_coin(available_coins, wallet, CAmount(2 * COIN));\n+            }\n+            return available_coins;\n+        });\n+        BOOST_CHECK(!res);\n+        BOOST_CHECK(util::ErrorString(res).empty()); // empty means \"insufficient funds\"\n+    }\n+\n+    {\n+        // ###########################\n+        // 2) Test max weight exceeded\n+        // ###########################\n+        CAmount target = 49.5L * COIN;\n+        int max_weight = 3000;\n+        const auto& res = SelectCoinsSRD(target, cs_params, m_node.chain.get(), m_args, max_weight, [&](CWallet& wallet) {\n+            CoinsResult available_coins;\n+            for (int j = 0; j < 10; ++j) {\n+                add_coin(available_coins, wallet, CAmount(1 * COIN), CFeeRate(0), 144, false, 0, true);\n+                add_coin(available_coins, wallet, CAmount(2 * COIN), CFeeRate(0), 144, false, 0, true);\n+            }\n+            return available_coins;\n+        });\n+        BOOST_CHECK(!res);\n+        BOOST_CHECK(util::ErrorString(res).original.find(\"The inputs size exceeds the maximum weight\") != std::string::npos);\n+    }\n+\n+    {\n+        // ################################################################################################################\n+        // 3) Test selection when some coins surpass the max allowed weight while others not. --> must find a good solution\n+        // ################################################################################################################\n+        CAmount target = 25.33L * COIN;\n+        int max_weight = 10000;\n+        const auto& res = SelectCoinsSRD(target, cs_params, m_node.chain.get(), m_args, max_weight, [&](CWallet& wallet) {\n+            CoinsResult available_coins;\n+            for (int j = 0; j < 60; ++j) { // 60 UTXO --> 19,8 BTC total --> weight 272 * 60 = 16320 kvb\n+                add_coin(available_coins, wallet, CAmount(0.33 * COIN), CFeeRate(0), 144, false, 0, true);\n+            }\n+            for (int i = 0; i < 10; i++) { // 10 UTXO --> 20 BTC total --> weight 272 * 10 = 2720 kvb\n+                add_coin(available_coins, wallet, CAmount(2 * COIN), CFeeRate(0), 144, false, 0, true);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103622002",
      "id" : 1103622002,
      "in_reply_to_id" : 1103289270,
      "line" : 1053,
      "node_id" : "PRRC_kwDOABII585Bx-9y",
      "original_commit_id" : "bcb6f22130bdca73b2a084963a574960ac163bce",
      "original_line" : 1030,
      "original_position" : 91,
      "original_start_line" : 1021,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 91,
      "pull_request_review_id" : 1294524016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103622002/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-02-11T12:52:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103622002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "7d5a02ecb2af934ea0fa76c9013b2a2fc968b726",
      "created_at" : "2023-02-11T13:07:27Z",
      "diff_hunk" : "@@ -97,6 +99,7 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n     CAmount best_waste = MAX_MONEY;\n \n     bool is_feerate_high = utxo_pool.at(0).fee > utxo_pool.at(0).long_term_fee;\n+    bool max_tx_size_exceeded = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623941",
      "id" : 1103623941,
      "in_reply_to_id" : 1103290900,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Bx_cF",
      "original_commit_id" : "2c9b9507c9b15e47c22d7255763d71d21a91bae7",
      "original_line" : 102,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1294528314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-11T13:07:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "7d5a02ecb2af934ea0fa76c9013b2a2fc968b726",
      "created_at" : "2023-02-11T13:07:31Z",
      "diff_hunk" : "@@ -106,6 +109,9 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n             curr_value > selection_target + cost_of_change || // Selected value is out of range, go back and try other branch\n             (curr_waste > best_waste && is_feerate_high)) { // Don't select things which we know will be more wasteful if the waste is increasing\n             backtrack = true;\n+        } else if (curr_selection_weight > max_weight) { // Exceeding weight for standard tx, cannot find more solutions by adding more inputs\n+            max_tx_size_exceeded = true; // at least one selection attempt exceeded the max weight",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623954",
      "id" : 1103623954,
      "in_reply_to_id" : 1103291613,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Bx_cS",
      "original_commit_id" : "2c9b9507c9b15e47c22d7255763d71d21a91bae7",
      "original_line" : 113,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1294528321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623954/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-11T13:07:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "7d5a02ecb2af934ea0fa76c9013b2a2fc968b726",
      "created_at" : "2023-02-11T13:07:36Z",
      "diff_hunk" : "@@ -154,13 +161,14 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n                 curr_selection.push_back(utxo_pool_index);\n                 curr_value += utxo.GetSelectionAmount();\n                 curr_waste += utxo.fee - utxo.long_term_fee;\n+                curr_selection_weight += utxo.m_weight;\n             }\n         }\n     }\n \n     // Check for solution\n     if (best_selection.empty()) {\n-        return util::Error();\n+        return max_tx_size_exceeded ? ErrorMaxWeightExceeded() : util::Error();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623962",
      "id" : 1103623962,
      "in_reply_to_id" : 1103292025,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Bx_ca",
      "original_commit_id" : "2c9b9507c9b15e47c22d7255763d71d21a91bae7",
      "original_line" : 171,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1294528328,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-11T13:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "7d5a02ecb2af934ea0fa76c9013b2a2fc968b726",
      "created_at" : "2023-02-11T13:07:49Z",
      "diff_hunk" : "@@ -384,9 +384,12 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n  *\n  * @param[in]  utxo_pool    The positive effective value OutputGroups eligible for selection\n  * @param[in]  target_value The target value to select for\n+ * @param[in]  rng The randomness source to shuffle coins\n+ * @param[in] max_weight The maximum allowed weight for a selection result to be valid",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1103623989",
      "id" : 1103623989,
      "in_reply_to_id" : 1103268851,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Bx_c1",
      "original_commit_id" : "c723827ac21e265c9bdbb3e4aa2f8ba79ac48a97",
      "original_line" : 388,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : null,
      "pull_request_review_id" : 1294528349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623989/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-11T13:07:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103623989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Feedback tackled, thanks for the review Xekyo!\r\nPushed [diff](https://github.com/bitcoin/bitcoin/compare/f0add1d0a7507e5601d7da54f62fe9ab272b3281..7d5a02ecb2af934ea0fa76c9013b2a2fc968b726).",
      "created_at" : "2023-02-11T13:10:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#issuecomment-1426764558",
      "id" : 1426764558,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26720",
      "node_id" : "IC_kwDOABII585VCrMO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426764558/reactions"
      },
      "updated_at" : "2023-02-11T13:10:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426764558",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-02-17T19:12:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#issuecomment-1435119386",
      "id" : 1435119386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26720",
      "node_id" : "IC_kwDOABII585Vii8a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435119386/reactions"
      },
      "updated_at" : "2023-02-17T19:12:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435119386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-03-07T00:57:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#issuecomment-1457298397",
      "id" : 1457298397,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26720",
      "node_id" : "IC_kwDOABII585W3Jvd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1457298397/reactions"
      },
      "updated_at" : "2023-03-07T00:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1457298397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156435700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156435700"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1284223691127e76135a46d251c52416104f0ff1 (same below)\r\n\r\n> If an if only has a single-statement then-clause, it can appear on the same line as the if, without braces. In every other case, braces are required, and the then and else clauses must appear correctly indented on a new line.\r\nhttps://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c\r\n\r\n```suggestion\r\n    } else {\r\n\t\tappend_error(bnb_result);\r\n\t}\r\n```\r\n",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-03T20:38:26Z",
      "diff_hunk" : "@@ -554,25 +554,34 @@ util::Result<SelectionResult> ChooseSelectionResult(const CAmount& nTargetValue,\n {\n     // Vector of results. We will choose the best one based on waste.\n     std::vector<SelectionResult> results;\n+    std::vector<util::Result<SelectionResult>> errors;\n+    auto append_error = [&] (const util::Result<SelectionResult>& result) {\n+        // If any specific error message appears here, then something different from a simple \"no selection found\" happened.\n+        // Let's save it, so it can be retrieved to the user if no other selection algorithm succeeded.\n+        if (HasErrorMsg(result)) {\n+            errors.emplace_back(result);\n+        }\n+    };\n \n     if (auto bnb_result{SelectCoinsBnB(groups.positive_group, nTargetValue, coin_selection_params.m_cost_of_change)}) {\n         results.push_back(*bnb_result);\n-    }\n+    } else append_error(bnb_result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156435700",
      "id" : 1156435700,
      "line" : 571,
      "node_id" : "PRRC_kwDOABII585E7c70",
      "original_commit_id" : "1284223691127e76135a46d251c52416104f0ff1",
      "original_line" : 568,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 20,
      "pull_request_review_id" : 1369769556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156435700/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-03T21:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156435700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156451001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156451001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Maybe rename the variable to `max_inputs_weight` to make it clearer?",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-03T20:57:46Z",
      "diff_hunk" : "@@ -563,12 +563,15 @@ util::Result<SelectionResult> ChooseSelectionResult(const CAmount& nTargetValue,\n         }\n     };\n \n+    // Maximum allowed transaction weight\n+    int max_weight = MAX_STANDARD_TX_WEIGHT - (coin_selection_params.tx_noinputs_size * WITNESS_SCALE_FACTOR);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156451001",
      "id" : 1156451001,
      "line" : 567,
      "node_id" : "PRRC_kwDOABII585E7gq5",
      "original_commit_id" : "187ce369ff2409d08de6af5cd2144b4d3e714488",
      "original_line" : 567,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 14,
      "pull_request_review_id" : 1369769556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156451001/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-03T21:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156451001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156453195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156453195"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fd8cf58d736ed9614f46b4f5b3c92f71ff9c46d4\r\nnit\r\n```suggestion\r\n    const int operator() (const OutputGroup& group1, const OutputGroup& group2)\r\n```",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-03T21:00:37Z",
      "diff_hunk" : "@@ -172,9 +173,20 @@ util::Result<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_pool\n     return result;\n }\n \n-util::Result<SelectionResult> SelectCoinsSRD(const std::vector<OutputGroup>& utxo_pool, CAmount target_value, FastRandomContext& rng)\n+class MinOutputGroupComparator\n+{\n+public:\n+    int operator() (const OutputGroup& group1, const OutputGroup& group2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156453195",
      "id" : 1156453195,
      "line" : 187,
      "node_id" : "PRRC_kwDOABII585E7hNL",
      "original_commit_id" : "fd8cf58d736ed9614f46b4f5b3c92f71ff9c46d4",
      "original_line" : 179,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 91,
      "pull_request_review_id" : 1369769556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156453195/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-03T21:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156453195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156500169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156500169"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm,  what about something like this https://github.com/furszy/bitcoin-core/commit/0ddd8f4e2672f4826b87b1cfda617a3c15caabea\r\n",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-03T22:10:27Z",
      "diff_hunk" : "@@ -554,25 +554,34 @@ util::Result<SelectionResult> ChooseSelectionResult(const CAmount& nTargetValue,\n {\n     // Vector of results. We will choose the best one based on waste.\n     std::vector<SelectionResult> results;\n+    std::vector<util::Result<SelectionResult>> errors;\n+    auto append_error = [&] (const util::Result<SelectionResult>& result) {\n+        // If any specific error message appears here, then something different from a simple \"no selection found\" happened.\n+        // Let's save it, so it can be retrieved to the user if no other selection algorithm succeeded.\n+        if (HasErrorMsg(result)) {\n+            errors.emplace_back(result);\n+        }\n+    };\n \n     if (auto bnb_result{SelectCoinsBnB(groups.positive_group, nTargetValue, coin_selection_params.m_cost_of_change)}) {\n         results.push_back(*bnb_result);\n-    }\n+    } else append_error(bnb_result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156500169",
      "id" : 1156500169,
      "in_reply_to_id" : 1156435700,
      "line" : 571,
      "node_id" : "PRRC_kwDOABII585E7srJ",
      "original_commit_id" : "1284223691127e76135a46d251c52416104f0ff1",
      "original_line" : 568,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 20,
      "pull_request_review_id" : 1369864379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156500169/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-03T22:10:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156500169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156501392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156501392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it's the maximum allowed transaction weight, not only for the inputs.",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-03T22:12:41Z",
      "diff_hunk" : "@@ -563,12 +563,15 @@ util::Result<SelectionResult> ChooseSelectionResult(const CAmount& nTargetValue,\n         }\n     };\n \n+    // Maximum allowed transaction weight\n+    int max_weight = MAX_STANDARD_TX_WEIGHT - (coin_selection_params.tx_noinputs_size * WITNESS_SCALE_FACTOR);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156501392",
      "id" : 1156501392,
      "in_reply_to_id" : 1156451001,
      "line" : 567,
      "node_id" : "PRRC_kwDOABII585E7s-Q",
      "original_commit_id" : "187ce369ff2409d08de6af5cd2144b4d3e714488",
      "original_line" : 567,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 14,
      "pull_request_review_id" : 1369866095,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156501392/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-03T22:12:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156501392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156541825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156541825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in commit 1284223691127e76135a46d251c52416104f0ff1: this doxygen comment about the return-value has to be adapted w.r.t. `std::nullopt`",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-03T23:24:59Z",
      "diff_hunk" : "@@ -417,10 +418,10 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n  * @param[in]  target_value The target value to select for\n  * @returns If successful, a SelectionResult, otherwise, std::nullopt",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156541825",
      "id" : 1156541825,
      "line" : 422,
      "node_id" : "PRRC_kwDOABII585E722B",
      "original_commit_id" : "1284223691127e76135a46d251c52416104f0ff1",
      "original_line" : 419,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : 23,
      "pull_request_review_id" : 1369922559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156541825/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-04T00:04:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156541825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156571087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156571087"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> it's the maximum allowed transaction weight, not only for the inputs.\r\n\r\nI don't think so? The coin selection algos don't have any knowledge about the additional data of the to-be-created tx (static header size + outputs), so they can only work with a weight limit on the inputs.",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-04T00:09:23Z",
      "diff_hunk" : "@@ -563,12 +563,15 @@ util::Result<SelectionResult> ChooseSelectionResult(const CAmount& nTargetValue,\n         }\n     };\n \n+    // Maximum allowed transaction weight\n+    int max_weight = MAX_STANDARD_TX_WEIGHT - (coin_selection_params.tx_noinputs_size * WITNESS_SCALE_FACTOR);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156571087",
      "id" : 1156571087,
      "in_reply_to_id" : 1156451001,
      "line" : 567,
      "node_id" : "PRRC_kwDOABII585E79_P",
      "original_commit_id" : "187ce369ff2409d08de6af5cd2144b4d3e714488",
      "original_line" : 567,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 14,
      "pull_request_review_id" : 1369965206,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156571087/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-04T00:09:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156571087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156844031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156844031"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I haven't written a test for this, so all the following is not verified and just my guess based on the code understanding.\r\n\r\nThis is not a regression in this particular PR, but this could lead to misleading errors in a situation when a proper solution exists, but our coin selection failed to find it and only found solution that exceeded weight.\r\nLet's imagine following scenario:\r\n- UTXO pool: two big coins 50BTC, a ton of 0.001BTC.\r\n- Target amount: 90BTC\r\n- Proper solution: just take two big coins and create a change output.\r\n\r\nI think none of the coin selection algorithms will be able to **reliably** find the proper solution.\r\n1) BnB won't be able to find it, because proper solution includes change. \r\n2) Knapsack again optimises for the match, therefore it discards the proper solution in favour of a closer match that exceeds the weight limit.\r\n2) SRD misses proper solution with 75% chance, because it checks each coin exactly once. If it skipped at least one of two big coins it will never find the proper solution.\r\n\r\nI think we should a) make the message more explicit about the fact that solution might exist, but we just failed to find one b) propose users to select coins manually as another remedy c) better document the shortcomings of our coin selection.\r\n",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-04T07:31:41Z",
      "diff_hunk" : "@@ -13,8 +13,16 @@\n \n #include <numeric>\n #include <optional>\n+#include <queue>\n \n namespace wallet {\n+// Common selection error across the algorithms\n+static util::Result<SelectionResult> ErrorMaxWeightExceeded()\n+{\n+    return util::Error{_(\"The inputs size exceeds the maximum weight. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156844031",
      "id" : 1156844031,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII585E9An_",
      "original_commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "original_line" : 22,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 10,
      "pull_request_review_id" : 1370369681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156844031/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-04T07:31:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156844031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156851716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156851716"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wrote #24580 at some point to capture known to me inefficiencies of current coin selection. The scenario I described above is very close to case no.3 in `test_one_big_and_many_small_coins`",
      "commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "created_at" : "2023-04-04T07:38:41Z",
      "diff_hunk" : "@@ -13,8 +13,16 @@\n \n #include <numeric>\n #include <optional>\n+#include <queue>\n \n namespace wallet {\n+// Common selection error across the algorithms\n+static util::Result<SelectionResult> ErrorMaxWeightExceeded()\n+{\n+    return util::Error{_(\"The inputs size exceeds the maximum weight. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26720#discussion_r1156851716",
      "id" : 1156851716,
      "in_reply_to_id" : 1156844031,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII585E9CgE",
      "original_commit_id" : "ba7970c793f3e8ddb54a02256e7ae52e88e47f08",
      "original_line" : 22,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 10,
      "pull_request_review_id" : 1370381137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26720",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156851716/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-04T07:38:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156851716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
