[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [brunoerg](https://github.com/bitcoin/bitcoin/pull/26742#pullrequestreview-1228858150), [promag](https://github.com/bitcoin/bitcoin/pull/26742#pullrequestreview-1240762906) |\n| Approach ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/26742#pullrequestreview-1237467909) |\n| Stale ACK | [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1365549010), [stickies-v](https://github.com/bitcoin/bitcoin/pull/26742#pullrequestreview-1243713404) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2022-12-22T18:49:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1363227894",
      "id" : 1363227894,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585RQTT2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1363227894/reactions"
      },
      "updated_at" : "2023-02-10T19:45:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1363227894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Running `test/functional/feature_abortnode.py` before and after change we get a significant performance gain\r\n\r\nrunning before changes f3bc1a72825fe2b51f4bc20e004cef464f05b965\r\n```\r\ntest/functional/feature_abortnode.py\r\n2022-12-23T04:47:19.826000Z TestFramework (INFO): Initializing test directory /var/folders/9g/cvx014yx4dq5lwl_x5zvn_j80000gn/T/bitcoin_func_test_k3_6xric\r\n2022-12-23T04:47:21.229000Z TestFramework (INFO): Waiting for crash\r\n2022-12-23T04:47:51.429000Z TestFramework (INFO): Node crashed - now verifying restart fails\r\n2022-12-23T04:47:52.086000Z TestFramework (INFO): Stopping nodes\r\n2022-12-23T04:47:52.300000Z TestFramework (INFO): Cleaning up /var/folders/9g/cvx014yx4dq5lwl_x5zvn_j80000gn/T/bitcoin_func_test_k3_6xric on exit\r\n2022-12-23T04:47:52.300000Z TestFramework (INFO): Tests successful\r\n```\r\n32.50 seconds to run test\r\n\r\n-------\r\n\r\nrunning test with these changes applied [40528e7](https://github.com/bitcoin/bitcoin/pull/26742/commits/40528e777fbad0512bb657fb067ea8dc2389c02e)\r\n```\r\ntest/functional/feature_abortnode.py\r\n2022-12-23T04:44:30.075000Z TestFramework (INFO): Initializing test directory /var/folders/9g/cvx014yx4dq5lwl_x5zvn_j80000gn/T/bitcoin_func_test_0h3w_rbx\r\n2022-12-23T04:44:31.516000Z TestFramework (INFO): Waiting for crash\r\n2022-12-23T04:44:31.837000Z TestFramework (INFO): Node crashed - now verifying restart fails\r\n2022-12-23T04:44:32.452000Z TestFramework (INFO): Stopping nodes\r\n2022-12-23T04:44:32.727000Z TestFramework (INFO): Cleaning up /var/folders/9g/cvx014yx4dq5lwl_x5zvn_j80000gn/T/bitcoin_func_test_0h3w_rbx on exit\r\n2022-12-23T04:44:32.727000Z TestFramework (INFO): Tests successful\r\n```\r\n1.2 seconds to run test",
      "created_at" : "2022-12-23T04:50:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1363612871",
      "id" : 1363612871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585RRxTH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1363612871/reactions"
      },
      "updated_at" : "2022-12-23T04:50:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1363612871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056290646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056290646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe a `GlobalMutex` would be more appropriate here?\r\n\r\n```suggestion\r\nstatic GlobalMutex g_requests_mutex;\r\n```",
      "commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "created_at" : "2022-12-23T11:59:10Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static Mutex g_requests_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056290646",
      "id" : 1056290646,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584-9bdW",
      "original_commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "original_line" : 152,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 18,
      "pull_request_review_id" : 1228890565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056290646/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-23T11:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056290646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK :trollface: ",
      "created_at" : "2022-12-23T15:12:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1364031297",
      "id" : 1364031297,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585RTXdB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1364031297/reactions"
      },
      "updated_at" : "2022-12-23T15:12:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1364031297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056417241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056417241"
         }
      },
      "author_association" : "NONE",
      "body" : "I'm still newish to the repo, is there a convention on when we should use `Mutex` vs `GlobalMutex`?",
      "commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "created_at" : "2022-12-23T15:21:47Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static Mutex g_requests_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056417241",
      "id" : 1056417241,
      "in_reply_to_id" : 1056290646,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584-96XZ",
      "original_commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "original_line" : 152,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 18,
      "pull_request_review_id" : 1229085018,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056417241/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-23T15:21:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056417241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056453597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056453597"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I'm still newish to the repo, is there a convention on when we should use `Mutex` vs `GlobalMutex`?\r\n\r\nIt depends on a scope. For the global namespace the `GlobalMutex` is an appropriate option: https://github.com/bitcoin/bitcoin/blob/f3bc1a72825fe2b51f4bc20e004cef464f05b965/src/sync.h#L132-L141",
      "commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "created_at" : "2022-12-23T16:07:21Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static Mutex g_requests_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056453597",
      "id" : 1056453597,
      "in_reply_to_id" : 1056290646,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584--DPd",
      "original_commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "original_line" : 152,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 18,
      "pull_request_review_id" : 1229150643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056453597/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-23T16:15:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056453597",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056466553"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056466553"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Maybe a `GlobalMutex` would be more appropriate here?\r\n\r\nThis suggestion must fix the following [errors](https://api.cirrus-ci.com/v1/task/5176219491106816/logs/ci.log):\r\n```\r\nhttpserver.cpp:221:13: error: calling function 'MaybeCheckNotHeld' requires negative capability '!g_requests_mutex' [-Werror,-Wthread-safety-analysis]\r\n            LOCK(g_requests_mutex);\r\n            ^\r\n./sync.h:258:56: note: expanded from macro 'LOCK'\r\n#define LOCK(cs) UniqueLock UNIQUE_NAME(criticalblock)(MaybeCheckNotHeld(cs), #cs, __FILE__, __LINE__)\r\n                                                       ^\r\nhttpserver.cpp:218:9: error: calling function 'MaybeCheckNotHeld' requires negative capability '!g_requests_mutex' [-Werror,-Wthread-safety-analysis]\r\n        LOCK(g_requests_mutex);\r\n        ^\r\n./sync.h:258:56: note: expanded from macro 'LOCK'\r\n#define LOCK(cs) UniqueLock UNIQUE_NAME(criticalblock)(MaybeCheckNotHeld(cs), #cs, __FILE__, __LINE__)\r\n                                                       ^\r\nhttpserver.cpp:481:9: error: calling function 'MaybeCheckNotHeld' requires negative capability '!g_requests_mutex' [-Werror,-Wthread-safety-analysis]\r\n        WAIT_LOCK(g_requests_mutex, lock);\r\n        ^\r\n./sync.h:263:45: note: expanded from macro 'WAIT_LOCK'\r\n#define WAIT_LOCK(cs, name) UniqueLock name(MaybeCheckNotHeld(cs), #cs, __FILE__, __LINE__)\r\n                                            ^\r\n3 errors generated.\r\n```",
      "commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "created_at" : "2022-12-23T16:14:16Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static Mutex g_requests_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056466553",
      "id" : 1056466553,
      "in_reply_to_id" : 1056290646,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584--GZ5",
      "original_commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "original_line" : 152,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 18,
      "pull_request_review_id" : 1229159987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056466553/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-23T16:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056466553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056684955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056684955"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe include a comment explaining this, see https://github.com/bitcoin/bitcoin/pull/19420#discussion_r833476744. At this point, it is possible that on`g_thread_http` the `eventHTTP` struct is being used.",
      "commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "created_at" : "2022-12-23T23:15:38Z",
      "diff_hunk" : "@@ -459,14 +477,22 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);\n+        }\n+    }\n+    if (eventHTTP) {\n+        event_base_once(eventBase, -1, EV_TIMEOUT, [](evutil_socket_t, short, void*) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056684955",
      "id" : 1056684955,
      "line" : 487,
      "node_id" : "PRRC_kwDOABII584--7ub",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 487,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 54,
      "pull_request_review_id" : 1229452700,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056684955/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-23T23:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056684955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056685160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056685160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe always call `g_requests_cv.notify_all()` and update comment above.",
      "commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "created_at" : "2022-12-23T23:17:07Z",
      "diff_hunk" : "@@ -207,6 +213,18 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when last active request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            LOCK(g_requests_mutex);\n+            auto n = g_requests.erase(req);\n+            assert(n == 1);\n+            if (g_requests.empty()) g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056685160",
      "id" : 1056685160,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII584--7xo",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 224,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 36,
      "pull_request_review_id" : 1229452951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056685160/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-23T23:23:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056685160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056685560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056685560"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe log \"Waiting for %d requests to stop HTTP server\" or something like that.",
      "commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "created_at" : "2022-12-23T23:19:05Z",
      "diff_hunk" : "@@ -459,14 +477,22 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056685560",
      "id" : 1056685560,
      "line" : 483,
      "node_id" : "PRRC_kwDOABII584--734",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 483,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 50,
      "pull_request_review_id" : 1229452951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056685560/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-23T23:23:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056685560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056843393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056843393"
         }
      },
      "author_association" : "NONE",
      "body" : "why would we want to always call `.notify_all()` if we are waiting for all the http requests to finish?",
      "commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "created_at" : "2022-12-24T15:54:44Z",
      "diff_hunk" : "@@ -207,6 +213,18 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when last active request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            LOCK(g_requests_mutex);\n+            auto n = g_requests.erase(req);\n+            assert(n == 1);\n+            if (g_requests.empty()) g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056843393",
      "id" : 1056843393,
      "in_reply_to_id" : 1056685160,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII584-_iaB",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 224,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 36,
      "pull_request_review_id" : 1229663708,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056843393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-24T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056843393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056847000"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056847000"
         }
      },
      "author_association" : "MEMBER",
      "body" : "because that way you would get a log every time a connection closes. Otherwise `g_requests_cv` should be renamed to `g_requests_empty_cv`.\r\n\r\nIf `g_requests_cv` is used to signal changes to `g_requests` then also add call `.notify_all()` after `g_requests.insert(req)`.",
      "commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "created_at" : "2022-12-24T16:14:22Z",
      "diff_hunk" : "@@ -207,6 +213,18 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when last active request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            LOCK(g_requests_mutex);\n+            auto n = g_requests.erase(req);\n+            assert(n == 1);\n+            if (g_requests.empty()) g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056847000",
      "id" : 1056847000,
      "in_reply_to_id" : 1056685160,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII584-_jSY",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 224,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 36,
      "pull_request_review_id" : 1229667937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056847000/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-24T16:14:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056847000",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056946375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056946375"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done, errors are fixed. Thanks!",
      "commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "created_at" : "2022-12-25T12:33:00Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static Mutex g_requests_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056946375",
      "id" : 1056946375,
      "in_reply_to_id" : 1056290646,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-_7jH",
      "original_commit_id" : "40528e777fbad0512bb657fb067ea8dc2389c02e",
      "original_line" : 152,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1229739963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056946375/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-25T12:33:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056946375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056987595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987595"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-25T18:56:17Z",
      "diff_hunk" : "@@ -459,14 +477,22 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056987595",
      "id" : 1056987595,
      "in_reply_to_id" : 1056685560,
      "line" : 487,
      "node_id" : "PRRC_kwDOABII584_AFnL",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 487,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 54,
      "pull_request_review_id" : 1229770200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-25T18:56:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056987708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987708"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done, I have opted for always calling it",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-25T18:56:50Z",
      "diff_hunk" : "@@ -207,6 +213,18 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when last active request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            LOCK(g_requests_mutex);\n+            auto n = g_requests.erase(req);\n+            assert(n == 1);\n+            if (g_requests.empty()) g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056987708",
      "id" : 1056987708,
      "in_reply_to_id" : 1056685160,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_AFo8",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 224,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1229770232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987708/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-25T18:56:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987708",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056987813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987813"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done, I hope that covers it.",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-25T18:57:53Z",
      "diff_hunk" : "@@ -459,14 +477,22 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);\n+        }\n+    }\n+    if (eventHTTP) {\n+        event_base_once(eventBase, -1, EV_TIMEOUT, [](evutil_socket_t, short, void*) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056987813",
      "id" : 1056987813,
      "in_reply_to_id" : 1056684955,
      "line" : 494,
      "node_id" : "PRRC_kwDOABII584_AFql",
      "original_commit_id" : "b9b8b5d2ca9fe43a777f4756e9399dcdb967c22c",
      "original_line" : 494,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 61,
      "pull_request_review_id" : 1229770283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987813/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-25T18:57:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1056987813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057353934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057353934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "my suggestion was to add the log here in the loop.",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-26T22:16:15Z",
      "diff_hunk" : "@@ -459,14 +478,28 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        if (!g_requests.empty()) {\n+            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+        }\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057353934",
      "id" : 1057353934,
      "line" : 487,
      "node_id" : "PRRC_kwDOABII584_BfDO",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 487,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 54,
      "pull_request_review_id" : 1230240081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057353934/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-26T22:16:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057353934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "retACK [f95063e](https://github.com/bitcoin/bitcoin/pull/26742/commits/f95063efb9c23765671f72a1f14eb66634cb3988) with `test/functional/feature_abortnode.py`",
      "created_at" : "2022-12-27T01:57:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1365549010",
      "id" : 1365549010,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585RZJ_S",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1365549010/reactions"
      },
      "updated_at" : "2022-12-27T01:57:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1365549010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From https://github.com/bitcoin/bitcoin/pull/15363#issuecomment-461921981:\r\n> The libevent HTTP interface is kind of crazy, so I don't think it's surprising that fixing this requires some trial and error. But it would be good to have tests for each issue that gets fixed to avoid going in circles.\r\n\r\nSuggesting to add a test which will prevent any regressions in the future.",
      "created_at" : "2022-12-27T16:24:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1366026611",
      "id" : 1366026611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585Ra-lz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1366026611/reactions"
      },
      "updated_at" : "2022-12-27T16:24:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1366026611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057781251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057781251"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Calling `notify_all()` while holding a mutex is a pessimization. Suggesting to apply a diff:\r\n```suggestion\r\n            auto n = WITH_LOCK(g_requests_mutex, return g_requests.erase(req));\r\n```",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-27T16:40:00Z",
      "diff_hunk" : "@@ -207,6 +213,19 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);\n+        g_requests_cv.notify_all();\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            LOCK(g_requests_mutex);\n+            auto n = g_requests.erase(req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057781251",
      "id" : 1057781251,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII584_DHYD",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 223,
      "original_position" : 35,
      "original_start_line" : 222,
      "path" : "src/httpserver.cpp",
      "position" : 35,
      "pull_request_review_id" : 1230825822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057781251/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 222,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-27T17:06:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057781251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057781323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057781323"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Calling `notify_all()` while holding a mutex is a pessimization. Suggesting to apply a diff:\r\n```suggestion\r\n        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\r\n```\r\nor to introduce a new scope.",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-27T16:40:11Z",
      "diff_hunk" : "@@ -207,6 +213,19 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057781323",
      "id" : 1057781323,
      "line" : 219,
      "node_id" : "PRRC_kwDOABII584_DHZL",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 219,
      "original_position" : 31,
      "original_start_line" : 218,
      "path" : "src/httpserver.cpp",
      "position" : 31,
      "pull_request_review_id" : 1230825822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057781323/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 218,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-27T17:06:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057781323",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057794988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057794988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While this code snippet is used across the current codebase, for new code I'd prefer another `wait()` overload with an \"inlined\" `stop_waiting` condition:\r\n```suggestion\r\n        g_requests_cv.wait(lock, []() EXCLUSIVE_LOCKS_REQUIRED(g_requests_mutex) { return g_requests.empty(); });\r\n```",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-27T16:59:24Z",
      "diff_hunk" : "@@ -459,14 +478,28 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        if (!g_requests.empty()) {\n+            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+        }\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057794988",
      "id" : 1057794988,
      "line" : 488,
      "node_id" : "PRRC_kwDOABII584_DKus",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 488,
      "original_position" : 55,
      "original_start_line" : 486,
      "path" : "src/httpserver.cpp",
      "position" : 55,
      "pull_request_review_id" : 1230825822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057794988/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 486,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-27T17:06:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057794988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057798365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057798365"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is any particular reason for not using `std::unordered_set` which has more efficient `insert()` and `erase()` methods?",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-27T17:06:11Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057798365",
      "id" : 1057798365,
      "line" : 154,
      "node_id" : "PRRC_kwDOABII584_DLjd",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 154,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 20,
      "pull_request_review_id" : 1230825822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057798365/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-27T17:06:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057798365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057827695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057827695"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Combine two `if (eventBase)` blocks into a single one?",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2022-12-27T18:00:27Z",
      "diff_hunk" : "@@ -459,14 +478,28 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        if (!g_requests.empty()) {\n+            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+        }\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);\n+        }\n+    }\n+    if (eventHTTP) {\n+        // Schedule a callback to call evhttp_free in the event base thread, so\n+        // that evhttp_free does not need to be called again after the handling\n+        // of unfinished request connections that follows.\n+        event_base_once(eventBase, -1, EV_TIMEOUT, [](evutil_socket_t, short, void*) {\n+            evhttp_free(eventHTTP);\n+            eventHTTP = nullptr;\n+        }, nullptr, nullptr);\n+    }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n         if (g_thread_http.joinable()) g_thread_http.join();\n     }\n-    if (eventHTTP) {\n-        evhttp_free(eventHTTP);\n-        eventHTTP = nullptr;\n-    }\n     if (eventBase) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057827695",
      "id" : 1057827695,
      "line" : 503,
      "node_id" : "PRRC_kwDOABII584_DStv",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 503,
      "original_position" : 74,
      "original_start_line" : 499,
      "path" : "src/httpserver.cpp",
      "position" : 74,
      "pull_request_review_id" : 1230889827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057827695/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 499,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-27T18:00:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1057827695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1060815427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1060815427"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No reason, should be a small set anyway, both are fine IMHO.",
      "commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "created_at" : "2023-01-03T17:45:00Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1060815427",
      "id" : 1060815427,
      "in_reply_to_id" : 1057798365,
      "line" : 154,
      "node_id" : "PRRC_kwDOABII584_OsJD",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 154,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 20,
      "pull_request_review_id" : 1234903247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1060815427/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-03T17:45:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1060815427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> From [#15363 (comment)](https://github.com/bitcoin/bitcoin/pull/15363#issuecomment-461921981):\r\n> \r\n> > The libevent HTTP interface is kind of crazy, so I don't think it's surprising that fixing this requires some trial and error. But it would be good to have tests for each issue that gets fixed to avoid going in circles.\r\n> \r\n> Suggesting to add a test which will prevent any regressions in the future.\r\n\r\n@hebasto like https://github.com/bitcoin/bitcoin/blob/7bb07bf8bd8e240562714f9cc4b7696868cb6c26/test/functional/feature_abortnode.py#L44 should take less than 5s or so?",
      "created_at" : "2023-01-03T17:48:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1370056781",
      "id" : 1370056781,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585RqWhN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1370056781/reactions"
      },
      "updated_at" : "2023-01-03T17:48:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1370056781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062432864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062432864"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T12:43:59Z",
      "diff_hunk" : "@@ -459,14 +478,28 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        if (!g_requests.empty()) {\n+            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+        }\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);\n+        }\n+    }\n+    if (eventHTTP) {\n+        // Schedule a callback to call evhttp_free in the event base thread, so\n+        // that evhttp_free does not need to be called again after the handling\n+        // of unfinished request connections that follows.\n+        event_base_once(eventBase, -1, EV_TIMEOUT, [](evutil_socket_t, short, void*) {\n+            evhttp_free(eventHTTP);\n+            eventHTTP = nullptr;\n+        }, nullptr, nullptr);\n+    }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n         if (g_thread_http.joinable()) g_thread_http.join();\n     }\n-    if (eventHTTP) {\n-        evhttp_free(eventHTTP);\n-        eventHTTP = nullptr;\n-    }\n     if (eventBase) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062432864",
      "id" : 1062432864,
      "in_reply_to_id" : 1057827695,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_U3Bg",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 503,
      "original_position" : 74,
      "original_start_line" : 499,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1237333989,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062432864/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-05T12:44:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062432864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062432926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062432926"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T12:44:03Z",
      "diff_hunk" : "@@ -146,6 +148,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062432926",
      "id" : 1062432926,
      "in_reply_to_id" : 1057798365,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_U3Ce",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 154,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1237334064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062432926/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-05T12:44:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062432926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062433014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T12:44:08Z",
      "diff_hunk" : "@@ -459,14 +478,28 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        if (!g_requests.empty()) {\n+            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+        }\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062433014",
      "id" : 1062433014,
      "in_reply_to_id" : 1057794988,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_U3D2",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 488,
      "original_position" : 55,
      "original_start_line" : 486,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1237334154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433014/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-05T12:44:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062433112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433112"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T12:44:12Z",
      "diff_hunk" : "@@ -207,6 +213,19 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062433112",
      "id" : 1062433112,
      "in_reply_to_id" : 1057781323,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_U3FY",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 219,
      "original_position" : 31,
      "original_start_line" : 218,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1237334247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433112/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-05T12:44:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062433226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433226"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T12:44:18Z",
      "diff_hunk" : "@@ -207,6 +213,19 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        LOCK(g_requests_mutex);\n+        g_requests.insert(req);\n+        g_requests_cv.notify_all();\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            LOCK(g_requests_mutex);\n+            auto n = g_requests.erase(req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062433226",
      "id" : 1062433226,
      "in_reply_to_id" : 1057781251,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_U3HK",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 223,
      "original_position" : 35,
      "original_start_line" : 222,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1237334348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433226/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-05T12:44:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062433226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062434858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062434858"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I think doing it in the loop essentially creates a countdown that I didn't think was necessary. But I am kind of indifferent on this, so I have changed it now.",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T12:45:41Z",
      "diff_hunk" : "@@ -459,14 +478,28 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        if (!g_requests.empty()) {\n+            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+        }\n+        while (!g_requests.empty()) {\n+            g_requests_cv.wait(lock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062434858",
      "id" : 1062434858,
      "in_reply_to_id" : 1057353934,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_U3gq",
      "original_commit_id" : "f95063efb9c23765671f72a1f14eb66634cb3988",
      "original_line" : 487,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1237336008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062434858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-05T12:45:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062434858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > From [#15363 (comment)](https://github.com/bitcoin/bitcoin/pull/15363#issuecomment-461921981):\r\n> > > The libevent HTTP interface is kind of crazy, so I don't think it's surprising that fixing this requires some trial and error. But it would be good to have tests for each issue that gets fixed to avoid going in circles.\r\n> > \r\n> > \r\n> > Suggesting to add a test which will prevent any regressions in the future.\r\n> \r\n> @hebasto like\r\n> \r\n> https://github.com/bitcoin/bitcoin/blob/7bb07bf8bd8e240562714f9cc4b7696868cb6c26/test/functional/feature_abortnode.py#L44\r\n> \r\n> should take less than 5s or so?\r\n\r\nI have updated the test and it seems to be reliably failing on master, so I think this is a good enough regression test @hebasto ?\r\n\r\nAlso addressed other comments by @hebasto .",
      "created_at" : "2023-01-05T12:47:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1372172010",
      "id" : 1372172010,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585Rya7q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1372172010/reactions"
      },
      "updated_at" : "2023-01-05T12:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1372172010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062524049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062524049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Isn't indentation too big?",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T14:20:00Z",
      "diff_hunk" : "@@ -459,15 +477,27 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n-    if (eventBase) {\n-        LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        if (g_thread_http.joinable()) g_thread_http.join();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        g_requests_cv.wait(lock, []() EXCLUSIVE_LOCKS_REQUIRED(g_requests_mutex) {\n+                if (!g_requests.empty()) {\n+                    LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+                }\n+                return g_requests.empty();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062524049",
      "id" : 1062524049,
      "line" : 486,
      "node_id" : "PRRC_kwDOABII584_VNSR",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 486,
      "original_position" : 58,
      "original_start_line" : 483,
      "path" : "src/httpserver.cpp",
      "position" : 58,
      "pull_request_review_id" : 1237467909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062524049/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 483,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-05T14:24:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062524049",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062528172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062528172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Having side effects in the predicate seems a bad idea due to spurious wakeups. It should be a pure function.",
      "commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "created_at" : "2023-01-05T14:23:57Z",
      "diff_hunk" : "@@ -459,15 +477,27 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n-    if (eventBase) {\n-        LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        if (g_thread_http.joinable()) g_thread_http.join();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        g_requests_cv.wait(lock, []() EXCLUSIVE_LOCKS_REQUIRED(g_requests_mutex) {\n+                if (!g_requests.empty()) {\n+                    LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062528172",
      "id" : 1062528172,
      "line" : 484,
      "node_id" : "PRRC_kwDOABII584_VOSs",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 484,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 56,
      "pull_request_review_id" : 1237467909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062528172/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-05T14:24:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062528172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062671091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062671091"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What's the purpose of this notification? I think we (currently) only need to monitor for completed requests, not new ones?",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-05T16:36:56Z",
      "diff_hunk" : "@@ -207,6 +214,17 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n+        g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1062671091",
      "id" : 1062671091,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII584_VxLz",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 220,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 34,
      "pull_request_review_id" : 1237698918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062671091/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-06T18:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1062671091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1063664153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1063664153"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this can also be a simple atomic counter which doesn't require a lock?\r\n\r\n<details>\r\n<summary>git diff on 6d3a848fc</summary>\r\n\r\n```diff\r\ndiff --git a/src/httpserver.cpp b/src/httpserver.cpp\r\nindex 346c6d5cb..a058a9c49 100644\r\n--- a/src/httpserver.cpp\r\n+++ b/src/httpserver.cpp\r\n@@ -152,7 +152,7 @@ static std::vector<evhttp_bound_socket *> boundSockets;\r\n //! Track active requests\r\n static GlobalMutex g_requests_mutex;\r\n static std::condition_variable g_requests_cv;\r\n-static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);\r\n+static std::atomic<size_t> g_requests_count;\r\n \r\n /** Check if a network address is allowed to access the HTTP server */\r\n static bool ClientAllowed(const CNetAddr& netaddr)\r\n@@ -216,11 +216,9 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\r\n {\r\n     // Track requests and notify when a request is completed.\r\n     {\r\n-        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\r\n-        g_requests_cv.notify_all();\r\n+        ++g_requests_count;\r\n         evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\r\n-            auto n = WITH_LOCK(g_requests_mutex, return g_requests.erase(req));\r\n-            assert(n == 1);\r\n+            --g_requests_count;\r\n             g_requests_cv.notify_all();\r\n         }, nullptr);\r\n     }\r\n@@ -480,10 +478,10 @@ void StopHTTPServer()\r\n     {\r\n         WAIT_LOCK(g_requests_mutex, lock);\r\n         g_requests_cv.wait(lock, []() EXCLUSIVE_LOCKS_REQUIRED(g_requests_mutex) {\r\n-                if (!g_requests.empty()) {\r\n-                    LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\r\n-                }\r\n-                return g_requests.empty();\r\n+            if (g_requests_count > 0) {\r\n+                LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests_count);\r\n+            }\r\n+            return g_requests_count == 0;\r\n         });\r\n     }\r\n     if (eventHTTP) {\r\n```\r\n</details>\r\n\r\n(cc @hebasto - I think this is a similar but less \"controversial\" approach than what I proposed offline)",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-06T18:06:43Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1063664153",
      "id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_ZjoZ",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1237698918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1063664153/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-06T18:17:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1063664153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585334"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fixed",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T12:25:23Z",
      "diff_hunk" : "@@ -459,15 +477,27 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n-    if (eventBase) {\n-        LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        if (g_thread_http.joinable()) g_thread_http.join();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        g_requests_cv.wait(lock, []() EXCLUSIVE_LOCKS_REQUIRED(g_requests_mutex) {\n+                if (!g_requests.empty()) {\n+                    LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\n+                }\n+                return g_requests.empty();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585334",
      "id" : 1064585334,
      "in_reply_to_id" : 1062524049,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_dEh2",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 486,
      "original_position" : 58,
      "original_start_line" : 483,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1240403260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-09T12:25:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585371"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sure, then I think [this](https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1057353934) isn't possible anymore so I am reverting back to how I did it before. I think that's fine though.",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T12:25:25Z",
      "diff_hunk" : "@@ -459,15 +477,27 @@ void StopHTTPServer()\n         evhttp_del_accept_socket(eventHTTP, socket);\n     }\n     boundSockets.clear();\n-    if (eventBase) {\n-        LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        if (g_thread_http.joinable()) g_thread_http.join();\n+    {\n+        WAIT_LOCK(g_requests_mutex, lock);\n+        g_requests_cv.wait(lock, []() EXCLUSIVE_LOCKS_REQUIRED(g_requests_mutex) {\n+                if (!g_requests.empty()) {\n+                    LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585371",
      "id" : 1064585371,
      "in_reply_to_id" : 1062528172,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584_dEib",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 484,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1240403319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585371/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T12:25:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585466"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Did you see https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1056847000 ?",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T12:25:32Z",
      "diff_hunk" : "@@ -207,6 +214,17 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n+        g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585466",
      "id" : 1064585466,
      "in_reply_to_id" : 1062671091,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII584_dEj6",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 220,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 34,
      "pull_request_review_id" : 1240403458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585466/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T12:25:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585841"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, for this change alone it would be possible with a count I think but not for the follow-up change in [#19434](https://github.com/bitcoin/bitcoin/pull/19434) where the explicit requests are removed in a callback.",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T12:25:58Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064585841",
      "id" : 1064585841,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_dEpx",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1240403973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T12:25:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064585841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Can anyone please confirm or correct my understanding of why this so much faster?\r\n> \r\n> My current understanding is that even when all of the workers in `g_thread_http_workers` have terminated (i.e. the entire queue is processed and `running==false`), the http server thread `g_thread_http` does not return (when joining) immediately because there are still some idle connections _(with whom?)_ open, preventing the server from shutting down. By first (instead of afterwards) calling `evhttp_free(eventHTTP)`, we can safely destroy the server even if connections are still open (but all requests are handled), causing `g_thread_http.join()` to return immediately in `StopHTTPServer()` as opposed to waiting for a timeout.\r\n\r\nSounds good to me. I guess libevent doesn't close the idle connection as an optimization (less overhead if the client wants to send more requests) and if the client doesn't close them then we are seeing this issue. I would add that the overhead that we see in the functional test is the timeout we have configured on the http server ourselves [here](https://github.com/bitcoin/bitcoin/blob/master/src/httpserver.h#L14).\r\n",
      "created_at" : "2023-01-09T12:52:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1375580720",
      "id" : 1375580720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585R_bIw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1375580720/reactions"
      },
      "updated_at" : "2023-01-09T12:52:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1375580720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I guess libevent doesn't close the idle connection as an optimization (less overhead if the client wants to send more requests) and if the client doesn't close them then we are seeing this issue.\r\n\r\nNot really an optimization of libevent, `AuthServiceProxy` used in the test framework creates a persistent connection (to reuse the same connection for consecutive HTTP requests, as @fjahr says).",
      "created_at" : "2023-01-09T14:27:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1375705311",
      "id" : 1375705311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585R_5jf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1375705311/reactions"
      },
      "updated_at" : "2023-01-09T14:27:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1375705311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064702034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064702034"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I hadn't seen that, thanks for linking. \r\n\r\nIt's a minor concern, but I'm a bit worried that we're creating a very general contract (\"`g_requests_cv` will always notify for any changes to the `g_requests`\") on a global variable when it's enforced outside of `g_requests`, when in the future we might easily introduce mutations on `g_requests` without notifying the cv. A more scoped cv, such as `g_requests_cv_handled` largely mitigates that.\r\n\r\nBut, again, no big concern, and it's not likely to cause any major problems should we miss something there. As you see fit.",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T14:30:17Z",
      "diff_hunk" : "@@ -207,6 +214,17 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n+        g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064702034",
      "id" : 1064702034,
      "in_reply_to_id" : 1062671091,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII584_dhBS",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 220,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 34,
      "pull_request_review_id" : 1240584139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064702034/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T14:30:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064702034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064707663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064707663"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, makes sense. I'm not sure how controversial #19434 is, need to take a closer look. Would it make sense to use the atomic counter in this PR and then use a set in the follow-up? In case we can't get that merged, that would leave master in a better state, and I think the code churn is manageable?",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T14:35:39Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064707663",
      "id" : 1064707663,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_diZP",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1240593034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064707663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T14:35:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064707663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064808284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064808284"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You still need a lock, otherwise, how would you wait for the count to be zero?",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T16:03:39Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064808284",
      "id" : 1064808284,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_d69c",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1240747932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064808284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T16:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064808284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064818694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064818694"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure I understand your comment - my diff (https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1063664153) does not involve removing the lock, although it reduces reliance on it since a counter can be encapsulated with a more efficient `std::atomic<size_t>` as opposed to set mutations which require acquiring a lock. If I'm misunderstanding you, could you please clarify?",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T16:13:40Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064818694",
      "id" : 1064818694,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_d9gG",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1240764314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064818694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T16:13:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064818694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064823506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064823506"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah neverming, we could use `std::atomic<T>::wait`",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T16:18:07Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064823506",
      "id" : 1064823506,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_d-rS",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1240771586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064823506/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T16:18:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064823506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064826454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064826454"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Anyway, I think having a set of connections is required for upcoming changes (like #19434) but you are right that for this branch the count is enough. I still tend to prefer as is but I would ACK a version with the counter.",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T16:20:44Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064826454",
      "id" : 1064826454,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_d_ZW",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1240775975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064826454/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T16:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064826454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064889295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064889295"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I prefer to keep it as is as well. I don't think #19434 will be controversial because it's not conceptually different, just an improvement. And using the count is just a minor simplification, the code works the same either way. We have put stranger things into the code base, like unused functions for example, as long as there were follow-ups where they would be used and the these follow-ups were following the same concept that was already ACKed.",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-09T17:23:23Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1064889295",
      "id" : 1064889295,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_eOvP",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1240871737,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064889295/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T17:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064889295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066468897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066468897"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can be removed.",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-11T00:29:57Z",
      "diff_hunk" : "@@ -21,12 +21,15 @@\n #include <util/threadnames.h>\n #include <util/translation.h>\n \n+#include <condition_variable>\n #include <cstdio>\n #include <cstdlib>\n #include <deque>\n #include <memory>\n+#include <mutex>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066468897",
      "id" : 1066468897,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII584_kQYh",
      "original_commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "original_line" : 29,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 9,
      "pull_request_review_id" : 1243146112,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066468897/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T00:29:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066468897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066864359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066864359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "+1, and we're missing `#include <event2/http_struct.h>` (for `evhttp_request`)",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-11T11:08:00Z",
      "diff_hunk" : "@@ -21,12 +21,15 @@\n #include <util/threadnames.h>\n #include <util/translation.h>\n \n+#include <condition_variable>\n #include <cstdio>\n #include <cstdlib>\n #include <deque>\n #include <memory>\n+#include <mutex>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066864359",
      "id" : 1066864359,
      "in_reply_to_id" : 1066468897,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII584_lw7n",
      "original_commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "original_line" : 29,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 9,
      "pull_request_review_id" : 1243713404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066864359/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T11:47:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066864359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066864853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066864853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit - think I'd prefer removing the `n` var altogether, the temp var doesn't really make it more readable imo\r\n```suggestion\r\n            auto n{WITH_LOCK(g_requests_mutex, return g_requests.erase(req))};\r\n```",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-11T11:08:33Z",
      "diff_hunk" : "@@ -207,6 +214,17 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n+        g_requests_cv.notify_all();\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            auto n = WITH_LOCK(g_requests_mutex, return g_requests.erase(req));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066864853",
      "id" : 1066864853,
      "line" : 222,
      "node_id" : "PRRC_kwDOABII584_lxDV",
      "original_commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "original_line" : 222,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 36,
      "pull_request_review_id" : 1243713404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066864853/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T11:46:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066864853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066894976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066894976"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "FYI I think one approach to improve on this contract (and as a nice benefit, also encapsulate code a bit better - I think this improves readability) in the below diff.\r\n\r\n(`WaitUntilEmpty()` needs improvement because it shouldn't directly be logging about the HTTP server like that. I guess we also don't need a `GlobalMutex` here.)\r\n\r\n<details>\r\n<summary>git diff on 55bbf04ad</summary>\r\n\r\n```diff\r\ndiff --git a/src/httpserver.cpp b/src/httpserver.cpp\r\nindex b481ef093..90ef37bd5 100644\r\n--- a/src/httpserver.cpp\r\n+++ b/src/httpserver.cpp\r\n@@ -134,6 +134,40 @@ struct HTTPPathHandler\r\n     HTTPRequestHandler handler;\r\n };\r\n \r\n+class RequestTracker\r\n+{\r\n+public:\r\n+    typedef std::unordered_set<evhttp_request*> requests_t;\r\n+private:\r\n+    GlobalMutex m_requests_mutex;\r\n+    std::condition_variable m_requests_cv;\r\n+    requests_t m_requests GUARDED_BY(m_requests_mutex);\r\n+public:\r\n+    void Register(struct evhttp_request* req)\r\n+    {\r\n+        WITH_LOCK(m_requests_mutex, m_requests.insert(req));\r\n+        m_requests_cv.notify_all();\r\n+    }\r\n+\r\n+    size_t Remove(struct evhttp_request* req)\r\n+    {\r\n+        auto n{WITH_LOCK(m_requests_mutex, return m_requests.erase(req))};\r\n+        m_requests_cv.notify_all();\r\n+        return n;\r\n+    }\r\n+\r\n+    void WaitUntilEmpty()\r\n+    {\r\n+        WAIT_LOCK(m_requests_mutex, lock);\r\n+        if (!m_requests.empty()) {\r\n+            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", m_requests.size());\r\n+        }\r\n+        m_requests_cv.wait(lock, [this]() EXCLUSIVE_LOCKS_REQUIRED(m_requests_mutex) {\r\n+            return m_requests.empty();\r\n+        });\r\n+    }\r\n+};\r\n+\r\n /** HTTP module state */\r\n \r\n //! libevent event loop\r\n@@ -149,10 +183,8 @@ static GlobalMutex g_httppathhandlers_mutex;\r\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\r\n //! Bound listening sockets\r\n static std::vector<evhttp_bound_socket *> boundSockets;\r\n-//! Track active requests\r\n-static GlobalMutex g_requests_mutex;\r\n-static std::condition_variable g_requests_cv;\r\n-static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);\r\n+static RequestTracker g_request_tracker;\r\n+\r\n \r\n /** Check if a network address is allowed to access the HTTP server */\r\n static bool ClientAllowed(const CNetAddr& netaddr)\r\n@@ -216,12 +248,9 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\r\n {\r\n     // Track requests and notify when a request is completed.\r\n     {\r\n-        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\r\n-        g_requests_cv.notify_all();\r\n+        g_request_tracker.Register(req);\r\n         evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\r\n-            auto n = WITH_LOCK(g_requests_mutex, return g_requests.erase(req));\r\n-            assert(n == 1);\r\n-            g_requests_cv.notify_all();\r\n+            assert(g_request_tracker.Remove(req) == 1);\r\n         }, nullptr);\r\n     }\r\n \r\n@@ -477,15 +506,7 @@ void StopHTTPServer()\r\n         evhttp_del_accept_socket(eventHTTP, socket);\r\n     }\r\n     boundSockets.clear();\r\n-    {\r\n-        WAIT_LOCK(g_requests_mutex, lock);\r\n-        if (!g_requests.empty()) {\r\n-            LogPrint(BCLog::HTTP, \"Waiting for %d requests to stop HTTP server\\n\", g_requests.size());\r\n-        }\r\n-        g_requests_cv.wait(lock, []() EXCLUSIVE_LOCKS_REQUIRED(g_requests_mutex) {\r\n-            return g_requests.empty();\r\n-        });\r\n-    }\r\n+    g_request_tracker.WaitUntilEmpty();\r\n     if (eventHTTP) {\r\n         // Schedule a callback to call evhttp_free in the event base thread, so\r\n         // that evhttp_free does not need to be called again after the handling\r\n```\r\n</details>",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-11T11:43:08Z",
      "diff_hunk" : "@@ -207,6 +214,17 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n+        g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066894976",
      "id" : 1066894976,
      "in_reply_to_id" : 1062671091,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII584_l4aA",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 220,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 34,
      "pull_request_review_id" : 1243713404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066894976/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T11:46:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066894976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066896174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066896174"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Alright, it's not my ideal approach but let's be pragmatic and keep it as is. Can be marked as resolved for me.",
      "commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "created_at" : "2023-01-11T11:44:36Z",
      "diff_hunk" : "@@ -146,6 +149,10 @@ static GlobalMutex g_httppathhandlers_mutex;\n static std::vector<HTTPPathHandler> pathHandlers GUARDED_BY(g_httppathhandlers_mutex);\n //! Bound listening sockets\n static std::vector<evhttp_bound_socket *> boundSockets;\n+//! Track active requests\n+static GlobalMutex g_requests_mutex;\n+static std::condition_variable g_requests_cv;\n+static std::unordered_set<evhttp_request*> g_requests GUARDED_BY(g_requests_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1066896174",
      "id" : 1066896174,
      "in_reply_to_id" : 1063664153,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584_l4su",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 155,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 23,
      "pull_request_review_id" : 1243713404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066896174/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T11:46:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066896174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1103167272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103167272"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Both done",
      "commit_id" : "60978c8080ec13ff4571c8a89e742517b2aca692",
      "created_at" : "2023-02-10T19:45:49Z",
      "diff_hunk" : "@@ -21,12 +21,15 @@\n #include <util/threadnames.h>\n #include <util/translation.h>\n \n+#include <condition_variable>\n #include <cstdio>\n #include <cstdlib>\n #include <deque>\n #include <memory>\n+#include <mutex>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1103167272",
      "id" : 1103167272,
      "in_reply_to_id" : 1066468897,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585BwP8o",
      "original_commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "original_line" : 29,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1293893628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103167272/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-10T19:45:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103167272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1103167917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103167917"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry but it's a significant change and this PR already has a pretty long history and several ACKs for the current approach. I would suggest you open a follow-up PR with this as an additional improvement.",
      "commit_id" : "60978c8080ec13ff4571c8a89e742517b2aca692",
      "created_at" : "2023-02-10T19:46:28Z",
      "diff_hunk" : "@@ -207,6 +214,17 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n+        g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1103167917",
      "id" : 1103167917,
      "in_reply_to_id" : 1062671091,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII585BwQGt",
      "original_commit_id" : "6d3a848fc76f76af2b2b262011f37be952325b44",
      "original_line" : 220,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 41,
      "pull_request_review_id" : 1293895284,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103167917/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-10T19:46:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103167917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1103168195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103168195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "60978c8080ec13ff4571c8a89e742517b2aca692",
      "created_at" : "2023-02-10T19:46:51Z",
      "diff_hunk" : "@@ -207,6 +214,17 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\n /** HTTP request callback */\n static void http_request_cb(struct evhttp_request* req, void* arg)\n {\n+    // Track requests and notify when a request is completed.\n+    {\n+        WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n+        g_requests_cv.notify_all();\n+        evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\n+            auto n = WITH_LOCK(g_requests_mutex, return g_requests.erase(req));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1103168195",
      "id" : 1103168195,
      "in_reply_to_id" : 1066864853,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585BwQLD",
      "original_commit_id" : "55bbf04adc4879dcacd135f40aa053e60032af4b",
      "original_line" : 222,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1293896071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103168195/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-10T19:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1103168195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed comments by @promag and @stickies-v ",
      "created_at" : "2023-02-10T19:47:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#issuecomment-1426261216",
      "id" : 1426261216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26742",
      "node_id" : "IC_kwDOABII585VAwTg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426261216/reactions"
      },
      "updated_at" : "2023-02-10T19:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426261216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1121744890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1121744890"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: IWYU suggests to s/`#include <event2/http_struct.h>`/`#include <event2/event.h>`/.",
      "commit_id" : "60978c8080ec13ff4571c8a89e742517b2aca692",
      "created_at" : "2023-03-01T13:39:04Z",
      "diff_hunk" : "@@ -21,19 +21,22 @@\n #include <util/threadnames.h>\n #include <util/translation.h>\n \n+#include <condition_variable>\n #include <cstdio>\n #include <cstdlib>\n #include <deque>\n #include <memory>\n #include <optional>\n #include <string>\n+#include <unordered_set>\n \n #include <sys/types.h>\n #include <sys/stat.h>\n \n #include <event2/buffer.h>\n #include <event2/bufferevent.h>\n #include <event2/http.h>\n+#include <event2/http_struct.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1121744890",
      "id" : 1121744890,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585C3Hf6",
      "original_commit_id" : "60978c8080ec13ff4571c8a89e742517b2aca692",
      "original_line" : 39,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 19,
      "pull_request_review_id" : 1319862109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1121744890/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-01T13:40:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1121744890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1125511981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1125511981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks! I will fix this in the follow-up that will pick up #19434.",
      "commit_id" : "60978c8080ec13ff4571c8a89e742517b2aca692",
      "created_at" : "2023-03-04T18:28:28Z",
      "diff_hunk" : "@@ -21,19 +21,22 @@\n #include <util/threadnames.h>\n #include <util/translation.h>\n \n+#include <condition_variable>\n #include <cstdio>\n #include <cstdlib>\n #include <deque>\n #include <memory>\n #include <optional>\n #include <string>\n+#include <unordered_set>\n \n #include <sys/types.h>\n #include <sys/stat.h>\n \n #include <event2/buffer.h>\n #include <event2/bufferevent.h>\n #include <event2/http.h>\n+#include <event2/http_struct.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26742#discussion_r1125511981",
      "id" : 1125511981,
      "in_reply_to_id" : 1121744890,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585DFfMt",
      "original_commit_id" : "60978c8080ec13ff4571c8a89e742517b2aca692",
      "original_line" : 39,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 19,
      "pull_request_review_id" : 1325078200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26742",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1125511981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-04T18:28:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1125511981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
