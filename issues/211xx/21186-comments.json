[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21837 ([POC] Rust based Cuckoo Filter for m_addr_known by fanquake)\n* #21527 (net_processing: lock clean up by ajtowns)\n* #21261 (p2p: update inbound eviction protection for multiple networks, add I2P peers by jonatack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-18T05:16:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-781061349",
      "id" : 781061349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MTA2MTM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-08T00:32:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/781061349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r592834789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592834789"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please [use `std::make_unique` in new code](https://github.com/bitcoin/bitcoin/blob/master/src/util/memory.h#L13).",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-03-12T00:52:55Z",
      "diff_hunk" : "@@ -216,7 +237,8 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id, bool addr_relay)\n+        : m_id(id), m_addr_known{addr_relay ? nullptr : MakeUnique<CRollingBloomFilter>(5000, 0.001)} {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r592834789",
      "id" : 592834789,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjgzNDc4OQ==",
      "original_commit_id" : "231562806b99cbe91bcb5ba27662b2b4e51f13a2",
      "original_line" : 241,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 610365228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592834789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "#21236 is merged. Moving this out of draft.",
      "created_at" : "2021-04-01T08:10:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-811732373",
      "id" : 811732373,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTczMjM3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T08:10:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811732373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r605911247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605911247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\nstatic bool RelayAddrsWithPeer(const Peer& peer)\r\n{\r\n    return peer.m_addr_known != nullptr;\r\n}\r\n```",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-01T19:58:24Z",
      "diff_hunk" : "@@ -617,6 +652,39 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+static bool RelayAddrsWithPeer(const Peer& peer) { return peer.m_addr_known != nullptr; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r605911247",
      "id" : 605911247,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTkxMTI0Nw==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 653,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 626603303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605911247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-04-02T23:02:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-812747777",
      "id" : 812747777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMjc0Nzc3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-02T23:02:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/812747777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r606517593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606517593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Out of curiosity, is there a way to teach the [`clang-format-diff.py`](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy) to support such formatting, i.e., both a leading comma and `{}` on the the same line?",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-03T00:03:20Z",
      "diff_hunk" : "@@ -218,7 +241,10 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id, bool addr_relay)\n+        : m_id(id)\n+        , m_addr_known{addr_relay ? nullptr : std::make_unique<CRollingBloomFilter>(5000, 0.001)}\n+    {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r606517593",
      "id" : 606517593,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjUxNzU5Mw==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 245,
      "original_position" : 45,
      "original_start_line" : 244,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 627411416,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606517593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r606562457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606562457"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit:\r\n```suggestion\r\n    std::array<std::pair<uint64_t, Peer*>, 2> best{{{0, nullptr}, {0, nullptr}}};\r\n```",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-03T01:22:52Z",
      "diff_hunk" : "@@ -1483,59 +1551,49 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n     });\n }\n \n-/**\n- * Relay (gossip) an address to a few randomly chosen nodes.\n- * We choose the same nodes within a given 24h window (if the list of connected\n- * nodes does not change) and we don't relay to nodes that already know an\n- * address. So within 24h we will likely relay a given address once. This is to\n- * prevent a peer from unjustly giving their address better propagation by sending\n- * it to us repeatedly.\n- * @param[in] originator The peer that sent us the address. We don't want to relay it back.\n- * @param[in] addr Address to relay.\n- * @param[in] fReachable Whether the address' network is reachable. We relay unreachable\n- * addresses less.\n- * @param[in] connman Connection manager to choose nodes to relay to.\n- */\n-static void RelayAddress(const CNode& originator,\n-                         const CAddress& addr,\n-                         bool fReachable,\n-                         const CConnman& connman)\n+void PeerManagerImpl::RelayAddress(NodeId originator,\n+                                   const CAddress& addr,\n+                                   bool fReachable)\n {\n+    // We choose the same nodes within a given 24h window (if the list of connected\n+    // nodes does not change) and we don't relay to nodes that already know an\n+    // address. So within 24h we will likely relay a given address once. This is to\n+    // prevent a peer from unjustly giving their address better propagation by sending\n+    // it to us repeatedly.\n+\n     if (!fReachable && !addr.IsRelayable()) return;\n \n     // Relay to a limited number of other nodes\n     // Use deterministic randomness to send to the same nodes for 24 hours\n     // at a time so the m_addr_knowns of the chosen nodes prevent repeats\n     uint64_t hashAddr = addr.GetHash();\n-    const CSipHasher hasher = connman.GetDeterministicRandomizer(RANDOMIZER_ID_ADDRESS_RELAY).Write(hashAddr << 32).Write((GetTime() + hashAddr) / (24 * 60 * 60));\n+    const CSipHasher hasher = m_connman.GetDeterministicRandomizer(RANDOMIZER_ID_ADDRESS_RELAY).Write(hashAddr << 32).Write((GetTime() + hashAddr) / (24 * 60 * 60));\n     FastRandomContext insecure_rand;\n \n     // Relay reachable addresses to 2 peers. Unreachable addresses are relayed randomly to 1 or 2 peers.\n     unsigned int nRelayNodes = (fReachable || (hasher.Finalize() & 1)) ? 2 : 1;\n \n-    std::array<std::pair<uint64_t, CNode*>,2> best{{{0, nullptr}, {0, nullptr}}};\n+    std::array<std::pair<uint64_t, Peer*>,2> best{{{0, nullptr}, {0, nullptr}}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r606562457",
      "id" : 606562457,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjU2MjQ1Nw==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 1576,
      "original_position" : 161,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 627419995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606562457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r606563197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606563197"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit:\r\n```suggestion\r\n            if (addr.nTime > nSince && !peer->m_getaddr_sent && vAddr.size() <= 10 && addr.IsRoutable()) {\r\n```",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-03T01:24:18Z",
      "diff_hunk" : "@@ -2674,24 +2732,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n             if (addr.nTime <= 100000000 || addr.nTime > nNow + 10 * 60)\n                 addr.nTime = nNow - 5 * 24 * 60 * 60;\n-            pfrom.AddAddressKnown(addr);\n+            AddAddressKnown(*peer, addr);\n             if (m_banman && (m_banman->IsDiscouraged(addr) || m_banman->IsBanned(addr))) {\n                 // Do not process banned/discouraged addresses beyond remembering we received them\n                 continue;\n             }\n             bool fReachable = IsReachable(addr);\n-            if (addr.nTime > nSince && !pfrom.fGetAddr && vAddr.size() <= 10 && addr.IsRoutable())\n+            if (addr.nTime > nSince && !peer->m_getaddr_sent && vAddr.size() <= 10 && addr.IsRoutable())\n             {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r606563197",
      "id" : 606563197,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjU2MzE5Nw==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 2742,
      "original_position" : 248,
      "original_start_line" : 2741,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 627419995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606563197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607837015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607837015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed!",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-06T13:14:14Z",
      "diff_hunk" : "@@ -1483,59 +1551,49 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n     });\n }\n \n-/**\n- * Relay (gossip) an address to a few randomly chosen nodes.\n- * We choose the same nodes within a given 24h window (if the list of connected\n- * nodes does not change) and we don't relay to nodes that already know an\n- * address. So within 24h we will likely relay a given address once. This is to\n- * prevent a peer from unjustly giving their address better propagation by sending\n- * it to us repeatedly.\n- * @param[in] originator The peer that sent us the address. We don't want to relay it back.\n- * @param[in] addr Address to relay.\n- * @param[in] fReachable Whether the address' network is reachable. We relay unreachable\n- * addresses less.\n- * @param[in] connman Connection manager to choose nodes to relay to.\n- */\n-static void RelayAddress(const CNode& originator,\n-                         const CAddress& addr,\n-                         bool fReachable,\n-                         const CConnman& connman)\n+void PeerManagerImpl::RelayAddress(NodeId originator,\n+                                   const CAddress& addr,\n+                                   bool fReachable)\n {\n+    // We choose the same nodes within a given 24h window (if the list of connected\n+    // nodes does not change) and we don't relay to nodes that already know an\n+    // address. So within 24h we will likely relay a given address once. This is to\n+    // prevent a peer from unjustly giving their address better propagation by sending\n+    // it to us repeatedly.\n+\n     if (!fReachable && !addr.IsRelayable()) return;\n \n     // Relay to a limited number of other nodes\n     // Use deterministic randomness to send to the same nodes for 24 hours\n     // at a time so the m_addr_knowns of the chosen nodes prevent repeats\n     uint64_t hashAddr = addr.GetHash();\n-    const CSipHasher hasher = connman.GetDeterministicRandomizer(RANDOMIZER_ID_ADDRESS_RELAY).Write(hashAddr << 32).Write((GetTime() + hashAddr) / (24 * 60 * 60));\n+    const CSipHasher hasher = m_connman.GetDeterministicRandomizer(RANDOMIZER_ID_ADDRESS_RELAY).Write(hashAddr << 32).Write((GetTime() + hashAddr) / (24 * 60 * 60));\n     FastRandomContext insecure_rand;\n \n     // Relay reachable addresses to 2 peers. Unreachable addresses are relayed randomly to 1 or 2 peers.\n     unsigned int nRelayNodes = (fReachable || (hasher.Finalize() & 1)) ? 2 : 1;\n \n-    std::array<std::pair<uint64_t, CNode*>,2> best{{{0, nullptr}, {0, nullptr}}};\n+    std::array<std::pair<uint64_t, Peer*>,2> best{{{0, nullptr}, {0, nullptr}}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607837015",
      "id" : 607837015,
      "in_reply_to_id" : 606562457,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzgzNzAxNQ==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 1576,
      "original_position" : 161,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 628954170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607837015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607838883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607838883"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-06T13:16:43Z",
      "diff_hunk" : "@@ -2674,24 +2732,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n             if (addr.nTime <= 100000000 || addr.nTime > nNow + 10 * 60)\n                 addr.nTime = nNow - 5 * 24 * 60 * 60;\n-            pfrom.AddAddressKnown(addr);\n+            AddAddressKnown(*peer, addr);\n             if (m_banman && (m_banman->IsDiscouraged(addr) || m_banman->IsBanned(addr))) {\n                 // Do not process banned/discouraged addresses beyond remembering we received them\n                 continue;\n             }\n             bool fReachable = IsReachable(addr);\n-            if (addr.nTime > nSince && !pfrom.fGetAddr && vAddr.size() <= 10 && addr.IsRoutable())\n+            if (addr.nTime > nSince && !peer->m_getaddr_sent && vAddr.size() <= 10 && addr.IsRoutable())\n             {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607838883",
      "id" : 607838883,
      "in_reply_to_id" : 606563197,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzgzODg4Mw==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 2742,
      "original_position" : 248,
      "original_start_line" : 2741,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 628956816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607838883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review, @hebasto! I've addressed both of your style comments.\r\n\r\n> four functions are moved from CNode members to the net_processing.cpp as free static functions. I agree that there's no need to make them members of Peer, but why not place them in a namespace? It could be unnamed, or we could choose a pretty good name for it :)\r\n\r\nThere's almost no difference between declaring a free function `static` and placing it in the unnamed namespace. Both will prevent the name from being accessible outside the translation unit. See https://stackoverflow.com/a/154482/933705 for example.\r\n\r\n> Also CNode::AddAddressKnown and CNode::PushAddress are subjects for fuzzing in the master branch. Could new free functions also be fuzzed?\r\n\r\nBoth of these functions are called from `ProcessMessage()`, so are indirectly tested by the `fuzz/process_messages.py` fuzzer.",
      "created_at" : "2021-04-06T13:17:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-814112000",
      "id" : 814112000,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNDExMjAwMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-06T13:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/814112000",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607839921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607839921"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good question! I'm not an expert on clang-format.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-06T13:18:01Z",
      "diff_hunk" : "@@ -218,7 +241,10 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id, bool addr_relay)\n+        : m_id(id)\n+        , m_addr_known{addr_relay ? nullptr : std::make_unique<CRollingBloomFilter>(5000, 0.001)}\n+    {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607839921",
      "id" : 607839921,
      "in_reply_to_id" : 606517593,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzgzOTkyMQ==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 245,
      "original_position" : 45,
      "original_start_line" : 244,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 628958170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607839921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607841267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607841267"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps `BCIS_BeforeComma`? (https://clang.llvm.org/docs/ClangFormatStyleOptions.html)",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-06T13:19:37Z",
      "diff_hunk" : "@@ -218,7 +241,10 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id, bool addr_relay)\n+        : m_id(id)\n+        , m_addr_known{addr_relay ? nullptr : std::make_unique<CRollingBloomFilter>(5000, 0.001)}\n+    {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r607841267",
      "id" : 607841267,
      "in_reply_to_id" : 606517593,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzg0MTI2Nw==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 245,
      "original_position" : 45,
      "original_start_line" : 244,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 628959964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607841267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> #19176 (comment)\r\n\r\nI don't see a hugely compelling reason to prefer unnamed namespaces over static declaration in any of those links, but equally wouldn't be opposed to updating the style guide to prefer unnnamed namespaces just for consistency.\r\n\r\nOne advantage of using `static` that isn't mentioned is that it's instantly obvious to the reader that the symbol has internal linkage. Unnamed namespaces often span many hundreds of lines, so it's not obvious when something is in the namespace. For example, I've just realized that in this PR, all the new functions are in fact inside an unnamed namespace that spans lines 542-942.",
      "created_at" : "2021-04-06T13:46:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-814132933",
      "id" : 814132933,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNDEzMjkzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-06T13:46:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/814132933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> For example, I've just realized that in this PR, all the new functions are in fact inside an unnamed namespace that spans lines 542-942.\r\n\r\nThere are three adjacent unnamed namespaces...\r\n\r\n> Unnamed namespaces often span many hundreds of lines...\r\n\r\nI think it is a code organizing problem, no?",
      "created_at" : "2021-04-10T14:13:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-817143110",
      "id" : 817143110,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzE0MzExMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-10T14:13:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817143110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> There are three adjacent unnamed namespaces...\r\n\r\nYes. This is part of the unfinished work in #20758. Once that's finished, these unnamed namespaces should be fixed up.\r\n\r\n> > Unnamed namespaces often span many hundreds of lines...\r\n\r\n> I think it is a code organizing problem, no?\r\n\r\nI'm not sure. I think if we use unnamed namespaces for all the internal functions that we don't want exposed outside the translation unit then they'll usually be hundreds of lines.",
      "created_at" : "2021-04-10T14:38:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-817146622",
      "id" : 817146622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzE0NjYyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-10T14:38:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817146622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'm not sure. I think if we use unnamed namespaces for all the internal functions that we don't want exposed outside the translation unit then they'll usually be hundreds of lines.\r\n\r\nCorrect. I mean that our code base have some really huge translation units :)",
      "created_at" : "2021-04-10T14:42:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-817147104",
      "id" : 817147104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzE0NzEwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-10T14:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817147104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611260357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611260357"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's counterintuitive to me that we don't relay addresses when `addr_relay` is true - I would have expected the opposite, or a different name like `disable_addr_relay`.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-11T23:21:15Z",
      "diff_hunk" : "@@ -218,7 +241,10 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id, bool addr_relay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611260357",
      "id" : 611260357,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTI2MDM1Nw==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 242,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 633064488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611260357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611261881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611261881"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems incorrect to me: The old code was specifically ignoring GETADDR requests from all outbound connections (for reasons explained in the comment above this line), the new code only ignores from block-relay-only connections. ",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-11T23:34:07Z",
      "diff_hunk" : "@@ -3566,20 +3622,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // to users' AddrMan and later request them by sending getaddr messages.\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\n         // the getaddr message mitigates the attack.\n-        if (!pfrom.IsInboundConn()) {\n+        if (!RelayAddrsWithPeer(*peer)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611261881",
      "id" : 611261881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTI2MTg4MQ==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 3625,
      "original_position" : 269,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 633064488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611261881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611264116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611264116"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why did you drop the check for `IsAddrCompatible()` in the move? Since `PushAddress()` is called from several places (not only `RelayAddress()` where this is checked seperately) this looks like more than a pure refactor to me.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-11T23:50:33Z",
      "diff_hunk" : "@@ -657,37 +632,6 @@ class CNode\n         nRefCount--;\n     }\n \n-    void AddAddressKnown(const CAddress& _addr)\n-    {\n-        assert(m_addr_known);\n-        m_addr_known->insert(_addr.GetKey());\n-    }\n-\n-    /**\n-     * Whether the peer supports the address. For example, a peer that does not\n-     * implement BIP155 cannot receive Tor v3 addresses because it requires\n-     * ADDRv2 (BIP155) encoding.\n-     */\n-    bool IsAddrCompatible(const CAddress& addr) const\n-    {\n-        return m_wants_addrv2 || addr.IsAddrV1Compatible();\n-    }\n-\n-    void PushAddress(const CAddress& _addr, FastRandomContext &insecure_rand)\n-    {\n-        // Known checking here is only to save space from duplicates.\n-        // SendMessages will filter it again for knowns that were added\n-        // after addresses were pushed.\n-        assert(m_addr_known);\n-        if (_addr.IsValid() && !m_addr_known->contains(_addr.GetKey()) && IsAddrCompatible(_addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611264116",
      "id" : 611264116,
      "line" : 682,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTI2NDExNg==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 682,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 84,
      "pull_request_review_id" : 633064488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611264116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611435801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611435801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oh wow. That's terrible. Thank you for catching this.\r\n\r\nThis was a bad rebase on top of 49c10a9ca40, which combined the two error conditions:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 690b59476b..859b67755d 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -3521,11 +3521,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\r\n         // the getaddr message mitigates the attack.\r\n         if (!pfrom.IsInboundConn()) {\r\n-            LogPrint(BCLog::NET, \"Ignoring \\\"getaddr\\\" from outbound connection. peer=%d\\n\", pfrom.GetId());\r\n-            return;\r\n-        }\r\n-        if (!pfrom.RelayAddrsWithConn()) {\r\n-            LogPrint(BCLog::NET, \"Ignoring \\\"getaddr\\\" from block-relay-only connection. peer=%d\\n\", pfrom.GetId());\r\n+            LogPrint(BCLog::NET, \"Ignoring \\\"getaddr\\\" from %s connection. peer=%d\\n\", pfrom.ConnectionTypeAsString(), pfrom.GetId());\r\n             return;\r\n         }\r\n```",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-12T08:40:40Z",
      "diff_hunk" : "@@ -3566,20 +3622,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // to users' AddrMan and later request them by sending getaddr messages.\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\n         // the getaddr message mitigates the attack.\n-        if (!pfrom.IsInboundConn()) {\n+        if (!RelayAddrsWithPeer(*peer)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611435801",
      "id" : 611435801,
      "in_reply_to_id" : 611261881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTQzNTgwMQ==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 3625,
      "original_position" : 269,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 633279230,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611435801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611472016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611472016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right. The logic here is correct, but the naming is confusing. I've reversed the logic, and added comments to the place where this ctor is called to hopefully make this more intuitive.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-12T09:30:49Z",
      "diff_hunk" : "@@ -218,7 +241,10 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id, bool addr_relay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611472016",
      "id" : 611472016,
      "in_reply_to_id" : 611260357,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTQ3MjAxNg==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 242,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 633326541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611472016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611472286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611472286"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is another rebase error. Thank you for catching!",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-12T09:31:12Z",
      "diff_hunk" : "@@ -657,37 +632,6 @@ class CNode\n         nRefCount--;\n     }\n \n-    void AddAddressKnown(const CAddress& _addr)\n-    {\n-        assert(m_addr_known);\n-        m_addr_known->insert(_addr.GetKey());\n-    }\n-\n-    /**\n-     * Whether the peer supports the address. For example, a peer that does not\n-     * implement BIP155 cannot receive Tor v3 addresses because it requires\n-     * ADDRv2 (BIP155) encoding.\n-     */\n-    bool IsAddrCompatible(const CAddress& addr) const\n-    {\n-        return m_wants_addrv2 || addr.IsAddrV1Compatible();\n-    }\n-\n-    void PushAddress(const CAddress& _addr, FastRandomContext &insecure_rand)\n-    {\n-        // Known checking here is only to save space from duplicates.\n-        // SendMessages will filter it again for knowns that were added\n-        // after addresses were pushed.\n-        assert(m_addr_known);\n-        if (_addr.IsValid() && !m_addr_known->contains(_addr.GetKey()) && IsAddrCompatible(_addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611472286",
      "id" : 611472286,
      "in_reply_to_id" : 611264116,
      "line" : 682,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTQ3MjI4Ng==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 682,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 84,
      "pull_request_review_id" : 633326896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611472286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thank you for the careful review @mzumsande. You caught two rebase errors :flushed: \r\n\r\nI've fixed those and addressed your other comment. I've also made some minor edits to comments to clarify concepts, and also re-reviewed everything to make sure no other errors have crept in.",
      "created_at" : "2021-04-12T09:40:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-817657534",
      "id" : 817657534,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzY1NzUzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-12T09:40:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817657534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611521373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611521373"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, I see. There should be a functional test for this that would have failed - something which I [once](https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-701571168) wanted to do anyway but then forgot about. I'll  write one soon!",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-12T10:46:13Z",
      "diff_hunk" : "@@ -3566,20 +3622,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // to users' AddrMan and later request them by sending getaddr messages.\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\n         // the getaddr message mitigates the attack.\n-        if (!pfrom.IsInboundConn()) {\n+        if (!RelayAddrsWithPeer(*peer)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611521373",
      "id" : 611521373,
      "in_reply_to_id" : 611261881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTUyMTM3Mw==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 3625,
      "original_position" : 269,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 633392913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611521373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611532916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611532916"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll very happily review once you open the PR.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-12T11:04:51Z",
      "diff_hunk" : "@@ -3566,20 +3622,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // to users' AddrMan and later request them by sending getaddr messages.\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\n         // the getaddr message mitigates the attack.\n-        if (!pfrom.IsInboundConn()) {\n+        if (!RelayAddrsWithPeer(*peer)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611532916",
      "id" : 611532916,
      "in_reply_to_id" : 611261881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTUzMjkxNg==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 3625,
      "original_position" : 269,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 633407973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611532916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611926283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611926283"
         }
      },
      "author_association" : "MEMBER",
      "body" : "heads up that I've recently written some similar tests here: https://github.com/bitcoin/bitcoin/pull/21528/files?file-filters%5B%5D=.py#diff-5a9f30817894348260893f195cea07da88271b5e01b1531f0cd839ee85898592R150. I don't think it would cover this exact use case, but just mentioning incase its useful / incase the test improvements could play nice together. ",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-12T20:18:52Z",
      "diff_hunk" : "@@ -3566,20 +3622,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // to users' AddrMan and later request them by sending getaddr messages.\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\n         // the getaddr message mitigates the attack.\n-        if (!pfrom.IsInboundConn()) {\n+        if (!RelayAddrsWithPeer(*peer)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611926283",
      "id" : 611926283,
      "in_reply_to_id" : 611261881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTkyNjI4Mw==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 3625,
      "original_position" : 269,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 633930457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611926283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611952434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611952434"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Cool - I didn't know, I had only looked at the non-test commits in your PR! This use case is the reverse direction (inbound/outbound send the getaddr to our node and get back addrs/nothing) from your tests, so I agree that these belong together.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-12T21:02:34Z",
      "diff_hunk" : "@@ -3566,20 +3622,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // to users' AddrMan and later request them by sending getaddr messages.\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\n         // the getaddr message mitigates the attack.\n-        if (!pfrom.IsInboundConn()) {\n+        if (!RelayAddrsWithPeer(*peer)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r611952434",
      "id" : 611952434,
      "in_reply_to_id" : 611261881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk1MjQzNA==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 3625,
      "original_position" : 269,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 633963545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611952434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r622796211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/622796211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "More tests added in #21707",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-29T07:25:02Z",
      "diff_hunk" : "@@ -3566,20 +3622,20 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // to users' AddrMan and later request them by sending getaddr messages.\n         // Making nodes which are behind NAT and can only make outgoing connections ignore\n         // the getaddr message mitigates the attack.\n-        if (!pfrom.IsInboundConn()) {\n+        if (!RelayAddrsWithPeer(*peer)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r622796211",
      "id" : 622796211,
      "in_reply_to_id" : 611261881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMjc5NjIxMQ==",
      "original_commit_id" : "c538369123b6c69358649255815cf331b2c39f52",
      "original_line" : 3625,
      "original_position" : 269,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 647885360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/622796211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623430587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623430587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this assert seems unnecessary / not useful. the previous line returns early if `m_addr_known` is not present. ",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-29T21:59:42Z",
      "diff_hunk" : "@@ -4147,72 +4202,72 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::mic\n     }\n }\n \n-void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds current_time)\n+void PeerManagerImpl::MaybeSendAddr(CNode& node, Peer& peer, std::chrono::microseconds current_time)\n {\n     // Nothing to do for non-address-relay peers\n-    if (!node.RelayAddrsWithConn()) return;\n+    if (!RelayAddrsWithPeer(peer)) return;\n \n-    assert(node.m_addr_known);\n+    assert(peer.m_addr_known);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623430587",
      "id" : 623430587,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzQzMDU4Nw==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 4210,
      "original_position" : 253,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 648690068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623430587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623434604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623434604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "isn't this more like... \"The maximum number of addresses permitted in an ADDR message\"? because we also enforce on incoming ADDR messages. I'm not sure what the \"new\" is supposed to indicate in this comment. ",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-29T22:08:35Z",
      "diff_hunk" : "@@ -150,6 +150,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The maximum number of new addresses to relay to a peer in an ADDR message. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623434604",
      "id" : 623434604,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzQzNDYwNA==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 153,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 648690068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623434604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623440472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623440472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I know you just moved this comment, but s/implying/indicating? sending a message is pretty explicit =P  \r\n",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-29T22:22:05Z",
      "diff_hunk" : "@@ -210,6 +212,25 @@ struct Peer {\n     /** Whether a ping has been requested by the user */\n     std::atomic<bool> m_ping_queued{false};\n \n+    /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n+    std::vector<CAddress> vAddrToSend;\n+    /** Probabilistic filter of addresses that this peer already knows.\n+     *  Used to avoid relaying addresses to this peer more than once. */\n+    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Whether a getaddr request to this peer is outstanding. */\n+    bool fGetAddr{false};\n+    /** Guards address sending timers. */\n+    mutable Mutex m_addr_send_times_mutex;\n+    /** Time point to send the next ADDR message to this peer. */\n+    std::chrono::microseconds m_next_addr_send GUARDED_BY(m_addr_send_times_mutex){0};\n+    /** Time point to possibly re-announce our local address to this peer. */\n+    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(m_addr_send_times_mutex){0};\n+    /** Whether the peer has signaled support for receiving ADDRv2 (BIP155)\n+     *  messages, implying a preference to receive ADDRv2 instead of ADDR ones. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623440472",
      "id" : 623440472,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzQ0MDQ3Mg==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 229,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 648690068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623440472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623485685"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623485685"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm curious- why did you opt to make this a standalone function that takes in a peer vs a member on peer itself (like it previously was on CNode)? ",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-29T23:26:44Z",
      "diff_hunk" : "@@ -626,6 +650,39 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+static bool RelayAddrsWithPeer(const Peer& peer) { return peer.m_addr_known != nullptr; }\n+\n+/**\n+ * Whether the peer supports the address. For example, a peer that does not\n+ * implement BIP155 cannot receive Tor v3 addresses because it requires\n+ * ADDRv2 (BIP155) encoding.\n+ */\n+static bool IsAddrCompatible(const Peer& peer, const CAddress& addr)\n+{\n+    return peer.m_wants_addrv2 || addr.IsAddrV1Compatible();\n+}\n+\n+static void AddAddressKnown(Peer& peer, const CAddress& addr)\n+{\n+    assert(peer.m_addr_known);\n+    peer.m_addr_known->insert(addr.GetKey());\n+}\n+\n+static void PushAddress(Peer& peer, const CAddress& addr, FastRandomContext& insecure_rand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623485685",
      "id" : 623485685,
      "line" : 674,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzQ4NTY4NQ==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 674,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 90,
      "pull_request_review_id" : 648690068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623485685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623776939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623776939"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because `Peer` isn't a class. It's a data structure containing information about a Peer, which PeerManager acts on.\r\n\r\nI know the distinction is blurry in C++, but I think it's generally better to treat things as purely a data structure (which carries data that is acted on by external logic) or purely a class (where the data is private and internal logic exists behind well-defined public interface functions). Mixing the two, where some logic is contained within the object but external logic can also reach into the object and manipulate the data, is confusing.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-30T10:28:29Z",
      "diff_hunk" : "@@ -626,6 +650,39 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+static bool RelayAddrsWithPeer(const Peer& peer) { return peer.m_addr_known != nullptr; }\n+\n+/**\n+ * Whether the peer supports the address. For example, a peer that does not\n+ * implement BIP155 cannot receive Tor v3 addresses because it requires\n+ * ADDRv2 (BIP155) encoding.\n+ */\n+static bool IsAddrCompatible(const Peer& peer, const CAddress& addr)\n+{\n+    return peer.m_wants_addrv2 || addr.IsAddrV1Compatible();\n+}\n+\n+static void AddAddressKnown(Peer& peer, const CAddress& addr)\n+{\n+    assert(peer.m_addr_known);\n+    peer.m_addr_known->insert(addr.GetKey());\n+}\n+\n+static void PushAddress(Peer& peer, const CAddress& addr, FastRandomContext& insecure_rand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623776939",
      "id" : 623776939,
      "in_reply_to_id" : 623485685,
      "line" : 674,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzc3NjkzOQ==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 674,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 90,
      "pull_request_review_id" : 649085564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623776939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed!",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-30T10:28:52Z",
      "diff_hunk" : "@@ -210,6 +212,25 @@ struct Peer {\n     /** Whether a ping has been requested by the user */\n     std::atomic<bool> m_ping_queued{false};\n \n+    /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n+    std::vector<CAddress> vAddrToSend;\n+    /** Probabilistic filter of addresses that this peer already knows.\n+     *  Used to avoid relaying addresses to this peer more than once. */\n+    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Whether a getaddr request to this peer is outstanding. */\n+    bool fGetAddr{false};\n+    /** Guards address sending timers. */\n+    mutable Mutex m_addr_send_times_mutex;\n+    /** Time point to send the next ADDR message to this peer. */\n+    std::chrono::microseconds m_next_addr_send GUARDED_BY(m_addr_send_times_mutex){0};\n+    /** Time point to possibly re-announce our local address to this peer. */\n+    std::chrono::microseconds m_next_local_addr_send GUARDED_BY(m_addr_send_times_mutex){0};\n+    /** Whether the peer has signaled support for receiving ADDRv2 (BIP155)\n+     *  messages, implying a preference to receive ADDRv2 instead of ADDR ones. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777163",
      "id" : 623777163,
      "in_reply_to_id" : 623440472,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzc3NzE2Mw==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 229,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 649085820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Much better. Thanks.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-30T10:28:54Z",
      "diff_hunk" : "@@ -150,6 +150,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The maximum number of new addresses to relay to a peer in an ADDR message. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777176",
      "id" : 623777176,
      "in_reply_to_id" : 623434604,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzc3NzE3Ng==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 153,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 649085841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point. Removed!",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-30T10:28:55Z",
      "diff_hunk" : "@@ -4147,72 +4202,72 @@ void PeerManagerImpl::MaybeSendPing(CNode& node_to, Peer& peer, std::chrono::mic\n     }\n }\n \n-void PeerManagerImpl::MaybeSendAddr(CNode& node, std::chrono::microseconds current_time)\n+void PeerManagerImpl::MaybeSendAddr(CNode& node, Peer& peer, std::chrono::microseconds current_time)\n {\n     // Nothing to do for non-address-relay peers\n-    if (!node.RelayAddrsWithConn()) return;\n+    if (!RelayAddrsWithPeer(peer)) return;\n \n-    assert(node.m_addr_known);\n+    assert(peer.m_addr_known);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777191",
      "id" : 623777191,
      "in_reply_to_id" : 623430587,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzc3NzE5MQ==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 4210,
      "original_position" : 253,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 649085859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777241"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-30T10:29:00Z",
      "diff_hunk" : "@@ -617,6 +652,39 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+static bool RelayAddrsWithPeer(const Peer& peer) { return peer.m_addr_known != nullptr; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r623777241",
      "id" : 623777241,
      "in_reply_to_id" : 605911247,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzc3NzI0MQ==",
      "original_commit_id" : "468db1469382ee11380f0667454b86ec1903eca8",
      "original_line" : 653,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 649085926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T10:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/623777241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the reviews @ajtowns and @amitiuttarwar. I've addressed all of your comments.\r\n\r\n> The \"Move addr relay data and logic into net processing\" commit is doing a lot of things, and I think that makes it a bit hard to review (and leads to rebase errors?). Might be worth putting a bit of effort into splitting it up further if some of the changes can be isolated?\r\n\r\nI did try that at one point, but it seemed more confusing/difficult than just moving across the addr data/logic in one commit.",
      "created_at" : "2021-04-30T10:40:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-830006829",
      "id" : 830006829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMDAwNjgyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-30T10:40:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/830006829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-04-30T15:53:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-830190747",
      "id" : 830190747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMDE5MDc0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-30T15:53:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/830190747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r624181122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/624181122"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok gotcha, thanks!",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-04-30T20:35:33Z",
      "diff_hunk" : "@@ -626,6 +650,39 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+static bool RelayAddrsWithPeer(const Peer& peer) { return peer.m_addr_known != nullptr; }\n+\n+/**\n+ * Whether the peer supports the address. For example, a peer that does not\n+ * implement BIP155 cannot receive Tor v3 addresses because it requires\n+ * ADDRv2 (BIP155) encoding.\n+ */\n+static bool IsAddrCompatible(const Peer& peer, const CAddress& addr)\n+{\n+    return peer.m_wants_addrv2 || addr.IsAddrV1Compatible();\n+}\n+\n+static void AddAddressKnown(Peer& peer, const CAddress& addr)\n+{\n+    assert(peer.m_addr_known);\n+    peer.m_addr_known->insert(addr.GetKey());\n+}\n+\n+static void PushAddress(Peer& peer, const CAddress& addr, FastRandomContext& insecure_rand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r624181122",
      "id" : 624181122,
      "in_reply_to_id" : 623485685,
      "line" : 674,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNDE4MTEyMg==",
      "original_commit_id" : "7741ca59593361c51df48e2b83500a3e2dae8563",
      "original_line" : 674,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 90,
      "pull_request_review_id" : 649602010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-30T20:35:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/624181122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\n @sipa has been requested to review this pull request as specified in the REVIEWERS file.",
      "created_at" : "2021-05-03T09:33:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-831142655",
      "id" : 831142655,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMTE0MjY1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-03T09:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/831142655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-05-19T11:57:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-844031773",
      "id" : 844031773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NDAzMTc3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-19T11:57:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/844031773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-05-20T19:11:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-845405200",
      "id" : 845405200,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NTQwNTIwMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-20T19:11:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/845405200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 0829516d1f3868c1c2ba507feee718325d81e329, reviewed the code and ran tests.",
      "created_at" : "2021-05-20T21:07:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#issuecomment-845477302",
      "id" : 845477302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21186",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NTQ3NzMwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-20T21:07:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/845477302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r637227476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/637227476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Using `!IsBlockOnlyConn()` as proxy for \"should we relay addresses\" goes a bit in the opposite direction as the earlier connection types refactors went in. Any reason not just keep the function name (I realize there's a derived one with that name added, but it's ultimately still relying on this test.\r\n\r\nI don't have a particularly strong opinion here; I'm just noticing some flipflopping.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-05-21T20:54:51Z",
      "diff_hunk" : "@@ -954,7 +1014,9 @@ void PeerManagerImpl::InitializeNode(CNode *pnode)\n         assert(m_txrequest.Count(nodeid) == 0);\n     }\n     {\n-        PeerRef peer = std::make_shared<Peer>(nodeid);\n+        // Addr relay is disabled for outbound block-relay-only peers to\n+        // prevent adversaries from inferring these links from addr traffic.\n+        PeerRef peer = std::make_shared<Peer>(nodeid, /* addr_relay = */ !pnode->IsBlockOnlyConn());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r637227476",
      "id" : 637227476,
      "line" : 1019,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzIyNzQ3Ng==",
      "original_commit_id" : "76568a3351418c878d30ba0373cf76988f93f90e",
      "original_line" : 1019,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 115,
      "pull_request_review_id" : 665881137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-21T21:07:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/637227476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r637869571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/637869571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This logic of checking `IsBlockOnlyConn()` is used only when calling the `Peer` ctor. After that, we use the `RelayAddrsWithPeer()`, which replaces the old `RelayAddrsWithConn()` function. That's a clearer separation between net and net_processing since we only check the connection type when initializing the Peer object.",
      "commit_id" : "0829516d1f3868c1c2ba507feee718325d81e329",
      "created_at" : "2021-05-24T11:11:19Z",
      "diff_hunk" : "@@ -954,7 +1014,9 @@ void PeerManagerImpl::InitializeNode(CNode *pnode)\n         assert(m_txrequest.Count(nodeid) == 0);\n     }\n     {\n-        PeerRef peer = std::make_shared<Peer>(nodeid);\n+        // Addr relay is disabled for outbound block-relay-only peers to\n+        // prevent adversaries from inferring these links from addr traffic.\n+        PeerRef peer = std::make_shared<Peer>(nodeid, /* addr_relay = */ !pnode->IsBlockOnlyConn());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21186#discussion_r637869571",
      "id" : 637869571,
      "in_reply_to_id" : 637227476,
      "line" : 1019,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNzg2OTU3MQ==",
      "original_commit_id" : "76568a3351418c878d30ba0373cf76988f93f90e",
      "original_line" : 1019,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 115,
      "pull_request_review_id" : 666635127,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21186",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T11:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/637869571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
