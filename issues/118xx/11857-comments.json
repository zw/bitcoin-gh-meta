[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r155908730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/155908730"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Instead of blocking, give 503?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-09T01:32:57Z",
      "diff_hunk" : "@@ -350,6 +351,10 @@ static bool rest_tx(HTTPRequest* req, const std::string& strURIPart)\n     if (!ParseHashStr(hashStr, hash))\n         return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid hash: \" + hashStr);\n \n+    if (g_txindex) {\n+        g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r155908730",
      "id" : 155908730,
      "original_commit_id" : "ae276cead580e459d881db5b7439b618ec0854a6",
      "original_position" : 13,
      "path" : "src/rest.cpp",
      "position" : 13,
      "pull_request_review_id" : 82311538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/155908730",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r155915071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/155915071"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Comment incomplete or outdated?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-09T06:51:20Z",
      "diff_hunk" : "@@ -1426,9 +1433,9 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n \n                 if (fRequestShutdown) break;\n \n-                // LoadBlockIndex will load fTxIndex from the db, or set it if\n+                // LoadBlockIndex will load fHavePruned if we've ever removed a",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r155915071",
      "id" : 155915071,
      "original_commit_id" : "ae276cead580e459d881db5b7439b618ec0854a6",
      "original_position" : 33,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 82318411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/155915071",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "High-Level Concept ACK. As for your two notes:\r\n\r\n> an alternative would be to split the txindex into a separate DB and do a data migration on upgrade.\r\n\r\nI'd vote strongly for this. Keeping them separate is good.\r\n\r\n> though it may be fine to just do the TxIndex write directly in the BlockConnected method.\r\n\r\nYes, I think you should just do this. I'd like to move the CValidationInterface semantics to no longer be a single thread run on the scheduler but instead multiple scheduler threads that process events and only guarantee order for individual clients instead of globally.",
      "created_at" : "2017-12-09T16:03:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-350481060",
      "id" : 350481060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2017-12-09T16:03:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/350481060",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r155936523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/155936523"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Move after Init?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-10T01:58:23Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <future>\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(const std::shared_ptr<CBlockTreeDB>& db) :\n+    m_db(db), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadTxIndexBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (!best_block_hash.IsNull()) {\n+        auto it = mapBlockIndex.find(best_block_hash);\n+        if (it == mapBlockIndex.end()) {\n+            FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+            return false;\n+        }\n+\n+        const auto pindex = it->second;\n+        m_best_block_index = pindex;\n+\n+        auto chain_tip = chainActive.Tip();\n+        if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            m_synced = true;\n+        }\n+\n+        return true;\n+    }\n+\n+    auto chain_tip = chainActive.Tip();\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index;\n+    m_db->ReadFlag(\"txindex\", f_migrate_index);\n+    if (f_migrate_index) {\n+        m_best_block_index = chain_tip;\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        LogPrintf(\"Syncing txindex with block chain from height %d\\n\",\n+                  pindex ? pindex->nHeight + 1 : 0);\n+\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxIndex(vPos, pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    {\n+        LOCK(cs_main);\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",\n+                       __func__, pindex->GetBlockHash().ToString(),\n+                       best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip()...\n+        LOCK(cs_main);\n+        auto chain_tip = chainActive.Tip();\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    // ...otherwise put a callback in the validation interface queue and wait\n+    // for the queue to drain enough to execute it (indicating we are caught up\n+    // at least with the time we entered this function).\n+    std::promise<void> promise;\n+    CallFunctionInValidationInterfaceQueue([&promise] {\n+        promise.set_value();\n+    });\n+    promise.get_future().wait();\n+\n+    return true;\n+}\n+\n+bool TxIndex::FindTx(const uint256& txid, CDiskTxPos& pos) const\n+{\n+    return m_db->ReadTxIndex(txid, pos);\n+}\n+\n+void TxIndex::Interrupt()\n+{\n+    m_interrupt();\n+}\n+\n+void TxIndex::Start()\n+{\n+    RegisterValidationInterface(this);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r155936523",
      "id" : 155936523,
      "original_commit_id" : "41022ec2770d328c55191f8b1bc36b750e46f9a0",
      "original_position" : 226,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 82339759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/155936523",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156239136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156239136"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, this has to be registered before `m_synced` is set to true in Init.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-12T00:11:43Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <future>\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(const std::shared_ptr<CBlockTreeDB>& db) :\n+    m_db(db), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadTxIndexBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (!best_block_hash.IsNull()) {\n+        auto it = mapBlockIndex.find(best_block_hash);\n+        if (it == mapBlockIndex.end()) {\n+            FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+            return false;\n+        }\n+\n+        const auto pindex = it->second;\n+        m_best_block_index = pindex;\n+\n+        auto chain_tip = chainActive.Tip();\n+        if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            m_synced = true;\n+        }\n+\n+        return true;\n+    }\n+\n+    auto chain_tip = chainActive.Tip();\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index;\n+    m_db->ReadFlag(\"txindex\", f_migrate_index);\n+    if (f_migrate_index) {\n+        m_best_block_index = chain_tip;\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        LogPrintf(\"Syncing txindex with block chain from height %d\\n\",\n+                  pindex ? pindex->nHeight + 1 : 0);\n+\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxIndex(vPos, pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    {\n+        LOCK(cs_main);\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",\n+                       __func__, pindex->GetBlockHash().ToString(),\n+                       best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip()...\n+        LOCK(cs_main);\n+        auto chain_tip = chainActive.Tip();\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    // ...otherwise put a callback in the validation interface queue and wait\n+    // for the queue to drain enough to execute it (indicating we are caught up\n+    // at least with the time we entered this function).\n+    std::promise<void> promise;\n+    CallFunctionInValidationInterfaceQueue([&promise] {\n+        promise.set_value();\n+    });\n+    promise.get_future().wait();\n+\n+    return true;\n+}\n+\n+bool TxIndex::FindTx(const uint256& txid, CDiskTxPos& pos) const\n+{\n+    return m_db->ReadTxIndex(txid, pos);\n+}\n+\n+void TxIndex::Interrupt()\n+{\n+    m_interrupt();\n+}\n+\n+void TxIndex::Start()\n+{\n+    RegisterValidationInterface(this);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156239136",
      "id" : 156239136,
      "in_reply_to_id" : 155936523,
      "original_commit_id" : "41022ec2770d328c55191f8b1bc36b750e46f9a0",
      "original_position" : 226,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 82684125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156239136",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156239250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156239250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's not really unavailable, just that the background process needs to catch up, which should happen quickly.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-12T00:12:34Z",
      "diff_hunk" : "@@ -350,6 +351,10 @@ static bool rest_tx(HTTPRequest* req, const std::string& strURIPart)\n     if (!ParseHashStr(hashStr, hash))\n         return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid hash: \" + hashStr);\n \n+    if (g_txindex) {\n+        g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156239250",
      "id" : 156239250,
      "in_reply_to_id" : 155908730,
      "original_commit_id" : "ae276cead580e459d881db5b7439b618ec0854a6",
      "original_position" : 13,
      "path" : "src/rest.cpp",
      "position" : 13,
      "pull_request_review_id" : 82684252,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156239250",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156541766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156541766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, fixed.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-13T01:14:22Z",
      "diff_hunk" : "@@ -1426,9 +1433,9 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n \n                 if (fRequestShutdown) break;\n \n-                // LoadBlockIndex will load fTxIndex from the db, or set it if\n+                // LoadBlockIndex will load fHavePruned if we've ever removed a",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156541766",
      "id" : 156541766,
      "in_reply_to_id" : 155915071,
      "original_commit_id" : "ae276cead580e459d881db5b7439b618ec0854a6",
      "original_position" : 33,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 83036066,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156541766",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Concept ACK\r\n\r\n> an alternative would be to split the txindex into a separate DB and do a data migration on upgrade.\r\n\r\nI agree that would be preferable (though not necessarily in this PR, I don't think the scope here should be extended further).  The transaction index has a completely different access pattern from the block index. This came up in #10922 and other places.\r\n\r\nAlso for safety and flexibility it would be good to have separate indexers, and to not have it integrated into consensus-critical block handling.",
      "created_at" : "2017-12-13T07:37:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-351308356",
      "id" : 351308356,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2017-12-13T07:59:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351308356",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not actaully sure that its unrelated - currently txindex is required to be kept in-sync and be present in the block tree DB before the coins for a block are flushed to the utxodb. Moving it to the background without bending over backwards to keep things in-sync would result in \"corrupt\" (I assume just missing entries) tx index in some cases on downgrade. Its not a huge deal, but I think moving the txindex into a separate DB would be really nice to do before (or in the same PR) things are background-flushed.",
      "created_at" : "2017-12-13T16:58:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-351453993",
      "id" : 351453993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2017-12-13T16:58:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351453993",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@TheBlueMatt @laanwj I updated this PR to split the database and added a migration. The migration took ~103 min on an AWS m4.large with data on a gp2 EBS volume (non-local SSD). So that's kind of painful. I could change the migration to happen in the background thread, but the UX might be weird for people upgrading because the RPC endpoint would report that the txindex is catching up. Open to suggestions here.",
      "created_at" : "2017-12-13T17:42:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-351467099",
      "id" : 351467099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2017-12-13T17:44:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351467099",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems to be missing migration (forget to push?). Doing migration in the background after start seems fine, better to wait with most things working than it just hanging startup, just have to make sure it doesn't overwrite new entries or you'd end up pointing to a reorg'd-out block's copy (though I think thats probably not technically a problem, it seems strange).\r\n\r\nAs for threading, it would be really nice to have the flushing for new blocks happen directly in the scheduler/validation interface threading, with the upgrade either in the init thread at the end (it just hangs around for the entire program's execution waiting for shutdown to start, so as long as the migration is interruptible that'd be a fine place for it) or a new thread.",
      "created_at" : "2017-12-13T18:54:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-351487094",
      "id" : 351487094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2017-12-13T18:54:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351487094",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@TheBlueMatt Migration is here: https://github.com/bitcoin/bitcoin/pull/11857/commits/a252d466ca0c44a455051d01c43e50e15643c423#diff-81e4f16a1b5d5b7ca25351a63d07cb80R446. Called from `Start()`, though it could be moved to `ThreadSync` (the dedicated thread for the txindex initial sync).\r\n\r\nI also changed the new block flushing to happen directly in the `BlockConnected` callback as you suggested.",
      "created_at" : "2017-12-13T20:10:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-351507915",
      "id" : 351507915,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2017-12-13T20:10:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351507915",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156770888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156770888"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Separating these if statements loses coherency - if we crash we may have a bogus txindex and no way to detect it. Should likely instead do if (batch_newdb.SizeEstimate() + batch_olddb.SizeEstimate() > batch_size)........",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-13T20:16:59Z",
      "diff_hunk" : "@@ -424,3 +425,129 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n+    if (Read(DB_BEST_BLOCK, hash)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        hash.SetNull();\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool TxIndexDB::WriteBestBlockHash(const uint256& hash) {\n+    return Write(DB_BEST_BLOCK, hash);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            break;\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);\n+            batch_newdb.Clear();\n+            CompactRange(prev_key_newdb, key);\n+            prev_key_newdb = key;\n+        }\n+        if (batch_olddb.SizeEstimate() > batch_size) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156770888",
      "id" : 156770888,
      "original_commit_id" : "e95ed5ac89e1393f44c32a3ee5d026c1088477f1",
      "original_position" : 110,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 83303997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156770888",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156804378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156804378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2017-12-13T22:26:59Z",
      "diff_hunk" : "@@ -424,3 +425,129 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n+    if (Read(DB_BEST_BLOCK, hash)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        hash.SetNull();\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool TxIndexDB::WriteBestBlockHash(const uint256& hash) {\n+    return Write(DB_BEST_BLOCK, hash);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            break;\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);\n+            batch_newdb.Clear();\n+            CompactRange(prev_key_newdb, key);\n+            prev_key_newdb = key;\n+        }\n+        if (batch_olddb.SizeEstimate() > batch_size) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r156804378",
      "id" : 156804378,
      "in_reply_to_id" : 156770888,
      "original_commit_id" : "e95ed5ac89e1393f44c32a3ee5d026c1088477f1",
      "original_position" : 110,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 83341524,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/156804378",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159895945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159895945"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nMaybe change to `const auto& tuple` to avoid a copy while iterating.\r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T15:01:03Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159895945",
      "id" : 159895945,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 17,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159895945",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159897305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159897305"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nMaybe declare const and add comment (16MiB).",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T15:06:43Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159897305",
      "id" : 159897305,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 37,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159897305",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159897839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159897839"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nMaybe log an error in this case. I don't think it would be expected for pcursor->Valid() to return true but pcursor->GetKey to fail.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T15:09:28Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159897839",
      "id" : 159897839,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 54,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159897839",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159900328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159900328"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nThis is duplicating code inside the for loop, and also skipping the last compact range on the old db. Maybe just flush and compact once at the top of the loop:\r\n\r\n```c++\r\nfor (pcursor->Seek(begin_key);; pcursor->Next()) {\r\n    if (!pcursor->Valid() || batch_newdb.SizeEstimate()...) {\r\n        ...flush and compact...\r\n    }\r\n    if (!pcursor->Valid()) break;\r\n    ...move entry at cursor...\r\n}\r\n```\r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T15:20:13Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            break;\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size || batch_olddb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);\n+            batch_newdb.Clear();\n+            CompactRange(prev_key_newdb, key);\n+            prev_key_newdb = key;\n+\n+            block_tree_db.WriteBatch(batch_olddb);\n+            batch_olddb.Clear();\n+            block_tree_db.CompactRange(prev_key_olddb, key);\n+            prev_key_olddb = key;\n+        }\n+    }\n+\n+    WriteBatch(batch_newdb);\n+    CompactRange(begin_key, key);\n+    block_tree_db.WriteBatch(batch_olddb);\n+    block_tree_db.CompactRange(begin_key, key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159900328",
      "id" : 159900328,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 94,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159900328",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159901942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159901942"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nUnclear why migration should be tied to txindex flag. At first glance, it would seem simpler to reason about possible states and also more robust if the code just always moved DB_TXINDEX entries from the old location to the new location independent of the flag. Maybe add a code comment here to clarify rationale.\r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T15:26:46Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159901942",
      "id" : 159901942,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 25,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159901942",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159904033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159904033"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Methods on TxIndexDB to persist best block hash. \"\r\n\r\nIs this a mistake? Probably shouldn't be adding an unused parameter to an unrelated method in this commit.\r\n  \r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T15:34:31Z",
      "diff_hunk" : "@@ -142,9 +142,15 @@ class TxIndexDB : public CDBWrapper\n     /// Write a batch of transaction positions to the DB.\n     bool WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos);\n \n+    /// Read the best block hash of the chain that the txindex is in sync with.\n+    bool ReadBestBlockHash(uint256& hash) const;\n+\n+    /// Write the best block hash of the chain that the txindex is in sync with.\n+    bool WriteBestBlockHash(const uint256& block_hash);\n+\n     /// Migrate txindex data from the block tree DB, where it may be for older nodes that have not\n     /// been upgraded yet to the new database.\n-    bool MigrateData(CBlockTreeDB& block_tree_db);\n+    bool MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159904033",
      "id" : 159904033,
      "original_commit_id" : "0f77eab3cedfbf9e75ce8c15fc837da09a1cb952",
      "original_position" : 13,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159904033",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159912603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159912603"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nMaybe restructure the code to get rid of this early successful return. It's a little confusing, and also not clear if it's 100% correct. For example I would think that if best_block_hash and chain_tip are both null, m_synced should still be set to true below.\r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T16:07:29Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159912603",
      "id" : 159912603,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 49,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159912603",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159913072"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159913072"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nCould `const auto&` to avoid a copy.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T16:09:29Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (!chain_tip || pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159913072",
      "id" : 159913072,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 73,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159913072",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159915333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159915333"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nConsider moving WriteBestBlockHash call out to caller so the stored best block and m_best_block_index get updated together. It's a little unexpected to see one value written without the other. Might want to rename this method to `WriteBlockTxns` if you do this.\r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T16:19:07Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (!chain_tip || pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159915333",
      "id" : 159915333,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 77,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159915333",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159915638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159915638"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\n>No, this has to be registered before m_synced is set to true in Init.\r\n\r\nDefinitely worth noting this in a code comment. Also maybe m_synced should be called m_initialized or m_started to be clearer that it changes from false to true just once on startup, and isn't updated in an ongoing way.\r\n\r\n  \r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T16:20:16Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <future>\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(const std::shared_ptr<CBlockTreeDB>& db) :\n+    m_db(db), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadTxIndexBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (!best_block_hash.IsNull()) {\n+        auto it = mapBlockIndex.find(best_block_hash);\n+        if (it == mapBlockIndex.end()) {\n+            FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+            return false;\n+        }\n+\n+        const auto pindex = it->second;\n+        m_best_block_index = pindex;\n+\n+        auto chain_tip = chainActive.Tip();\n+        if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            m_synced = true;\n+        }\n+\n+        return true;\n+    }\n+\n+    auto chain_tip = chainActive.Tip();\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index;\n+    m_db->ReadFlag(\"txindex\", f_migrate_index);\n+    if (f_migrate_index) {\n+        m_best_block_index = chain_tip;\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        LogPrintf(\"Syncing txindex with block chain from height %d\\n\",\n+                  pindex ? pindex->nHeight + 1 : 0);\n+\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxIndex(vPos, pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    {\n+        LOCK(cs_main);\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",\n+                       __func__, pindex->GetBlockHash().ToString(),\n+                       best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip()...\n+        LOCK(cs_main);\n+        auto chain_tip = chainActive.Tip();\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    // ...otherwise put a callback in the validation interface queue and wait\n+    // for the queue to drain enough to execute it (indicating we are caught up\n+    // at least with the time we entered this function).\n+    std::promise<void> promise;\n+    CallFunctionInValidationInterfaceQueue([&promise] {\n+        promise.set_value();\n+    });\n+    promise.get_future().wait();\n+\n+    return true;\n+}\n+\n+bool TxIndex::FindTx(const uint256& txid, CDiskTxPos& pos) const\n+{\n+    return m_db->ReadTxIndex(txid, pos);\n+}\n+\n+void TxIndex::Interrupt()\n+{\n+    m_interrupt();\n+}\n+\n+void TxIndex::Start()\n+{\n+    RegisterValidationInterface(this);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159915638",
      "id" : 159915638,
      "in_reply_to_id" : 155936523,
      "original_commit_id" : "41022ec2770d328c55191f8b1bc36b750e46f9a0",
      "original_position" : 226,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159915638",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159917226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159917226"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nWhy use a different code for DB_TXINDEX_BEST_BLOCK than DB_BEST_BLOCK? Why even define a new constant at all? It seems strange that the new txindex format would diverge unnecessarily from the old format here when it isn't doing do that in other places. Should add a code comment explaining if there is a reason.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T16:27:02Z",
      "diff_hunk" : "@@ -29,6 +29,7 @@ static const char DB_HEAD_BLOCKS = 'H';\n static const char DB_FLAG = 'F';\n static const char DB_REINDEX_FLAG = 'R';\n static const char DB_LAST_BLOCK = 'l';\n+static const char DB_TXINDEX_BEST_BLOCK = 'T';",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159917226",
      "id" : 159917226,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 4,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159917226",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159923255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159923255"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nI'm not sure this case and the one above should be errors given that BlockConnected calls are queued up in the notification thread and may not be up to date with chainActive (which is what ThreadSync syncs toward). Seems like it would be right (and simpler) to just call WriteBlock unconditionally here.\r\n  \r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-05T16:50:18Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (!chain_tip || pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    auto best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159923255",
      "id" : 159923255,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 97,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 86924561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/159923255",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160286747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160286747"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, I moved the check for null `chain_tip` up to fix that case. However, I still think the early return here is necessary.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:50:25Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160286747",
      "id" : 160286747,
      "in_reply_to_id" : 159912603,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 49,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 87376715,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160286747",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160286762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160286762"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:50:32Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (!chain_tip || pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160286762",
      "id" : 160286762,
      "in_reply_to_id" : 159913072,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 73,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 87376736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160286762",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287005"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This isn't checking against chainActive, it is just asserting that BlockConnected gets called with blocks in order (even if chainActive is ahead). It's important to note that if the BlockConnected callbacks are running, then `m_synced` is true an `ThreadSync` has exited. I added more comments to these fields/methods in the header file to hopefully make that more clear.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:52:05Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (!chain_tip || pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    auto best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287005",
      "id" : 160287005,
      "in_reply_to_id" : 159923255,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 97,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 87376999,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287005",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287130"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, that wasn't even used. Left over from a previous version where the database wasn't split out.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:52:59Z",
      "diff_hunk" : "@@ -29,6 +29,7 @@ static const char DB_HEAD_BLOCKS = 'H';\n static const char DB_FLAG = 'F';\n static const char DB_REINDEX_FLAG = 'R';\n static const char DB_LAST_BLOCK = 'l';\n+static const char DB_TXINDEX_BEST_BLOCK = 'T';",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287130",
      "id" : 160287130,
      "in_reply_to_id" : 159917226,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 4,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 87377151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287130",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287161"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287161"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:53:09Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287161",
      "id" : 160287161,
      "in_reply_to_id" : 159895945,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 17,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 87377189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287161",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287269"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I elaborated on the comment. I think this is the best way to determine whether a migration is necessary. LMK if you think it needs further explanation.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:54:02Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287269",
      "id" : 160287269,
      "in_reply_to_id" : 159901942,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 25,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 87377320,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287269",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287498"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:55:47Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287498",
      "id" : 160287498,
      "in_reply_to_id" : 159897305,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 37,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 87377606,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287498",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287605"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you are right that this should never happen, so I opted to return an error instead of logging and completing the migration.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:56:38Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287605",
      "id" : 160287605,
      "in_reply_to_id" : 159897839,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 54,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 87377744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287605",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287986"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, the logic gets kind of tricky since there's also the early break if the cursor is valid but iterates past the DB_TXINDEX range. Also the CompactRange after the loop compacts over the entire range, not just from the previous batch write point. What do you mean that it skips the last compact range on the old DB? It shouldn't.\r\n\r\nThis code was mostly copied from `CCoinsViewDB::Upgrade` if that wasn't clear.\r\n  ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-08T23:59:25Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            break;\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size || batch_olddb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);\n+            batch_newdb.Clear();\n+            CompactRange(prev_key_newdb, key);\n+            prev_key_newdb = key;\n+\n+            block_tree_db.WriteBatch(batch_olddb);\n+            batch_olddb.Clear();\n+            block_tree_db.CompactRange(prev_key_olddb, key);\n+            prev_key_olddb = key;\n+        }\n+    }\n+\n+    WriteBatch(batch_newdb);\n+    CompactRange(begin_key, key);\n+    block_tree_db.WriteBatch(batch_olddb);\n+    block_tree_db.CompactRange(begin_key, key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160287986",
      "id" : 160287986,
      "in_reply_to_id" : 159900328,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 94,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 87378208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160287986",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160288280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160288280"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It does get used. The `MigrateData` implementation is modified to write the block hash in this commit before deleting the txindex flag from the old DB.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-09T00:01:43Z",
      "diff_hunk" : "@@ -142,9 +142,15 @@ class TxIndexDB : public CDBWrapper\n     /// Write a batch of transaction positions to the DB.\n     bool WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos);\n \n+    /// Read the best block hash of the chain that the txindex is in sync with.\n+    bool ReadBestBlockHash(uint256& hash) const;\n+\n+    /// Write the best block hash of the chain that the txindex is in sync with.\n+    bool WriteBestBlockHash(const uint256& block_hash);\n+\n     /// Migrate txindex data from the block tree DB, where it may be for older nodes that have not\n     /// been upgraded yet to the new database.\n-    bool MigrateData(CBlockTreeDB& block_tree_db);\n+    bool MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160288280",
      "id" : 160288280,
      "in_reply_to_id" : 159904033,
      "original_commit_id" : "0f77eab3cedfbf9e75ce8c15fc837da09a1cb952",
      "original_position" : 13,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 87378587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160288280",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160288890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160288890"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I kind of prefer to keep the DB writes together. I'd hoped that the access pattern would make it clear:\r\n\r\n```c++\r\nif (WriteBlock(*block, pindex)) {\r\n    m_best_block_index = pindex;\r\n}\r\n```",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-09T00:06:21Z",
      "diff_hunk" : "@@ -0,0 +1,129 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (!chain_tip || pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (auto tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r160288890",
      "id" : 160288890,
      "in_reply_to_id" : 159915333,
      "original_commit_id" : "669d39e0df5b74fcac11a5055567eefd2f46ce8c",
      "original_position" : 77,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 87379326,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/160288890",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r161027360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/161027360"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/11857#discussion_r159901942\r\n\r\n>> Unclear why migration should be tied to txindex flag. At first glance, it would seem simpler to reason about possible states and also more robust if the code just always moved DB_TXINDEX entries from the old location to the new location independent of the flag. Maybe add a code comment here to clarify rationale.\r\n\r\n> I elaborated on the comment. I think this is the best way to determine whether a migration is necessary. LMK if you think it needs further explanation.\r\n\r\nThis still doesn't seem to be saying why the flag needs to be checked. Maybe add \"Do not migrate data if the txindex flag is false, because any data that is found will be stale and not in sync with DB_BEST_BLOCK\" to the comment if that's the explanation.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-01-11T17:49:21Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r161027360",
      "id" : 161027360,
      "in_reply_to_id" : 159901942,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 25,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/161027360",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Needs rebase (probably a simple one, only init.cpp conflicted).",
      "created_at" : "2018-02-08T18:50:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-364211135",
      "id" : 364211135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-02-08T18:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364211135",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167242419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167242419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should this have a distinct error code, rather than `RPC_INVALID_ADDRESS_OR_KEY`? If I understand correctly, an RPC consumer should wait a little and try again if this happens. ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-02-09T14:35:04Z",
      "diff_hunk" : "@@ -177,10 +183,12 @@ UniValue getrawtransaction(const JSONRPCRequest& request)\n                 throw JSONRPCError(RPC_MISC_ERROR, \"Block not available\");\n             }\n             errmsg = \"No such transaction found in the provided block\";\n+        } else if (!g_txindex) {\n+            errmsg = \"No such mempool transaction. Use -txindex to enable blockchain transaction queries\";\n+        } else if (!f_txindex_ready) {\n+            errmsg = \"No such mempool transaction. Blockchain transactions are still in the process of being indexed\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167242419",
      "id" : 167242419,
      "original_commit_id" : "c4401fc41422daa17df46e5945c35a55c1e0e8bd",
      "original_position" : 45,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 54,
      "pull_request_review_id" : 95437789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167242419",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167244773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167244773"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If it really takes 103 minutes on a fast EC2 instance, maybe make it 1%? Or once a minute? QT already shows 1% intervals during the upgrade.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-02-09T14:43:16Z",
      "diff_hunk" : "@@ -424,3 +424,132 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n+    if (Read(DB_BEST_BLOCK, hash)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        hash.SetNull();\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool TxIndexDB::WriteBestBlockHash(const uint256& hash) {\n+    return Write(DB_BEST_BLOCK, hash);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. If the flag is not\n+    // set, txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            return error(\"%s: cannot get key from valid cursor\", __func__);\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167244773",
      "id" : 167244773,
      "original_commit_id" : "c4401fc41422daa17df46e5945c35a55c1e0e8bd",
      "original_position" : 81,
      "path" : "src/txdb.cpp",
      "position" : 131,
      "pull_request_review_id" : 95437789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167244773",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I also noticed that `indexes` isn't emptied if you set `txindex=0`. That's probably a good thing, e.g. perhaps someone doesn't want to read / update them for a while, but should be documented.\r\n\r\nI was able to reproduce the \"Error opening block database\" QT error (on master) after a fresh reindex (on this branch). No need to use bitcoind to make it go away, simply launch with `-reindex`. That shouldn't be necessary. \r\n\r\nThis also seems to happens on master so might be unrelated:\r\n\r\n```\r\n2018-02-09 16:23:44 init message: Loading block index...\r\n2018-02-09 16:23:44 Wiping LevelDB in /Users/bitcoin/Library/Application Support/Bitcoin/testnet3/blocks/index\r\n2018-02-09 16:23:44 IO error: lock /Users/bitcoin/Library/Application Support/Bitcoin/testnet3/blocks/index/LOCK: already held by process\r\n2018-02-09 16:23:44 Database I/O error\r\n```",
      "created_at" : "2018-02-09T16:15:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-364479759",
      "id" : 364479759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-02-09T16:31:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364479759",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I was comparing the wrong directory sizes above. `chainstate` is for the UTXO set, `txindex` is in `blocks/index` (on master).\r\n\r\nAlso the error I was seeing was unrelated, and hopefully fixed in #12401  ",
      "created_at" : "2018-02-09T19:01:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-364527179",
      "id" : 364527179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-02-09T19:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364527179",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167342688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167342688"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, that's right, an RPC consumer should wait until the index is built. Using the `RPC_INVALID_ADDRESS_OR_KEY` error code for the `\"No such mempool transaction. Use -txindex to enable blockchain transaction queries\"` clause also seems odd to me.\r\n\r\nPerhaps the `RPC_IN_WARMUP` makes sense here, or perhaps a new `RPC_INDEX_UNAVAILABLE` error code.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-02-09T20:50:19Z",
      "diff_hunk" : "@@ -177,10 +183,12 @@ UniValue getrawtransaction(const JSONRPCRequest& request)\n                 throw JSONRPCError(RPC_MISC_ERROR, \"Block not available\");\n             }\n             errmsg = \"No such transaction found in the provided block\";\n+        } else if (!g_txindex) {\n+            errmsg = \"No such mempool transaction. Use -txindex to enable blockchain transaction queries\";\n+        } else if (!f_txindex_ready) {\n+            errmsg = \"No such mempool transaction. Blockchain transactions are still in the process of being indexed\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167342688",
      "id" : 167342688,
      "in_reply_to_id" : 167242419,
      "original_commit_id" : "c4401fc41422daa17df46e5945c35a55c1e0e8bd",
      "original_position" : 45,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 54,
      "pull_request_review_id" : 95558369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167342688",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167346079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167346079"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The percentage shown in the UI is updated with every percent, it's just the log line that shows increments of 10, as it appends to the same line: `[0%]...[10%]...[20%...]`. Alternatively, it could log progress on a separate line every 30 seconds or something like: \"Upgrading txindex database: n% complete\\n\". I kind of prefer that approach, but I copied how it was done for CCoinsViewDB upgrade.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-02-09T21:07:28Z",
      "diff_hunk" : "@@ -424,3 +424,132 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n+    if (Read(DB_BEST_BLOCK, hash)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        hash.SetNull();\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool TxIndexDB::WriteBestBlockHash(const uint256& hash) {\n+    return Write(DB_BEST_BLOCK, hash);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. If the flag is not\n+    // set, txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            return error(\"%s: cannot get key from valid cursor\", __func__);\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r167346079",
      "id" : 167346079,
      "in_reply_to_id" : 167244773,
      "original_commit_id" : "c4401fc41422daa17df46e5945c35a55c1e0e8bd",
      "original_position" : 81,
      "path" : "src/txdb.cpp",
      "position" : 131,
      "pull_request_review_id" : 95562771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167346079",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Sjors Thanks for the review!\r\n\r\nI added f1b8b8d to log the txindex build status periodically while it is catching up.\r\n\r\nI agree functional tests would be nice, but I'm having trouble figuring out how to exercise the case where the txindex is catchup up in the test harness. Could maybe sync a node with a few blocks, stop it, delete the txindex database files, restart and then hit the RPC, but it is going to be racey no matter what. Let me know if you have suggestions.\r\n\r\nI'm curious what other people think, but having the block index database elsewhere doesn't bother me too much, because it is special and required. I am imagining that `indexes/` will be for optional indexes that can be built and synced in the background. Also, it doesn't seem worth it to make a migration just to move around the block index directory path.",
      "created_at" : "2018-02-09T21:49:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-364578968",
      "id" : 364578968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-02-09T21:49:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364578968",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery: any thoughts on how to tackle functional tests?",
      "created_at" : "2018-02-10T10:43:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-364642544",
      "id" : 364642544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-02-10T10:43:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364642544",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172322571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172322571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a lot of moves, since you already move TxIndex::TxIndex. Can you change to create the unique_ptr in the constructor call, e.g.:\r\n\r\n```\r\ng_txindex.reset(new TxIndex(MakeUnique<...>(....));\r\n```\r\n\r\nOr even better, use argument forwarding.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-05T20:45:48Z",
      "diff_hunk" : "@@ -1568,6 +1574,12 @@ bool AppInitMain()\n                 return InitError(strLoadError);\n             }\n         }\n+\n+        if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n+            auto txindex_db = MakeUnique<TxIndexDB>(nTxIndexCache, false, fReset);\n+            g_txindex.reset(new TxIndex(std::move(txindex_db)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172322571",
      "id" : 172322571,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 85,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 101320521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172322571",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172322782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172322782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you make this forwardable?\r\n\r\n```\r\nTxIndex(std::unique_ptr<TxIndexDB> &&db);\r\n```\r\n\r\nOr just create the unique_ptr here, see my other comment regarding g_txindex.reset()",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-05T20:46:40Z",
      "diff_hunk" : "@@ -0,0 +1,74 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <threadinterrupt.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records\n+ * the filesystem location of each transaction by transaction hash.\n+ */\n+class TxIndex final : public CValidationInterface\n+{\n+private:\n+    const std::unique_ptr<TxIndexDB> m_db;\n+\n+    /// Whether the index is in sync with the main chain. The flag is flipped\n+    /// from false to true once, after which point this starts processing\n+    /// ValidationInterface notifications to stay in sync.\n+    std::atomic<bool> m_synced;\n+\n+    /// The last block in the chain that the TxIndex is in sync with.\n+    std::atomic<const CBlockIndex*> m_best_block_index;\n+\n+    std::thread m_thread_sync;\n+    CThreadInterrupt m_interrupt;\n+\n+    /// Initialize internal state from the database and block index.\n+    bool Init();\n+\n+    /// Sync the tx index with the block index starting from the current best\n+    /// block. Intended to be run in its own thread, m_thread_sync, and can be\n+    /// interrupted with m_interrupt. Once the txindex gets in sync, the\n+    /// m_synced flag is set and the BlockConnected ValidationInterface callback\n+    /// takes over and the sync thread exits.\n+    void ThreadSync();\n+\n+    /// Write update index entries for a newly connected block.\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex);\n+\n+protected:\n+    void BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                        const std::vector<CTransactionRef>& txn_conflicted) override;\n+\n+public:\n+    explicit TxIndex(std::unique_ptr<TxIndexDB> db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172322782",
      "id" : 172322782,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 54,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 101320521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172322782",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172323530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172323530"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it makes sense to add a logging statement in the path here where the method actually blocks.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-05T20:49:33Z",
      "diff_hunk" : "@@ -0,0 +1,251 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    auto best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",\n+                       __func__, pindex->GetBlockHash().ToString(),\n+                       best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip().\n+        LOCK(cs_main);\n+        auto chain_tip = chainActive.Tip();\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    SyncWithValidationInterfaceQueue();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172323530",
      "id" : 172323530,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 217,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 101320521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172323530",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172324778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172324778"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doesn't std::bind already return the right type here?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-05T20:54:10Z",
      "diff_hunk" : "@@ -0,0 +1,251 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    auto best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",\n+                       __func__, pindex->GetBlockHash().ToString(),\n+                       best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip().\n+        LOCK(cs_main);\n+        auto chain_tip = chainActive.Tip();\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    SyncWithValidationInterfaceQueue();\n+    return true;\n+}\n+\n+bool TxIndex::FindTx(const uint256& txid, CDiskTxPos& pos) const\n+{\n+    return m_db->ReadTxPos(txid, pos);\n+}\n+\n+void TxIndex::Interrupt()\n+{\n+    m_interrupt();\n+}\n+\n+void TxIndex::Start()\n+{\n+    // Need to register this ValidationInterface before running Init(), so that\n+    // callbacks are not missed if Init sets m_synced to true.\n+    RegisterValidationInterface(this);\n+    if (!Init()) {\n+        return;\n+    }\n+\n+    m_thread_sync = std::thread(&TraceThread<std::function<void()>>, \"txindex\",\n+                                std::function<void()>(std::bind(&TxIndex::ThreadSync, this)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172324778",
      "id" : 172324778,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 241,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 101320521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172324778",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172325383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172325383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe you can do `{DB_TXINDEX, txid}` in C++11.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-05T20:56:15Z",
      "diff_hunk" : "@@ -424,3 +424,132 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172325383",
      "id" : 172325383,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 11,
      "path" : "src/txdb.cpp",
      "position" : 19,
      "pull_request_review_id" : 101320521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172325383",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172538666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172538666"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch. This came from a copy-paste.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-06T14:47:27Z",
      "diff_hunk" : "@@ -0,0 +1,251 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    auto best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",\n+                       __func__, pindex->GetBlockHash().ToString(),\n+                       best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip().\n+        LOCK(cs_main);\n+        auto chain_tip = chainActive.Tip();\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    SyncWithValidationInterfaceQueue();\n+    return true;\n+}\n+\n+bool TxIndex::FindTx(const uint256& txid, CDiskTxPos& pos) const\n+{\n+    return m_db->ReadTxPos(txid, pos);\n+}\n+\n+void TxIndex::Interrupt()\n+{\n+    m_interrupt();\n+}\n+\n+void TxIndex::Start()\n+{\n+    // Need to register this ValidationInterface before running Init(), so that\n+    // callbacks are not missed if Init sets m_synced to true.\n+    RegisterValidationInterface(this);\n+    if (!Init()) {\n+        return;\n+    }\n+\n+    m_thread_sync = std::thread(&TraceThread<std::function<void()>>, \"txindex\",\n+                                std::function<void()>(std::bind(&TxIndex::ThreadSync, this)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172538666",
      "id" : 172538666,
      "in_reply_to_id" : 172324778,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 241,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 101570901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172538666",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172538847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172538847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That doesn't seem to work because `Read` is templated and can't infer that the initializer list should be cast to a `std::pair`.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-06T14:48:02Z",
      "diff_hunk" : "@@ -424,3 +424,132 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172538847",
      "id" : 172538847,
      "in_reply_to_id" : 172325383,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 11,
      "path" : "src/txdb.cpp",
      "position" : 19,
      "pull_request_review_id" : 101571131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172538847",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172552215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172552215"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd rather have them on separate lines because I think otherwise there is too much happening on one line (and it would get pretty long).\r\n\r\nRegarding argument forwarding, even if `TxIndex` takes an rvalue-ref, the `std::move` is necessary.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-06T15:25:28Z",
      "diff_hunk" : "@@ -1568,6 +1574,12 @@ bool AppInitMain()\n                 return InitError(strLoadError);\n             }\n         }\n+\n+        if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n+            auto txindex_db = MakeUnique<TxIndexDB>(nTxIndexCache, false, fReset);\n+            g_txindex.reset(new TxIndex(std::move(txindex_db)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172552215",
      "id" : 172552215,
      "in_reply_to_id" : 172322571,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 85,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 101587488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172552215",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172552923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172552923"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I find it clearer to pass by value here, as is recommended by [this StackOverflow post](https://stackoverflow.com/a/8114913). Is there a big benefit to changing the parameter to an rvalue-ref?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-06T15:27:27Z",
      "diff_hunk" : "@@ -0,0 +1,74 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <threadinterrupt.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records\n+ * the filesystem location of each transaction by transaction hash.\n+ */\n+class TxIndex final : public CValidationInterface\n+{\n+private:\n+    const std::unique_ptr<TxIndexDB> m_db;\n+\n+    /// Whether the index is in sync with the main chain. The flag is flipped\n+    /// from false to true once, after which point this starts processing\n+    /// ValidationInterface notifications to stay in sync.\n+    std::atomic<bool> m_synced;\n+\n+    /// The last block in the chain that the TxIndex is in sync with.\n+    std::atomic<const CBlockIndex*> m_best_block_index;\n+\n+    std::thread m_thread_sync;\n+    CThreadInterrupt m_interrupt;\n+\n+    /// Initialize internal state from the database and block index.\n+    bool Init();\n+\n+    /// Sync the tx index with the block index starting from the current best\n+    /// block. Intended to be run in its own thread, m_thread_sync, and can be\n+    /// interrupted with m_interrupt. Once the txindex gets in sync, the\n+    /// m_synced flag is set and the BlockConnected ValidationInterface callback\n+    /// takes over and the sync thread exits.\n+    void ThreadSync();\n+\n+    /// Write update index entries for a newly connected block.\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex);\n+\n+protected:\n+    void BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                        const std::vector<CTransactionRef>& txn_conflicted) override;\n+\n+public:\n+    explicit TxIndex(std::unique_ptr<TxIndexDB> db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172552923",
      "id" : 172552923,
      "in_reply_to_id" : 172322782,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 54,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 101588357,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172552923",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172552991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172552991"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-06T15:27:38Z",
      "diff_hunk" : "@@ -0,0 +1,251 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.\n+    auto best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            FatalError(\"%s: Block %s does not connect to an ancestor of known best chain (tip=%s)\",\n+                       __func__, pindex->GetBlockHash().ToString(),\n+                       best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip().\n+        LOCK(cs_main);\n+        auto chain_tip = chainActive.Tip();\n+        auto best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    SyncWithValidationInterfaceQueue();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r172552991",
      "id" : 172552991,
      "in_reply_to_id" : 172323530,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 217,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 101588441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172552991",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Concept ACK.\r\n\r\nHaving the transaction index as a modular, optional, separate database that gets updated in the background is a major improvement over how things work now.\r\n\r\nIt's also the approach that similar optional indexes or redundant data can take; for example a rolling UTXO set hash or a per-scriptPubKey UTXO index (see #9806) could follow the same approach.",
      "created_at" : "2018-03-06T18:50:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-370887085",
      "id" : 370887085,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-06T18:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/370887085",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tested adding an index in Bitcoin-QT and it seems to work. I didn't try upgrading an existing index.\r\n\r\nIt doesn't delete the index when you set `txindex=0`. That might actually be better than the current behavior to prevent accidents, but should be explained in the release notes and such.",
      "created_at" : "2018-03-07T15:15:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-371170887",
      "id" : 371170887,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-07T15:15:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371170887",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Sjors Thanks for testing. I fixed the issue switching from pruned to unpruned w/o txindex with an amend to 33ebb98. You raise an interesting point about dropping the txindex database. Not sure what the right behavior should be. One approach might be to add a `-dropindex=txindex` flag or to add an RPC and `bitcoin-cli` command that errors if the txindex is active. I like the CLI approach personally, but the downside is it requires the RPC server to be running.",
      "created_at" : "2018-03-08T18:31:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-371579644",
      "id" : 371579644,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-08T18:31:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371579644",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173250283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173250283"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I opted to log every 30s.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-08T18:37:00Z",
      "diff_hunk" : "@@ -424,3 +424,132 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n+    if (Read(DB_BEST_BLOCK, hash)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        hash.SetNull();\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool TxIndexDB::WriteBestBlockHash(const uint256& hash) {\n+    return Write(DB_BEST_BLOCK, hash);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. If the flag is not\n+    // set, txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            return error(\"%s: cannot get key from valid cursor\", __func__);\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173250283",
      "id" : 173250283,
      "in_reply_to_id" : 167244773,
      "original_commit_id" : "c4401fc41422daa17df46e5945c35a55c1e0e8bd",
      "original_position" : 81,
      "path" : "src/txdb.cpp",
      "position" : 131,
      "pull_request_review_id" : 102409576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173250283",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think your release note is fine. Deleting a directory doesn't seem worth the complexity of another RPC command / command line flag. I don't think it's too much to ask.",
      "created_at" : "2018-03-08T19:08:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-371590826",
      "id" : 371590826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-08T19:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371590826",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK!\r\n- Is there a reason for the extensive use of the c++11 `auto` specifier (for things like `CBlockIndex*`)?\r\n- Maybe a stupid question, but why blocking the thread / RPC / REST during txindex generation? I just had the thought why not building the txindex reserve (from tip to genesis) and allow access anytime while eventually add a txindex status report call `txindexstatus` (if this makes sense, then probably not in this PR).",
      "created_at" : "2018-03-09T01:11:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-371679779",
      "id" : 371679779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-09T01:11:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371679779",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonasschnelli I wrote this before the discussion on #12120. Happy to go through the commits and reduce the usage.\r\n\r\nAs for the RPC behavior, it actually works similar to how you suggest. `BlockUntilSyncedToCurrentChain` only blocks if the txindex is caught up and just waits for the ValidationInterface queue to clear. If the txindex is syncing from genesis, `BlockUntilSyncedToCurrentChain` immediately returns false. The `getrawtransaction` behavior, however, is to optimistically query the index and only if it can't find the tx does it return a not found error saying the index is catching up. Basically, the index has an initial sync phase, then a staying in sync phase, where RPC calls might block for a short amount of time just for consistency with other RPC responses.",
      "created_at" : "2018-03-09T01:23:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-371681871",
      "id" : 371681871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-09T01:35:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371681871",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645421"
         }
      },
      "author_association" : "MEMBER",
      "body" : "remove `static`, that's the opposite of what you want (it reserves `.bss` space)",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:14:40Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645421",
      "id" : 173645421,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 14,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645421",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645439"
         }
      },
      "author_association" : "MEMBER",
      "body" : "typo, \"in the old database\"",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:15:53Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645439",
      "id" : 173645439,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 52,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645439",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645463"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is wrong, you have an extra argument that dereferences a nullptr.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:17:56Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645463",
      "id" : 173645463,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 149,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645463",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645474"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: move this to the ctor (it can take a size to reserve)",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:18:50Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645474",
      "id" : 173645474,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 157,
      "path" : "src/index/txindex.cpp",
      "position" : 135,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645474",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: emplace_back",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:19:14Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645479",
      "id" : 173645479,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 159,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645479",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IMO it's weird to mix tx and txn, I would just use tx (and txs) throughout. Up to you though, purely a style thing.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:20:19Z",
      "diff_hunk" : "@@ -126,4 +126,31 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/** Access to the block database (blocks/index/) */\n+class TxIndexDB : public CDBWrapper\n+{\n+public:\n+    explicit TxIndexDB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    TxIndexDB(const TxIndexDB&) = delete;\n+    TxIndexDB& operator=(const TxIndexDB&) = delete;\n+\n+    /// Read the disk location of the transaction data with the given hash. Returns false if the\n+    /// transaction hash is not indexed.\n+    bool ReadTxPos(const uint256& txid, CDiskTxPos& pos) const;\n+\n+    /// Write a batch of transaction positions to the DB.\n+    bool WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645497",
      "id" : 173645497,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 27,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645497",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645530"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right, disregard.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:22:36Z",
      "diff_hunk" : "@@ -0,0 +1,74 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <threadinterrupt.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records\n+ * the filesystem location of each transaction by transaction hash.\n+ */\n+class TxIndex final : public CValidationInterface\n+{\n+private:\n+    const std::unique_ptr<TxIndexDB> m_db;\n+\n+    /// Whether the index is in sync with the main chain. The flag is flipped\n+    /// from false to true once, after which point this starts processing\n+    /// ValidationInterface notifications to stay in sync.\n+    std::atomic<bool> m_synced;\n+\n+    /// The last block in the chain that the TxIndex is in sync with.\n+    std::atomic<const CBlockIndex*> m_best_block_index;\n+\n+    std::thread m_thread_sync;\n+    CThreadInterrupt m_interrupt;\n+\n+    /// Initialize internal state from the database and block index.\n+    bool Init();\n+\n+    /// Sync the tx index with the block index starting from the current best\n+    /// block. Intended to be run in its own thread, m_thread_sync, and can be\n+    /// interrupted with m_interrupt. Once the txindex gets in sync, the\n+    /// m_synced flag is set and the BlockConnected ValidationInterface callback\n+    /// takes over and the sync thread exits.\n+    void ThreadSync();\n+\n+    /// Write update index entries for a newly connected block.\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex);\n+\n+protected:\n+    void BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                        const std::vector<CTransactionRef>& txn_conflicted) override;\n+\n+public:\n+    explicit TxIndex(std::unique_ptr<TxIndexDB> db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645530",
      "id" : 173645530,
      "in_reply_to_id" : 172322782,
      "original_commit_id" : "f1b8b8d676c72d9a9d544804262f2471d3ce5bf8",
      "original_position" : 54,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645530",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645676"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The transaction logic throughout is wrong here because there's a data ordering dependency.\r\n\r\nDuring the data migration:\r\n * Write to new new with `fsync = True`\r\n * After new write finishes, you can erase from old db (fsync setting can be left false)\r\n\r\nThis ensures that you can can always scan through the old database and catch up to what's in the new database if there's a crash or you are interrupted. During the non-migration path I think it's fine to have fsync disabled.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:29:51Z",
      "diff_hunk" : "@@ -424,3 +424,132 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n+    if (Read(DB_BEST_BLOCK, hash)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        hash.SetNull();\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool TxIndexDB::WriteBestBlockHash(const uint256& hash) {\n+    return Write(DB_BEST_BLOCK, hash);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. If the flag is not\n+    // set, txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            return error(\"%s: cannot get key from valid cursor\", __func__);\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            uiInterface.ShowProgress(_(\"Upgrading txindex database\"), percentage_done, true);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size || batch_olddb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645676",
      "id" : 173645676,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 100,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645676",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These should both be done in a single `WriteBatch()` call to make them atomic.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T07:34:18Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645805",
      "id" : 173645805,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 162,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 102873084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173645805",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173671296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree, will change.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T21:53:55Z",
      "diff_hunk" : "@@ -126,4 +126,31 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/** Access to the block database (blocks/index/) */\n+class TxIndexDB : public CDBWrapper\n+{\n+public:\n+    explicit TxIndexDB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    TxIndexDB(const TxIndexDB&) = delete;\n+    TxIndexDB& operator=(const TxIndexDB&) = delete;\n+\n+    /// Read the disk location of the transaction data with the given hash. Returns false if the\n+    /// transaction hash is not indexed.\n+    bool ReadTxPos(const uint256& txid, CDiskTxPos& pos) const;\n+\n+    /// Write a batch of transaction positions to the DB.\n+    bool WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173671296",
      "id" : 173671296,
      "in_reply_to_id" : 173645497,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 27,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 102897865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671296",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173671927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm pretty sure the `std::vector` constructor that takes a `size_t` creates the vector with `n` elements rather than having a size of 0 and a capacity of `n`.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T22:12:03Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173671927",
      "id" : 173671927,
      "in_reply_to_id" : 173645474,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 157,
      "path" : "src/index/txindex.cpp",
      "position" : 135,
      "pull_request_review_id" : 102898419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671927",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173671931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671931"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T22:12:18Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173671931",
      "id" : 173671931,
      "in_reply_to_id" : 173645463,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 149,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 102898425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173671931",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173672075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173672075"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Will do.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-11T22:15:48Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.push_back(std::make_pair(tx->GetHash(), pos));\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxns(vPos) && m_db->WriteBestBlockHash(pindex->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173672075",
      "id" : 173672075,
      "in_reply_to_id" : 173645805,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 162,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 102898565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173672075",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174025542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174025542"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's not strictly accurate:\r\n\r\n```\r\n$ g++ --version\r\ng++ (GCC) 7.3.1 20180303 (Red Hat 7.3.1-5)\r\nCopyright (C) 2017 Free Software Foundation, Inc.\r\nThis is free software; see the source for copying conditions.  There is NO\r\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n\r\n$ cat reserve.cc \r\n#include <iostream>\r\n#include <vector>\r\n\r\nstruct Foo {\r\n    int x;\r\n    Foo() :x(1) {}\r\n};\r\n\r\nint main(int argc, char **argv) {\r\n    std::vector<Foo> foovec;\r\n    foovec.reserve(10);\r\n    std::cout << foovec[5].x << std::endl;\r\n    std::cout << foovec.at(5).x << std::endl;\r\n    return 0;\r\n}\r\n\r\n$ g++ reserve.cc \r\n\r\n$ ./a.out \r\n0\r\nterminate called after throwing an instance of 'std::out_of_range'\r\n  what():  vector::_M_range_check: __n (which is 5) >= this->size() (which is 0)\r\nAborted (core dumped)\r\n```\r\n\r\nIn this test `Foo` has a constructor that sets `x` to 1, but as you can see from the first line of output it prints 0 implying that the ctor wasn't actually called. The `.at()` check fails because the element is out of bounds compared to the true size. The standard calls this [\"default insertable\"](http://en.cppreference.com/w/cpp/concept/DefaultInsertable) which I think just means \"not allocator aware\" in which case the default allocator is allowed to just create space for the item.\r\n\r\nEither way it's a nit that you can ignore, but I think the suggestion I made is safe and slightly faster, assuming you actually initialize the elements before accessing them.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-13T06:20:02Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174025542",
      "id" : 174025542,
      "in_reply_to_id" : 173645474,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 157,
      "path" : "src/index/txindex.cpp",
      "position" : 135,
      "pull_request_review_id" : 103307558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174025542",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I thought more about the ordering dependency between the block index and the txindex, and I realize now that it might be possible to make them independent of ordering. There's an edge case (that may not be possible in practice) if a reorg happens during crash recovery, so I stand by my original recommendation and maybe we can fix the reorg edge case before 0.17 is released.",
      "created_at" : "2018-03-13T06:25:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-372559696",
      "id" : 372559696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-13T06:25:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/372559696",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174491001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174491001"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nCommit title could be changed to something like \"Add (unused) TxIndexDB class\" to be more specific. Current title is a little misleading about what the actual change is.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T15:03:06Z",
      "diff_hunk" : "@@ -126,4 +126,25 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/** Access to the block database (blocks/index/) */\n+class TxIndexDB : public CDBWrapper",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174491001",
      "id" : 174491001,
      "original_commit_id" : "3c37a4b86232b12ecc15a5a6efde2276a8273735",
      "original_position" : 5,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174491001",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174494166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174494166"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nI think it'd be better to disable copying in `CDBWrapper` instead of here, since the state that's actually unsafe to copy is in that class, not this one.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T15:11:45Z",
      "diff_hunk" : "@@ -126,4 +126,25 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/** Access to the block database (blocks/index/) */\n+class TxIndexDB : public CDBWrapper\n+{\n+public:\n+    explicit TxIndexDB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    TxIndexDB(const TxIndexDB&) = delete;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174494166",
      "id" : 174494166,
      "original_commit_id" : "3c37a4b86232b12ecc15a5a6efde2276a8273735",
      "original_position" : 10,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174494166",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174499186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174499186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[db] Create separate database for txindex.\"\r\n\r\nCould say cursor instead of pcursor to avoid more hungarian names.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T15:24:23Z",
      "diff_hunk" : "@@ -424,3 +424,113 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxs(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. If the flag is not\n+    // set, txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174499186",
      "id" : 174499186,
      "original_commit_id" : "3c37a4b86232b12ecc15a5a6efde2276a8273735",
      "original_position" : 50,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174499186",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174512461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174512461"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159900328\r\n\r\nIn commit \"[db] Create separate database for txindex.\"\r\n\r\n> Hmm, the logic gets kind of tricky since there's also the early break. \r\n\r\nThis doesn't seem that bad in light of the code duplication in the current version of this code, and the fact that the originally duplicated code had a bug that needed to be fixed two places instead of one (missing the \"Sync new DB changes to disk before deleting from old DB\" behavior). \r\n\r\nI think adding new `done` bool variable set to as `!pcursor->Valid() || key.first != DB_TXINDEX`, would make the code change I suggested above even shorter and clearer.\r\n\r\n> What do you mean that it skips the last compact range on the old DB? It shouldn't.\r\n\r\nMy mistake, I don't think I saw the actual line of code I was commenting on.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T15:58:11Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            break;\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size || batch_olddb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);\n+            batch_newdb.Clear();\n+            CompactRange(prev_key_newdb, key);\n+            prev_key_newdb = key;\n+\n+            block_tree_db.WriteBatch(batch_olddb);\n+            batch_olddb.Clear();\n+            block_tree_db.CompactRange(prev_key_olddb, key);\n+            prev_key_olddb = key;\n+        }\n+    }\n+\n+    WriteBatch(batch_newdb);\n+    CompactRange(begin_key, key);\n+    block_tree_db.WriteBatch(batch_olddb);\n+    block_tree_db.CompactRange(begin_key, key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174512461",
      "id" : 174512461,
      "in_reply_to_id" : 159900328,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 94,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174512461",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174521474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174521474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159904033\r\n\r\nIn commit \"[db] Methods on TxIndexDB to persist best block hash. \"\r\n\r\n> It does get used.\r\n\r\nMy mistake. IMO, it would make review a little easier if this commit were squashed into the previous commit. I don't think there's benefit to adding the new TxIndexDB class in one commit, and then modifying it to add this simple feature separately.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T16:22:53Z",
      "diff_hunk" : "@@ -142,9 +142,15 @@ class TxIndexDB : public CDBWrapper\n     /// Write a batch of transaction positions to the DB.\n     bool WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos);\n \n+    /// Read the best block hash of the chain that the txindex is in sync with.\n+    bool ReadBestBlockHash(uint256& hash) const;\n+\n+    /// Write the best block hash of the chain that the txindex is in sync with.\n+    bool WriteBestBlockHash(const uint256& block_hash);\n+\n     /// Migrate txindex data from the block tree DB, where it may be for older nodes that have not\n     /// been upgraded yet to the new database.\n-    bool MigrateData(CBlockTreeDB& block_tree_db);\n+    bool MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174521474",
      "id" : 174521474,
      "in_reply_to_id" : 159904033,
      "original_commit_id" : "0f77eab3cedfbf9e75ce8c15fc837da09a1cb952",
      "original_position" : 13,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174521474",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174529236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174529236"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nNot really the \"block index database\" now, but a separate database (unless I'm misinterpreting)?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T16:45:34Z",
      "diff_hunk" : "@@ -0,0 +1,52 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174529236",
      "id" : 174529236,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 16,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174529236",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174529930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174529930"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nMaybe set to this false here to simplify initialization in the constructor. Similarly for atomic member below.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T16:47:35Z",
      "diff_hunk" : "@@ -0,0 +1,52 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records\n+ * the filesystem location of each transaction by transaction hash.\n+ */\n+class TxIndex final : public CValidationInterface\n+{\n+private:\n+    const std::unique_ptr<TxIndexDB> m_db;\n+\n+    /// Whether the index is in sync with the main chain. The flag is flipped\n+    /// from false to true once, after which point this starts processing\n+    /// ValidationInterface notifications to stay in sync.\n+    std::atomic<bool> m_synced;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174529930",
      "id" : 174529930,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 27,
      "path" : "src/index/txindex.h",
      "position" : 30,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174529930",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174530719"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174530719"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nMaybe add comment about initialization sequence given the three initialization methods in this class (constructor, `Init`, and `Start`).",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T16:49:50Z",
      "diff_hunk" : "@@ -0,0 +1,52 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records\n+ * the filesystem location of each transaction by transaction hash.\n+ */\n+class TxIndex final : public CValidationInterface\n+{\n+private:\n+    const std::unique_ptr<TxIndexDB> m_db;\n+\n+    /// Whether the index is in sync with the main chain. The flag is flipped\n+    /// from false to true once, after which point this starts processing\n+    /// ValidationInterface notifications to stay in sync.\n+    std::atomic<bool> m_synced;\n+\n+    /// The last block in the chain that the TxIndex is in sync with.\n+    std::atomic<const CBlockIndex*> m_best_block_index;\n+\n+    /// Initialize internal state from the database and block index.\n+    bool Init();\n+\n+    /// Write update index entries for a newly connected block.\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex);\n+\n+protected:\n+    void BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                        const std::vector<CTransactionRef>& txn_conflicted) override;\n+\n+public:\n+    explicit TxIndex(std::unique_ptr<TxIndexDB> db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174530719",
      "id" : 174530719,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 43,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174530719",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174534066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174534066"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nIt seems hungarian notation can never go away even in new code, given how sticky the `pindex` convention seems to be, but maybe consider calling this `block` or `best_block_index` instead.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T16:59:27Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174534066",
      "id" : 174534066,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 61,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174534066",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174537635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174537635"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nIt seems needlessly inefficient and complicated to be creating a vector just to be able to pass a sequence of txids to the `TxIndexDB::WriteTxs` method, which is only called from this one place. It seems like a simpler design might inline the WriteTx method, or pass a block to it, or just not have separate `TxIndexDB` and `TxIndex` classes.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T17:09:55Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174537635",
      "id" : 174537635,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 78,
      "path" : "src/index/txindex.cpp",
      "position" : 134,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174537635",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174577538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174577538"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nWould expand this comment to mention what could actually trigger these errors. Maybe add \"If the errors below are triggered, it means a BlockConnected call has been received for a new block which has ancestor blocks that might never have been added to the transaction index. This could happen if a bug causes BlockConnected notifications to be sent in the wrong order, or if there's an unfortunately timed reorg or invalidateblock call that causes the first BlockConnection notification after shutdown of the initial sync thread to not be an ancestor or direct descendant of chainActive at the time the sync completed.\"",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T19:05:04Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos, pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174577538",
      "id" : 174577538,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 94,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174577538",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174594791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174594791"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] TxIndex initial sync thread.\"\r\n\r\nCould declare static to avoid creating a linker symbol.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T20:10:20Z",
      "diff_hunk" : "@@ -10,6 +11,8 @@\n #include <validation.h>\n #include <warnings.h>\n \n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174594791",
      "id" : 174594791,
      "original_commit_id" : "b381ec3672d6de1b0aeb25ae7b466c4ec079528a",
      "original_position" : 12,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174594791",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174596700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174596700"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[init] Initialize and start TxIndex in init code.\"\r\n\r\nMight be more consistent to use MakeUnique here too.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T20:17:31Z",
      "diff_hunk" : "@@ -1598,15 +1610,22 @@ bool AppInitMain()\n         ::feeEstimator.Read(est_filein);\n     fFeeEstimatesInitialized = true;\n \n-    // ********************************************************* Step 8: load wallet\n+    // ********************************************************* Step 8: start indexers\n+    if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n+        auto txindex_db = MakeUnique<TxIndexDB>(nTxIndexCache, false, fReindex);\n+        g_txindex.reset(new TxIndex(std::move(txindex_db)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174596700",
      "id" : 174596700,
      "original_commit_id" : "0ffbc19451a24185e128c42338315e19ebbfe361",
      "original_position" : 73,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174596700",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174598230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174598230"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[init] Initialize and start TxIndex in init code.\"\r\n\r\nCould combine lines and shorten by just passing `nTotalCache / 8` directly to min. Same for nBlockTreeDBCache above. ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T20:23:12Z",
      "diff_hunk" : "@@ -1404,16 +1411,22 @@ bool AppInitMain()\n     int64_t nTotalCache = (gArgs.GetArg(\"-dbcache\", nDefaultDbCache) << 20);\n     nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n     nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = nTotalCache / 8;\n-    nBlockTreeDBCache = std::min(nBlockTreeDBCache, (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxBlockDBAndTxIndexCache : nMaxBlockDBCache) << 20);\n+    int64_t nBlockTreeDBCache = nTotalCache / 16;\n+    nBlockTreeDBCache = std::min(nBlockTreeDBCache, nMaxBlockDBCache << 20);\n     nTotalCache -= nBlockTreeDBCache;\n+    int64_t nTxIndexCache = nTotalCache / 8;\n+    nTxIndexCache = std::min(nTxIndexCache, gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxTxIndexCache << 20 : 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174598230",
      "id" : 174598230,
      "original_commit_id" : "0ffbc19451a24185e128c42338315e19ebbfe361",
      "original_position" : 38,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174598230",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174598693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174598693"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[init] Initialize and start TxIndex in init code.\"\r\n\r\nWhat's the reason for halving this even if txindex is disabled?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T20:24:58Z",
      "diff_hunk" : "@@ -1404,16 +1411,22 @@ bool AppInitMain()\n     int64_t nTotalCache = (gArgs.GetArg(\"-dbcache\", nDefaultDbCache) << 20);\n     nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n     nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = nTotalCache / 8;\n-    nBlockTreeDBCache = std::min(nBlockTreeDBCache, (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxBlockDBAndTxIndexCache : nMaxBlockDBCache) << 20);\n+    int64_t nBlockTreeDBCache = nTotalCache / 16;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174598693",
      "id" : 174598693,
      "original_commit_id" : "0ffbc19451a24185e128c42338315e19ebbfe361",
      "original_position" : 34,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174598693",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174601865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174601865"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "[index] TxIndex method to wait until caught up.\r\n\r\nDescription above and function name seem a little misleading since this will only wait to be caught up with validation notifications, and will actually return false immediately during startup. This is probably worth mentioning in the comment above, and maybe in an additional comment where this is called. Could also give this this a less reassuring name like `FinishProcessingCurrentBlock.`",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T20:37:00Z",
      "diff_hunk" : "@@ -56,6 +56,10 @@ class TxIndex final : public CValidationInterface\n     /// Destructor interrupts sync thread if running and blocks until it exits.\n     ~TxIndex();\n \n+    /// Blocks the current thread until the transaction index is caught up to\n+    /// the current state of the block chain.\n+    bool BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174601865",
      "id" : 174601865,
      "original_commit_id" : "e4523cf480273b1ce1677107b5ed53751f9cd6ee",
      "original_position" : 6,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174601865",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174604126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174604126"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[test] Simple unit test for TxIndex.\"\r\n\r\nWould be good to validate `postx` variable contents here and below.\r\n\r\n",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T20:45:05Z",
      "diff_hunk" : "@@ -0,0 +1,47 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <script/standard.h>\n+#include <test/test_bitcoin.h>\n+#include <util.h>\n+#include <utiltime.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(txindex_tests)\n+\n+BOOST_FIXTURE_TEST_CASE(txindex_initial_sync, TestChain100Setup)\n+{\n+    TxIndex txindex(MakeUnique<TxIndexDB>(1 << 20, true));\n+    txindex.Start();\n+\n+    // Allow tx index to catch up with the block index.\n+    constexpr int64_t timeout_ms = 10 * 1000;\n+    int64_t time_start = GetTimeMillis();\n+    while (!txindex.BlockUntilSyncedToCurrentChain()) {\n+        BOOST_REQUIRE(time_start + timeout_ms > GetTimeMillis());\n+        MilliSleep(100);\n+    }\n+\n+    for (const auto& txn : coinbaseTxns) {\n+        CDiskTxPos postx;\n+        BOOST_CHECK(txindex.FindTx(txn.GetHash(), postx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174604126",
      "id" : 174604126,
      "original_commit_id" : "1f89575ec9f29c0e53e2bf86c00f7227708c5002",
      "original_position" : 31,
      "path" : "src/test/txindex_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174604126",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174606064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174606064"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[test] Simple unit test for TxIndex.\"\r\n\r\nWould suggest adding a few more simple checks:\r\n\r\n* Test that sync thread actually works. I.e. that if new transactions are added before calling `Start()`, they don't show up, and that they do show up after calling `Start()`.\r\n* Check that transactions are persistent and reloaded correctly if txindex is closed and reopened.\r\n* Check BlockUntilSyncedToCurrentChain return value. Should be false before started, true after.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-14T20:52:28Z",
      "diff_hunk" : "@@ -0,0 +1,47 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <script/standard.h>\n+#include <test/test_bitcoin.h>\n+#include <util.h>\n+#include <utiltime.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(txindex_tests)\n+\n+BOOST_FIXTURE_TEST_CASE(txindex_initial_sync, TestChain100Setup)\n+{\n+    TxIndex txindex(MakeUnique<TxIndexDB>(1 << 20, true));\n+    txindex.Start();\n+\n+    // Allow tx index to catch up with the block index.\n+    constexpr int64_t timeout_ms = 10 * 1000;\n+    int64_t time_start = GetTimeMillis();\n+    while (!txindex.BlockUntilSyncedToCurrentChain()) {\n+        BOOST_REQUIRE(time_start + timeout_ms > GetTimeMillis());\n+        MilliSleep(100);\n+    }\n+\n+    for (const auto& txn : coinbaseTxns) {\n+        CDiskTxPos postx;\n+        BOOST_CHECK(txindex.FindTx(txn.GetHash(), postx));\n+    }\n+\n+    for (int i = 0; i < 10; i++) {\n+        CScript coinbase_script_pub_key = GetScriptForDestination(coinbaseKey.GetPubKey().GetID());\n+        std::vector<CMutableTransaction> no_txns;\n+        const CBlock& block = CreateAndProcessBlock(no_txns, coinbase_script_pub_key);\n+        const CTransaction& txn = *block.vtx[0];\n+\n+        txindex.BlockUntilSyncedToCurrentChain();\n+\n+        CDiskTxPos actual_postx;\n+        BOOST_CHECK(txindex.FindTx(txn.GetHash(), actual_postx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174606064",
      "id" : 174606064,
      "original_commit_id" : "1f89575ec9f29c0e53e2bf86c00f7227708c5002",
      "original_position" : 43,
      "path" : "src/test/txindex_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 88249616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/174606064",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Two functional tests `rpc_rawtransaction.py` and `wallet_abandonconflict.py` seem to be failing, perhaps due to a bad interaction with #11041. AssertLockHeld is failing with stack trace:\r\n\r\n```\r\n#0  0x00007ffff5411428 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54\r\n#1  0x00007ffff541302a in __GI_abort () at abort.c:89\r\n#2  0x0000555555b617d0 in AssertLockHeldInternal (pszName=0x555555bfe1ff \"cs_main\", pszFile=0x555555bfe1f0 \"./validation.h\", nLine=432, cs=0x55555615d240 <cs_main>) at sync.cpp:157\r\n#3  0x00005555555beae4 in LookupBlockIndex (hash=...) at ./validation.h:432\r\n#4  0x00005555557a487f in TxToJSON (tx=..., hashBlock=..., entry=...) at rpc/rawtransaction.cpp:52\r\n#5  0x00005555557a5835 in getrawtransaction (request=...) at rpc/rawtransaction.cpp:200\r\n#6  0x00005555557d07d6 in CRPCTable::execute (this=0x555556166d80 <tableRPC>, request=...) at rpc/server.cpp:493\r\n#7  0x000055555596ffae in HTTPReq_JSONRPC (req=0x7fffcc0017b0) at httprpc.cpp:188\r\n#8  0x00005555557542ae in std::_Function_handler<bool (HTTPRequest*, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&), bool (*)(HTTPRequest*, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&)>::_M_invoke(std::_Any_data const&, HTTPRequest*&&, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) (__functor=..., __args#0=<unknown type in /home/russ/src/bitcoin/src/bitcoind, CU 0x509db3, DIE 0x562965>, __args#1=\"\")\r\n    at /usr/include/c++/5/functional:1857\r\n#9  0x000055555597d64a in std::function<bool (HTTPRequest*, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&)>::operator()(HTTPRequest*, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) const (\r\n    this=0x7fffcc001c10, __args#0=0x7fffcc0017b0, __args#1=\"\") at /usr/include/c++/5/functional:2267\r\n#10 0x000055555597b87b in HTTPWorkItem::operator() (this=0x7fffcc001be0) at httpserver.cpp:53\r\n#11 0x000055555597e7c4 in WorkQueue<HTTPClosure>::Run (this=0x5555562e3ea0) at httpserver.cpp:112\r\n#12 0x00005555559768d7 in HTTPWorkQueueRun (queue=0x5555562e3ea0) at httpserver.cpp:333\r\n#13 0x000055555598ed42 in std::_Bind_simple<void (*(WorkQueue<HTTPClosure>*))(WorkQueue<HTTPClosure>*)>::_M_invoke<0ul>(std::_Index_tuple<0ul>) (this=0x5555562e4368) at /usr/include/c++/5/functional:1531\r\n#14 0x000055555598e6f8 in std::_Bind_simple<void (*(WorkQueue<HTTPClosure>*))(WorkQueue<HTTPClosure>*)>::operator()() (this=0x5555562e4368) at /usr/include/c++/5/functional:1520\r\n#15 0x000055555598de99 in std::thread::_Impl<std::_Bind_simple<void (*(WorkQueue<HTTPClosure>*))(WorkQueue<HTTPClosure>*)> >::_M_run() (this=0x5555562e4350) at /usr/include/c++/5/thread:115\r\n#16 0x00007ffff5d82510 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#17 0x00007ffff6d556ba in start_thread (arg=0x7fffc7fff700) at pthread_create.c:333\r\n#18 0x00007ffff54e341d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\r\n```\r\n\r\nThe error is showing up on travis (https://travis-ci.org/bitcoin/bitcoin/jobs/353440060), but I can also reproduce the problem locally building with building with `--enable-debug`.",
      "created_at" : "2018-03-15T17:30:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-373459507",
      "id" : 373459507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-15T17:30:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/373459507",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175310704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175310704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, outdated comment, will fix. An earlier version of this refactor didn't split the DB out, just the logic.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T00:04:00Z",
      "diff_hunk" : "@@ -0,0 +1,52 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175310704",
      "id" : 175310704,
      "in_reply_to_id" : 174529236,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 16,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 104817916,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175310704",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175312803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175312803"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have tried a few things, and the approach you describe is not worth the additional control flow complexity IMO. Consider also that the CompactRange calls are over a different range inside and outside of the loop (as noted above) and the newest version of the code adds an additional write to the batch outside of the loop to write the block hash.\r\n\r\nHowever, I understand the argument against duplication, so I instead added a private method extracting the logic:\r\n\r\n```c++\r\nstatic void WriteTxIndexMigrationBatches(TxIndexDB& newdb, CBlockTreeDB& olddb,\r\n                                         CDBBatch& batch_newdb, CDBBatch& batch_olddb,\r\n                                         const std::pair<unsigned char, uint256>& begin_key,\r\n                                         const std::pair<unsigned char, uint256>& end_key)\r\n{\r\n    ...\r\n}\r\n```\r\n\r\nHow do you feel about this approach?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T00:49:51Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            break;\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size || batch_olddb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);\n+            batch_newdb.Clear();\n+            CompactRange(prev_key_newdb, key);\n+            prev_key_newdb = key;\n+\n+            block_tree_db.WriteBatch(batch_olddb);\n+            batch_olddb.Clear();\n+            block_tree_db.CompactRange(prev_key_olddb, key);\n+            prev_key_olddb = key;\n+        }\n+    }\n+\n+    WriteBatch(batch_newdb);\n+    CompactRange(begin_key, key);\n+    block_tree_db.WriteBatch(batch_olddb);\n+    block_tree_db.CompactRange(begin_key, key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175312803",
      "id" : 175312803,
      "in_reply_to_id" : 159900328,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 94,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 104820170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175312803",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314357"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:20:05Z",
      "diff_hunk" : "@@ -126,4 +126,25 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/** Access to the block database (blocks/index/) */\n+class TxIndexDB : public CDBWrapper",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314357",
      "id" : 175314357,
      "in_reply_to_id" : 174491001,
      "original_commit_id" : "3c37a4b86232b12ecc15a5a6efde2276a8273735",
      "original_position" : 5,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 104820170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314357",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314366"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:20:14Z",
      "diff_hunk" : "@@ -126,4 +126,25 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/** Access to the block database (blocks/index/) */\n+class TxIndexDB : public CDBWrapper\n+{\n+public:\n+    explicit TxIndexDB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    TxIndexDB(const TxIndexDB&) = delete;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314366",
      "id" : 175314366,
      "in_reply_to_id" : 174494166,
      "original_commit_id" : "3c37a4b86232b12ecc15a5a6efde2276a8273735",
      "original_position" : 10,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 104821859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314366",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314377"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:20:21Z",
      "diff_hunk" : "@@ -424,3 +424,113 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxs(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. If the flag is not\n+    // set, txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314377",
      "id" : 175314377,
      "in_reply_to_id" : 174499186,
      "original_commit_id" : "3c37a4b86232b12ecc15a5a6efde2276a8273735",
      "original_position" : 50,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 104821873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314377",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:28:22Z",
      "diff_hunk" : "@@ -0,0 +1,52 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INDEX_TXINDEX_H\n+#define BITCOIN_INDEX_TXINDEX_H\n+\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <validationinterface.h>\n+\n+class CBlockIndex;\n+\n+/**\n+ * TxIndex is used to look up transactions included in the blockchain by hash.\n+ * The index is written to a keyspace in the block index database and records\n+ * the filesystem location of each transaction by transaction hash.\n+ */\n+class TxIndex final : public CValidationInterface\n+{\n+private:\n+    const std::unique_ptr<TxIndexDB> m_db;\n+\n+    /// Whether the index is in sync with the main chain. The flag is flipped\n+    /// from false to true once, after which point this starts processing\n+    /// ValidationInterface notifications to stay in sync.\n+    std::atomic<bool> m_synced;\n+\n+    /// The last block in the chain that the TxIndex is in sync with.\n+    std::atomic<const CBlockIndex*> m_best_block_index;\n+\n+    /// Initialize internal state from the database and block index.\n+    bool Init();\n+\n+    /// Write update index entries for a newly connected block.\n+    bool WriteBlock(const CBlock& block, const CBlockIndex* pindex);\n+\n+protected:\n+    void BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                        const std::vector<CTransactionRef>& txn_conflicted) override;\n+\n+public:\n+    explicit TxIndex(std::unique_ptr<TxIndexDB> db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175314900",
      "id" : 175314900,
      "in_reply_to_id" : 174530719,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 43,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 104822453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175314900",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175315199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175315199"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, it could be more efficient, but I feel that this produces the cleanest separation of responsibilities. Another way to do it might be to add a `TxIndexDB::AddTxToBatch(CDBBatch& batch, const uint256& txid, const CDiskTxPos& tx_pos)` method. Would you prefer that?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:33:16Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175315199",
      "id" : 175315199,
      "in_reply_to_id" : 174537635,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 78,
      "path" : "src/index/txindex.cpp",
      "position" : 134,
      "pull_request_review_id" : 104822784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175315199",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175315594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175315594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'll elaborate on the comment, but I don't understand the case you are describing. These checks should always pass as long as the ValidationInterface BlockConnected notifications are sent in order. If there is a race you can think of in the presence of reorgs or shutdowns, we should fix that.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:39:28Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos, pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175315594",
      "id" : 175315594,
      "in_reply_to_id" : 174577538,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 94,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 104823205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175315594",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175316500"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175316500"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Correct me if I'm wrong, but I assume this could be inlined or something by the compiler if it were not declared static. I tried looking it up briefly and it said something along those lines, but then I got bored because I don't care all that much (something, something ODR-rule?). Will change if you still want.\r\n\r\nAlso, see https://github.com/bitcoin/bitcoin/pull/11857#discussion_r173645421.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:52:36Z",
      "diff_hunk" : "@@ -10,6 +11,8 @@\n #include <validation.h>\n #include <warnings.h>\n \n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175316500",
      "id" : 175316500,
      "in_reply_to_id" : 174594791,
      "original_commit_id" : "b381ec3672d6de1b0aeb25ae7b466c4ec079528a",
      "original_position" : 12,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 104824172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175316500",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175316827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175316827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point, updated comment.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:57:09Z",
      "diff_hunk" : "@@ -56,6 +56,10 @@ class TxIndex final : public CValidationInterface\n     /// Destructor interrupts sync thread if running and blocks until it exits.\n     ~TxIndex();\n \n+    /// Blocks the current thread until the transaction index is caught up to\n+    /// the current state of the block chain.\n+    bool BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175316827",
      "id" : 175316827,
      "in_reply_to_id" : 174601865,
      "original_commit_id" : "e4523cf480273b1ce1677107b5ed53751f9cd6ee",
      "original_position" : 6,
      "path" : "src/index/txindex.h",
      "position" : null,
      "pull_request_review_id" : 104824529,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175316827",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175316948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175316948"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T01:58:56Z",
      "diff_hunk" : "@@ -1598,15 +1610,22 @@ bool AppInitMain()\n         ::feeEstimator.Read(est_filein);\n     fFeeEstimatesInitialized = true;\n \n-    // ********************************************************* Step 8: load wallet\n+    // ********************************************************* Step 8: start indexers\n+    if (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX)) {\n+        auto txindex_db = MakeUnique<TxIndexDB>(nTxIndexCache, false, fReindex);\n+        g_txindex.reset(new TxIndex(std::move(txindex_db)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175316948",
      "id" : 175316948,
      "in_reply_to_id" : 174596700,
      "original_commit_id" : "0ffbc19451a24185e128c42338315e19ebbfe361",
      "original_position" : 73,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 104824682,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175316948",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175317104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175317104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're right, will revert. I was just kind of making up values here.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T02:01:37Z",
      "diff_hunk" : "@@ -1404,16 +1411,22 @@ bool AppInitMain()\n     int64_t nTotalCache = (gArgs.GetArg(\"-dbcache\", nDefaultDbCache) << 20);\n     nTotalCache = std::max(nTotalCache, nMinDbCache << 20); // total cache cannot be less than nMinDbCache\n     nTotalCache = std::min(nTotalCache, nMaxDbCache << 20); // total cache cannot be greater than nMaxDbcache\n-    int64_t nBlockTreeDBCache = nTotalCache / 8;\n-    nBlockTreeDBCache = std::min(nBlockTreeDBCache, (gArgs.GetBoolArg(\"-txindex\", DEFAULT_TXINDEX) ? nMaxBlockDBAndTxIndexCache : nMaxBlockDBCache) << 20);\n+    int64_t nBlockTreeDBCache = nTotalCache / 16;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175317104",
      "id" : 175317104,
      "in_reply_to_id" : 174598693,
      "original_commit_id" : "0ffbc19451a24185e128c42338315e19ebbfe361",
      "original_position" : 34,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 104824887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175317104",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175492787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175492787"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Have you tried that code sample with `std::vector<Foo> foovec(10);` instead of `std::vector<Foo> foovec; foovec.reserve(10);`? The behavior is different. I assume that is the suggestion you are making, though maybe I misunderstood.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T16:11:30Z",
      "diff_hunk" : "@@ -0,0 +1,252 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+static constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    auto chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    auto it = mapBlockIndex.find(best_block_hash);\n+    if (it == mapBlockIndex.end()) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    const auto pindex = it->second;\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    auto pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    auto pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                auto pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\", pindex->nHeight);\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175492787",
      "id" : 175492787,
      "in_reply_to_id" : 173645474,
      "original_commit_id" : "1f9c92d5f7a8d271bc55232614b6fceba8e5ff14",
      "original_position" : 157,
      "path" : "src/index/txindex.cpp",
      "position" : 135,
      "pull_request_review_id" : 105030585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175492787",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175609305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175609305"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r159900328\r\n\r\n> How do you feel about this approach?\r\n\r\nBetter, I'm still not sure why my suggestion doesn't work out, but this takes care of my concern.\r\n\r\n",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T22:45:16Z",
      "diff_hunk" : "@@ -424,3 +424,107 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxns(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (auto tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    int report_done = 0;\n+    size_t batch_size = 1 << 24;\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key_newdb = begin_key;\n+    std::pair<unsigned char, uint256> prev_key_olddb = begin_key;\n+\n+    std::unique_ptr<CDBIterator> pcursor(block_tree_db.NewIterator());\n+    for (pcursor->Seek(begin_key); pcursor->Valid(); pcursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            break;\n+        }\n+\n+        if (!pcursor->GetKey(key)) {\n+            break;\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);\n+            int percentage_done = (int)(high * 100.0 / 65536.0 + 0.5);\n+            if (report_done < percentage_done/10) {\n+                LogPrintf(\"[%d%%]...\", percentage_done);\n+                report_done = percentage_done/10;\n+            }\n+        }\n+\n+        CDiskTxPos value;\n+        if (!pcursor->GetValue(value)) {\n+            return error(\"%s: cannot parse txindex record\", __func__);\n+        }\n+        batch_newdb.Write(key, value);\n+        batch_olddb.Erase(key);\n+\n+        if (batch_newdb.SizeEstimate() > batch_size || batch_olddb.SizeEstimate() > batch_size) {\n+            WriteBatch(batch_newdb);\n+            batch_newdb.Clear();\n+            CompactRange(prev_key_newdb, key);\n+            prev_key_newdb = key;\n+\n+            block_tree_db.WriteBatch(batch_olddb);\n+            batch_olddb.Clear();\n+            block_tree_db.CompactRange(prev_key_olddb, key);\n+            prev_key_olddb = key;\n+        }\n+    }\n+\n+    WriteBatch(batch_newdb);\n+    CompactRange(begin_key, key);\n+    block_tree_db.WriteBatch(batch_olddb);\n+    block_tree_db.CompactRange(begin_key, key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175609305",
      "id" : 175609305,
      "in_reply_to_id" : 159900328,
      "original_commit_id" : "1ae2904ea5e333c28a33af8c6ce6526d8554f9f6",
      "original_position" : 94,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 105166914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175609305",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175610366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175610366"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174537635\r\n\r\n> Yes, it could be more efficient, but I feel that this produces the cleanest separation of responsibilities.\r\n\r\nI'm not sure what the separation of responsibilities is actually. If it's important to avoid a more direct write, can you say somewhere in a comment what the separation is supposed to be, and what benefits it provides? This just seems a little more complicated than I would expect it to be.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T22:50:48Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175610366",
      "id" : 175610366,
      "in_reply_to_id" : 174537635,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 78,
      "path" : "src/index/txindex.cpp",
      "position" : 134,
      "pull_request_review_id" : 105168131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175610366",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175614840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175614840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174577538\r\n\r\n> I'll elaborate on the comment, but I don't understand the case you are describing\r\n\r\nThe `BlockConnected` handler will drop any notifications as long as `m_synced` is false, but when `m_synced` becomes true, there is no code to clear out the queue, which could be backlogged. So if `m_synced` is set to true after a reorg but before `BlockConnected` calls from the reorg arrive, some initial `BlockConnected` notifications about blocks that aren't descendants of the synced best block could fail.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T23:16:21Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos, pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175614840",
      "id" : 175614840,
      "in_reply_to_id" : 174577538,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 94,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 105173079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175614840",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175617070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175617070"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r174594791\r\n\r\n> Correct me if I'm wrong, but I assume this could be inlined or something by the compiler if it were not declared static. I tried looking it up briefly and it said something along those lines, but then I got bored because I don't care all that much (something, something ODR-rule?). Will change if you still want.\r\n\r\nHmm, I guess you and @eklitzke are making me question my sanity, but why would adding `static` here prevent inlining, or \"reserve .bss space\" or do anything along these lines?\r\n\r\nIf this isn't declared static, the compiler doesn't know that there isn't some code in another object file that will access the SYNC_LOG_INTERVAL variable or take its address. So there will necessarily be a SYNC_LOG_INTERVAL symbol in the object file. If it's static, it can just be internal to the object.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-19T23:29:16Z",
      "diff_hunk" : "@@ -10,6 +11,8 @@\n #include <validation.h>\n #include <warnings.h>\n \n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175617070",
      "id" : 175617070,
      "in_reply_to_id" : 174594791,
      "original_commit_id" : "b381ec3672d6de1b0aeb25ae7b466c4ec079528a",
      "original_position" : 12,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 105175558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175617070",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'll take another look at this tomorrow to re-ack the new changes. Hopefully I responded to wherever there were questions above.",
      "created_at" : "2018-03-19T23:34:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-374421493",
      "id" : 374421493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-19T23:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374421493",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175886450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175886450"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-20T18:58:59Z",
      "diff_hunk" : "@@ -0,0 +1,47 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <script/standard.h>\n+#include <test/test_bitcoin.h>\n+#include <util.h>\n+#include <utiltime.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(txindex_tests)\n+\n+BOOST_FIXTURE_TEST_CASE(txindex_initial_sync, TestChain100Setup)\n+{\n+    TxIndex txindex(MakeUnique<TxIndexDB>(1 << 20, true));\n+    txindex.Start();\n+\n+    // Allow tx index to catch up with the block index.\n+    constexpr int64_t timeout_ms = 10 * 1000;\n+    int64_t time_start = GetTimeMillis();\n+    while (!txindex.BlockUntilSyncedToCurrentChain()) {\n+        BOOST_REQUIRE(time_start + timeout_ms > GetTimeMillis());\n+        MilliSleep(100);\n+    }\n+\n+    for (const auto& txn : coinbaseTxns) {\n+        CDiskTxPos postx;\n+        BOOST_CHECK(txindex.FindTx(txn.GetHash(), postx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175886450",
      "id" : 175886450,
      "in_reply_to_id" : 174604126,
      "original_commit_id" : "1f89575ec9f29c0e53e2bf86c00f7227708c5002",
      "original_position" : 31,
      "path" : "src/test/txindex_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 105492226,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175886450",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175887350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175887350"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I added checks for 1 & 3. With regards to persistence, the DB in the test environment currently uses the in-memory LevelDB environment rather than actually writing to disk, which makes cleanup nicer and probably makes the test marginally faster.\r\n\r\nHow important do you think it is to test the persistence at this layer? My feeling is that it's probably not adding much since it's just using the common CDBWrapper abstraction.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-20T19:02:11Z",
      "diff_hunk" : "@@ -0,0 +1,47 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <script/standard.h>\n+#include <test/test_bitcoin.h>\n+#include <util.h>\n+#include <utiltime.h>\n+#include <validation.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(txindex_tests)\n+\n+BOOST_FIXTURE_TEST_CASE(txindex_initial_sync, TestChain100Setup)\n+{\n+    TxIndex txindex(MakeUnique<TxIndexDB>(1 << 20, true));\n+    txindex.Start();\n+\n+    // Allow tx index to catch up with the block index.\n+    constexpr int64_t timeout_ms = 10 * 1000;\n+    int64_t time_start = GetTimeMillis();\n+    while (!txindex.BlockUntilSyncedToCurrentChain()) {\n+        BOOST_REQUIRE(time_start + timeout_ms > GetTimeMillis());\n+        MilliSleep(100);\n+    }\n+\n+    for (const auto& txn : coinbaseTxns) {\n+        CDiskTxPos postx;\n+        BOOST_CHECK(txindex.FindTx(txn.GetHash(), postx));\n+    }\n+\n+    for (int i = 0; i < 10; i++) {\n+        CScript coinbase_script_pub_key = GetScriptForDestination(coinbaseKey.GetPubKey().GetID());\n+        std::vector<CMutableTransaction> no_txns;\n+        const CBlock& block = CreateAndProcessBlock(no_txns, coinbase_script_pub_key);\n+        const CTransaction& txn = *block.vtx[0];\n+\n+        txindex.BlockUntilSyncedToCurrentChain();\n+\n+        CDiskTxPos actual_postx;\n+        BOOST_CHECK(txindex.FindTx(txn.GetHash(), actual_postx));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175887350",
      "id" : 175887350,
      "in_reply_to_id" : 174606064,
      "original_commit_id" : "1f89575ec9f29c0e53e2bf86c00f7227708c5002",
      "original_position" : 43,
      "path" : "src/test/txindex_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 105493364,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/175887350",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors\r\n> @jnewbery: any thoughts on how to tackle functional tests?\r\n\r\nMy first thought is that this isn't suitable for a functional test, since it's an implementation change rather than new functionality. Unit tests seem more appropriate.\r\n\r\nWill try to review this week.",
      "created_at" : "2018-03-20T21:43:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-374767119",
      "id" : 374767119,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-20T21:43:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/374767119",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "This seems to introduce a cyclic dependency between `index/txindex` and `validation`. As these usually are a sign of imperfect abstraction boundaries, I would very much like to avoid them. If the current code is only expected to be temporary, I don't want to hold things up just for this, but I don't think it's very hard to avoid; you can move `GetTransaction` from `validation` to `rpc/rawtransaction` or another utility file. It doesn't quite belong in `validation` anyway.\r\n",
      "created_at" : "2018-03-22T01:18:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-375147034",
      "id" : 375147034,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-22T01:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/375147034",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sipa Totally agree `GetTransaction` should be moved. I'd prefer to do it in a follow-up PR as this one is already rather large though.",
      "created_at" : "2018-03-22T01:29:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-375148907",
      "id" : 375148907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-22T01:29:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/375148907",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177805608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177805608"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why compact the newdb?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T16:13:06Z",
      "diff_hunk" : "@@ -458,3 +458,116 @@ bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n     }\n     return false;\n }\n+\n+/*\n+ * Safely persist a transfer of data from the old txindex database to the new one, and compact the\n+ * range of keys updated. This is used internally by MigrateData.\n+ */\n+static void WriteTxIndexMigrationBatches(TxIndexDB& newdb, CBlockTreeDB& olddb,\n+                                         CDBBatch& batch_newdb, CDBBatch& batch_olddb,\n+                                         const std::pair<unsigned char, uint256>& begin_key,\n+                                         const std::pair<unsigned char, uint256>& end_key)\n+{\n+    // Sync new DB changes to disk before deleting from old DB.\n+    newdb.WriteBatch(batch_newdb, /*fSync=*/ true);\n+    olddb.WriteBatch(batch_olddb);\n+\n+    batch_newdb.Clear();\n+    batch_olddb.Clear();\n+\n+    newdb.CompactRange(begin_key, end_key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177805608",
      "id" : 177805608,
      "original_commit_id" : "aee37f2b62c72a0796557b92bf12fde6867dfbc5",
      "original_position" : 21,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 107747366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177805608",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177805735"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177805735"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should probably do something to the old DB so that any old versions refuse to start when the txindex data is partially-migrated (not sure how to do it, or if its really possible, but it'd be nice to sidestep the inevitable \"I started the new version, and it took forever to start, so I killed it, downgraded again, and now my getrawtransaction-based scripts are all failing\" issues).",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T16:13:26Z",
      "diff_hunk" : "@@ -458,3 +458,116 @@ bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n     }\n     return false;\n }\n+\n+/*\n+ * Safely persist a transfer of data from the old txindex database to the new one, and compact the\n+ * range of keys updated. This is used internally by MigrateData.\n+ */\n+static void WriteTxIndexMigrationBatches(TxIndexDB& newdb, CBlockTreeDB& olddb,\n+                                         CDBBatch& batch_newdb, CDBBatch& batch_olddb,\n+                                         const std::pair<unsigned char, uint256>& begin_key,\n+                                         const std::pair<unsigned char, uint256>& end_key)\n+{\n+    // Sync new DB changes to disk before deleting from old DB.\n+    newdb.WriteBatch(batch_newdb, /*fSync=*/ true);\n+    olddb.WriteBatch(batch_olddb);\n+\n+    batch_newdb.Clear();\n+    batch_olddb.Clear();\n+\n+    newdb.CompactRange(begin_key, end_key);\n+    olddb.CompactRange(begin_key, end_key);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. The flag signals\n+    // whether any txindex data is present in the block_tree_db. If the flag is\n+    // not set, either the txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177805735",
      "id" : 177805735,
      "original_commit_id" : "aee37f2b62c72a0796557b92bf12fde6867dfbc5",
      "original_position" : 45,
      "path" : "src/txdb.cpp",
      "position" : 109,
      "pull_request_review_id" : 107747366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177805735",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177812638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177812638"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This check is too strict for the BlockConnected validationinterface callback - you really want some variant of the SetBestChain validationinterface callback (which is called when new blocks/header tree is flushed to disik). Practically, I'm not sure what the best way to sovle this is:\r\n * You could move txindex stuff to a cache ala pcoinsTip and then flush it on some SetBestChain variant (which would need to be tweaked to not have its own timer, which I think we should do anyway, and use the fPeriodicWrite bool or so), but then you'd need to plumb the txindex cache usage back into the FlushStateToDisk flush condition. I think this is probably the easiest approach, but people will probably not be too happy with the circular dependency here. You could get around that with some higher-level \"total memory usage tracking\" interface, but scope creep....\r\n * You could move to storing a locator in the txindex DB like the wallet does and then reconnect from that on startup from whatever the locator can find. This has a super weird edge-case where you may have dangling entries pointing to blocks which were stale, which were connected, (ie \"written\" to disk) but then lost as they were not flushed to disk, but that should be rare enough the overhead of DB entries isnt a big deal, as long as you handle such failed reads appropriately.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T16:36:58Z",
      "diff_hunk" : "@@ -0,0 +1,139 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177812638",
      "id" : 177812638,
      "original_commit_id" : "ae578cbee79f46d1b3b683ea46638ac997730bff",
      "original_position" : 63,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 107747366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177812638",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177828216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177828216"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It'd be nice to keep these kinds of globals in the same place. At least g_connman is in init.cpp and exposed as extern in net.h, so you could duplicate that (which is \"correct\" in that init \"owns\" the object).",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T17:27:10Z",
      "diff_hunk" : "@@ -13,6 +13,8 @@\n \n constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n \n+std::unique_ptr<TxIndex> g_txindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177828216",
      "id" : 177828216,
      "original_commit_id" : "8ac5ed122e45cae6081bd3fc4c243ca4135cccbe",
      "original_position" : 4,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 107747366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177828216",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177831648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177831648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should we not check the return of BlockUntilSyncedToCurrentChain and maybe always return an error before its even gotten close to caught up?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T17:37:55Z",
      "diff_hunk" : "@@ -350,6 +351,10 @@ static bool rest_tx(HTTPRequest* req, const std::string& strURIPart)\n     if (!ParseHashStr(hashStr, hash))\n         return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid hash: \" + hashStr);\n \n+    if (g_txindex) {\n+        g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177831648",
      "id" : 177831648,
      "in_reply_to_id" : 155908730,
      "original_commit_id" : "ae276cead580e459d881db5b7439b618ec0854a6",
      "original_position" : 13,
      "path" : "src/rest.cpp",
      "position" : 13,
      "pull_request_review_id" : 107747366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177831648",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177834651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177834651"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A distinct error code may make sense, though no opinion on what. Further, I'm not sure we should let GetTransaction call into the g_txindex if !f_txindex_ready (as it may return data from a stale block, but its also just generally not so useful). Maybe GetTransaction/FindTx can check if we're in sync yet.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T17:47:02Z",
      "diff_hunk" : "@@ -177,10 +183,12 @@ UniValue getrawtransaction(const JSONRPCRequest& request)\n                 throw JSONRPCError(RPC_MISC_ERROR, \"Block not available\");\n             }\n             errmsg = \"No such transaction found in the provided block\";\n+        } else if (!g_txindex) {\n+            errmsg = \"No such mempool transaction. Use -txindex to enable blockchain transaction queries\";\n+        } else if (!f_txindex_ready) {\n+            errmsg = \"No such mempool transaction. Blockchain transactions are still in the process of being indexed\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177834651",
      "id" : 177834651,
      "in_reply_to_id" : 167242419,
      "original_commit_id" : "c4401fc41422daa17df46e5945c35a55c1e0e8bd",
      "original_position" : 45,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 54,
      "pull_request_review_id" : 107747366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177834651",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177835267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177835267"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Also here - should report a different error of some kind if we're not in sync yet.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T17:49:14Z",
      "diff_hunk" : "@@ -229,29 +238,36 @@ UniValue gettxoutproof(const JSONRPCRequest& request)\n        oneTxid = hash;\n     }\n \n-    LOCK(cs_main);\n-\n     CBlockIndex* pblockindex = nullptr;\n-\n     uint256 hashBlock;\n-    if (!request.params[1].isNull())\n     {\n-        hashBlock = uint256S(request.params[1].get_str());\n-        pblockindex = LookupBlockIndex(hashBlock);\n-        if (!pblockindex) {\n-            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n-        }\n-    } else {\n-        // Loop through txids and try to find which block they're in. Exit loop once a block is found.\n-        for (const auto& tx : setTxids) {\n-            const Coin& coin = AccessByTxid(*pcoinsTip, tx);\n-            if (!coin.IsSpent()) {\n-                pblockindex = chainActive[coin.nHeight];\n-                break;\n+        LOCK(cs_main);\n+\n+        if (!request.params[1].isNull()) {\n+            hashBlock = uint256S(request.params[1].get_str());\n+            pblockindex = LookupBlockIndex(hashBlock);\n+            if (!pblockindex) {\n+                throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n+            }\n+        } else {\n+            // Loop through txids and try to find which block they're in. Exit loop once a block is found.\n+            for (const auto& tx : setTxids) {\n+                const Coin& coin = AccessByTxid(*pcoinsTip, tx);\n+                if (!coin.IsSpent()) {\n+                    pblockindex = chainActive[coin.nHeight];\n+                    break;\n+                }\n             }\n         }\n     }\n \n+    // Allow txindex to catch up if we need to query it and before we acquire cs_main.\n+    if (g_txindex && !pblockindex) {\n+        g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177835267",
      "id" : 177835267,
      "original_commit_id" : "013716e1f5f65ba8dcc24f2d5fbe26ac7e3743c5",
      "original_position" : 93,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 108,
      "pull_request_review_id" : 107747366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177835267",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177858240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177858240"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That's what I did originally, but that caused problems when building tests. The test binary is not linked against init.cpp, it's linked against test_bitcoin_main.cpp, which is why `g_connman` is also defined there. That took me an annoying amount of time to figure out, and by the time I did I was so pissed off I decided to move it to `txindex.cpp`.\r\n\r\nThis whole thing where stuff in init has to get redefined in `test_bitcoin_main.cpp` if it's used in the tests seems pretty gross. Do you really thing that's the right way to do it?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T19:05:49Z",
      "diff_hunk" : "@@ -13,6 +13,8 @@\n \n constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n \n+std::unique_ptr<TxIndex> g_txindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177858240",
      "id" : 177858240,
      "in_reply_to_id" : 177828216,
      "original_commit_id" : "8ac5ed122e45cae6081bd3fc4c243ca4135cccbe",
      "original_position" : 4,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 107810560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177858240",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177860703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177860703"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, yea, thats a bit gross. Still, if thats what we have now, maybe add a comment noting that in both places and at least be consistent?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-28T19:15:01Z",
      "diff_hunk" : "@@ -13,6 +13,8 @@\n \n constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n \n+std::unique_ptr<TxIndex> g_txindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r177860703",
      "id" : 177860703,
      "in_reply_to_id" : 177828216,
      "original_commit_id" : "8ac5ed122e45cae6081bd3fc4c243ca4135cccbe",
      "original_position" : 4,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 107813561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/177860703",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178184558"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178184558"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't understand. This line is in the `Init` method, not the BlockConnected callback. As long as we never prune entries from the block index, I don't see when this check would fail.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-29T21:20:34Z",
      "diff_hunk" : "@@ -0,0 +1,139 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178184558",
      "id" : 178184558,
      "in_reply_to_id" : 177812638,
      "original_commit_id" : "ae578cbee79f46d1b3b683ea46638ac997730bff",
      "original_position" : 63,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 108208042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178184558",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178187241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178187241"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd prefer to just move the definition of `g_connman` to `net.cpp` or define them in the respective header files. Any reason they need to be `extern`? @theuni ",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-29T21:31:55Z",
      "diff_hunk" : "@@ -13,6 +13,8 @@\n \n constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n \n+std::unique_ptr<TxIndex> g_txindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178187241",
      "id" : 178187241,
      "in_reply_to_id" : 177828216,
      "original_commit_id" : "8ac5ed122e45cae6081bd3fc4c243ca4135cccbe",
      "original_position" : 4,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 108211243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178187241",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178188635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178188635"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point, that's not necessary.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-29T21:38:24Z",
      "diff_hunk" : "@@ -458,3 +458,116 @@ bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n     }\n     return false;\n }\n+\n+/*\n+ * Safely persist a transfer of data from the old txindex database to the new one, and compact the\n+ * range of keys updated. This is used internally by MigrateData.\n+ */\n+static void WriteTxIndexMigrationBatches(TxIndexDB& newdb, CBlockTreeDB& olddb,\n+                                         CDBBatch& batch_newdb, CDBBatch& batch_olddb,\n+                                         const std::pair<unsigned char, uint256>& begin_key,\n+                                         const std::pair<unsigned char, uint256>& end_key)\n+{\n+    // Sync new DB changes to disk before deleting from old DB.\n+    newdb.WriteBatch(batch_newdb, /*fSync=*/ true);\n+    olddb.WriteBatch(batch_olddb);\n+\n+    batch_newdb.Clear();\n+    batch_olddb.Clear();\n+\n+    newdb.CompactRange(begin_key, end_key);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178188635",
      "id" : 178188635,
      "in_reply_to_id" : 177805608,
      "original_commit_id" : "aee37f2b62c72a0796557b92bf12fde6867dfbc5",
      "original_position" : 21,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 108212902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178188635",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178217315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178217315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, it's best effort, just like the lookup from CCoinsCacheView. If there's a response, great, otherwise the error message says that the not found may be inclusive. I agree that's kind of a weird behavior for the RPC, but if we change it, I could make the same argument for just removing the CCoinsCacheView lookup.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-30T01:23:47Z",
      "diff_hunk" : "@@ -177,10 +183,12 @@ UniValue getrawtransaction(const JSONRPCRequest& request)\n                 throw JSONRPCError(RPC_MISC_ERROR, \"Block not available\");\n             }\n             errmsg = \"No such transaction found in the provided block\";\n+        } else if (!g_txindex) {\n+            errmsg = \"No such mempool transaction. Use -txindex to enable blockchain transaction queries\";\n+        } else if (!f_txindex_ready) {\n+            errmsg = \"No such mempool transaction. Blockchain transactions are still in the process of being indexed\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178217315",
      "id" : 178217315,
      "in_reply_to_id" : 167242419,
      "original_commit_id" : "c4401fc41422daa17df46e5945c35a55c1e0e8bd",
      "original_position" : 45,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 54,
      "pull_request_review_id" : 108246501,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178217315",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I'd very much like to get rid of the UTXO based block lookup. It's unreliable (depends on having at least one unspent output left for the transaction), is slow (needs to load and scan the entire block) and probably unused. There is an issue for it somewhere, but I think we'll want a deprecation for it first.\n\nOne way to deal with it is introducing a new RPC `getchaintransaction` or so, which strictly only works when txindex is enabled. Then `getrawtransaction` can be deprecated with a warning saying you can use `getmempoolentry` for unconfirmed transactions, and `getchaintransaction` for confirmed ones (if txindex is enabled).",
      "created_at" : "2018-03-30T01:40:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-377421311",
      "id" : 377421311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-30T01:40:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/377421311",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178323651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178323651"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A block may be connected, but the block index may not be written to disk until much later. Thus, we can run far ahead here. Specifically, we flush in the following order:\r\n* Blocks are written to disk before connecting them (but not fsync'd, so not guarantees here!). At the same time entries are added to mapBlockIndex/CBlockIndex*s are created, but not flushed to disk)\r\n* Blocks are validated/connected, generating BlockConnected callbacks.\r\n* At some point in the future, flushing happens, where we first fsync the blocks written to disk, then write out the mapBlockIndex changes, then write out pcoinsTip/UTXO DB.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-30T16:34:58Z",
      "diff_hunk" : "@@ -0,0 +1,139 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178323651",
      "id" : 178323651,
      "in_reply_to_id" : 177812638,
      "original_commit_id" : "ae578cbee79f46d1b3b683ea46638ac997730bff",
      "original_position" : 63,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 108371943,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178323651",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178329846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178329846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you think of this approach? https://github.com/bitcoin/bitcoin/pull/11857/commits/c3b34b1b62ab034c5d6b6d700ae378291b19fc4b",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-30T17:10:14Z",
      "diff_hunk" : "@@ -458,3 +458,116 @@ bool TxIndexDB::ReadBestBlockHash(uint256& hash) const {\n     }\n     return false;\n }\n+\n+/*\n+ * Safely persist a transfer of data from the old txindex database to the new one, and compact the\n+ * range of keys updated. This is used internally by MigrateData.\n+ */\n+static void WriteTxIndexMigrationBatches(TxIndexDB& newdb, CBlockTreeDB& olddb,\n+                                         CDBBatch& batch_newdb, CDBBatch& batch_olddb,\n+                                         const std::pair<unsigned char, uint256>& begin_key,\n+                                         const std::pair<unsigned char, uint256>& end_key)\n+{\n+    // Sync new DB changes to disk before deleting from old DB.\n+    newdb.WriteBatch(batch_newdb, /*fSync=*/ true);\n+    olddb.WriteBatch(batch_olddb);\n+\n+    batch_newdb.Clear();\n+    batch_olddb.Clear();\n+\n+    newdb.CompactRange(begin_key, end_key);\n+    olddb.CompactRange(begin_key, end_key);\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. The flag signals\n+    // whether any txindex data is present in the block_tree_db. If the flag is\n+    // not set, either the txindex did not exist or was already migrated.\n+    bool f_migrate_index = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n+    if (!f_migrate_index) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178329846",
      "id" : 178329846,
      "in_reply_to_id" : 177805735,
      "original_commit_id" : "aee37f2b62c72a0796557b92bf12fde6867dfbc5",
      "original_position" : 45,
      "path" : "src/txdb.cpp",
      "position" : 109,
      "pull_request_review_id" : 108379405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178329846",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178331224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178331224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The error here already is not that useful and does not even indicate if the txindex is disabled. I'd like to fix this in a follow-up PR.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-03-30T17:17:41Z",
      "diff_hunk" : "@@ -229,29 +238,36 @@ UniValue gettxoutproof(const JSONRPCRequest& request)\n        oneTxid = hash;\n     }\n \n-    LOCK(cs_main);\n-\n     CBlockIndex* pblockindex = nullptr;\n-\n     uint256 hashBlock;\n-    if (!request.params[1].isNull())\n     {\n-        hashBlock = uint256S(request.params[1].get_str());\n-        pblockindex = LookupBlockIndex(hashBlock);\n-        if (!pblockindex) {\n-            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n-        }\n-    } else {\n-        // Loop through txids and try to find which block they're in. Exit loop once a block is found.\n-        for (const auto& tx : setTxids) {\n-            const Coin& coin = AccessByTxid(*pcoinsTip, tx);\n-            if (!coin.IsSpent()) {\n-                pblockindex = chainActive[coin.nHeight];\n-                break;\n+        LOCK(cs_main);\n+\n+        if (!request.params[1].isNull()) {\n+            hashBlock = uint256S(request.params[1].get_str());\n+            pblockindex = LookupBlockIndex(hashBlock);\n+            if (!pblockindex) {\n+                throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n+            }\n+        } else {\n+            // Loop through txids and try to find which block they're in. Exit loop once a block is found.\n+            for (const auto& tx : setTxids) {\n+                const Coin& coin = AccessByTxid(*pcoinsTip, tx);\n+                if (!coin.IsSpent()) {\n+                    pblockindex = chainActive[coin.nHeight];\n+                    break;\n+                }\n             }\n         }\n     }\n \n+    // Allow txindex to catch up if we need to query it and before we acquire cs_main.\n+    if (g_txindex && !pblockindex) {\n+        g_txindex->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178331224",
      "id" : 178331224,
      "in_reply_to_id" : 177835267,
      "original_commit_id" : "013716e1f5f65ba8dcc24f2d5fbe26ac7e3743c5",
      "original_position" : 93,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 108,
      "pull_request_review_id" : 108381018,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178331224",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@TheBlueMatt @sipa I'd prefer to handle some of your suggestions about getrawtransaction (better error reporting, no UTXO lookup, moving GetTransaction out of validation, etc.) in a follow-up PR because this one is already 700+ lines. Commit https://github.com/jimpo/bitcoin/commit/2b8ee538bf804bcd2d30942d1254d147e65f2ee3 is a starting point.",
      "created_at" : "2018-03-30T17:19:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-377574766",
      "id" : 377574766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-30T17:19:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/377574766",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "@jimpo Sorry if I was unclear; my message above was just to give some background thoughts and not a request to further change this PR itself.\n\nI'll review the code soon.",
      "created_at" : "2018-03-30T18:15:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-377587439",
      "id" : 377587439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-03-30T18:15:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/377587439",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178703570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178703570"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See last two commits (c837c6c & 297f89c) for fix.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-03T03:12:27Z",
      "diff_hunk" : "@@ -0,0 +1,139 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178703570",
      "id" : 178703570,
      "in_reply_to_id" : 177812638,
      "original_commit_id" : "ae578cbee79f46d1b3b683ea46638ac997730bff",
      "original_position" : 63,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 108803916,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178703570",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178897768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178897768"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"!fixup Migration to handle downgrades gracefully.\"\r\n\r\nI really like this `DB_TXINDEX_BLOCK` solution to the problem of recovering from an interrupted upgrade. It's surprisingly simple.\r\n\r\nNot sure if it's worth the additional work, but it seems it'd be possible to write some simple unit tests that exercise this code by running it on databases with known states (with \"txindex\", with both \"txindex\" and BLOCK, with BLOCK but no txindex, etc) and checking the results.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-03T17:13:54Z",
      "diff_hunk" : "@@ -471,23 +472,41 @@ static void WriteTxIndexMigrationBatches(TxIndexDB& newdb, CBlockTreeDB& olddb,\n     // Sync new DB changes to disk before deleting from old DB.\n     newdb.WriteBatch(batch_newdb, /*fSync=*/ true);\n     olddb.WriteBatch(batch_olddb);\n+    olddb.CompactRange(begin_key, end_key);\n \n     batch_newdb.Clear();\n     batch_olddb.Clear();\n-\n-    newdb.CompactRange(begin_key, end_key);\n-    olddb.CompactRange(begin_key, end_key);\n }\n \n-bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& block_hash)\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const uint256& tip_hash)\n {\n     // The prior implementation of txindex was always in sync with block index\n-    // and presence was indicated with a boolean DB flag. The flag signals\n-    // whether any txindex data is present in the block_tree_db. If the flag is\n-    // not set, either the txindex did not exist or was already migrated.\n-    bool f_migrate_index = false;\n-    block_tree_db.ReadFlag(\"txindex\", f_migrate_index);\n-    if (!f_migrate_index) {\n+    // and presence was indicated with a boolean DB flag. If the flag is set,\n+    // this means the txindex from a previous version is valid and in sync with\n+    // the chain tip. The first step of the migration is to unset the flag and\n+    // write the chain hash to a separate key, DB_TXINDEX_BLOCK. After that, the\n+    // index entries are copied over in batches to the new database. Finally,\n+    // DB_TXINDEX_BLOCK is erased from the old database and the block hash is\n+    // written to the new database.\n+    //\n+    // Unsetting the boolean flag ensures that if the node is downgraded to a\n+    // previous version, it will not see a corrupted, partially migrated index\n+    // -- it will see that the txindex is disabled. When the node is upgraded\n+    // again, the migration will pick up where it left off and sync to the block\n+    // with hash DB_TXINDEX_BLOCK.\n+    bool f_legacy_flag = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_legacy_flag);\n+    if (f_legacy_flag) {\n+        if (!block_tree_db.Write(DB_TXINDEX_BLOCK, tip_hash)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178897768",
      "id" : 178897768,
      "original_commit_id" : "c3b34b1b62ab034c5d6b6d700ae378291b19fc4b",
      "original_position" : 47,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 109038387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178897768",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178907241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178907241"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"!fixup Change TxIndexDB to read/write locators instead of hashes.\"\r\n\r\nWould it make sense to assert `locator.front() == m_best_block_index.GetBlockHash()` as a sanity check on event ordering?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-03T17:45:49Z",
      "diff_hunk" : "@@ -195,6 +183,16 @@ void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const C\n     }\n }\n \n+void TxIndex::SetBestChain(const CBlockLocator& locator)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+    if (!m_db->WriteBestBlock(locator)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178907241",
      "id" : 178907241,
      "original_commit_id" : "297f89cad4808b3499d290bdadb5c4863a94fdd7",
      "original_position" : 76,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 109038387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178907241",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178913914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178913914"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[index] Create new TxIndex class.\"\r\n\r\nIt still seems to me like it would be possible (though unlikely) for these errors to trigger spuriously, even when the events arrive in the right order, but the notification queue gets backlogged: https://github.com/bitcoin/bitcoin/pull/11857#discussion_r175614840\r\n\r\nIf this is true, the current comment seems misleading, and could mention the edge case.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-03T18:08:11Z",
      "diff_hunk" : "@@ -0,0 +1,271 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, chainActive.GetLocator())) {\n+        return false;\n+    }\n+\n+    CBlockLocator locator;\n+    if (!m_db->ReadBestBlock(locator)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    const CBlockIndex* pindex = FindForkInGlobalIndex(chainActive, locator);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex == chainActive.Tip()) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    const CBlockIndex* pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    const CBlockIndex* pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                const CBlockIndex* pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    if (!m_db->WriteBestBlock(chainActive.GetLocator())) {\n+                        error(\"%s: Failed to write locator to disk\", __func__);\n+                    }\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\");\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos);\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block. This should always be the\n+    // case assuming BlockConnected is called on the ValidationInterfaces in the proper order.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r178913914",
      "id" : 178913914,
      "original_commit_id" : "297f89cad4808b3499d290bdadb5c4863a94fdd7",
      "original_position" : 160,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 109038387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178913914",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tested 806b2f1, including interrupting the migration from legacy to the new db.\r\n\r\nIf someone wants to do a partial backport, the migration code that removes txindex without requiring a reindex would be useful for folks who regret having set `txindex=1` on a node with slow hardware.",
      "created_at" : "2018-04-04T15:34:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-378644032",
      "id" : 378644032,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-04-04T15:34:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378644032",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r179296749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179296749"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, that's a good idea.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-04T22:02:29Z",
      "diff_hunk" : "@@ -195,6 +183,16 @@ void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const C\n     }\n }\n \n+void TxIndex::SetBestChain(const CBlockLocator& locator)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+    if (!m_db->WriteBestBlock(locator)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r179296749",
      "id" : 179296749,
      "in_reply_to_id" : 178907241,
      "original_commit_id" : "297f89cad4808b3499d290bdadb5c4863a94fdd7",
      "original_position" : 76,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 109516588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179296749",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r179297158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179297158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, got it. Will update the comment and make this a warning log instead of a fatal error.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-04T22:04:26Z",
      "diff_hunk" : "@@ -0,0 +1,138 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    const CBlockIndex* chain_tip = chainActive.Tip();\n+    uint256 tip_hash;\n+    if (chain_tip) {\n+        tip_hash = chain_tip->GetBlockHash();\n+    }\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, tip_hash)) {\n+        return false;\n+    }\n+\n+    if (!chain_tip) {\n+        m_synced = true;\n+        return true;\n+    }\n+\n+    uint256 best_block_hash;\n+    if (!m_db->ReadBestBlockHash(best_block_hash)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    if (best_block_hash.IsNull()) {\n+        return true;\n+    }\n+\n+    const CBlockIndex* pindex = LookupBlockIndex(best_block_hash);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos, pindex->GetBlockHash());\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r179297158",
      "id" : 179297158,
      "in_reply_to_id" : 174577538,
      "original_commit_id" : "478e5db2d740ba31d1176d8670b3dacfebb5f5fb",
      "original_position" : 94,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 109517053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179297158",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r179310578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179310578"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed the comment and error handling.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-04T23:14:55Z",
      "diff_hunk" : "@@ -0,0 +1,271 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, chainActive.GetLocator())) {\n+        return false;\n+    }\n+\n+    CBlockLocator locator;\n+    if (!m_db->ReadBestBlock(locator)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    const CBlockIndex* pindex = FindForkInGlobalIndex(chainActive, locator);\n+    if (!pindex) {\n+        FatalError(\"%s: Last block synced by txindex is unknown\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = pindex;\n+    if (pindex == chainActive.Tip()) {\n+        m_synced = true;\n+    }\n+\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    const CBlockIndex* pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    const CBlockIndex* pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                const CBlockIndex* pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    if (!m_db->WriteBestBlock(chainActive.GetLocator())) {\n+                        error(\"%s: Failed to write locator to disk\", __func__);\n+                    }\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\");\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos);\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    // Ensure block connects to an ancestor of the current best block. This should always be the\n+    // case assuming BlockConnected is called on the ValidationInterfaces in the proper order.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r179310578",
      "id" : 179310578,
      "in_reply_to_id" : 178913914,
      "original_commit_id" : "297f89cad4808b3499d290bdadb5c4863a94fdd7",
      "original_position" : 160,
      "path" : "src/index/txindex.cpp",
      "position" : null,
      "pull_request_review_id" : 109532406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-04T23:14:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/179310578",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2018-04-05T20:16:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-379062978",
      "id" : 379062978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-04-05T20:16:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/379062978",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> warning saying you can use getmempoolentry for unconfirmed transactions\r\n@sipa But getmempoolentry doesn't give you the same data as getrawtransaction (I guess it could be extended to do so optionally).\r\n",
      "created_at" : "2018-04-05T20:20:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#issuecomment-379063844",
      "id" : 379063844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
      "updated_at" : "2018-04-05T20:20:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/379063844",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180842468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180842468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you end up having to change this PR for other reasons, might be worth leaving a comment to note that this works because leveldb is sorted by key and that you're making use of the first two bytes of the txid here. It took me a little head-scratching to see what was going on here (thanks to @ryanofsky for the help).",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-11T17:51:12Z",
      "diff_hunk" : "@@ -424,3 +425,171 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxs(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlock(CBlockLocator& locator) const\n+{\n+    if (Read(DB_BEST_BLOCK, locator)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        locator.SetNull();\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool TxIndexDB::WriteBestBlock(const CBlockLocator& locator)\n+{\n+    return Write(DB_BEST_BLOCK, locator);\n+}\n+\n+/*\n+ * Safely persist a transfer of data from the old txindex database to the new one, and compact the\n+ * range of keys updated. This is used internally by MigrateData.\n+ */\n+static void WriteTxIndexMigrationBatches(TxIndexDB& newdb, CBlockTreeDB& olddb,\n+                                         CDBBatch& batch_newdb, CDBBatch& batch_olddb,\n+                                         const std::pair<unsigned char, uint256>& begin_key,\n+                                         const std::pair<unsigned char, uint256>& end_key)\n+{\n+    // Sync new DB changes to disk before deleting from old DB.\n+    newdb.WriteBatch(batch_newdb, /*fSync=*/ true);\n+    olddb.WriteBatch(batch_olddb);\n+    olddb.CompactRange(begin_key, end_key);\n+\n+    batch_newdb.Clear();\n+    batch_olddb.Clear();\n+}\n+\n+bool TxIndexDB::MigrateData(CBlockTreeDB& block_tree_db, const CBlockLocator& best_locator)\n+{\n+    // The prior implementation of txindex was always in sync with block index\n+    // and presence was indicated with a boolean DB flag. If the flag is set,\n+    // this means the txindex from a previous version is valid and in sync with\n+    // the chain tip. The first step of the migration is to unset the flag and\n+    // write the chain hash to a separate key, DB_TXINDEX_BLOCK. After that, the\n+    // index entries are copied over in batches to the new database. Finally,\n+    // DB_TXINDEX_BLOCK is erased from the old database and the block hash is\n+    // written to the new database.\n+    //\n+    // Unsetting the boolean flag ensures that if the node is downgraded to a\n+    // previous version, it will not see a corrupted, partially migrated index\n+    // -- it will see that the txindex is disabled. When the node is upgraded\n+    // again, the migration will pick up where it left off and sync to the block\n+    // with hash DB_TXINDEX_BLOCK.\n+    bool f_legacy_flag = false;\n+    block_tree_db.ReadFlag(\"txindex\", f_legacy_flag);\n+    if (f_legacy_flag) {\n+        if (!block_tree_db.Write(DB_TXINDEX_BLOCK, best_locator)) {\n+            return error(\"%s: cannot write block indicator\", __func__);\n+        }\n+        if (!block_tree_db.WriteFlag(\"txindex\", false)) {\n+            return error(\"%s: cannot write block index db flag\", __func__);\n+        }\n+    }\n+\n+    CBlockLocator locator;\n+    if (!block_tree_db.Read(DB_TXINDEX_BLOCK, locator)) {\n+        return true;\n+    }\n+\n+    int64_t count = 0;\n+    LogPrintf(\"Upgrading txindex database...\\n\");\n+    LogPrintf(\"[0%%]...\");\n+    uiInterface.ShowProgress(_(\"Upgrading txindex database\"), 0, true);\n+    int report_done = 0;\n+    const size_t batch_size = 1 << 24; // 16 MiB\n+\n+    CDBBatch batch_newdb(*this);\n+    CDBBatch batch_olddb(block_tree_db);\n+\n+    std::pair<unsigned char, uint256> key;\n+    std::pair<unsigned char, uint256> begin_key{DB_TXINDEX, uint256()};\n+    std::pair<unsigned char, uint256> prev_key = begin_key;\n+\n+    bool interrupted = false;\n+    std::unique_ptr<CDBIterator> cursor(block_tree_db.NewIterator());\n+    for (cursor->Seek(begin_key); cursor->Valid(); cursor->Next()) {\n+        boost::this_thread::interruption_point();\n+        if (ShutdownRequested()) {\n+            interrupted = true;\n+            break;\n+        }\n+\n+        if (!cursor->GetKey(key)) {\n+            return error(\"%s: cannot get key from valid cursor\", __func__);\n+        }\n+        if (key.first != DB_TXINDEX) {\n+            break;\n+        }\n+\n+        // Log progress every 10%.\n+        if (++count % 256 == 0) {\n+            uint32_t high = 0x100 * *key.second.begin() + *(key.second.begin() + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180842468",
      "id" : 180842468,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 133,
      "path" : "src/txdb.cpp",
      "position" : 133,
      "pull_request_review_id" : 111336513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-11T21:06:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180842468",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180884263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180884263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we made this call in `TxIndex::BlockConnected` it seems like we could avoid defining this entire function. Is the reason you're not doing it there for efficiency's sake (e.g. maybe you're worried about the expense of constructing a locator)?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-11T20:16:57Z",
      "diff_hunk" : "@@ -0,0 +1,294 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, chainActive.GetLocator())) {\n+        return false;\n+    }\n+\n+    CBlockLocator locator;\n+    if (!m_db->ReadBestBlock(locator)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n+    m_synced = m_best_block_index.load() == chainActive.Tip();\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    const CBlockIndex* pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    const CBlockIndex* pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                const CBlockIndex* pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    if (!m_db->WriteBestBlock(chainActive.GetLocator())) {\n+                        error(\"%s: Failed to write locator to disk\", __func__);\n+                    }\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\");\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos);\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        // Ensure block connects to an ancestor of the current best block. This should be the case\n+        // most of the time, but may not be immediately after the the sync thread catches up and sets\n+        // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n+        // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n+        // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            LogPrintf(\"%s: WARNING: Block %s does not connect to an ancestor of known best chain \"\n+                      \"(tip=%s); not updating txindex\\n\",\n+                      __func__, pindex->GetBlockHash().ToString(),\n+                      best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+void TxIndex::SetBestChain(const CBlockLocator& locator)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const uint256& locator_tip_hash = locator.vHave.front();\n+    const CBlockIndex* locator_tip_index;\n+    {\n+        LOCK(cs_main);\n+        locator_tip_index = LookupBlockIndex(locator_tip_hash);\n+    }\n+\n+    if (!locator_tip_index) {\n+        FatalError(\"%s: First block (hash=%s) in locator was not found\",\n+                   __func__, locator_tip_hash.ToString());\n+        return;\n+    }\n+\n+    // This checks that SetBestChain callbacks are received after BlockConnected. The check may fail\n+    // immediately after the the sync thread catches up and sets m_synced. Consider the case where\n+    // there is a reorg and the blocks on the stale branch are in the ValidationInterface queue\n+    // backlog even after the sync thread has caught up to the new chain tip. In this unlikely\n+    // event, log a warning and let the queue clear.\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n+        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best chain \"\n+                  \"(tip=%s); not writing txindex locator\\n\",\n+                  __func__, locator_tip_hash.ToString(),\n+                  best_block_index->GetBlockHash().ToString());\n+        return;\n+    }\n+\n+    if (!m_db->WriteBestBlock(locator)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180884263",
      "id" : 180884263,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 214,
      "path" : "src/index/txindex.cpp",
      "position" : 214,
      "pull_request_review_id" : 111336513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-11T21:06:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180884263",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180885992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180885992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're only ever using the tip of this locator to populate `m_best_block_index` in `TxIndex::Init()`, have you considered storing a single blockhash instead of a locator here? I guess there may be some beneficial future-proofing to having a locator on hand, but it's a bit more expensive to maintain (c.f. my comment on possibly eliminating `TxIndex::SetBestChain`).",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-11T20:22:55Z",
      "diff_hunk" : "@@ -126,4 +124,36 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/**\n+ * Access to the txindex database (indexes/txindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the TxIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class TxIndexDB : public CDBWrapper\n+{\n+public:\n+    explicit TxIndexDB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /// Read the disk location of the transaction data with the given hash. Returns false if the\n+    /// transaction hash is not indexed.\n+    bool ReadTxPos(const uint256& txid, CDiskTxPos& pos) const;\n+\n+    /// Write a batch of transaction positions to the DB.\n+    bool WriteTxs(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos);\n+\n+    /// Read block locator of the chain that the txindex is in sync with.\n+    bool ReadBestBlock(CBlockLocator& hash) const;\n+\n+    /// Write block locator of the chain that the txindex is in sync with.\n+    bool WriteBestBlock(const CBlockLocator& locator);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180885992",
      "id" : 180885992,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 56,
      "path" : "src/txdb.h",
      "position" : 56,
      "pull_request_review_id" : 111336513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-11T21:06:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180885992",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180888339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180888339"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just curious: under what circumstances would a chainActive `best_block_index` have ever surpassed `chainActive.Tip()`?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-11T20:30:57Z",
      "diff_hunk" : "@@ -0,0 +1,294 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, chainActive.GetLocator())) {\n+        return false;\n+    }\n+\n+    CBlockLocator locator;\n+    if (!m_db->ReadBestBlock(locator)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n+    m_synced = m_best_block_index.load() == chainActive.Tip();\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    const CBlockIndex* pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    const CBlockIndex* pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                const CBlockIndex* pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    if (!m_db->WriteBestBlock(chainActive.GetLocator())) {\n+                        error(\"%s: Failed to write locator to disk\", __func__);\n+                    }\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\");\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos);\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        // Ensure block connects to an ancestor of the current best block. This should be the case\n+        // most of the time, but may not be immediately after the the sync thread catches up and sets\n+        // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n+        // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n+        // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            LogPrintf(\"%s: WARNING: Block %s does not connect to an ancestor of known best chain \"\n+                      \"(tip=%s); not updating txindex\\n\",\n+                      __func__, pindex->GetBlockHash().ToString(),\n+                      best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+void TxIndex::SetBestChain(const CBlockLocator& locator)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const uint256& locator_tip_hash = locator.vHave.front();\n+    const CBlockIndex* locator_tip_index;\n+    {\n+        LOCK(cs_main);\n+        locator_tip_index = LookupBlockIndex(locator_tip_hash);\n+    }\n+\n+    if (!locator_tip_index) {\n+        FatalError(\"%s: First block (hash=%s) in locator was not found\",\n+                   __func__, locator_tip_hash.ToString());\n+        return;\n+    }\n+\n+    // This checks that SetBestChain callbacks are received after BlockConnected. The check may fail\n+    // immediately after the the sync thread catches up and sets m_synced. Consider the case where\n+    // there is a reorg and the blocks on the stale branch are in the ValidationInterface queue\n+    // backlog even after the sync thread has caught up to the new chain tip. In this unlikely\n+    // event, log a warning and let the queue clear.\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n+        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best chain \"\n+                  \"(tip=%s); not writing txindex locator\\n\",\n+                  __func__, locator_tip_hash.ToString(),\n+                  best_block_index->GetBlockHash().ToString());\n+        return;\n+    }\n+\n+    if (!m_db->WriteBestBlock(locator)) {\n+        error(\"%s: Failed to write locator to disk\", __func__);\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip().\n+        LOCK(cs_main);\n+        const CBlockIndex* chain_tip = chainActive.Tip();\n+        const CBlockIndex* best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180888339",
      "id" : 180888339,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 233,
      "path" : "src/index/txindex.cpp",
      "position" : 233,
      "pull_request_review_id" : 111336513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-11T21:06:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180888339",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180897285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180897285"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@jamesob got me looking into this code, but since Stop() is called from the destructor, is it ok to call this here, or is there a problem like https://github.com/bitcoin/bitcoin/pull/12647#discussion_r179790601?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-11T21:02:35Z",
      "diff_hunk" : "@@ -0,0 +1,294 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, chainActive.GetLocator())) {\n+        return false;\n+    }\n+\n+    CBlockLocator locator;\n+    if (!m_db->ReadBestBlock(locator)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n+    m_synced = m_best_block_index.load() == chainActive.Tip();\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    const CBlockIndex* pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    const CBlockIndex* pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                const CBlockIndex* pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    if (!m_db->WriteBestBlock(chainActive.GetLocator())) {\n+                        error(\"%s: Failed to write locator to disk\", __func__);\n+                    }\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\");\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos);\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        // Ensure block connects to an ancestor of the current best block. This should be the case\n+        // most of the time, but may not be immediately after the the sync thread catches up and sets\n+        // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n+        // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n+        // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            LogPrintf(\"%s: WARNING: Block %s does not connect to an ancestor of known best chain \"\n+                      \"(tip=%s); not updating txindex\\n\",\n+                      __func__, pindex->GetBlockHash().ToString(),\n+                      best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+void TxIndex::SetBestChain(const CBlockLocator& locator)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const uint256& locator_tip_hash = locator.vHave.front();\n+    const CBlockIndex* locator_tip_index;\n+    {\n+        LOCK(cs_main);\n+        locator_tip_index = LookupBlockIndex(locator_tip_hash);\n+    }\n+\n+    if (!locator_tip_index) {\n+        FatalError(\"%s: First block (hash=%s) in locator was not found\",\n+                   __func__, locator_tip_hash.ToString());\n+        return;\n+    }\n+\n+    // This checks that SetBestChain callbacks are received after BlockConnected. The check may fail\n+    // immediately after the the sync thread catches up and sets m_synced. Consider the case where\n+    // there is a reorg and the blocks on the stale branch are in the ValidationInterface queue\n+    // backlog even after the sync thread has caught up to the new chain tip. In this unlikely\n+    // event, log a warning and let the queue clear.\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n+        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best chain \"\n+                  \"(tip=%s); not writing txindex locator\\n\",\n+                  __func__, locator_tip_hash.ToString(),\n+                  best_block_index->GetBlockHash().ToString());\n+        return;\n+    }\n+\n+    if (!m_db->WriteBestBlock(locator)) {\n+        error(\"%s: Failed to write locator to disk\", __func__);\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip().\n+        LOCK(cs_main);\n+        const CBlockIndex* chain_tip = chainActive.Tip();\n+        const CBlockIndex* best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n+            return true;\n+        }\n+    }\n+\n+    LogPrintf(\"%s: txindex is catching up on block notifications\\n\", __func__);\n+    SyncWithValidationInterfaceQueue();\n+    return true;\n+}\n+\n+bool TxIndex::FindTx(const uint256& tx_hash, uint256& block_hash, CTransactionRef& tx) const\n+{\n+    CDiskTxPos postx;\n+    if (!m_db->ReadTxPos(tx_hash, postx)) {\n+        return false;\n+    }\n+\n+    CAutoFile file(OpenBlockFile(postx, true), SER_DISK, CLIENT_VERSION);\n+    if (file.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed\", __func__);\n+    }\n+    CBlockHeader header;\n+    try {\n+        file >> header;\n+        fseek(file.Get(), postx.nTxOffset, SEEK_CUR);\n+        file >> tx;\n+    } catch (const std::exception& e) {\n+        return error(\"%s: Deserialize or I/O error - %s\", __func__, e.what());\n+    }\n+    if (tx->GetHash() != tx_hash) {\n+        return error(\"%s: txid mismatch\", __func__);\n+    }\n+    block_hash = header.GetHash();\n+    return true;\n+}\n+\n+void TxIndex::Interrupt()\n+{\n+    m_interrupt();\n+}\n+\n+void TxIndex::Start()\n+{\n+    // Need to register this ValidationInterface before running Init(), so that\n+    // callbacks are not missed if Init sets m_synced to true.\n+    RegisterValidationInterface(this);\n+    if (!Init()) {\n+        return;\n+    }\n+\n+    m_thread_sync = std::thread(&TraceThread<std::function<void()>>, \"txindex\",\n+                                std::bind(&TxIndex::ThreadSync, this));\n+}\n+\n+void TxIndex::Stop()\n+{\n+    UnregisterValidationInterface(this);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r180897285",
      "id" : 180897285,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 289,
      "path" : "src/index/txindex.cpp",
      "position" : 289,
      "pull_request_review_id" : 111401714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-11T21:02:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/180897285",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181131048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181131048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I think this return value is a bit confusing; if we didn't actually read the best block, why would we return true (regardless of the reason)?",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-12T15:48:16Z",
      "diff_hunk" : "@@ -424,3 +425,171 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+TxIndexDB::TxIndexDB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    CDBWrapper(GetDataDir() / \"indexes\" / \"txindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool TxIndexDB::ReadTxPos(const uint256 &txid, CDiskTxPos& pos) const\n+{\n+    return Read(std::make_pair(DB_TXINDEX, txid), pos);\n+}\n+\n+bool TxIndexDB::WriteTxs(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : v_pos) {\n+        batch.Write(std::make_pair(DB_TXINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool TxIndexDB::ReadBestBlock(CBlockLocator& locator) const\n+{\n+    if (Read(DB_BEST_BLOCK, locator)) {\n+        return true;\n+    }\n+\n+    // Read might have failed either because key does not exist or due to an error.\n+    // If the former, return value should still be true.\n+    if (!Exists(DB_BEST_BLOCK)) {\n+        locator.SetNull();\n+        return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181131048",
      "id" : 181131048,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 41,
      "path" : "src/txdb.cpp",
      "position" : 41,
      "pull_request_review_id" : 111682712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-12T21:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181131048",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181175539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181175539"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "So `TxIndex::Init()` uses `FindForkInGlobalIndex` to populate `m_best_block_index`, which may not necessarily be the tip of the locator. One case where it might not be is when the active chain locator is written at the end of ThreadSync, which may contain locator entries for blocks that have not been flushed to disk.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-12T18:16:17Z",
      "diff_hunk" : "@@ -126,4 +124,36 @@ class CBlockTreeDB : public CDBWrapper\n     bool LoadBlockIndexGuts(const Consensus::Params& consensusParams, std::function<CBlockIndex*(const uint256&)> insertBlockIndex);\n };\n \n+/**\n+ * Access to the txindex database (indexes/txindex/)\n+ *\n+ * The database stores a block locator of the chain the database is synced to\n+ * so that the TxIndex can efficiently determine the point it last stopped at.\n+ * A locator is used instead of a simple hash of the chain tip because blocks\n+ * and block index entries may not be flushed to disk until after this database\n+ * is updated.\n+ */\n+class TxIndexDB : public CDBWrapper\n+{\n+public:\n+    explicit TxIndexDB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    /// Read the disk location of the transaction data with the given hash. Returns false if the\n+    /// transaction hash is not indexed.\n+    bool ReadTxPos(const uint256& txid, CDiskTxPos& pos) const;\n+\n+    /// Write a batch of transaction positions to the DB.\n+    bool WriteTxs(const std::vector<std::pair<uint256, CDiskTxPos>>& v_pos);\n+\n+    /// Read block locator of the chain that the txindex is in sync with.\n+    bool ReadBestBlock(CBlockLocator& hash) const;\n+\n+    /// Write block locator of the chain that the txindex is in sync with.\n+    bool WriteBestBlock(const CBlockLocator& locator);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181175539",
      "id" : 181175539,
      "in_reply_to_id" : 180885992,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 56,
      "path" : "src/txdb.h",
      "position" : 56,
      "pull_request_review_id" : 111736425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-12T18:16:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181175539",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181177572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181177572"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "One scenario is if `ActivateBestChainStep` attempts to reorg to an invalid chain. So it would disconnect a few blocks, then realize that one of the blocks it tries to connect is invalid, leaving the tip at a lower height than it started. I suppose `InvalidateBlock` could cause this too.",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-12T18:23:09Z",
      "diff_hunk" : "@@ -0,0 +1,294 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, chainActive.GetLocator())) {\n+        return false;\n+    }\n+\n+    CBlockLocator locator;\n+    if (!m_db->ReadBestBlock(locator)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n+    m_synced = m_best_block_index.load() == chainActive.Tip();\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    const CBlockIndex* pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    const CBlockIndex* pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                const CBlockIndex* pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    if (!m_db->WriteBestBlock(chainActive.GetLocator())) {\n+                        error(\"%s: Failed to write locator to disk\", __func__);\n+                    }\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\");\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos);\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        // Ensure block connects to an ancestor of the current best block. This should be the case\n+        // most of the time, but may not be immediately after the the sync thread catches up and sets\n+        // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n+        // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n+        // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            LogPrintf(\"%s: WARNING: Block %s does not connect to an ancestor of known best chain \"\n+                      \"(tip=%s); not updating txindex\\n\",\n+                      __func__, pindex->GetBlockHash().ToString(),\n+                      best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+void TxIndex::SetBestChain(const CBlockLocator& locator)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const uint256& locator_tip_hash = locator.vHave.front();\n+    const CBlockIndex* locator_tip_index;\n+    {\n+        LOCK(cs_main);\n+        locator_tip_index = LookupBlockIndex(locator_tip_hash);\n+    }\n+\n+    if (!locator_tip_index) {\n+        FatalError(\"%s: First block (hash=%s) in locator was not found\",\n+                   __func__, locator_tip_hash.ToString());\n+        return;\n+    }\n+\n+    // This checks that SetBestChain callbacks are received after BlockConnected. The check may fail\n+    // immediately after the the sync thread catches up and sets m_synced. Consider the case where\n+    // there is a reorg and the blocks on the stale branch are in the ValidationInterface queue\n+    // backlog even after the sync thread has caught up to the new chain tip. In this unlikely\n+    // event, log a warning and let the queue clear.\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n+        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best chain \"\n+                  \"(tip=%s); not writing txindex locator\\n\",\n+                  __func__, locator_tip_hash.ToString(),\n+                  best_block_index->GetBlockHash().ToString());\n+        return;\n+    }\n+\n+    if (!m_db->WriteBestBlock(locator)) {\n+        error(\"%s: Failed to write locator to disk\", __func__);\n+    }\n+}\n+\n+bool TxIndex::BlockUntilSyncedToCurrentChain()\n+{\n+    AssertLockNotHeld(cs_main);\n+\n+    if (!m_synced) {\n+        return false;\n+    }\n+\n+    {\n+        // Skip the queue-draining stuff if we know we're caught up with\n+        // chainActive.Tip().\n+        LOCK(cs_main);\n+        const CBlockIndex* chain_tip = chainActive.Tip();\n+        const CBlockIndex* best_block_index = m_best_block_index.load();\n+        if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181177572",
      "id" : 181177572,
      "in_reply_to_id" : 180888339,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 233,
      "path" : "src/index/txindex.cpp",
      "position" : 233,
      "pull_request_review_id" : 111738822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-12T18:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181177572",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181180587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181180587"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, there's a few reasons. 1) It's how CWallet works, which I looked at as a model. 2) I'd rather not `LOCK(cs_main)` on every `BlockConnected` if avoidable. We wouldn't even need the lock in this method if `SetBestChain` was called with the tip block index as an argument. 3) I think this gives better efficiency of block locator hits. So if the tip of the block locator is always the best block index entry that has been flushed to disk, when the TxIndex restarts, it always picks up from the best possible point. Whereas if the locator is written on every BlockConnected call, because there are exponentially increasing jumps in the locator, you might only find a block that is further back than that one. (Hopefully that makes sense).",
      "commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "created_at" : "2018-04-12T18:32:47Z",
      "diff_hunk" : "@@ -0,0 +1,294 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <index/txindex.h>\n+#include <init.h>\n+#include <tinyformat.h>\n+#include <ui_interface.h>\n+#include <util.h>\n+#include <validation.h>\n+#include <warnings.h>\n+\n+constexpr int64_t SYNC_LOG_INTERVAL = 30; // seconds\n+\n+std::unique_ptr<TxIndex> g_txindex;\n+\n+template<typename... Args>\n+static void FatalError(const char* fmt, const Args&... args)\n+{\n+    std::string strMessage = tfm::format(fmt, args...);\n+    SetMiscWarning(strMessage);\n+    LogPrintf(\"*** %s\\n\", strMessage);\n+    uiInterface.ThreadSafeMessageBox(\n+        \"Error: A fatal internal error occurred, see debug.log for details\",\n+        \"\", CClientUIInterface::MSG_ERROR);\n+    StartShutdown();\n+}\n+\n+TxIndex::TxIndex(std::unique_ptr<TxIndexDB> db) :\n+    m_db(std::move(db)), m_synced(false), m_best_block_index(nullptr)\n+{}\n+\n+TxIndex::~TxIndex()\n+{\n+    Interrupt();\n+    Stop();\n+}\n+\n+bool TxIndex::Init()\n+{\n+    LOCK(cs_main);\n+\n+    // Attempt to migrate txindex from the old database to the new one. Even if\n+    // chain_tip is null, the node could be reindexing and we still want to\n+    // delete txindex records in the old database.\n+    if (!m_db->MigrateData(*pblocktree, chainActive.GetLocator())) {\n+        return false;\n+    }\n+\n+    CBlockLocator locator;\n+    if (!m_db->ReadBestBlock(locator)) {\n+        FatalError(\"%s: Failed to read from tx index database\", __func__);\n+        return false;\n+    }\n+\n+    m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n+    m_synced = m_best_block_index.load() == chainActive.Tip();\n+    return true;\n+}\n+\n+static const CBlockIndex* NextSyncBlock(const CBlockIndex* pindex_prev)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    if (!pindex_prev) {\n+        return chainActive.Genesis();\n+    }\n+\n+    const CBlockIndex* pindex = chainActive.Next(pindex_prev);\n+    if (pindex) {\n+        return pindex;\n+    }\n+\n+    return chainActive.Next(chainActive.FindFork(pindex_prev));\n+}\n+\n+void TxIndex::ThreadSync()\n+{\n+    const CBlockIndex* pindex = m_best_block_index.load();\n+    if (!m_synced) {\n+        auto& consensus_params = Params().GetConsensus();\n+\n+        int64_t last_log_time = 0;\n+        while (true) {\n+            if (m_interrupt) {\n+                return;\n+            }\n+\n+            {\n+                LOCK(cs_main);\n+                const CBlockIndex* pindex_next = NextSyncBlock(pindex);\n+                if (!pindex_next) {\n+                    if (!m_db->WriteBestBlock(chainActive.GetLocator())) {\n+                        error(\"%s: Failed to write locator to disk\", __func__);\n+                    }\n+                    m_best_block_index = pindex;\n+                    m_synced = true;\n+                    break;\n+                }\n+                pindex = pindex_next;\n+            }\n+\n+            int64_t current_time = GetTime();\n+            if (last_log_time + SYNC_LOG_INTERVAL < current_time) {\n+                LogPrintf(\"Syncing txindex with block chain from height %d\\n\", pindex->nHeight);\n+                last_log_time = current_time;\n+            }\n+\n+            CBlock block;\n+            if (!ReadBlockFromDisk(block, pindex, consensus_params)) {\n+                FatalError(\"%s: Failed to read block %s from disk\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+            if (!WriteBlock(block, pindex)) {\n+                FatalError(\"%s: Failed to write block %s to tx index database\",\n+                           __func__, pindex->GetBlockHash().ToString());\n+                return;\n+            }\n+        }\n+    }\n+\n+    if (pindex) {\n+        LogPrintf(\"txindex is enabled at height %d\\n\", pindex->nHeight);\n+    } else {\n+        LogPrintf(\"txindex is enabled\\n\");\n+    }\n+}\n+\n+bool TxIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+{\n+    CDiskTxPos pos(pindex->GetBlockPos(), GetSizeOfCompactSize(block.vtx.size()));\n+    std::vector<std::pair<uint256, CDiskTxPos>> vPos;\n+    vPos.reserve(block.vtx.size());\n+    for (const auto& tx : block.vtx) {\n+        vPos.emplace_back(tx->GetHash(), pos);\n+        pos.nTxOffset += ::GetSerializeSize(*tx, SER_DISK, CLIENT_VERSION);\n+    }\n+    return m_db->WriteTxs(vPos);\n+}\n+\n+void TxIndex::BlockConnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex,\n+                    const std::vector<CTransactionRef>& txn_conflicted)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (!best_block_index) {\n+        if (pindex->nHeight != 0) {\n+            FatalError(\"%s: First block connected is not the genesis block (height=%d)\",\n+                       __func__, pindex->nHeight);\n+            return;\n+        }\n+    } else {\n+        // Ensure block connects to an ancestor of the current best block. This should be the case\n+        // most of the time, but may not be immediately after the the sync thread catches up and sets\n+        // m_synced. Consider the case where there is a reorg and the blocks on the stale branch are\n+        // in the ValidationInterface queue backlog even after the sync thread has caught up to the\n+        // new chain tip. In this unlikely event, log a warning and let the queue clear.\n+        if (best_block_index->GetAncestor(pindex->nHeight - 1) != pindex->pprev) {\n+            LogPrintf(\"%s: WARNING: Block %s does not connect to an ancestor of known best chain \"\n+                      \"(tip=%s); not updating txindex\\n\",\n+                      __func__, pindex->GetBlockHash().ToString(),\n+                      best_block_index->GetBlockHash().ToString());\n+            return;\n+        }\n+    }\n+\n+    if (WriteBlock(*block, pindex)) {\n+        m_best_block_index = pindex;\n+    } else {\n+        FatalError(\"%s: Failed to write block %s to txindex\",\n+                   __func__, pindex->GetBlockHash().ToString());\n+        return;\n+    }\n+}\n+\n+void TxIndex::SetBestChain(const CBlockLocator& locator)\n+{\n+    if (!m_synced) {\n+        return;\n+    }\n+\n+    const uint256& locator_tip_hash = locator.vHave.front();\n+    const CBlockIndex* locator_tip_index;\n+    {\n+        LOCK(cs_main);\n+        locator_tip_index = LookupBlockIndex(locator_tip_hash);\n+    }\n+\n+    if (!locator_tip_index) {\n+        FatalError(\"%s: First block (hash=%s) in locator was not found\",\n+                   __func__, locator_tip_hash.ToString());\n+        return;\n+    }\n+\n+    // This checks that SetBestChain callbacks are received after BlockConnected. The check may fail\n+    // immediately after the the sync thread catches up and sets m_synced. Consider the case where\n+    // there is a reorg and the blocks on the stale branch are in the ValidationInterface queue\n+    // backlog even after the sync thread has caught up to the new chain tip. In this unlikely\n+    // event, log a warning and let the queue clear.\n+    const CBlockIndex* best_block_index = m_best_block_index.load();\n+    if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n+        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best chain \"\n+                  \"(tip=%s); not writing txindex locator\\n\",\n+                  __func__, locator_tip_hash.ToString(),\n+                  best_block_index->GetBlockHash().ToString());\n+        return;\n+    }\n+\n+    if (!m_db->WriteBestBlock(locator)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857#discussion_r181180587",
      "id" : 181180587,
      "in_reply_to_id" : 180884263,
      "original_commit_id" : "ea8be45ace75b649584c163deca3051c4f33aa16",
      "original_position" : 214,
      "path" : "src/index/txindex.cpp",
      "position" : 214,
      "pull_request_review_id" : 111742304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857",
      "updated_at" : "2018-04-12T18:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/181180587",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   }
]
