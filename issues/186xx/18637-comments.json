[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18731 (refactor: Make CCheckQueue RAII-styled by hebasto)\n* #17487 (coins: allow write to disk without cache drop by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-04-14T21:10:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-613683149",
      "id" : 613683149,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMzY4MzE0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-23T01:56:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613683149",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r408954497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408954497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will need to be modified with the change that @MarcoFalke has made in https://github.com/bitcoin/bitcoin/pull/18615.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-15T15:57:58Z",
      "diff_hunk" : "@@ -0,0 +1,76 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <random.h>\n+#include <uint256.h>\n+#include <consensus/validation.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <vector>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_chainstate_tests, TestingSetup)\n+\n+//! Test resizing coins-related CChainState caches during runtime.\n+//!\n+BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n+{\n+    ChainstateManager manager;\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);\n+    c1.InitCoinsDB(\n+        /* cache_size_bytes */ 1 << 23, /* in_memory */ true, /* should_wipe */ false);\n+    WITH_LOCK(::cs_main, c1.InitCoinsCache(1 << 23));\n+\n+    // Add a coin to the in-memory cache, upsize once, then downsize.\n+    {\n+        LOCK(::cs_main);\n+        auto outpoint = add_coin(c1.CoinsTip());\n+\n+        // Set a meaningless bestblock value in the coinsview cache - otherwise we won't\n+        // flush during ResizecoinsCaches() and will subsequently hit an assertion.\n+        c1.CoinsTip().SetBestBlock(InsecureRand256());\n+\n+        BOOST_CHECK(c1.CoinsTip().HaveCoinInCache(outpoint));\n+\n+        c1.ResizeCoinsCaches(\n+            1 << 24,  // upsizing the coinsview cache\n+            1 << 22  // downsizing the coinsdb cache\n+        );\n+\n+        // View should still have the coin cached, since we haven't destructed the cache on upsize.\n+        BOOST_CHECK(c1.CoinsTip().HaveCoinInCache(outpoint));\n+\n+        c1.ResizeCoinsCaches(\n+            1 << 22,  // downsizing the coinsview cache\n+            1 << 23  // upsizing the coinsdb cache\n+        );\n+\n+        // The view cache should be empty since we had to destruct to downsize.\n+        BOOST_CHECK(!c1.CoinsTip().HaveCoinInCache(outpoint));\n+    }\n+\n+    // Avoid triggering the address sanitizer.\n+    WITH_LOCK(::cs_main, manager.Unload());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r408954497",
      "id" : 408954497,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk1NDQ5Nw==",
      "original_commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 73,
      "pull_request_review_id" : 393914341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408954497",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409694987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409694987"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nAssertLockHeld would be one option",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T16:36:13Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory)\n {\n+    db.reset(new CDBWrapper(ldb_path, nCacheSize, fMemory, fWipe, true));\n+}\n+\n+// XXX this should never be called without holding cs_main. Maybe figure out\n+// a better way of articulating this (lock annotations can't be used due to\n+// circular dep. with validation).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409694987",
      "id" : 409694987,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5NDk4Nw==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 65,
      "original_position" : 14,
      "original_start_line" : 63,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409694987",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409697186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409697186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nWould be nice to stick to member initialization and keep empty constructor body `db(MakeUnique<CDBWrapper>(...)))`",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T16:39:29Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409697186",
      "id" : 409697186,
      "line" : 47,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5NzE4Ng==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 47,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 15,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409697186",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409699250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409699250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nDoesn't really matter but general better to avoid `new` with `MakeUnique`\r\nhttps://isocpp.org/blog/2019/06/quick-q-differences-between-stdmake-unique-and-stdunique-ptr-with-new",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T16:42:36Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory)\n {\n+    db.reset(new CDBWrapper(ldb_path, nCacheSize, fMemory, fWipe, true));\n+}\n+\n+// XXX this should never be called without holding cs_main. Maybe figure out\n+// a better way of articulating this (lock annotations can't be used due to\n+// circular dep. with validation).\n+void CCoinsViewDB::ResizeCache(size_t new_cache_size)\n+{\n+    // Have to do a reset first to get the original `db` state to release its\n+    // filesystem lock.\n+    db.reset();\n+    db.reset(new CDBWrapper(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409699250",
      "id" : 409699250,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5OTI1MA==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 71,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409699250",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409701315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409701315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nSince this commit is already changing the type of `db` and updating every single line where it's referenced, it'd be nice to rename it to `m_db` at the same time",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T16:45:45Z",
      "diff_hunk" : "@@ -43,7 +43,9 @@ static const int64_t nMaxCoinsDBCache = 8;\n class CCoinsViewDB final : public CCoinsView\n {\n protected:\n-    CDBWrapper db;\n+    std::unique_ptr<CDBWrapper> db;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409701315",
      "id" : 409701315,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwMTMxNQ==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 46,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txdb.h",
      "position" : null,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409701315",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409705135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409705135"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add test for CChainState::ResizeCoinsCaches()\" (03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5)\r\n\r\nNice test!",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T16:51:46Z",
      "diff_hunk" : "@@ -0,0 +1,76 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <random.h>\n+#include <uint256.h>\n+#include <consensus/validation.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <vector>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_chainstate_tests, TestingSetup)\n+\n+//! Test resizing coins-related CChainState caches during runtime.\n+//!\n+BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409705135",
      "id" : 409705135,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwNTEzNQ==",
      "original_commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 20,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409705135",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409709750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409709750"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add CChainState::ResizeCoinsCaches\" (df0f720cfdcc1ad70d5ef2656039f008b3bc4bba)\r\n\r\nWould be good to pass along false return value to caller in case this fails",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T16:59:10Z",
      "diff_hunk" : "@@ -4924,6 +4924,36 @@ std::string CChainState::ToString()\n         tip ? tip->nHeight : -1, tip ? tip->GetBlockHash().ToString() : \"null\");\n }\n \n+void CChainState::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n+{\n+    if (coinstip_size == m_coinstip_cache_size_bytes &&\n+            coinsdb_size == m_coinsdb_cache_size_bytes) {\n+        // Cache sizes are unchanged, no need to continue.\n+        return;\n+    }\n+    int old_coinstip_size = m_coinstip_cache_size_bytes;\n+    m_coinstip_cache_size_bytes = coinstip_size;\n+    m_coinsdb_cache_size_bytes = coinsdb_size;\n+    CoinsDB().ResizeCache(coinsdb_size);\n+\n+    LogPrintf(\"[%s] resized coinsdb cache to %.1f MiB\\n\",\n+        this->ToString(), coinsdb_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"[%s] resized coinstip cache to %.1f MiB\\n\",\n+        this->ToString(), coinstip_size * (1.0 / 1024 / 1024));\n+\n+    BlockValidationState state;\n+    const CChainParams& chainparams = Params();\n+\n+    if (coinstip_size > old_coinstip_size) {\n+        // Likely no need to flush if cache sizes have grown.\n+        FlushStateToDisk(chainparams, state, FlushStateMode::IF_NEEDED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409709750",
      "id" : 409709750,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwOTc1MA==",
      "original_commit_id" : "df0f720cfdcc1ad70d5ef2656039f008b3bc4bba",
      "original_line" : 4949,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409709750",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409714771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409714771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add CChainState::ResizeCoinsCaches\" (df0f720cfdcc1ad70d5ef2656039f008b3bc4bba)\r\n\r\nJust confirming but looks like this 1.5MB default cache size was only used by test cases previously, which are now using 8MB or 1KB caches depending on the case.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T17:07:19Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ bool fPruneMode = false;\n bool fRequireStandard = true;\n bool fCheckBlockIndex = false;\n bool fCheckpointsEnabled = DEFAULT_CHECKPOINTS_ENABLED;\n-size_t nCoinCacheUsage = 5000 * 300;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409714771",
      "id" : 409714771,
      "line" : 138,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNDc3MQ==",
      "original_commit_id" : "df0f720cfdcc1ad70d5ef2656039f008b3bc4bba",
      "original_line" : 138,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409714771",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409719460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409719460"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add CChainState::ResizeCoinsCaches\" (df0f720cfdcc1ad70d5ef2656039f008b3bc4bba)\r\n\r\nJust curious, but would it make sense to call FlushStateToDisk before resetting CoinsDB instead of after? Thought would be that maybe live CDBWrapper object has cached state that would make the flush faster, or maybe it could be good to start with a new CDBWrapper after the flush",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T17:15:24Z",
      "diff_hunk" : "@@ -4924,6 +4924,36 @@ std::string CChainState::ToString()\n         tip ? tip->nHeight : -1, tip ? tip->GetBlockHash().ToString() : \"null\");\n }\n \n+void CChainState::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n+{\n+    if (coinstip_size == m_coinstip_cache_size_bytes &&\n+            coinsdb_size == m_coinsdb_cache_size_bytes) {\n+        // Cache sizes are unchanged, no need to continue.\n+        return;\n+    }\n+    int old_coinstip_size = m_coinstip_cache_size_bytes;\n+    m_coinstip_cache_size_bytes = coinstip_size;\n+    m_coinsdb_cache_size_bytes = coinsdb_size;\n+    CoinsDB().ResizeCache(coinsdb_size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409719460",
      "id" : 409719460,
      "line" : 4978,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxOTQ2MA==",
      "original_commit_id" : "df0f720cfdcc1ad70d5ef2656039f008b3bc4bba",
      "original_line" : 4978,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 52,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409719460",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409723518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409723518"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"add ChainstateManager::MaybeRebalanceCaches()\" (69514bd9fce0f867256bd08ec9f1b616a3ece573)\r\n\r\nCould probably write a short unit test exercising this (checking m_coins{tip,db}_cache_size_bytes)",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-16T17:22:01Z",
      "diff_hunk" : "@@ -5237,3 +5237,33 @@ void ChainstateManager::Reset()\n     m_active_chainstate = nullptr;\n     m_snapshot_validated = false;\n }\n+\n+void ChainstateManager::MaybeRebalanceCaches()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409723518",
      "id" : 409723518,
      "line" : 5301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMzUxOA==",
      "original_commit_id" : "69514bd9fce0f867256bd08ec9f1b616a3ece573",
      "original_line" : 5301,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 83,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409723518",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review and good suggestions, @ryanofsky. I've incorporated your feedback in the latest revision.",
      "created_at" : "2020-04-22T15:28:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-617849721",
      "id" : 617849721,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzg0OTcyMQ==",
      "updated_at" : "2020-04-22T15:28:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617849721",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r413083482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413083482"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea, done.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-22T15:28:29Z",
      "diff_hunk" : "@@ -5237,3 +5237,33 @@ void ChainstateManager::Reset()\n     m_active_chainstate = nullptr;\n     m_snapshot_validated = false;\n }\n+\n+void ChainstateManager::MaybeRebalanceCaches()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r413083482",
      "id" : 413083482,
      "in_reply_to_id" : 409723518,
      "line" : 5301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA4MzQ4Mg==",
      "original_commit_id" : "69514bd9fce0f867256bd08ec9f1b616a3ece573",
      "original_line" : 5301,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 83,
      "pull_request_review_id" : 398310433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413083482",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r413083886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413083886"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah thanks, didn't know that.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-22T15:28:56Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory)\n {\n+    db.reset(new CDBWrapper(ldb_path, nCacheSize, fMemory, fWipe, true));\n+}\n+\n+// XXX this should never be called without holding cs_main. Maybe figure out\n+// a better way of articulating this (lock annotations can't be used due to\n+// circular dep. with validation).\n+void CCoinsViewDB::ResizeCache(size_t new_cache_size)\n+{\n+    // Have to do a reset first to get the original `db` state to release its\n+    // filesystem lock.\n+    db.reset();\n+    db.reset(new CDBWrapper(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r413083886",
      "id" : 413083886,
      "in_reply_to_id" : 409699250,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA4Mzg4Ng==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 71,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 398310897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413083886",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r413084378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413084378"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I just ended up using an `extern` declaration for the lock and adding an annotation. Not sure why I didn't do that in the first place.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-04-22T15:29:29Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory)\n {\n+    db.reset(new CDBWrapper(ldb_path, nCacheSize, fMemory, fWipe, true));\n+}\n+\n+// XXX this should never be called without holding cs_main. Maybe figure out\n+// a better way of articulating this (lock annotations can't be used due to\n+// circular dep. with validation).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r413084378",
      "id" : 413084378,
      "in_reply_to_id" : 409694987,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA4NDM3OA==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 65,
      "original_position" : 14,
      "original_start_line" : 63,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 398311456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/413084378",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r427549224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427549224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"add ChainstateManager::MaybeRebalanceCaches()\" (db5e36a033e642599db808f59d16d03a40860f17)\r\n\r\nThis is interesting. Once we update to c++14 or 17 we should be able to use WITH_LOCK like\r\n\r\n```c++\r\nCChainState& c1 = WITH_LOCK(cs_main, return manager.InitializeChainstate());\r\n```\r\n\r\nI think it changing it wouldn't work now without decltype(auto)",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-19T19:31:36Z",
      "diff_hunk" : "@@ -101,4 +101,58 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test rebalancing the caches associated with each chainstate.\n+BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n+{\n+    ChainstateManager manager;\n+    int max_cache = 10000;\n+    manager.m_total_coinsdb_cache = max_cache;\n+    manager.m_total_coinstip_cache = max_cache;\n+\n+    std::vector<CChainState*> chainstates;\n+\n+    // Create a legacy (IBD) chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r427549224",
      "id" : 427549224,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU0OTIyNA==",
      "original_commit_id" : "db5e36a033e642599db808f59d16d03a40860f17",
      "original_line" : 120,
      "original_position" : 18,
      "original_start_line" : 116,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 50,
      "pull_request_review_id" : 414759782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 118,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427549224",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Should this be added to in progress column https://github.com/bitcoin/bitcoin/projects/11? \r\n\r\nAlso maybe if there's a main assumeutxo pr you'd prioritize for review now it could go on high priority reviews https://github.com/bitcoin/bitcoin/projects/8",
      "created_at" : "2020-05-22T17:32:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-632821018",
      "id" : 632821018,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjgyMTAxOA==",
      "updated_at" : "2020-05-22T17:32:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632821018",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429373795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429373795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is different between this potential WITH_LOCK use, and the existing ones that return a value?",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-22T17:37:12Z",
      "diff_hunk" : "@@ -101,4 +101,58 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test rebalancing the caches associated with each chainstate.\n+BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n+{\n+    ChainstateManager manager;\n+    int max_cache = 10000;\n+    manager.m_total_coinsdb_cache = max_cache;\n+    manager.m_total_coinstip_cache = max_cache;\n+\n+    std::vector<CChainState*> chainstates;\n+\n+    // Create a legacy (IBD) chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429373795",
      "id" : 429373795,
      "in_reply_to_id" : 427549224,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3Mzc5NQ==",
      "original_commit_id" : "db5e36a033e642599db808f59d16d03a40860f17",
      "original_line" : 120,
      "original_position" : 18,
      "original_start_line" : 116,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 50,
      "pull_request_review_id" : 417080272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 118,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429373795",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429383887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429383887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't know, but maybe C++11 lambda can not return references? If yes, this can be solved with\r\n\r\n\r\n```cpp\r\nCChainState& c1 = *WITH_LOCK(cs_main, return &manager.InitializeChainstate());",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-22T18:00:00Z",
      "diff_hunk" : "@@ -101,4 +101,58 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test rebalancing the caches associated with each chainstate.\n+BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n+{\n+    ChainstateManager manager;\n+    int max_cache = 10000;\n+    manager.m_total_coinsdb_cache = max_cache;\n+    manager.m_total_coinstip_cache = max_cache;\n+\n+    std::vector<CChainState*> chainstates;\n+\n+    // Create a legacy (IBD) chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429383887",
      "id" : 429383887,
      "in_reply_to_id" : 427549224,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4Mzg4Nw==",
      "original_commit_id" : "db5e36a033e642599db808f59d16d03a40860f17",
      "original_line" : 120,
      "original_position" : 18,
      "original_start_line" : 116,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 50,
      "pull_request_review_id" : 417093545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 118,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429383887",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429401621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429401621"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, just what marco said, auto return type won't deduce a reference, and I think the pointer trick would work here, so it might nice to incorporate if the PR is gets updated again",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-22T18:44:01Z",
      "diff_hunk" : "@@ -101,4 +101,58 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test rebalancing the caches associated with each chainstate.\n+BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n+{\n+    ChainstateManager manager;\n+    int max_cache = 10000;\n+    manager.m_total_coinsdb_cache = max_cache;\n+    manager.m_total_coinstip_cache = max_cache;\n+\n+    std::vector<CChainState*> chainstates;\n+\n+    // Create a legacy (IBD) chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429401621",
      "id" : 429401621,
      "in_reply_to_id" : 427549224,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMTYyMQ==",
      "original_commit_id" : "db5e36a033e642599db808f59d16d03a40860f17",
      "original_line" : 120,
      "original_position" : 18,
      "original_start_line" : 116,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 50,
      "pull_request_review_id" : 417117008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 118,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429401621",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-05-23T12:06:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-633038709",
      "id" : 633038709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzAzODcwOQ==",
      "updated_at" : "2020-05-23T12:06:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633038709",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429541761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429541761"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                chainman.m_total_coinsdb_cache = nCoinDBCache;\r\n```\r\n\r\nNeeds rebase to remove the `g_` prefix in this line",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-23T12:26:35Z",
      "diff_hunk" : "@@ -1532,6 +1532,9 @@ bool AppInitMain(NodeContext& node)\n             try {\n                 LOCK(cs_main);\n                 g_chainman.InitializeChainstate();\n+                g_chainman.m_total_coinstip_cache = nCoinCacheUsage;\n+                g_chainman.m_total_coinsdb_cache = nCoinDBCache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429541761",
      "id" : 429541761,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0MTc2MQ==",
      "original_commit_id" : "4cc7b612d1413451d500c5fd6eefebea34216460",
      "original_line" : 1536,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 417275042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429541761",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429541868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429541868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this needs a `SyncWithValidationInterfaceQueue` before the unload because in this test not blocks are mined and no txs are added to the mempool.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-23T12:28:17Z",
      "diff_hunk" : "@@ -0,0 +1,76 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <random.h>\n+#include <uint256.h>\n+#include <consensus/validation.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <vector>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_chainstate_tests, TestingSetup)\n+\n+//! Test resizing coins-related CChainState caches during runtime.\n+//!\n+BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n+{\n+    ChainstateManager manager;\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);\n+    c1.InitCoinsDB(\n+        /* cache_size_bytes */ 1 << 23, /* in_memory */ true, /* should_wipe */ false);\n+    WITH_LOCK(::cs_main, c1.InitCoinsCache(1 << 23));\n+\n+    // Add a coin to the in-memory cache, upsize once, then downsize.\n+    {\n+        LOCK(::cs_main);\n+        auto outpoint = add_coin(c1.CoinsTip());\n+\n+        // Set a meaningless bestblock value in the coinsview cache - otherwise we won't\n+        // flush during ResizecoinsCaches() and will subsequently hit an assertion.\n+        c1.CoinsTip().SetBestBlock(InsecureRand256());\n+\n+        BOOST_CHECK(c1.CoinsTip().HaveCoinInCache(outpoint));\n+\n+        c1.ResizeCoinsCaches(\n+            1 << 24,  // upsizing the coinsview cache\n+            1 << 22  // downsizing the coinsdb cache\n+        );\n+\n+        // View should still have the coin cached, since we haven't destructed the cache on upsize.\n+        BOOST_CHECK(c1.CoinsTip().HaveCoinInCache(outpoint));\n+\n+        c1.ResizeCoinsCaches(\n+            1 << 22,  // downsizing the coinsview cache\n+            1 << 23  // upsizing the coinsdb cache\n+        );\n+\n+        // The view cache should be empty since we had to destruct to downsize.\n+        BOOST_CHECK(!c1.CoinsTip().HaveCoinInCache(outpoint));\n+    }\n+\n+    // Avoid triggering the address sanitizer.\n+    WITH_LOCK(::cs_main, manager.Unload());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r429541868",
      "id" : 429541868,
      "in_reply_to_id" : 408954497,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0MTg2OA==",
      "original_commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 73,
      "pull_request_review_id" : 417275131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429541868",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r432009502"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432009502"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pushed, thanks!",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-28T17:37:49Z",
      "diff_hunk" : "@@ -1532,6 +1532,9 @@ bool AppInitMain(NodeContext& node)\n             try {\n                 LOCK(cs_main);\n                 g_chainman.InitializeChainstate();\n+                g_chainman.m_total_coinstip_cache = nCoinCacheUsage;\n+                g_chainman.m_total_coinsdb_cache = nCoinDBCache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r432009502",
      "id" : 432009502,
      "in_reply_to_id" : 429541761,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwOTUwMg==",
      "original_commit_id" : "4cc7b612d1413451d500c5fd6eefebea34216460",
      "original_line" : 1536,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 420343465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432009502",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This doesn't compile\r\n\r\n```\r\nvalidation.cpp: In member function bool CChainState::ResizeCoinsCaches(size_t, size_t):\r\n\r\nvalidation.cpp:4990:23: error: comparison of integer expressions of different signedness: size_t {aka unsigned int} and int [-Werror=sign-compare]\r\n\r\n     if (coinstip_size > old_coinstip_size) {\r\n\r\n         ~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~\r\n\r\ncc1plus: some warnings being treated as errors",
      "created_at" : "2020-05-31T12:59:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-636468316",
      "id" : 636468316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjQ2ODMxNg==",
      "updated_at" : "2020-05-31T12:59:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636468316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It does compile locally, so I am not sure how to reproduce this failure :(",
      "created_at" : "2020-05-31T13:00:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-636468355",
      "id" : 636468355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjQ2ODM1NQ==",
      "updated_at" : "2020-05-31T13:00:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636468355",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r432944978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432944978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit in commit 1e6e0b9af6c5470dbf1e61:\r\n\r\nNow that you have to force push anyway, might as well remove the clumsy `ENTER_CRITICAL_SECTION`?\r\n\r\n```suggestion\r\n    CChainState& c1 = *WITH_LOCK(cs_main, return &manager.InitializeChainstate());\r\n```",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-31T13:02:50Z",
      "diff_hunk" : "@@ -104,4 +104,58 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test rebalancing the caches associated with each chainstate.\n+BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n+{\n+    ChainstateManager manager;\n+    int max_cache = 10000;\n+    manager.m_total_coinsdb_cache = max_cache;\n+    manager.m_total_coinstip_cache = max_cache;\n+\n+    std::vector<CChainState*> chainstates;\n+\n+    // Create a legacy (IBD) chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r432944978",
      "id" : 432944978,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk0NDk3OA==",
      "original_commit_id" : "1e6e0b9af6c5470dbf1e61f54900ac9a21f147a2",
      "original_line" : 120,
      "original_position" : 18,
      "original_start_line" : 119,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 50,
      "pull_request_review_id" : 421492649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 118,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432944978",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r432945053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432945053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    CChainState& c2 = *WITH_LOCK(cs_main, return &manager.InitializeChainstate(GetRandHash()));\r\n```\r\n\r\nSame",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-05-31T13:03:51Z",
      "diff_hunk" : "@@ -104,4 +104,58 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test rebalancing the caches associated with each chainstate.\n+BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n+{\n+    ChainstateManager manager;\n+    int max_cache = 10000;\n+    manager.m_total_coinsdb_cache = max_cache;\n+    manager.m_total_coinstip_cache = max_cache;\n+\n+    std::vector<CChainState*> chainstates;\n+\n+    // Create a legacy (IBD) chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);\n+    chainstates.push_back(&c1);\n+    c1.InitCoinsDB(\n+        /* cache_size_bytes */ 1 << 23, /* in_memory */ true, /* should_wipe */ false);\n+\n+    {\n+        LOCK(::cs_main);\n+        c1.InitCoinsCache(1 << 23);\n+        c1.CoinsTip().SetBestBlock(InsecureRand256());\n+        manager.MaybeRebalanceCaches();\n+    }\n+\n+    BOOST_CHECK_EQUAL(c1.m_coinstip_cache_size_bytes, max_cache);\n+    BOOST_CHECK_EQUAL(c1.m_coinsdb_cache_size_bytes, max_cache);\n+\n+    // Create a snapshot-based chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c2 = manager.InitializeChainstate(GetRandHash());\n+    LEAVE_CRITICAL_SECTION(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r432945053",
      "id" : 432945053,
      "line" : 139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk0NTA1Mw==",
      "original_commit_id" : "1e6e0b9af6c5470dbf1e61f54900ac9a21f147a2",
      "original_line" : 139,
      "original_position" : 37,
      "original_start_line" : 138,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 69,
      "pull_request_review_id" : 421492649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 137,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432945053",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r440414525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440414525"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "0fd9039ab3de00a0ac03b8fe0463f0c62a92dd43\r\n\r\nThis currently introduces a new compiler warning. The initializer list should be in the same order as they members are declared.\r\n\r\n```\r\ntxdb.cpp:47:5: warning: field 'm_is_memory' will be initialized after field 'm_db' [-Wreorder]\r\n    m_is_memory(fMemory),\r\n```",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-06-15T20:01:25Z",
      "diff_hunk" : "@@ -41,35 +42,45 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r440414525",
      "id" : 440414525,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxNDUyNQ==",
      "original_commit_id" : "0fd9039ab3de00a0ac03b8fe0463f0c62a92dd43",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 430951947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440414525",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r440415231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440415231"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "1bf9a836713b44d873dd6f2b99ce8ab343808ffe\r\n\r\nThis looks like it could be a constant?",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-06-15T20:02:47Z",
      "diff_hunk" : "@@ -139,7 +139,7 @@ TestingSetup::TestingSetup(const std::string& chainName, const std::vector<const\n     ::ChainstateActive().InitCoinsDB(\n         /* cache_size_bytes */ 1 << 23, /* in_memory */ true, /* should_wipe */ false);\n     assert(!::ChainstateActive().CanFlushToDisk());\n-    ::ChainstateActive().InitCoinsCache();\n+    ::ChainstateActive().InitCoinsCache(1 << 23);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r440415231",
      "id" : 440415231,
      "line" : 142,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxNTIzMQ==",
      "original_commit_id" : "1bf9a836713b44d873dd6f2b99ce8ab343808ffe",
      "original_line" : 142,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 5,
      "pull_request_review_id" : 430951947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440415231",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r440416684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440416684"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "6df742f093de1c1360e3f37d011fbdf0a3888017\r\n\r\nIn the test I think `1 << 23` could also be a variable to help a little bit with readability.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-06-15T20:05:53Z",
      "diff_hunk" : "@@ -103,4 +103,58 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test rebalancing the caches associated with each chainstate.\n+BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n+{\n+    ChainstateManager manager;\n+    size_t max_cache = 10000;\n+    manager.m_total_coinsdb_cache = max_cache;\n+    manager.m_total_coinstip_cache = max_cache;\n+\n+    std::vector<CChainState*> chainstates;\n+\n+    // Create a legacy (IBD) chainstate.\n+    //\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);\n+    chainstates.push_back(&c1);\n+    c1.InitCoinsDB(\n+        /* cache_size_bytes */ 1 << 23, /* in_memory */ true, /* should_wipe */ false);\n+\n+    {\n+        LOCK(::cs_main);\n+        c1.InitCoinsCache(1 << 23);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r440416684",
      "id" : 440416684,
      "line" : 127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxNjY4NA==",
      "original_commit_id" : "6df742f093de1c1360e3f37d011fbdf0a3888017",
      "original_line" : 127,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 57,
      "pull_request_review_id" : 430951947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440416684",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "[\"if anyone wants to see forward motion on assumeutxo, #18637 is the one to review\"](http://www.erisian.com.au/bitcoin-core-dev/log-2020-06-11.html#l-442)",
      "created_at" : "2020-06-30T17:20:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-651932209",
      "id" : 651932209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MTkzMjIwOQ==",
      "updated_at" : "2020-06-30T17:20:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/651932209",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r447889705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447889705"
         }
      },
      "author_association" : "MEMBER",
      "body" : "FWIW I can't reproduce this locally with either clang or gcc:\r\n\r\n```\r\nCC            = /usr/bin/ccache /usr/bin/clang\r\nCFLAGS        = -g -O2\r\nCPPFLAGS      =  -DDEBUG -DDEBUG_LOCKORDER  -I/home/james/src/bitcoin/db4/include/ -DHAVE_BUILD_INFO -D__STDC_FORMAT_MACROS\r\nCXX           = /usr/bin/ccache /usr/bin/clang++ -std=c++11\r\nCXXFLAGS      =  -O0 -g3 -ftrapv  -Wstack-protector -fstack-protector-all     -std=c++11 -Wthread-safety-analysis -Werror\r\n\r\n% clang++ --version\r\nclang version 7.0.1-8 (tags/RELEASE_701/final)\r\nTarget: x86_64-pc-linux-gnu\r\nThread model: posix\r\nInstalledDir: /usr/bin\r\n\r\n% gcc --version\r\ngcc (Debian 8.3.0-6) 8.3.0\r\nCopyright (C) 2018 Free Software Foundation, Inc.\r\nThis is free software; see the source for copying conditions.  There is NO\r\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\r\n```",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-06-30T18:20:51Z",
      "diff_hunk" : "@@ -41,35 +42,45 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r447889705",
      "id" : 447889705,
      "in_reply_to_id" : 440414525,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4OTcwNQ==",
      "original_commit_id" : "0fd9039ab3de00a0ac03b8fe0463f0c62a92dd43",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 440275077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/447889705",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r448459247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448459247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You just need to move `m_db` to be the first thing initialized, just as it's the first thing declared in txdb.h. Warning appears for me with clang 9.0 fwiw. cf https://en.cppreference.com/w/cpp/language/constructor#Initialization_order",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-07-01T15:52:42Z",
      "diff_hunk" : "@@ -41,35 +42,45 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r448459247",
      "id" : 448459247,
      "in_reply_to_id" : 440414525,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1OTI0Nw==",
      "original_commit_id" : "0fd9039ab3de00a0ac03b8fe0463f0c62a92dd43",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 440997107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448459247",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r448479334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448479334"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems a bit of an anti-pattern -- it's not ResizeCache() that needs cs_main, it's the fact that when it's called it ends up operating on `m_coins_views->m_dbview` which does need cs_main, but that's not enforced because the constraint is thrown away by CoinsDB() returning a reference to the guarded object.\r\n\r\nI think it might be better to replace `CoinsDB()` by a `GetCoinsViews()` that returns a reference to `m_coins_views`, and then have `auto& x = GetCoinsViews(); LOCK(cs_main); x.m_dbview.ResizeCache(y);` ? No need to address in this PR though, I think.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-07-01T16:26:23Z",
      "diff_hunk" : "@@ -60,6 +65,9 @@ class CCoinsViewDB final : public CCoinsView\n     //! Attempt to update from an older database format. Returns whether an error occurred.\n     bool Upgrade();\n     size_t EstimateSize() const override;\n+\n+    //! Dynamically alter the underlying leveldb cache size.\n+    void ResizeCache(size_t new_cache_size) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r448479334",
      "id" : 448479334,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3OTMzNA==",
      "original_commit_id" : "0fd9039ab3de00a0ac03b8fe0463f0c62a92dd43",
      "original_line" : 70,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txdb.h",
      "position" : 24,
      "pull_request_review_id" : 441023103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:47:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448479334",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r448552717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448552717"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-07-01T18:47:04Z",
      "diff_hunk" : "@@ -41,35 +42,45 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r448552717",
      "id" : 448552717,
      "in_reply_to_id" : 440414525,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MjcxNw==",
      "original_commit_id" : "0fd9039ab3de00a0ac03b8fe0463f0c62a92dd43",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 441115809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-01T18:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448552717",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r449710524"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449710524"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "super-nit: A bit more info on the rationale behind 0.05/0.95 would be nice. Also, the values could be constants. But that can be considered for a follow-up.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-07-03T21:59:03Z",
      "diff_hunk" : "@@ -5297,3 +5297,33 @@ void ChainstateManager::Reset()\n     m_active_chainstate = nullptr;\n     m_snapshot_validated = false;\n }\n+\n+void ChainstateManager::MaybeRebalanceCaches()\n+{\n+    if (m_ibd_chainstate && !m_snapshot_chainstate) {\n+        LogPrintf(\"[snapshot] allocating all cache to the IBD chainstate\\n\");\n+        // Allocate everything to the IBD chainstate.\n+        m_ibd_chainstate->ResizeCoinsCaches(m_total_coinstip_cache, m_total_coinsdb_cache);\n+    }\n+    else if (m_snapshot_chainstate && !m_ibd_chainstate) {\n+        LogPrintf(\"[snapshot] allocating all cache to the snapshot chainstate\\n\");\n+        // Allocate everything to the snapshot chainstate.\n+        m_snapshot_chainstate->ResizeCoinsCaches(m_total_coinstip_cache, m_total_coinsdb_cache);\n+    }\n+    else if (m_ibd_chainstate && m_snapshot_chainstate) {\n+        // If both chainstates exist, determine who needs more cache based on IBD status.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r449710524",
      "id" : 449710524,
      "line" : 5314,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMDUyNA==",
      "original_commit_id" : "8ac3ef46999ed676ca3775f7b2f461d92f09a542",
      "original_line" : 5314,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 96,
      "pull_request_review_id" : 442566498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-03T22:00:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449710524",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This looks ready to merge",
      "created_at" : "2020-07-24T10:15:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-663469178",
      "id" : 663469178,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzQ2OTE3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-24T10:15:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663469178",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r462269791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462269791"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't this lock `cs_main` twice ?",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-07-29T12:45:58Z",
      "diff_hunk" : "@@ -57,12 +55,13 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     // Create a snapshot-based chainstate.\n     //\n     ENTER_CRITICAL_SECTION(cs_main);\n-    CChainState& c2 = manager.InitializeChainstate(GetRandHash());\n+    CChainState& c2 = *WITH_LOCK(::cs_main,\n+        return &manager.InitializeChainstate(GetRandHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r462269791",
      "id" : 462269791,
      "line" : 59,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI2OTc5MQ==",
      "original_commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "original_line" : 59,
      "original_position" : 22,
      "original_start_line" : 57,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 22,
      "pull_request_review_id" : 457483812,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 57,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-29T12:46:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462269791",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r462271342"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462271342"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The test nits are fixed in the first commit of #19604 ",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-07-29T12:48:35Z",
      "diff_hunk" : "@@ -57,12 +55,13 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     // Create a snapshot-based chainstate.\n     //\n     ENTER_CRITICAL_SECTION(cs_main);\n-    CChainState& c2 = manager.InitializeChainstate(GetRandHash());\n+    CChainState& c2 = *WITH_LOCK(::cs_main,\n+        return &manager.InitializeChainstate(GetRandHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r462271342",
      "id" : 462271342,
      "in_reply_to_id" : 462269791,
      "line" : 59,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3MTM0Mg==",
      "original_commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "original_line" : 59,
      "original_position" : 22,
      "original_start_line" : 57,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 22,
      "pull_request_review_id" : 457485909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 57,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-29T12:48:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462271342",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r462275500"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462275500"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yep. Brainfart. Just noticed while rebasing https://github.com/bitcoin/bitcoin/pull/19556 and commented without thinking.",
      "commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "created_at" : "2020-07-29T12:55:18Z",
      "diff_hunk" : "@@ -57,12 +55,13 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     // Create a snapshot-based chainstate.\n     //\n     ENTER_CRITICAL_SECTION(cs_main);\n-    CChainState& c2 = manager.InitializeChainstate(GetRandHash());\n+    CChainState& c2 = *WITH_LOCK(::cs_main,\n+        return &manager.InitializeChainstate(GetRandHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r462275500",
      "id" : 462275500,
      "in_reply_to_id" : 462269791,
      "line" : 59,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI3NTUwMA==",
      "original_commit_id" : "f19fdd47a6371dcbe0760ef6f3c3c5adb31b1bb4",
      "original_line" : 59,
      "original_position" : 22,
      "original_start_line" : 57,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 22,
      "pull_request_review_id" : 457491435,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 57,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-29T12:55:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462275500",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   }
]
