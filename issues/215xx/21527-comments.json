[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601192396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601192396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about removing this call? The comment above is incorrect (we only process one tx at most, not recursively), and we'll process the orphans in subsequent calls to `ProcessMessages()`. It seems strange that in this one case we can process up to two transactions in `ProcessMessage()` (the one that we just received, and up to one orphan child of it).",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T08:28:45Z",
      "diff_hunk" : "@@ -3059,7 +3060,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n \n             // Recursively process any orphan transactions that depended on this one\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n+            ProcessOrphanTx(*peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601192396",
      "id" : 601192396,
      "line" : 3113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTE5MjM5Ng==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 3113,
      "original_position" : 151,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 189,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601192396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601207659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601207659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How about moving this check up to immediately after the call to `ProcessOrphanTx()`? It's not possible to have both `more_orphans` be true _and_ have `m_getdata_requests` be non-empty:\r\n\r\n- `ProcessOrphanTx(*peer)` can only return true if there are elements in peer's orphan work set, which can only be true if the last network message processed was a `tx` (`m_peer_work_set` only gets added to when processing a `tx` or when processing an element of `m_peer_work_set`, and we won't process another network message until it's empty)\r\n- `m_getdata_requests` can only be non-empty if the last network message processed was a `getdata` (`m_getdata_requests` only gets added to when processing a `getdata`, and we won't process another message until it's empty)\r\n\r\nThat'd eliminate the need for a `more_orphans` variable, and make it immediately obvious that we're not going to process an orphan _and_ a getdata request on the same pass through `ProcessMessage()`.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T08:44:03Z",
      "diff_hunk" : "@@ -3871,8 +3871,7 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n     }\n \n     {\n-        LOCK(g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) return true;\n+        if (more_orphans) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601207659",
      "id" : 601207659,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTIwNzY1OQ==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 3899,
      "original_position" : 185,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601207659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601210830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601210830"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can be more concisely written as:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 02e2785c24..c90d73cb95 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -3854,11 +3854,7 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\r\n         }\r\n     }\r\n \r\n-    bool more_orphans = false;\r\n-    {\r\n-        LOCK(cs_main);\r\n-        more_orphans = ProcessOrphanTx(*peer);\r\n-    }\r\n+    const bool more_orphans{WITH_LOCK(cs_main, return ProcessOrphanTx(*peer);)};\r\n \r\n     if (pfrom->fDisconnect)\r\n         return false;\r\n",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T08:47:11Z",
      "diff_hunk" : "@@ -3853,11 +3854,10 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n         }\n     }\n \n+    bool more_orphans = false;\n     {\n-        LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n-        }\n+        LOCK(cs_main);\n+        more_orphans = ProcessOrphanTx(*peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601210830",
      "id" : 601210830,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTIxMDgzMA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 3885,
      "original_position" : 175,
      "original_start_line" : 3859,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601210830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25144](https://github.com/bitcoin/bitcoin/pull/25144) (refactor: Pass Peer& to Misbehaving() by MarcoFalke)\n* [#24970](https://github.com/bitcoin/bitcoin/pull/24970) (net processing: Move cleanSubVer, fPreferredDownload and nLocalHostNonce to Peer by jnewbery)\n* [#22778](https://github.com/bitcoin/bitcoin/pull/22778) (net processing: Reduce resource usage for inbound block-relay-only connections by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-25T08:57:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-806478833",
      "id" : 806478833,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjQ3ODgzMw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806478833/reactions"
      },
      "updated_at" : "2022-05-17T20:22:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806478833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601221165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601221165"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It'd be good to remove the `EXCLUSIVE_LOCKS_REQUIRED(cs_main)` and only take the cs_main lock inside the while look (once we know that we have orphans to reprocess). In vast majority of cases we're taking and releasing cs_main for no reason because we have no orphans to process.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T08:57:13Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601221165",
      "id" : 601221165,
      "line" : 2086,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTIyMTE2NQ==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2086,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 110,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601221165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601223122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601223122"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Well remembered to do this. Perhaps add a `TxOrphange::Empty()` function that returns whether there are any elements in any of the containers in the orphanage, and then assert `m_orphange.Empty()` in the `FinalizeNode()` logic when the last peer is deleted.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T08:58:51Z",
      "diff_hunk" : "@@ -87,24 +86,27 @@ int TxOrphanage::EraseTx(const uint256& txid)\n \n void TxOrphanage::EraseForPeer(NodeId peer)\n {\n-    AssertLockHeld(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n+    const int work_erased = m_peer_work_set.erase(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601223122",
      "id" : 601223122,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTIyMzEyMg==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 91,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601223122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601225798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601225798"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure that it's very interesting to log `work_erased`. It'll only ever be 0 (nothing in the work set) or 1 (items in the work set).",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T09:01:24Z",
      "diff_hunk" : "@@ -87,24 +86,27 @@ int TxOrphanage::EraseTx(const uint256& txid)\n \n void TxOrphanage::EraseForPeer(NodeId peer)\n {\n-    AssertLockHeld(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n+    const int work_erased = m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n+\n     std::map<uint256, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n         std::map<uint256, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n-            nErased += EraseTx(maybeErase->second.tx->GetHash());\n+            nErased += _EraseTx(maybeErase->second.tx->GetHash());\n         }\n     }\n-    if (nErased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\n+    if (nErased > 0 || work_erased > 0) LogPrint(BCLog::MEMPOOL, \"Erased %d orphan tx and %d from orphan work set for peer=%d\\n\", nErased, work_erased, peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601225798",
      "id" : 601225798,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTIyNTc5OA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 104,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601225798",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601236470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601236470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is a good idea. Anything that you guard with this mutex will never be accessible on other threads, which would prevent us from eg exposing it to RPC methods, or using it in validation interface callbacks. This seems like a way of reinventing thread local storage, which I don't think we want.\r\n\r\nIn addition, this mutex is exposed and used in both the net and net_processing layer, which adds to the coupling between those components. That's the opposite direction that I think we want to go in.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T09:11:32Z",
      "diff_hunk" : "@@ -232,6 +232,7 @@ struct LocalServiceInfo {\n     uint16_t nPort;\n };\n \n+extern Mutex g_mutex_message_handler;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601236470",
      "id" : 601236470,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTIzNjQ3MA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 235,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601236470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601253387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601253387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this possible? I think the logic in `GetTxToReconsider()` ensures that if true is returned, then porphanTx will not be null.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T09:26:41Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n \n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    while (m_orphanage.GetTxToReconsider(peer.m_id, porphanTx, from_peer, more)) {\n+        if (porphanTx == nullptr) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601253387",
      "id" : 601253387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTI1MzM4Nw==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2090,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601253387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601279266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601279266"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a very strange interface. How about returning a `std::optional<std::pair<CTransactionRef, NodeId>>`, and then adding another public method `HasTxToReconsider()`. It's a bit less efficient, but we'll only ever call it after processing a transaction, so it seems negligible.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T09:49:02Z",
      "diff_hunk" : "@@ -21,65 +23,75 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+    bool HaveTx(const GenTxid& gtxid) const;\n \n-    /** Get an orphan transaction and its orginating peer\n-     * (Transaction ref will be nullptr if not found)\n+    /** Get an orphan transaction for a peer to work on\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, and populates its arguments with tx,\n+     *  the originating peer, and whether there are more orphans for this\n+     *  peer to work on after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601279266",
      "id" : 601279266,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTI3OTI2Ng==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 35,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601279266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601280373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601280373"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess this means you already tried using an optional in the return value of `GetTxToReconsider()`? ",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T09:49:56Z",
      "diff_hunk" : "@@ -10,8 +10,10 @@\n #include <primitives/transaction.h>\n #include <sync.h>\n \n-/** Guards orphan transactions and extra txs for compact blocks */\n-extern RecursiveMutex g_cs_orphans;\n+#include <map>\n+#include <optional>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601280373",
      "id" : 601280373,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTI4MDM3Mw==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 14,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601280373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601283910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601283910"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think you need this lock. It was previously here to enforce that cs_main was taken before g_cs_orphans.\r\n\r\nIt can also be removed from the process_message and process_messages fuzz tests.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T09:53:10Z",
      "diff_hunk" : "@@ -203,15 +203,14 @@ void Shutdown(NodeContext& node)\n     // Follow the lock order requirements:\n     // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n     //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n+    // * ProcessMessage locks cs_main before indirectly calling ForEachNode which locks cs_vNodes.\n+    // * CConnman::StopNodes grabs cs_vNodes lock which calls DeleteNode, which calls FinalizeNode,\n+    //   which locks cs_main and calls EraseOrphansFor.\n     //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n+    // Thus the implicit locking order requirement is: (1) cs_main, (2) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601283910",
      "id" : 601283910,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTI4MzkxMA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601283910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601298826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601298826"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment is now incorrect. The multimap stores the node that provided the orphan tx.\r\n\r\nAlso, this data is redundant data with the `fromPeer` in the `OrphanTx` struct (this could easily be a set of txids to reconsider, and the originating peer is then looked up in the `OrphanTx` struct). We store it in the multimap for efficiency - the comment could be updated to indicate that.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T10:05:44Z",
      "diff_hunk" : "@@ -21,65 +23,75 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+    bool HaveTx(const GenTxid& gtxid) const;\n \n-    /** Get an orphan transaction and its orginating peer\n-     * (Transaction ref will be nullptr if not found)\n+    /** Get an orphan transaction for a peer to work on\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, and populates its arguments with tx,\n+     *  the originating peer, and whether there are more orphans for this\n+     *  peer to work on after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more);\n \n     /** Erase an orphan by txid */\n-    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    int EraseTx(const uint256& txid) { LOCK(m_mutex); return _EraseTx(txid); }\n \n     /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n-    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void EraseForPeer(NodeId peer);\n \n     /** Erase all orphans included in or invalidated by a new block */\n-    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!g_cs_orphans);\n+    void EraseForBlock(const CBlock& block);\n \n     /** Limit the orphanage to the given maximum */\n-    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    unsigned int LimitOrphans(unsigned int max_orphans);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Add any orphans that list a particular tx as a parent into the from peer's work set */\n+    void AddChildrenToWorkSet(const CTransaction& tx);\n \n protected:\n+    /** Guards data */\n+    mutable Mutex m_mutex;\n+\n+    /** Erase an orphan by txid (internal, lock must already be held) */\n+    int _EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n     struct OrphanTx {\n         CTransactionRef tx;\n         NodeId fromPeer;\n         int64_t nTimeExpire;\n         size_t list_pos;\n     };\n \n-    /** Map from txid to orphan transaction record. Limited by\n-     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n-\n-    using OrphanMap = decltype(m_orphans);\n+    using OrphanMap = std::map<uint256, OrphanTx>;\n \n     struct IteratorComparator\n     {\n-        template<typename I>\n-        bool operator()(const I& a, const I& b) const\n+        bool operator()(const OrphanMap::iterator& a, const OrphanMap::iterator& b) const\n         {\n             return &(*a) < &(*b);\n         }\n     };\n \n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    OrphanMap m_orphans GUARDED_BY(m_mutex);\n+\n+    /** Which peer provided a parent tx of orphans that need to be reconsidered */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601298826",
      "id" : 601298826,
      "line" : 80,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTI5ODgyNg==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 80,
      "original_position" : 92,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 90,
      "pull_request_review_id" : 620835937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601298826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601391595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601391595"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We could process 3 txs I think -- the last orphan already in the workset (in ProcessMessages), one from a just received TX message, and an additional orphan whose parent was the contents of that TX message. I don't think it's problematic that way, but 1-non-trivial-ATMP-call per ProcessMessages invocation could be reasonable.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T11:27:43Z",
      "diff_hunk" : "@@ -3059,7 +3060,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n \n             // Recursively process any orphan transactions that depended on this one\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n+            ProcessOrphanTx(*peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601391595",
      "id" : 601391595,
      "in_reply_to_id" : 601192396,
      "line" : 3113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTM5MTU5NQ==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 3113,
      "original_position" : 151,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 189,
      "pull_request_review_id" : 620999343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601391595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601392702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601392702"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It crossed my mind that this might be another case where a multi index could be a win.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T11:28:46Z",
      "diff_hunk" : "@@ -87,24 +86,27 @@ int TxOrphanage::EraseTx(const uint256& txid)\n \n void TxOrphanage::EraseForPeer(NodeId peer)\n {\n-    AssertLockHeld(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n+    const int work_erased = m_peer_work_set.erase(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601392702",
      "id" : 601392702,
      "in_reply_to_id" : 601223122,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTM5MjcwMg==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 91,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 621000254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601392702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601398665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601398665"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The reasoning isn't that this is particularly \"good\", it's that it's documenting the safety mechanisms we already have. It would have caught https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601317221 for instance.\r\n\r\nnet_processing is fundamentally coupled with net -- it implements the NetEventsInterface defined and called from net. I mean I guess if you preferred, it could be `NetEventsInterface::m_mutex_message_handler`? (EDIT: actually, whether or not you prefer that, I think I do...)",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T11:34:23Z",
      "diff_hunk" : "@@ -232,6 +232,7 @@ struct LocalServiceInfo {\n     uint16_t nPort;\n };\n \n+extern Mutex g_mutex_message_handler;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601398665",
      "id" : 601398665,
      "in_reply_to_id" : 601236470,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTM5ODY2NQ==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 235,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 621004986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601398665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601401123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601401123"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`assert(porphanTx != nullptr)` seemed overkill and not having anything seemed like it might be annoying for static analysers",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T11:36:39Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n \n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    while (m_orphanage.GetTxToReconsider(peer.m_id, porphanTx, from_peer, more)) {\n+        if (porphanTx == nullptr) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601401123",
      "id" : 601401123,
      "in_reply_to_id" : 601253387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTQwMTEyMw==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2090,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 621006771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601401123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601414014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601414014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I updated the comments which should still indicate why cs_main is needed there -- it needs to be locked before cs_vNodes, but cs_vNodes is locked first if you call StopThreads directly?",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T11:48:29Z",
      "diff_hunk" : "@@ -203,15 +203,14 @@ void Shutdown(NodeContext& node)\n     // Follow the lock order requirements:\n     // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n     //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n+    // * ProcessMessage locks cs_main before indirectly calling ForEachNode which locks cs_vNodes.\n+    // * CConnman::StopNodes grabs cs_vNodes lock which calls DeleteNode, which calls FinalizeNode,\n+    //   which locks cs_main and calls EraseOrphansFor.\n     //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n+    // Thus the implicit locking order requirement is: (1) cs_main, (2) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601414014",
      "id" : 601414014,
      "in_reply_to_id" : 601283910,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTQxNDAxNA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 621016147,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601414014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601414581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601414581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Very good point. I hadn't considered processing the orphan _before_ processing the net message.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T11:49:09Z",
      "diff_hunk" : "@@ -3059,7 +3060,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n \n             // Recursively process any orphan transactions that depended on this one\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n+            ProcessOrphanTx(*peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601414581",
      "id" : 601414581,
      "in_reply_to_id" : 601192396,
      "line" : 3113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTQxNDU4MQ==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 3113,
      "original_position" : 151,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 189,
      "pull_request_review_id" : 621016668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601414581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601416590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601416590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How about: `if (!Assume(porphanTx)) break` ?",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T11:52:34Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n \n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    while (m_orphanage.GetTxToReconsider(peer.m_id, porphanTx, from_peer, more)) {\n+        if (porphanTx == nullptr) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601416590",
      "id" : 601416590,
      "in_reply_to_id" : 601253387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTQxNjU5MA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2090,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 621019338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601416590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601422013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601422013"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, very good point. And we can't take `cs_main` inside `StopNodes` because net isn't aware of `cs_main`.\r\n\r\nIt's outside the scope of this PR, but it'd be good to untangle this lock ordering dependency by eg making sure that cs_vNodes is not held when calling any PeerManager functions.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T12:00:57Z",
      "diff_hunk" : "@@ -203,15 +203,14 @@ void Shutdown(NodeContext& node)\n     // Follow the lock order requirements:\n     // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n     //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n+    // * ProcessMessage locks cs_main before indirectly calling ForEachNode which locks cs_vNodes.\n+    // * CConnman::StopNodes grabs cs_vNodes lock which calls DeleteNode, which calls FinalizeNode,\n+    //   which locks cs_main and calls EraseOrphansFor.\n     //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n+    // Thus the implicit locking order requirement is: (1) cs_main, (2) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601422013",
      "id" : 601422013,
      "in_reply_to_id" : 601283910,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTQyMjAxMw==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 621026235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601422013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601452522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601452522"
         }
      },
      "author_association" : "MEMBER",
      "body" : "And if you're doing that then perhaps you can make it a `PeerManagerImpl::m_mutex_message_handler` and take it in `ProcessMessages()` and `SendMessages()`. Taking that lock once at the top of those functions would be very low cost (since there would never be any contention).",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-03-25T12:46:18Z",
      "diff_hunk" : "@@ -232,6 +232,7 @@ struct LocalServiceInfo {\n     uint16_t nPort;\n };\n \n+extern Mutex g_mutex_message_handler;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601452522",
      "id" : 601452522,
      "in_reply_to_id" : 601236470,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTQ1MjUyMg==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 235,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 621066590,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601452522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616368502"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616368502"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've done this now -- the first three commits introduce `m_mutex_messages`, remove `cs_sendProcessing` and move extra txns to be protected by `m_mutex_messages` instead of `g_cs_orphans`. I think it would be good to cherry-pick those commits into #21186 so that the moved addr variables can actually be marked as guarded by something.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T06:04:30Z",
      "diff_hunk" : "@@ -232,6 +232,7 @@ struct LocalServiceInfo {\n     uint16_t nPort;\n };\n \n+extern Mutex g_mutex_message_handler;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616368502",
      "id" : 616368502,
      "in_reply_to_id" : 601236470,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM2ODUwMg==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 235,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 639533523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616368502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616385405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616385405"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think:\r\n\r\n * just call AddChildrenToWorkSet when a new tx arrives, don't also immediately process them (ie don't also call ProcessOrphanTx)\r\n * when ProcessOrphanTx does work, don't continue on to also do a ProcessMessage, give another peer a chance to get some work done first\r\n * have ProcessOrphanTx take cs_main only when necessary\r\n * make the GetTxToReconsider signature simpler\r\n \r\nwould all fit together nicely and be a good idea, but it also feels like it's adding a bit much to this PR?\r\n ",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T06:39:32Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616385405",
      "id" : 616385405,
      "in_reply_to_id" : 601221165,
      "line" : 2086,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM4NTQwNQ==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2086,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 110,
      "pull_request_review_id" : 639554968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616385405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616392400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616392400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See #21563",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T06:52:36Z",
      "diff_hunk" : "@@ -203,15 +203,14 @@ void Shutdown(NodeContext& node)\n     // Follow the lock order requirements:\n     // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n     //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n+    // * ProcessMessage locks cs_main before indirectly calling ForEachNode which locks cs_vNodes.\n+    // * CConnman::StopNodes grabs cs_vNodes lock which calls DeleteNode, which calls FinalizeNode,\n+    //   which locks cs_main and calls EraseOrphansFor.\n     //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n+    // Thus the implicit locking order requirement is: (1) cs_main, (2) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616392400",
      "id" : 616392400,
      "in_reply_to_id" : 601283910,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM5MjQwMA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 639563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616392400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, some of the suggestions picked up, reworked the \"message handler\" mutex.",
      "created_at" : "2021-04-20T06:53:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-823022635",
      "id" : 823022635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzAyMjYzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T06:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823022635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616392887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616392887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also see #21563",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T06:53:25Z",
      "diff_hunk" : "@@ -232,6 +232,7 @@ struct LocalServiceInfo {\n     uint16_t nPort;\n };\n \n+extern Mutex g_mutex_message_handler;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616392887",
      "id" : 616392887,
      "in_reply_to_id" : 601236470,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM5Mjg4Nw==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 235,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 639564557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616392887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616546524"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616546524"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it'd be cleaner for the `m_mutex_messages` lock to be taken by ProcessMessage**s**, rather than ProcessMessage. That would remove the need to define an inner `_ProcessMessage` to be called when the mutex is already locked. It's also consistent with the comment on the `m_mutex_messages` member, which says \"is acquired by ProcessMessages and SendMessages\"",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T10:14:46Z",
      "diff_hunk" : "@@ -253,9 +250,18 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_messages);\n \n private:\n+    /** Message processing is single-threaded\n+     * Anything only accessed by message parsing can be guarded by\n+     * this mutex, which is acquired by ProcessMessages and SendMessages\n+     */\n+    Mutex m_mutex_messages;\n+\n+    void _ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616546524",
      "id" : 616546524,
      "line" : 263,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjU0NjUyNA==",
      "original_commit_id" : "9cc2da27d3fed55cbe442ec13c87d157ef401822",
      "original_line" : 263,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 639768190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616546524",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616563414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616563414"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It is taken by `ProcessMessages()` (and also by `SendMessages()`), however `ProcessMessage()` is also called from the test suite, so cannot assume the lock has been taken. That's why the public interface, `ProcessMessage()`, is implemented as a wrapper that takes the lock, then calls the internal function.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T10:40:27Z",
      "diff_hunk" : "@@ -253,9 +250,18 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_messages);\n \n private:\n+    /** Message processing is single-threaded\n+     * Anything only accessed by message parsing can be guarded by\n+     * this mutex, which is acquired by ProcessMessages and SendMessages\n+     */\n+    Mutex m_mutex_messages;\n+\n+    void _ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616563414",
      "id" : 616563414,
      "in_reply_to_id" : 616546524,
      "line" : 263,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjU2MzQxNA==",
      "original_commit_id" : "9cc2da27d3fed55cbe442ec13c87d157ef401822",
      "original_line" : 263,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 639790506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616563414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616661184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616661184"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, sorry - misread.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T13:02:28Z",
      "diff_hunk" : "@@ -253,9 +250,18 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_messages);\n \n private:\n+    /** Message processing is single-threaded\n+     * Anything only accessed by message parsing can be guarded by\n+     * this mutex, which is acquired by ProcessMessages and SendMessages\n+     */\n+    Mutex m_mutex_messages;\n+\n+    void _ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616661184",
      "id" : 616661184,
      "in_reply_to_id" : 616546524,
      "line" : 263,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjY2MTE4NA==",
      "original_commit_id" : "9cc2da27d3fed55cbe442ec13c87d157ef401822",
      "original_line" : 263,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 639919003,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616661184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've re-reviewed the locking changes and they look reasonable. There are still a few review comments outstanding. I'm happy to review this PR again once those have been addressed.",
      "created_at" : "2021-04-20T13:08:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-823260165",
      "id" : 823260165,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzI2MDE2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T13:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823260165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616696972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616696972"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> This PR changes orphan processing from being done for the peer that provided the parent to the peer that provided the orphan. I think that's fine, but perhaps we should split the PR into one that does refactoring only and one that has behaviour changes.\r\n\r\nHmm, might make sense to put the changes above together with the last commit in a separate PR, so this is just refactoring and the behaviour changes (who processes orphans, and how many orphans are processed in a cycle) are collected together.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T13:44:22Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616696972",
      "id" : 616696972,
      "in_reply_to_id" : 601221165,
      "line" : 2086,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjY5Njk3Mg==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2086,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 110,
      "pull_request_review_id" : 639968531,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616696972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616712448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616712448"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I agree that it's better to split the PR into two: one that refactors and one that changes behaviour.",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-20T14:00:59Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r616712448",
      "id" : 616712448,
      "in_reply_to_id" : 601221165,
      "line" : 2086,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjcxMjQ0OA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2086,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 110,
      "pull_request_review_id" : 639989638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/616712448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r618789454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618789454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is drafted at https://github.com/ajtowns/bitcoin/commits/202104-whohandlesorphans",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-22T22:41:31Z",
      "diff_hunk" : "@@ -2010,33 +2016,25 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in/out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n     AssertLockHeld(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r618789454",
      "id" : 618789454,
      "in_reply_to_id" : 601221165,
      "line" : 2086,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODc4OTQ1NA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 2086,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 110,
      "pull_request_review_id" : 642749069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/618789454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is now cleaned up, and ready for review. The behaviour changes that were in the last commit are now deferred to https://github.com/ajtowns/bitcoin/commits/202104-whohandlesorphans . ",
      "created_at" : "2021-04-22T22:43:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-825228907",
      "id" : 825228907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTIyODkwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-22T22:43:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825228907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-25T09:20:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-826289705",
      "id" : 826289705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjI4OTcwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-25T09:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826289705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r619829668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619829668"
         }
      },
      "author_association" : "MEMBER",
      "body" : "21563 is merged",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-25T15:02:06Z",
      "diff_hunk" : "@@ -203,15 +203,14 @@ void Shutdown(NodeContext& node)\n     // Follow the lock order requirements:\n     // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n     //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n+    // * ProcessMessage locks cs_main before indirectly calling ForEachNode which locks cs_vNodes.\n+    // * CConnman::StopNodes grabs cs_vNodes lock which calls DeleteNode, which calls FinalizeNode,\n+    //   which locks cs_main and calls EraseOrphansFor.\n     //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n+    // Thus the implicit locking order requirement is: (1) cs_main, (2) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r619829668",
      "id" : 619829668,
      "in_reply_to_id" : 601283910,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTgyOTY2OA==",
      "original_commit_id" : "59cfe0c74bcb06cda19b9ce25e74c57332487e47",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 644149974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T09:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619829668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "When you rebase this, there are a few files that no longer need to include txorphanage.h:\r\n\r\n<details>\r\n<summary>Diff</summary>\r\n\r\n```diff\r\ndiff --git a/src/init.cpp b/src/init.cpp\r\nindex bb5b144802..e7b5ed60e3 100644\r\n--- a/src/init.cpp\r\n+++ b/src/init.cpp\r\n@@ -52,7 +52,6 @@\r\n #include <torcontrol.h>\r\n #include <txdb.h>\r\n #include <txmempool.h>\r\n-#include <txorphanage.h>\r\n #include <util/asmap.h>\r\n #include <util/check.h>\r\n #include <util/moneystr.h>\r\ndiff --git a/src/test/fuzz/process_message.cpp b/src/test/fuzz/process_message.cpp\r\nindex 7b99193ad0..5a71b25768 100644\r\n--- a/src/test/fuzz/process_message.cpp\r\n+++ b/src/test/fuzz/process_message.cpp\r\n@@ -18,7 +18,6 @@\r\n #include <test/util/net.h>\r\n #include <test/util/setup_common.h>\r\n #include <test/util/validation.h>\r\n-#include <txorphanage.h>\r\n #include <validationinterface.h>\r\n #include <version.h>\r\n \r\ndiff --git a/src/test/fuzz/process_messages.cpp b/src/test/fuzz/process_messages.cpp\r\nindex 11b236c9bd..f8b1c8fc90 100644\r\n--- a/src/test/fuzz/process_messages.cpp\r\n+++ b/src/test/fuzz/process_messages.cpp\r\n@@ -13,7 +13,6 @@\r\n #include <test/util/net.h>\r\n #include <test/util/setup_common.h>\r\n #include <test/util/validation.h>\r\n-#include <txorphanage.h>\r\n #include <validation.h>\r\n #include <validationinterface.h>\r\n```\r\n\r\n</details>\r\n\r\nThose files were only including txorphange.h to use the g_cs_orphans mutex.",
      "created_at" : "2021-04-25T15:38:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-826344035",
      "id" : 826344035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjM0NDAzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-25T15:38:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826344035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased (and likewise the whohandlesorphans followup)",
      "created_at" : "2021-04-29T09:21:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-829077016",
      "id" : 829077016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyOTA3NzAxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-29T09:21:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/829077016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r622998740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/622998740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    /** Get an orphan transaction for a peer to work on and erase it from the peer's workset.\r\n```",
      "commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "created_at" : "2021-04-29T12:20:48Z",
      "diff_hunk" : "@@ -21,65 +21,75 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    /** Get an orphan transaction for a peer to work on",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r622998740",
      "id" : 622998740,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMjk5ODc0MA==",
      "original_commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "original_line" : 29,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 24,
      "pull_request_review_id" : 648135263,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-29T12:40:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/622998740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\n @sipa has been requested to review this pull request as specified in the REVIEWERS file.",
      "created_at" : "2021-05-03T09:32:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-831142078",
      "id" : 831142078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMTE0MjA3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-03T09:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/831142078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-05-07T03:16:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-834031899",
      "id" : 834031899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNDAzMTg5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-07T03:16:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/834031899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased past #21845. cc @MarcoFalke @promag for reviews :)",
      "created_at" : "2021-05-07T12:27:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-834330923",
      "id" : 834330923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNDMzMDkyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-07T12:27:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/834330923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 8b4f685ebef5eb14f049d04e2c4f4ce5b44878de\r\n\r\nDo you mind addressing https://github.com/bitcoin/bitcoin/pull/21527#discussion_r622998740 while there are no other ACKs on the branch?",
      "created_at" : "2021-05-07T13:00:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-834360334",
      "id" : 834360334,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNDM2MDMzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-07T13:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/834360334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628237298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628237298"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done-ish",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-07T14:04:51Z",
      "diff_hunk" : "@@ -21,65 +21,75 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    /** Get an orphan transaction for a peer to work on",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628237298",
      "id" : 628237298,
      "in_reply_to_id" : 622998740,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODIzNzI5OA==",
      "original_commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "original_line" : 29,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 654495227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T14:04:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628237298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-07T14:39:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-834466926",
      "id" : 834466926,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNDQ2NjkyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-07T14:39:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/834466926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628263177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628263177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "thank you!",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-07T14:39:58Z",
      "diff_hunk" : "@@ -21,65 +21,75 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    /** Get an orphan transaction for a peer to work on",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628263177",
      "id" : 628263177,
      "in_reply_to_id" : 622998740,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODI2MzE3Nw==",
      "original_commit_id" : "584043a0203332fe645529b1c27c086e4f14a61c",
      "original_line" : 29,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 654531888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T14:39:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628263177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628835510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628835510"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit fec0ff16627c1cbf5545c9de8db19b749c90beee:\r\n\r\nThe lock order is m_mutex_message_handling -> cs_main -> g_cs_orphans, so it would be nice to also order the Asserts here in the same way.",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-09T05:21:12Z",
      "diff_hunk" : "@@ -2093,6 +2095,7 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n {\n     AssertLockHeld(cs_main);\n+    AssertLockHeld(m_mutex_message_handling);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628835510",
      "id" : 628835510,
      "line" : 2097,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODgzNTUxMA==",
      "original_commit_id" : "fec0ff16627c1cbf5545c9de8db19b749c90beee",
      "original_line" : 2098,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 113,
      "pull_request_review_id" : 655041297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-09T06:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628835510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628836372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628836372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "57900348db566105351b525ae18cc2830e9665b5:\r\n\r\nThis undocumented one-line-if might be a bit too minimal. Previously there was a nice comment as to why return early is needed here. Now the comment is gone, or at least can't be trivially attached to the return here.",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-09T05:30:24Z",
      "diff_hunk" : "@@ -3895,9 +3902,7 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n \n     {\n         LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(*peer);\n-        }\n+        if (ProcessOrphanTx(*peer)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628836372",
      "id" : 628836372,
      "line" : 3900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODgzNjM3Mg==",
      "original_commit_id" : "57900348db566105351b525ae18cc2830e9665b5",
      "original_line" : 3905,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 230,
      "pull_request_review_id" : 655041297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-09T06:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628836372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628839074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628839074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "67618f024690bc9b926aa48ead23a0f687f03fe4: I know there is a check to avoid duplicate insertion of the same txid, but is there a reason to pick this datastructure, which doesn't disallow duplicate entries like set? Also insertion is trivially more expensive (log(all peers' work sets) vs log(this peers' work set)). Finally handling is done in insertion order, not in sorted order.",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-09T06:00:19Z",
      "diff_hunk" : "@@ -43,9 +43,11 @@ class TxOrphanage {\n     /** Limit the orphanage to the given maximum */\n     unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Which peer provided a parent tx of orphans that need to be reconsidered */\n+    std::multimap<NodeId, uint256> m_peer_work_set GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628839074",
      "id" : 628839074,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODgzOTA3NA==",
      "original_commit_id" : "67618f024690bc9b926aa48ead23a0f687f03fe4",
      "original_line" : 47,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 655041297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-09T06:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628839074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628907747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628907747"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure what you mean by \"the comment is gone\" ? The \"maintains the order of responses and prevents ~vRecvGetData~ m_getdata_requests to grow unbounded\" is still there, but at least I thought that sensibly described the ~`!pfrom->vRecvGetData.empty()`~ `!peer->m_getdata_requests.empty()` check it remains attached to, and didn't really fit the \"more orphans to work on\" check. (EDIT: oops, was looking at 0.19 to see if there was any other comment)",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-09T15:45:33Z",
      "diff_hunk" : "@@ -3895,9 +3902,7 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n \n     {\n         LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(*peer);\n-        }\n+        if (ProcessOrphanTx(*peer)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r628907747",
      "id" : 628907747,
      "in_reply_to_id" : 628836372,
      "line" : 3900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODkwNzc0Nw==",
      "original_commit_id" : "57900348db566105351b525ae18cc2830e9665b5",
      "original_line" : 3905,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 230,
      "pull_request_review_id" : 655090428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-09T16:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628907747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r631826871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631826871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> ... is there a reason to pick this datastructure, which doesn't disallow duplicate entries ...\r\n\r\nI think the reason could be to allow (nodeX, tx1), (nodeX, tx2)?",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-13T13:53:19Z",
      "diff_hunk" : "@@ -43,9 +43,11 @@ class TxOrphanage {\n     /** Limit the orphanage to the given maximum */\n     unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Which peer provided a parent tx of orphans that need to be reconsidered */\n+    std::multimap<NodeId, uint256> m_peer_work_set GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r631826871",
      "id" : 631826871,
      "in_reply_to_id" : 628839074,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTgyNjg3MQ==",
      "original_commit_id" : "67618f024690bc9b926aa48ead23a0f687f03fe4",
      "original_line" : 47,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 658925527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T13:53:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631826871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r631895780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631895780"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If it is single-threaded, then we don't need to guard anything with a mutex?\r\n\r\nIt looks to me that `PeerManagerImpl::m_mutex_message_handling` is useless because it is only being acquired from a single thread. No two threads are ever going to race to acquire it at the same time:\r\n\r\n```cpp\r\nThreadMessageHandler() // there is just one thread executing this\r\n   ProcessMessages()\r\n       ...\r\n       lock m_mutex_message_handling\r\n       ...\r\n   ...\r\n   SendMessages()\r\n       ...\r\n       lock m_mutex_message_handling\r\n       ...\r\n```\r\n\r\nI may be missing something but to me it looks like `m_mutex_message_handling` can be removed safely, which will reduce the complexity of the code.\r\n",
      "commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "created_at" : "2021-05-13T15:25:27Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r631895780",
      "id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTg5NTc4MA==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 658993554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T15:35:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631895780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633205205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633205205"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that if you've got N peers each with K items in their work set, then a log search over everything is `log(N*K)`, and a log search for the peer followed by a log search or the work item is `log(N) + log(K)` which is the same. If there's one peer with K items and every other peer has 0, you instead get `log(K)` vs `log(N) + 1/N log(K)`; so a map of sets would be better than a set of pairs provided `N < K`, but probably isn't very interesting.\r\n\r\nI picked the data structure because I thought it was simpler than a set of pairs, but I don't think there's an adequate check to avoid duplicate insertion of the same txid (and to do that, you'd have to search through all the entries for a peer, which would be annoying).",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T03:49:59Z",
      "diff_hunk" : "@@ -43,9 +43,11 @@ class TxOrphanage {\n     /** Limit the orphanage to the given maximum */\n     unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Which peer provided a parent tx of orphans that need to be reconsidered */\n+    std::multimap<NodeId, uint256> m_peer_work_set GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633205205",
      "id" : 633205205,
      "in_reply_to_id" : 628839074,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzIwNTIwNQ==",
      "original_commit_id" : "67618f024690bc9b926aa48ead23a0f687f03fe4",
      "original_line" : 47,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 660532615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T03:49:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633205205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633205889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633205889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed to `map<NodeId,set<uint256>>`",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T03:52:59Z",
      "diff_hunk" : "@@ -43,9 +43,11 @@ class TxOrphanage {\n     /** Limit the orphanage to the given maximum */\n     unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Which peer provided a parent tx of orphans that need to be reconsidered */\n+    std::multimap<NodeId, uint256> m_peer_work_set GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633205889",
      "id" : 633205889,
      "in_reply_to_id" : 628839074,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzIwNTg4OQ==",
      "original_commit_id" : "67618f024690bc9b926aa48ead23a0f687f03fe4",
      "original_line" : 47,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 660533417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T03:52:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633205889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633206688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633206688"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You don't need the mutex at runtime, but having the `GUARDED_BY(m_mutex_message_handling)` at compile time makes it easy to verify nobody's accidentally accessing the object from some other thread (either currently, or as a result of some future change, eg adding an RPC call that wants to expose some of the information stored in those objects). The cost of also having the mutex at runtime is trivial since there's never any contention on it.",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T03:56:19Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633206688",
      "id" : 633206688,
      "in_reply_to_id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzIwNjY4OA==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 660534298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-17T03:56:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633206688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633287175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633287175"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    // Look up this peer's work set, ensuring it exists.\r\n```",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T07:31:35Z",
      "diff_hunk" : "@@ -132,15 +134,19 @@ unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n     {\n         // Evict a random orphan:\n         size_t randompos = rng.randrange(m_orphan_list.size());\n-        EraseTx(m_orphan_list[randompos]->first);\n+        _EraseTx(m_orphan_list[randompos]->first);\n         ++nEvicted;\n     }\n     return nEvicted;\n }\n \n-void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, NodeId peer)\n {\n-    AssertLockHeld(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n+    // lookup this peer's work set, ensuring it exists",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633287175",
      "id" : 633287175,
      "line" : 147,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzI4NzE3NQ==",
      "original_commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "original_line" : 147,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 84,
      "pull_request_review_id" : 660637741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T07:31:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633287175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633293884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633293884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit bdd227493602437d4b6ee2d366ca0a83189f071c:\r\n\r\nThe new value for `it` is unused. No need to set it here:\r\n\r\n```suggestion\r\n        orphan_work_set.erase(it);\r\n```",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T07:42:41Z",
      "diff_hunk" : "@@ -2100,11 +2097,15 @@ bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n     AssertLockHeld(cs_main);\n     AssertLockHeld(g_cs_orphans);\n \n-    if (peer.m_orphan_work_set.empty()) return false;\n+    auto work_set_it = m_orphanage.m_peer_work_set.find(peer.m_id);\n+    if (work_set_it == m_orphanage.m_peer_work_set.end()) return false;\n+\n+    std::set<uint256>& orphan_work_set = work_set_it->second;\n \n-    while (!peer.m_orphan_work_set.empty()) {\n-        const uint256 orphanHash = *peer.m_orphan_work_set.begin();\n-        peer.m_orphan_work_set.erase(peer.m_orphan_work_set.begin());\n+    while (!orphan_work_set.empty()) {\n+        auto it = orphan_work_set.begin();\n+        const uint256 orphanHash = *it;\n+        it = orphan_work_set.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633293884",
      "id" : 633293884,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzI5Mzg4NA==",
      "original_commit_id" : "bdd227493602437d4b6ee2d366ca0a83189f071c",
      "original_line" : 2108,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 660646816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T08:02:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633293884",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633446322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633446322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I left a comment about this interface further up that seems to have been lost without being resolved. I think the interface is needlessly complex and doing too much. From my comment above:\r\n\r\n> How about returning a `std::optional<std::pair<CTransactionRef, NodeId>>`, and then adding another public method `HasTxToReconsider()`. It's a bit less efficient, but we'll only ever call it after processing a transaction, so it seems negligible.",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T11:22:06Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633446322",
      "id" : 633446322,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzQ0NjMyMg==",
      "original_commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "original_line" : 36,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 33,
      "pull_request_review_id" : 660851825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T11:26:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633446322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633447335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633447335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(if you're keeping `more`), the following is equivalent, and maybe more direct/clear:\r\n\r\n```suggestion\r\n                more = !(work_set.empty());\r\n```",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T11:23:53Z",
      "diff_hunk" : "@@ -153,26 +159,43 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>\n \n bool TxOrphanage::HaveTx(const GenTxid& gtxid) const\n {\n-    LOCK(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n     if (gtxid.IsWtxid()) {\n         return m_wtxid_to_orphan_it.count(gtxid.GetHash());\n     } else {\n         return m_orphans.count(gtxid.GetHash());\n     }\n }\n \n-std::pair<CTransactionRef, NodeId> TxOrphanage::GetTx(const uint256& txid) const\n+bool TxOrphanage::GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more)\n {\n-    AssertLockHeld(g_cs_orphans);\n-\n-    const auto it = m_orphans.find(txid);\n-    if (it == m_orphans.end()) return {nullptr, -1};\n-    return {it->second.tx, it->second.fromPeer};\n+    LOCK(m_mutex);\n+\n+    auto work_set_it = m_peer_work_set.find(peer);\n+    if (work_set_it != m_peer_work_set.end()) {\n+        auto& work_set = work_set_it->second;\n+        auto it = work_set.begin();\n+        while (it != work_set.end()) {\n+            uint256 txid = *it;\n+            it = work_set.erase(it);\n+\n+            const auto orphan_it = m_orphans.find(txid);\n+            if (orphan_it != m_orphans.end()) {\n+                more = (it != work_set.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633447335",
      "id" : 633447335,
      "line" : 185,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzQ0NzMzNQ==",
      "original_commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "original_line" : 185,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 124,
      "pull_request_review_id" : 660851825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T11:26:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633447335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633456971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633456971"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601221165",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T11:40:48Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633456971",
      "id" : 633456971,
      "in_reply_to_id" : 633446322,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzQ1Njk3MQ==",
      "original_commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "original_line" : 36,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 33,
      "pull_request_review_id" : 660865808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T11:40:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633456971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633669006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633669006"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "NACK the addition of `m_mutex_message_handling`.\r\n\r\nFollowing the logic of\r\n\r\n> GUARDED_BY() makes it easy to verify nobody's accidentally accessing...\r\n\r\nshould we add a dummy mutex for **every** variable?\r\n\r\nIMO mutexes should be used only where concurrent access is possible.",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T16:11:21Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633669006",
      "id" : 633669006,
      "in_reply_to_id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzY2OTAwNg==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 661155372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-17T16:11:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633669006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633692263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633692263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@vasild can you take a look at the commits that build on top of this branch in https://github.com/jnewbery/bitcoin/commits/2021-05-use-mutex-message-handling. Currently, a lot of the data in net_processing is guarded by cs_main, which is also used in validation. One way to loosen that coupling between validation and net_processing is to introduce an internal mutex inside net_processing (`m_mutex_message_handling`) that guards its own members.",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-17T16:43:31Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r633692263",
      "id" : 633692263,
      "in_reply_to_id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzY5MjI2Mw==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 661186513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-17T16:43:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633692263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r634375833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634375833"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that https://github.com/jnewbery/bitcoin/commits/2021-05-use-mutex-message-handling can be simplified and the common `m_mutex_message_handling` avoided by changing some of the variables to atomics and using a dedicated mutex for e.g. `m_txrequest`.\r\n\r\nBtw, it does not compile.\r\n<details>\r\n<summary>minor fixups</summary>\r\n\r\n```diff\r\ndiff --git i/src/net_processing.cpp w/src/net_processing.cpp\r\nindex c56863e5ef..cc04679683 100644\r\n--- i/src/net_processing.cpp\r\n+++ w/src/net_processing.cpp\r\n@@ -401,13 +401,13 @@ private:\r\n      * Set mapBlockSource[hash].second to false if the node should not be\r\n      * punished if the block is invalid.\r\n      */\r\n     std::map<uint256, std::pair<NodeId, bool>> mapBlockSource GUARDED_BY(cs_main);\r\n \r\n     /** Number of peers with wtxid relay. */\r\n-    int m_wtxid_relay_peers GUARDED_BY(m_mutex_message_handing) {0};\r\n+    int m_wtxid_relay_peers GUARDED_BY(m_mutex_message_handling) {0};\r\n \r\n     /** Number of outbound peers with m_chain_sync.m_protect. */\r\n     int m_outbound_peers_with_protect_from_disconnect GUARDED_BY(cs_main) = 0;\r\n \r\n     bool AlreadyHaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n \r\n@@ -1000,20 +1000,15 @@ void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)\r\n     CNodeState *state = State(node);\r\n     if (state) state->m_last_block_announcement = time_in_seconds;\r\n }\r\n \r\n void PeerManagerImpl::InitializeNode(CNode *pnode)\r\n {\r\n-    LOCK(m_mutex_message_handling);\r\n-\r\n     NodeId nodeid = pnode->GetId();\r\n-    {\r\n-        LOCK(cs_main);\r\n-        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(pnode->IsInboundConn()));\r\n-        assert(m_txrequest.Count(nodeid) == 0);\r\n-    }\r\n+    WITH_LOCK(cs_main, mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(pnode->IsInboundConn())));\r\n+    WITH_LOCK(m_mutex_message_handling, assert(m_txrequest.Count(nodeid) == 0));\r\n     {\r\n         PeerRef peer = std::make_shared<Peer>(nodeid, m_mutex_message_handling);\r\n         LOCK(m_peer_mutex);\r\n         m_peer_map.emplace_hint(m_peer_map.end(), nodeid, std::move(peer));\r\n     }\r\n     if (!pnode->IsInboundConn()) {\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>compilation errors</summary>\r\n\r\n```sh\r\n(clang 13)\r\n\r\nnet_processing.cpp:986:33: error: reading variable 'fPreferredDownload' requires holding mutex 'peer.m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n    const bool preferred = peer.fPreferredDownload;\r\n                                ^\r\nnet_processing.cpp:1033:13: error: calling function '_RelayTransaction' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n            _RelayTransaction(txid, tx->GetWitnessHash());\r\n            ^\r\nnet_processing.cpp:1062:41: error: reading variable 'fPreferredDownload' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n            nPreferredDownload -= peer->fPreferredDownload;\r\n                                        ^\r\nnet_processing.cpp:1063:42: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n            m_wtxid_relay_peers -= peer->m_wtxid_relay;\r\n                                         ^\r\nnet_processing.cpp:1537:41: error: calling function '_RelayTransaction' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n    WITH_LOCK(m_mutex_message_handling, _RelayTransaction(txid, wtxid););\r\n                                        ^\r\nnet_processing.cpp:1550:43: error: reading variable 'm_wtxid_relay' requires holding mutex 'it->second->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n        node->PushTxInventory(it->second->m_wtxid_relay ? wtxid : txid);\r\n                                          ^\r\nnet_processing.cpp:2485:15: error: writing variable 'fPreferredDownload' requires holding mutex 'peer->m_mutex_message_handling' exclusively [-Werror,-Wthread-safety-analysis]\r\n        peer->fPreferredDownload = (!pfrom.IsInboundConn() || pfrom.HasPermission(PF_NOBAN)) && !pfrom.IsAddrFetchConn() && !pfrom.fClient;\r\n              ^\r\nnet_processing.cpp:2486:37: error: reading variable 'fPreferredDownload' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n        nPreferredDownload -= peer->fPreferredDownload;\r\n                                    ^\r\nnet_processing.cpp:2653:24: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n            if (!peer->m_wtxid_relay) {\r\n                       ^\r\nnet_processing.cpp:2654:23: error: writing variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' exclusively [-Werror,-Wthread-safety-analysis]\r\n                peer->m_wtxid_relay = true;\r\n                      ^\r\nnet_processing.cpp:2777:23: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n            if (peer->m_wtxid_relay) {\r\n                      ^\r\nnet_processing.cpp:3049:37: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n        const uint256& hash = peer->m_wtxid_relay ? wtxid : txid;\r\n                                    ^\r\nnet_processing.cpp:3051:19: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n        if (peer->m_wtxid_relay && txid != wtxid) {\r\n                  ^\r\nnet_processing.cpp:3075:13: error: calling function 'AlreadyHaveTx' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        if (AlreadyHaveTx(GenTxid(/* is_wtxid=*/true, wtxid))) {\r\n            ^\r\nnet_processing.cpp:3084:21: error: calling function '_RelayTransaction' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n                    _RelayTransaction(tx.GetHash(), tx.GetWitnessHash());\r\n                    ^\r\nnet_processing.cpp:3090:44: error: calling function 'AcceptToMemoryPool' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        const MempoolAcceptResult result = AcceptToMemoryPool(m_chainman.ActiveChainstate(), m_mempool, ptx, false /* bypass_limits */);\r\n                                           ^\r\nnet_processing.cpp:3094:23: error: calling function 'check' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n            m_mempool.check(m_chainman.ActiveChainstate());\r\n                      ^\r\nnet_processing.cpp:3099:13: error: calling function '_RelayTransaction' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n            _RelayTransaction(tx.GetHash(), tx.GetWitnessHash());\r\n            ^\r\nnet_processing.cpp:3114:13: error: calling function 'ProcessOrphanTx' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n            ProcessOrphanTx(*peer);\r\n            ^\r\nnet_processing.cpp:3131:21: error: reading variable 'recentRejects' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n                if (recentRejects->contains(parent_txid)) {\r\n                    ^\r\nnet_processing.cpp:3147:26: error: calling function 'AlreadyHaveTx' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n                    if (!AlreadyHaveTx(gtxid)) AddTxAnnouncement(pfrom, *peer, gtxid, current_time);\r\n                         ^\r\nnet_processing.cpp:3172:17: error: reading variable 'recentRejects' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n                recentRejects->insert(tx.GetHash());\r\n                ^\r\nnet_processing.cpp:3173:17: error: reading variable 'recentRejects' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n                recentRejects->insert(tx.GetWitnessHash());\r\n                ^\r\nnet_processing.cpp:3192:24: error: reading variable 'recentRejects' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n                assert(recentRejects);\r\n                       ^\r\nnet_processing.cpp:3193:17: error: reading variable 'recentRejects' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n                recentRejects->insert(tx.GetWitnessHash());\r\n                ^\r\nnet_processing.cpp:3204:21: error: reading variable 'recentRejects' requires holding mutex 'cs_main' [-Werror,-Wthread-safety-analysis]\r\n                    recentRejects->insert(tx.GetHash());\r\n                    ^\r\nnet_processing.cpp:4291:29: error: reading variable 'fPreferredDownload' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n        bool fFetch = peer->fPreferredDownload || (nPreferredDownload == 0 && !pto->fClient && !pto->IsAddrFetchConn()); // Download if this is a nice peer, or we have no nice peers and this one might do.\r\n                            ^\r\nnet_processing.cpp:4504:53: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n                        const uint256& hash = peer->m_wtxid_relay ? txinfo.tx->GetWitnessHash() : txinfo.tx->GetHash();\r\n                                                    ^\r\nnet_processing.cpp:4505:40: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n                        CInv inv(peer->m_wtxid_relay ? MSG_WTX : MSG_TX, hash);\r\n                                       ^\r\nnet_processing.cpp:4536:85: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n                    CompareInvMempoolOrder compareInvMempoolOrder(&m_mempool, peer->m_wtxid_relay);\r\n                                                                                    ^\r\nnet_processing.cpp:4548:40: error: reading variable 'm_wtxid_relay' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n                        CInv inv(peer->m_wtxid_relay ? MSG_WTX : MSG_TX, hash);\r\n                                       ^\r\nnet_processing.cpp:4636:117: error: reading variable 'fPreferredDownload' requires holding mutex 'peer->m_mutex_message_handling' [-Werror,-Wthread-safety-analysis]\r\n                if (current_time > state.m_headers_sync_timeout && nSyncStarted == 1 && (nPreferredDownload - peer->fPreferredDownload >= 1)) {\r\n                                                                                                                    ^\r\n32 errors generated.\r\n```\r\n</details>\r\n",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-18T13:26:04Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r634375833",
      "id" : 634375833,
      "in_reply_to_id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDM3NTgzMw==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 662077356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-18T13:26:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634375833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r634534643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634534643"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"Should we add a dummy mutex for every variable\" -- we should have a GUARDED_BY for every object that's reachable by multiple threads, yes. The mutex is not a dummy, it's a real mutex.\r\n\r\nFor this specific case, here's an example of a patch that adds an access from another thread: https://github.com/ajtowns/bitcoin/commits/202105-whyhaveaguard . With the `GUARDED_BY(m_mutex_message_handling)` this is caught at compile time; without the guard (removed in the second commit), it compiles fine but introduces a race condition.",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-18T16:10:19Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r634534643",
      "id" : 634534643,
      "in_reply_to_id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDUzNDY0Mw==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 662301412,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-18T16:10:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634534643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r635119808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635119808"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> we should have a GUARDED_BY for every object that's reachable by multiple threads\r\n\r\nI assume here you mean -- even if the current code accesses it from a single thread.\r\n\r\nIf yes, then I think that is an overkill - it means having a mutex attached to every non-const global or class member variable, including private ones (coz in the future somebody may access it from another thread).\r\n\r\n> For this specific case, here's an example...\r\n\r\nYeah, but one can do such an example for any other variable. IMO annotating everything with `GUARDED_BY()`, just in case, would have a net-adverse effect on the code base.\r\n\r\n<details>\r\n<summary>Similar example for two other, randomly picked variables</summary>\r\n\r\n```diff\r\ndiff --git i/src/net.h w/src/net.h\r\nindex 6b9a7ef136..18d57a7d8e 100644\r\n--- i/src/net.h\r\n+++ w/src/net.h\r\n@@ -1256,12 +1256,18 @@ private:\r\n      * an address and port that are designated for incoming Tor connections.\r\n      */\r\n     std::vector<CService> m_onion_binds;\r\n \r\n     friend struct CConnmanTest;\r\n     friend struct ConnmanTestMsg;\r\n+\r\n+public:\r\n+    size_t ResponseCachesSize() const\r\n+    {\r\n+        return m_addr_response_caches.size();\r\n+    }\r\n };\r\n \r\n /** Return a timestamp in the future (in microseconds) for exponentially distributed events. */\r\n std::chrono::microseconds PoissonNextSend(std::chrono::microseconds now, std::chrono::seconds average_interval);\r\n \r\n /** Dump binary message to file, with timestamp */\r\ndiff --git i/src/rpc/net.cpp w/src/rpc/net.cpp\r\nindex 1f6b6e8d7e..cfab1ebafc 100644\r\n--- i/src/rpc/net.cpp\r\n+++ w/src/rpc/net.cpp\r\n@@ -631,12 +631,14 @@ static RPCHelpMan getnetworkinfo()\r\n     NodeContext& node = EnsureAnyNodeContext(request.context);\r\n     if (node.connman) {\r\n         ServiceFlags services = node.connman->GetLocalServices();\r\n         obj.pushKV(\"localservices\", strprintf(\"%016x\", services));\r\n         obj.pushKV(\"localservicesnames\", GetServicesNames(services));\r\n     }\r\n+    obj.pushKV(\"bug1\", node.connman->ResponseCachesSize());\r\n+    obj.pushKV(\"bug2\", node.addrman->m_asmap.size());\r\n     if (node.peerman) {\r\n         obj.pushKV(\"localrelay\", !node.peerman->IgnoresIncomingTxs());\r\n     }\r\n     obj.pushKV(\"timeoffset\",    GetTimeOffset());\r\n     if (node.connman) {\r\n         obj.pushKV(\"networkactive\", node.connman->GetNetworkActive());\r\n```\r\n</details>\r\n",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-19T10:41:11Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r635119808",
      "id" : 635119808,
      "in_reply_to_id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTExOTgwOA==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 663035458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-19T10:41:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635119808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r636167047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/636167047"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> `diff --git i/src/net.h w/src/net.h`\r\n\r\nYes, net.cpp/net.h is terrible for having globally accessible variables that aren't annotated for thread safety. Being able to introduce races that the compiler doesn't catch is a bad thing... txmempool's a better example, though it's also missing some guards (cf #22003).\r\n\r\n> IMO annotating everything with `GUARDED_BY()`, just in case, would have a net-adverse effect on the code base.\r\n\r\n`GUARDED_BY` is always a \"just in case\" thing -- any time the code compiles correctly with `GUARDED_BY` it will also compile correctly without it -- the benefit is \"just in case\" someone forgets while modifying the code later. With a guard, the compiler will catch the mistake; without it, you have to hope someone reviewing the code remembers, or wait for some obscure bug to be noticed and reported.\r\n\r\nNot consistently guarding variables has an easily observable adverse affect on the code bas as a whole: it makes it hard to change code, because you're not sure when things might be safe to reuse in a different context. eg see https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602283867\r\n\r\n>  it means having a mutex attached to every non-const global or class member variable, including private ones\r\n\r\nYes and no -- no, in that most classes don't need to manually manage locks, but should rather rely on whatever instantiates them to ensure the entire object is accessed safely; but for the ones that do, yes: every non-const, non-atomic member should be guarded (as should every class's non-const, non-atomic static members, since they're effectively globals themselves).",
      "commit_id" : "d2f5cc9de12196c870b2079bffc38e90076074d4",
      "created_at" : "2021-05-20T14:37:12Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r636167047",
      "id" : 636167047,
      "in_reply_to_id" : 631895780,
      "line" : 262,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNjE2NzA0Nw==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 262,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 664469678,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-20T14:37:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/636167047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-05-24T13:49:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-847055310",
      "id" : 847055310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzA1NTMxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-24T13:49:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847055310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased past #21186, addressed @jnewbery's nits.",
      "created_at" : "2021-05-25T04:28:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-847520754",
      "id" : 847520754,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzUyMDc1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T04:28:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847520754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-25T10:55:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-847768237",
      "id" : 847768237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0Nzc2ODIzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T10:55:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847768237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638801680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638801680"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@ajtowns, thanks for the elaboration.\r\n\r\nI still think that mutexes should be introduced when needed, not beforehand (with a reason that in the future somebody may access a variable from a different thread).\r\n\r\nLooks like neither one of us is convinced by the other's arguments. It's ok, it would have been too boring if everybody agreed on everything all the time.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-25T13:44:20Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638801680",
      "id" : 638801680,
      "in_reply_to_id" : 631895780,
      "line" : 286,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODgwMTY4MA==",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 286,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 667846182,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 281,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-25T13:44:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638801680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638832780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638832780"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Previously this would have allowed concurrent executions of `SendMessages()` for different peers, whereas now the concurrency is reduced by serializing all `SendMessages()` under the newly introduced single mutex `m_mutex_message_handling`.\r\n\r\nCurrently this code is executed by a single thread, so that is irrelevant, but in a possible future where we might want to do concurrent `SendMessages()` for different peers, the deleted `cs_sendProcessing` will have to be re-introduced.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-25T14:18:12Z",
      "diff_hunk" : "@@ -2197,10 +2197,7 @@ void CConnman::ThreadMessageHandler()\n             if (flagInterruptMsgProc)\n                 return;\n             // Send messages\n-            {\n-                LOCK(pnode->cs_sendProcessing);\n-                m_msgproc->SendMessages(pnode);\n-            }\n+            m_msgproc->SendMessages(pnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638832780",
      "id" : 638832780,
      "line" : 2200,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODgzMjc4MA==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 2200,
      "original_position" : 8,
      "original_start_line" : 2200,
      "path" : "src/net.cpp",
      "position" : 8,
      "pull_request_review_id" : 667889439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 2200,
      "start_side" : "LEFT",
      "updated_at" : "2021-05-26T17:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638832780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638964977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638964977"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Before this PR we would have returned `false` (no more work) if `fDisconnect` was set regardless of the outcome of `ProcessOrphanTx()` and regardless of whether `peer->m_orphan_work_set` was empty.\r\n\r\nNow `fDisconnect` may be set, but we may return `true` if `ProcessOrphanTx()` returns `true`.\r\n\r\nIf this change is not intentional, then maybe swap the order:\r\n\r\n```cpp\r\n    if (pfrom->fDisconnect) {\r\n        return false;\r\n    }\r\n\r\n    {\r\n        LOCK(cs_main);\r\n        if (ProcessOrphanTx(*peer)) return true;\r\n    }\r\n```\r\n",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-25T16:27:27Z",
      "diff_hunk" : "@@ -3927,10 +3955,8 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n     }\n \n     {\n-        LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n-        }\n+        LOCK(cs_main);\n+        if (ProcessOrphanTx(*peer)) return true;\n     }\n \n     if (pfrom->fDisconnect)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638964977",
      "id" : 638964977,
      "line" : 3962,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODk2NDk3Nw==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 3962,
      "original_position" : 233,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 233,
      "pull_request_review_id" : 667889439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T17:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638964977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638972961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638972961"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can be simplified?\r\n\r\n```suggestion\r\n    std::set<uint256>& orphan_work_set = m_peer_work_set[peer];\r\n```",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-25T16:35:10Z",
      "diff_hunk" : "@@ -132,15 +134,19 @@ unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n     {\n         // Evict a random orphan:\n         size_t randompos = rng.randrange(m_orphan_list.size());\n-        EraseTx(m_orphan_list[randompos]->first);\n+        _EraseTx(m_orphan_list[randompos]->first);\n         ++nEvicted;\n     }\n     return nEvicted;\n }\n \n-void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, NodeId peer)\n {\n-    AssertLockHeld(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n+    // Get this peer's work set, ensuring it exists\n+    std::set<uint256>& orphan_work_set = m_peer_work_set.emplace(peer, std::set<uint256>{}).first->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638972961",
      "id" : 638972961,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODk3Mjk2MQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 148,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 85,
      "pull_request_review_id" : 667889439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T17:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638972961",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638975978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638975978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`s/map/unordered_map/` to make lookup `O(1)` (we don't rely on this being ordered by `NodeId`). Same for the set of transaction ids.\r\n\r\n```suggestion\r\n    std::unordered_map<NodeId, std::unordered_set<uint256>> m_peer_work_set GUARDED_BY(m_mutex);\r\n```",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-25T16:39:03Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase an orphan by txid */\n-    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) { LOCK(m_mutex); return _EraseTx(txid); }\n \n     /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n-    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase all orphans included in or invalidated by a new block */\n-    void EraseForBlock(const CBlock& block) LOCKS_EXCLUDED(::g_cs_orphans);\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Limit the orphanage to the given maximum */\n-    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Add any orphans that list a particular tx as a parent into a peer's work set */\n+    void AddChildrenToWorkSet(const CTransaction& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n protected:\n+    /** Guards data */\n+    mutable Mutex m_mutex;\n+\n+    /** Erase an orphan by txid (internal, lock must already be held) */\n+    int _EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n     struct OrphanTx {\n         CTransactionRef tx;\n         NodeId fromPeer;\n         int64_t nTimeExpire;\n         size_t list_pos;\n     };\n \n-    /** Map from txid to orphan transaction record. Limited by\n-     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n-\n-    using OrphanMap = decltype(m_orphans);\n+    using OrphanMap = std::map<uint256, OrphanTx>;\n \n     struct IteratorComparator\n     {\n-        template<typename I>\n-        bool operator()(const I& a, const I& b) const\n+        bool operator()(const OrphanMap::iterator& a, const OrphanMap::iterator& b) const\n         {\n             return &(*a) < &(*b);\n         }\n     };\n \n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    OrphanMap m_orphans GUARDED_BY(m_mutex);\n+\n+    /** Which peer provided a parent tx of orphans that need to be reconsidered */\n+    std::map<NodeId, std::set<uint256>> m_peer_work_set GUARDED_BY(m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r638975978",
      "id" : 638975978,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODk3NTk3OA==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 82,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 93,
      "pull_request_review_id" : 667889439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T17:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638975978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r639923436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/639923436"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This `Assume()` seems unnecessary because `GetTxToReconsider()` is documented to populate `porphanTx` if it returns `true`.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-26T16:53:24Z",
      "diff_hunk" : "@@ -2132,33 +2152,26 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n+    AssertLockHeld(m_mutex_message_handling);\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n \n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    while (m_orphanage.GetTxToReconsider(peer.m_id, porphanTx, from_peer, more)) {\n+        if (!Assume(porphanTx)) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r639923436",
      "id" : 639923436,
      "line" : 2165,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzOTkyMzQzNg==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 2165,
      "original_position" : 125,
      "original_start_line" : 2164,
      "path" : "src/net_processing.cpp",
      "position" : 125,
      "pull_request_review_id" : 667889439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 2164,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-26T17:05:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/639923436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r640459998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640459998"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it possible for `TxOrphanage::m_orphans` to contain keys (transaction ids) which are not in `TxOrphanage::m_peer_work_set` or the other way around?",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-27T09:36:09Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase an orphan by txid */\n-    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) { LOCK(m_mutex); return _EraseTx(txid); }\n \n     /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n-    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase all orphans included in or invalidated by a new block */\n-    void EraseForBlock(const CBlock& block) LOCKS_EXCLUDED(::g_cs_orphans);\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Limit the orphanage to the given maximum */\n-    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Add any orphans that list a particular tx as a parent into a peer's work set */\n+    void AddChildrenToWorkSet(const CTransaction& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n protected:\n+    /** Guards data */\n+    mutable Mutex m_mutex;\n+\n+    /** Erase an orphan by txid (internal, lock must already be held) */\n+    int _EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n     struct OrphanTx {\n         CTransactionRef tx;\n         NodeId fromPeer;\n         int64_t nTimeExpire;\n         size_t list_pos;\n     };\n \n-    /** Map from txid to orphan transaction record. Limited by\n-     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n-\n-    using OrphanMap = decltype(m_orphans);\n+    using OrphanMap = std::map<uint256, OrphanTx>;\n \n     struct IteratorComparator\n     {\n-        template<typename I>\n-        bool operator()(const I& a, const I& b) const\n+        bool operator()(const OrphanMap::iterator& a, const OrphanMap::iterator& b) const\n         {\n             return &(*a) < &(*b);\n         }\n     };\n \n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    OrphanMap m_orphans GUARDED_BY(m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r640459998",
      "id" : 640459998,
      "line" : 79,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDQ1OTk5OA==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 79,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 90,
      "pull_request_review_id" : 669963251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-27T09:38:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640459998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r641181600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641181600"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "All Assume's should be unnecessary by definition? See https://github.com/bitcoin/bitcoin/pull/21527#discussion_r601253387 for prior discussion.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-28T02:53:58Z",
      "diff_hunk" : "@@ -2132,33 +2152,26 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n+    AssertLockHeld(m_mutex_message_handling);\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n \n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    while (m_orphanage.GetTxToReconsider(peer.m_id, porphanTx, from_peer, more)) {\n+        if (!Assume(porphanTx)) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r641181600",
      "id" : 641181600,
      "in_reply_to_id" : 639923436,
      "line" : 2165,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MTE4MTYwMA==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 2165,
      "original_position" : 125,
      "original_start_line" : 2164,
      "path" : "src/net_processing.cpp",
      "position" : 125,
      "pull_request_review_id" : 670890047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 2164,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-28T02:53:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641181600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r641207541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641207541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`m_orphans` will normally contain txids that aren't in `m_peer_work_set` -- they only get added to the work set when a parent appears and are (hopefully) very quickly removed from the work set after retrying ATMP.\r\n\r\nIt's also possible for something to expire from `m_orphans` and still be present in `m_peer_work_set`: if a tx that's in the work set is removed via `LimitOrphans` or `EraseForBlock` you'll get that case. It will eventually be removed from the work set when `GetTxToReconsider` is called.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-28T03:20:24Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase an orphan by txid */\n-    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) { LOCK(m_mutex); return _EraseTx(txid); }\n \n     /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n-    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase all orphans included in or invalidated by a new block */\n-    void EraseForBlock(const CBlock& block) LOCKS_EXCLUDED(::g_cs_orphans);\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Limit the orphanage to the given maximum */\n-    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Add any orphans that list a particular tx as a parent into a peer's work set */\n+    void AddChildrenToWorkSet(const CTransaction& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n protected:\n+    /** Guards data */\n+    mutable Mutex m_mutex;\n+\n+    /** Erase an orphan by txid (internal, lock must already be held) */\n+    int _EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n     struct OrphanTx {\n         CTransactionRef tx;\n         NodeId fromPeer;\n         int64_t nTimeExpire;\n         size_t list_pos;\n     };\n \n-    /** Map from txid to orphan transaction record. Limited by\n-     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n-\n-    using OrphanMap = decltype(m_orphans);\n+    using OrphanMap = std::map<uint256, OrphanTx>;\n \n     struct IteratorComparator\n     {\n-        template<typename I>\n-        bool operator()(const I& a, const I& b) const\n+        bool operator()(const OrphanMap::iterator& a, const OrphanMap::iterator& b) const\n         {\n             return &(*a) < &(*b);\n         }\n     };\n \n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    OrphanMap m_orphans GUARDED_BY(m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r641207541",
      "id" : 641207541,
      "in_reply_to_id" : 640459998,
      "line" : 79,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MTIwNzU0MQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 79,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 90,
      "pull_request_review_id" : 670898345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-28T03:20:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641207541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r641381542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641381542"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`Assume()` makes sense if the value is derived in an obscure way. But not for checking whether a function has set its \"out\" parameters as documented.\r\n\r\nFor example, when calling `CSHA256::Finalize(result)` we don't set `result` to a dummy value before the call and check that it is not that dummy value after the call with `Assume()`. Same for any other function that has \"out\" parameters.\r\n\r\nIf you insist to check that `porphanTx` was set by the function, then I guess you should do the same with `from_peer`: `Assume(from_peer != -1)`.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-05-28T08:48:08Z",
      "diff_hunk" : "@@ -2132,33 +2152,26 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n+    AssertLockHeld(m_mutex_message_handling);\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(g_cs_orphans);\n \n-    while (!orphan_work_set.empty()) {\n-        const uint256 orphanHash = *orphan_work_set.begin();\n-        orphan_work_set.erase(orphan_work_set.begin());\n+    CTransactionRef porphanTx = nullptr;\n+    NodeId from_peer = -1;\n+    bool more = false;\n \n-        const auto [porphanTx, from_peer] = m_orphanage.GetTx(orphanHash);\n-        if (porphanTx == nullptr) continue;\n+    while (m_orphanage.GetTxToReconsider(peer.m_id, porphanTx, from_peer, more)) {\n+        if (!Assume(porphanTx)) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r641381542",
      "id" : 641381542,
      "in_reply_to_id" : 639923436,
      "line" : 2165,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MTM4MTU0Mg==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 2165,
      "original_position" : 125,
      "original_start_line" : 2164,
      "path" : "src/net_processing.cpp",
      "position" : 125,
      "pull_request_review_id" : 671075089,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 2164,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-28T08:48:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/641381542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> NACK the addition of m_mutex_message_handling.\r\n\r\n> Looks like neither one of us is convinced by the other's arguments. It's ok, it would have been too boring if everybody agreed on everything all the time.\r\n\r\n@vasild: Are you in a position where you can ACK this PR overall (with reservations) or would you prefer not to ACK it? Either is fine (obviously), I just suspect other reviewers may be waiting to see if your concerns are addressed or not before spending time reviewing this.",
      "created_at" : "2021-06-16T11:42:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-862308967",
      "id" : 862308967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjMwODk2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T11:42:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862308967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652902450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652902450"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think second part of this comment \"This peer's set may be added...\" is confusing and annotating the parameter as an output doesn't make sense anymore.\r\n\r\nAfter this PR, parameter is no more a `std::map<NodeId, std::set<uint256>>` and new one can be actually a const.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-06-16T17:30:57Z",
      "diff_hunk" : "@@ -329,7 +337,17 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n-    void ProcessOrphanTx(std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(cs_main, g_cs_orphans);\n+    /**\n+     * Reconsider orphan transactions after a parent has been accepted to the mempool.\n+     *\n+     * @param[in,out]  peer             The peer whose orphan transactions we will reconsider. Generally only one\n+     *                                  orphan will be reconsidered on each call of this function. This peer's set\n+     *                                  may be added to if accepting an orphan causes its children to be\n+     *                                  reconsidered.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652902450",
      "id" : 652902450,
      "line" : 346,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjkwMjQ1MA==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 346,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 685461575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-16T18:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652902450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652906116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652906116"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about `EXCLUSIVE_LOCKS_EXCLUDED(!(...))` ? The logical negation operator is easy to miss for a reviewer. ",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-06-16T17:36:04Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase an orphan by txid */\n-    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) { LOCK(m_mutex); return _EraseTx(txid); }\n \n     /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n-    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase all orphans included in or invalidated by a new block */\n-    void EraseForBlock(const CBlock& block) LOCKS_EXCLUDED(::g_cs_orphans);\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652906116",
      "id" : 652906116,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjkwNjExNg==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 45,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 45,
      "pull_request_review_id" : 685461575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-16T18:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652906116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652926191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652926191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "At commit f86a525, I don't think this lock is useful to protect `vExtraTxnForCompact`, there is already one in `AddToCompactExtraTransactions` ? Though it might be useful at branch tip ?",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-06-16T18:00:56Z",
      "diff_hunk" : "@@ -2132,33 +2152,26 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n+    AssertLockHeld(m_mutex_message_handling);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652926191",
      "id" : 652926191,
      "line" : 2157,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjkyNjE5MQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 2157,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 111,
      "pull_request_review_id" : 685461575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-16T18:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652926191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652937929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652937929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this introduce a lightweight behavior change.\r\n\r\nPreviously, if our peer has `fDisconnect=true` set up from a previous message processing and the orphan work set is still non-empty after the `ProcessOrphanTx` above, we would have return `false`.\r\n\r\nFrom now on, if the orphan work set is still non-empty after `ProcessOrphanTx`, we're going to return `true`. \r\n\r\nThough i don't think it has any impact on allowing our peer to abuse more our CPU time, when we return from `ProcessMessages` to `ThreadMessageHandler`, we go to `SendMessages` which calls `MaybeDiscourageAndDisconnect` as first thing.\r\n\r\n(Actually why the check on `fDisconnect` isn't first in `ProcessMessages`, should be before any kind of processing work attempted with `ProcessGetData`/`ProcessOrphanTx` ?)",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-06-16T18:18:37Z",
      "diff_hunk" : "@@ -3943,11 +3969,6 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n         if (!peer->m_getdata_requests.empty()) return true;\n     }\n \n-    {\n-        LOCK(g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652937929",
      "id" : 652937929,
      "line" : 3948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjkzNzkyOQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 3948,
      "original_position" : 240,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 240,
      "pull_request_review_id" : 685461575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-16T18:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652937929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652945059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652945059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually, sharing block headers/compact blocks messages in parallel has been discussed a while back (iirc  https://bitcoincore.org/en/meetings/2018/05/03/, see \"Call ProcessNewBlock asynchronously\") though we could insert some queued interface between a net_processing thread and multiple net threads ?\r\n\r\nThat said, if it's direction we agree on, I think the discussion is worthy to have.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-06-16T18:28:00Z",
      "diff_hunk" : "@@ -2197,10 +2197,7 @@ void CConnman::ThreadMessageHandler()\n             if (flagInterruptMsgProc)\n                 return;\n             // Send messages\n-            {\n-                LOCK(pnode->cs_sendProcessing);\n-                m_msgproc->SendMessages(pnode);\n-            }\n+            m_msgproc->SendMessages(pnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r652945059",
      "id" : 652945059,
      "in_reply_to_id" : 638832780,
      "line" : 2200,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Mjk0NTA1OQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 2200,
      "original_position" : 8,
      "original_start_line" : 2200,
      "path" : "src/net.cpp",
      "position" : 8,
      "pull_request_review_id" : 685520228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : 2200,
      "start_side" : "LEFT",
      "updated_at" : "2021-06-16T18:31:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652945059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r654705472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654705472"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">  /** Message handling mutex.\r\n>    *  Message processing is single-threaded, so anything only accessed\r\n>    *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\r\n>    *  which guarantees it's only accessed by a single thread.\r\n\r\nI'm confused. This mutex ends up protecting everything accessed in those functions. For example, in `SendMessages`, it also protects `MaybeDiscourageAndDisconnect` that accesses things like `peer.m_misbehavior_mutex`, which can be accessed by the validation thread. So this mutex is guarding more things than what is _only_ accessed by the `ProcessMessage(s)` and `SendMessages` thread.\r\n\r\nI suppose it's safe that this mutex also ends up guarding things that are accessed by multiple threads, but I find the comment confusing.",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-06-18T22:55:03Z",
      "diff_hunk" : "@@ -4303,6 +4324,8 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     if (!peer) return false;\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n \n+    LOCK(m_mutex_message_handling);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r654705472",
      "id" : 654705472,
      "line" : 4327,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDcwNTQ3Mg==",
      "original_commit_id" : "7961d94c8b734d6039397eb5df3c24ddf67de2df",
      "original_line" : 4327,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 259,
      "pull_request_review_id" : 687760801,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-18T22:55:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654705472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r654713376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654713376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "do I understand correctly that after these changes `PeerManagerImpl::ProcessMessage` is a test-only function? If so, I think the comment in `net_processing.h` should be updated. Or even better, the function renamed to something like `ProcessMessageTest` :)",
      "commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "created_at" : "2021-06-18T23:28:52Z",
      "diff_hunk" : "@@ -2396,6 +2407,14 @@ void PeerManagerImpl::ProcessBlock(CNode& pfrom, const std::shared_ptr<const CBl\n void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r654713376",
      "id" : 654713376,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDcxMzM3Ng==",
      "original_commit_id" : "7961d94c8b734d6039397eb5df3c24ddf67de2df",
      "original_line" : 2407,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 687771014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-18T23:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654713376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > NACK the addition of m_mutex_message_handling.\r\n> \r\n> > Looks like neither one of us is convinced by the other's arguments. It's ok, it would have been too boring if everybody agreed on everything all the time.\r\n> \r\n> @vasild: Are you in a position where you can ACK this PR overall (with reservations) or would you prefer not to ACK it? Either is fine (obviously), I just suspect other reviewers may be waiting to see if your concerns are addressed or not before spending time reviewing this.\r\n\r\nThe rest of this PR looks good overall (modulo some minor other comments I left). But the mutex `m_mutex_message_handling` looks [really strange](https://github.com/bitcoin/bitcoin/pull/21527#discussion_r631895780) to me, with a [confusing comment](https://github.com/bitcoin/bitcoin/pull/21527#discussion_r654705472).\r\n\r\nI would re-review carefully and probably ACK this PR if the mutex is removed. If needed later then it can be added in another PR.",
      "created_at" : "2021-06-21T14:02:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-865057893",
      "id" : 865057893,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTA1Nzg5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T14:02:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865057893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns are you still working on this? I think this new net_processing lock is the best way we have to make progress with much of the net/net_processing/validation separation work.",
      "created_at" : "2021-07-27T10:20:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-887393835",
      "id" : 887393835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII58405I4r",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T10:20:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887393835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r700794786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700794786"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I was just adding `AssertLockHeld` to correspond with the `EXCLUSIVE_LOCKS_REQUIRED` annotation as a matter of course (see the recommendation in developer-notes.md).",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T06:49:02Z",
      "diff_hunk" : "@@ -2132,33 +2152,26 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     return;\n }\n \n-/**\n- * Reconsider orphan transactions after a parent has been accepted to the mempool.\n- *\n- * @param[in,out]  orphan_work_set  The set of orphan transactions to reconsider. Generally only one\n- *                                  orphan will be reconsidered on each call of this function. This set\n- *                                  may be added to if accepting an orphan causes its children to be\n- *                                  reconsidered.\n- */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+bool PeerManagerImpl::ProcessOrphanTx(Peer& peer)\n {\n+    AssertLockHeld(m_mutex_message_handling);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r700794786",
      "id" : 700794786,
      "in_reply_to_id" : 652926191,
      "line" : 2236,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDc5NDc4Ng==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 2236,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 111,
      "pull_request_review_id" : 744666339,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T06:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700794786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r700795929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700795929"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`fDisconnect` is already checked in net.cpp prior to `ProcessMessages` being called, but there's always a chance that there's a race and `fDisconnect` is set while in the middle of `ProcessMessages` for the peer.",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T06:51:05Z",
      "diff_hunk" : "@@ -3943,11 +3969,6 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n         if (!peer->m_getdata_requests.empty()) return true;\n     }\n \n-    {\n-        LOCK(g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r700795929",
      "id" : 700795929,
      "in_reply_to_id" : 652937929,
      "line" : 4069,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDc5NTkyOQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 4069,
      "original_position" : 240,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 245,
      "pull_request_review_id" : 744667754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T06:51:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700795929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701462414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701462414"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you have:\r\n\r\n```c++\r\nMutex mutex;\r\nint x GUARDED_BY(mutex);\r\nint y;\r\nstatic void A() { LOCK(mutex); ++x; ++y; }\r\nstatic void B() { LOCK(mutex); --x; }\r\nvoid ThreadA() { for (int i = 0; i < 100; ++i) { A(); } }\r\nvoid ThreadB() { for (int i = 0; i < 100; ++i) { B(); } }\r\n```\r\n\r\nthen I'd say that only `x` is guarded by the mutex, even though `y` is only actually accessed while the mutex is held. If you later  introduce\r\n\r\n```c++\r\nstatic void C() { y *= 2; }\r\n```\r\n\r\nthen that would still be safe/correct if `ThreadA` were to start calling `C()`, but `y` would no longer always be protected by the mutex; conversely if `ThreadB` were to start calling `C()`, then `y` would no longer be thread safe, but because it's not guarded by anything, the compiler would not catch that bug.\r\n\r\nI guess I'd look at it more as mutexes protect **code** from being run simultaneously; it's the GUARDED_BY **annotations** that protect the variables. If the variables aren't annotated, they don't have any automatic protections, only manual protection by the programmer constantly being careful.",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T22:26:56Z",
      "diff_hunk" : "@@ -4303,6 +4324,8 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     if (!peer) return false;\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n \n+    LOCK(m_mutex_message_handling);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701462414",
      "id" : 701462414,
      "in_reply_to_id" : 654705472,
      "line" : 4523,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ2MjQxNA==",
      "original_commit_id" : "7961d94c8b734d6039397eb5df3c24ddf67de2df",
      "original_line" : 4523,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 264,
      "pull_request_review_id" : 745569164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T22:26:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701462414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701466455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701466455"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`PeerManager::ProcessMessage` has always only been exposed for tests, and is already documented that way in the header file:\r\n\r\n```c++\r\n    /** Process a single message from a peer. Public for fuzz testing */\r\n    virtual void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\r\n```\r\n\r\n`PeerManagerImpl::ProcessMessage` is thus needed to complete the `PeerManager` interface.",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T22:35:53Z",
      "diff_hunk" : "@@ -2396,6 +2407,14 @@ void PeerManagerImpl::ProcessBlock(CNode& pfrom, const std::shared_ptr<const CBl\n void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701466455",
      "id" : 701466455,
      "in_reply_to_id" : 654713376,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ2NjQ1NQ==",
      "original_commit_id" : "7961d94c8b734d6039397eb5df3c24ddf67de2df",
      "original_line" : 2490,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 745573547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T22:35:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701466455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701484079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701484079"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a comment.",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T23:21:53Z",
      "diff_hunk" : "@@ -3895,9 +3902,7 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n \n     {\n         LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(*peer);\n-        }\n+        if (ProcessOrphanTx(*peer)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701484079",
      "id" : 701484079,
      "in_reply_to_id" : 628836372,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ4NDA3OQ==",
      "original_commit_id" : "57900348db566105351b525ae18cc2830e9665b5",
      "original_line" : 3959,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 745593894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T23:21:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701484079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701484517"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701484517"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed to `return !pfrom->fDisconnect` to preserve the same behaviour.",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T23:23:16Z",
      "diff_hunk" : "@@ -3927,10 +3955,8 @@ bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt\n     }\n \n     {\n-        LOCK2(cs_main, g_cs_orphans);\n-        if (!peer->m_orphan_work_set.empty()) {\n-            ProcessOrphanTx(peer->m_orphan_work_set);\n-        }\n+        LOCK(cs_main);\n+        if (ProcessOrphanTx(*peer)) return true;\n     }\n \n     if (pfrom->fDisconnect)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701484517",
      "id" : 701484517,
      "in_reply_to_id" : 638964977,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ4NDUxNw==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 4090,
      "original_position" : 233,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 745594486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T23:23:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701484517",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701484925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701484925"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed to C++17's `try_emplace` which simplifies it slightly. Not really a fan of `map::operator[]`",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T23:24:37Z",
      "diff_hunk" : "@@ -132,15 +134,19 @@ unsigned int TxOrphanage::LimitOrphans(unsigned int max_orphans)\n     {\n         // Evict a random orphan:\n         size_t randompos = rng.randrange(m_orphan_list.size());\n-        EraseTx(m_orphan_list[randompos]->first);\n+        _EraseTx(m_orphan_list[randompos]->first);\n         ++nEvicted;\n     }\n     return nEvicted;\n }\n \n-void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const\n+void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx, NodeId peer)\n {\n-    AssertLockHeld(g_cs_orphans);\n+    LOCK(m_mutex);\n+\n+    // Get this peer's work set, ensuring it exists\n+    std::set<uint256>& orphan_work_set = m_peer_work_set.emplace(peer, std::set<uint256>{}).first->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701484925",
      "id" : 701484925,
      "in_reply_to_id" : 638972961,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ4NDkyNQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 148,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 745595054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T23:24:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701484925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701485341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701485341"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Left as map; I don't think performance matters enough to justify using extra space for the hashmap; and longer term, using a multiindex rather than a bunch of different containers referencing each other is probably better.",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T23:25:57Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase an orphan by txid */\n-    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) { LOCK(m_mutex); return _EraseTx(txid); }\n \n     /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n-    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase all orphans included in or invalidated by a new block */\n-    void EraseForBlock(const CBlock& block) LOCKS_EXCLUDED(::g_cs_orphans);\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Limit the orphanage to the given maximum */\n-    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    unsigned int LimitOrphans(unsigned int max_orphans) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n-    /** Add any orphans that list a particular tx as a parent into a peer's work set\n-     * (ie orphans that may have found their final missing parent, and so should be reconsidered for the mempool) */\n-    void AddChildrenToWorkSet(const CTransaction& tx, std::set<uint256>& orphan_work_set) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    /** Add any orphans that list a particular tx as a parent into a peer's work set */\n+    void AddChildrenToWorkSet(const CTransaction& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n protected:\n+    /** Guards data */\n+    mutable Mutex m_mutex;\n+\n+    /** Erase an orphan by txid (internal, lock must already be held) */\n+    int _EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n     struct OrphanTx {\n         CTransactionRef tx;\n         NodeId fromPeer;\n         int64_t nTimeExpire;\n         size_t list_pos;\n     };\n \n-    /** Map from txid to orphan transaction record. Limited by\n-     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n-    std::map<uint256, OrphanTx> m_orphans GUARDED_BY(g_cs_orphans);\n-\n-    using OrphanMap = decltype(m_orphans);\n+    using OrphanMap = std::map<uint256, OrphanTx>;\n \n     struct IteratorComparator\n     {\n-        template<typename I>\n-        bool operator()(const I& a, const I& b) const\n+        bool operator()(const OrphanMap::iterator& a, const OrphanMap::iterator& b) const\n         {\n             return &(*a) < &(*b);\n         }\n     };\n \n+    /** Map from txid to orphan transaction record. Limited by\n+     *  -maxorphantx/DEFAULT_MAX_ORPHAN_TRANSACTIONS */\n+    OrphanMap m_orphans GUARDED_BY(m_mutex);\n+\n+    /** Which peer provided a parent tx of orphans that need to be reconsidered */\n+    std::map<NodeId, std::set<uint256>> m_peer_work_set GUARDED_BY(m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701485341",
      "id" : 701485341,
      "in_reply_to_id" : 638975978,
      "line" : 92,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ4NTM0MQ==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 92,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 106,
      "pull_request_review_id" : 745595604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T23:25:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701485341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701486116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701486116"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Dropped the `out` which doesn't make sense. Knowing that this may increase the size of the set, not simply reduce it is valuable I think, so have left that text alone.",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T23:28:04Z",
      "diff_hunk" : "@@ -329,7 +337,17 @@ class PeerManagerImpl final : public PeerManager\n      */\n     bool MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer);\n \n-    void ProcessOrphanTx(std::set<uint256>& orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(cs_main, g_cs_orphans);\n+    /**\n+     * Reconsider orphan transactions after a parent has been accepted to the mempool.\n+     *\n+     * @param[in,out]  peer             The peer whose orphan transactions we will reconsider. Generally only one\n+     *                                  orphan will be reconsidered on each call of this function. This peer's set\n+     *                                  may be added to if accepting an orphan causes its children to be\n+     *                                  reconsidered.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701486116",
      "id" : 701486116,
      "in_reply_to_id" : 652902450,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ4NjExNg==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 346,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 745596441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T23:28:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701486116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701486468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701486468"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems like something more for clang upstream if anything?",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-02T23:29:08Z",
      "diff_hunk" : "@@ -21,65 +21,76 @@ extern RecursiveMutex g_cs_orphans;\n class TxOrphanage {\n public:\n     /** Add a new orphan transaction */\n-    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */\n-    bool HaveTx(const GenTxid& gtxid) const LOCKS_EXCLUDED(::g_cs_orphans);\n-\n-    /** Get an orphan transaction and its originating peer\n-     * (Transaction ref will be nullptr if not found)\n+    bool HaveTx(const GenTxid& gtxid) const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Extract a transaction from a peer's work set\n+     *  Returns false and sets more to false if there are no transactions\n+     *  to work on. Otherwise returns true, removes the transaction from\n+     *  the work set, and populates its arguments with tx, the originating\n+     *  peer, and whether there are more orphans for this peer to work on\n+     *  after this tx.\n      */\n-    std::pair<CTransactionRef, NodeId> GetTx(const uint256& txid) const EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    bool GetTxToReconsider(NodeId peer, CTransactionRef& ref, NodeId& originator, bool& more) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase an orphan by txid */\n-    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    int EraseTx(const uint256& txid) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex) { LOCK(m_mutex); return _EraseTx(txid); }\n \n     /** Erase all orphans announced by a peer (eg, after that peer disconnects) */\n-    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans);\n+    void EraseForPeer(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Erase all orphans included in or invalidated by a new block */\n-    void EraseForBlock(const CBlock& block) LOCKS_EXCLUDED(::g_cs_orphans);\n+    void EraseForBlock(const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701486468",
      "id" : 701486468,
      "in_reply_to_id" : 652906116,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTQ4NjQ2OA==",
      "original_commit_id" : "d6dfa5977a7c03d9a81727e1692edb58bfeab62c",
      "original_line" : 48,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 49,
      "pull_request_review_id" : 745596865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-02T23:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701486468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased past #21562. Minor updates per reviews.",
      "created_at" : "2021-09-02T23:31:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-912129890",
      "id" : 912129890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5842Xf9i",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-02T23:31:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/912129890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701689238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701689238"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I guess I'd look at it more as mutexes protect __code__ from being run simultaneously\r\n\r\nIMO mutexes protect variables, not code.\r\n\r\nFrom https://en.wikipedia.org/wiki/Lock_(computer_science)\r\n> ... a mechanism that enforces limits on access to a __resource__ ...\r\n> ... each thread cooperates by acquiring the lock before accessing the __corresponding data__ ...",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-03T08:06:17Z",
      "diff_hunk" : "@@ -4303,6 +4324,8 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     if (!peer) return false;\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n \n+    LOCK(m_mutex_message_handling);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r701689238",
      "id" : 701689238,
      "in_reply_to_id" : 654705472,
      "line" : 4523,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTY4OTIzOA==",
      "original_commit_id" : "7961d94c8b734d6039397eb5df3c24ddf67de2df",
      "original_line" : 4523,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 264,
      "pull_request_review_id" : 745835427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-03T08:06:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701689238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r703141868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703141868"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Read your second quote carefully -- it's not the mutex/lock that protects the data, it's the threads that protect it by cooperatively acquiring the lock before accessing the data.\r\n\r\nIt's 99% true that the point of using a mutex is to protect data, but it's not the mutex itself that ensures the data is protected, it's how you use the mutex. It's like looking both ways before crossing the road -- if you don't do that, you'll probably walk into traffic; but looking alone isn't enough, you have to make sure you do it before crossing the road, and depending on what you see, delay crossing the road. The point of annotations here is to ensure at compile time that you're not metaphorically stepping into the road before looking, or literally not accessing variables that are only meant to be accessed by a particular thread from another thread.\r\n\r\n(I think I've repeated this point enough now; if there's something not clear, feel free to ask, but I'm not seeing any point to going around in circles another time)",
      "commit_id" : "6655c361befdd9632c91cc9fd80cecdc86ed858d",
      "created_at" : "2021-09-07T02:55:55Z",
      "diff_hunk" : "@@ -4303,6 +4324,8 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n     if (!peer) return false;\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n \n+    LOCK(m_mutex_message_handling);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r703141868",
      "id" : 703141868,
      "in_reply_to_id" : 654705472,
      "line" : 4523,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMzE0MTg2OA==",
      "original_commit_id" : "7961d94c8b734d6039397eb5df3c24ddf67de2df",
      "original_line" : 4523,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 264,
      "pull_request_review_id" : 747496945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-07T02:55:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/703141868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, I like the idea of txorphanage being internally thread-safe",
      "created_at" : "2021-09-24T13:43:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-926635717",
      "id" : 926635717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5843O1bF",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-24T13:43:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926635717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-27T13:27:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-927875183",
      "id" : 927875183,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5843TkBv",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-27T13:27:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927875183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased past #22976",
      "created_at" : "2021-09-29T19:13:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-930467996",
      "id" : 930467996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5843ddCc",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T19:13:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930467996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-10-25T14:20:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-950979318",
      "id" : 950979318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5844rsr2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/950979318/reactions"
      },
      "updated_at" : "2021-10-25T14:20:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/950979318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased past #23157",
      "created_at" : "2021-10-26T12:42:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-951900670",
      "id" : 951900670,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5844vNn-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951900670/reactions"
      },
      "updated_at" : "2021-10-26T12:42:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951900670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-11-10T13:59:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-965207447",
      "id" : 965207447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5845h-WX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965207447/reactions"
      },
      "updated_at" : "2021-11-10T13:59:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965207447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased past a few conflicts.",
      "created_at" : "2021-12-09T15:17:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-989947680",
      "id" : 989947680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5847AWcg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989947680/reactions"
      },
      "updated_at" : "2021-12-09T15:17:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989947680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-24T09:40:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1019902757",
      "id" : 1019902757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII5848ynsl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019902757/reactions"
      },
      "updated_at" : "2022-01-24T09:40:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019902757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r790857566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790857566"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it is fine to not have thread safety stuff on things that aren't meant to be called by more than one thread. For example, most code in init.cpp doesn't need them because they are only called once per process. Though, other stuff should communicate to the developer whether it is thread safe. Either via code comments (https://github.com/bitcoin/bitcoin/blob/e3de7cb9039770e0fd5b8bb8a5cba35c87ae8f00/src/random.h#L67, https://github.com/bitcoin/bitcoin/blob/e3de7cb9039770e0fd5b8bb8a5cba35c87ae8f00/src/random.h#L129) or via annotations.",
      "commit_id" : "a39bca3d7761450c10e517f399c7d9e1ec6657e9",
      "created_at" : "2022-01-24T15:29:46Z",
      "diff_hunk" : "@@ -254,9 +251,20 @@ class PeerManagerImpl final : public PeerManager\n     void SetBestHeight(int height) override { m_best_height = height; };\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message) override;\n     void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override;\n+                        const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) override LOCKS_EXCLUDED(m_mutex_message_handling);\n \n private:\n+    /** Message handling mutex.\n+     *  Message processing is single-threaded, so anything only accessed\n+     *  by ProcessMessage(s) or SendMessages can be guarded by this mutex,\n+     *  which guarantees it's only accessed by a single thread.\n+     */\n+    Mutex m_mutex_message_handling;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#discussion_r790857566",
      "id" : 790857566,
      "in_reply_to_id" : 631895780,
      "line" : 328,
      "node_id" : "PRRC_kwDOABII584vI4de",
      "original_commit_id" : "dd754fd73ab0fcbe9461a6a21b5fc2bc22faf968",
      "original_line" : 328,
      "original_position" : 32,
      "original_start_line" : 257,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 861123301,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21527",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790857566/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 323,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-24T15:29:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790857566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased with the `cs_sendProcessing` parts split out into #24474; marking as draft while that one gets reviewed.",
      "created_at" : "2022-03-04T19:42:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1059462475",
      "id" : 1059462475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII584_Jh1L",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1059462475/reactions"
      },
      "updated_at" : "2022-03-04T19:42:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1059462475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-07T08:24:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1060319868",
      "id" : 1060319868,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII584_MzJ8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060319868/reactions"
      },
      "updated_at" : "2022-03-07T08:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060319868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-26T08:02:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1109479265",
      "id" : 1109479265,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII585CIU9h",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1109479265/reactions"
      },
      "updated_at" : "2022-04-26T08:02:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1109479265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased to keep up with #24474",
      "created_at" : "2022-05-03T17:52:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1116381806",
      "id" : 1116381806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII585CiqJu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1116381806/reactions"
      },
      "updated_at" : "2022-05-03T17:52:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1116381806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-16T13:06:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1127649616",
      "id" : 1127649616,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII585DNpFQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127649616/reactions"
      },
      "updated_at" : "2022-05-16T13:06:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127649616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-19T10:21:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1131512985",
      "id" : 1131512985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII585DcYSZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131512985/reactions"
      },
      "updated_at" : "2022-05-19T10:21:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131512985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-20T13:41:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21527#issuecomment-1132916061",
      "id" : 1132916061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21527",
      "node_id" : "IC_kwDOABII585Dhu1d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1132916061/reactions"
      },
      "updated_at" : "2022-05-20T13:41:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1132916061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
